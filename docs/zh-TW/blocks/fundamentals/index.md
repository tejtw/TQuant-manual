# æ¶æ§‹ Aï¼šè²¡å ±é¸è‚¡æ¶æ§‹ (Fundamental Selection Framework)

> **æ ¸å¿ƒæ€æƒ³ï¼šå…ˆç®—å‡ºåå–®ï¼Œå›æ¸¬åªæ˜¯åŸ·è¡Œã€‚**  
> "Calculate the list first, backtest is just execution."

---

## ğŸ“Œ æ ¸å¿ƒæ¦‚å¿µ

è²¡å ±é¸è‚¡æ¶æ§‹çš„æœ¬è³ªæ˜¯ã€Œ**äº‹å‰è¨ˆç®— + äº‹å¾ŒåŸ·è¡Œ**ã€çš„åˆ†é›¢è¨­è¨ˆï¼š
```
Step 1: åœ¨å›æ¸¬å¤–ï¼Œç”¨ DataFrame ç®—å‡ºæ¯æœŸçš„è‚¡ç¥¨åå–®
Step 2: åœ¨å›æ¸¬å…§ï¼Œç…§è¡¨æ“èª²åŸ·è¡Œäº¤æ˜“
```

é€™ç¨®æ¶æ§‹æœ€ç¬¦åˆçœŸå¯¦æŠ•è³‡çš„æ€è€ƒé‚è¼¯ï¼š
- ğŸ“Š **æœˆåº•**ï¼šæ‰“é–‹è²¡å ±è³‡æ–™åº«ï¼Œç¯©é¸å‡ºç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨
- ğŸ“… **éš”æœˆåˆ**ï¼šç…§è‘—åå–®ä¸‹å–®

---

## ğŸ¯ é©ç”¨å ´æ™¯

### âœ… æœ€é©åˆçš„æƒ…å¢ƒ
- **åŸºæœ¬é¢é¸è‚¡**ï¼šæœ¬ç›Šæ¯”ã€ROEã€è² å‚µæ¯”ç­‰è²¡å ±æŒ‡æ¨™
- **å­£åº¦èª¿å€‰**ï¼šé…åˆè²¡å ±å…¬å‘Šé€±æœŸï¼ˆ3/6/9/12æœˆï¼‰
- **å¤šæ¢ä»¶ç¯©é¸**ï¼šéœ€è¦åŒæ™‚æª¢æŸ¥ 5+ å€‹è²¡å‹™æŒ‡æ¨™
- **ä¸­ç­‰è¦æ¨¡è‚¡ç¥¨æ± **ï¼š50-200 æª”è‚¡ç¥¨

### âŒ ä¸é©åˆçš„æƒ…å¢ƒ
- âŒ æ—¥å…§äº¤æ˜“ã€é«˜é »ç­–ç•¥
- âŒ ç´”æŠ€è¡“æŒ‡æ¨™ï¼ˆMACDã€KD ç­‰ï¼‰
- âŒ éœ€è¦å³æ™‚é‹ç®—çš„å› å­
- âŒ è¶…å¤§è¦æ¨¡å¸‚å ´æƒæï¼ˆ>500 æª”ï¼‰

---

## ğŸ—ï¸ æ¶æ§‹ç‰¹è‰²

### æ•¸æ“šæµå‘åœ–
```mermaid
graph TD
    subgraph Outside["âš™ï¸ å›æ¸¬å¤–é‹ç®— (Pre-Backtest)"]
        A1[TejToolAPI.get_history_data<br/>æŠ“å–å®Œæ•´è²¡å ±] --> A2[compute_stock å‡½æ•¸<br/>é‹ç®—é¸è‚¡é‚è¼¯]
        A2 --> A3[ç”¢å‡º Ticker List<br/>+ æ›è‚¡æ—¥æœŸ]
    end
    
    subgraph Inside["ğŸ”„ å›æ¸¬å…§åŸ·è¡Œ (In-Backtest)"]
        A3 --> B1[zipline.run_algorithm]
        B1 --> B2{handle_data<br/>æ¯æ—¥æª¢æŸ¥}
        B2 -->|æ˜¯æ›è‚¡æ—¥| B3[context.state = True]
        B2 -->|ä¸æ˜¯| B4[æŒæœ‰ä¸å‹•]
        B3 --> B5[éš”æ—¥åŸ·è¡Œ<br/>order_target_percent]
    end
    
    style Outside fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style Inside fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    style A2 fill:#ffccbc,stroke:#d84315,stroke-width:2px
```

### é—œéµè¨­è¨ˆç†å¿µ

#### 1. é¿å…å‰è¦–åå·® (Look-ahead Bias)
```python
# âŒ éŒ¯èª¤ï¼šç•¶å¤©çœ‹åˆ°è¨Šè™Ÿå°±ä¸‹å–®
if date == rebalance_date:
    order_target_percent(symbol, weight)

# âœ… æ­£ç¢ºï¼šæ¨™è¨˜ä»Šå¤©ï¼Œéš”å¤©æ‰ä¸‹å–®
if date == rebalance_date:
    context.state = True  # æ¨™è¨˜
    context.order_tickers = compute_stock(date)

if context.state == True:  # éš”å¤©åŸ·è¡Œ
    for ticker in context.order_tickers:
        order_target_percent(symbol(ticker), weight)
```

#### 2. æ•¸æ“šé€æ˜åŒ–
æ‰€æœ‰ç¯©é¸é‚è¼¯éƒ½åœ¨ `compute_stock()` å‡½æ•¸ä¸­ï¼Œæ–¹ä¾¿æª¢æŸ¥å’Œèª¿è©¦ï¼š
```python
def compute_stock(date, data):
    df = data[data['æ—¥æœŸ'] == date]
    
    # æ¢ä»¶ 1: æœ¬ç›Šæ¯” < ç”¢æ¥­å¹³å‡
    set_1 = set(df[df['æœ¬ç›Šæ¯”'] < df['ç”¢æ¥­å¹³å‡æœ¬ç›Šæ¯”']]['è‚¡ç¥¨ä»£ç¢¼'])
    
    # æ¢ä»¶ 2: è² å‚µæ¯” < 20%
    set_2 = set(df[df['è² å‚µæ¯”'] < 0.2]['è‚¡ç¥¨ä»£ç¢¼'])
    
    # å–äº¤é›†
    return list(set_1 & set_2)
```

#### 3. éˆæ´»çš„æ›è‚¡é€±æœŸ
```python
# æ–¹æ³• 1: å›ºå®šæ—¥æœŸï¼ˆæ¯å­£æœ€å¾Œä¸€å¤©ï¼‰
modified_day = ['2023-03-31', '2023-06-30', '2023-09-30', '2023-12-31']

# æ–¹æ³• 2: å‹•æ…‹è¨ˆç®—ï¼ˆTEJ äº¤æ˜“æ—¥æ›†ï¼‰
trade_days = tejapi.get('TWN/TRADEDAY_TWSE', ...)
last_days = trade_days.groupby(['year', 'quarter'])['date'].max()
```

---

## ğŸ“Š èˆ‡å…¶ä»–æ¶æ§‹çš„å·®ç•°

| ç‰¹æ€§ | è²¡å ±é¸è‚¡æ¶æ§‹ | æŠ€è¡“æŒ‡æ¨™æ¶æ§‹ | Pipeline æ¶æ§‹ |
| :--- | :---: | :---: | :---: |
| **é‹ç®—æ™‚æ©Ÿ** | å›æ¸¬å¤– | å›æ¸¬å…§ï¼ˆæ¯æ—¥ï¼‰ | å›æ¸¬å…§ï¼ˆç›¤å‰ï¼‰ |
| **æ•¸æ“šä¾†æº** | TEJ è²¡å ± API | Zipline æ­·å²åƒ¹æ ¼ | CustomDataset |
| **é©ç”¨è‚¡ç¥¨æ•¸** | 50-200 | 1-10 | 500-2000 |
| **èª¿å€‰é »ç‡** | å­£åº¦/æœˆåº¦ | æ¯æ—¥ | æ¯æ—¥/æ¯é€± |
| **Debug é›£åº¦** | ğŸŸ¢ æ˜“ | ğŸŸ¢ æ˜“ | ğŸ”´ é›£ |
| **åŸ·è¡Œé€Ÿåº¦** | ğŸŸ¢ å¿« | ğŸŸ¡ ä¸­ | ğŸŸ¢ æ¥µå¿« |
| **è¨˜æ†¶é«”éœ€æ±‚** | ğŸŸ¢ ä½ | ğŸŸ¢ ä½ | ğŸ”´ é«˜ |

---

## ğŸ’¡ ä½•æ™‚é¸æ“‡é€™å€‹æ¶æ§‹ï¼Ÿ

### å¿«é€Ÿåˆ¤æ–·æª¢æŸ¥è¡¨
```mermaid
graph TD
    A[ä½ çš„ç­–ç•¥] --> B{æ•¸æ“šä¾†è‡ªè²¡å ±?}
    B -->|Yes| C{èª¿å€‰é »ç‡?}
    B -->|No| X[è€ƒæ…®æŠ€è¡“æŒ‡æ¨™æ¶æ§‹]
    
    C -->|å­£åº¦/æœˆåº¦| D[âœ… è²¡å ±é¸è‚¡æ¶æ§‹]
    C -->|æ¯æ—¥| E{è‚¡ç¥¨æ•¸é‡?}
    
    E -->|<50æª”| D
    E -->|>50æª”| F[è€ƒæ…® Pipeline æ¶æ§‹]
    
    style D fill:#c8e6c9,stroke:#388e3c,stroke-width:3px
```

### å…¸å‹ä½¿ç”¨æ¡ˆä¾‹
- âœ… åƒ¹å€¼æŠ•è³‡ç­–ç•¥ï¼ˆä½ PBã€é«˜è‚¡æ¯ï¼‰
- âœ… æˆé•·è‚¡ç¯©é¸ï¼ˆé«˜ ROEã€ä½è² å‚µï¼‰
- âœ… å“è³ªå› å­çµ„åˆï¼ˆæµå‹•æ¯”ç‡ã€æ¯›åˆ©ç‡ï¼‰
- âœ… Dreman é€†å‘æŠ•è³‡æ³•

---

## ğŸ“ å­¸ç¿’è·¯å¾‘

### æ–°æ‰‹å…¥é–€ï¼ˆ3 æ­¥é©Ÿï¼‰
1. **é–±è®€æ¡ˆä¾‹**ï¼šå…ˆçœ‹ `case-multifactor.md`ï¼Œç†è§£å®Œæ•´æµç¨‹
2. **è¤‡è£½æ¨¡æ¿**ï¼šå‰å¾€ `template.md` è¤‡è£½éª¨æ¶
3. **å¡«å…¥é‚è¼¯**ï¼šä¿®æ”¹ `compute_stock()` å‡½æ•¸

### é€²éšå„ªåŒ–
- å‹•æ…‹æ›è‚¡æ—¥è¨ˆç®—ï¼ˆTEJ äº¤æ˜“æ—¥æ›†ï¼‰
- é¢¨éšªå¹³åƒ¹é…ç½®ï¼ˆéç­‰æ¬Šé‡ï¼‰
- ç”¢æ¥­ä¸­æ€§åŒ–è™•ç†

---

## ğŸ“š ç›¸é—œè³‡æº

- **æ¨¡æ¿é é¢**ï¼š[template.md](template.md)
- **æ¡ˆä¾‹å­¸ç¿’**ï¼š
  - [å¤šå› å­é¸è‚¡](case-multifactor.md) - ç¶“å…¸äº”å› å­ç­–ç•¥
  - [å°å‹æˆé•·è‚¡](case-smallcap.md) - å¸‚å€¼ + æˆé•·å› å­
  - [Dreman é€†å‘æŠ•è³‡](case-dreman.md) - è¨ˆåˆ†åˆ¶ç¯©é¸
- **å¸¸è¦‹å•é¡Œ**ï¼š[faq.md](faq.md)

---

## âš ï¸ å¸¸è¦‹é™·é˜±

### é™·é˜± 1ï¼šå¿˜è¨˜é¿å…å‰è¦–åå·®
```python
# âŒ éŒ¯èª¤ç¤ºç¯„
if date in rebalance_dates:
    tickers = compute_stock(date)
    for t in tickers:
        order_target_percent(symbol(t), 1/len(tickers))  # ç•¶å¤©å°±ä¸‹å–®ï¼
```

### é™·é˜± 2ï¼šæ—¥æœŸå°ä¸ä¸Š
```python
# è²¡å ±æ—¥æœŸæ˜¯ 2023-03-31ï¼Œä½†å¯¦éš›äº¤æ˜“æ—¥æ˜¯ 2023-04-03
# éœ€è¦ç¢ºä¿æ›è‚¡æ—¥æ˜¯å¯¦éš›äº¤æ˜“æ—¥
```

### é™·é˜± 3ï¼šæ•¸æ“šæ™‚é–“é»éŒ¯èª¤
```python
# å­£å ±é€šå¸¸å»¶é² 45 å¤©å…¬å‘Š
# 3/31 çš„è²¡å ±è¦åˆ° 5/15 æ‰èƒ½ç”¨
# éœ€è¦åŠ å…¥å»¶é²é‚è¼¯
```

---

**ğŸ‘‰ Next Step:** å‰å¾€ [template.md](template.md) é–‹å§‹é–‹ç™¼ä½ çš„ç­–ç•¥ï¼