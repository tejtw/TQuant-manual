
<!doctype html>
<html lang="zh-TW" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed egestas et ipsum sit amet pretium. Quisque sed ipsum sed lorem.">
      
      
        <meta name="author" content="TEJ">
      
      
        <link rel="canonical" href="http://127.0.0.1:8000/example/documents55/">
      
      
        <link rel="prev" href="../documents54/">
      
      
        <link rel="next" href="../documents14/">
      
      
      <link rel="icon" href="../../assets/images/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>回測範例(Example) - TQuant-manual</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XXXXXXXXXX"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XXXXXXXXXX",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tsmc" class="md-skip">
          跳轉到
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
              <button class="md-banner__button md-icon" aria-label="不再顯示此訊息">
                
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
              </button>
            
            
 <!-- Add announcement here, including arbitrary HTML -->
 如需最新更新，請關注 <strong>@squidfunk</strong> 在
  <a rel="me" href="https://github.com/tejtw/TQuant-Lab">
    <span class="twemoji">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </span>
    <strong>GitHub</strong>
  </a>

          </div>
          
            <script>var el=document.querySelector("[data-md-component=announce]");if(el){var content=el.querySelector(".md-typeset");__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0)}</script>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="頁首">
    <a href="../.." title="TQuant-manual" class="md-header__button md-logo" aria-label="TQuant-manual" data-md-component="logo">
      
  <img src="../../assets/images/demo-logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TQuant-manual
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              回測範例(Example)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="選擇語言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="https://kadin4134.github.io/mkdocs/" hreflang="zh-TW" class="md-select__link">
              中文
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="https://kadin4134.github.io/mkdocs/en/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜尋" placeholder="搜尋" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="搜尋">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清除" aria-label="清除" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜尋引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/tejtw/TQuant-manual" title="前往倉庫" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    TQuant-manual
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="導覽列" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="TQuant-manual" class="md-nav__button md-logo" aria-label="TQuant-manual" data-md-component="logo">
      
  <img src="../../assets/images/demo-logo.svg" alt="logo">

    </a>
    TQuant-manual
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tejtw/TQuant-manual" title="前往倉庫" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    TQuant-manual
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    首頁
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    技術手冊
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            技術手冊
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TQuant Lab 安裝 (Installation)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TQuant Lab 分析流程 (Workflow)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    擬真量化回測引擎 (Zipline)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            擬真量化回測引擎 (Zipline)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    新手教學(Simple Example)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_2" >
        
          
          <label class="md-nav__link" for="__nav_2_3_2" id="__nav_2_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    資料(Data)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_2">
            <span class="md-nav__icon md-icon"></span>
            資料(Data)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../docume/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ingest 價量資料(Ingest Pricing Data)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents9/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ingest 非價量資料(Ingest Fundamental Data)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    取得 benchmark 報酬率 (Get Risk-Free Rate)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    取得無風險利率 (Get Benchmark Roi)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    交易日曆(Calendars)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_4" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3_4" id="__nav_2_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3_4">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_4_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3_4_1" id="__nav_2_3_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    回測(Backtest)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_3_4_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3_4_1">
            <span class="md-nav__icon md-icon"></span>
            回測(Backtest)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    initialize
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents51/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    handle_data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents52/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    before_trading_start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents53/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    analyze
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents54/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    context
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_4_1_6" checked>
        
          
          <label class="md-nav__link" for="__nav_2_3_4_1_6" id="__nav_2_3_4_1_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    執行回測演算法(run_algorithm)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_2_3_4_1_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3_4_1_6">
            <span class="md-nav__icon md-icon"></span>
            執行回測演算法(run_algorithm)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    回測範例(Example)
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    回測範例(Example)
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目錄">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目錄
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      導入股價資料
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize" class="md-nav__link">
    <span class="md-ellipsis">
      Initialize 函式
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle_data" class="md-nav__link">
    <span class="md-ellipsis">
      Handle_data 函式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Handle_data 函式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ziplineapiorder" class="md-nav__link">
    <span class="md-ellipsis">
      zipline.api.order
    </span>
  </a>
  
    <nav class="md-nav" aria-label="zipline.api.order">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ziplinedatacurrent" class="md-nav__link">
    <span class="md-ellipsis">
      zipline.data.current
    </span>
  </a>
  
    <nav class="md-nav" aria-label="zipline.data.current">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters_1" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analyze" class="md-nav__link">
    <span class="md-ellipsis">
      Analyze 函式
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      Run_algorithm 函式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Run_algorithm 函式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ziplinerun_algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      zipline.run_algorithm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="zipline.run_algorithm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters_2" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_algorithm_1" class="md-nav__link">
    <span class="md-ellipsis">
      Run_algorithm 函式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Run_algorithm 函式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ziplinerun_algorithm_1" class="md-nav__link">
    <span class="md-ellipsis">
      zipline.run_algorithm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="zipline.run_algorithm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters_3" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returns_1" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_algorithm_2" class="md-nav__link">
    <span class="md-ellipsis">
      Run_algorithm 函式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Run_algorithm 函式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ziplinerun_algorithm_2" class="md-nav__link">
    <span class="md-ellipsis">
      zipline.run_algorithm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="zipline.run_algorithm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters_4" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returns_2" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    股票池(Universe API)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_4_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4_3" id="__nav_2_3_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    交易演算法API(Trading Algorithm API)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_3_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4_3">
            <span class="md-nav__icon md-icon"></span>
            交易演算法API(Trading Algorithm API)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    資料物件(Data Object)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents56/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    排程函數(Scheduling Functions)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_4_3_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4_3_3" id="__nav_2_3_4_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    下單函數(Orders)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_2_3_4_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4_3_3">
            <span class="md-nav__icon md-icon"></span>
            下單函數(Orders)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents57/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    order
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents58/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    order_target
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents59/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    order_percent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents60/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    order_target_percent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents61/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    order_value
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents62/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    order_target_value
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents63/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    get_open_orders
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents64/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    cancel_order
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents65/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    資產物件(Assets)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_4_3_5" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4_3_5" id="__nav_2_3_4_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    交易限制(Trading Controls)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_2_3_4_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4_3_5">
            <span class="md-nav__icon md-icon"></span>
            交易限制(Trading Controls)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents66/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    set_do_not_order_list
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents67/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    set_long_only
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents68/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    set_max_leverage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents69/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    set_max_order_count
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents70/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    set_max_order_size
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents71/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    set_max_position_size
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents72/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    回測參數(Simulation Parameters)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_4_3_7" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4_3_7" id="__nav_2_3_4_3_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    手續費模型(Commission Models)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_2_3_4_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4_3_7">
            <span class="md-nav__icon md-icon"></span>
            手續費模型(Commission Models)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents73/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PerDollar
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents74/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PerTrade
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents75/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PerShare
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents76/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom_TW_Commission
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents77/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    NoCommission
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_4_3_8" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4_3_8" id="__nav_2_3_4_3_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    滑價模型(Slippage Models)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_2_3_4_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4_3_8">
            <span class="md-nav__icon md-icon"></span>
            滑價模型(Slippage Models)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents78/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FixedSlippage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents79/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VolumeShareSlippage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents80/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FixedBasisPointsSlippag
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents81/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    NoSlippage
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents83/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    其他功能(Other API)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_4_4" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4_4" id="__nav_2_3_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pipeline API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_2_3_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4_4">
            <span class="md-nav__icon md-icon"></span>
            Pipeline API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    投資訊號生成工具(Pipeline)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents84/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipeline因子(Factor)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents85/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipeline濾網(Filter)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents86/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipeline分類器(Classifier)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents87/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipeline自訂因子(CustomFactor)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents88/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipeline計算元素(Term)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents89/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipeline遮網(Masking)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_4_4_8" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4_4_8" id="__nav_2_3_4_4_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pipeline資料集(DataSet)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_2_3_4_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4_4_8">
            <span class="md-nav__icon md-icon"></span>
            Pipeline資料集(DataSet)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents90/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    價量資料集(EquityPricing)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents91/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TEJ財務資料集(TQDataSet)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents92/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TEJ非財務資料集(TQAltDataSet)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents93/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自訂資料集(Custom Dataset)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents94/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipeline欄位(Column)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_4_4_10" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4_4_10" id="__nav_2_3_4_4_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pipeline內建因子(Built-in Factors)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_2_3_4_4_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4_4_10">
            <span class="md-nav__icon md-icon"></span>
            Pipeline內建因子(Built-in Factors)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents95/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AverageDollarVolume
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents96/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BollingerBands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents97/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DailyReturns
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents98/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SimpleMovingAverage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents99/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LinearWeightedMovingAverage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents100/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ExponentialWeightedMovingAverage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents101/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ExponentialWeightedMovingStdDev
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents102/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Latest
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents103/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MaxDrawdown
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents104/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Returns
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents105/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RollingPearson
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents106/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RollingLinearRegressionOfReturns
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents107/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RollingSpearmanOfReturns
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents108/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SimpleBeta
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents109/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RSI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents110/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    VWAP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents111/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WeightedAverageValue
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents112/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PercentChange
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents113/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PeerCount
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents114/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RateOfChangePercentage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents115/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Aroon
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents116/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FastStochasticOscillator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents117/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TrueRange
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents118/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IchimokuKinkoHyo
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_4_4_11" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4_4_11" id="__nav_2_3_4_4_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pipeline內建濾網(Built-in Filters)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_2_3_4_4_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4_4_11">
            <span class="md-nav__icon md-icon"></span>
            Pipeline內建濾網(Built-in Filters)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents119/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    All
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents120/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Any
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents121/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AtLeastN
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents122/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AllPresent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents123/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    StaticAssets
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents124/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    StaticSids
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents125/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SingleAsset
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents126/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    top/bottom
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents127/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    percentile_between
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents128/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    if_else
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_4_4_12" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4_4_12" id="__nav_2_3_4_4_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pipeline內建分類器(Built-in Classifiers)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_2_3_4_4_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4_4_12">
            <span class="md-nav__icon md-icon"></span>
            Pipeline內建分類器(Built-in Classifiers)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents129/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quartiles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents130/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quintiles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents131/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    deciles
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents132/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    quantiles
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents133/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pipeline引擎(Pipeline Engine)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_4_4_14" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4_4_14" id="__nav_2_3_4_4_14_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pipeline資料讀取(PipelineLoader)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="5" aria-labelledby="__nav_2_3_4_4_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4_4_14">
            <span class="md-nav__icon md-icon"></span>
            Pipeline資料讀取(PipelineLoader)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents134/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    EquityPricingLoader
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents135/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DataFrameLoader
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    交易所與資產屬性(Exchange and Asset Metadata)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bundle資料API(Data API)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents35/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    進階範例(Advanced Examples)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents36/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    版本發布(Releases)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents37/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    常見問題(FAQ)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents38/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    參考資源(Related References)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    可視化報表呈現 (Pyfolo)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            可視化報表呈現 (Pyfolo)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pyfolo安裝(Installation)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_4_2" >
        
          
          <label class="md-nav__link" for="__nav_2_4_2" id="__nav_2_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_2">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents39/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    公用函數(Utilites)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents40/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    因子績效報告(Tears)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents41/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    績效函數(Performance)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents42/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    繪圖函數(Ploting)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    進階範例(Advanced Examples)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    版本發布(Releases)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    常見問題(FAQ)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    參考資源(Related References)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    專業的因子分析工具 (Alphalens)
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            專業的因子分析工具 (Alphalens)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_5_2" >
        
          
          <label class="md-nav__link" for="__nav_2_5_2" id="__nav_2_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_2">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents43/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    公用函數(Utilites)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents44/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    因子績效報告(Tears)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents45/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    績效函數(Performance)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents46/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    繪圖函數(Ploting)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    進階範例(Advanced Examples)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    版本發布(Releases)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    常見問題(FAQ)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents26/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    參考資源(Related References)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    TejToolAPI
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            TejToolAPI
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TQuant Lab 安裝與API(Installation and API)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_6_2" >
        
          
          <label class="md-nav__link" for="__nav_2_6_2" id="__nav_2_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_2">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents47/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    取得資料(get_history_data)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents27/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    進階範例(Advanced Examples)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents28/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    常見問題(FAQ)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    版本發布(Releases)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Calendars
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            Calendars
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents7/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents30/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents31/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    版本發布(Releases)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_8" >
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Empyrical
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            Empyrical
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents8/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_8_2" >
        
          
          <label class="md-nav__link" for="__nav_2_8_2" id="__nav_2_8_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_2">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents48/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    公用函數(Utilites)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents49/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    (Stats)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents50/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    (Perf_attrib)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents32/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced Examples
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents33/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Releases
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents34/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Related References
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目錄">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目錄
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      導入股價資料
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialize" class="md-nav__link">
    <span class="md-ellipsis">
      Initialize 函式
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle_data" class="md-nav__link">
    <span class="md-ellipsis">
      Handle_data 函式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Handle_data 函式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ziplineapiorder" class="md-nav__link">
    <span class="md-ellipsis">
      zipline.api.order
    </span>
  </a>
  
    <nav class="md-nav" aria-label="zipline.api.order">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ziplinedatacurrent" class="md-nav__link">
    <span class="md-ellipsis">
      zipline.data.current
    </span>
  </a>
  
    <nav class="md-nav" aria-label="zipline.data.current">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters_1" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analyze" class="md-nav__link">
    <span class="md-ellipsis">
      Analyze 函式
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      Run_algorithm 函式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Run_algorithm 函式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ziplinerun_algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      zipline.run_algorithm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="zipline.run_algorithm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters_2" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_algorithm_1" class="md-nav__link">
    <span class="md-ellipsis">
      Run_algorithm 函式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Run_algorithm 函式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ziplinerun_algorithm_1" class="md-nav__link">
    <span class="md-ellipsis">
      zipline.run_algorithm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="zipline.run_algorithm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters_3" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returns_1" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run_algorithm_2" class="md-nav__link">
    <span class="md-ellipsis">
      Run_algorithm 函式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Run_algorithm 函式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ziplinerun_algorithm_2" class="md-nav__link">
    <span class="md-ellipsis">
      zipline.run_algorithm
    </span>
  </a>
  
    <nav class="md-nav" aria-label="zipline.run_algorithm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameters_4" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returns_2" class="md-nav__link">
    <span class="md-ellipsis">
      Returns:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="tsmc">TSMC 買進持有策略<a class="headerlink" href="#tsmc" title="Permanent link">&para;</a></h1>
<p>本次範例將以最經典的買進持有策略向您介紹 zipline 回測方法，並且介紹組建 zipline 交易策略最基礎的四大函式 - <code>initialize</code>、<code>handle_data</code>、<code>analyze</code>、<code>run_algorithm</code>。</p>
<h2 id="_1">導入股價資料<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>在 zipline 中，我們使用 <code>os</code> 搭配 <code>!zipline ingest</code> 將股價資料導入到本地端。常用寫法為: 
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>!zipline ingest -b tqant 
</span></code></pre></div>
其中 <code>-b</code> 為 bundle 之涵義，bundle 為股票價量資訊的載體，<code>tquant</code> 則是 bundle 之名稱，可由使用者自定義。在 ingest 之前，需先使用 <code>os</code> 設定環境變數，以方便 zipline 接收使用者所欲抓取之資產標的與年份之要求。一般而言，針對環境變數之寫法如下:
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>os.environ[&#39;TEJAPI_BASE&#39;] = &quot;https://api.tej.com.tw&quot; ==&gt; 導航至 tej api 網域。
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>os.environ[&#39;TEJAPI_KEY&#39;] = &quot;your key&quot; ==&gt; 個人 api key 以驗證身分。
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>os.environ[&#39;mdate&#39;] = &quot;20170601 20230702&quot; ==&gt; 欲抓取資料之日期區間，前者為起始日，後者為終止日。
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>os.environ[&#39;ticker&#39;] = &#39;2330 2337&#39; ==&gt; 所欲抓取股票之代碼。
</span></code></pre></div></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span> 
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TEJAPI_BASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;https://api.tej.com.tw&quot;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TEJAPI_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;your key&quot;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;mdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;20170601 20230702&quot;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2330 IR0001&#39;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="err">!</span><span class="n">zipline</span> <span class="n">ingest</span> <span class="o">-</span><span class="n">b</span> <span class="n">tquant</span>
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code>Merging daily equity files:


[2023-08-09 05:09:50.565678] INFO: zipline.data.bundles.core: Ingesting tquant.
</code></pre></div>
<h2 id="initialize">Initialize 函式<a class="headerlink" href="#initialize" title="Permanent link">&para;</a></h2>
<p><code>initialize</code> 為構建 zipline 交易策略的重要函式，會在回測開始前被呼叫一次，主要任務為設定回測環境，常見用於設定滑價或手續費。分別可以使用:</p>
<ol>
<li>
<p>zipline.api.set_slippage</p>
<p>設定滑價模式，zipline 共提供四種滑價計算方法，詳請請見後續教學-zipline slippage。</p>
</li>
<li>
<p>zipline.api.set_commission</p>
<p>設定手續費模式，zipline 共提供三種手續費計算方法，詳請請見後續教學-zipline commission。</p>
</li>
</ol>
<p>常見的寫法如下:
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>def initialize(context):
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    set_slippage(slippage.FixedSlippage())
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    set_commission(commission.PerShare(cost=0.00285))
</span></code></pre></div>
除此之外，我們可以注意到 initialize 含有一個參數 <strong>context</strong>，<strong>context</strong> 為一個命名空間 (namespace)，可以在儲存各種自定義之變數並且在每次交易日中循環呼叫。舉例來說，我們設置一個變數 (context.day = 0) 來計算交易日天數與一個變數 (context.has_ordered = False) 紀錄是否已經持有台積電股票。
<div class="language-text highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>def initialize(context):
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    context.day = 0
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    context.has_ordered = False
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    set_slippage(slippage.FixedSlippage())
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    set_commission(commission.PerShare(cost=0.00285))
</span></code></pre></div></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">set_slippage</span><span class="p">,</span> <span class="n">set_commission</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.finance</span><span class="w"> </span><span class="kn">import</span> <span class="n">slippage</span><span class="p">,</span> <span class="n">commission</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>    <span class="n">context</span><span class="o">.</span><span class="n">day</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="n">context</span><span class="o">.</span><span class="n">has_ordered</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="n">set_slippage</span><span class="p">(</span><span class="n">slippage</span><span class="o">.</span><span class="n">FixedSlippage</span><span class="p">())</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="n">set_commission</span><span class="p">(</span><span class="n">commission</span><span class="o">.</span><span class="n">PerShare</span><span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mf">0.00285</span><span class="p">))</span>
</span></code></pre></div>
<h2 id="handle_data">Handle_data 函式<a class="headerlink" href="#handle_data" title="Permanent link">&para;</a></h2>
<p><code>handle_data</code> 為構建 zipline 交易策略的重要函式，會在回測開始後每天被呼叫，主要任務為設定交易策略、下單與紀錄交易資訊。</p>
<p>其中 <code>handle_data</code> 含有兩種參數 -- <strong>context</strong> , <strong>data</strong>。<strong>context</strong> 與上述 <code>initialize</code> 介紹功能相同，這裡為了記錄交易天數與否持有台積電股票，我們設定為:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>def handle_data(context, data):
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>    # 每次交易日加 1 天。
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>    context.day += 1 
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    # 判別是否持有台積電，請注意我們在 initialize 設定 context.has_ordered 為 False。
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>    if not context.has_ordered:
</span></code></pre></div>
<p>接著我們引入交易下單函式，下單函式共有六個不同種類，請見教材中以 zipline order 開頭之文件，這裡使用最基礎的下單函式:</p>
<h3 id="ziplineapiorder">zipline.api.order<a class="headerlink" href="#ziplineapiorder" title="Permanent link">&para;</a></h3>
<p>買進或賣出 n 股的資產標的。</p>
<h4 id="parameters">Parameters:<a class="headerlink" href="#parameters" title="Permanent link">&para;</a></h4>
<ul>
<li>asset: <em>zipline.assets.Asset</em>
        欲下單之資產，請注意資料型態為 zipline 獨有的 Asset 型態。</li>
<li>amount: <em>int</em>
        欲下單股數。</li>
<li>limit_price: <em>float</em>, optional
        限價。</li>
<li>stop_price: <em>float</em>, optional
        停價。</li>
</ul>
<p>加入下單函式 order(symbol("2330")，其中 symbol("2330") 就是 zipline 中的 Asset 資料型態。之後，我們會將 context.has_ordered 調整成 True，此時下個交易日就不會再度下單，更改完程式如下:
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>def handle_data(context, data):
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    context.day += 1 
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>    if not context.has_ordered:
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>        # 下單台積電股票一張 == 1000股
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>        order(symbol(&quot;2330&quot;, 1000)
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>        # 設定 context.has_ordered 為 True 以避免下次交易日下單
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>        context.has_ordered = True
</span></code></pre></div>
最後為了記錄交易天數、是否持有部位與當日價格，我們使用 <code>record</code> 函式，其功能為記錄每個交易日的資訊並且在最終 <code>run_algorithm</code> 輸出的資料表中，以欄位型式加入所紀錄資訊。其程式編輯方式如下:
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>record( 欄位名稱 = 資訊)
</span></code></pre></div>
這裡我們紀錄當天交易天數 (context.day)、是否持有部位 (context.has_ordered) 與當天收盤價格 (data.current(symbol("2330"), "close"))，其中上面所提到的 data 就是在 <code>handle_data</code> 中的 <strong>data</strong>，<strong>data</strong> 主要功能為保存每天股價的價量資料並且提供呼叫，於本實例我們欲紀錄當天收盤價，於是用到 <code>data.current()</code> 函式。</p>
<h3 id="ziplinedatacurrent">zipline.data.current<a class="headerlink" href="#ziplinedatacurrent" title="Permanent link">&para;</a></h3>
<p>呼叫股票的當日價量資訊。</p>
<h4 id="parameters_1">Parameters:<a class="headerlink" href="#parameters_1" title="Permanent link">&para;</a></h4>
<ul>
<li>assets: <em>zipline.asset.Asset</em>
        所欲呼叫的股票，請注意資料型態為 zipline 獨有的 Asset 型態。</li>
<li>fields: <em>str</em>
        所欲呼叫的價量資訊，提供 'close', 'open', 'high', 'low' 與 'volume'。</li>
</ul>
<p>由於我們希望記錄台積電當日收盤價格，因此程式編輯如下:
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>def handle_data(context, data):
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    context.day += 1 
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    if not context.has_ordered:
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>        order(symbol(&quot;2330&quot;, 1000)
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>        context.has_ordered = True
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    record( # 紀錄用
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>        trade_days = context.day,
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>        has_ordered = context.has_ordered,
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>        TSMC = data.current(symbol(&quot;2330&quot;), &quot;close&quot;)
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>    )
</span></code></pre></div></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">order</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">symbol</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">handle_data</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="n">context</span><span class="o">.</span><span class="n">day</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="o">.</span><span class="n">has_ordered</span><span class="p">:</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>        <span class="n">order</span><span class="p">(</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;2330&quot;</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>        <span class="n">context</span><span class="o">.</span><span class="n">has_ordered</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>    <span class="n">record</span><span class="p">(</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>        <span class="n">trade_days</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>        <span class="n">has_ordered</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">has_ordered</span><span class="p">,</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="n">TSMC</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">current</span><span class="p">(</span><span class="n">symbol</span><span class="p">(</span><span class="s2">&quot;2330&quot;</span><span class="p">),</span> <span class="s2">&quot;close&quot;</span><span class="p">)</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>    <span class="p">)</span>
</span></code></pre></div>
<h2 id="analyze">Analyze 函式<a class="headerlink" href="#analyze" title="Permanent link">&para;</a></h2>
<p><code>analyze</code> 主要用於回測後視覺化策略績效與風險，這裡我們以 <code>matplotlib</code> 繪製投組價值表與台積電股價走勢表。其中 <code>analyze</code> 有兩個參數 <strong>context</strong> 與 <strong>perf</strong>，<strong>context</strong> 就與上述相同，<strong>perf</strong> 就是最終 <code>run_algorithm</code> 輸出的資料表 -- <strong>results</strong>。我們可以提取裡面特定欄位來繪製圖表。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">analyze</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">perf</span><span class="p">):</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>    <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="n">perf</span><span class="o">.</span><span class="n">portfolio_value</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;portfolio values&#39;</span><span class="p">)</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="n">perf</span><span class="p">[</span><span class="s1">&#39;TSMC&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;TSMC close&#39;</span><span class="p">)</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></div>
<h2 id="run_algorithm">Run_algorithm 函式<a class="headerlink" href="#run_algorithm" title="Permanent link">&para;</a></h2>
<h3 id="ziplinerun_algorithm">zipline.run_algorithm<a class="headerlink" href="#ziplinerun_algorithm" title="Permanent link">&para;</a></h3>
<p>進行策略回測。</p>
<h4 id="parameters_2">Parameters:<a class="headerlink" href="#parameters_2" title="Permanent link">&para;</a></h4>
<ul>
<li>start: <em>pd.Timestamp</em> or <em>datetime</em>
        回測起始日期。</li>
<li>end: <em>pd.Timestamp</em> or <em>datetime</em>
        回測結束日期。</li>
<li>initialize: <em>callable</em>
        呼叫 initialize 函式以用於回測。</li>
<li>capital_base: <em>int</em>
        初始資金額度。</li>
<li>handle_data: <em>callable</em>, optional
        呼叫 handle_data 函式以用於回測。</li>
<li>before_trading_start: <em>callable</em>, optional
        呼叫 before_trading_start 函式以用於回測。</li>
<li>analyze: <em>callable</em>, optional
        呼叫 analyze 函式以用於回測。</li>
<li>data_frequency: <em>{"daily", "minute"}</em>, optional
        設置交易頻率。</li>
<li>bundle: <em>str</em>, optional
        設置回測用的 bundle。</li>
<li>trading_calendar: <em>TradingCalendar</em>, optional
        設置交易日曆。</li>
<li>benchmark_returns: <em>pd.Series</em>, optional
        設置指標報酬率。</li>
<li>treasury_returns: <em>pd.Series</em>, optional
        設置無風險利率。</li>
</ul>
<h4 id="returns">Returns:<a class="headerlink" href="#returns" title="Permanent link">&para;</a></h4>
<p>Perf: <em>pd.DataFrame</em>, 內建欄位有:</p>
<ul>
<li>benchmark_return：
    當日的benchmark報酬率，若是由<code>set_benchmark()</code>設定，則計算方式為(當日benchmark收盤價 / 前一日benchmark收盤價) - 1。</li>
<li>benchmark_period_return：
    累積的benchmark日報酬率。計算方式：np.nancumprod(1 + <code>benchmark_return</code> Series) - 1。</li>
<li>treasury_return：
    當日的treasury報酬率，直接由TEJ API提供。</li>
<li>treasury_period_return：
    累積的treasury日報酬率。計算方式：np.nancumprod(1 + <code>treasury_return</code> Series) - 1。</li>
<li>
<p>benchmark_volatility：
    benchmark日報酬率的年化波動率，至少需有兩期的報酬率才進行計算。計算方式：(<code>benchmark_return</code> Series).expanding(2).std(ddof=1) * np.sqrt(252)</p>
</li>
<li>
<p>orders：顯示下單紀錄
    每一筆下單用一個字典的方式呈現，其中：</p>
</li>
<li>id：虛擬單號。</li>
<li>dt：下單時間。</li>
<li>reason：None, Hold, or Reject（目前不適用）</li>
<li>created：建立時間。</li>
<li>amount：<ul>
<li>下單股數。</li>
<li>若&gt;0表示買進或回補，&lt;0表示賣出或放空。</li>
<li>若有發股票股利或股票分割的情形，除權日當天會更新之前未成交訂單的amount（new_amount = old_amount / ratio，其中ratio = 1/僅除權調整係數）。</li>
</ul>
</li>
<li>
<p>filled：成交股數。</p>
<ul>
<li>註：Order execution - 當演算法在某一天下單時，該訂單會在下一個交易日成交，以避免lookahead bias。   </li>
</ul>
</li>
<li>
<p>commission：該筆交易傭金。</p>
</li>
<li>stop：停損價，若有發股票股利或股票分割的情形，除權日當天會更新之前未成交訂單的stop price（new_stop = old_stop * ratio，其中ratio = 1/僅除權調整係數）。</li>
<li>limit：限價價，若有發股票股利或股票分割的情形，除權日當天會更新之前未成交訂單的limit price（new_limit = old_limit * ratio，其中ratio = 1/僅除權調整係數）。</li>
<li>stop_reached：<ul>
<li>對於buy stop order，若現價&gt;=stop price，則顯示True否則False。</li>
<li>對於sell stop order，若現價&lt;=stop price，則顯示True否則False。</li>
</ul>
</li>
<li>limit_reached：<ul>
<li>對於buy limit order，若現價&lt;=limit price，則顯示True否則False。</li>
<li>對於sell limit order，若現價&gt;=limit price，則顯示True否則False。</li>
</ul>
</li>
<li>sid（asset）：下單的標的。</li>
<li>
<p>status：若=0表示OPEN（未完全成交），=1表示FILLED（完全成交），=2表示CANCEL（已取消）。</p>
</li>
<li>
<p>transactions：顯示交易紀錄</p>
</li>
<li>amount：下單股數。</li>
<li>dt ： 交易時間。</li>
<li>price：成交價（為調整前收盤價，不調整股息、分割、股票股利）。</li>
<li>order_id：單號，可與orders中的id比對。</li>
<li>sid（asset）：下單的標的。</li>
<li>
<p>commission：一律為None。傭金資料已經在'orders'底下。</p>
</li>
<li>
<p>positions：顯示持有部位</p>
</li>
<li>sid（asset）：下單的標的。</li>
<li>amount：該標的總持有股數。除權日當天amount會進行調整（old_amount / ratio = new_amount，其中ratio = 1/僅除權調整係數）。</li>
<li>last_sale_price：標的最近一筆的收盤價。</li>
<li>cost_basis：每股平均成本（含commissions）。<ul>
<li>計算方法為：sum(成交價 * (1+commission) * 股數) / 總股數</li>
<li>除權日當天cost_basis會進行調整（old_cost_basis * ratio = new_cost_basis，其中ratio = 1/僅除權調整係數）。</li>
<li>對於買進或回補來說，commissions會造成cost_basis增加；對於賣出或放空來說，commissions會造成cost_basis減少。</li>
</ul>
</li>
<li>longs_count：</li>
<li>當日帳上有幾檔長部位股票。可與<code>positions</code>比較。</li>
<li>shorts_count：</li>
<li>當日帳上有幾檔短部位股票。可與<code>positions</code>比較。</li>
<li>long_exposure（long_value）：</li>
<li>當日帳上長部位的市值。</li>
<li>可與<code>positions</code>比較。</li>
<li>當投資標的為股票時<code>long_exposure</code>和<code>long_value</code>兩欄位數值一致。</li>
<li>計算方式為sum(持有股數 * 收盤價) = sum(amount * last_sale_price)，where amount &gt; 0。</li>
<li>short_exposure（short_value）：</li>
<li>當日帳上短部位的市值。</li>
<li>可與<code>positions</code>比較。</li>
<li>當投資標的為股票時<code>short_exposure</code>和<code>short_value</code>兩欄位數值一致。</li>
<li>計算方式為sum(持有股數 * 收盤價) = sum(amount * last_sale_price)，where amount &lt; 0。</li>
<li>short_exposure必然 &lt;= 0。</li>
<li>ending_exposure（ending_value）：</li>
<li>當日結束時帳上部位的淨市值。</li>
<li>計算方式：<code>long_exposure</code> + <code>short_exposure</code></li>
<li>starting_exposure（starting_value）：</li>
<li>當日開始時帳上部位的淨市值。</li>
<li>為前一日的<code>ending_exposure</code>。</li>
<li>gross_leverage（leverage）：</li>
<li>Gross leverage is the sum of long and short leverage exposureper share divided by net asset value（portfolio_value）。</li>
<li>計算方式：（<code>long_exposure</code> - <code>short_exposure</code>）／<code>portfolio_value</code></li>
<li>net_leverage：</li>
<li>Net leverage is the net leverage exposure per share divided by net asset value（portfolio_value）。</li>
<li>計算方式：（<code>long_exposure</code> + <code>short_exposure</code>）／<code>portfolio_value</code></li>
<li>capital_used：</li>
<li>當天的cash flow。&gt;0表示流入，&lt;0表示流出。</li>
<li>計算方式：<ul>
<li>-1 * sum(<code>transaction.price</code> * <code>transaction.amount</code>) - sum(<code>order.commission</code>) + sum(earn_dividends) + sum(leftover_cash)</li>
</ul>
</li>
<li>
<p>註：    </p>
<ol>
<li>earn_dividends：會於pay_date當天配發。</li>
<li>leftover_cash：分割、股票股利等原因導致股數變動時，若有&lt;1股(fractional_share_count)無法分配的情況時則返回現金。</li>
<li>leftover_cash範例：</li>
<li>若現在持有100股（amount），ratio=3。</li>
<li>新的amount理論上是100/3=33.333，然而不滿一股的部分需轉換成現金 (return cash)。</li>
<li>所以新的amount會是33，剩餘的0.333股（33.333-33）就是fractional_share_count。</li>
<li>由於ratio=3代表該公司股數有發生變動，所以每股平均成本 (cost basis)需調整=原cost basis * 原amount / 新amount 後四捨五入到小數第二位。</li>
<li>所以退回現金(return cash)=(fractional_share_count) * (新cost basis) 再四捨五入到小數第二位</li>
</ol>
</li>
<li>
<p>ending_cash：</p>
</li>
<li>當日結束時帳上持有現金。</li>
<li>計算方式：<code>starting_cash</code>+<code>capital_used</code></li>
<li>starting_cash：</li>
<li>當日開始時帳上持有現金。</li>
<li>為前一日的<code>ending_cash</code>+sum(earn_dividends)，若無前一日則為<code>capital_base</code>。</li>
<li>pnl：</li>
<li>當日投資組合損益。</li>
<li>計算方式：(<code>ending_exposure</code> + <code>ending_cash</code>) - (<code>starting_exposure</code> + <code>starting_cash</code>)。</li>
<li>returns：</li>
<li>當日報酬率。</li>
<li>計算方式：(當日<code>portfolio_value</code>) / (前一日<code>portfolio_value</code>) - 1。</li>
<li>存在尾差。</li>
<li>portfolio_value：</li>
<li>即net asset value，當日投資組合總價值。</li>
<li>計算方式：(<code>ending_exposure</code> + <code>ending_cash</code>)</li>
<li>algorithm_period_return：</li>
<li>投資組合累積日報酬率。</li>
<li>計算方式：( 1 + 前一日的<code>algorithm_period_return</code>) * ( 1 + 當日<code>returns</code>) - 1。</li>
<li>存在尾差。</li>
<li>algo_volatility：</li>
<li>投資組合日報酬率的年化波動率，至少需有兩期的報酬率才進行計算。</li>
<li>利用empyrical套件計算：
    <br> empyrical.annual_volatility(<code>returns</code>Series, period='daily', alpha=2.0, annualization=None)。</li>
<li>具體來說，empyrical套件的計算方式為：<code>returns</code>Series.std(ddof=1) * (252 ** (1 / 2))，std為樣本標準差。</li>
<li>用完整<code>returns</code>資料，則會回傳最後一日algo_volatility，若扣掉最後一日<code>returns</code>，則回傳倒數第二日，以此類推。  </li>
<li>excess_return：</li>
<li>投資組合累積超額日報酬（相對於<code>benchmark_period_return</code>）。</li>
<li>計算方式為：(<code>algorithm_period_return</code> - <code>benchmark_period_return</code>)。</li>
<li>max_drawdown：</li>
<li>投資組合累積報酬率從過去的峰值下跌的最大跌幅百分比。</li>
<li>利用empyrical套件計算：empyrical.max_drawdown(<code>returns</code> Series)。</li>
<li>具體來說，empyrical套件的計算方式為：<ul>
<li>cumulative_returns：先計算過去每一日的累積報酬。</li>
<li>previous_peaks：計算過去累積報酬率的最大值。</li>
<li>daily_drawdown：計算每日回撤 = (cumulative_returns - previous_peaks) / previous_peaks</li>
<li>max_drawdown：過去每一日的daily_drawdown取極小值。</li>
</ul>
</li>
<li>sharpe：</li>
<li>年化夏普比率，衡量每承擔1單位風險，可以獲取多少的報酬。</li>
<li>利用empyrical套件計算：empyrical.sharpe_ratio(<code>returns</code> Series, risk_free=0)。</li>
<li>具體來說，empyrical套件的計算方式為：
    <br>np.mean(<code>returns</code> Series) / np.std(<code>returns</code> Series,ddof=1) * np.sqrt(252)</li>
<li>sortino：   </li>
<li>年化索提諾比率，衡量承擔單位下方風險，可以獲取多少的報酬。</li>
<li>利用empyrical套件計算：empyrical.sortino_ratio(<code>returns</code> Series, required_return=0)。</li>
<li>具體來說，empyrical套件的計算方式為：<ul>
<li>計算downside_risk：np.sqrt(np.nanmean(np.square(downside_return))) * np.sqrt(252)，其中downside_return將<code>returns</code> Series中&gt;0的數值替換成0。</li>
<li>計算mean_return：np.nanmean(<code>returns</code> Series)</li>
<li>計算sortino_ratio =  mean_return / downside_risk * 252。</li>
</ul>
</li>
<li>
<p>存在尾差。</p>
</li>
<li>
<p>alpha：</p>
</li>
<li>年化alpha，衡量投資組合創造超額報酬的能力。</li>
<li>利用empyrical套件計算：empyrical.alpha_beta_aligned(returns=<code>returns</code>Series, factor_returns=<code>benchmark_return</code> Series,risk_free=0.0)</li>
<li>具體來說，empyrical套件的計算方式為：<ul>
<li>計算alpha_series：<code>returns</code> Series - (當日<code>beta</code> * <code>benchmark_return</code> Series)</li>
<li>計算平均alpha：nanmean(alpha_series)</li>
<li>計算年化alpha：(平均alpha + 1) ^ 252 -1  </li>
</ul>
</li>
<li>beta：    </li>
<li>衡量投資組合相對於整體市場的波動性。</li>
<li>利用empyrical套件計算：empyrical.alpha_beta_aligned(returns=<code>returns</code>Series, factor_returns=<code>benchmark_return</code> Series,risk_free=0.0)</li>
<li>具體來說，empyrical套件的計算方式為：
    <br>Cov(<code>benchmark_return</code> Series, <code>returns</code> Series) / Var(<code>benchmark_return</code> Series)</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_algorithm</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span> 
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2018-12-30&#39;</span><span class="p">,</span><span class="n">tz</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="n">end_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2023-05-26&#39;</span><span class="p">,</span><span class="n">tz</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="n">results</span> <span class="o">=</span> <span class="n">run_algorithm</span><span class="p">(</span><span class="n">start</span><span class="o">=</span> <span class="n">start_date</span><span class="p">,</span>  
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>                       <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>                       <span class="n">initialize</span><span class="o">=</span><span class="n">initialize</span><span class="p">,</span>                       
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>                       <span class="n">capital_base</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span>                       
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>                       <span class="n">analyze</span><span class="o">=</span><span class="n">analyze</span><span class="p">,</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>                       <span class="n">handle_data</span><span class="o">=</span><span class="n">handle_data</span><span class="p">,</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>                       <span class="n">data_frequency</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>                       <span class="n">bundle</span><span class="o">=</span><span class="s1">&#39;tquant&#39;</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>                       <span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">results</span>
</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>period_open</th>
      <th>period_close</th>
      <th>short_value</th>
      <th>long_exposure</th>
      <th>benchmark_return</th>
      <th>treasury_return</th>
      <th>pnl</th>
      <th>short_exposure</th>
      <th>capital_used</th>
      <th>returns</th>
      <th>...</th>
      <th>treasury_period_return</th>
      <th>algorithm_period_return</th>
      <th>alpha</th>
      <th>beta</th>
      <th>sharpe</th>
      <th>sortino</th>
      <th>max_drawdown</th>
      <th>max_leverage</th>
      <th>trading_days</th>
      <th>period_label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2019-01-02 13:30:00+08:00</th>
      <td>2019-01-02 09:01:00+08:00</td>
      <td>2019-01-02 13:30:00+08:00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>0.000000</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.000000</td>
      <td>None</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1</td>
      <td>2019-01</td>
    </tr>
    <tr>
      <th>2019-01-03 13:30:00+08:00</th>
      <td>2019-01-03 09:01:00+08:00</td>
      <td>2019-01-03 13:30:00+08:00</td>
      <td>0.0</td>
      <td>215500.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2.85</td>
      <td>0.0</td>
      <td>-215502.85</td>
      <td>-0.000003</td>
      <td>...</td>
      <td>0.0</td>
      <td>-0.000003</td>
      <td>None</td>
      <td>None</td>
      <td>-11.224972</td>
      <td>-11.224972</td>
      <td>-0.000003</td>
      <td>0.215501</td>
      <td>2</td>
      <td>2019-01</td>
    </tr>
    <tr>
      <th>2019-01-04 13:30:00+08:00</th>
      <td>2019-01-04 09:01:00+08:00</td>
      <td>2019-01-04 13:30:00+08:00</td>
      <td>0.0</td>
      <td>208000.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-7500.00</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>-0.007500</td>
      <td>...</td>
      <td>0.0</td>
      <td>-0.007503</td>
      <td>None</td>
      <td>None</td>
      <td>-9.170376</td>
      <td>-9.168633</td>
      <td>-0.007503</td>
      <td>0.215501</td>
      <td>3</td>
      <td>2019-01</td>
    </tr>
    <tr>
      <th>2019-01-07 13:30:00+08:00</th>
      <td>2019-01-07 09:01:00+08:00</td>
      <td>2019-01-07 13:30:00+08:00</td>
      <td>0.0</td>
      <td>213000.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5000.00</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>0.005038</td>
      <td>...</td>
      <td>0.0</td>
      <td>-0.002503</td>
      <td>None</td>
      <td>None</td>
      <td>-1.893153</td>
      <td>-2.608781</td>
      <td>-0.007503</td>
      <td>0.215501</td>
      <td>4</td>
      <td>2019-01</td>
    </tr>
    <tr>
      <th>2019-01-08 13:30:00+08:00</th>
      <td>2019-01-08 09:01:00+08:00</td>
      <td>2019-01-08 13:30:00+08:00</td>
      <td>0.0</td>
      <td>211000.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-2000.00</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>-0.002005</td>
      <td>...</td>
      <td>0.0</td>
      <td>-0.004503</td>
      <td>None</td>
      <td>None</td>
      <td>-3.141155</td>
      <td>-4.087705</td>
      <td>-0.007503</td>
      <td>0.215501</td>
      <td>5</td>
      <td>2019-01</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-05-22 13:30:00+08:00</th>
      <td>2023-05-22 09:01:00+08:00</td>
      <td>2023-05-22 13:30:00+08:00</td>
      <td>0.0</td>
      <td>531000.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-1000.00</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>-0.000734</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.362247</td>
      <td>None</td>
      <td>None</td>
      <td>0.816172</td>
      <td>1.250657</td>
      <td>-0.202433</td>
      <td>0.455182</td>
      <td>1063</td>
      <td>2023-05</td>
    </tr>
    <tr>
      <th>2023-05-23 13:30:00+08:00</th>
      <td>2023-05-23 09:01:00+08:00</td>
      <td>2023-05-23 13:30:00+08:00</td>
      <td>0.0</td>
      <td>530000.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-1000.00</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>-0.000734</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.361247</td>
      <td>None</td>
      <td>None</td>
      <td>0.813954</td>
      <td>1.247253</td>
      <td>-0.202433</td>
      <td>0.455182</td>
      <td>1064</td>
      <td>2023-05</td>
    </tr>
    <tr>
      <th>2023-05-24 13:30:00+08:00</th>
      <td>2023-05-24 09:01:00+08:00</td>
      <td>2023-05-24 13:30:00+08:00</td>
      <td>0.0</td>
      <td>525000.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>-5000.00</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>-0.003673</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.356247</td>
      <td>None</td>
      <td>None</td>
      <td>0.804283</td>
      <td>1.232180</td>
      <td>-0.202433</td>
      <td>0.455182</td>
      <td>1065</td>
      <td>2023-05</td>
    </tr>
    <tr>
      <th>2023-05-25 13:30:00+08:00</th>
      <td>2023-05-25 09:01:00+08:00</td>
      <td>2023-05-25 13:30:00+08:00</td>
      <td>0.0</td>
      <td>543000.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>18000.00</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>0.013272</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.374247</td>
      <td>None</td>
      <td>None</td>
      <td>0.835019</td>
      <td>1.282067</td>
      <td>-0.202433</td>
      <td>0.455182</td>
      <td>1066</td>
      <td>2023-05</td>
    </tr>
    <tr>
      <th>2023-05-26 13:30:00+08:00</th>
      <td>2023-05-26 09:01:00+08:00</td>
      <td>2023-05-26 13:30:00+08:00</td>
      <td>0.0</td>
      <td>566000.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>23000.00</td>
      <td>0.0</td>
      <td>0.00</td>
      <td>0.016736</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.397247</td>
      <td>None</td>
      <td>None</td>
      <td>0.873009</td>
      <td>1.345075</td>
      <td>-0.202433</td>
      <td>0.455182</td>
      <td>1067</td>
      <td>2023-05</td>
    </tr>
  </tbody>
</table>
<p>1067 rows × 42 columns</p>
</div>

<p>我們可以發現之前使用 <code>order</code> 紀錄的 trade_days, has_ordered 與 TSMC 確實以欄位型式記錄在 <strong>results</strong> 表中。 </p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">results</span><span class="p">[[</span><span class="s1">&#39;trade_days&#39;</span><span class="p">,</span><span class="s1">&#39;has_ordered&#39;</span><span class="p">,</span><span class="s1">&#39;TSMC&#39;</span><span class="p">]]</span>
</span></code></pre></div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>trade_days</th>
      <th>has_ordered</th>
      <th>TSMC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2019-01-02 13:30:00+08:00</th>
      <td>1</td>
      <td>True</td>
      <td>219.5</td>
    </tr>
    <tr>
      <th>2019-01-03 13:30:00+08:00</th>
      <td>2</td>
      <td>True</td>
      <td>215.5</td>
    </tr>
    <tr>
      <th>2019-01-04 13:30:00+08:00</th>
      <td>3</td>
      <td>True</td>
      <td>208.0</td>
    </tr>
    <tr>
      <th>2019-01-07 13:30:00+08:00</th>
      <td>4</td>
      <td>True</td>
      <td>213.0</td>
    </tr>
    <tr>
      <th>2019-01-08 13:30:00+08:00</th>
      <td>5</td>
      <td>True</td>
      <td>211.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-05-22 13:30:00+08:00</th>
      <td>1063</td>
      <td>True</td>
      <td>531.0</td>
    </tr>
    <tr>
      <th>2023-05-23 13:30:00+08:00</th>
      <td>1064</td>
      <td>True</td>
      <td>530.0</td>
    </tr>
    <tr>
      <th>2023-05-24 13:30:00+08:00</th>
      <td>1065</td>
      <td>True</td>
      <td>525.0</td>
    </tr>
    <tr>
      <th>2023-05-25 13:30:00+08:00</th>
      <td>1066</td>
      <td>True</td>
      <td>543.0</td>
    </tr>
    <tr>
      <th>2023-05-26 13:30:00+08:00</th>
      <td>1067</td>
      <td>True</td>
      <td>566.0</td>
    </tr>
  </tbody>
</table>
<p>1067 rows × 3 columns</p>
</div>

<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>
</span></code></pre></div>
<h2 id="run_algorithm_1">Run_algorithm 函式<a class="headerlink" href="#run_algorithm_1" title="Permanent link">&para;</a></h2>
<h3 id="ziplinerun_algorithm_1">zipline.run_algorithm<a class="headerlink" href="#ziplinerun_algorithm_1" title="Permanent link">&para;</a></h3>
<p>進行策略回測。</p>
<h4 id="parameters_3">Parameters:<a class="headerlink" href="#parameters_3" title="Permanent link">&para;</a></h4>
<ul>
<li>start: <em>pd.Timestamp</em> or <em>datetime</em>
        回測起始日期。</li>
<li>end: <em>pd.Timestamp</em> or <em>datetime</em>
        回測結束日期。</li>
<li>initialize: <em>callable</em>
        呼叫 initialize 函式以用於回測。</li>
<li>capital_base: <em>int</em>
        初始資金額度。</li>
<li>handle_data: <em>callable</em>, optional
        呼叫 handle_data 函式以用於回測。</li>
<li>before_trading_start: <em>callable</em>, optional
        呼叫 before_trading_start 函式以用於回測。</li>
<li>analyze: <em>callable</em>, optional
        呼叫 analyze 函式以用於回測。</li>
<li>data_frequency: <em>{"daily", "minute"}</em>, optional
        設置交易頻率。</li>
<li>bundle: <em>str</em>, optional
        設置回測用的 bundle。</li>
<li>trading_calendar: <em>TradingCalendar</em>, optional
        設置交易日曆。</li>
<li>benchmark_returns: <em>pd.Series</em>, optional
        設置指標報酬率。</li>
<li>treasury_returns: <em>pd.Series</em>, optional
        設置無風險利率。</li>
</ul>
<h4 id="returns_1">Returns:<a class="headerlink" href="#returns_1" title="Permanent link">&para;</a></h4>
<p>Perf: <em>pd.DataFrame</em>, 內建欄位有:</p>
<ul>
<li>benchmark_return：
    當日的benchmark報酬率，若是由<code>set_benchmark()</code>設定，則計算方式為(當日benchmark收盤價 / 前一日benchmark收盤價) - 1。</li>
<li>benchmark_period_return：
    累積的benchmark日報酬率。計算方式：np.nancumprod(1 + <code>benchmark_return</code> Series) - 1。</li>
<li>treasury_return：
    當日的treasury報酬率，直接由TEJ API提供。</li>
<li>treasury_period_return：
    累積的treasury日報酬率。計算方式：np.nancumprod(1 + <code>treasury_return</code> Series) - 1。</li>
<li>
<p>benchmark_volatility：
    benchmark日報酬率的年化波動率，至少需有兩期的報酬率才進行計算。計算方式：(<code>benchmark_return</code> Series).expanding(2).std(ddof=1) * np.sqrt(252)</p>
</li>
<li>
<p>orders：顯示下單紀錄
    每一筆下單用一個字典的方式呈現，其中：</p>
</li>
<li>id：虛擬單號。</li>
<li>dt：下單時間。</li>
<li>reason：None, Hold, or Reject（目前不適用）</li>
<li>created：建立時間。</li>
<li>amount：<ul>
<li>下單股數。</li>
<li>若&gt;0表示買進或回補，&lt;0表示賣出或放空。</li>
<li>若有發股票股利或股票分割的情形，除權日當天會更新之前未成交訂單的amount（new_amount = old_amount / ratio，其中ratio = 1/僅除權調整係數）。</li>
</ul>
</li>
<li>
<p>filled：成交股數。</p>
<ul>
<li>註：Order execution - 當演算法在某一天下單時，該訂單會在下一個交易日成交，以避免lookahead bias。   </li>
</ul>
</li>
<li>
<p>commission：該筆交易傭金。</p>
</li>
<li>stop：停損價，若有發股票股利或股票分割的情形，除權日當天會更新之前未成交訂單的stop price（new_stop = old_stop * ratio，其中ratio = 1/僅除權調整係數）。</li>
<li>limit：限價價，若有發股票股利或股票分割的情形，除權日當天會更新之前未成交訂單的limit price（new_limit = old_limit * ratio，其中ratio = 1/僅除權調整係數）。</li>
<li>stop_reached：<ul>
<li>對於buy stop order，若現價&gt;=stop price，則顯示True否則False。</li>
<li>對於sell stop order，若現價&lt;=stop price，則顯示True否則False。</li>
</ul>
</li>
<li>limit_reached：<ul>
<li>對於buy limit order，若現價&lt;=limit price，則顯示True否則False。</li>
<li>對於sell limit order，若現價&gt;=limit price，則顯示True否則False。</li>
</ul>
</li>
<li>sid（asset）：下單的標的。</li>
<li>
<p>status：若=0表示OPEN（未完全成交），=1表示FILLED（完全成交），=2表示CANCEL（已取消）。</p>
</li>
<li>
<p>transactions：顯示交易紀錄</p>
</li>
<li>amount：下單股數。</li>
<li>dt ： 交易時間。</li>
<li>price：成交價（為調整前收盤價，不調整股息、分割、股票股利）。</li>
<li>order_id：單號，可與orders中的id比對。</li>
<li>sid（asset）：下單的標的。</li>
<li>
<p>commission：一律為None。傭金資料已經在'orders'底下。</p>
</li>
<li>
<p>positions：顯示持有部位</p>
</li>
<li>sid（asset）：下單的標的。</li>
<li>amount：該標的總持有股數。除權日當天amount會進行調整（old_amount / ratio = new_amount，其中ratio = 1/僅除權調整係數）。</li>
<li>last_sale_price：標的最近一筆的收盤價。</li>
<li>cost_basis：每股平均成本（含commissions）。<ul>
<li>計算方法為：sum(成交價 * (1+commission) * 股數) / 總股數</li>
<li>除權日當天cost_basis會進行調整（old_cost_basis * ratio = new_cost_basis，其中ratio = 1/僅除權調整係數）。</li>
<li>對於買進或回補來說，commissions會造成cost_basis增加；對於賣出或放空來說，commissions會造成cost_basis減少。</li>
</ul>
</li>
<li>longs_count：</li>
<li>當日帳上有幾檔長部位股票。可與<code>positions</code>比較。</li>
<li>shorts_count：</li>
<li>當日帳上有幾檔短部位股票。可與<code>positions</code>比較。</li>
<li>long_exposure（long_value）：</li>
<li>當日帳上長部位的市值。</li>
<li>可與<code>positions</code>比較。</li>
<li>當投資標的為股票時<code>long_exposure</code>和<code>long_value</code>兩欄位數值一致。</li>
<li>計算方式為sum(持有股數 * 收盤價) = sum(amount * last_sale_price)，where amount &gt; 0。</li>
<li>short_exposure（short_value）：</li>
<li>當日帳上短部位的市值。</li>
<li>可與<code>positions</code>比較。</li>
<li>當投資標的為股票時<code>short_exposure</code>和<code>short_value</code>兩欄位數值一致。</li>
<li>計算方式為sum(持有股數 * 收盤價) = sum(amount * last_sale_price)，where amount &lt; 0。</li>
<li>short_exposure必然 &lt;= 0。</li>
<li>ending_exposure（ending_value）：</li>
<li>當日結束時帳上部位的淨市值。</li>
<li>計算方式：<code>long_exposure</code> + <code>short_exposure</code></li>
<li>starting_exposure（starting_value）：</li>
<li>當日開始時帳上部位的淨市值。</li>
<li>為前一日的<code>ending_exposure</code>。</li>
<li>gross_leverage（leverage）：</li>
<li>Gross leverage is the sum of long and short leverage exposure per share divided by net asset value（portfolio_value）。</li>
<li>計算方式：（<code>long_exposure</code> - <code>short_exposure</code>）／<code>portfolio_value</code></li>
<li>net_leverage：</li>
<li>Net leverage is the net leverage exposure per share divided by net asset value（portfolio_value）。</li>
<li>計算方式：（<code>long_exposure</code> + <code>short_exposure</code>）／<code>portfolio_value</code></li>
<li>capital_used：</li>
<li>當天的cash flow。&gt;0表示流入，&lt;0表示流出。</li>
<li>計算方式：<ul>
<li>-1 * sum(<code>transaction.price</code> * <code>transaction.amount</code>) - sum(<code>order.commission</code>) + sum(earn_dividends) + sum(leftover_cash)</li>
</ul>
</li>
<li>
<p>註：    </p>
<ol>
<li>earn_dividends：會於pay_date當天配發。</li>
<li>leftover_cash：分割、股票股利等原因導致股數變動時，若有&lt;1股(fractional_share_count)無法分配的情況時則返回現金。</li>
<li>leftover_cash範例：</li>
<li>若現在持有100股（amount），ratio=3。</li>
<li>新的amount理論上是100/3=33.333，然而不滿一股的部分需轉換成現金 (return cash)。</li>
<li>所以新的amount會是33，剩餘的0.333股（33.333-33）就是fractional_share_count。</li>
<li>由於ratio=3代表該公司股數有發生變動，所以每股平均成本 (cost basis)需調整=原cost basis * 原amount / 新amount 後四捨五入到小數第二位。</li>
<li>所以退回現金(return cash)=(fractional_share_count) * (新cost basis) 再四捨五入到小數第二位</li>
</ol>
</li>
<li>
<p>ending_cash：</p>
</li>
<li>當日結束時帳上持有現金。</li>
<li>計算方式：<code>starting_cash</code>+<code>capital_used</code></li>
<li>starting_cash：</li>
<li>當日開始時帳上持有現金。</li>
<li>為前一日的<code>ending_cash</code>+sum(earn_dividends)，若無前一日則為<code>capital_base</code>。</li>
<li>pnl：</li>
<li>當日投資組合損益。</li>
<li>計算方式：(<code>ending_exposure</code> + <code>ending_cash</code>) - (<code>starting_exposure</code> + <code>starting_cash</code>)。</li>
<li>returns：</li>
<li>當日報酬率。</li>
<li>計算方式：(當日<code>portfolio_value</code>) / (前一日<code>portfolio_value</code>) - 1。</li>
<li>存在尾差。</li>
<li>portfolio_value：</li>
<li>即net asset value，當日投資組合總價值。</li>
<li>計算方式：(<code>ending_exposure</code> + <code>ending_cash</code>)</li>
<li>algorithm_period_return：</li>
<li>投資組合累積日報酬率。</li>
<li>計算方式：( 1 + 前一日的<code>algorithm_period_return</code>) * ( 1 + 當日<code>returns</code>) - 1。</li>
<li>存在尾差。</li>
<li>algo_volatility：</li>
<li>投資組合日報酬率的年化波動率，至少需有兩期的報酬率才進行計算。</li>
<li>利用empyrical套件計算：
    <br> empyrical.annual_volatility(<code>returns</code>Series, period='daily', alpha=2.0, annualization=None)。</li>
<li>具體來說，empyrical套件的計算方式為：<code>returns</code>Series.std(ddof=1) * (252 ** (1 / 2))，std為樣本標準差。</li>
<li>用完整<code>returns</code>資料，則會回傳最後一日algo_volatility，若扣掉最後一日<code>returns</code>，則回傳倒數第二日，以此類推。  </li>
<li>excess_return：</li>
<li>投資組合累積超額日報酬（相對於<code>benchmark_period_return</code>）。</li>
<li>計算方式為：(<code>algorithm_period_return</code> - <code>benchmark_period_return</code>)。</li>
<li>max_drawdown：</li>
<li>投資組合累積報酬率從過去的峰值下跌的最大跌幅百分比。</li>
<li>利用empyrical套件計算：empyrical.max_drawdown(<code>returns</code> Series)。</li>
<li>具體來說，empyrical套件的計算方式為：<ul>
<li>cumulative_returns：先計算過去每一日的累積報酬。</li>
<li>previous_peaks：計算過去累積報酬率的最大值。</li>
<li>daily_drawdown：計算每日回撤 = (cumulative_returns - previous_peaks) / previous_peaks</li>
<li>max_drawdown：過去每一日的daily_drawdown取極小值。</li>
</ul>
</li>
<li>sharpe：</li>
<li>年化夏普比率，衡量每承擔1單位風險，可以獲取多少的報酬。</li>
<li>利用empyrical套件計算：empyrical.sharpe_ratio(<code>returns</code> Series, risk_free=0)。</li>
<li>具體來說，empyrical套件的計算方式為：
    <br>np.mean(<code>returns</code> Series) / np.std(<code>returns</code> Series,ddof=1) * np.sqrt(252)</li>
<li>sortino：   </li>
<li>年化索提諾比率，衡量承擔單位下方風險，可以獲取多少的報酬。</li>
<li>利用empyrical套件計算：empyrical.sortino_ratio(<code>returns</code> Series, required_return=0)。</li>
<li>具體來說，empyrical套件的計算方式為：<ul>
<li>計算downside_risk：np.sqrt(np.nanmean(np.square(downside_return))) * np.sqrt(252)，其中downside_return將<code>returns</code> Series中&gt;0的數值替換成0。</li>
<li>計算mean_return：np.nanmean(<code>returns</code> Series)</li>
<li>計算sortino_ratio =  mean_return / downside_risk * 252。</li>
</ul>
</li>
<li>
<p>存在尾差。</p>
</li>
<li>
<p>alpha：</p>
</li>
<li>年化alpha，衡量投資組合創造超額報酬的能力。</li>
<li>利用empyrical套件計算：empyrical.alpha_beta_aligned(returns=<code>returns</code>Series, factor_returns=<code>benchmark_return</code> Series,risk_free=0.0)</li>
<li>具體來說，empyrical套件的計算方式為：<ul>
<li>計算alpha_series：<code>returns</code> Series - (當日<code>beta</code> * <code>benchmark_return</code> Series)</li>
<li>計算平均alpha：nanmean(alpha_series)</li>
<li>計算年化alpha：(平均alpha + 1) ^ 252 -1  </li>
</ul>
</li>
<li>beta：    </li>
<li>衡量投資組合相對於整體市場的波動性。</li>
<li>利用empyrical套件計算：empyrical.alpha_beta_aligned(returns=<code>returns</code>Series, factor_returns=<code>benchmark_return</code> Series,risk_free=0.0)</li>
<li>具體來說，empyrical套件的計算方式為：
    <br>Cov(<code>benchmark_return</code> Series, <code>returns</code> Series) / Var(<code>benchmark_return</code> Series)</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_algorithm</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span> 
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2018-12-30&#39;</span><span class="p">,</span><span class="n">tz</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="n">end_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2023-05-26&#39;</span><span class="p">,</span><span class="n">tz</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="n">results</span> <span class="o">=</span> <span class="n">run_algorithm</span><span class="p">(</span><span class="n">start</span><span class="o">=</span> <span class="n">start_date</span><span class="p">,</span>  
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>                       <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>                       <span class="n">initialize</span><span class="o">=</span><span class="n">initialize</span><span class="p">,</span>                       
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a>                       <span class="n">capital_base</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span>                       
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>                       <span class="n">analyze</span><span class="o">=</span><span class="n">analyze</span><span class="p">,</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>                       <span class="n">handle_data</span><span class="o">=</span><span class="n">handle_data</span><span class="p">,</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>                       <span class="n">data_frequency</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>                       <span class="n">bundle</span><span class="o">=</span><span class="s1">&#39;tquant&#39;</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>                       <span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">results</span>
</span></code></pre></div>
<p>我們可以發現之前使用 <code>order</code> 紀錄的 trade_days, has_ordered 與 TSMC 確實以欄位型式記錄在 <strong>results</strong> 表中。 </p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="n">results</span><span class="p">[[</span><span class="s1">&#39;trade_days&#39;</span><span class="p">,</span><span class="s1">&#39;has_ordered&#39;</span><span class="p">,</span><span class="s1">&#39;TSMC&#39;</span><span class="p">]]</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>
</span></code></pre></div>
<h2 id="run_algorithm_2">Run_algorithm 函式<a class="headerlink" href="#run_algorithm_2" title="Permanent link">&para;</a></h2>
<h3 id="ziplinerun_algorithm_2">zipline.run_algorithm<a class="headerlink" href="#ziplinerun_algorithm_2" title="Permanent link">&para;</a></h3>
<p>進行策略回測。</p>
<h4 id="parameters_4">Parameters:<a class="headerlink" href="#parameters_4" title="Permanent link">&para;</a></h4>
<ul>
<li>start: <em>pd.Timestamp</em> or <em>datetime</em>
        回測起始日期。</li>
<li>end: <em>pd.Timestamp</em> or <em>datetime</em>
        回測結束日期。</li>
<li>initialize: <em>callable</em>
        呼叫 initialize 函式以用於回測。</li>
<li>capital_base: <em>int</em>
        初始資金額度。</li>
<li>handle_data: <em>callable</em>, optional
        呼叫 handle_data 函式以用於回測。</li>
<li>before_trading_start: <em>callable</em>, optional
        呼叫 before_trading_start 函式以用於回測。</li>
<li>analyze: <em>callable</em>, optional
        呼叫 analyze 函式以用於回測。</li>
<li>data_frequency: <em>{"daily", "minute"}</em>, optional
        設置交易頻率。</li>
<li>bundle: <em>str</em>, optional
        設置回測用的 bundle。</li>
<li>trading_calendar: <em>TradingCalendar</em>, optional
        設置交易日曆。</li>
<li>benchmark_returns: <em>pd.Series</em>, optional
        設置指標報酬率。</li>
<li>treasury_returns: <em>pd.Series</em>, optional
        設置無風險利率。</li>
</ul>
<h4 id="returns_2">Returns:<a class="headerlink" href="#returns_2" title="Permanent link">&para;</a></h4>
<p>Perf: <em>pd.DataFrame</em>, 內建欄位有:</p>
<ul>
<li>benchmark_return：
    當日的benchmark報酬率，若是由<code>set_benchmark()</code>設定，則計算方式為(當日benchmark收盤價 / 前一日benchmark收盤價) - 1。</li>
<li>benchmark_period_return：
    累積的benchmark日報酬率。計算方式：np.nancumprod(1 + <code>benchmark_return</code> Series) - 1。</li>
<li>treasury_return：
    當日的treasury報酬率，直接由TEJ API提供。</li>
<li>treasury_period_return：
    累積的treasury日報酬率。計算方式：np.nancumprod(1 + <code>treasury_return</code> Series) - 1。</li>
<li>
<p>benchmark_volatility：
    benchmark日報酬率的年化波動率，至少需有兩期的報酬率才進行計算。計算方式：(<code>benchmark_return</code> Series).expanding(2).std(ddof=1) * np.sqrt(252)</p>
</li>
<li>
<p>orders：顯示下單紀錄
    每一筆下單用一個字典的方式呈現，其中：</p>
</li>
<li>id：虛擬單號。</li>
<li>dt：下單時間。</li>
<li>reason：None, Hold, or Reject（目前不適用）</li>
<li>created：建立時間。</li>
<li>amount：<ul>
<li>下單股數。</li>
<li>若&gt;0表示買進或回補，&lt;0表示賣出或放空。</li>
<li>若有發股票股利或股票分割的情形，除權日當天會更新之前未成交訂單的amount（new_amount = old_amount / ratio，其中ratio = 1/僅除權調整係數）。</li>
</ul>
</li>
<li>
<p>filled：成交股數。</p>
<ul>
<li>註：Order execution - 當演算法在某一天下單時，該訂單會在下一個交易日成交，以避免lookahead bias。   </li>
</ul>
</li>
<li>
<p>commission：該筆交易傭金。</p>
</li>
<li>stop：停損價，若有發股票股利或股票分割的情形，除權日當天會更新之前未成交訂單的stop price（new_stop = old_stop * ratio，其中ratio = 1/僅除權調整係數）。</li>
<li>limit：限價價，若有發股票股利或股票分割的情形，除權日當天會更新之前未成交訂單的limit price（new_limit = old_limit * ratio，其中ratio = 1/僅除權調整係數）。</li>
<li>stop_reached：<ul>
<li>對於buy stop order，若現價&gt;=stop price，則顯示True否則False。</li>
<li>對於sell stop order，若現價&lt;=stop price，則顯示True否則False。</li>
</ul>
</li>
<li>limit_reached：<ul>
<li>對於buy limit order，若現價&lt;=limit price，則顯示True否則False。</li>
<li>對於sell limit order，若現價&gt;=limit price，則顯示True否則False。</li>
</ul>
</li>
<li>sid（asset）：下單的標的。</li>
<li>
<p>status：若=0表示OPEN（未完全成交），=1表示FILLED（完全成交），=2表示CANCEL（已取消）。</p>
</li>
<li>
<p>transactions：顯示交易紀錄</p>
</li>
<li>amount：下單股數。</li>
<li>dt ： 交易時間。</li>
<li>price：成交價（為調整前收盤價，不調整股息、分割、股票股利）。</li>
<li>order_id：單號，可與orders中的id比對。</li>
<li>sid（asset）：下單的標的。</li>
<li>
<p>commission：一律為None。傭金資料已經在'orders'底下。</p>
</li>
<li>
<p>positions：顯示持有部位</p>
</li>
<li>sid（asset）：下單的標的。</li>
<li>amount：該標的總持有股數。除權日當天amount會進行調整（old_amount / ratio = new_amount，其中ratio = 1/僅除權調整係數）。</li>
<li>last_sale_price：標的最近一筆的收盤價。</li>
<li>cost_basis：每股平均成本（含commissions）。<ul>
<li>計算方法為：sum(成交價 * (1+commission) * 股數) / 總股數</li>
<li>除權日當天cost_basis會進行調整（old_cost_basis * ratio = new_cost_basis，其中ratio = 1/僅除權調整係數）。</li>
<li>對於買進或回補來說，commissions會造成cost_basis增加；對於賣出或放空來說，commissions會造成cost_basis減少。</li>
</ul>
</li>
<li>longs_count：</li>
<li>當日帳上有幾檔長部位股票。可與<code>positions</code>比較。</li>
<li>shorts_count：</li>
<li>當日帳上有幾檔短部位股票。可與<code>positions</code>比較。</li>
<li>long_exposure（long_value）：</li>
<li>當日帳上長部位的市值。</li>
<li>可與<code>positions</code>比較。</li>
<li>當投資標的為股票時<code>long_exposure</code>和<code>long_value</code>兩欄位數值一致。</li>
<li>計算方式為sum(持有股數 * 收盤價) = sum(amount * last_sale_price)，where amount &gt; 0。</li>
<li>short_exposure（short_value）：</li>
<li>當日帳上短部位的市值。</li>
<li>可與<code>positions</code>比較。</li>
<li>當投資標的為股票時<code>short_exposure</code>和<code>short_value</code>兩欄位數值一致。</li>
<li>計算方式為sum(持有股數 * 收盤價) = sum(amount * last_sale_price)，where amount &lt; 0。</li>
<li>short_exposure必然 &lt;= 0。</li>
<li>ending_exposure（ending_value）：</li>
<li>當日結束時帳上部位的淨市值。</li>
<li>計算方式：<code>long_exposure</code> + <code>short_exposure</code></li>
<li>starting_exposure（starting_value）：</li>
<li>當日開始時帳上部位的淨市值。</li>
<li>為前一日的<code>ending_exposure</code>。</li>
<li>gross_leverage（leverage）：</li>
<li>Gross leverage is the sum of long and short leverage exposure per share divided by net asset value（portfolio_value）。</li>
<li>計算方式：（<code>long_exposure</code> - <code>short_exposure</code>）／<code>portfolio_value</code></li>
<li>net_leverage：</li>
<li>Net leverage is the net leverage exposure per share divided by net asset value（portfolio_value）。</li>
<li>計算方式：（<code>long_exposure</code> + <code>short_exposure</code>）／<code>portfolio_value</code></li>
<li>capital_used：</li>
<li>當天的cash flow。&gt;0表示流入，&lt;0表示流出。</li>
<li>計算方式：<ul>
<li>-1 * sum(<code>transaction.price</code> * <code>transaction.amount</code>) - sum(<code>order.commission</code>) + sum(earn_dividends) + sum(leftover_cash)</li>
</ul>
</li>
<li>
<p>註：    </p>
<ol>
<li>earn_dividends：會於pay_date當天配發。</li>
<li>leftover_cash：分割、股票股利等原因導致股數變動時，若有&lt;1股(fractional_share_count)無法分配的情況時則返回現金。</li>
<li>leftover_cash範例：</li>
<li>若現在持有100股（amount），ratio=3。</li>
<li>新的amount理論上是100/3=33.333，然而不滿一股的部分需轉換成現金 (return cash)。</li>
<li>所以新的amount會是33，剩餘的0.333股（33.333-33）就是fractional_share_count。</li>
<li>由於ratio=3代表該公司股數有發生變動，所以每股平均成本 (cost basis)需調整=原cost basis * 原amount / 新amount 後四捨五入到小數第二位。</li>
<li>所以退回現金(return cash)=(fractional_share_count) * (新cost basis) 再四捨五入到小數第二位</li>
</ol>
</li>
<li>
<p>ending_cash：</p>
</li>
<li>當日結束時帳上持有現金。</li>
<li>計算方式：<code>starting_cash</code>+<code>capital_used</code></li>
<li>starting_cash：</li>
<li>當日開始時帳上持有現金。</li>
<li>為前一日的<code>ending_cash</code>+sum(earn_dividends)，若無前一日則為<code>capital_base</code>。</li>
<li>pnl：</li>
<li>當日投資組合損益。</li>
<li>計算方式：(<code>ending_exposure</code> + <code>ending_cash</code>) - (<code>starting_exposure</code> + <code>starting_cash</code>)。</li>
<li>returns：</li>
<li>當日報酬率。</li>
<li>計算方式：(當日<code>portfolio_value</code>) / (前一日<code>portfolio_value</code>) - 1。</li>
<li>存在尾差。</li>
<li>portfolio_value：</li>
<li>即net asset value，當日投資組合總價值。</li>
<li>計算方式：(<code>ending_exposure</code> + <code>ending_cash</code>)</li>
<li>algorithm_period_return：</li>
<li>投資組合累積日報酬率。</li>
<li>計算方式：( 1 + 前一日的<code>algorithm_period_return</code>) * ( 1 + 當日<code>returns</code>) - 1。</li>
<li>存在尾差。</li>
<li>algo_volatility：</li>
<li>投資組合日報酬率的年化波動率，至少需有兩期的報酬率才進行計算。</li>
<li>利用empyrical套件計算：
    <br> empyrical.annual_volatility(<code>returns</code>Series, period='daily', alpha=2.0, annualization=None)。</li>
<li>具體來說，empyrical套件的計算方式為：<code>returns</code>Series.std(ddof=1) * (252 ** (1 / 2))，std為樣本標準差。</li>
<li>用完整<code>returns</code>資料，則會回傳最後一日algo_volatility，若扣掉最後一日<code>returns</code>，則回傳倒數第二日，以此類推。  </li>
<li>excess_return：</li>
<li>投資組合累積超額日報酬（相對於<code>benchmark_period_return</code>）。</li>
<li>計算方式為：(<code>algorithm_period_return</code> - <code>benchmark_period_return</code>)。</li>
<li>max_drawdown：</li>
<li>投資組合累積報酬率從過去的峰值下跌的最大跌幅百分比。</li>
<li>利用empyrical套件計算：empyrical.max_drawdown(<code>returns</code> Series)。</li>
<li>具體來說，empyrical套件的計算方式為：<ul>
<li>cumulative_returns：先計算過去每一日的累積報酬。</li>
<li>previous_peaks：計算過去累積報酬率的最大值。</li>
<li>daily_drawdown：計算每日回撤 = (cumulative_returns - previous_peaks) / previous_peaks</li>
<li>max_drawdown：過去每一日的daily_drawdown取極小值。</li>
</ul>
</li>
<li>sharpe：</li>
<li>年化夏普比率，衡量每承擔1單位風險，可以獲取多少的報酬。</li>
<li>利用empyrical套件計算：empyrical.sharpe_ratio(<code>returns</code> Series, risk_free=0)。</li>
<li>具體來說，empyrical套件的計算方式為：
    <br>np.mean(<code>returns</code> Series) / np.std(<code>returns</code> Series,ddof=1) * np.sqrt(252)</li>
<li>sortino：   </li>
<li>年化索提諾比率，衡量承擔單位下方風險，可以獲取多少的報酬。</li>
<li>利用empyrical套件計算：empyrical.sortino_ratio(<code>returns</code> Series, required_return=0)。</li>
<li>具體來說，empyrical套件的計算方式為：<ul>
<li>計算downside_risk：np.sqrt(np.nanmean(np.square(downside_return))) * np.sqrt(252)，其中downside_return將<code>returns</code> Series中&gt;0的數值替換成0。</li>
<li>計算mean_return：np.nanmean(<code>returns</code> Series)</li>
<li>計算sortino_ratio =  mean_return / downside_risk * 252。</li>
</ul>
</li>
<li>
<p>存在尾差。</p>
</li>
<li>
<p>alpha：</p>
</li>
<li>年化alpha，衡量投資組合創造超額報酬的能力。</li>
<li>利用empyrical套件計算：empyrical.alpha_beta_aligned(returns=<code>returns</code>Series, factor_returns=<code>benchmark_return</code> Series,risk_free=0.0)</li>
<li>具體來說，empyrical套件的計算方式為：<ul>
<li>計算alpha_series：<code>returns</code> Series - (當日<code>beta</code> * <code>benchmark_return</code> Series)</li>
<li>計算平均alpha：nanmean(alpha_series)</li>
<li>計算年化alpha：(平均alpha + 1) ^ 252 -1  </li>
</ul>
</li>
<li>beta：    </li>
<li>衡量投資組合相對於整體市場的波動性。</li>
<li>利用empyrical套件計算：empyrical.alpha_beta_aligned(returns=<code>returns</code>Series, factor_returns=<code>benchmark_return</code> Series,risk_free=0.0)</li>
<li>具體來說，empyrical套件的計算方式為：
    <br>Cov(<code>benchmark_return</code> Series, <code>returns</code> Series) / Var(<code>benchmark_return</code> Series)</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_algorithm</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span> 
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="n">start_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2018-12-30&#39;</span><span class="p">,</span><span class="n">tz</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="n">end_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2023-05-26&#39;</span><span class="p">,</span><span class="n">tz</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span><span class="p">)</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="n">results</span> <span class="o">=</span> <span class="n">run_algorithm</span><span class="p">(</span><span class="n">start</span><span class="o">=</span> <span class="n">start_date</span><span class="p">,</span>  
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>                       <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>                       <span class="n">initialize</span><span class="o">=</span><span class="n">initialize</span><span class="p">,</span>                       
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>                       <span class="n">capital_base</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span>                       
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>                       <span class="n">analyze</span><span class="o">=</span><span class="n">analyze</span><span class="p">,</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>                       <span class="n">handle_data</span><span class="o">=</span><span class="n">handle_data</span><span class="p">,</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>                       <span class="n">data_frequency</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">,</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>                       <span class="n">bundle</span><span class="o">=</span><span class="s1">&#39;tquant&#39;</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>                       <span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">results</span>
</span></code></pre></div>
<p>我們可以發現之前使用 <code>order</code> 紀錄的 trade_days, has_ordered 與 TSMC 確實以欄位型式記錄在 <strong>results</strong> 表中。 </p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">results</span><span class="p">[[</span><span class="s1">&#39;trade_days&#39;</span><span class="p">,</span><span class="s1">&#39;has_ordered&#39;</span><span class="p">,</span><span class="s1">&#39;TSMC&#39;</span><span class="p">]]</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>
</span></code></pre></div>
<hr />
<h1 id="target-percent-pipeline-algorithm">Target Percent Pipeline Algorithm<a class="headerlink" href="#target-percent-pipeline-algorithm" title="Permanent link">&para;</a></h1>
<p>利用pipeline提供的買賣清單與持股權重進行定期再平衡的演算法。</p>
<p><span id="menu"></span>
本文件包含以下部份：</p>
<p><strong>基本設定</strong>
1. <a href="#Env">Set Environment Variables</a>
2. <a href="#Universe">Investment Universe</a>
3. <a href="#Ingest">Ingest</a>
4. <a href="#Imports">Imports</a>
5. <a href="#Pipeline">Pipeline</a></p>
<p><strong>參數說明與範例</strong></p>
<ol>
<li><a href="#APIReference">API Reference</a>：參數說明。</li>
<li><a href="#APIReference">class zipline.algo.pipeline_algo.TargetPercentPipeAlgo</a></li>
<li>
<p><a href="#date_rules">class zipline.api.date_rules</a></p>
</li>
<li>
<p><a href="#Examples">Examples</a>：範例。</p>
</li>
<li><a href="#Case1">Case 1－調整start_session與end_session</a></li>
<li><a href="#Case2">Case 2－調整max_leverage</a></li>
<li><a href="#Case3">Case 3－調整tradeday</a></li>
<li><a href="#Case4">Case 4－調整rebalance_date_rule</a></li>
<li><a href="#Case5">Case 5－調整slippage_model</a></li>
<li><a href="#Case6">Case 6－調整stocklist</a></li>
<li><a href="#Case7">Case 7－調整order_filling_policy</a></li>
<li><a href="#Case8">Case 8－調整allow_short</a></li>
<li><a href="#Case9">Case 9－調整cancel_datedelta</a>   </li>
<li><a href="#Case10">Case 10－調整limit_buy_multiplier</a>  </li>
<li><a href="#Case11">Case 11－調整custom_weight、analyze、record_vars、get_record_vars與get_transaction_detail</a>   </li>
</ol>
<p><span id="Env"></span></p>
<h1 id="1-set-environment-variables">1. Set Environment Variables<a class="headerlink" href="#1-set-environment-variables" title="Permanent link">&para;</a></h1>
<p><a href="#menu">Return to Menu</a></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">tejapi</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="c1"># set tej_key and base</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TEJAPI_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;your key&quot;</span> 
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TEJAPI_BASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;https://api.tej.com.tw&quot;</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="c1"># set benchmark</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="n">benchmark</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;IR0001&#39;</span><span class="p">]</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="c1"># set calendar</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="n">calendar_name</span><span class="o">=</span><span class="s1">&#39;TEJ_XTAI&#39;</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="c1"># set bundle name</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="n">bundle_name</span> <span class="o">=</span> <span class="s1">&#39;tquant&#39;</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="c1"># set date</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2023-06-01&#39;</span>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="n">end</span><span class="o">=</span><span class="s1">&#39;2023-10-03&#39;</span>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="c1"># 由文字型態轉為Timestamp，供回測使用</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="n">tz</span> <span class="o">=</span> <span class="s1">&#39;UTC&#39;</span>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="n">start_dt</span><span class="p">,</span> <span class="n">end_dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">tz</span> <span class="o">=</span> <span class="n">tz</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">tz</span> <span class="o">=</span> <span class="n">tz</span><span class="p">)</span>
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a><span class="c1"># 設定os.environ[&#39;mdate&#39;] = start+&#39; &#39;+end，供ingest bundle使用</span>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;mdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">end</span>
</span></code></pre></div>
<p><span id="Universe"></span></p>
<h1 id="2-investment-universe">2. Investment Universe<a class="headerlink" href="#2-investment-universe" title="Permanent link">&para;</a></h1>
<p>台灣50指數成分股</p>
<p><a href="#menu">Return to Menu</a></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.sources.TEJ_Api_Data</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_universe</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="n">StockList</span> <span class="o">=</span> <span class="n">get_universe</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">idx_id</span><span class="o">=</span><span class="s1">&#39;IX0002&#39;</span><span class="p">)</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">StockList</span><span class="p">))</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">StockList</span> <span class="o">+</span> <span class="n">benchmark</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span>
</span></code></pre></div>
<p><span id="Ingest"></span></p>
<h1 id="3-ingest">3. Ingest<a class="headerlink" href="#3-ingest" title="Permanent link">&para;</a></h1>
<p><a href="#menu">Return to Menu</a></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1"># Ingest pricing bundle</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="err">!</span><span class="n">zipline</span> <span class="n">ingest</span> <span class="o">-</span><span class="n">b</span> <span class="n">tquant</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.data.data_portal</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_bundle_price</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="n">df_bundle_price</span> <span class="o">=</span> <span class="n">get_bundle_price</span><span class="p">(</span><span class="n">bundle_name</span><span class="o">=</span><span class="n">bundle_name</span><span class="p">,</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>                                   <span class="n">calendar_name</span><span class="o">=</span><span class="n">calendar_name</span><span class="p">,</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>                                   <span class="n">start_dt</span><span class="o">=</span><span class="n">start_dt</span><span class="p">,</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>                                   <span class="n">end_dt</span><span class="o">=</span><span class="n">end_dt</span><span class="p">)</span>
</span></code></pre></div>
<p><span id="Imports"></span></p>
<h1 id="4-imports-settings">4. Imports &amp; Settings<a class="headerlink" href="#4-imports-settings" title="Permanent link">&para;</a></h1>
<p><a href="#menu">Return to Menu</a></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">empyrical</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ep</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">logbook</span><span class="w"> </span><span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">StderrHandler</span><span class="p">,</span> <span class="n">INFO</span><span class="p">,</span> <span class="n">WARNING</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.ticker</span><span class="w"> </span><span class="kn">import</span> <span class="n">MaxNLocator</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="kn">from</span><span class="w"> </span><span class="nn">TejToolAPI.TejToolAPI</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">record</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.utils.calendar_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_calendar</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.utils.run_algo</span><span class="w"> </span><span class="kn">import</span>  <span class="p">(</span><span class="n">get_transaction_detail</span><span class="p">,</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>                                     <span class="n">get_record_vars</span><span class="p">)</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span><span class="p">,</span> <span class="n">CustomFactor</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.pipeline.filters</span><span class="w"> </span><span class="kn">import</span> <span class="n">SingleAsset</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.pipeline.factors</span><span class="w"> </span><span class="kn">import</span> <span class="n">RSI</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.pipeline.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">TQAltDataSet</span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a>
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.finance</span><span class="w"> </span><span class="kn">import</span> <span class="n">slippage</span>
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.TQresearch.tej_pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_pipeline</span>
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a>
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a><span class="c1"># 設定log顯示方式</span>
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="n">log_handler</span> <span class="o">=</span> <span class="n">StderrHandler</span><span class="p">(</span><span class="n">format_string</span><span class="o">=</span><span class="s1">&#39;[{record.time:%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1">}]: &#39;</span> <span class="o">+</span>
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a>                            <span class="s1">&#39;</span><span class="si">{record.level_name}</span><span class="s1">: </span><span class="si">{record.func_name}</span><span class="s1">: </span><span class="si">{record.message}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a>                            <span class="n">level</span><span class="o">=</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="__span-31-32"><a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a><span class="n">log_handler</span><span class="o">.</span><span class="n">push_application</span><span class="p">()</span>
</span><span id="__span-31-33"><a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a><span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="s1">&#39;Algorithm&#39;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span></code></pre></div>
<p><span id="Pipeline"></span></p>
<h1 id="5-pipeline">5. Pipeline<a class="headerlink" href="#5-pipeline" title="Permanent link">&para;</a></h1>
<p>取得<code>Market_Cap_Dollars</code>（市值）資料</p>
<p><a href="#menu">Return to Menu</a></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Market_Cap_Dollars&#39;</span><span class="p">]</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>    <span class="n">fields</span> <span class="o">+=</span> <span class="n">i</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>    <span class="n">fields</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fields</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1"># Ingest Fundamental Bundle</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="err">!</span><span class="n">zipline</span> <span class="n">ingest</span> <span class="o">-</span><span class="n">b</span> <span class="n">fundamentals</span>
</span></code></pre></div>
<p><span id="APIReference"></span></p>
<h1 id="6-api-reference">6. API Reference<a class="headerlink" href="#6-api-reference" title="Permanent link">&para;</a></h1>
<p><a href="#menu">Return to Menu</a></p>
<h3 id="class-ziplinealgopipeline_algotargetpercentpipealgo"><strong>class zipline.algo.pipeline_algo.<font color=DeepPink>TargetPercentPipeAlgo</font></strong><a class="headerlink" href="#class-ziplinealgopipeline_algotargetpercentpipealgo" title="Permanent link">&para;</a></h3>
<p><em>(self, bundle_name='tquant', start_session=None, end_session=None, trading_calendar=get_calendar('TEJ_XTAI'),</em></p>
<p><em>capital_base=1e7, data_frequency='daily', tradeday=None, rebalance_date_rule=None, stocklist=None, benchmark='IR0001',</em> </p>
<p><em>zero_treasury_returns=True, slippage_model=slippage.VolumeShareSlippage(volume_limit=0.025, price_impact=0.1),</em></p>
<p><em>commission_model=commission.Custom_TW_Commission(min_trade_cost=20, discount = 1.0, tax = 0.003), max_leverage=0.8,</em> </p>
<p><em>limit_buy_multiplier=None, limit_sell_multiplier=None, allow_short=False, cancel_datedelta=None, custom_weight=False,</em></p>
<p><em>custom_loader=None, pipeline=None, analyze=None, record_vars=None, get_record_vars=False, get_transaction_detail=False,</em></p>
<p><em>order_filling_policy='next_bar')</em></p>
<p>利用pipeline提供的買賣清單與持股權重進行定期再平衡的演算法。必要參數僅有<code>pipeline</code>。</p>
<h4 id="parameters_5">Parameters:<a class="headerlink" href="#parameters_5" title="Permanent link">&para;</a></h4>
<ul>
<li>
<p><strong>bundle_name</strong> (<em>str, optional</em>)－bundle名稱。預設是 <strong><code>'tquant'</code></strong>。  </p>
</li>
<li>
<p><strong>start_session</strong> (<em>pd.Timestamp or datetime, optional</em>)－回測起始日期。預設是**bundle中最早的資料日期**。  </p>
</li>
<li>
<p><strong>end_session</strong> (<em>pd.Timestamp or datetime, optional</em>)－回測結束日期。預設是**bundle中最晚的資料日期**。  </p>
</li>
<li>
<p><strong>trading_calendar</strong> (<em>TradingCalendar, optional</em>)－</p>
</li>
<li>設置交易日曆。預設是 <strong><code>get_calendar('TEJ_XTAI')</code></strong>。</li>
<li>
<p>TradingCalendar：<code>zipline.utils.calendar_utils.TradingCalendar</code>。  </p>
</li>
<li>
<p><strong>capital_base</strong> (<em>float, optional</em>)－初始資金額度。預設是**一千萬**。  </p>
</li>
<li>
<p><strong>data_frequency</strong> (<em>{'daily', 'minute'}, optional</em>)－資料頻率，目前僅支援日頻率 <strong><code>'daily'</code></strong>。  </p>
</li>
<li>
<p><strong>tradeday</strong> (<em>list[str] or list[pd.Timestamp] or pd.DatetimeIndex, optional</em>)－</p>
</li>
<li>交易日期清單，限制只能在這個清單中的日期進行交易。預設是**None**，代表**每日**都交易。</li>
<li>
<p><code>rebalance_date_rule</code>與<code>tradeday</code>請擇一設定，若兩者皆設定，則會以<code>rebalance_date_rule</code>為主。  </p>
</li>
<li>
<p><strong>rebalance_date_rule</strong>(<em>EventRule, optional</em>)－</p>
</li>
<li>交易頻率，設定固定的交易頻率。預設是**None**，代表**每日**都交易。</li>
<li><code>rebalance_date_rule</code>與<code>tradeday</code>請擇一設定，若兩者皆設定，則會以<code>rebalance_date_rule</code>為主。</li>
<li>
<p>EventRule：<code>zipline.utils.events.EventRule</code>。可使用的<code>rebalance_date_rule</code>參考<a href="#date_rules">zipline.api.date_rules</a>。  </p>
</li>
<li>
<p><strong>stocklist</strong> (<em>list[str], optional</em>)－交易清單，限制只能交易這個清單中的股票。預設是**None**，代表使用所有bundle中的股票。  </p>
</li>
<li>
<p><strong>benchmark</strong> (<em>str, optional</em>)－指數名稱，用來與投資組合報酬率比較。預設是<code>'IR0001'</code>，代表**台灣發行量加權股價報酬指數**。  </p>
</li>
<li>
<p><strong>zero_treasury_returns</strong> (<em>bool, optional</em>)－</p>
</li>
<li>是否將無風險利率設定為0，預設是**True**，代表設定為0。因此使用<code>algo.run()</code>產出的回測報表中，<code>treasury_return</code>與<code>treasury_period_return</code>皆會是0。</li>
<li>
<p>若設定為**False**，則會<font color=DeepPink>耗費額外API流量</font>，並取得第一銀行一年期定存利率作為無風險利率。  </p>
</li>
<li>
<p><strong>slippage_model</strong> (<em>SlippageModel, optional</em>)－</p>
</li>
<li>設定滑價模型。預設為<code>slippage.VolumeShareSlippage(volume_limit=0.025, price_impact=0.1)</code>。可使用的模型參考：<a href="https://github.com/tejtw/TQuant-Lab/blob/main/lecture/Zipline%20Slippage.ipynb">lecture/Zipline Slippage.ipynb</a></li>
<li>
<p>SlippageModel：<code>zipline.finance.slippage.SlippageModel</code>。</p>
</li>
<li>
<p><strong>commission_model</strong> (<em>CommissionModel, optional</em>)－</p>
</li>
<li>設定手續費模型。預設為<code>commission.Custom_TW_Commission(min_trade_cost=20, discount=1.0, tax = 0.003)</code>。可使用的模型參考：<a href="https://github.com/tejtw/TQuant-Lab/blob/main/lecture/Zipline%20Commission%20Models.ipynb">lecture/Zipline Commission Models.ipynb</a></li>
<li>
<p>CommissionModel：<code>zipline.finance.commission.CommissionModel</code></p>
</li>
<li>
<p><strong>max_leverage</strong> (<em>float, optional</em>)－槓桿限制，預設 = <strong>0.8</strong>。  </p>
</li>
<li>
<p><strong>limit_buy_multiplier</strong> (<em>float, optional</em>)－</p>
</li>
<li>買進／回補時的limit_price乘數，若有提供則limit_price = 下單時最近一筆收盤價 * <code>limit_buy_multiplier</code>。</li>
<li>
<p>預設為**None**，代表**不設定**買進／回補時的limit_price。  </p>
</li>
<li>
<p><strong>limit_sell_multiplier</strong> (<em>float, optional</em>)－</p>
</li>
<li>賣出／放空時的limit_price乘數，若有提供則limit_price = 下單時最近一筆收盤價 * <code>limit_sell_multiplier</code>。</li>
<li>
<p>預設為**None**，代表**不設定**賣出／放空時的limit_price。  </p>
</li>
<li>
<p><strong>allow_short</strong> (<em>bool, optional</em>)－是否允許放空股票，預設為**False**，代表僅能做多。若設定為**True**，則pipeline中需要有<code>shorts</code>欄位。  </p>
</li>
<li>
<p><strong>cancel_datedelta</strong> (<em>int, optional</em>)－訂單幾天內未完全成交就取消。預設是在**下一次再平衡**時取消。 </p>
</li>
<li>
<p><strong>custom_weight</strong> (<em>bool, optional</em>)－</p>
</li>
<li>是否要使用自訂的加權權數，預設為**False**，代表不使用（即等權重加權）。</li>
<li>
<p>若設定為**True**，則pipeline中需要有<code>long_weights</code>（若<code>allow_short</code>=True，則也須有<code>short_weights</code>）欄位。</p>
</li>
<li>
<p><strong>custom_loader</strong> (<em>PipelineLoader , optional</em>)－</p>
</li>
<li>用來取得價量以外資料，預設是**None**，代表不使用價量、<code>TQDataSet</code>與<code>TQAltDataSet</code>以外資料。</li>
<li>TQDataSet：<code>zipline.pipeline.data.TQDataSet</code></li>
<li>TQAltDataSet：<code>zipline.pipeline.data.TQAltDataSet</code></li>
<li>
<p>目前支援的<code>PipelineLoader</code>：</p>
<ul>
<li>DataFrameLoader（<code>zipline.pipeline.loaders.frame.DataFrameLoader</code>）。</li>
</ul>
</li>
<li>
<p><strong>pipeline</strong> (<em>Pipeline</em>)－</p>
</li>
<li>要用來產出交易清單或權重的pipeline，為<font color=DeepPink><strong>必要參數</strong></font>。</li>
<li>
<p>Pipeline：<code>zipline.pipeline.Pipeline</code></p>
</li>
<li>
<p><strong>analyze</strong> (<em>callable[(context, pd.DataFrame) -&gt; None], optional</em>)－</p>
</li>
<li>傳入<code>analyze</code>函式以用於回測，函式中必須要有<code>context</code>與<code>perf</code>參數，預設是**None**。</li>
<li>
<p>此函式在**回測結束**時被一次性呼叫，並繪製自訂圖表。</p>
</li>
<li>
<p><strong>record_vars</strong> (<em>callable[(context, BarData) -&gt; None], optional</em>)－</p>
</li>
<li>傳入<code>record_vars</code>函式以用於回測，函式中必須要有<code>context</code>與<code>data</code>參數，預設是**None**。</li>
<li>
<p>此函式在**每個交易日結束**時被呼叫，並把指定資料紀錄於回測結果的DataFrame中。</p>
</li>
<li>
<p><strong>get_record_vars</strong> (<em>bool, optional</em>)－</p>
</li>
<li>是否產出<code>record_vars</code>中<code>record</code>方法所記錄的變數，預設為**False**，代表不產出。</li>
<li>
<p>若設定為**True**，則可用<code>algo.dict_record_vars</code>取出。</p>
</li>
<li>
<p><strong>get_transaction_detail</strong> (<em>bool, optional</em>)－</p>
</li>
<li>是否產出交易結果，預設為**False**，代表不產出。</li>
<li>
<p>若設定為**True**，則可用<code>algo.positions</code>、<code>algo.transactions</code>、<code>algo.orders</code>方式取出交易結果。</p>
</li>
<li>
<p><strong>order_filling_policy</strong> (<em>{'next_bar','current_bar'}, optional</em>)－</p>
</li>
<li>設定交易方式，預設為**next_bar**，代表當天收盤後下單，隔一日收盤前成交，也就是原先的回測方式。</li>
<li>若要當天開盤前下單，收盤前成交，則需指定設定為**current_bar**。</li>
</ul>
<h4 id="returns_3">Returns:<a class="headerlink" href="#returns_3" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code>algo
</code></pre></div>
<h4 id="return-type">Return type:<a class="headerlink" href="#return-type" title="Permanent link">&para;</a></h4>
<div class="language-text highlight"><pre><span></span><code>zipline.algo.pipeline_algo.TargetPercentPipeAlgo
</code></pre></div>
<p><br></p>
<p><br/></p>
<p><strong><font color=DeepPink>run</font>()</strong></p>
<blockquote>
<p>執行演算法</p>
<p><strong>Returns:</strong>
- perf（回測報表）</p>
<p><strong>Return type:</strong>
- pd.DataFrame</p>
</blockquote>
<p><span id="date_rules"></span></p>
<h3 id="class-ziplineapidate_rules"><strong>class zipline.api.<font color=DeepPink>date_rules</font></strong><a class="headerlink" href="#class-ziplineapidate_rules" title="Permanent link">&para;</a></h3>
<p><a href="#menu">Return to Menu</a></p>
<ul>
<li>為Factory API，主要用來傳入<code>zipline.api.schedule_function</code>的<code>date_rule</code>參數中。用來決定要以何種頻率觸發某項規則。</li>
<li>使用前請先import：<code>from zipline.api import date_rules</code>。</li>
</ul>
<hr />
<p><em>static</em> <strong><font color=DeepPink>every_day</font></strong>()</p>
<blockquote>
<p>每日觸發某項規則。</p>
<p><strong>Returns:</strong>
- rule</p>
<p><strong>Return type:</strong>
- zipline.utils.events.EventRule</p>
</blockquote>
<p><br></p>
<p><em>static</em> <strong><font color=DeepPink>month_end</font></strong>(days_offset=0)</p>
<blockquote>
<p>每個月底觸發某項規則，並可以選擇性的新增一個偏移量。</p>
<p><strong>Parameters:</strong>
- <strong>days_offset</strong>(<em>int , optional</em>)：
  - 在月底之前的第幾個交易日（由0開始計算）觸發某項規則。預設值是0，即在月底的最後一個交易日觸發。
  - days_offset只能介於0~22之間。 </p>
<p><strong>Returns:</strong>
- rule</p>
<p><strong>Return type:</strong>
- zipline.utils.events.EventRule</p>
</blockquote>
<p><br></p>
<p><em>static</em> <strong><font color=DeepPink>month_start</font></strong>(days_offset=0)</p>
<blockquote>
<p>每個月初觸發某項規則，並可以選擇性的新增一個偏移量。</p>
<p><strong>Parameters:</strong>
- <strong>days_offset</strong>(<em>int , optional</em>)：
  - 在月初之後的第幾個交易日（由0開始計算）才觸發某項規則。預設值是0，即在月初的第一個交易日觸發。
  - days_offset只能介於0~22之間。 </p>
<p><strong>Returns:</strong>
- rule</p>
<p><strong>Return type:</strong>
- zipline.utils.events.EventRule</p>
</blockquote>
<p><br></p>
<p><em>static</em> <strong><font color=DeepPink>week_end</font></strong>(days_offset=0)</p>
<blockquote>
<p>在每周最後一個交易日觸發某項規則，並可以選擇性的新增一個偏移量。</p>
<p><strong>Parameters:</strong>
- <strong>days_offset</strong>(<em>int , optional</em>)：
  - 在每周倒數第幾個交易日（由0開始計算）觸發某項規則。預設值是0，即在每周的最後一個交易日觸發。
  - days_offset只能介於0~4之間。 </p>
<p><strong>Returns:</strong>
- rule</p>
<p><strong>Return type:</strong>
- zipline.utils.events.EventRule</p>
</blockquote>
<p><br></p>
<p><em>static</em> <strong><font color=DeepPink>week_start</font></strong>(days_offset=0)</p>
<blockquote>
<p>在每周的第一個交易日觸發某項規則，並可以選擇性的新增一個偏移量。</p>
<p><strong>Parameters:</strong>
- <strong>days_offset</strong>(<em>int , optional</em>)：
  - 在每周的第幾個交易日（由0開始計算）才觸發某項規則。預設值是0，即在每周的第一個交易日觸發。
  - days_offset只能介於0~4之間。</p>
<p><strong>Returns:</strong>
- rule</p>
<p><strong>Return type:</strong>
- zipline.utils.events.EventRule</p>
</blockquote>
<p><span id="Examples"></span></p>
<h1 id="7-examples">7. Examples<a class="headerlink" href="#7-examples" title="Permanent link">&para;</a></h1>
<p><a href="#menu">Return to Menu</a></p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.utils.algo_instance</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_algo_instance</span><span class="p">,</span> <span class="n">set_algo_instance</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.algo.pipeline_algo</span><span class="w"> </span><span class="kn">import</span> <span class="n">TargetPercentPipeAlgo</span>
</span></code></pre></div>
<p><span id="Case1"></span></p>
<h2 id="case-1-start_sessionend_session">Case 1 調整start_session與end_session<a class="headerlink" href="#case-1-start_sessionend_session" title="Permanent link">&para;</a></h2>
<p><a href="#menu">Return to Menu</a></p>
<p>僅調整<code>start_session</code>與<code>end_session</code>。其餘保持預設值。</p>
<p>以下設定pipeline（<code>make_pipeline()</code>），並定義<code>longs</code>欄位用來判斷須持有的股票。在<code>longs</code>欄位中要持有的股票標記為True，反之標記為False。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">bundles</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="n">bundle</span> <span class="o">=</span> <span class="n">bundles</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">bundle_name</span><span class="p">)</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_pipeline</span><span class="p">():</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>    <span class="n">rsi</span> <span class="o">=</span> <span class="n">RSI</span><span class="p">()</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>    <span class="n">longs</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">top</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">SingleAsset</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">lookup_symbol</span><span class="p">(</span><span class="s1">&#39;IR0001&#39;</span><span class="p">,</span> <span class="n">as_of_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>    <span class="k">return</span> <span class="n">Pipeline</span><span class="p">(</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>        <span class="n">columns</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a>            <span class="s2">&quot;longs&quot;</span> <span class="p">:</span> <span class="n">longs</span><span class="p">,</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>        <span class="p">}</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>    <span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="n">algo_start</span> <span class="o">=</span> <span class="s1">&#39;2023-09-21&#39;</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="n">algo_start_dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">algo_start</span><span class="p">,</span> <span class="n">tz</span> <span class="o">=</span> <span class="n">tz</span><span class="p">)</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="n">result</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">make_pipeline</span><span class="p">(),</span> <span class="n">algo_start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="n">result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;longs == True&#39;</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="_2">執行演算法<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ol>
<li>實體化<code>TargetPercentPipeAlgo</code>並命名為<code>algo</code>。</li>
<li>設定演算法：<code>set_algo_instance(algo)</code></li>
<li>執行演算法，並產出回測報表<code>stats</code>（<em>pd.DataFrame</em>）：<code>stats = algo.run()</code></li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="p">)</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="c1"># set_algo_instance</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="c1"># run</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></div>
<p>查看演算法中的參數設定</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">algo</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="n">stats</span><span class="o">.</span><span class="n">T</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="n">transactions</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="n">positions</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;last_sale_price&#39;</span><span class="p">]</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="n">positions</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="n">stats</span><span class="o">.</span><span class="n">net_leverage</span>
</span></code></pre></div>
<p><span id="Case2"></span></p>
<h2 id="case-2-max_leverage">Case 2 調整max_leverage<a class="headerlink" href="#case-2-max_leverage" title="Permanent link">&para;</a></h2>
<p><a href="#menu">Return to Menu</a></p>
<p>接續**Case 1**，多調整<code>max_leverage=0.70</code>，其餘與**Case 1**相同。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>                     <span class="n">max_leverage</span><span class="o">=</span><span class="mf">0.70</span><span class="p">,</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="p">)</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="c1"># set_algo_instance</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="c1"># run</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="n">stats</span><span class="o">.</span><span class="n">net_leverage</span>
</span></code></pre></div>
<p><span id="Case3"></span></p>
<h2 id="case-3-tradeday">Case 3 調整tradeday<a class="headerlink" href="#case-3-tradeday" title="Permanent link">&para;</a></h2>
<p><a href="#menu">Return to Menu</a>  </p>
<p>接續**Case 1**，多新增<code>tradeday</code>，其餘與**Case 1**相同。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="c1"># 設定再平衡日期</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="n">freq</span> <span class="o">=</span> <span class="s1">&#39;MS&#39;</span>   <span class="c1"># QS-JUL  MS W</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="n">_tradeday</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_dt</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">freq</span><span class="p">))</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="n">tradeday</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_calendar</span><span class="p">(</span><span class="n">calendar_name</span><span class="p">)</span><span class="o">.</span><span class="n">next_open</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> \
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>           <span class="n">get_calendar</span><span class="p">(</span><span class="n">calendar_name</span><span class="p">)</span><span class="o">.</span><span class="n">is_session</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span> <span class="k">else</span> <span class="n">i</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_tradeday</span><span class="p">]</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="n">tradeday</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="n">algo_start_dt</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>           
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>                     <span class="n">tradeday</span><span class="o">=</span><span class="n">tradeday</span><span class="p">,</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="p">)</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="c1"># set_algo_instance</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="c1"># run</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="n">transactions</span>
</span></code></pre></div>
<p><span id="Case4"></span></p>
<h2 id="case-4-rebalance_date_rule">Case 4 調整rebalance_date_rule<a class="headerlink" href="#case-4-rebalance_date_rule" title="Permanent link">&para;</a></h2>
<p><a href="#menu">Return to Menu</a>  </p>
<p>接續**Case 1**，多新增<code>rebalance_date_rule</code>，並修改<code>start_session</code>為2023-09-01，其餘與**Case 1**相同。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">zipline.api</span><span class="w"> </span><span class="kn">import</span> <span class="n">date_rules</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2023-09-01&#39;</span><span class="p">,</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">),</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a>                     <span class="c1"># 每月的第四個交易日下單</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>                     <span class="n">rebalance_date_rule</span><span class="o">=</span><span class="n">date_rules</span><span class="o">.</span><span class="n">month_start</span><span class="p">(</span><span class="n">days_offset</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> 
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="p">)</span>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="c1"># set_algo_instance</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="c1"># run</span>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="n">orders</span>
</span></code></pre></div>
<p><span id="Case5"></span></p>
<h2 id="case-5-slippage_model">Case 5 調整slippage_model<a class="headerlink" href="#case-5-slippage_model" title="Permanent link">&para;</a></h2>
<p><a href="#menu">Return to Menu</a>  </p>
<p>接續**Case 1**，多新增<code>slippage_model</code>，將<code>volume_limit</code>由**0.025**調整為**0.01**，其餘與**Case 1**相同。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>                     <span class="n">slippage_model</span><span class="o">=</span><span class="n">slippage</span><span class="o">.</span><span class="n">VolumeShareSlippage</span><span class="p">(</span><span class="n">volume_limit</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">price_impact</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="p">)</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="c1"># set_algo_instance</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="c1"># run</span>
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="n">orders</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;1590&quot;) &amp; (created.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-25&quot;)&#39;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="c1"># 321000 * 1% = 3210(股) </span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="n">df_bundle_price</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;1590&quot;) &amp; (date.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-26&quot;)&#39;</span><span class="p">)[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]]</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="n">orders</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2885&quot;) &amp; (created.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-27&quot;)&#39;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="c1"># 10738000 * 1% = 107380(股) </span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="n">df_bundle_price</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2885&quot;) &amp; (date.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-28&quot;)&#39;</span><span class="p">)[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]]</span>
</span></code></pre></div>
<p><span id="Case6"></span></p>
<h2 id="case-6-stocklist">Case 6 調整stocklist<a class="headerlink" href="#case-6-stocklist" title="Permanent link">&para;</a></h2>
<p><a href="#menu">Return to Menu</a>  </p>
<p>接續**Case 1**，多新增<code>stocklist</code>，其餘與**Case 1**相同。  </p>
<p>註1：<code>stocklist</code>限制是在pipeline執行完後。  </p>
<p>註2：也可以使用pipeline直接限制股票池。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="nb">len</span><span class="p">(</span><span class="n">StockList</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="n">_StockList</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">StockList</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="s1">&#39;2886&#39;</span><span class="p">]</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="nb">len</span><span class="p">(</span><span class="n">_StockList</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>            
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>                     <span class="n">stocklist</span><span class="o">=</span><span class="n">_StockList</span><span class="p">,</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="p">)</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="c1"># set_algo_instance</span>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="c1"># run</span>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="n">positions</span>
</span></code></pre></div>
<p><span id="Case7"></span></p>
<h2 id="case-7-order_filling_policy">Case 7 調整order_filling_policy<a class="headerlink" href="#case-7-order_filling_policy" title="Permanent link">&para;</a></h2>
<p><a href="#menu">Return to Menu</a> </p>
<p>接續**Case 1**，多新增<code>order_filling_policy='current_bar'</code>，其餘與**Case 1**相同。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a>                     <span class="n">order_filling_policy</span><span class="o">=</span><span class="s1">&#39;current_bar&#39;</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a><span class="p">)</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a><span class="c1"># set_algo_instance</span>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10" href="#__codelineno-66-10"></a>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11" href="#__codelineno-66-11"></a><span class="c1"># run</span>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12" href="#__codelineno-66-12"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2023-09-22&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;longs == True&#39;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="c1"># 從`orders`中可以發現created=2023-09-22的單在當天就成交（status由0變為1）</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="n">orders</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2023-09-22&#39;</span><span class="p">]</span>
</span></code></pre></div>
<p><span id="Case8"></span></p>
<h2 id="case-8-allow_short">Case 8 調整allow_short<a class="headerlink" href="#case-8-allow_short" title="Permanent link">&para;</a></h2>
<p><a href="#menu">Return to Menu</a> </p>
<p>接續**Case 1**，多新增<code>allow_short=True</code>，其餘與**Case 1**相同。  </p>
<p>以下設定pipeline（<code>make_pipeline()</code>），並定義<code>shorts</code>欄位用來判斷須放空的股票。在<code>shorts</code>欄位中要放空的股票標記為True，反之標記為False。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_pipeline</span><span class="p">():</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>    <span class="n">rsi</span> <span class="o">=</span> <span class="n">RSI</span><span class="p">()</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a>    <span class="n">longs</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">top</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">SingleAsset</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">lookup_symbol</span><span class="p">(</span><span class="s1">&#39;IR0001&#39;</span><span class="p">,</span> <span class="n">as_of_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>    <span class="n">shorts</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">bottom</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">SingleAsset</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">lookup_symbol</span><span class="p">(</span><span class="s1">&#39;IR0001&#39;</span><span class="p">,</span> <span class="n">as_of_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a>    <span class="k">return</span> <span class="n">Pipeline</span><span class="p">(</span>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>        <span class="n">columns</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>            <span class="s2">&quot;longs&quot;</span> <span class="p">:</span> <span class="n">longs</span><span class="p">,</span>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>            <span class="s2">&quot;shorts&quot;</span> <span class="p">:</span> <span class="n">shorts</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>        <span class="p">}</span>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>    <span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="n">result</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">make_pipeline</span><span class="p">(),</span> <span class="n">algo_start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a><span class="n">result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(longs == True) | (shorts == True)&#39;</span> <span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>                     <span class="n">allow_short</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="p">)</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="c1"># set_algo_instance</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a><span class="c1"># run</span>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="c1"># 當天取消</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a><span class="n">orders</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2912&quot;) &amp; (created.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-28&quot;)&#39;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="c1"># 343000 * 2.5% = 8575(股) </span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="n">df_bundle_price</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2912&quot;) &amp; (date.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-10-02&quot;)&#39;</span><span class="p">)[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]]</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="n">positions</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;last_sale_price&#39;</span><span class="p">]</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="n">positions</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2912&quot;)&#39;</span><span class="p">)</span>
</span></code></pre></div>
<p><span id="Case9"></span></p>
<h2 id="case-9-cancel_datedelta">Case 9 調整cancel_datedelta<a class="headerlink" href="#case-9-cancel_datedelta" title="Permanent link">&para;</a></h2>
<p><a href="#menu">Return to Menu</a> </p>
<p>接續**Case 8**，多新增<code>cancel_datedelta=2</code>，其餘與**Case 8**相同。  </p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>                     <span class="n">allow_short</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>                     <span class="n">cancel_datedelta</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a><span class="p">)</span>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a>
</span><span id="__span-77-9"><a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a><span class="c1"># set_algo_instance</span>
</span><span id="__span-77-10"><a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
</span><span id="__span-77-11"><a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a>
</span><span id="__span-77-12"><a id="__codelineno-77-12" name="__codelineno-77-12" href="#__codelineno-77-12"></a><span class="c1"># run</span>
</span><span id="__span-77-13"><a id="__codelineno-77-13" name="__codelineno-77-13" href="#__codelineno-77-13"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="n">result</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">make_pipeline</span><span class="p">(),</span> <span class="n">algo_start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a><span class="n">result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(longs == True) | (shorts == True)&#39;</span> <span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="n">orders</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2912&quot;) &amp; (created.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-28&quot;)&#39;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="c1"># 10/02：343000 * 2.5% = 8575(股) </span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="c1"># 10/03：808000 * 2.5% = 20200(股) </span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="n">df_bundle_price</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2912&quot;) &amp; (date.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;)&gt;=&quot;2023-10-02&quot;)&#39;</span><span class="p">)</span>\
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a>                 <span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;volume&#39;</span><span class="p">]]</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="n">positions</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">positions</span><span class="p">[</span><span class="s1">&#39;last_sale_price&#39;</span><span class="p">]</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="n">positions</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;2912&quot;)&#39;</span><span class="p">)</span>
</span></code></pre></div>
<p><span id="Case10"></span></p>
<h2 id="case-10-limit_buy_multiplier">Case 10 調整limit_buy_multiplier<a class="headerlink" href="#case-10-limit_buy_multiplier" title="Permanent link">&para;</a></h2>
<p><a href="#menu">Return to Menu</a> </p>
<p>接續**Case 9**，多設定<code>limit_buy_multiplier=1.015</code>，其餘與**Case 9**相同。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="n">result</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">make_pipeline</span><span class="p">(),</span> <span class="n">algo_start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="n">result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(longs == True) | (shorts == True)&#39;</span> <span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a>                     <span class="n">limit_buy_multiplier</span><span class="o">=</span><span class="mf">1.015</span><span class="p">,</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a>                     <span class="n">allow_short</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a>                     <span class="n">cancel_datedelta</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="p">)</span>
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a>
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a><span class="c1"># set_algo_instance</span>
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a>
</span><span id="__span-84-13"><a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a><span class="c1"># run</span>
</span><span id="__span-84-14"><a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="n">positions</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">get_transaction_detail</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="n">orders</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="n">orders</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;1590&quot;) &amp; (created.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;) == &quot;2023-09-28&quot;)&#39;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="c1"># 9/28 979 * 1.015 = 993.685</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2" href="#__codelineno-88-2"></a><span class="n">df_bundle_price</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(symbol == &quot;1590&quot;) &amp; (date.dt.strftime(&quot;%Y-%m-</span><span class="si">%d</span><span class="s1">&quot;)&gt;=&quot;2023-09-28&quot;)&#39;</span><span class="p">)</span>\
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3" href="#__codelineno-88-3"></a>                 <span class="p">[[</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;close&#39;</span><span class="p">]]</span>
</span></code></pre></div>
<p><span id="Case11"></span></p>
<h2 id="case-11-custom_weightanalyzerecord_varsget_record_varsget_transaction_detail">Case 11 調整custom_weight、analyze、record_vars、get_record_vars與get_transaction_detail<a class="headerlink" href="#case-11-custom_weightanalyzerecord_varsget_record_varsget_transaction_detail" title="Permanent link">&para;</a></h2>
<p><a href="#menu">Return to Menu</a> </p>
<p>接續**Case 10**，多設定<code>custom_weight</code>=True、<code>analyze</code>、<code>record_vars</code>、<code>get_record_vars</code>=True與<code>get_transaction_detail</code>=True，其餘與**Case 10**相同。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Weight</span><span class="p">(</span><span class="n">CustomFactor</span><span class="p">):</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2" href="#__codelineno-89-2"></a>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3" href="#__codelineno-89-3"></a>    <span class="n">inputs</span> <span class="o">=</span>  <span class="p">[</span><span class="n">TQAltDataSet</span><span class="o">.</span><span class="n">Market_Cap_Dollars</span><span class="p">]</span> 
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4" href="#__codelineno-89-4"></a>    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Market_Cap_Dollars&quot;</span><span class="p">,</span><span class="s2">&quot;Sum_Market_Cap_Dollars&quot;</span><span class="p">,</span><span class="s2">&quot;Weight&quot;</span><span class="p">]</span>   
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5" href="#__codelineno-89-5"></a>    <span class="n">window_length</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6" href="#__codelineno-89-6"></a>
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7" href="#__codelineno-89-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">today</span><span class="p">,</span> <span class="n">assets</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">Market_Cap_Dollars</span><span class="p">):</span>
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8" href="#__codelineno-89-8"></a>
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9" href="#__codelineno-89-9"></a>        <span class="n">out</span><span class="o">.</span><span class="n">Market_Cap_Dollars</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Market_Cap_Dollars</span>
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10" href="#__codelineno-89-10"></a>        <span class="n">out</span><span class="o">.</span><span class="n">Sum_Market_Cap_Dollars</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">Market_Cap_Dollars</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-89-11"><a id="__codelineno-89-11" name="__codelineno-89-11" href="#__codelineno-89-11"></a>        <span class="n">out</span><span class="o">.</span><span class="n">Weight</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Market_Cap_Dollars</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Market_Cap_Dollars</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">make_pipeline</span><span class="p">():</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2" href="#__codelineno-90-2"></a>
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3" href="#__codelineno-90-3"></a>    <span class="n">rsi</span> <span class="o">=</span> <span class="n">RSI</span><span class="p">()</span>
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4" href="#__codelineno-90-4"></a>    <span class="n">longs</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">top</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">SingleAsset</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">lookup_symbol</span><span class="p">(</span><span class="s1">&#39;IR0001&#39;</span><span class="p">,</span> <span class="n">as_of_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5" href="#__codelineno-90-5"></a>    <span class="n">shorts</span> <span class="o">=</span> <span class="n">rsi</span><span class="o">.</span><span class="n">bottom</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">SingleAsset</span><span class="p">(</span><span class="n">bundle</span><span class="o">.</span><span class="n">asset_finder</span><span class="o">.</span><span class="n">lookup_symbol</span><span class="p">(</span><span class="s1">&#39;IR0001&#39;</span><span class="p">,</span> <span class="n">as_of_date</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6" href="#__codelineno-90-6"></a>
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7" href="#__codelineno-90-7"></a>    <span class="k">return</span> <span class="n">Pipeline</span><span class="p">(</span>
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8" href="#__codelineno-90-8"></a>
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9" href="#__codelineno-90-9"></a>        <span class="n">columns</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10" href="#__codelineno-90-10"></a>            <span class="s2">&quot;Market_Cap_Dollars&quot;</span><span class="p">:</span><span class="n">Weight</span><span class="p">()</span><span class="o">.</span><span class="n">Market_Cap_Dollars</span><span class="p">,</span>        
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11" href="#__codelineno-90-11"></a>            <span class="s2">&quot;longs&quot;</span> <span class="p">:</span> <span class="n">longs</span><span class="p">,</span>
</span><span id="__span-90-12"><a id="__codelineno-90-12" name="__codelineno-90-12" href="#__codelineno-90-12"></a>            <span class="s2">&quot;shorts&quot;</span> <span class="p">:</span> <span class="n">shorts</span><span class="p">,</span>
</span><span id="__span-90-13"><a id="__codelineno-90-13" name="__codelineno-90-13" href="#__codelineno-90-13"></a>            <span class="s2">&quot;long_weights&quot;</span> <span class="p">:</span> <span class="n">Weight</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">longs</span><span class="p">)</span><span class="o">.</span><span class="n">Weight</span><span class="p">,</span>
</span><span id="__span-90-14"><a id="__codelineno-90-14" name="__codelineno-90-14" href="#__codelineno-90-14"></a>            <span class="s2">&quot;short_weights&quot;</span> <span class="p">:</span> <span class="n">Weight</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">shorts</span><span class="p">)</span><span class="o">.</span><span class="n">Weight</span>
</span><span id="__span-90-15"><a id="__codelineno-90-15" name="__codelineno-90-15" href="#__codelineno-90-15"></a>        <span class="p">}</span>
</span><span id="__span-90-16"><a id="__codelineno-90-16" name="__codelineno-90-16" href="#__codelineno-90-16"></a>    <span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="k">def</span><span class="w"> </span><span class="nf">analyze</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">perf</span><span class="p">):</span>
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2" href="#__codelineno-91-2"></a>
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3" href="#__codelineno-91-3"></a>    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4" href="#__codelineno-91-4"></a>
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5" href="#__codelineno-91-5"></a>    <span class="c1"># First chart(累積報酬)</span>
</span><span id="__span-91-6"><a id="__codelineno-91-6" name="__codelineno-91-6" href="#__codelineno-91-6"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">611</span><span class="p">)</span> 
</span><span id="__span-91-7"><a id="__codelineno-91-7" name="__codelineno-91-7" href="#__codelineno-91-7"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Strategy Results&#39;</span><span class="p">)</span> 
</span><span id="__span-91-8"><a id="__codelineno-91-8" name="__codelineno-91-8" href="#__codelineno-91-8"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;algorithm_period_return&#39;</span><span class="p">],</span>
</span><span id="__span-91-9"><a id="__codelineno-91-9" name="__codelineno-91-9" href="#__codelineno-91-9"></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
</span><span id="__span-91-10"><a id="__codelineno-91-10" name="__codelineno-91-10" href="#__codelineno-91-10"></a>            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;algorithm period return&#39;</span><span class="p">,</span>
</span><span id="__span-91-11"><a id="__codelineno-91-11" name="__codelineno-91-11" href="#__codelineno-91-11"></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
</span><span id="__span-91-12"><a id="__codelineno-91-12" name="__codelineno-91-12" href="#__codelineno-91-12"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;benchmark_period_return&#39;</span><span class="p">],</span>
</span><span id="__span-91-13"><a id="__codelineno-91-13" name="__codelineno-91-13" href="#__codelineno-91-13"></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
</span><span id="__span-91-14"><a id="__codelineno-91-14" name="__codelineno-91-14" href="#__codelineno-91-14"></a>            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;benchmark period return&#39;</span><span class="p">,</span>
</span><span id="__span-91-15"><a id="__codelineno-91-15" name="__codelineno-91-15" href="#__codelineno-91-15"></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
</span><span id="__span-91-16"><a id="__codelineno-91-16" name="__codelineno-91-16" href="#__codelineno-91-16"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-91-17"><a id="__codelineno-91-17" name="__codelineno-91-17" href="#__codelineno-91-17"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-91-18"><a id="__codelineno-91-18" name="__codelineno-91-18" href="#__codelineno-91-18"></a>
</span><span id="__span-91-19"><a id="__codelineno-91-19" name="__codelineno-91-19" href="#__codelineno-91-19"></a>    <span class="c1"># Second chart(returns)</span>
</span><span id="__span-91-20"><a id="__codelineno-91-20" name="__codelineno-91-20" href="#__codelineno-91-20"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">612</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>       
</span><span id="__span-91-21"><a id="__codelineno-91-21" name="__codelineno-91-21" href="#__codelineno-91-21"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;returns&#39;</span><span class="p">],</span>
</span><span id="__span-91-22"><a id="__codelineno-91-22" name="__codelineno-91-22" href="#__codelineno-91-22"></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
</span><span id="__span-91-23"><a id="__codelineno-91-23" name="__codelineno-91-23" href="#__codelineno-91-23"></a>            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;returns&#39;</span><span class="p">,</span>
</span><span id="__span-91-24"><a id="__codelineno-91-24" name="__codelineno-91-24" href="#__codelineno-91-24"></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
</span><span id="__span-91-25"><a id="__codelineno-91-25" name="__codelineno-91-25" href="#__codelineno-91-25"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-91-26"><a id="__codelineno-91-26" name="__codelineno-91-26" href="#__codelineno-91-26"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-91-27"><a id="__codelineno-91-27" name="__codelineno-91-27" href="#__codelineno-91-27"></a>
</span><span id="__span-91-28"><a id="__codelineno-91-28" name="__codelineno-91-28" href="#__codelineno-91-28"></a>    <span class="c1"># Third chart(ending_cash) -&gt; 觀察是否超買</span>
</span><span id="__span-91-29"><a id="__codelineno-91-29" name="__codelineno-91-29" href="#__codelineno-91-29"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">613</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</span><span id="__span-91-30"><a id="__codelineno-91-30" name="__codelineno-91-30" href="#__codelineno-91-30"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;ending_cash&#39;</span><span class="p">],</span> 
</span><span id="__span-91-31"><a id="__codelineno-91-31" name="__codelineno-91-31" href="#__codelineno-91-31"></a>            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ending_cash&#39;</span><span class="p">,</span>
</span><span id="__span-91-32"><a id="__codelineno-91-32" name="__codelineno-91-32" href="#__codelineno-91-32"></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
</span><span id="__span-91-33"><a id="__codelineno-91-33" name="__codelineno-91-33" href="#__codelineno-91-33"></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
</span><span id="__span-91-34"><a id="__codelineno-91-34" name="__codelineno-91-34" href="#__codelineno-91-34"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-91-35"><a id="__codelineno-91-35" name="__codelineno-91-35" href="#__codelineno-91-35"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-91-36"><a id="__codelineno-91-36" name="__codelineno-91-36" href="#__codelineno-91-36"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-91-37"><a id="__codelineno-91-37" name="__codelineno-91-37" href="#__codelineno-91-37"></a>
</span><span id="__span-91-38"><a id="__codelineno-91-38" name="__codelineno-91-38" href="#__codelineno-91-38"></a>    <span class="c1"># Forth chart(shorts_count) -&gt; 觀察是否放空</span>
</span><span id="__span-91-39"><a id="__codelineno-91-39" name="__codelineno-91-39" href="#__codelineno-91-39"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">614</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</span><span id="__span-91-40"><a id="__codelineno-91-40" name="__codelineno-91-40" href="#__codelineno-91-40"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;shorts_count&#39;</span><span class="p">],</span> 
</span><span id="__span-91-41"><a id="__codelineno-91-41" name="__codelineno-91-41" href="#__codelineno-91-41"></a>            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;shorts_count&#39;</span><span class="p">,</span>
</span><span id="__span-91-42"><a id="__codelineno-91-42" name="__codelineno-91-42" href="#__codelineno-91-42"></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
</span><span id="__span-91-43"><a id="__codelineno-91-43" name="__codelineno-91-43" href="#__codelineno-91-43"></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
</span><span id="__span-91-44"><a id="__codelineno-91-44" name="__codelineno-91-44" href="#__codelineno-91-44"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="__span-91-45"><a id="__codelineno-91-45" name="__codelineno-91-45" href="#__codelineno-91-45"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-91-46"><a id="__codelineno-91-46" name="__codelineno-91-46" href="#__codelineno-91-46"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-91-47"><a id="__codelineno-91-47" name="__codelineno-91-47" href="#__codelineno-91-47"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-91-48"><a id="__codelineno-91-48" name="__codelineno-91-48" href="#__codelineno-91-48"></a>
</span><span id="__span-91-49"><a id="__codelineno-91-49" name="__codelineno-91-49" href="#__codelineno-91-49"></a>    <span class="c1"># Fifth chart(longs_count)</span>
</span><span id="__span-91-50"><a id="__codelineno-91-50" name="__codelineno-91-50" href="#__codelineno-91-50"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">615</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</span><span id="__span-91-51"><a id="__codelineno-91-51" name="__codelineno-91-51" href="#__codelineno-91-51"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">perf</span><span class="p">[</span><span class="s1">&#39;longs_count&#39;</span><span class="p">],</span> 
</span><span id="__span-91-52"><a id="__codelineno-91-52" name="__codelineno-91-52" href="#__codelineno-91-52"></a>            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;longs_count&#39;</span><span class="p">,</span>
</span><span id="__span-91-53"><a id="__codelineno-91-53" name="__codelineno-91-53" href="#__codelineno-91-53"></a>            <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
</span><span id="__span-91-54"><a id="__codelineno-91-54" name="__codelineno-91-54" href="#__codelineno-91-54"></a>            <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
</span><span id="__span-91-55"><a id="__codelineno-91-55" name="__codelineno-91-55" href="#__codelineno-91-55"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="__span-91-56"><a id="__codelineno-91-56" name="__codelineno-91-56" href="#__codelineno-91-56"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-91-57"><a id="__codelineno-91-57" name="__codelineno-91-57" href="#__codelineno-91-57"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span><span id="__span-91-58"><a id="__codelineno-91-58" name="__codelineno-91-58" href="#__codelineno-91-58"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> 
</span><span id="__span-91-59"><a id="__codelineno-91-59" name="__codelineno-91-59" href="#__codelineno-91-59"></a>
</span><span id="__span-91-60"><a id="__codelineno-91-60" name="__codelineno-91-60" href="#__codelineno-91-60"></a>    <span class="c1"># Sixth chart(weights) -&gt; 觀察每日持股權重</span>
</span><span id="__span-91-61"><a id="__codelineno-91-61" name="__codelineno-91-61" href="#__codelineno-91-61"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">616</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>        
</span><span id="__span-91-62"><a id="__codelineno-91-62" name="__codelineno-91-62" href="#__codelineno-91-62"></a>    <span class="n">weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">perf</span><span class="p">[</span><span class="s1">&#39;daily_weights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</span><span id="__span-91-63"><a id="__codelineno-91-63" name="__codelineno-91-63" href="#__codelineno-91-63"></a>
</span><span id="__span-91-64"><a id="__codelineno-91-64" name="__codelineno-91-64" href="#__codelineno-91-64"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">weights</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
</span><span id="__span-91-65"><a id="__codelineno-91-65" name="__codelineno-91-65" href="#__codelineno-91-65"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
</span><span id="__span-91-66"><a id="__codelineno-91-66" name="__codelineno-91-66" href="#__codelineno-91-66"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;daily_weights&#39;</span><span class="p">)</span>
</span><span id="__span-91-67"><a id="__codelineno-91-67" name="__codelineno-91-67" href="#__codelineno-91-67"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="__span-91-68"><a id="__codelineno-91-68" name="__codelineno-91-68" href="#__codelineno-91-68"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;daily_weights&#39;</span><span class="p">])</span>
</span><span id="__span-91-69"><a id="__codelineno-91-69" name="__codelineno-91-69" href="#__codelineno-91-69"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</span><span id="__span-91-70"><a id="__codelineno-91-70" name="__codelineno-91-70" href="#__codelineno-91-70"></a>
</span><span id="__span-91-71"><a id="__codelineno-91-71" name="__codelineno-91-71" href="#__codelineno-91-71"></a>    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="__span-91-72"><a id="__codelineno-91-72" name="__codelineno-91-72" href="#__codelineno-91-72"></a>
</span><span id="__span-91-73"><a id="__codelineno-91-73" name="__codelineno-91-73" href="#__codelineno-91-73"></a><span class="k">def</span><span class="w"> </span><span class="nf">record_vars</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="__span-91-74"><a id="__codelineno-91-74" name="__codelineno-91-74" href="#__codelineno-91-74"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-91-75"><a id="__codelineno-91-75" name="__codelineno-91-75" href="#__codelineno-91-75"></a><span class="sd">    Plot variables at the end of each day.</span>
</span><span id="__span-91-76"><a id="__codelineno-91-76" name="__codelineno-91-76" href="#__codelineno-91-76"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-91-77"><a id="__codelineno-91-77" name="__codelineno-91-77" href="#__codelineno-91-77"></a>
</span><span id="__span-91-78"><a id="__codelineno-91-78" name="__codelineno-91-78" href="#__codelineno-91-78"></a>    <span class="n">record</span><span class="p">(</span><span class="n">daily_weights</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">daily_weights</span><span class="p">,</span>
</span><span id="__span-91-79"><a id="__codelineno-91-79" name="__codelineno-91-79" href="#__codelineno-91-79"></a>           <span class="n">Market_Cap_Dollars</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">Market_Cap_Dollars</span>
</span><span id="__span-91-80"><a id="__codelineno-91-80" name="__codelineno-91-80" href="#__codelineno-91-80"></a>          <span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="n">algo</span> <span class="o">=</span> <span class="n">TargetPercentPipeAlgo</span><span class="p">(</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2" href="#__codelineno-92-2"></a>                     <span class="n">start_session</span><span class="o">=</span><span class="n">algo_start_dt</span><span class="p">,</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3" href="#__codelineno-92-3"></a>                     <span class="n">end_session</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4" href="#__codelineno-92-4"></a>                     <span class="n">limit_buy_multiplier</span><span class="o">=</span><span class="mf">1.015</span><span class="p">,</span>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5" href="#__codelineno-92-5"></a>                     <span class="n">allow_short</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6" href="#__codelineno-92-6"></a>                     <span class="n">custom_weight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7" href="#__codelineno-92-7"></a>                     <span class="n">cancel_datedelta</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="__span-92-8"><a id="__codelineno-92-8" name="__codelineno-92-8" href="#__codelineno-92-8"></a>                     <span class="n">pipeline</span><span class="o">=</span><span class="n">make_pipeline</span><span class="p">,</span>
</span><span id="__span-92-9"><a id="__codelineno-92-9" name="__codelineno-92-9" href="#__codelineno-92-9"></a>                     <span class="n">analyze</span><span class="o">=</span><span class="n">analyze</span><span class="p">,</span>
</span><span id="__span-92-10"><a id="__codelineno-92-10" name="__codelineno-92-10" href="#__codelineno-92-10"></a>                     <span class="n">record_vars</span><span class="o">=</span><span class="n">record_vars</span><span class="p">,</span>
</span><span id="__span-92-11"><a id="__codelineno-92-11" name="__codelineno-92-11" href="#__codelineno-92-11"></a>                     <span class="n">get_record_vars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="__span-92-12"><a id="__codelineno-92-12" name="__codelineno-92-12" href="#__codelineno-92-12"></a>                     <span class="n">get_transaction_detail</span><span class="o">=</span><span class="kc">True</span>
</span><span id="__span-92-13"><a id="__codelineno-92-13" name="__codelineno-92-13" href="#__codelineno-92-13"></a><span class="p">)</span>
</span><span id="__span-92-14"><a id="__codelineno-92-14" name="__codelineno-92-14" href="#__codelineno-92-14"></a>
</span><span id="__span-92-15"><a id="__codelineno-92-15" name="__codelineno-92-15" href="#__codelineno-92-15"></a><span class="c1"># set_algo_instance</span>
</span><span id="__span-92-16"><a id="__codelineno-92-16" name="__codelineno-92-16" href="#__codelineno-92-16"></a><span class="n">set_algo_instance</span><span class="p">(</span><span class="n">algo</span><span class="p">)</span>
</span><span id="__span-92-17"><a id="__codelineno-92-17" name="__codelineno-92-17" href="#__codelineno-92-17"></a>
</span><span id="__span-92-18"><a id="__codelineno-92-18" name="__codelineno-92-18" href="#__codelineno-92-18"></a><span class="c1"># run</span>
</span><span id="__span-92-19"><a id="__codelineno-92-19" name="__codelineno-92-19" href="#__codelineno-92-19"></a><span class="n">stats</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="n">result</span> <span class="o">=</span> <span class="n">run_pipeline</span><span class="p">(</span><span class="n">make_pipeline</span><span class="p">(),</span> <span class="n">algo_start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a><span class="n">result</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;(longs == True) | (shorts == True)&#39;</span> <span class="p">)</span>
</span></code></pre></div>
<h4 id="algopositions">algo.positions<a class="headerlink" href="#algopositions" title="Permanent link">&para;</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="c1"># 計算實際股票部位的weight = 個股持股市值／所有股票部位的持股市值加總</span>
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="n">pos</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">positions</span>
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a>
</span><span id="__span-94-4"><a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;last_sale_price&#39;</span><span class="p">]</span>
</span><span id="__span-94-5"><a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a>
</span><span id="__span-94-6"><a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a><span class="n">positive_sum</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="__span-94-7"><a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a><span class="n">negative_sum</span> <span class="o">=</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="__span-94-8"><a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="__span-94-9"><a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a>                            <span class="n">pos</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">positive_sum</span><span class="p">),</span>
</span><span id="__span-94-10"><a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a>                            <span class="n">pos</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">negative_sum</span><span class="p">))</span>
</span><span id="__span-94-11"><a id="__codelineno-94-11" name="__codelineno-94-11" href="#__codelineno-94-11"></a>
</span><span id="__span-94-12"><a id="__codelineno-94-12" name="__codelineno-94-12" href="#__codelineno-94-12"></a><span class="n">pos</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;mv&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pos</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span>
</span><span id="__span-94-13"><a id="__codelineno-94-13" name="__codelineno-94-13" href="#__codelineno-94-13"></a><span class="n">pos</span>
</span></code></pre></div>
<h4 id="algodict_record_vars">algo.dict_record_vars<a class="headerlink" href="#algodict_record_vars" title="Permanent link">&para;</a></h4>
<div class="language-python highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a><span class="n">record_vars</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">dict_record_vars</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="c1"># 實際持股市值 = 個股持股市值／所有股票部位的持股市值加總 * max_leverage</span>
</span><span id="__span-96-2"><a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a><span class="n">record_vars</span><span class="p">[</span><span class="s1">&#39;daily_weights&#39;</span><span class="p">]</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="c1"># 個股總市值</span>
</span><span id="__span-97-2"><a id="__codelineno-97-2" name="__codelineno-97-2" href="#__codelineno-97-2"></a><span class="n">record_vars</span><span class="p">[</span><span class="s1">&#39;Market_Cap_Dollars&#39;</span><span class="p">]</span>
</span></code></pre></div>
<p><a href="#menu">Return to Menu</a> </p>









  




                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到頂端
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="頁腳" >
        
          
          <a href="../documents54/" class="md-footer__link md-footer__link--prev" aria-label="上一頁: context">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一頁
              </span>
              <div class="md-ellipsis">
                context
              </div>
            </div>
          </a>
        
        
          
          <a href="../documents14/" class="md-footer__link md-footer__link--next" aria-label="下一頁: 股票池(Universe API)">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一頁
              </span>
              <div class="md-ellipsis">
                股票池(Universe API)
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 - MkDocs
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/squidfunk/mkdocs-material" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.tabs.link", "content.tooltips", "navigation.indexes", "navigation.expand", "navigation.top", "navigation.tracking", "navigation.footer", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u8907\u88fd", "clipboard.copy": "\u8907\u88fd", "search.result.more.one": "\u6b64\u9801\u5c1a\u6709 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.more.other": "\u6b64\u9801\u5c1a\u6709 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.none": "\u6c92\u6709\u7b26\u5408\u7684\u9805\u76ee", "search.result.one": "\u627e\u5230 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.other": "\u627e\u5230 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.placeholder": "\u6253\u5b57\u9032\u884c\u641c\u5c0b", "search.result.term.missing": "\u7f3a\u5c11\u5b57\u8a5e", "select.version": "\u9078\u64c7\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>