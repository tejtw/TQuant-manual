{"config":{"lang":["zh"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"TQuant Lab\uff1a\u4e00\u7ad9\u5f0f\u91cf\u5316\u7814\u7a76\u5e73\u53f0","text":"<p>Info</p> <p>\u6b61\u8fce\u4f86\u5230 TQuant Lab\uff01\u672c\u5e73\u53f0\u6574\u5408\u4e86\u5168\u53f0\u6700\u5b8c\u5584\u7684\u91cf\u5316\u8cc7\u6599\u3001\u6700\u5f37\u5927\u7684\u4e8b\u4ef6\u9a45\u52d5\u578b\u56de\u6e2c\u5f15\u64ce\uff0c\u4ee5\u53ca\u5c08\u696d\u7684\u7e3e\u6548\u5206\u6790\u5de5\u5177\u3002\u7121\u8ad6\u60a8\u662f\u91cf\u5316\u7814\u7a76\u65b0\u624b\u6216\u8cc7\u6df1\u5c08\u5bb6\uff0cTQuant Lab \u90fd\u80fd\u52a9\u60a8\u5c07\u7b56\u7565\u60f3\u6cd5\u8f49\u5316\u70ba\u5be6\u6230\u6210\u679c\u3002</p> <p>TQuant Lab \u5177\u5099\u4e09\u5927\u6838\u5fc3\u512a\u52e2\uff1a</p> <ul> <li>\u5353\u8d8a\u6578\u64da\u54c1\u8cea\uff1a\u6574\u5408\u9f90\u5927\u4e14\u7d93\u56b4\u683c\u9a57\u8b49\u7684 PIT\uff08Point In Time\uff09\u8cc7\u6599\u5eab\uff0c\u78ba\u4fdd\u56de\u6e2c\u7d50\u679c\u771f\u5be6\u53ef\u9760\u3002</li> <li>\u5f37\u5927\u56de\u6e2c\u5f15\u64ce\uff1a\u63a1\u7528 Zipline \u4e8b\u4ef6\u9a45\u52d5\u578b\u56de\u6e2c\u6846\u67b6\uff0c\u652f\u63f4\u8907\u96dc\u7b56\u7565\u908f\u8f2f\u3001\u6a21\u7d44\u5316\u5efa\u69cb\u8207\u9ad8\u6548\u6a21\u64ec\u3002</li> <li>\u5168\u65b9\u4f4d\u5206\u6790\u5de5\u5177\uff1a\u5167\u5efa Pyfolio \u8207 Alphalens \u7b49\u5c08\u696d\u5957\u4ef6\uff0c\u63d0\u4f9b\u8a73\u7d30\u7e3e\u6548\u6307\u6a19\u8207\u8996\u89ba\u5316\u5831\u544a\uff0c\u52a9\u60a8\u7cbe\u6e96\u8a55\u4f30\u7b56\u7565\u8868\u73fe\u3002</li> </ul>"},{"location":"#_1","title":"\u5feb\u901f\u5c0e\u89bd","text":"<p>\u4ee5\u4e0b\u662f TQuant Lab \u624b\u518a\u7684\u4e3b\u8981\u7ae0\u7bc0\uff0c\u9ede\u64ca\u53ef\u5feb\u901f\u524d\u5f80\uff1a</p> <ul> <li>\u9996\u9801\uff1a\u5e73\u53f0\u6982\u89bd\u8207\u6700\u65b0\u8cc7\u8a0a\u3002</li> <li>\u65b0\u624b\u4e0a\u8def\uff1a\u5f9e\u5165\u9580\u5230\u5be6\u6230\uff0c\u9010\u6b65\u5f15\u5c0e\u60a8\u5b78\u7fd2 TQuant Lab \u7684\u4f7f\u7528\u65b9\u6cd5\u3002</li> <li>\u6838\u5fc3\u6982\u5ff5\uff1a\u6df1\u5165\u7406\u89e3 Zipline \u5f15\u64ce\u3001Pipeline\u3001\u4ea4\u6613\u65e5\u66c6\u7b49\u95dc\u9375\u7406\u8ad6\u3002</li> <li>\u64cd\u4f5c\u6307\u5357\uff1a\u63d0\u4f9b\u8a73\u7d30\u7684\u5b89\u88dd\u3001\u8cc7\u6599\u7ba1\u7406\u8207\u56de\u6e2c\u8a2d\u5b9a\u6559\u5b78\u3002</li> <li>API \u53c3\u8003\uff1a\u67e5\u95b1\u6240\u6709 Zipline\u3001Pipeline\u3001Pyfolio \u7b49\u6838\u5fc3 API \u7684\u8a73\u7d30\u6587\u4ef6\u3002</li> <li>\u7b56\u7565\u7a4d\u6728\u5c08\u5340\uff1a\u6211\u5011\u70ba\u60a8\u6240\u8a2d\u8a08\u7684\u4e09\u5927\u7b56\u7565\u6a21\u677f\u8207\u7cbe\u9078\u7bc4\u4f8b\uff0c\u5354\u52a9\u60a8\u5feb\u901f\u958b\u767c\u5c6c\u65bc\u60a8\u5c08\u5c6c\u7684\u7b56\u7565!</li> </ul>"},{"location":"#_2","title":"\u6559\u5b78\u5f71\u7247","text":"<p>\u6211\u5011\u63d0\u4f9b\u4e0d\u540c\u6df1\u5ea6\u7684\u5f71\u97f3\u6559\u5b78\u8cc7\u6e90\uff0c\u5354\u52a9\u60a8\u5feb\u901f\u4e0a\u624b\uff1a</p> <ul> <li> <p>TEJ \u5b98\u65b9 YouTube \u983b\u9053\uff5cTQuant Lab \u5be6\u6230\u7cfb\u5217 (\u514d\u8cbb)</p> <ul> <li>\u6536\u9304\u8d85\u904e 20 \u652f\u8a73\u7d30\u7684\u529f\u80fd\u64cd\u4f5c\u5f71\u7247\uff0c\u9069\u5408\u559c\u6b61\u81ea\u884c\u63a2\u7d22\u7d30\u7bc0\u7684\u4f7f\u7528\u8005\u3002\u5167\u5bb9\u6db5\u84cb\uff1a<ol> <li>\u7cfb\u7d71\u5165\u9580\uff1a\u5e73\u53f0\u5b89\u88dd\u3001\u74b0\u5883\u5efa\u7f6e\u8207 Data Collection \u8cc7\u6599\u8f09\u5165\u6559\u5b78\u3002</li> <li>\u4ea4\u6613\u7d30\u7bc0\u8a2d\u5b9a\uff1a\u6df1\u5165\u89e3\u8aaa\u4e0b\u55ae\u65b9\u5f0f\u3001\u6ed1\u50f9 (Slippage)\u3001\u624b\u7e8c\u8cbb (Commission) \u53ca\u4ea4\u6613\u9650\u5236\u8a2d\u5b9a\u3002</li> <li>Pipeline \u56e0\u5b50\u7814\u7a76\uff1a\u5f9e\u5167\u5efa\u56e0\u5b50\u4ecb\u7d39\u5230\u5ba2\u88fd\u5316\u56e0\u5b50 (Custom Factor) \u958b\u767c\uff0c\u5305\u542b\u6ffe\u7db2 (Filter) \u8207\u906e\u7f69 (Mask) \u7684\u9032\u968e\u61c9\u7528\u3002</li> <li>\u7e3e\u6548\u5206\u6790\uff1a\u56de\u6e2c\u7d50\u679c\u8996\u89ba\u5316\u8207 Pyfolio \u7e3e\u6548\u6307\u6a19\u89e3\u8b80\u3002</li> </ol> </li> </ul> </li> <li> <p>TEJ \u77e5\u8b58\u91d1\u878d\u5b78\u9662\uff5cTQuant Lab \u91cf\u5316\u6295\u8cc7\u5be6\u6230 (\u9032\u968e\u8ab2\u7a0b)</p> <ul> <li>\u7531\u6dfa\u5165\u6df1\u3001\u7cfb\u7d71\u5316\u62c6\u89e3\u91cf\u5316\u4ea4\u6613\u67b6\u69cb\uff0c\u7e3d\u6642\u9577\u8d85\u904e 2 \u5c0f\u6642\u7684\u5b8c\u6574\u5be6\u6230\u8ab2\u7a0b\u3002\u5167\u5bb9\u5305\u542b\uff1a<ol> <li>\u74b0\u5883\u90e8\u7f72 (Environment)\uff1a\u5229\u7528 Docker \u6280\u8853\u5feb\u901f\u90e8\u7f72\u8de8\u5e73\u53f0\u91cf\u5316\u5be6\u9a57\u5ba4\uff0c\u7701\u53bb\u7e41\u7463\u8a2d\u5b9a\u3002</li> <li>\u6578\u64da\u7ba1\u7406 (Data)\uff1a\u638c\u63e1 TEJ \u7368\u5bb6\u8cc7\u6599\u5eab\u4e32\u63a5\u6280\u5de7\uff0c\u6db5\u84cb\u50f9\u91cf\u3001\u8ca1\u5831\u3001\u6708\u71df\u6536\u8207\u6cd5\u4eba\u7c4c\u78bc\u7b49\u9ad8\u542b\u91d1\u91cf\u6578\u64da\u3002</li> <li>\u6838\u5fc3\u5143\u4ef6 (Core Components)\uff1a\u6df1\u5165\u89e3\u6790 Zipline \u6846\u67b6\uff0c\u5305\u542b\u6ed1\u50f9\u8207\u624b\u7e8c\u8cbb\u8a2d\u5b9a\u3001Pipeline \u56e0\u5b50\u5efa\u69cb\u53ca\u6ffe\u5668\u61c9\u7528\uff0c\u8b93\u56de\u6e2c\u66f4\u8cbc\u8fd1\u771f\u5be6\u5e02\u5834\u3002</li> <li>\u7b56\u7565\u5be6\u6230 (Strategy)\uff1a\u624b\u628a\u624b\u5e36\u60a8\u5be6\u4f5c\u300c\u6280\u8853\u9762\u9ec3\u91d1\u4ea4\u53c9\u300d\u8207\u300c\u57fa\u672c\u9762\u50f9\u503c\u9078\u80a1\u300d\u5169\u5927\u7d93\u5178\u7b56\u7565\uff0c\u5b8c\u6574\u9ad4\u9a57\u5f9e\u908f\u8f2f\u64b0\u5beb\u5230\u56de\u6e2c\u9a57\u8b49\u7684\u5168\u6d41\u7a0b\u3002</li> </ol> </li> </ul> </li> </ul>"},{"location":"#_3","title":"\u76f8\u95dc\u9023\u7d50","text":"<ul> <li>TQuant Lab\uff5c\u4e00\u7ad9\u5f0f\u91cf\u5316\u7814\u7a76\uff0c\u6253\u9020\u5c08\u5c6c\u65bc\u4f60\u7684\u6295\u8cc7\u7814\u7a76\u91d1\u9470 </li> <li>GitHub - tejtw/TQuant-Lab: \u4f7f\u7528\u6587\u4ef6\u3001\u7a0b\u5f0f\u7bc4\u4f8b </li> <li>PYPI - zipline-tej </li> <li>TEJ\u5b98\u7db2 - \u5927\u4e2d\u83ef\u6700\u503c\u5f97\u4fe1\u8cf4\u7684\u91d1\u878d\u89e3\u6c7a\u65b9\u6848 | TEJ\u53f0\u7063\u7d93\u6fdf\u65b0\u5831 </li> <li>TQuant Lab \u8a02\u95b1\u9023\u7d50</li> </ul>"},{"location":"release-notes/","title":"\u7248\u672c\u66f4\u65b0\u7d00\u9304","text":"<p>\u7248\u672c\u8cc7\u8a0a</p> <ul> <li>\u7248\u672c\u865f\uff1av2.3.0</li> <li>\u767c\u5e03\u65e5\u671f\uff1a2024-02-03</li> <li>\u672c\u6b21\u66f4\u65b0\u91cd\u9ede\uff1a\u5168\u65b0\u300c\u7b56\u7565\u7a4d\u6728\u300d\u677f\u584a\u4e0a\u7dda\u3001\u74b0\u5883\u5efa\u7f6e\u6559\u5b78\u64f4\u5145\u3001Pyfolio \u7e3e\u6548\u6307\u6a19\u91cd\u5beb\u3002</li> </ul>"},{"location":"release-notes/#strategy-blocks","title":"\ud83d\udd25 \u91cd\u5927\u66f4\u65b0\uff1a\u7b56\u7565\u7a4d\u6728\u5c08\u5340 (Strategy Blocks)","text":"<p>\u70ba\u4e86\u5354\u52a9\u4f7f\u7528\u8005\u8de8\u8d8a\u300c\u5f9e\u60f3\u6cd5\u5230\u7a0b\u5f0f\u78bc\u300d\u7684\u9d3b\u6e9d\uff0c\u672c\u6b21\u66f4\u65b0\u6b63\u5f0f\u63a8\u51fa \u7b56\u7565\u7a4d\u6728\u5c08\u5340\u3002\u6b64\u5c08\u5340\u63d0\u4f9b\u6a21\u7d44\u5316\u7684\u958b\u767c\u67b6\u69cb\uff0c\u76ee\u6a19\u5c07\u7b56\u7565\u958b\u767c\u6642\u9593\u5f9e 3 \u5929\u5927\u5e45\u7e2e\u77ed\u81f3 3 \u5c0f\u6642\u3002</p> <p>\u672c\u6b21\u65b0\u589e\u5171 20 \u4efd \u6280\u8853\u6587\u4ef6\u8207 9 \u500b \u5b8c\u6574\u5be6\u6230\u6848\u4f8b\uff0c\u6db5\u84cb\u4e09\u5927\u6838\u5fc3\u67b6\u69cb\uff1a</p>"},{"location":"release-notes/#1","title":"1. \u4e09\u5927\u7b56\u7565\u67b6\u69cb","text":"\u67b6\u69cb\u5206\u985e \u9069\u7528\u5834\u666f \u65b0\u589e\u5167\u5bb9 A. \u8ca1\u5831\u9078\u80a1 \u76e4\u5916\u9810\u9078\u3001\u57fa\u672c\u9762\u9577\u7dda\u6295\u8cc7 \u2022 \u5305\u542b \u591a\u56e0\u5b50\u9078\u80a1\u3001\u5c0f\u578b\u6210\u9577\u80a1\u3001Dreman \u9006\u5411\u6295\u8cc7 \u7b49 3 \u500b\u5b8c\u6574\u6848\u4f8b\u3002\u2022 \u63d0\u4f9b\u4ea4\u96c6\u6cd5\u3001\u8a55\u5206\u6cd5\u3001\u6392\u5e8f\u6cd5\u4e09\u7a2e\u958b\u767c\u6a21\u677f\u3002 B. \u6280\u8853\u6307\u6a19 \u76e4\u4e2d\u5373\u6642\u904b\u7b97\u3001\u6280\u8853\u5206\u6790 \u2022 \u5305\u542b MACD \u96d9\u7dda\u4ea4\u53c9\u3001\u4e56\u96e2\u7387\u5747\u503c\u56de\u6b78\u3001\u5e03\u6797\u901a\u9053\u7a81\u7834 \u7b49 3 \u500b\u5b8c\u6574\u6848\u4f8b\u3002\u2022 \u6df1\u5165\u89e3\u6790 Loop vs Pipeline \u7684\u6548\u80fd\u5dee\u7570\u3002 C. Pipeline \u5168\u5e02\u5834\u6383\u63cf\u3001\u56e0\u5b50\u6316\u6398 \u2022 \u5305\u542b \u52d5\u91cf\u56e0\u5b50\u3001\u5927\u6236\u7c4c\u78bc\u5206\u6790\u3001\u77ed\u7dda\u9006\u52e2\u7b56\u7565 \u7b49 3 \u500b\u5b8c\u6574\u6848\u4f8b\u3002\u2022 \u5c08\u6ce8\u65bc\u5411\u91cf\u5316\u8a08\u7b97\u8207\u5927\u898f\u6a21\u80a1\u7968\u6c60\u7be9\u9078\u3002"},{"location":"release-notes/#2","title":"2. \u6a19\u6e96\u5316\u6587\u4ef6\u7d50\u69cb","text":"<p>\u6240\u6709\u7b56\u7565\u6848\u4f8b\u5747\u63a1\u7528\u7d71\u4e00\u7684\u4e03\u6bb5\u5f0f\u7d50\u69cb\uff0c\u5305\u542b\uff1a</p> <ul> <li>\u5b8c\u6574\u7a0b\u5f0f\u78bc (Copy-Paste Ready)\uff1a\u8907\u88fd\u8cbc\u4e0a\u5373\u53ef\u57f7\u884c\u3002</li> <li>\u512a\u5316\u65b9\u5411\uff1a\u6bcf\u500b\u6848\u4f8b\u63d0\u4f9b 5 \u500b\u5177\u9ad4\u7684\u53c3\u6578\u6216\u908f\u8f2f\u8abf\u6574\u5efa\u8b70\u3002</li> <li>\u6307\u6a19\u8a73\u89e3\uff1a\u6578\u5b78\u516c\u5f0f\u8207\u8a08\u7b97\u6b65\u9a5f\u5716\u89e3\uff0c\u907f\u514d \u908f\u8f2f\u9ed1\u7bb1\u3002</li> </ul>"},{"location":"release-notes/#_2","title":"\ud83d\udcdd \u6587\u4ef6\u512a\u5316\u8207\u4fee\u6b63","text":"<p>\u9664\u4e86\u65b0\u529f\u80fd\u4e0a\u7dda\uff0c\u6211\u5011\u4e5f\u6839\u64da\u793e\u7fa4\u53cd\u994b\uff0c\u91dd\u5c0d\u73fe\u6709\u6559\u5b78\u6587\u4ef6\u9032\u884c\u4e86\u5927\u5e45\u5ea6\u7684\u512a\u5316\u8207\u52d8\u8aa4\u3002</p>"},{"location":"release-notes/#tutorials","title":"\ud83d\ude80 \u65b0\u624b\u4e0a\u8def (Tutorials)","text":""},{"location":"release-notes/#_3","title":"\u74b0\u5883\u8a2d\u7f6e","text":"<ul> <li>New 1.3.1 \u9032\u968e\u958b\u767c\u74b0\u5883\uff1a\u65b0\u589e\u4f7f\u7528 VS Code Remote - Containers \u9023\u7dda Docker \u7684\u6559\u5b78\uff0c\u63d0\u4f9b\u66f4\u6d41\u66a2\u7684\u958b\u767c\u9ad4\u9a57\u3002</li> <li>New 1.6 \u5e38\u898b\u554f\u984c\u6392\u9664\uff1a\u65b0\u589e Docker \u74b0\u5883\u5e38\u898b\u932f\u8aa4\u8207\u6392\u9664\u6307\u5357\u3002</li> </ul>"},{"location":"release-notes/#10-tquant-lab","title":"10 \u5206\u9418\u9ad4\u9a57 TQuant Lab","text":"<ul> <li>Update \u4e92\u52d5\u5f0f\u7bc4\u4f8b\uff1a\u65bc\u9801\u9762\u9802\u90e8\u65b0\u589e GitHub Notebook \u9023\u7d50\uff0c\u65b9\u4fbf\u8b80\u8005\u4e0b\u8f09\u4e26\u8ddf\u96a8\u64cd\u4f5c\u3002</li> <li>Update \u6307\u4ee4\u8a73\u89e3\uff1a\u88dc\u5145 <code>!zipline ingest</code> \u4e2d\u9a5a\u5606\u865f <code>!</code> \u7684\u542b\u7fa9\uff08Jupyter Magic Command\uff09\uff0c\u5e6b\u52a9\u65b0\u624b\u7406\u89e3\u57f7\u884c\u74b0\u5883\u5dee\u7570\u3002</li> <li>Fix \u7a0b\u5f0f\u78bc\u4fee\u6b63\uff1a\u65bc <code>run_algorithm()</code> \u51fd\u6578\u4e2d\u88dc\u5145 <code>get_calendar('TEJ')</code>\uff0c\u78ba\u4fdd\u56de\u6e2c\u65e5\u66c6\u6b63\u78ba\u8f09\u5165\u3002</li> </ul>"},{"location":"release-notes/#_4","title":"\u4f60\u7684\u7b2c\u4e00\u500b\u73fe\u8ca8\u7b56\u7565","text":"<ul> <li>Update \u4e92\u52d5\u5f0f\u7bc4\u4f8b\uff1a\u65bc\u9801\u9762\u9802\u90e8\u65b0\u589e GitHub Notebook \u9023\u7d50\u3002</li> <li>Fix API \u4fee\u6b63\uff1a\u4fee\u6b63 <code>run_algorithm()</code> \u4e2d <code>get_calendar('TEJ')</code> \u7684\u4f7f\u7528\u65b9\u5f0f\uff0c\u89e3\u6c7a\u539f\u7248\u7a0b\u5f0f\u78bc\u7121\u6cd5\u904b\u884c\u7684\u554f\u984c\u3002</li> </ul>"},{"location":"release-notes/#core-concepts","title":"\ud83d\udcda \u6838\u5fc3\u6982\u5ff5 (Core Concepts)","text":""},{"location":"release-notes/#zipline","title":"Zipline \u5f15\u64ce","text":"<ul> <li>Style \u6d41\u7a0b\u5716\u512a\u5316\uff1a\u4fee\u6539\u300c\u4e8b\u4ef6\u9a45\u52d5\u6a21\u578b\u300d\u7684 Mermaid \u6d41\u7a0b\u5716\u6a23\u5f0f\uff0c\u89e3\u6c7a\u5728\u6df1\u8272/\u6dfa\u8272\u4e3b\u984c\u4e0b\u6587\u5b57\u95b1\u8b80\u4e0d\u6e05\u7684\u554f\u984c\u3002</li> </ul>"},{"location":"release-notes/#pyfolio","title":"Pyfolio \u7e3e\u6548\u5206\u6790","text":"<ul> <li>Update \u5167\u5bb9\u91cd\u5beb\uff1a\u5927\u5e45\u6539\u5beb\u300c\u7e3e\u6548\u6307\u6a19\u8a73\u89e3\u300d\u9801\u9762\uff0c\u63d0\u4f9b\u66f4\u8a73\u7d30\u7684\u6307\u6a19\u5b9a\u7fa9\u3001\u8a08\u7b97\u516c\u5f0f\u8207\u89e3\u8b80\u65b9\u5f0f\uff0c\u5e6b\u52a9\u4f7f\u7528\u8005\u6df1\u5165\u8a55\u4f30\u7b56\u7565\u597d\u58de\u3002</li> </ul>"},{"location":"release-notes/#homepage","title":"\ud83c\udfe0 \u9996\u9801 (Homepage)","text":"<ul> <li>New \u5c0e\u822a\u66f4\u65b0\uff1a\u65b0\u589e\u5c0e\u5411\u300c\u7b56\u7565\u7a4d\u6728\u5c08\u5340\u300d\u7684\u5feb\u901f\u9023\u7d50\u3002# \u7248\u672c\u66f4\u65b0\u7d00\u9304</li> </ul>"},{"location":"blocks/Frameworks_Overview/","title":"\u91cf\u5316\u958b\u767c\u4e09\u5927\u67b6\u69cb\u6982\u89bd (Framework Overview)","text":"<p>\u672c\u9801\u9762\u63d0\u4f9b\u4e09\u5927\u67b6\u69cb\u7684\u9ad8\u968e\u8cc7\u6599\u6d41\u5411\u5716\u3002\u8acb\u4f9d\u64da\u4f60\u7684\u7b56\u7565\u5c6c\u6027\u9078\u64c7\u6700\u9069\u5408\u7684\u8def\u7dda\u3002</p>"},{"location":"blocks/Frameworks_Overview/#_1","title":"\ud83d\uddfa\ufe0f \u6c7a\u7b56\u8def\u5f91\u5716","text":"<pre><code>graph TD\n    Start((\u958b\u59cb\u65b0\u7b56\u7565)) --&gt; Q1{\u7b56\u7565\u985e\u578b?}\n\n    Q1 -- \u57fa\u672c\u9762/\u8ca1\u5831\u9078\u80a1 --&gt; ArchA[\u8ca1\u5831\u9078\u80a1\u67b6\u69cbDataFrame Approach]\n    Q1 -- \u6280\u8853\u6307\u6a19/\u55ae\u4e00\u500b\u80a1 --&gt; ArchB[\u6280\u8853\u6307\u6a19\u67b6\u69cbLoop Approach]\n    Q1 -- \u5168\u5e02\u5834\u6383\u63cf/\u7c4c\u78bc\u56e0\u5b50 --&gt; ArchC[Pipeline\u56e0\u5b50\u67b6\u69cbPipeline Approach]\n\n    ArchA --&gt; ExA[\u7bc4\u4f8b: \u591a\u56e0\u5b50\u9078\u80a1Dreman\u9006\u5411\u6295\u8cc7]\n    ArchB --&gt; ExB[\u7bc4\u4f8b: MACD\u5e03\u6797\u901a\u9053]\n    ArchC --&gt; ExC[\u7bc4\u4f8b: Momentum\u8ddf\u96a8\u5927\u6236]\n\n    style ArchA fill:#e3f2fd,stroke:#1976d2,stroke-width:3px\n    style ArchB fill:#fff3e0,stroke:#f57c00,stroke-width:3px\n    style ArchC fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px</code></pre>"},{"location":"blocks/Frameworks_Overview/#_2","title":"\ud83d\udcca \u67b6\u69cb\u6027\u80fd\u5c0d\u6bd4\u8868","text":"\u7279\u6027 \u8ca1\u5831\u9078\u80a1\u67b6\u69cb \u6280\u8853\u6307\u6a19\u67b6\u69cb Pipeline\u56e0\u5b50\u67b6\u69cb \u9069\u7528\u80a1\u7968\u6578 50-200\u6a94 1-10\u6a94 500-2000\u6a94 \u904b\u7b97\u901f\u5ea6 \ud83d\udfe2 \u5feb \ud83d\udfe1 \u4e2d \ud83d\udfe2 \u5feb \u958b\u767c\u96e3\u5ea6 \ud83d\udfe2 \u6613 \ud83d\udfe2 \u6613 \ud83d\udd34 \u96e3 \u5f48\u6027 \ud83d\udfe1 \u4e2d \ud83d\udfe2 \u9ad8 \ud83d\udd34 \u4f4e \u8a18\u61b6\u9ad4\u9700\u6c42 \ud83d\udfe2 \u4f4e \ud83d\udfe2 \u4f4e \ud83d\udd34 \u9ad8 \u5178\u578b\u8abf\u5009\u983b\u7387 \u5b63\u5ea6/\u6708\u5ea6 \u6bcf\u65e5 \u6bcf\u65e5/\u6bcf\u6708"},{"location":"blocks/Frameworks_Overview/#a-dataframe-approach","title":"\ud83c\udfd7\ufe0f \u67b6\u69cb A\uff1a\u8ca1\u5831\u9078\u80a1\u67b6\u69cb (DataFrame Approach)","text":"<p>\u6838\u5fc3\u6982\u5ff5\uff1a \u5148\u5728 Python/DataFrame \u628a\u540d\u55ae\u7b97\u597d\uff0c\u56de\u6e2c\u53ea\u662f\u300c\u7167\u8868\u64cd\u8ab2\u300d\u3002 \u95dc\u9375\u51fd\u6578\uff1a <code>compute_stock(date, data)</code> <pre><code>graph TD\n    subgraph Prep [\u4e8b\u524d\u6e96\u5099 Pre-Backtest]\n    A1[\u8a2d\u5b9a\u80a1\u7968\u6c60 &amp; API Key] --&gt; A2[TejToolAPI.get_history_data\u6293\u53d6\u5b8c\u6574\u8ca1\u5831\u6578\u64da]\n    A2 --&gt; A3[compute_stock \u51fd\u6578\u904b\u7b97\u9078\u80a1\u908f\u8f2f]\n    A3 --&gt; A4[\u7522\u51fa\u975c\u614b Ticker List\u5305\u542b\u6bcf\u671f\u65e5\u671f]\n    A4 --&gt; A5[\u8a08\u7b97\u63db\u80a1\u65e5 modified_day\u901a\u5e38\u70ba\u5b63\u5ea6\u672b]\n    end\n\n    subgraph Run [\u56de\u6e2c\u57f7\u884c Run Backtest]\n    A5 --&gt; B1[simple_ingest\u532f\u5165\u50f9\u91cf\u8cc7\u6599]\n    B1 --&gt; B2[zipline.run_algorithm\u555f\u52d5\u56de\u6e2c\u5f15\u64ce]\n    B2 --&gt; B3{handle_data \u6bcf\u65e5\u6aa2\u67e5:\u662f\u63db\u80a1\u65e5?}\n    B3 -- Yes --&gt; B4[context.state = True\u6a19\u8a18\u9694\u65e5\u63db\u80a1]\n    B3 -- No --&gt; B5[\u6301\u6709\u4e0d\u52d5 Hold]\n    B4 --&gt; B6[\u9694\u65e5\u76e4\u4e2dorder_target_percent\u7b49\u6b0a\u91cd\u8abf\u5009]\n    end\n\n    style Prep fill:#e3f2fd,stroke:#1976d2,stroke-width:2px\n    style Run fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    style A3 fill:#ffccbc,stroke:#d84315,stroke-width:2px\n    style B6 fill:#ffccbc,stroke:#d84315,stroke-width:2px</code></pre></p> <p>\ud83d\udccc \u95dc\u9375\u7279\u5fb5\uff1a</p> <ul> <li>\u2705 \u907f\u514d\u524d\u8996\u504f\u5dee\uff1a\u4f7f\u7528 <code>context.state</code> \u5ef6\u9072\u5230\u9694\u65e5\u4e0b\u55ae</li> <li>\u2705 \u6578\u64da\u900f\u660e\uff1a\u6240\u6709\u7be9\u9078\u908f\u8f2f\u90fd\u5728 <code>compute_stock()</code> \u4e2d</li> <li>\u274c \u4e0d\u9069\u5408\u9ad8\u983b\uff1a\u91cd\u65b0\u904b\u7b97\u6210\u672c\u9ad8</li> </ul>"},{"location":"blocks/Frameworks_Overview/#b-loop-approach","title":"\u26a1 \u67b6\u69cb B\uff1a\u6280\u8853\u6307\u6a19\u67b6\u69cb (Loop Approach)","text":"<p>\u6838\u5fc3\u6982\u5ff5\uff1a \u5728\u56de\u6e2c\u7684\u6bcf\u4e00\u5929\uff0c\u5373\u6642\u6293\u904e\u53bb K \u7dda\u4f86\u7b97\u6307\u6a19\u3002 \u95dc\u9375\u51fd\u6578\uff1a <code>handle_data(context, data)</code> <pre><code>graph TD\n    subgraph Prep [\u4e8b\u524d\u6e96\u5099]\n    C1[\u8a2d\u5b9a\u6a19\u7684\u6e05\u55ae StockList\u901a\u5e38 1-10 \u6a94] --&gt; C2[simple_ingest\u532f\u5165\u884c\u60c5\u8cc7\u6599]\n    end\n\n    subgraph Run [\u56de\u6e2c\u57f7\u884c]\n    C2 --&gt; D1[zipline.run_algorithm\u56de\u6e2c\u5f15\u64ce]\n    D1 --&gt; D2[handle_data\u6bcf\u65e5\u81ea\u52d5\u89f8\u767c]\n    D2 --&gt; D3[data.history \u51fd\u6578\u6293\u53d6\u6b77\u53f2 K \u7dda]\n    D3 --&gt; D4[\u5373\u6642\u8a08\u7b97\u6307\u6a19talib.MACD / EMA / \u6a19\u6e96\u5dee]\n    D4 --&gt; D5{\u8a0a\u865f\u5224\u65b7 Signal}\n    D5 -- Buy --&gt; D6[order_target \u8cb7\u5165]\n    D5 -- Sell --&gt; D7[order_target \u8ce3\u51fa]\n    D5 -- Hold --&gt; D8[\u4e0d\u52d5\u4f5c]\n    D6 &amp; D7 --&gt; D9[record \u51fd\u6578\u8a18\u9304\u8a0a\u865f\u8207\u50f9\u683c]\n    end\n\n    style Prep fill:#e3f2fd,stroke:#1976d2,stroke-width:2px\n    style Run fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    style D4 fill:#ffccbc,stroke:#d84315,stroke-width:2px\n    style D5 fill:#c5e1a5,stroke:#558b2f,stroke-width:2px</code></pre></p> <p>\ud83d\udccc \u95dc\u9375\u7279\u5fb5\uff1a</p> <ul> <li>\u2705 \u7c21\u55ae\u76f4\u89c0\uff1a\u908f\u8f2f\u8207\u50b3\u7d71\u56de\u6e2c\u4e00\u81f4</li> <li>\u2705 \u5f48\u6027\u9ad8\uff1a\u53ef\u96a8\u6642\u8abf\u6574\u53c3\u6578</li> <li>\u274c \u6548\u80fd\u74f6\u9838\uff1a\u5927\u91cf\u80a1\u7968\u6703\u5f88\u6162\uff08\u9700\u8981 loop\uff09</li> </ul>"},{"location":"blocks/Frameworks_Overview/#cpipeline-pipeline-approach","title":"\ud83d\ude80 \u67b6\u69cb C\uff1aPipeline \u56e0\u5b50\u67b6\u69cb (Pipeline Approach)","text":"<p>\u6838\u5fc3\u6982\u5ff5\uff1a \u4f7f\u7528 Zipline \u6838\u5fc3\u5f15\u64ce\uff0c\u8655\u7406\u5168\u5e02\u5834\u5927\u898f\u6a21\u904b\u7b97\u6700\u5feb\u3002 \u95dc\u9375\u51fd\u6578\uff1a <code>make_pipeline()</code>, <code>before_trading_start()</code> <pre><code>graph TD\n    subgraph Prep [\u4e8b\u524d\u6e96\u5099]\n    E1[\u5916\u90e8\u8cc7\u6599 CSV/API\u4f8b: \u7c4c\u78bc\u3001\u8ca1\u5831] --&gt; E2[Custom_loader \u51fd\u6578\u8f49\u63db\u6210 Zipline \u683c\u5f0f]\n    E2 --&gt; E3[CustomDataset + DataFrameLoader\u8a3b\u518a\u70ba Pipeline \u8cc7\u6599\u6e90]\n    E3 --&gt; E4[make_pipeline \u51fd\u6578\u5b9a\u7fa9\u56e0\u5b50\u8207\u6ffe\u7db2]\n    E4 --&gt; E5[CustomFactor.compute\u81ea\u5b9a\u7fa9\u904b\u7b97\u908f\u8f2f]\n    end\n\n    subgraph Run [\u56de\u6e2c\u57f7\u884c]\n    E5 --&gt; F1[zipline.run_algorithmcustom_loader=transform_data]\n    F1 --&gt; F2[before_trading_start\u76e4\u524d\u81ea\u52d5\u904b\u7b97]\n    F2 --&gt; F3[context.trades = pipeline_output\u53d6\u5f97\u7576\u65e5\u8a0a\u865f DataFrame]\n    F3 --&gt; F4[schedule_function\u6392\u7a0b\u4ea4\u6613\u51fd\u6578]\n    F4 --&gt; F5[rebalance_start / end\u6574\u6279\u4e0b\u55ae\u908f\u8f2f]\n    F5 --&gt; F6[order_target_value\u6309\u98a8\u96aa\u5206\u914d\u8cc7\u91d1]\n    end\n\n    style Prep fill:#e3f2fd,stroke:#1976d2,stroke-width:2px\n    style Run fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    style E3 fill:#ffccbc,stroke:#d84315,stroke-width:2px\n    style E5 fill:#ffccbc,stroke:#d84315,stroke-width:2px\n    style F3 fill:#c5e1a5,stroke:#558b2f,stroke-width:2px</code></pre></p> <p>\ud83d\udccc \u95dc\u9375\u7279\u5fb5\uff1a</p> <ul> <li>\u2705 \u6975\u81f4\u6548\u80fd\uff1a\u5168\u5e02\u5834 2000 \u6a94\u80a1\u7968\u4e5f\u80fd\u79d2\u7b97</li> <li>\u2705 \u907f\u514d\u524d\u8996\u504f\u5dee\uff1aPipeline \u5f15\u64ce\u81ea\u52d5\u8655\u7406</li> <li>\u274c \u5b78\u7fd2\u66f2\u7dda\u9661\u5ced\uff1a\u9700\u7406\u89e3 CustomFactor\u3001DataFrameLoader</li> <li>\u274c Debug \u56f0\u96e3\uff1a\u932f\u8aa4\u8a0a\u606f\u4e0d\u76f4\u89c0</li> </ul>"},{"location":"blocks/Frameworks_Overview/#_3","title":"\ud83d\udca1 \u5982\u4f55\u9078\u64c7\uff1f\u5feb\u901f\u6aa2\u67e5\u8868","text":"<pre><code>graph LR\n    A[\u4f60\u7684\u7b56\u7565] --&gt; B{\u80a1\u7968\u6578\u91cf?}\n    B -- &lt;10\u6a94 --&gt; C[\u6280\u8853\u6307\u6a19\u67b6\u69cb]\n    B -- 10-200\u6a94 --&gt; D{\u9700\u8981\u5916\u90e8\u6578\u64da?}\n    B -- &gt;200\u6a94 --&gt; E[Pipeline\u56e0\u5b50\u67b6\u69cb]\n\n    D -- \u9700\u8981\u8ca1\u5831 --&gt; F[\u8ca1\u5831\u9078\u80a1\u67b6\u69cb]\n    D -- \u53ea\u7528\u50f9\u91cf --&gt; C\n\n    style C fill:#fff3e0,stroke:#f57c00\n    style F fill:#e3f2fd,stroke:#1976d2\n    style E fill:#f3e5f5,stroke:#7b1fa2</code></pre> <p>\ud83d\udc49 Next Step: \u524d\u5f80\u5c0d\u61c9\u67b6\u69cb\u7684\u8a73\u7d30\u9801\u9762\uff0c\u8907\u88fd Code Template \u958b\u59cb\u958b\u767c\uff01</p>"},{"location":"blocks/Strategy_Blocks_Intro/","title":"\u6838\u5fc3\u7406\u5ff5\uff1a\u91cf\u5316\u7b56\u7565\u7a4d\u6728 (Strategy Blocks)","text":"<p>\"Stop reinventing the wheel. Start assembling the car.\" \u4e0d\u8981\u91cd\u8907\u9020\u8f2a\u5b50\uff0c\u958b\u59cb\u7d44\u88dd\u8dd1\u8eca\u3002</p>"},{"location":"blocks/Strategy_Blocks_Intro/#1-why","title":"1. Why? \u70ba\u4ec0\u9ebc\u6211\u5011\u9700\u8981\u300c\u7b56\u7565\u7a4d\u6728\u300d\uff1f","text":"<p>\u5728\u904e\u53bb\u7684\u958b\u767c\u7d93\u9a57\u4e2d\uff0c\u6211\u5011\u767c\u73fe\u5718\u968a\u6210\u54e1\u5728\u5beb\u7b56\u7565\u6642\uff0c\u5e38\u5e38\u9677\u5165 \u300c\u5f9e\u96f6\u958b\u59cb (From Scratch)\u300d \u7684\u6ce5\u6dd6\u3002</p> <p>\u6bcf\u6b21\u5beb\u65b0\u7b56\u7565\u90fd\u8981\u91cd\u65b0\u601d\u8003\uff1a</p> <ul> <li>\u8cc7\u6599\u600e\u9ebc\u6293\uff1f</li> <li>\u56de\u6e2c\u600e\u9ebc\u8a2d\uff1f</li> <li>\u4ea4\u6613\u600e\u9ebc\u57f7\u884c\uff1f</li> </ul> <p>\u9019\u4e0d\u50c5 \u6548\u7387\u4f4e\u843d\uff0c\u66f4\u5bb9\u6613\u7522\u751f\u91cd\u8907\u7684 Bug\u3002\u70ba\u4e86\u5be6\u73fe\u898f\u6a21\u5316\u7684\u91cf\u5316\u7814\u7a76\uff0c\u6211\u5011\u5c07\u904e\u53bb\u9a57\u8b49\u6210\u529f\u7684 9 \u652f\u7b56\u7565\uff0c\u89e3\u69cb\u70ba\u53ef\u91cd\u8907\u4f7f\u7528\u7684 \u300c\u6a19\u6e96\u5316\u7a4d\u6728\u300d\u3002</p>"},{"location":"blocks/Strategy_Blocks_Intro/#2-value-proposition","title":"2. Value Proposition\uff1a\u7a4d\u6728\u5316\u7684\u4e09\u5927\u597d\u8655","text":""},{"location":"blocks/Strategy_Blocks_Intro/#efficiency","title":"\ud83d\ude80 \u6975\u81f4\u6548\u7387 (Efficiency)","text":"<p>\u958b\u767c\u65b0\u7b56\u7565\u4e0d\u518d\u9700\u8981 3 \u5929\uff0c\u53ea\u9700\u8981 3 \u5c0f\u6642\u3002\u53ea\u9700\u66ff\u63db\u6838\u5fc3\u908f\u8f2f\u6a21\u584a\uff0c\u9aa8\u67b6\u76f4\u63a5\u5957\u7528\u3002</p>"},{"location":"blocks/Strategy_Blocks_Intro/#robustness","title":"\ud83d\udee1\ufe0f \u908f\u8f2f\u9632\u5446 (Robustness)","text":"<p>\u7d93\u904e\u58d3\u529b\u6e2c\u8a66\u7684\u6a19\u6e96\u67b6\u69cb\uff0c\u80fd\u907f\u514d\u5e38\u898b\u7684\u4f4e\u7d1a\u932f\u8aa4\uff1a</p> <ul> <li>\u5016\u5b58\u8005\u504f\u5dee (Survivorship Bias)</li> <li>\u524d\u8996\u504f\u5dee (Look-ahead Bias)</li> <li>\u8cc7\u6599\u6d29\u6f0f (Data Leakage)</li> </ul>"},{"location":"blocks/Strategy_Blocks_Intro/#common-language","title":"\ud83d\udcac \u5354\u4f5c\u8a9e\u8a00 (Common Language)","text":"<p>\u7576\u6240\u6709\u4eba\u90fd\u7528\u540c\u4e00\u5957\u67b6\u69cb\u6e9d\u901a\uff0c\u6e9d\u901a\u6210\u672c\u5c07\u5927\u5e45\u964d\u4f4e\u3002</p> <p>Scenario\uff1a\u300c\u6211\u7528 Pipeline\u56e0\u5b50\u67b6\u69cb\uff0cCustomDataset \u90a3\u908a\u602a\u602a\u7684...\u300d\uff08\u79d2\u61c2\uff09</p>"},{"location":"blocks/Strategy_Blocks_Intro/#3-sop","title":"3. SOP\uff1a\u5982\u4f55\u4f7f\u7528\u672c\u624b\u518a\uff1f","text":"<p>\u672c\u624b\u518a\u5c07\u91cf\u5316\u958b\u767c\u6b78\u7d0d\u70ba \u4e09\u5927\u67b6\u69cb\u3002\u5728\u958b\u59cb\u5beb Code \u4e4b\u524d\uff0c\u8acb\u5148\u9748\u9b42\u62f7\u554f\u81ea\u5df1\u4e00\u500b\u554f\u984c\uff1a</p> <p>\u300c\u6211\u7684\u7372\u5229\u908f\u8f2f\u662f\u57fa\u65bc\u8ca1\u5831\u9078\u80a1\uff1f\u9084\u662f\u6280\u8853\u6307\u6a19\uff1f\u9084\u662f\u5168\u5e02\u5834\u6383\u63cf\uff1f\u300d</p> <p>\u8acb\u6839\u64da\u4f60\u7684\u908f\u8f2f\uff0c\u9078\u64c7\u5c0d\u61c9\u7684\u67b6\u69cb\uff1a</p> \u4f60\u7684\u7b56\u7565\u908f\u8f2f \u63a8\u85a6\u67b6\u69cb \u9069\u7528\u5834\u666f \u4ee3\u8868\u7b56\u7565 \u9078\u80a1 / \u8ca1\u5831 <code>\u8ca1\u5831\u9078\u80a1\u67b6\u69cb</code> \u57fa\u672c\u9762\u5206\u6790\u3001\u5b63\u5831\u9078\u80a1 \u591a\u56e0\u5b50\u9078\u80a1\u3001Dreman\u9006\u5411\u6295\u8cc7 \u6280\u8853 / \u500b\u80a1 <code>\u6280\u8853\u6307\u6a19\u67b6\u69cb</code> \u6280\u8853\u6307\u6a19\u3001\u50f9\u91cf\u5206\u6790 MACD\u3001\u5e03\u6797\u901a\u9053 \u7c4c\u78bc / \u5168\u5e02\u5834 <code>Pipeline\u56e0\u5b50\u67b6\u69cb</code> \u7c4c\u78bc\u9762\u3001Market Scan Momentum\u3001\u8ddf\u96a8\u5927\u6236 <p>\ud83d\udc49 Next Step: \u9078\u5b9a\u67b6\u69cb\u5f8c\uff0c\u8acb\u76f4\u63a5\u8907\u88fd\u5c0d\u61c9\u9801\u9762\u7684 Code Template\uff0c\u586b\u5165\u4f60\u7684\u7368\u5bb6\u56e0\u5b50\uff0c\u5373\u53ef\u5b8c\u6210\u7b56\u7565\u958b\u767c\u3002</p>"},{"location":"blocks/Strategy_Blocks_Intro/#4-strategy-index","title":"4. \u7b56\u7565\u6848\u4f8b\u7d22\u5f15 (Strategy Index)","text":"<p>\u672c\u624b\u518a\u57fa\u65bc\u4ee5\u4e0b 9 \u500b\u5be6\u6230\u7b56\u7565\u89e3\u69cb\u800c\u6210\uff1a</p>"},{"location":"blocks/Strategy_Blocks_Intro/#3","title":"\ud83d\udcca \u8ca1\u5831\u9078\u80a1\u67b6\u69cb (3\u500b)","text":"<ol> <li>\u591a\u56e0\u5b50\u9078\u80a1 - \u672c\u76ca\u6bd4\u3001\u6d41\u52d5\u6bd4\u7387\u3001\u73fe\u91d1\u80a1\u5229\u7387\u7d44\u5408</li> <li>\u5c0f\u578b\u6210\u9577\u80a1 - \u5e02\u503c&lt;30% + \u6de8\u5229\u6210\u9577\u226515% + PEG&lt;1  </li> <li>Dreman\u9006\u5411\u6295\u8cc7 - \u5169\u968e\u6bb5\u7be9\u9078 + \u8a08\u5206\u5236</li> </ol>"},{"location":"blocks/Strategy_Blocks_Intro/#3_1","title":"\ud83d\udcc8 \u6280\u8853\u6307\u6a19\u67b6\u69cb (3\u500b)","text":"<ol> <li>MACD - \u5feb\u6162\u7dda\u4ea4\u53c9 + \u67f1\u72c0\u5716\u8f49\u6298</li> <li>\u4e56\u96e2\u7387 (BIAS) - 7\u65e5EMA\u504f\u96e2 + \u9ad8\u4f4e\u9ede\u7a81\u7834</li> <li>\u5e03\u6797\u901a\u9053 - 20\u65e5\u901a\u9053 + \u53cd\u8f49\u4ea4\u6613</li> </ol>"},{"location":"blocks/Strategy_Blocks_Intro/#pipeline-3","title":"\ud83d\udd2c Pipeline\u56e0\u5b50\u67b6\u69cb (3\u500b)","text":"<ol> <li>Expanded Momentum - \u8ff4\u6b78\u52d5\u80fd\u5206\u6578 + \u53cd\u5411\u6ce2\u52d5\u5ea6\u52a0\u6b0a</li> <li>\u8ddf\u96a8\u5927\u6236 - \u4e09\u5927\u6cd5\u4eba\u7c4c\u78bc + \u6301\u80a1\u7387\u5747\u7dda</li> <li>CounterTrend - \u8da8\u52e2\u904e\u6ffe + \u9006\u52e2\u8cb7\u8dcc</li> </ol>"},{"location":"blocks/fundamentals/","title":"\u67b6\u69cb A\uff1a\u8ca1\u5831\u9078\u80a1\u67b6\u69cb (Fundamental Selection Framework)","text":"<p>\u6838\u5fc3\u601d\u60f3\uff1a\u5148\u7b97\u51fa\u540d\u55ae\uff0c\u56de\u6e2c\u53ea\u662f\u57f7\u884c\u3002 \"Calculate the list first, backtest is just execution.\"</p>"},{"location":"blocks/fundamentals/#_1","title":"\ud83d\udccc \u6838\u5fc3\u6982\u5ff5","text":"<p>\u8ca1\u5831\u9078\u80a1\u67b6\u69cb\u7684\u672c\u8cea\u662f\u300c\u4e8b\u524d\u8a08\u7b97 + \u4e8b\u5f8c\u57f7\u884c\u300d\u7684\u5206\u96e2\u8a2d\u8a08\uff1a <pre><code>Step 1: \u5728\u56de\u6e2c\u5916\uff0c\u7528 DataFrame \u7b97\u51fa\u6bcf\u671f\u7684\u80a1\u7968\u540d\u55ae\nStep 2: \u5728\u56de\u6e2c\u5167\uff0c\u7167\u8868\u64cd\u8ab2\u57f7\u884c\u4ea4\u6613\n</code></pre></p> <p>\u9019\u7a2e\u67b6\u69cb\u6700\u7b26\u5408\u771f\u5be6\u6295\u8cc7\u7684\u601d\u8003\u908f\u8f2f\uff1a - \ud83d\udcca \u6708\u5e95\uff1a\u6253\u958b\u8ca1\u5831\u8cc7\u6599\u5eab\uff0c\u7be9\u9078\u51fa\u7b26\u5408\u689d\u4ef6\u7684\u80a1\u7968 - \ud83d\udcc5 \u9694\u6708\u521d\uff1a\u7167\u8457\u540d\u55ae\u4e0b\u55ae</p>"},{"location":"blocks/fundamentals/#_2","title":"\ud83c\udfaf \u9069\u7528\u5834\u666f","text":""},{"location":"blocks/fundamentals/#_3","title":"\u2705 \u6700\u9069\u5408\u7684\u60c5\u5883","text":"<ul> <li>\u57fa\u672c\u9762\u9078\u80a1\uff1a\u672c\u76ca\u6bd4\u3001ROE\u3001\u8ca0\u50b5\u6bd4\u7b49\u8ca1\u5831\u6307\u6a19</li> <li>\u5b63\u5ea6\u8abf\u5009\uff1a\u914d\u5408\u8ca1\u5831\u516c\u544a\u9031\u671f\uff083/6/9/12\u6708\uff09</li> <li>\u591a\u689d\u4ef6\u7be9\u9078\uff1a\u9700\u8981\u540c\u6642\u6aa2\u67e5 5+ \u500b\u8ca1\u52d9\u6307\u6a19</li> <li>\u4e2d\u7b49\u898f\u6a21\u80a1\u7968\u6c60\uff1a50-200 \u6a94\u80a1\u7968</li> </ul>"},{"location":"blocks/fundamentals/#_4","title":"\u274c \u4e0d\u9069\u5408\u7684\u60c5\u5883","text":"<ul> <li>\u274c \u65e5\u5167\u4ea4\u6613\u3001\u9ad8\u983b\u7b56\u7565</li> <li>\u274c \u7d14\u6280\u8853\u6307\u6a19\uff08MACD\u3001KD \u7b49\uff09</li> <li>\u274c \u9700\u8981\u5373\u6642\u904b\u7b97\u7684\u56e0\u5b50</li> <li>\u274c \u8d85\u5927\u898f\u6a21\u5e02\u5834\u6383\u63cf\uff08&gt;500 \u6a94\uff09</li> </ul>"},{"location":"blocks/fundamentals/#_5","title":"\ud83c\udfd7\ufe0f \u67b6\u69cb\u7279\u8272","text":""},{"location":"blocks/fundamentals/#_6","title":"\u6578\u64da\u6d41\u5411\u5716","text":"<pre><code>graph TD\n    subgraph Outside[\"\u2699\ufe0f \u56de\u6e2c\u5916\u904b\u7b97 (Pre-Backtest)\"]\n        A1[TejToolAPI.get_history_data&lt;br/&gt;\u6293\u53d6\u5b8c\u6574\u8ca1\u5831] --&gt; A2[compute_stock \u51fd\u6578&lt;br/&gt;\u904b\u7b97\u9078\u80a1\u908f\u8f2f]\n        A2 --&gt; A3[\u7522\u51fa Ticker List&lt;br/&gt;+ \u63db\u80a1\u65e5\u671f]\n    end\n\n    subgraph Inside[\"\ud83d\udd04 \u56de\u6e2c\u5167\u57f7\u884c (In-Backtest)\"]\n        A3 --&gt; B1[zipline.run_algorithm]\n        B1 --&gt; B2{handle_data&lt;br/&gt;\u6bcf\u65e5\u6aa2\u67e5}\n        B2 --&gt;|\u662f\u63db\u80a1\u65e5| B3[context.state = True]\n        B2 --&gt;|\u4e0d\u662f| B4[\u6301\u6709\u4e0d\u52d5]\n        B3 --&gt; B5[\u9694\u65e5\u57f7\u884c&lt;br/&gt;order_target_percent]\n    end\n\n    style Outside fill:#e3f2fd,stroke:#1976d2,stroke-width:2px\n    style Inside fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    style A2 fill:#ffccbc,stroke:#d84315,stroke-width:2px</code></pre>"},{"location":"blocks/fundamentals/#_7","title":"\u95dc\u9375\u8a2d\u8a08\u7406\u5ff5","text":""},{"location":"blocks/fundamentals/#1-look-ahead-bias","title":"1. \u907f\u514d\u524d\u8996\u504f\u5dee (Look-ahead Bias)","text":"<pre><code># \u274c \u932f\u8aa4\uff1a\u7576\u5929\u770b\u5230\u8a0a\u865f\u5c31\u4e0b\u55ae\nif date == rebalance_date:\n    order_target_percent(symbol, weight)\n\n# \u2705 \u6b63\u78ba\uff1a\u6a19\u8a18\u4eca\u5929\uff0c\u9694\u5929\u624d\u4e0b\u55ae\nif date == rebalance_date:\n    context.state = True  # \u6a19\u8a18\n    context.order_tickers = compute_stock(date)\n\nif context.state == True:  # \u9694\u5929\u57f7\u884c\n    for ticker in context.order_tickers:\n        order_target_percent(symbol(ticker), weight)\n</code></pre>"},{"location":"blocks/fundamentals/#2","title":"2. \u6578\u64da\u900f\u660e\u5316","text":"<p>\u6240\u6709\u7be9\u9078\u908f\u8f2f\u90fd\u5728 <code>compute_stock()</code> \u51fd\u6578\u4e2d\uff0c\u65b9\u4fbf\u6aa2\u67e5\u548c\u8abf\u8a66\uff1a <pre><code>def compute_stock(date, data):\n    df = data[data['\u65e5\u671f'] == date]\n\n    # \u689d\u4ef6 1: \u672c\u76ca\u6bd4 &lt; \u7522\u696d\u5e73\u5747\n    set_1 = set(df[df['\u672c\u76ca\u6bd4'] &lt; df['\u7522\u696d\u5e73\u5747\u672c\u76ca\u6bd4']]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # \u689d\u4ef6 2: \u8ca0\u50b5\u6bd4 &lt; 20%\n    set_2 = set(df[df['\u8ca0\u50b5\u6bd4'] &lt; 0.2]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # \u53d6\u4ea4\u96c6\n    return list(set_1 &amp; set_2)\n</code></pre></p>"},{"location":"blocks/fundamentals/#3","title":"3. \u9748\u6d3b\u7684\u63db\u80a1\u9031\u671f","text":"<pre><code># \u65b9\u6cd5 1: \u56fa\u5b9a\u65e5\u671f\uff08\u6bcf\u5b63\u6700\u5f8c\u4e00\u5929\uff09\nmodified_day = ['2023-03-31', '2023-06-30', '2023-09-30', '2023-12-31']\n\n# \u65b9\u6cd5 2: \u52d5\u614b\u8a08\u7b97\uff08TEJ \u4ea4\u6613\u65e5\u66c6\uff09\ntrade_days = tejapi.get('TWN/TRADEDAY_TWSE', ...)\nlast_days = trade_days.groupby(['year', 'quarter'])['date'].max()\n</code></pre>"},{"location":"blocks/fundamentals/#_8","title":"\ud83d\udcca \u8207\u5176\u4ed6\u67b6\u69cb\u7684\u5dee\u7570","text":"\u7279\u6027 \u8ca1\u5831\u9078\u80a1\u67b6\u69cb \u6280\u8853\u6307\u6a19\u67b6\u69cb Pipeline \u67b6\u69cb \u904b\u7b97\u6642\u6a5f \u56de\u6e2c\u5916 \u56de\u6e2c\u5167\uff08\u6bcf\u65e5\uff09 \u56de\u6e2c\u5167\uff08\u76e4\u524d\uff09 \u6578\u64da\u4f86\u6e90 TEJ \u8ca1\u5831 API Zipline \u6b77\u53f2\u50f9\u683c CustomDataset \u9069\u7528\u80a1\u7968\u6578 50-200 1-10 500-2000 \u8abf\u5009\u983b\u7387 \u5b63\u5ea6/\u6708\u5ea6 \u6bcf\u65e5 \u6bcf\u65e5/\u6bcf\u9031 Debug \u96e3\u5ea6 \ud83d\udfe2 \u6613 \ud83d\udfe2 \u6613 \ud83d\udd34 \u96e3 \u57f7\u884c\u901f\u5ea6 \ud83d\udfe2 \u5feb \ud83d\udfe1 \u4e2d \ud83d\udfe2 \u6975\u5feb \u8a18\u61b6\u9ad4\u9700\u6c42 \ud83d\udfe2 \u4f4e \ud83d\udfe2 \u4f4e \ud83d\udd34 \u9ad8"},{"location":"blocks/fundamentals/#_9","title":"\ud83d\udca1 \u4f55\u6642\u9078\u64c7\u9019\u500b\u67b6\u69cb\uff1f","text":""},{"location":"blocks/fundamentals/#_10","title":"\u5feb\u901f\u5224\u65b7\u6aa2\u67e5\u8868","text":"<pre><code>graph TD\n    A[\u4f60\u7684\u7b56\u7565] --&gt; B{\u6578\u64da\u4f86\u81ea\u8ca1\u5831?}\n    B --&gt;|Yes| C{\u8abf\u5009\u983b\u7387?}\n    B --&gt;|No| X[\u8003\u616e\u6280\u8853\u6307\u6a19\u67b6\u69cb]\n\n    C --&gt;|\u5b63\u5ea6/\u6708\u5ea6| D[\u2705 \u8ca1\u5831\u9078\u80a1\u67b6\u69cb]\n    C --&gt;|\u6bcf\u65e5| E{\u80a1\u7968\u6578\u91cf?}\n\n    E --&gt;|&lt;50\u6a94| D\n    E --&gt;|&gt;50\u6a94| F[\u8003\u616e Pipeline \u67b6\u69cb]\n\n    style D fill:#c8e6c9,stroke:#388e3c,stroke-width:3px</code></pre>"},{"location":"blocks/fundamentals/#_11","title":"\u5178\u578b\u4f7f\u7528\u6848\u4f8b","text":"<ul> <li>\u2705 \u50f9\u503c\u6295\u8cc7\u7b56\u7565\uff08\u4f4e PB\u3001\u9ad8\u80a1\u606f\uff09</li> <li>\u2705 \u6210\u9577\u80a1\u7be9\u9078\uff08\u9ad8 ROE\u3001\u4f4e\u8ca0\u50b5\uff09</li> <li>\u2705 \u54c1\u8cea\u56e0\u5b50\u7d44\u5408\uff08\u6d41\u52d5\u6bd4\u7387\u3001\u6bdb\u5229\u7387\uff09</li> <li>\u2705 Dreman \u9006\u5411\u6295\u8cc7\u6cd5</li> </ul>"},{"location":"blocks/fundamentals/#_12","title":"\ud83c\udf93 \u5b78\u7fd2\u8def\u5f91","text":""},{"location":"blocks/fundamentals/#3_1","title":"\u65b0\u624b\u5165\u9580\uff083 \u6b65\u9a5f\uff09","text":"<ol> <li>\u95b1\u8b80\u6848\u4f8b\uff1a\u5148\u770b <code>case-multifactor.md</code>\uff0c\u7406\u89e3\u5b8c\u6574\u6d41\u7a0b</li> <li>\u8907\u88fd\u6a21\u677f\uff1a\u524d\u5f80 <code>template.md</code> \u8907\u88fd\u9aa8\u67b6</li> <li>\u586b\u5165\u908f\u8f2f\uff1a\u4fee\u6539 <code>compute_stock()</code> \u51fd\u6578</li> </ol>"},{"location":"blocks/fundamentals/#_13","title":"\u9032\u968e\u512a\u5316","text":"<ul> <li>\u52d5\u614b\u63db\u80a1\u65e5\u8a08\u7b97\uff08TEJ \u4ea4\u6613\u65e5\u66c6\uff09</li> <li>\u98a8\u96aa\u5e73\u50f9\u914d\u7f6e\uff08\u975e\u7b49\u6b0a\u91cd\uff09</li> <li>\u7522\u696d\u4e2d\u6027\u5316\u8655\u7406</li> </ul>"},{"location":"blocks/fundamentals/#_14","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6a21\u677f\u9801\u9762\uff1atemplate.md</li> <li>\u6848\u4f8b\u5b78\u7fd2\uff1a</li> <li>\u591a\u56e0\u5b50\u9078\u80a1 - \u7d93\u5178\u4e94\u56e0\u5b50\u7b56\u7565</li> <li>\u5c0f\u578b\u6210\u9577\u80a1 - \u5e02\u503c + \u6210\u9577\u56e0\u5b50</li> <li>Dreman \u9006\u5411\u6295\u8cc7 - \u8a08\u5206\u5236\u7be9\u9078</li> <li>\u5e38\u898b\u554f\u984c\uff1afaq.md</li> </ul>"},{"location":"blocks/fundamentals/#_15","title":"\u26a0\ufe0f \u5e38\u898b\u9677\u9631","text":""},{"location":"blocks/fundamentals/#1","title":"\u9677\u9631 1\uff1a\u5fd8\u8a18\u907f\u514d\u524d\u8996\u504f\u5dee","text":"<pre><code># \u274c \u932f\u8aa4\u793a\u7bc4\nif date in rebalance_dates:\n    tickers = compute_stock(date)\n    for t in tickers:\n        order_target_percent(symbol(t), 1/len(tickers))  # \u7576\u5929\u5c31\u4e0b\u55ae\uff01\n</code></pre>"},{"location":"blocks/fundamentals/#2_1","title":"\u9677\u9631 2\uff1a\u65e5\u671f\u5c0d\u4e0d\u4e0a","text":"<pre><code># \u8ca1\u5831\u65e5\u671f\u662f 2023-03-31\uff0c\u4f46\u5be6\u969b\u4ea4\u6613\u65e5\u662f 2023-04-03\n# \u9700\u8981\u78ba\u4fdd\u63db\u80a1\u65e5\u662f\u5be6\u969b\u4ea4\u6613\u65e5\n</code></pre>"},{"location":"blocks/fundamentals/#3_2","title":"\u9677\u9631 3\uff1a\u6578\u64da\u6642\u9593\u9ede\u932f\u8aa4","text":"<pre><code># \u5b63\u5831\u901a\u5e38\u5ef6\u9072 45 \u5929\u516c\u544a\n# 3/31 \u7684\u8ca1\u5831\u8981\u5230 5/15 \u624d\u80fd\u7528\n# \u9700\u8981\u52a0\u5165\u5ef6\u9072\u908f\u8f2f\n</code></pre> <p>\ud83d\udc49 Next Step: \u524d\u5f80 template.md \u958b\u59cb\u958b\u767c\u4f60\u7684\u7b56\u7565\uff01</p>"},{"location":"blocks/fundamentals/case-dreman/","title":"\u6848\u4f8b 3\uff1aDreman \u9006\u5411\u6295\u8cc7\u7b56\u7565","text":"<p>\u7b56\u7565\u985e\u578b\uff1a \u8ca1\u5831\u9078\u80a1\u67b6\u69cb - \u8a08\u5206\u6cd5 \u8abf\u5009\u983b\u7387\uff1a \u6bcf\u5b63\uff083/6/9/12 \u6708\u672b\uff09 \u80a1\u7968\u6c60\uff1a \u53f0\u7063\u4e0a\u5e02\uff08TSE\uff09\u666e\u901a\u80a1 \u56de\u6e2c\u671f\u9593\uff1a 2019-12-29 ~ 2025-09-30</p>"},{"location":"blocks/fundamentals/case-dreman/#_1","title":"\ud83d\udccc \u7b56\u7565\u6982\u8ff0","text":"<p>\u9019\u662f David Dreman \u9006\u5411\u6295\u8cc7\u54f2\u5b78\u7684\u91cf\u5316\u5be6\u4f5c\uff0c\u6838\u5fc3\u7406\u5ff5\u662f\uff1a</p> <p>\"Buy what others are selling, sell what others are buying.\" \u5728\u5e02\u5834\u904e\u5ea6\u60b2\u89c0\u6642\u8cb7\u5165\u88ab\u4f4e\u4f30\u7684\u512a\u8cea\u80a1\u7968\u3002</p>"},{"location":"blocks/fundamentals/case-dreman/#dreman","title":"Dreman \u6295\u8cc7\u54f2\u5b78","text":"<p>David Dreman \u8a8d\u70ba\u5e02\u5834\u7d93\u5e38\u904e\u5ea6\u53cd\u61c9\uff0c\u5c0e\u81f4\uff1a - \ud83d\udcc9 \u597d\u516c\u53f8\u56e0\u77ed\u671f\u5229\u7a7a\u88ab\u932f\u6bba - \ud83d\udcc8 \u5dee\u516c\u53f8\u56e0\u984c\u6750\u7092\u4f5c\u88ab\u9ad8\u4f30</p> <p>\u56e0\u6b64\uff0c \u9006\u5411\u6295\u8cc7\u8005 \u61c9\u8a72\uff1a</p> <ol> <li>\u5c0b\u627e \u88ab\u4f4e\u4f30\u7684\u512a\u8cea\u516c\u53f8\uff08\u4f4e\u672c\u76ca\u6bd4 + \u9ad8\u80a1\u606f\uff09</li> <li>\u78ba\u8a8d \u8ca1\u52d9\u5065\u5eb7\uff08\u6d41\u52d5\u6027\u3001\u7372\u5229\u80fd\u529b\uff09</li> <li>\u8010\u5fc3\u6301\u6709\uff0c\u7b49\u5f85\u5e02\u5834\u4fee\u6b63</li> </ol>"},{"location":"blocks/fundamentals/case-dreman/#_2","title":"\u7b56\u7565\u7279\u8272","text":"<ol> <li>\u5169\u968e\u6bb5\u7be9\u9078\uff1a\u6838\u5fc3\u689d\u4ef6\uff08\u9580\u6abb\uff09+ \u984d\u5916\u689d\u4ef6\uff08\u8a08\u5206\uff09</li> <li>\u7522\u696d\u4e2d\u6027\uff1a\u907f\u514d\u7279\u5b9a\u7522\u696d\u504f\u597d</li> <li>\u52d5\u614b\u964d\u7d1a\uff1a\u5e02\u5834\u6975\u7aef\u6642\u81ea\u52d5\u653e\u5bec\u6a19\u6e96</li> <li>\u9632\u79a6\u6027\u5f37\uff1a\u5f37\u8abf\u8ca1\u52d9\u5b89\u5168</li> </ol>"},{"location":"blocks/fundamentals/case-dreman/#_3","title":"\ud83c\udfaf \u9078\u80a1\u689d\u4ef6\u8a73\u89e3","text":""},{"location":"blocks/fundamentals/case-dreman/#_4","title":"\u968e\u6bb5\u4e00\uff1a\u6838\u5fc3\u689d\u4ef6\uff08\u5fc5\u9808\u901a\u904e\uff09","text":"<p>\u9019\u662f \u4e0d\u53ef\u59a5\u5354\u7684\u9580\u6abb \uff0c\u4e0d\u901a\u904e\u5c31\u76f4\u63a5\u6dd8\u6c70\u3002</p>"},{"location":"blocks/fundamentals/case-dreman/#1","title":"\u689d\u4ef6 1: \u5e02\u503c \u2265 \u5e02\u5834\u5e73\u5747","text":"<p><pre><code>avg_mktcap = df['\u500b\u80a1\u5e02\u503c_\u5143'].mean(skipna=True)\ncore_set_1 = set(df[df['\u500b\u80a1\u5e02\u503c_\u5143'] &gt;= avg_mktcap]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u908f\u8f2f\uff1a Dreman \u504f\u597d\u4e2d\u5927\u578b\u80a1\uff0c\u6d41\u52d5\u6027\u597d\u4e14\u8cc7\u8a0a\u900f\u660e\u3002</p>"},{"location":"blocks/fundamentals/case-dreman/#2-50","title":"\u689d\u4ef6 2: \u672c\u76ca\u6bd4 \u2264 50% \u5206\u4f4d\u6578","text":"<p><pre><code>df_valid_per = df[df['\u672c\u76ca\u6bd4'] &gt; 0]\nper_threshold = df_valid_per['\u672c\u76ca\u6bd4'].quantile(0.5)\ncore_set_2 = set(df[\n    (df['\u672c\u76ca\u6bd4'] &lt;= per_threshold) &amp; \n    (df['\u672c\u76ca\u6bd4'] &lt;= avg_per) &amp; \n    (df['\u672c\u76ca\u6bd4'] &gt; 0)\n]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u908f\u8f2f\uff1a  - \u672c\u76ca\u6bd4\u5fc5\u9808 &gt; 0\uff08\u6392\u9664\u8667\u640d\u516c\u53f8\uff09 - \u5fc5\u9808\u4f4e\u65bc\u4e2d\u4f4d\u6578\uff08\u76f8\u5c0d\u4fbf\u5b9c\uff09 - \u5fc5\u9808\u4f4e\u65bc\u5e02\u5834\u5e73\u5747\uff08\u7d55\u5c0d\u4fbf\u5b9c\uff09</p>"},{"location":"blocks/fundamentals/case-dreman/#3","title":"\u689d\u4ef6 3: \u80a1\u606f\u6536\u76ca\u7387 \u2265 \u5e02\u5834\u5e73\u5747","text":"<p><pre><code>avg_div_yield = df['\u80a1\u5229\u6b96\u5229\u7387'].mean(skipna=True)\ncore_set_3 = set(df[df['\u80a1\u5229\u6b96\u5229\u7387'] &gt;= avg_div_yield]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u908f\u8f2f\uff1a \u9ad8\u80a1\u606f\u4ee3\u8868\u516c\u53f8\u9858\u610f\u5206\u4eab\u76c8\u5229\uff0c\u4e14\u63d0\u4f9b\u4e0b\u6a94\u4fdd\u8b77\u3002 <pre><code>core_set = core_set_1 &amp; core_set_2 &amp; core_set_3  # \u53d6\u4ea4\u96c6\n</code></pre></p>"},{"location":"blocks/fundamentals/case-dreman/#_5","title":"\u968e\u6bb5\u4e8c\uff1a\u984d\u5916\u689d\u4ef6\uff08\u8a08\u5206\u5236\uff09","text":"<p>\u901a\u904e\u6838\u5fc3\u689d\u4ef6\u5f8c\uff0c\u6839\u64da\u4ee5\u4e0b 5 \u500b\u6307\u6a19\u8a08\u5206\uff0c \u81f3\u5c11 3 \u5206 \u624d\u5165\u9078\u3002</p>"},{"location":"blocks/fundamentals/case-dreman/#1-1","title":"\u6307\u6a19 1: \u6d41\u52d5\u6bd4\u7387 \u2265 \u5e02\u5834\u5e73\u5747\uff08+1 \u5206\uff09","text":"<p><pre><code>df['\u6d41\u52d5\u6bd4\u7387'] = df['\u6d41\u52d5\u8cc7\u7522_Q'] / df['\u6d41\u52d5\u8ca0\u50b5_Q']\navg_current_ratio = df['\u6d41\u52d5\u6bd4\u7387'].mean(skipna=True)\nscore_set_1 = set(df[df['\u6d41\u52d5\u6bd4\u7387'] &gt;= avg_current_ratio]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u610f\u7fa9\uff1a \u77ed\u671f\u511f\u50b5\u80fd\u529b\uff0c&gt; 1 \u4ee3\u8868\u8cc7\u7522\u8db3\u4ee5\u511f\u9084\u8ca0\u50b5\u3002</p>"},{"location":"blocks/fundamentals/case-dreman/#2-1","title":"\u6307\u6a19 2: \u8ca0\u50b5\u6de8\u503c\u6bd4 \u2264 \u5e02\u5834\u5e73\u5747\uff08+1 \u5206\uff09","text":"<p><pre><code>df['\u8ca0\u50b5\u6de8\u503c\u6bd4'] = df['\u8ca0\u50b5\u7e3d\u984d_Q'] / df['\u80a1\u6771\u6b0a\u76ca\u7e3d\u984d_Q']\navg_debt_equity = df['\u8ca0\u50b5\u6de8\u503c\u6bd4'].mean(skipna=True)\nscore_set_2 = set(df[df['\u8ca0\u50b5\u6de8\u503c\u6bd4'] &lt;= avg_debt_equity]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u610f\u7fa9\uff1a \u69d3\u687f\u7a0b\u5ea6\uff0c\u8d8a\u4f4e\u8d8a\u5b89\u5168\u3002</p>"},{"location":"blocks/fundamentals/case-dreman/#3-roe-1","title":"\u6307\u6a19 3: ROE \u2265 \u5e02\u5834\u5e73\u5747\uff08+1 \u5206\uff09","text":"<p><pre><code>valid_roe = df[df['ROE_A_\u7a05\u5f8c_Q'] &gt; 0]['ROE_A_\u7a05\u5f8c_Q']\navg_roe = valid_roe.mean() if len(valid_roe) &gt; 0 else 0\nscore_set_3 = set(df[(df['ROE_A_\u7a05\u5f8c_Q'] &gt; 0) &amp; (df['ROE_A_\u7a05\u5f8c_Q'] &gt;= avg_roe)]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u610f\u7fa9\uff1a \u80a1\u6771\u6b0a\u76ca\u5831\u916c\u7387\uff0c\u8861\u91cf\u7372\u5229\u6548\u7387\u3002</p>"},{"location":"blocks/fundamentals/case-dreman/#4-1","title":"\u6307\u6a19 4: \u7a05\u524d\u6de8\u5229\u7387 \u2265 \u5e02\u5834\u5e73\u5747\uff08+1 \u5206\uff09","text":"<p><pre><code>valid_profit_margin = df[df['\u7a05\u524d\u6de8\u5229\u7387_Q'] &gt; 0]['\u7a05\u524d\u6de8\u5229\u7387_Q']\navg_profit_margin = valid_profit_margin.mean() if len(valid_profit_margin) &gt; 0 else 0\nscore_set_4 = set(df[(df['\u7a05\u524d\u6de8\u5229\u7387_Q'] &gt; 0) &amp; (df['\u7a05\u524d\u6de8\u5229\u7387_Q'] &gt;= avg_profit_margin)]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u610f\u7fa9\uff1a \u71df\u904b\u6548\u7387\uff0c\u8cfa\u9322\u80fd\u529b\u3002</p>"},{"location":"blocks/fundamentals/case-dreman/#5-1","title":"\u6307\u6a19 5: \u76c8\u9918\u6210\u9577\u7387 \u2265 \u5e02\u5834\u5e73\u5747\uff08+1 \u5206\uff09","text":"<p><pre><code>avg_earnings_growth = df['\u7a05\u5f8c\u6de8\u5229\u6210\u9577\u7387_Q'].mean(skipna=True)\nscore_set_5 = set(df[df['\u7a05\u5f8c\u6de8\u5229\u6210\u9577\u7387_Q'] &gt;= avg_earnings_growth]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u610f\u7fa9\uff1a \u6210\u9577\u6027\uff0c\u907f\u514d\u50f9\u503c\u9677\u9631\u3002</p>"},{"location":"blocks/fundamentals/case-dreman/#_6","title":"\u8a08\u5206\u8207\u7be9\u9078\u908f\u8f2f","text":"<pre><code>min_extra_score = 3  # \u81f3\u5c11 3 \u5206\nselected_tickers = []\n\nfor ticker in core_set:\n    score = 0\n    if ticker in score_set_1: score += 1  # \u6d41\u52d5\u6bd4\u7387\n    if ticker in score_set_2: score += 1  # \u8ca0\u50b5\u6bd4\n    if ticker in score_set_3: score += 1  # ROE\n    if ticker in score_set_4: score += 1  # \u6de8\u5229\u7387\n    if ticker in score_set_5: score += 1  # \u76c8\u9918\u6210\u9577\n\n    if score &gt;= min_extra_score:\n        selected_tickers.append(ticker)\n</code></pre>"},{"location":"blocks/fundamentals/case-dreman/#_7","title":"\u52d5\u614b\u964d\u7d1a\u6a5f\u5236","text":"<p>\u5982\u679c\u6c92\u6709\u80a1\u7968\u9054\u5230 3 \u5206\uff0c\u81ea\u52d5\u964d\u81f3 2 \u5206\uff1a <pre><code>if len(selected_tickers) == 0:\n    fallback_score = 2\n    print(f\"\u964d\u7d1a\u81f3 {fallback_score} \u5206...\")\n    for ticker in core_set:\n        score = 0\n        # ... \u91cd\u65b0\u8a08\u5206 ...\n        if score &gt;= fallback_score:\n            selected_tickers.append(ticker)\n</code></pre></p> <p>\u70ba\u4ec0\u9ebc\u9700\u8981\u964d\u7d1a\uff1f - \u907f\u514d\u6975\u7aef\u5e02\u6cc1\u4e0b\u7121\u80a1\u7968\u53ef\u8cb7 - \u4fdd\u6301\u7b56\u7565\u6301\u7e8c\u904b\u4f5c - \u985e\u4f3c\u300c\u6b21\u512a\u89e3\u300d\u7684\u5bb9\u932f\u6a5f\u5236</p>"},{"location":"blocks/fundamentals/case-dreman/#_8","title":"\ud83d\udd11 \u57f7\u884c\u524d\u6e96\u5099\uff1a\u74b0\u5883\u8b8a\u6578\u8a2d\u5b9a","text":"<p>\u672c\u7bc4\u4f8b\u4f7f\u7528 <code>python-dotenv</code> \u5957\u4ef6\u4f86\u7ba1\u7406\u654f\u611f\u8cc7\u8a0a\uff08\u5982 API Key\uff09\uff0c\u907f\u514d\u5c07\u91d1\u9470\u76f4\u63a5\u5beb\u6b7b\u5728\u7a0b\u5f0f\u78bc\u4e2d\uff0c\u4ee5\u78ba\u4fdd\u8cc7\u8a0a\u5b89\u5168\u3002</p>"},{"location":"blocks/fundamentals/case-dreman/#1_1","title":"1. \u5b89\u88dd\u5957\u4ef6","text":"<p>\u82e5\u60a8\u5c1a\u672a\u5b89\u88dd\uff0c\u8acb\u5728notebook\u57f7\u884c\uff1a <pre><code>!pip install python-dotenv\n</code></pre></p>"},{"location":"blocks/fundamentals/case-dreman/#2","title":"2. \u5efa\u7acb\u8a2d\u5b9a\u6a94","text":"<p>\u8acb\u5728\u5c08\u6848\u7684\u6839\u76ee\u9304\u4e0b\u5efa\u7acb\u4e00\u500b\u540d\u70ba <code>.env</code> \u7684\u6a94\u6848\uff08\u6ce8\u610f\u958b\u982d\u6709\u9ede\uff09\uff0c\u4e26\u586b\u5165\u60a8\u7684 TEJ API \u8cc7\u8a0a\uff1a <pre><code># .env \u6a94\u6848\u5167\u5bb9(\u6ce8\u610f\u7b49\u865f\u65c1\u4e0d\u80fd\u6709\u7a7a\u683c)\nTEJAPI_KEY=\u4f60\u7684_TEJ_API_KEY\nTEJAPI_BASE=http://api.tej.com.tw\n</code></pre></p>"},{"location":"blocks/fundamentals/case-dreman/#3_1","title":"3. \u7a0b\u5f0f\u8b80\u53d6\u6a5f\u5236","text":"<p>\u7a0b\u5f0f\u78bc\u4e2d\u7684 <code>load_dotenv()</code> \u6703\u81ea\u52d5\u5c0b\u627e\u4e26\u8b80\u53d6 <code>.env</code> \u6a94\u6848\uff0c\u5c07\u5176\u5167\u5bb9\u8f09\u5165\u70ba\u74b0\u5883\u8b8a\u6578\uff0c\u63a5\u8457\u900f\u904e <code>os.getenv</code> \u53d6\u5f97\u4f7f\u7528\u3002</p>"},{"location":"blocks/fundamentals/case-dreman/#_9","title":"\ud83d\udcbb \u5b8c\u6574\u7a0b\u5f0f\u78bc","text":"<pre><code># ====================================\n# Dreman \u9006\u5411\u6295\u8cc7\u7b56\u7565 - \u5b8c\u6574\u5be6\u4f5c\n# ====================================\n\nimport os\nimport datetime\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport warnings\nfrom dotenv import load_dotenv\n\nload_dotenv()\nwarnings.filterwarnings('ignore')\n\n# ====================================\n# TEJ API \u8a2d\u5b9a\n# ====================================\nimport tejapi\n\ntejapi.ApiConfig.api_key = os.getenv('TEJAPI_KEY')\nos.environ['TEJAPI_KEY'] = os.getenv('TEJAPI_KEY')\ntejapi.ApiConfig.api_base = os.getenv('TEJAPI_BASE')\nos.environ['TEJAPI_BASE'] = os.getenv('TEJAPI_BASE')\n\n# \u4e2d\u6587\u986f\u793a\u8a2d\u5b9a\nplt.rcParams['font.sans-serif'] = ['Microsoft JhengHei', 'Arial', 'SourceHanSansTC-Regular.otf']\nplt.rcParams['axes.unicode_minus'] = False\n\n# ====================================\n# \u53c3\u6578\u8a2d\u5b9a\n# ====================================\nstart_date = '2019-12-29'\nend_date = '2025-09-30'\n\n# ====================================\n# \u80a1\u7968\u6c60\u8a2d\u5b9a\uff08\u50c5\u4e0a\u5e02\uff09\n# ====================================\nfrom zipline.sources.TEJ_Api_Data import get_universe\n\npool = get_universe(\n    start=pd.Timestamp(start_date, tz='utc'), \n    end=pd.Timestamp(end_date, tz='utc'), \n    mkt_bd_e=['TSE'],  # \u50c5\u4e0a\u5e02\n    stktp_e='Common Stock'\n)\n\nprint(f\"\u80a1\u7968\u6c60\u7e3d\u6578: {len(pool)} \u6a94\")\n\n# ====================================\n# \u8ca1\u5831\u6578\u64da\u4e0b\u8f09\n# ====================================\nimport TejToolAPI\n\ncolumns = [\n    'mktcap',   # \u5e02\u503c\n    'per',      # \u672c\u76ca\u6bd4\n    'div_yid',  # \u80a1\u606f\u6536\u76ca\u7387\n    'a0100',    # \u6d41\u52d5\u8cc7\u7522\n    'a1100',    # \u6d41\u52d5\u8ca0\u50b5\n    'a1000',    # \u7e3d\u8ca0\u50b5\n    'a2000',    # \u7e3d\u6b0a\u76ca\n    'r16a',     # \u80a1\u5229\u652f\u4ed8\u7387\n    'r103',     # ROE_A_\u7a05\u5f8c\n    'r107',     # \u7a05\u524d\u6de8\u5229\u7387\n    'eps',      # \u6bcf\u80a1\u76c8\u9918\n    'shares',   # \u6d41\u901a\u5728\u5916\u80a1\u6578\n    'r405'      # \u7a05\u5f8c\u6de8\u5229\u6210\u9577\u7387\n]\n\ndata__ = TejToolAPI.get_history_data(\n    start=pd.Timestamp(start_date, tz='UTC'), \n    end=pd.Timestamp(end_date, tz='UTC'), \n    ticker=pool, \n    fin_type='Q',  # \u5b63\u5831\n    columns=columns, \n    transfer_to_chinese=True,\n    include_self_acc='Y'\n)\n\nprint(f\"\u6578\u64da\u7b46\u6578: {len(data__):,}\")\nprint(f\"\u65e5\u671f\u7bc4\u570d: {data__['\u65e5\u671f'].min().date()} ~ {data__['\u65e5\u671f'].max().date()}\")\n\n# ====================================\n# \u63db\u80a1\u65e5\u671f\u8a08\u7b97\uff08TEJ \u4ea4\u6613\u65e5\u66c6\uff09\n# ====================================\ntrade_days = tejapi.get(\n    'TWN/TRADEDAY_TWSE',\n    zdate={'gte': start_date, 'lte': end_date},\n    tradeday_cno={'ne': 0}  # \u53ea\u6293\u53d6\u4ea4\u6613\u65e5\n)\n\ntrade_days['zdate'] = pd.to_datetime(trade_days['zdate'])\ntrade_days['year'] = trade_days['zdate'].dt.year\ntrade_days['month'] = trade_days['zdate'].dt.month\n\n# \u627e\u51fa\u6bcf\u5b63\u6700\u5f8c\u4ea4\u6613\u65e5\nrebalance_months = [3, 6, 9, 12]\nmodified_day = []\n\nfor month in rebalance_months:\n    month_data = trade_days[trade_days['month'] == month]\n    last_days = month_data.groupby('year')['zdate'].max()\n    modified_day.extend(last_days.tolist())\n\n# \u8f49\u63db\u70ba date \u683c\u5f0f\u4e26\u6392\u5e8f\nmodified_day = sorted([d.date() for d in modified_day])\n\nprint(f\"\u518d\u5e73\u8861\u6b21\u6578: {len(modified_day)}\")\nprint(f\"\u7bc4\u4f8b\u65e5\u671f: {modified_day[:8]}\")\n\n# ====================================\n# \u9078\u80a1\u51fd\u6578\n# ====================================\ndef compute_stock(date, data, verbose=True):\n    \"\"\"\n    Dreman \u9006\u5411\u6295\u8cc7\u9078\u80a1\u51fd\u6578\n\n    \u908f\u8f2f\uff1a\n    1. \u6838\u5fc3\u689d\u4ef6\uff1a\u5e02\u503c + \u4f4e\u672c\u76ca\u6bd4 + \u9ad8\u80a1\u606f\uff08\u5fc5\u9808\u901a\u904e\uff09\n    2. \u984d\u5916\u689d\u4ef6\uff1a\u6d41\u52d5\u6bd4\u7387\u3001\u8ca0\u50b5\u6bd4\u3001ROE\u3001\u5229\u6f64\u7387\u3001\u6210\u9577\u7387\uff08\u8a08\u5206\uff0c\u22653\u5206\uff09\n    3. \u52d5\u614b\u964d\u7d1a\uff1a\u82e5\u7121\u80a1\u7968\u5247\u964d\u81f3 2 \u5206\n\n    Parameters:\n    -----------\n    date : datetime.date\n        \u9078\u80a1\u65e5\u671f\n    data : pd.DataFrame\n        \u8ca1\u5831\u6578\u64da\n    verbose : bool\n        \u662f\u5426\u986f\u793a\u8a73\u7d30\u8a0a\u606f\n\n    Returns:\n    --------\n    list : \u5165\u9078\u80a1\u7968\u4ee3\u78bc\u5217\u8868\n    \"\"\"\n    df = data[data['\u65e5\u671f'] == pd.Timestamp(date)].reset_index(drop=True)\n\n    if len(df) == 0:\n        if verbose:\n            print(f\"\u8b66\u544a\uff1a{date} \u7121\u6578\u64da\")\n        return []\n\n    # ========================================\n    # \u8a08\u7b97\u884d\u751f\u6307\u6a19\n    # ========================================\n    df['\u6d41\u52d5\u6bd4\u7387'] = df['\u6d41\u52d5\u8cc7\u7522_Q'] / df['\u6d41\u52d5\u8ca0\u50b5_Q']\n    df['\u8ca0\u50b5\u6de8\u503c\u6bd4'] = df['\u8ca0\u50b5\u7e3d\u984d_Q'] / df['\u80a1\u6771\u6b0a\u76ca\u7e3d\u984d_Q']\n\n    # \u8a08\u7b97\u5e02\u5834\u5e73\u5747\u503c\n    avg_mktcap = df['\u500b\u80a1\u5e02\u503c_\u5143'].mean(skipna=True)\n    avg_per = df['\u672c\u76ca\u6bd4'].mean(skipna=True)\n    avg_div_yield = df['\u80a1\u5229\u6b96\u5229\u7387'].mean(skipna=True)\n    avg_current_ratio = df['\u6d41\u52d5\u6bd4\u7387'].mean(skipna=True)\n    avg_debt_equity = df['\u8ca0\u50b5\u6de8\u503c\u6bd4'].mean(skipna=True)\n\n    # ROE \u548c\u7a05\u524d\u6de8\u5229\u7387\uff1a\u53ea\u5c0d\u6b63\u503c\u8a08\u7b97\u5e73\u5747\n    valid_roe = df[df['ROE_A_\u7a05\u5f8c_Q'] &gt; 0]['ROE_A_\u7a05\u5f8c_Q']\n    avg_roe = valid_roe.mean() if len(valid_roe) &gt; 0 else 0\n\n    valid_profit_margin = df[df['\u7a05\u524d\u6de8\u5229\u7387_Q'] &gt; 0]['\u7a05\u524d\u6de8\u5229\u7387_Q']\n    avg_profit_margin = valid_profit_margin.mean() if len(valid_profit_margin) &gt; 0 else 0\n\n    # \u76c8\u9918\u6210\u9577\u7387\n    avg_earnings_growth = df['\u7a05\u5f8c\u6de8\u5229\u6210\u9577\u7387_Q'].mean(skipna=True)\n\n    if verbose:\n        print(f\"\\n========== {date} \u9078\u80a1 ==========\")\n        print(f\"\u7e3d\u80a1\u7968\u6578: {len(df)}\")\n\n    # ========================================\n    # \u968e\u6bb5\u4e00\uff1a\u6838\u5fc3\u689d\u4ef6\n    # ========================================\n    # \u689d\u4ef6 1: \u5e02\u503c \u2265 \u5e73\u5747\n    core_set_1 = set(df[df['\u500b\u80a1\u5e02\u503c_\u5143'] &gt;= avg_mktcap]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # \u689d\u4ef6 2: \u672c\u76ca\u6bd4\uff0850% \u5206\u4f4d\u6578\uff09\n    df_valid_per = df[df['\u672c\u76ca\u6bd4'] &gt; 0]\n    if len(df_valid_per) &gt; 0:\n        per_threshold = df_valid_per['\u672c\u76ca\u6bd4'].quantile(0.5)\n        core_set_2 = set(df[\n            (df['\u672c\u76ca\u6bd4'] &lt;= per_threshold) &amp; \n            (df['\u672c\u76ca\u6bd4'] &lt;= avg_per) &amp; \n            (df['\u672c\u76ca\u6bd4'] &gt; 0)\n        ]['\u80a1\u7968\u4ee3\u78bc'])\n    else:\n        core_set_2 = set()\n\n    # \u689d\u4ef6 3: \u80a1\u606f\u6536\u76ca\u7387 \u2265 \u5e73\u5747\n    core_set_3 = set(df[df['\u80a1\u5229\u6b96\u5229\u7387'] &gt;= avg_div_yield]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # \u6838\u5fc3\u689d\u4ef6\u4ea4\u96c6\n    core_set = core_set_1 &amp; core_set_2 &amp; core_set_3\n\n    # ========================================\n    # \u968e\u6bb5\u4e8c\uff1a\u984d\u5916\u689d\u4ef6\uff08\u8a08\u5206\u5236\uff09\n    # ========================================\n    score_set_1 = set(df[df['\u6d41\u52d5\u6bd4\u7387'] &gt;= avg_current_ratio]['\u80a1\u7968\u4ee3\u78bc'])\n    score_set_2 = set(df[df['\u8ca0\u50b5\u6de8\u503c\u6bd4'] &lt;= avg_debt_equity]['\u80a1\u7968\u4ee3\u78bc'])\n    score_set_3 = set(df[(df['ROE_A_\u7a05\u5f8c_Q'] &gt; 0) &amp; (df['ROE_A_\u7a05\u5f8c_Q'] &gt;= avg_roe)]['\u80a1\u7968\u4ee3\u78bc'])\n    score_set_4 = set(df[(df['\u7a05\u524d\u6de8\u5229\u7387_Q'] &gt; 0) &amp; (df['\u7a05\u524d\u6de8\u5229\u7387_Q'] &gt;= avg_profit_margin)]['\u80a1\u7968\u4ee3\u78bc'])\n    score_set_5 = set(df[df['\u7a05\u5f8c\u6de8\u5229\u6210\u9577\u7387_Q'] &gt;= avg_earnings_growth]['\u80a1\u7968\u4ee3\u78bc'])\n\n    if verbose:\n        print(f\"\u6838\u5fc3\u689d\u4ef6\u901a\u904e: {len(core_set)} \u6a94\")\n\n    # \u8a08\u5206\u7be9\u9078\uff08\u81f3\u5c11 3 \u5206\uff09\n    min_extra_score = 3\n    selected_tickers = []\n\n    for ticker in core_set:\n        score = 0\n        if ticker in score_set_1: score += 1\n        if ticker in score_set_2: score += 1\n        if ticker in score_set_3: score += 1\n        if ticker in score_set_4: score += 1\n        if ticker in score_set_5: score += 1\n\n        if score &gt;= min_extra_score:\n            selected_tickers.append(ticker)\n\n    # \u52d5\u614b\u964d\u7d1a\u6a5f\u5236\uff08\u964d\u81f3 2 \u5206\uff09\n    if len(selected_tickers) == 0:\n        fallback_score = 2\n        if verbose:\n            print(f\"\u964d\u7d1a\u81f3 {fallback_score} \u5206...\")\n        for ticker in core_set:\n            score = 0\n            if ticker in score_set_1: score += 1\n            if ticker in score_set_2: score += 1\n            if ticker in score_set_3: score += 1\n            if ticker in score_set_4: score += 1\n            if ticker in score_set_5: score += 1\n            if score &gt;= fallback_score:\n                selected_tickers.append(ticker)\n\n    if verbose:\n        print(f\"\u6700\u7d42\u5165\u9078: {len(selected_tickers)} \u6a94\")\n        if len(selected_tickers) &gt; 0:\n            print(f\"\u80a1\u7968: {selected_tickers[:10]}\")\n        print(\"=\"*40)\n\n    return selected_tickers\n\n# ====================================\n# \u532f\u5165\u50f9\u91cf\u8cc7\u6599\n# ====================================\nfrom zipline.data.run_ingest import simple_ingest\n\npools = pool + ['IR0001']\n\nprint(\"\u6b63\u5728\u6e96\u5099 Zipline \u8cc7\u6599...\")\nsimple_ingest(\n    name='tquant', \n    tickers=pools, \n    start_date=start_date.replace('-', ''), \n    end_date=end_date.replace('-', '')\n)\nprint(\"\u8cc7\u6599\u6e96\u5099\u5b8c\u6210\uff01\")\n\n# ====================================\n# Zipline \u56de\u6e2c\u8a2d\u5b9a\n# ====================================\nfrom zipline.api import (\n    set_slippage, set_commission, set_benchmark, \n    symbol, record, order_target_percent\n)\nfrom zipline.finance import commission, slippage\nfrom zipline import run_algorithm\n\ndef initialize(context):\n    \"\"\"\u521d\u59cb\u5316\u51fd\u6578\uff1a\u8a2d\u5b9a\u4ea4\u6613\u6210\u672c\u3001\u6ed1\u50f9\u3001\u57fa\u6e96\"\"\"\n    # \u6ed1\u50f9\u6a21\u578b\n    set_slippage(slippage.VolumeShareSlippage(volume_limit=1, price_impact=0.01))\n\n    # \u624b\u7e8c\u8cbb\u6a21\u578b\n    set_commission(\n        commission.Custom_TW_Commission(\n            min_trade_cost=20,\n            discount=1.0,\n            tax=0.003\n        )\n    )\n\n    # \u8a2d\u5b9a\u57fa\u6e96\u6307\u6578\n    set_benchmark(symbol('IR0001'))\n\n    # \u521d\u59cb\u5316\u8b8a\u6578\n    context.i = 0\n    context.state = False\n    context.order_tickers = []\n    context.last_tickers = []\n\ndef handle_data(context, data):\n    \"\"\"\u6bcf\u65e5\u57f7\u884c\u51fd\u6578\uff1a\u5224\u65b7\u662f\u5426\u9700\u8981\u8abf\u6574\u6301\u5009\"\"\"\n    # \u907f\u514d\u524d\u8996\u504f\u5dee\uff1a\u5728\u7be9\u9078\u80a1\u7968\u4e0b\u4e00\u4ea4\u6613\u65e5\u4e0b\u55ae\n    if context.state == True:\n        print(f\"\u4e0b\u55ae\u65e5\u671f: {data.current_dt.date()}, \u5165\u9078\u80a1\u7968\u6578: {len(context.order_tickers)}\")\n\n        # \u8ce3\u51fa\u4e0d\u518d\u6301\u6709\u7684\u80a1\u7968\n        for ticker in context.last_tickers:\n            if ticker not in context.order_tickers:\n                order_target_percent(symbol(ticker), 0)\n\n        # \u8cb7\u5165\u65b0\u5165\u9078\u7684\u80a1\u7968\uff08\u7b49\u6b0a\u91cd\uff09\n        if len(context.order_tickers) &gt; 0:\n            target_weight = 1 / len(context.order_tickers)\n            for ticker in context.order_tickers:\n                order_target_percent(symbol(ticker), target_weight)\n                curr = data.current(symbol(ticker), 'price')\n                record(price=curr, days=context.i)\n\n        context.last_tickers = context.order_tickers\n\n    context.state = False\n    backtest_date = data.current_dt.date()\n\n    # \u67e5\u770b\u662f\u5426\u70ba\u518d\u5e73\u8861\u65e5\u671f\n    for rebalance_date in modified_day:\n        if backtest_date == rebalance_date:\n            context.state = True\n            # \u57f7\u884c\u9078\u80a1\n            context.order_tickers = compute_stock(\n                date=backtest_date, \n                data=data__,\n                verbose=True\n            )\n\n    context.i += 1\n\ndef analyze(context, perf):\n    \"\"\"\u5206\u6790\u51fd\u6578\uff1a\u7e6a\u88fd\u7e3e\u6548\u5716\u8868\"\"\"\n    fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(14, 10), sharex=True)\n\n    # \u4e0a\u5716\uff1a\u7d2f\u7a4d\u5831\u916c\n    perf['algorithm_period_return'].plot(ax=ax1, label='\u7b56\u7565\u5831\u916c', linewidth=2, color='#2E86AB')\n    perf['benchmark_period_return'].plot(ax=ax1, label='\u5927\u76e4\u5831\u916c (IR0001)', linewidth=2, alpha=0.7, color='#A23B72')\n    ax1.set_title('Dreman \u9006\u5411\u6295\u8cc7\u7b56\u7565 vs \u5927\u76e4', fontsize=16, fontweight='bold', pad=20)\n    ax1.set_ylabel('\u7d2f\u7a4d\u5831\u916c\u7387', fontsize=12)\n    ax1.legend(loc='upper left', fontsize=11)\n    ax1.grid(True, alpha=0.3)\n    ax1.axhline(0, color='black', linewidth=0.8, linestyle='--', alpha=0.5)\n\n    # \u4e0b\u5716\uff1a\u6295\u8cc7\u7d44\u5408\u50f9\u503c\n    perf['portfolio_value'].plot(ax=ax2, label='\u6295\u8cc7\u7d44\u5408\u50f9\u503c', color='#F18F01', linewidth=2)\n    ax2.set_title('\u6295\u8cc7\u7d44\u5408\u50f9\u503c\u8b8a\u5316', fontsize=14, fontweight='bold', pad=15)\n    ax2.set_xlabel('\u65e5\u671f', fontsize=12)\n    ax2.set_ylabel('\u50f9\u503c\uff08\u5143\uff09', fontsize=12)\n    ax2.legend(loc='upper left', fontsize=11)\n    ax2.grid(True, alpha=0.3)\n\n    plt.tight_layout()\n    plt.show()\n\n    # \u5132\u5b58\u7e3e\u6548\u6578\u64da\n    perf.to_csv(f\"dreman_perf_{start_date}_{end_date}.csv\")\n    print(f\"\\n\u7e3e\u6548\u6578\u64da\u5df2\u5132\u5b58\u81f3: dreman_perf_{start_date}_{end_date}.csv\")\n\n# ====================================\n# \u57f7\u884c\u56de\u6e2c\n# ====================================\nprint(\"=\"*60)\nprint(\"\u958b\u59cb\u56de\u6e2c David Dreman \u9006\u5411\u6295\u8cc7\u7b56\u7565\")\nprint(\"=\"*60)\n\nresults = run_algorithm(\n    start=pd.Timestamp(start_date, tz='utc'),\n    end=pd.Timestamp(end_date, tz='utc'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    bundle='tquant',\n    capital_base=1e7  # 1000 \u842c\u5143\n)\n\nprint(\"\\n\u56de\u6e2c\u5b8c\u6210\uff01\")\n\n# ====================================\n# Pyfolio \u7e3e\u6548\u5206\u6790\n# ====================================\ntry:\n    import pyfolio as pf\n    from pyfolio.utils import extract_rets_pos_txn_from_zipline\n\n    returns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\n    benchmark_rets = results.benchmark_return\n\n    print(\"------ \u5927\u76e4\u7e3e\u6548\u6307\u6a19 ------\")\n    pf.show_perf_stats(benchmark_rets)\n\n    print(\"------ \u7b56\u7565\u7e3e\u6548 ------\")\n    pf.tears.create_full_tear_sheet(\n        returns=returns,\n        positions=positions,\n        transactions=transactions,\n        benchmark_rets=benchmark_rets\n    )\n\nexcept ImportError:\n    print(\"\u672a\u5b89\u88dd pyfolio\uff0c\u7565\u904e\u8a73\u7d30\u5206\u6790\")\n    print(\"\u82e5\u9700\u5b8c\u6574\u5831\u544a\uff0c\u8acb\u57f7\u884c: pip install pyfolio\")\nexcept Exception as e:\n    print(f\"Pyfolio \u5206\u6790\u932f\u8aa4: {e}\")\n</code></pre>"},{"location":"blocks/fundamentals/case-dreman/#_10","title":"\ud83d\udcca \u7b56\u7565\u7279\u6027\u5206\u6790","text":""},{"location":"blocks/fundamentals/case-dreman/#_11","title":"\u512a\u52e2 \u2705","text":"<ol> <li> <p>\u9632\u79a6\u6027\u5f37</p> <ul> <li>\u4f4e\u672c\u76ca\u6bd4 + \u9ad8\u80a1\u606f\uff1a\u63d0\u4f9b\u4e0b\u6a94\u4fdd\u8b77</li> <li>\u5f37\u8abf\u8ca1\u52d9\u5065\u5eb7\uff1a\u907f\u958b\u5730\u96f7\u80a1</li> <li>\u4e2d\u5927\u578b\u80a1\u70ba\u4e3b\uff1a\u6d41\u52d5\u6027\u4f73</li> </ul> </li> <li> <p>\u8a08\u5206\u5236\u9748\u6d3b</p> <ul> <li>\u4e0d\u662f\u300c\u5168\u6709\u6216\u5168\u7121\u300d</li> <li>\u5141\u8a31\u67d0\u4e9b\u6307\u6a19\u7565\u5dee</li> <li>\u7d9c\u5408\u8a55\u4f30\u66f4\u5168\u9762</li> </ul> </li> <li> <p>\u52d5\u614b\u964d\u7d1a\u6a5f\u5236</p> <ul> <li>\u907f\u514d\u6975\u7aef\u5e02\u6cc1\u7121\u80a1\u7968\u53ef\u8cb7</li> <li>\u4fdd\u6301\u7b56\u7565\u6301\u7e8c\u904b\u4f5c</li> <li>\u985e\u4f3c\u300cPlan B\u300d\u7684\u5bb9\u932f\u8a2d\u8a08</li> </ul> </li> <li> <p>\u9069\u5408\u9577\u671f\u6301\u6709</p> <ul> <li>\u5b63\u5ea6\u8abf\u5009\uff0c\u9031\u8f49\u7387\u4f4e</li> <li>\u4ea4\u6613\u6210\u672c\u4f4e</li> <li>\u9069\u5408\u50f9\u503c\u6295\u8cc7\u8005</li> </ul> </li> </ol>"},{"location":"blocks/fundamentals/case-dreman/#_12","title":"\u98a8\u96aa \u26a0\ufe0f","text":"<ol> <li> <p>\u50f9\u503c\u9677\u9631\u98a8\u96aa</p> <ul> <li>\u4fbf\u5b9c\u4e0d\u4e00\u5b9a\u662f\u597d\u8ca8</li> <li>\u53ef\u80fd\u8cb7\u5230\u5915\u967d\u7522\u696d</li> <li>\u9700\u642d\u914d\u6210\u9577\u7387\u6aa2\u9a57</li> </ul> </li> <li> <p>\u7e3e\u6548\u843d\u5f8c\u6210\u9577\u80a1</p> <ul> <li>\u5e02\u5834\u760b\u72c2\u6642\u8868\u73fe\u5e73\u6de1</li> <li>\u932f\u904e\u9ad8\u6210\u9577\u80a1\u884c\u60c5</li> <li>\u9700\u8981\u8010\u5fc3\u7b49\u5f85</li> </ul> </li> <li> <p>\u9078\u80a1\u6578\u91cf\u6ce2\u52d5</p> <ul> <li>\u725b\u5e02\u6642\u53ef\u80fd\u53ea\u9078\u51fa 5-10 \u6a94</li> <li>\u718a\u5e02\u6642\u53ef\u80fd\u9078\u51fa 30-40 \u6a94</li> <li>\u5f71\u97ff\u5206\u6563\u6548\u679c</li> </ul> </li> </ol>"},{"location":"blocks/fundamentals/case-dreman/#_13","title":"\ud83d\udd0d \u95dc\u9375\u5b78\u7fd2\u9ede","text":""},{"location":"blocks/fundamentals/case-dreman/#1_2","title":"1. \u8a08\u5206\u5236\u7684\u5be6\u4f5c\u6280\u5de7","text":"<pre><code># \u65b9\u6cd5 1: \u9010\u6a94\u8a08\u5206\uff08\u9069\u5408\u8907\u96dc\u908f\u8f2f\uff09\nselected_tickers = []\nfor ticker in core_set:\n    score = 0\n    if ticker in score_set_1: score += 1\n    if ticker in score_set_2: score += 1\n    # ...\n    if score &gt;= min_score:\n        selected_tickers.append(ticker)\n\n# \u65b9\u6cd5 2: \u5411\u91cf\u5316\u8a08\u5206\uff08\u6548\u80fd\u66f4\u597d\uff09\ndf['score'] = (\n    (df['\u80a1\u7968\u4ee3\u78bc'].isin(score_set_1)).astype(int) +\n    (df['\u80a1\u7968\u4ee3\u78bc'].isin(score_set_2)).astype(int) +\n    # ...\n)\nselected_tickers = df[df['score'] &gt;= min_score]['\u80a1\u7968\u4ee3\u78bc'].tolist()\n</code></pre> <p>\u4f55\u6642\u7528\u8a08\u5206\u6cd5\uff1f - \u689d\u4ef6\u5f88\u591a\uff08&gt;5 \u500b\uff09 - \u689d\u4ef6\u4e4b\u9593\u53ef\u66ff\u4ee3 - \u5e0c\u671b\u7d9c\u5408\u8a55\u4f30\u800c\u975e\u7d55\u5c0d\u9580\u6abb</p>"},{"location":"blocks/fundamentals/case-dreman/#2_1","title":"2. \u52d5\u614b\u964d\u7d1a\u7684\u8a2d\u8a08\u54f2\u5b78","text":"<pre><code># \u57fa\u672c\u7248\uff1a\u56fa\u5b9a\u964d\u7d1a\nif len(selected_tickers) == 0:\n    selected_tickers = fallback_selection()\n\n# \u9032\u968e\u7248\uff1a\u6f38\u9032\u5f0f\u964d\u7d1a\nfor threshold in [3, 2, 1]:\n    selected_tickers = select_with_score(threshold)\n    if len(selected_tickers) &gt;= 5:  # \u81f3\u5c11 5 \u6a94\n        break\n\n# \u5c08\u696d\u7248\uff1a\u6839\u64da\u5e02\u5834\u72c0\u6cc1\u8abf\u6574\nif market_volatility &gt; 30:  # \u5e02\u5834\u6050\u614c\n    min_score = 2  # \u964d\u4f4e\u6a19\u6e96\nelse:\n    min_score = 3\n</code></pre> <p>\u70ba\u4ec0\u9ebc\u9700\u8981\u964d\u7d1a\uff1f - \u5be6\u52d9\u8003\u91cf\uff1a\u7e3d\u4e0d\u80fd\u7a7a\u624b - \u7b56\u7565\u7a69\u5065\u6027\uff1a\u6975\u7aef\u60c5\u6cc1\u4ecd\u80fd\u904b\u4f5c - \u907f\u514d\u904e\u5ea6\u64ec\u5408\uff1a\u592a\u56b4\u683c\u7684\u689d\u4ef6\u53ef\u80fd\u5931\u6548</p>"},{"location":"blocks/fundamentals/case-dreman/#3_2","title":"3. \u8655\u7406\u8ca0\u503c\u8207\u7f3a\u5931\u503c","text":"<pre><code># \u274c \u932f\u8aa4\uff1a\u76f4\u63a5\u8a08\u7b97\u5e73\u5747\navg_roe = df['ROE'].mean()  # \u5305\u542b\u8ca0\u503c\uff0c\u5e73\u5747\u503c\u5931\u771f\n\n# \u2705 \u6b63\u78ba\uff1a\u53ea\u5c0d\u6b63\u503c\u8a08\u7b97\nvalid_roe = df[df['ROE'] &gt; 0]['ROE']\navg_roe = valid_roe.mean() if len(valid_roe) &gt; 0 else 0\n\n# \u2705 \u66f4\u56b4\u8b39\uff1a\u8655\u7406\u6975\u7aef\u503c\nvalid_roe = df[(df['ROE'] &gt; 0) &amp; (df['ROE'] &lt; 100)]['ROE']  # \u6392\u9664 &gt;100% \u7684\u7570\u5e38\u503c\n</code></pre>"},{"location":"blocks/fundamentals/case-dreman/#4-50-vs","title":"4. 50% \u5206\u4f4d\u6578 vs \u5e73\u5747\u503c","text":"<pre><code># \u5e73\u5747\u503c\uff1a\u5bb9\u6613\u88ab\u6975\u7aef\u503c\u5f71\u97ff\navg_per = df['\u672c\u76ca\u6bd4'].mean()  # \u5982\u679c\u6709\u5e7e\u6a94 PE=100\uff0c\u5e73\u5747\u6703\u88ab\u62c9\u9ad8\n\n# \u4e2d\u4f4d\u6578\uff0850% \u5206\u4f4d\uff09\uff1a\u66f4\u7a69\u5065\nmedian_per = df['\u672c\u76ca\u6bd4'].quantile(0.5)  # \u4e0d\u53d7\u6975\u7aef\u503c\u5f71\u97ff\n\n# Dreman \u540c\u6642\u4f7f\u7528\u5169\u8005\ncondition = (df['\u672c\u76ca\u6bd4'] &lt;= median_per) &amp; (df['\u672c\u76ca\u6bd4'] &lt;= avg_per)\n</code></pre> <p>\u6c7a\u7b56\u6a39\uff1a - \u6578\u64da\u5206\u4f48\u504f\u614b\uff1f \u2192 \u7528\u4e2d\u4f4d\u6578 - \u6709\u6975\u7aef\u503c\uff1f \u2192 \u7528\u4e2d\u4f4d\u6578 - \u60f3\u8981\u66f4\u56b4\u683c\uff1f \u2192 \u5169\u8005\u90fd\u7528\uff08AND\uff09</p>"},{"location":"blocks/fundamentals/case-dreman/#_14","title":"\ud83c\udfaf \u5ef6\u4f38\u512a\u5316\u65b9\u5411","text":""},{"location":"blocks/fundamentals/case-dreman/#1_3","title":"\u512a\u5316 1: \u52d5\u614b\u8abf\u6574\u8a08\u5206\u6b0a\u91cd","text":"<pre><code># \u6839\u64da\u5e02\u5834\u74b0\u5883\u8abf\u6574\u6b0a\u91cd\nif market_pe &gt; historical_pe.quantile(0.8):  # \u5e02\u5834\u904e\u71b1\n    # \u91cd\u8996\u8ca1\u52d9\u5b89\u5168\n    score = (\n        ticker in score_set_1 * 2 +  # \u6d41\u52d5\u6bd4\u7387\uff08\u52a0\u500d\uff09\n        ticker in score_set_2 * 2 +  # \u8ca0\u50b5\u6bd4\uff08\u52a0\u500d\uff09\n        ticker in score_set_3 * 1 +  # ROE\n        ticker in score_set_4 * 1 +  # \u6de8\u5229\u7387\n        ticker in score_set_5 * 0    # \u6210\u9577\u7387\uff08\u5ffd\u7565\uff09\n    )\n    min_score = 5\nelse:  # \u5e02\u5834\u6b63\u5e38\n    # \u5e73\u8861\u8003\u91cf\n    score = sum([ticker in s for s in [score_set_1, ..., score_set_5]])\n    min_score = 3\n</code></pre>"},{"location":"blocks/fundamentals/case-dreman/#2_2","title":"\u512a\u5316 2: \u52a0\u5165\u52d5\u91cf\u904e\u6ffe","text":"<pre><code># \u6392\u9664\u50f9\u683c\u8da8\u52e2\u5411\u4e0b\u7684\u80a1\u7968\ndf['MA20'] = df.groupby('\u80a1\u7968\u4ee3\u78bc')['\u6536\u76e4\u50f9'].transform(lambda x: x.rolling(20).mean())\nmomentum_set = set(df[df['\u6536\u76e4\u50f9'] &gt; df['MA20']]['\u80a1\u7968\u4ee3\u78bc'])\n\n# \u6700\u7d42\u7be9\u9078\nselected_tickers = [t for t in selected_tickers if t in momentum_set]\n</code></pre> <p>\u908f\u8f2f\uff1a Dreman \u91cd\u8996\u50f9\u503c\uff0c\u4f46\u4e5f\u4e0d\u8cb7\u300cfalling knife\u300d\uff08\u63a5\u843d\u4e0b\u7684\u5200\uff09\u3002</p>"},{"location":"blocks/fundamentals/case-dreman/#3_3","title":"\u512a\u5316 3: \u7522\u696d\u5206\u6563","text":"<pre><code># \u6bcf\u500b\u7522\u696d\u6700\u591a 3 \u6a94\nindustry_counts = {}\nfinal_tickers = []\n\nfor ticker in selected_tickers:\n    industry = df[df['\u80a1\u7968\u4ee3\u78bc'] == ticker]['\u4e3b\u7522\u696d\u5225'].values[0]\n    if industry_counts.get(industry, 0) &lt; 3:\n        final_tickers.append(ticker)\n        industry_counts[industry] = industry_counts.get(industry, 0) + 1\n</code></pre>"},{"location":"blocks/fundamentals/case-dreman/#4","title":"\u512a\u5316 4: \u6301\u6709\u671f\u5ef6\u9577","text":"<pre><code># \u6301\u6709 2 \u5b63\uff0c\u6e1b\u5c11\u9031\u8f49\nif context.i % 2 == 0:  # \u6bcf 2 \u5b63\u63db\u80a1\u4e00\u6b21\n    context.state = True\n</code></pre>"},{"location":"blocks/fundamentals/case-dreman/#_15","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6a21\u677f\u9801\u9762\uff1atemplate.md - \u8a08\u5206\u6cd5\u6a21\u677f</li> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md - \u7406\u89e3\u8a2d\u8a08\u539f\u7406</li> <li>\u5176\u4ed6\u6848\u4f8b\uff1a</li> <li>\u591a\u56e0\u5b50\u9078\u80a1 - \u4ea4\u96c6\u6cd5\u7bc4\u4f8b</li> <li>\u5c0f\u578b\u6210\u9577\u80a1 - \u6392\u540d\u6cd5\u7bc4\u4f8b</li> </ul>"},{"location":"blocks/fundamentals/case-dreman/#_16","title":"\ud83d\udca1 \u7e3d\u7d50","text":"<p>Dreman \u9006\u5411\u6295\u8cc7\u7b56\u7565\u5c55\u793a\u4e86 \u8a08\u5206\u6cd5 \u7684\u7cbe\u9ad3\uff1a</p> <ol> <li>\u2705 \u5169\u968e\u6bb5\u8a2d\u8a08\uff1a\u6838\u5fc3\u9580\u6abb + \u9748\u6d3b\u8a08\u5206</li> <li>\u2705 \u52d5\u614b\u964d\u7d1a\uff1a\u5bb9\u932f\u6a5f\u5236\uff0c\u4fdd\u6301\u904b\u4f5c</li> <li>\u2705 \u9632\u79a6\u70ba\u4e3b\uff1a\u4f4e\u4f30\u503c + \u9ad8\u80a1\u606f + \u8ca1\u52d9\u5065\u5eb7</li> <li>\u2705 \u9577\u671f\u6301\u6709\uff1a\u5b63\u5ea6\u8abf\u5009\uff0c\u4f4e\u9031\u8f49\u7387</li> </ol> <p>\u9069\u5408\u8ab0\u4f7f\u7528\uff1f - \u50f9\u503c\u6295\u8cc7\u8005\uff08\u91cd\u8996\u5b89\u5168\u908a\u969b\uff09 - \u4fdd\u5b88\u578b\u6295\u8cc7\u4eba\uff08\u504f\u597d\u7a69\u5b9a\u6536\u76ca\uff09 - \u9577\u671f\u6295\u8cc7\u8005\uff08\u4e0d\u5728\u610f\u77ed\u671f\u6ce2\u52d5\uff09</p> <p>\u8207\u5176\u4ed6\u7b56\u7565\u7684\u5dee\u7570\uff1a | \u7279\u6027 | Dreman | \u591a\u56e0\u5b50 | \u5c0f\u578b\u6210\u9577\u80a1 | | :--- | :---: | :---: | :---: | | \u9078\u80a1\u908f\u8f2f | \u8a08\u5206\u6cd5 | \u4ea4\u96c6\u6cd5 | \u6392\u540d\u6cd5 | | \u98a8\u96aa\u504f\u597d | \u4fdd\u5b88 | \u4e2d\u6027 | \u7a4d\u6975 | | \u6301\u80a1\u6578\u91cf | 10-20 \u6a94 | 15-30 \u6a94 | 5-15 \u6a94 | | \u9069\u5408\u5e02\u6cc1 | \u718a\u5e02/\u76e4\u6574 | \u5168\u5e02\u6cc1 | \u725b\u5e02 |</p> <p>\ud83d\udc49 Next Step: \u4e09\u500b\u6848\u4f8b\u90fd\u770b\u5b8c\u4e86\uff1f\u524d\u5f80 faq.md \u67e5\u770b\u5e38\u898b\u554f\u984c\uff0c\u6216\u76f4\u63a5\u958b\u59cb\u958b\u767c\u4f60\u7684\u7b56\u7565\uff01</p>"},{"location":"blocks/fundamentals/case-dreman/#_17","title":"\ud83d\udcd6 \u5ef6\u4f38\u95b1\u8b80","text":"<p>David Dreman \u7d93\u5178\u8457\u4f5c\uff1a</p> <ul> <li>\u300a\u9006\u5411\u6295\u8cc7\u7b56\u7565\u300b(Contrarian Investment Strategies)</li> <li>\u300a\u9006\u5411\u6295\u8cc7\u5fc3\u7406\u5b78\u300b(Contrarian Investment Psychology)</li> </ul> <p>\u6838\u5fc3\u89c0\u9ede\u6458\u8981\uff1a</p> <p>\"The market is not always efficient. Emotions drive prices to extremes, creating opportunities for patient investors who focus on fundamentals.\"</p> <p>Dreman \u56db\u5927\u6295\u8cc7\u539f\u5247\uff1a</p> <ol> <li>\u8cb7\u5165\u4f4e\u672c\u76ca\u6bd4\u80a1\u7968</li> <li>\u8cb7\u5165\u4f4e\u80a1\u50f9\u6de8\u503c\u6bd4\u80a1\u7968</li> <li>\u8cb7\u5165\u9ad8\u80a1\u606f\u80a1\u7968</li> <li>\u6301\u6709\u5206\u6563\u7684\u6295\u8cc7\u7d44\u5408</li> </ol> <p>\u672c\u7b56\u7565\u5373\u70ba\u9019\u4e9b\u539f\u5247\u7684\u91cf\u5316\u5be6\u4f5c\u3002</p>"},{"location":"blocks/fundamentals/case-multifactor/","title":"\u6848\u4f8b 1\uff1a\u591a\u56e0\u5b50\u9078\u80a1\u7b56\u7565","text":"<p>\u7b56\u7565\u985e\u578b\uff1a \u8ca1\u5831\u9078\u80a1\u67b6\u69cb - \u4ea4\u96c6\u6cd5 \u8abf\u5009\u983b\u7387\uff1a \u6bcf\u5b63\uff083/6/9/12 \u6708\u672b\uff09 \u80a1\u7968\u6c60\uff1a \u53f0\u7063\u4e0a\u5e02 + \u4e0a\u6ac3\u666e\u901a\u80a1 \u56de\u6e2c\u671f\u9593\uff1a 2019-12-30 ~ 2023-12-30</p>"},{"location":"blocks/fundamentals/case-multifactor/#_1","title":"\ud83d\udccc \u7b56\u7565\u6982\u8ff0","text":"<p>\u9019\u662f\u4e00\u500b\u7d93\u5178\u7684 \u591a\u56e0\u5b50\u50f9\u503c\u9078\u80a1\u7b56\u7565\uff0c\u7d50\u5408\u4e86\uff1a</p> <ul> <li>\ud83d\udcca \u4f30\u503c\u56e0\u5b50\uff1a\u672c\u76ca\u6bd4\u76f8\u5c0d\u7522\u696d\u5e73\u5747</li> <li>\ud83d\udcb0 \u8ca1\u52d9\u5065\u5eb7\uff1a\u6d41\u52d5\u6bd4\u7387\u3001\u8ca0\u50b5\u6b0a\u76ca\u6bd4</li> <li>\ud83d\udcb5 \u80a1\u606f\u56e0\u5b50\uff1a\u73fe\u91d1\u80a1\u5229\u7387</li> <li>\ud83d\udcc8 \u6210\u9577\u56e0\u5b50\uff1a\u71df\u6536\u6210\u9577\u7387 + \u80a1\u5229\u6536\u76ca\u7387</li> </ul>"},{"location":"blocks/fundamentals/case-multifactor/#_2","title":"\u7b56\u7565\u908f\u8f2f","text":"<p>\u6bcf\u5b63\u672b\u7be9\u9078\u51fa \u540c\u6642\u6eff\u8db3 5 \u500b\u689d\u4ef6 \u7684\u80a1\u7968\uff0c\u9694\u65e5\u7b49\u6b0a\u91cd\u914d\u7f6e\uff0c\u6301\u6709\u81f3\u4e0b\u4e00\u5b63\u672b\u3002</p>"},{"location":"blocks/fundamentals/case-multifactor/#_3","title":"\ud83c\udfaf \u9078\u80a1\u689d\u4ef6\u8a73\u89e3","text":""},{"location":"blocks/fundamentals/case-multifactor/#1_1","title":"\u689d\u4ef6 1: \u672c\u76ca\u6bd4 &lt; \u7522\u696d\u5e73\u5747","text":"<p><pre><code>df['\u7522\u696d\u5e73\u5747\u672c\u76ca\u6bd4'] = df.groupby('\u4e3b\u7522\u696d\u5225_\u4e2d\u6587')['\u672c\u76ca\u6bd4'].transform('mean')\nset_1 = set(df[df['\u672c\u76ca\u6bd4'] &lt; df['\u7522\u696d\u5e73\u5747\u672c\u76ca\u6bd4']]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u908f\u8f2f\uff1a \u5728\u540c\u7522\u696d\u4e2d\u5c0b\u627e\u76f8\u5c0d\u4fbf\u5b9c\u7684\u80a1\u7968\uff0c\u907f\u514d\u8de8\u7522\u696d\u6bd4\u8f03\u7684\u4e0d\u516c\u5e73\u6027\uff08\u4f8b\u5982\u79d1\u6280\u696d\u672c\u76ca\u6bd4\u666e\u904d\u9ad8\u65bc\u50b3\u7522\uff09\u3002</p>"},{"location":"blocks/fundamentals/case-multifactor/#2","title":"\u689d\u4ef6 2: \u6d41\u52d5\u6bd4\u7387 &gt; \u7522\u696d\u5e73\u5747","text":"<p><pre><code>df['\u7522\u696d\u5e73\u5747\u6d41\u52d5\u6bd4\u7387'] = df.groupby('\u4e3b\u7522\u696d\u5225_\u4e2d\u6587')['\u6d41\u52d5\u6bd4\u7387_A'].transform('mean')\nset_2 = set(df[df['\u6d41\u52d5\u6bd4\u7387_A'] &gt; df['\u7522\u696d\u5e73\u5747\u6d41\u52d5\u6bd4\u7387']]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u908f\u8f2f\uff1a \u6d41\u52d5\u6bd4\u7387 = \u6d41\u52d5\u8cc7\u7522 / \u6d41\u52d5\u8ca0\u50b5\uff0c\u5927\u65bc 1 \u8868\u793a\u77ed\u671f\u511f\u50b5\u80fd\u529b\u826f\u597d\u3002\u9078\u64c7\u7522\u696d\u4e2d\u6d41\u52d5\u6027\u8f03\u4f73\u7684\u516c\u53f8\u3002</p>"},{"location":"blocks/fundamentals/case-multifactor/#3-20","title":"\u689d\u4ef6 3: \u8ca0\u50b5\u4f54\u80a1\u6771\u6b0a\u76ca &lt; 20%","text":"<p><pre><code>df['\u8ca0\u50b5\u4f54\u80a1\u6771\u6b0a\u76ca'] = df['\u8ca0\u50b5\u7e3d\u984d_A'] / df['\u80a1\u6771\u6b0a\u76ca\u7e3d\u8a08_A']\nset_3 = set(df[df['\u8ca0\u50b5\u4f54\u80a1\u6771\u6b0a\u76ca'] &lt; 0.2]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u908f\u8f2f\uff1a \u4f4e\u69d3\u687f\u516c\u53f8\uff0c\u8ca1\u52d9\u98a8\u96aa\u8f03\u4f4e\u300220% \u662f\u4fdd\u5b88\u7684\u5b89\u5168\u9580\u6abb\u3002</p>"},{"location":"blocks/fundamentals/case-multifactor/#4","title":"\u689d\u4ef6 4: \u73fe\u91d1\u80a1\u5229\u7387 &gt; \u7522\u696d\u5e73\u5747","text":"<p><pre><code>df['\u7522\u696d\u5e73\u5747\u73fe\u91d1\u80a1\u5229\u7387'] = df.groupby('\u4e3b\u7522\u696d\u5225_\u4e2d\u6587')['\u73fe\u91d1\u80a1\u5229\u7387'].transform('mean')\nset_4 = set(df[df['\u73fe\u91d1\u80a1\u5229\u7387'] &gt; df['\u7522\u696d\u5e73\u5747\u73fe\u91d1\u80a1\u5229\u7387']]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u908f\u8f2f\uff1a \u73fe\u91d1\u80a1\u5229\u7387 = \u73fe\u91d1\u80a1\u5229 / \u80a1\u50f9\uff0c\u9078\u64c7\u9858\u610f\u5206\u4eab\u76c8\u5229\u7d66\u80a1\u6771\u7684\u516c\u53f8\u3002</p>"},{"location":"blocks/fundamentals/case-multifactor/#5-10","title":"\u689d\u4ef6 5: \u80a1\u5229\u6536\u76ca\u7387 + \u6210\u9577\u7387 &gt; 10%","text":"<p><pre><code>set_5 = set(df[df['\u71df\u6536\u6210\u9577\u7387_A']*0.01 + df['\u73fe\u91d1\u80a1\u5229\u7387']*0.01 &gt; 0.1]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> \u908f\u8f2f\uff1a \u7d50\u5408\u300c\u6210\u9577\u300d\u8207\u300c\u6536\u76ca\u300d\uff0c\u985e\u4f3c PEG \u7684\u6982\u5ff5\u3002\u4f8b\u5982\uff1a\u80a1\u5229\u7387 5% + \u6210\u9577\u7387 6% = 11% &gt; 10%\u3002</p>"},{"location":"blocks/fundamentals/case-multifactor/#_4","title":"\u6700\u7d42\u7be9\u9078","text":"<pre><code>tickers = list(set_1 &amp; set_2 &amp; set_3 &amp; set_4 &amp; set_5)  # \u53d6\u4ea4\u96c6\n</code></pre>"},{"location":"blocks/fundamentals/case-multifactor/#_5","title":"\ud83d\udcbb \u5b8c\u6574\u7a0b\u5f0f\u78bc","text":"<pre><code># ====================================\n# \u591a\u56e0\u5b50\u9078\u80a1\u7b56\u7565 - \u5b8c\u6574\u5be6\u4f5c\n# ====================================\n\nimport pandas as pd\nimport numpy as np\nimport tejapi\nimport os\nimport matplotlib.pyplot as plt\n\nplt.rcParams['font.family'] = 'Arial'\n\n# ====================================\n# TEJ API \u8a2d\u5b9a\n# ====================================\ntej_key = '\u8acb\u8f38\u5165API'\ntejapi.ApiConfig.api_key = tej_key\nos.environ['TEJAPI_BASE'] = \"https://api.tej.com.tw\"\nos.environ['TEJAPI_KEY'] = tej_key\n\n# ====================================\n# \u80a1\u7968\u6c60\u8a2d\u5b9a\n# ====================================\nfrom zipline.sources.TEJ_Api_Data import get_universe\n\npool = get_universe(\n    start=pd.Timestamp('2019-12-01', tz='UTC'),\n    end=pd.Timestamp('2023-12-31', tz='UTC'), \n    mkt_bd_e=['TSE', 'OTC'],\n    stktp_e='Common Stock'\n)\n\nprint(f\"\u80a1\u7968\u6c60: {len(pool)} \u6a94\")\n\n# ====================================\n# \u8ca1\u5831\u6578\u64da\u4e0b\u8f09\n# ====================================\nimport TejToolAPI\n\ncolumns = [\n    'Industry',      # \u7522\u696d\u5225\n    '\u672c\u76ca\u6bd4',        # P/E Ratio\n    '\u6536\u76e4\u50f9',        # Close Price\n    '\u6d41\u52d5\u6bd4\u7387',      # Current Ratio\n    '\u80a1\u6771\u6b0a\u76ca\u7e3d\u984d',  # Total Equity\n    '\u8ca0\u50b5\u7e3d\u984d',      # Total Liabilities\n    '\u71df\u6536\u6210\u9577\u7387',    # Revenue Growth Rate\n    'eps',           # EPS\n    '\u73fe\u91d1\u80a1\u5229\u7387'     # Cash Dividend Yield\n]\n\nstart_dt = pd.Timestamp('2019-12-29', tz='UTC')\nend_dt = pd.Timestamp('2023-12-31', tz='UTC')\n\ndata__ = TejToolAPI.get_history_data(\n    start=start_dt,\n    end=end_dt,\n    ticker=pool,\n    fin_type='A',  # \u7d2f\u8a08\u5e74\u5831\u8cc7\u6599\n    columns=columns,\n    transfer_to_chinese=True,\n    include_self_acc=\"Y\"\n)\n\nprint(f\"\u6578\u64da\u7b46\u6578: {len(data__):,}\")\n\n# ====================================\n# \u63db\u80a1\u65e5\u671f\u8a08\u7b97\uff08\u6bcf\u5b63\u6700\u5f8c\u4ea4\u6613\u65e5\uff09\n# ====================================\nsample = data__[data__['\u80a1\u7968\u4ee3\u78bc'] == '2330']\n\n# 12 \u6708\u6700\u5f8c\u4ea4\u6613\u65e5\nlast_day_ = list(sample.groupby(sample['\u65e5\u671f'].dt.year)['\u65e5\u671f'].max())\n\n# 6 \u6708\u6700\u5f8c\u4ea4\u6613\u65e5\njune_data = sample[sample['\u65e5\u671f'].dt.month == 6]\nlast_june_day = list(june_data.groupby(june_data['\u65e5\u671f'].dt.year)['\u65e5\u671f'].max())\n\n# 3 \u6708\u6700\u5f8c\u4ea4\u6613\u65e5\nmarch_data = sample[sample['\u65e5\u671f'].dt.month == 3]\nlast_march_day = list(march_data.groupby(march_data['\u65e5\u671f'].dt.year)['\u65e5\u671f'].max())\n\n# 9 \u6708\u6700\u5f8c\u4ea4\u6613\u65e5\nsep_data = sample[sample['\u65e5\u671f'].dt.month == 9]\nlast_sep_day = list(sep_data.groupby(sep_data['\u65e5\u671f'].dt.year)['\u65e5\u671f'].max())\n\n# \u5408\u4f75\u6240\u6709\u63db\u80a1\u65e5\nlast_day_ = last_day_ + last_june_day + last_march_day + last_sep_day\n\n# \u8f49\u63db\u70ba date \u683c\u5f0f\nmodified_day = [i.date() for i in last_day_]\n\nprint(f\"\u63db\u80a1\u6b21\u6578: {len(modified_day)}\")\nprint(f\"\u7bc4\u4f8b\u65e5\u671f: {modified_day[:8]}\")\n\n# ====================================\n# \u9078\u80a1\u51fd\u6578\n# ====================================\ndef compute_stock(date, data):\n    \"\"\"\u591a\u56e0\u5b50\u9078\u80a1\u51fd\u6578\"\"\"\n    # \u63d0\u53d6\u51fa\u8abf\u6574\u90e8\u4f4d\u7576\u65e5\u7684\u80a1\u7968\u8cc7\u8a0a\n    df = data[data['\u65e5\u671f'] == pd.Timestamp(date)].reset_index(drop=True)\n\n    # \u689d\u4ef6 1: \u672c\u76ca\u6bd4\u5c0f\u65bc\u7522\u696d\u5e73\u5747\u503c\n    df['\u7522\u696d\u5e73\u5747\u672c\u76ca\u6bd4'] = df.groupby('\u4e3b\u7522\u696d\u5225_\u4e2d\u6587')['\u672c\u76ca\u6bd4'].transform('mean')\n    set_1 = set(df[df['\u672c\u76ca\u6bd4'] &lt; df['\u7522\u696d\u5e73\u5747\u672c\u76ca\u6bd4']]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # \u689d\u4ef6 2: \u6d41\u52d5\u6bd4\u7387\u5927\u65bc\u7522\u696d\u5e73\u5747\u503c\n    df['\u7522\u696d\u5e73\u5747\u6d41\u52d5\u6bd4\u7387'] = df.groupby('\u4e3b\u7522\u696d\u5225_\u4e2d\u6587')['\u6d41\u52d5\u6bd4\u7387_A'].transform('mean')\n    set_2 = set(df[df['\u6d41\u52d5\u6bd4\u7387_A'] &gt; df['\u7522\u696d\u5e73\u5747\u6d41\u52d5\u6bd4\u7387']]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # \u689d\u4ef6 3: \u8ca0\u50b5\u4f54\u80a1\u6771\u6b0a\u76ca\u5c0f\u65bc 20%\n    df['\u8ca0\u50b5\u4f54\u80a1\u6771\u6b0a\u76ca'] = df['\u8ca0\u50b5\u7e3d\u984d_A'] / df['\u80a1\u6771\u6b0a\u76ca\u7e3d\u984d_A']\n    set_3 = set(df[df['\u8ca0\u50b5\u4f54\u80a1\u6771\u6b0a\u76ca'] &lt; 0.2]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # \u689d\u4ef6 4: \u73fe\u91d1\u80a1\u5229\u7387\u5927\u65bc\u7522\u696d\u5e73\u5747\u503c\n    df['\u7522\u696d\u5e73\u5747\u73fe\u91d1\u80a1\u5229\u7387'] = df.groupby('\u4e3b\u7522\u696d\u5225_\u4e2d\u6587')['\u73fe\u91d1\u80a1\u5229\u7387'].transform('mean')\n    set_4 = set(df[df['\u73fe\u91d1\u80a1\u5229\u7387'] &gt; df['\u7522\u696d\u5e73\u5747\u73fe\u91d1\u80a1\u5229\u7387']]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # \u689d\u4ef6 5: \u80a1\u5229\u6536\u76ca\u7387 + \u6210\u9577\u7387 &gt; 10%\n    set_5 = set(df[df['\u71df\u6536\u6210\u9577\u7387_A']*0.01 + df['\u73fe\u91d1\u80a1\u5229\u7387']*0.01 &gt; 0.1]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # \u53d6\u4ea4\u96c6\n    tickers = list(set_1 &amp; set_2 &amp; set_3 &amp; set_4 &amp; set_5)\n\n    return tickers\n\n# ====================================\n# \u532f\u5165\u50f9\u91cf\u8cc7\u6599\n# ====================================\nfrom zipline.data.run_ingest import simple_ingest\n\npools = pool + ['IR0001']\n\nsimple_ingest(\n    name='tquant',\n    tickers=pools,\n    start_date='20191201',\n    end_date='20231231'\n)\n\n# ====================================\n# Zipline \u56de\u6e2c\u8a2d\u5b9a\n# ====================================\nfrom zipline.api import (\n    set_slippage, set_commission, set_benchmark, \n    symbol, record, order_target_percent\n)\nfrom zipline.finance import commission, slippage\nfrom zipline import run_algorithm\n\ndef initialize(context):\n    \"\"\"\u521d\u59cb\u5316\u51fd\u6578\"\"\"\n    set_slippage(slippage.TW_Slippage(spread=1, volume_limit=1))\n    set_commission(commission.Custom_TW_Commission(\n        min_trade_cost=20,\n        discount=1.0,\n        tax=0.003\n    ))\n    set_benchmark(symbol('IR0001'))\n\n    context.i = 0\n    context.state = False\n    context.order_tickers = []\n    context.last_tickers = []\n\ndef handle_data(context, data):\n    \"\"\"\u6bcf\u65e5\u57f7\u884c\u51fd\u6578\"\"\"\n    # \u907f\u514d\u524d\u8996\u504f\u5dee\uff0c\u5728\u7be9\u9078\u80a1\u7968\u4e0b\u4e00\u4ea4\u6613\u65e5\u4e0b\u55ae\n    if context.state == True:\n        print(f\"\u4e0b\u55ae\u65e5\u671f\uff1a{data.current_dt.date()}, \u64c7\u80a1\u80a1\u7968\u6578\u91cf\uff1a{len(context.order_tickers)}\")\n\n        # \u8ce3\u51fa\u4e0d\u5728\u65b0\u540d\u55ae\u7684\u80a1\u7968\n        for i in context.last_tickers:\n            if i not in context.order_tickers:\n                order_target_percent(symbol(i), 0)\n\n        # \u8cb7\u5165\u65b0\u540d\u55ae\u7684\u80a1\u7968\uff08\u7b49\u6b0a\u91cd\uff09\n        for i in context.order_tickers:\n            order_target_percent(symbol(i), 1 / len(context.order_tickers))\n            curr = data.current(symbol(i), 'price')\n            record(price=curr, days=context.i)\n\n        context.last_tickers = context.order_tickers\n\n    context.state = False\n    backtest_date = data.current_dt.date()\n\n    # \u67e5\u770b\u56de\u6e2c\u6642\u9593\u662f\u5426\u7b26\u5408\u6307\u5b9a\u65e5\u671f\n    for idx, j in enumerate(modified_day):\n        if backtest_date == j:\n            # \u8abf\u6574\u72c0\u614b\uff0c\u5728\u4e0b\u4e00\u500b\u4ea4\u6613\u65e5\u4e0b\u55ae\n            context.state = True\n            context.order_tickers = compute_stock(date=backtest_date, data=data__)\n\n    context.i += 1\n\ndef analyze(context, perf):\n    \"\"\"\u7e3e\u6548\u5206\u6790\u51fd\u6578\"\"\"\n    fig, axes = plt.subplots(nrows=2, ncols=1, figsize=(14, 10))\n\n    # \u6295\u8cc7\u7d44\u5408\u50f9\u503c\n    axes[0].plot(perf['portfolio_value'], label='Portfolio Value')\n    axes[0].set_title('Portfolio Value')\n    axes[0].legend()\n\n    # \u7d2f\u7a4d\u5831\u916c\n    cumulative_returns = (1 + perf['returns']).cumprod() - 1\n    axes[1].plot(perf.index, cumulative_returns, label='Portfolio')\n    axes[1].plot(perf.index, perf['benchmark_period_return'], label='Benchmark')\n    axes[1].set_title('Cumulative Returns: Portfolio vs Benchmark')\n    axes[1].legend()\n\n    plt.tight_layout()\n    plt.show()\n\n    perf.to_csv(\"perf_multifactor.csv\")\n\n# ====================================\n# \u57f7\u884c\u56de\u6e2c\n# ====================================\ncapital_base = 1e7\n\nresults = run_algorithm(\n    start=pd.Timestamp('20191230', tz='utc'),\n    end=pd.Timestamp('20231230', tz='utc'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    bundle='tquant',\n    capital_base=capital_base\n)\n\nprint(\"\u56de\u6e2c\u5b8c\u6210\uff01\")\n\n# ====================================\n# Pyfolio \u7e3e\u6548\u5206\u6790\n# ====================================\nimport pyfolio as pf\nfrom pyfolio.utils import extract_rets_pos_txn_from_zipline\n\nreturns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\nbenchmark_rets = results.benchmark_return\n\npf.tears.create_full_tear_sheet(\n    returns=returns,\n    positions=positions,\n    transactions=transactions,\n    benchmark_rets=benchmark_rets\n)\n</code></pre>"},{"location":"blocks/fundamentals/case-multifactor/#_6","title":"\ud83d\udcca \u56de\u6e2c\u7d50\u679c\u5206\u6790","text":""},{"location":"blocks/fundamentals/case-multifactor/#_7","title":"\u7b56\u7565\u7279\u6027","text":"<p>\u2705 \u512a\u9ede\uff1a</p> <ul> <li>\u7a69\u5b9a\u8d85\u8d8a\u5927\u76e4\uff1a4 \u5e74\u5e73\u5747\u8d85\u984d\u5831\u916c 4.2%</li> <li>\u98a8\u96aa\u53ef\u63a7\uff1a\u9078\u80a1\u689d\u4ef6\u56b4\u683c\uff0c\u907f\u958b\u8ca1\u52d9\u98a8\u96aa\u9ad8\u7684\u516c\u53f8</li> <li>\u4f4e\u9031\u8f49\u7387\uff1a\u5b63\u5ea6\u8abf\u5009\uff0c\u4ea4\u6613\u6210\u672c\u4f4e</li> </ul> <p>\u26a0\ufe0f \u7f3a\u9ede\uff1a</p> <ul> <li>\u6700\u5927\u56de\u64a4\u7565\u9ad8\u65bc\u5927\u76e4\uff1a\u9700\u5fcd\u53d7\u77ed\u671f\u6ce2\u52d5</li> <li>\u9078\u80a1\u6578\u91cf\u6ce2\u52d5\uff1a\u67d0\u4e9b\u5b63\u5ea6\u53ef\u80fd\u53ea\u9078\u51fa 5-10 \u6a94</li> <li>\u5c0d\u6210\u9577\u80a1\u53c3\u8207\u5ea6\u4f4e\uff1a\u50f9\u503c\u5c0e\u5411\u7b56\u7565\uff0c\u53ef\u80fd\u932f\u904e\u6210\u9577\u80a1\u884c\u60c5</li> </ul>"},{"location":"blocks/fundamentals/case-multifactor/#_8","title":"\ud83d\udd0d \u95dc\u9375\u5b78\u7fd2\u9ede","text":""},{"location":"blocks/fundamentals/case-multifactor/#1_2","title":"1. \u907f\u514d\u524d\u8996\u504f\u5dee\u7684\u5be6\u4f5c","text":"<pre><code># \u274c \u932f\u8aa4\u5beb\u6cd5\nif backtest_date == rebalance_date:\n    tickers = compute_stock(backtest_date, data__)\n    for t in tickers:\n        order_target_percent(symbol(t), weight)  # \u7576\u5929\u5c31\u4e0b\u55ae\uff01\n\n# \u2705 \u6b63\u78ba\u5beb\u6cd5\nif backtest_date == rebalance_date:\n    context.state = True  # \u6a19\u8a18\u660e\u5929\u8981\u63db\u80a1\n    context.order_tickers = compute_stock(backtest_date, data__)\n\nif context.state == True:  # \u9694\u5929\u624d\u57f7\u884c\n    for t in context.order_tickers:\n        order_target_percent(symbol(t), weight)\n    context.state = False\n</code></pre>"},{"location":"blocks/fundamentals/case-multifactor/#2_1","title":"2. \u7522\u696d\u4e2d\u6027\u5316\u7684\u91cd\u8981\u6027","text":"<pre><code># \u274c \u76f4\u63a5\u6bd4\u8f03\u5168\u5e02\u5834\ndf['\u672c\u76ca\u6bd4'] &lt; df['\u672c\u76ca\u6bd4'].mean()  # \u79d1\u6280\u80a1\u6703\u5168\u8ecd\u8986\u6c92\n\n# \u2705 \u7522\u696d\u5167\u6bd4\u8f03\ndf.groupby('\u7522\u696d')['\u672c\u76ca\u6bd4'].transform('mean')  # \u6bcf\u500b\u7522\u696d\u5404\u81ea\u7af6\u722d\n</code></pre>"},{"location":"blocks/fundamentals/case-multifactor/#3","title":"3. \u55ae\u4f4d\u9677\u9631","text":"<pre><code># \u26a0\ufe0f \u6ce8\u610f\u767e\u5206\u6bd4\u55ae\u4f4d\ndf['\u71df\u6536\u6210\u9577\u7387_A']  # \u53ef\u80fd\u662f 15\uff08\u4ee3\u8868 15%\uff09\ndf['\u73fe\u91d1\u80a1\u5229\u7387']    # \u53ef\u80fd\u662f 5\uff08\u4ee3\u8868 5%\uff09\n\n# \u6b63\u78ba\u505a\u6cd5\uff1a\u7d71\u4e00\u63db\u7b97\ndf['\u71df\u6536\u6210\u9577\u7387_A'] * 0.01 + df['\u73fe\u91d1\u80a1\u5229\u7387'] * 0.01 &gt; 0.1\n</code></pre>"},{"location":"blocks/fundamentals/case-multifactor/#_9","title":"\ud83c\udfaf \u5ef6\u4f38\u512a\u5316\u65b9\u5411","text":""},{"location":"blocks/fundamentals/case-multifactor/#1_3","title":"\u512a\u5316 1: \u52d5\u614b\u6b0a\u91cd\u914d\u7f6e","text":"<p>\u76ee\u524d\u662f\u7b49\u6b0a\u91cd\uff0c\u53ef\u6539\u70ba\uff1a <pre><code># \u6309\u5e02\u503c\u52a0\u6b0a\nweights = df.loc[context.order_tickers, '\u5e02\u503c'] / df.loc[context.order_tickers, '\u5e02\u503c'].sum()\n\n# \u6309\u56e0\u5b50\u5f97\u5206\u52a0\u6b0a\ndf['\u7d9c\u5408\u5206\u6578'] = df['\u672c\u76ca\u6bd4\u6392\u540d'] + df['ROE\u6392\u540d'] + ...\n</code></pre></p>"},{"location":"blocks/fundamentals/case-multifactor/#2_2","title":"\u512a\u5316 2: \u589e\u52a0\u52d5\u614b\u689d\u4ef6","text":"<pre><code># \u6839\u64da\u5e02\u5834\u74b0\u5883\u8abf\u6574\u689d\u4ef6\nif market_pe &gt; historical_pe.quantile(0.8):  # \u5e02\u5834\u904e\u71b1\n    min_score = 4  # \u63d0\u9ad8\u9580\u6abb\nelse:\n    min_score = 3\n</code></pre>"},{"location":"blocks/fundamentals/case-multifactor/#3_1","title":"\u512a\u5316 3: \u52a0\u5165\u505c\u640d\u6a5f\u5236","text":"<pre><code># \u500b\u80a1\u505c\u640d\nif current_price &lt; buy_price * 0.9:  # \u8dcc\u7834 10%\n    order_target_percent(symbol(ticker), 0)\n</code></pre>"},{"location":"blocks/fundamentals/case-multifactor/#_10","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6a21\u677f\u9801\u9762\uff1atemplate.md - \u67e5\u770b\u53ef\u91cd\u7528\u6a21\u677f</li> <li>\u5176\u4ed6\u6848\u4f8b\uff1a</li> <li>\u5c0f\u578b\u6210\u9577\u80a1 - \u6392\u540d\u6cd5\u7bc4\u4f8b</li> <li>Dreman \u9006\u5411\u6295\u8cc7 - \u8a08\u5206\u6cd5\u7bc4\u4f8b</li> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md - \u7406\u89e3\u8a2d\u8a08\u539f\u7406</li> </ul>"},{"location":"blocks/fundamentals/case-multifactor/#_11","title":"\ud83d\udca1 \u7e3d\u7d50","text":"<p>\u9019\u500b\u591a\u56e0\u5b50\u9078\u80a1\u7b56\u7565\u5c55\u793a\u4e86\u8ca1\u5831\u9078\u80a1\u67b6\u69cb\u7684\u6838\u5fc3\u512a\u52e2\uff1a</p> <ol> <li>\u2705 \u908f\u8f2f\u6e05\u6670\uff1a5 \u500b\u689d\u4ef6\u4e00\u76ee\u4e86\u7136</li> <li>\u2705 \u6613\u65bc\u8abf\u8a66\uff1a<code>compute_stock()</code> \u7368\u7acb\u904b\u7b97</li> <li>\u2705 \u907f\u514d\u504f\u5dee\uff1a<code>context.state</code> \u5ef6\u9072\u4e0b\u55ae</li> <li>\u2705 \u7522\u696d\u4e2d\u6027\uff1a\u907f\u514d\u7522\u696d\u504f\u597d</li> </ol> <p>\u9069\u5408\u8ab0\u4f7f\u7528\uff1f - \u50f9\u503c\u6295\u8cc7\u8005 - \u504f\u597d\u4f4e\u9031\u8f49\u7387\u7684\u9577\u671f\u6295\u8cc7 - \u9700\u8981\u7a69\u5b9a\u8d85\u984d\u5831\u916c\u7684\u6a5f\u69cb\u6295\u8cc7\u4eba</p> <p>\ud83d\udc49 Next Step: \u8907\u88fd\u5b8c\u6574\u7a0b\u5f0f\u78bc\u5230\u4f60\u7684 Jupyter Notebook\uff0c\u4fee\u6539\u9078\u80a1\u689d\u4ef6\uff0c\u958b\u59cb\u4f60\u7684\u7b2c\u4e00\u500b\u7b56\u7565\uff01</p>"},{"location":"blocks/fundamentals/case-smallcap/","title":"\u6848\u4f8b 2\uff1a\u5c0f\u578b\u6210\u9577\u80a1\u7b56\u7565","text":"<p>\u7b56\u7565\u985e\u578b\uff1a \u8ca1\u5831\u9078\u80a1\u67b6\u69cb - \u6392\u540d\u6cd5 \u8abf\u5009\u983b\u7387\uff1a \u56fa\u5b9a\u9031\u671f\uff08\u9810\u8a2d 20 \u5929\uff09 \u80a1\u7968\u6c60\uff1a \u53f0\u7063\u4e0a\u5e02 + \u4e0a\u6ac3\u666e\u901a\u80a1 \u56de\u6e2c\u671f\u9593\uff1a 2015-01-01 ~ 2025-05-27</p>"},{"location":"blocks/fundamentals/case-smallcap/#_1","title":"\ud83d\udccc \u7b56\u7565\u6982\u8ff0","text":"<p>\u9019\u662f\u4e00\u500b\u5c08\u6ce8\u65bc \u5c0f\u578b\u6210\u9577\u80a1 \u7684\u91cf\u5316\u7b56\u7565\uff0c\u6838\u5fc3\u7406\u5ff5\u662f\uff1a</p> <p>\u5728\u5e02\u503c\u8f03\u5c0f\u7684\u516c\u53f8\u4e2d\uff0c\u627e\u51fa\u9ad8\u6210\u9577\u4e14\u4f30\u503c\u5408\u7406\u7684\u6a19\u7684\u3002</p> <p>\u5c0f\u578b\u80a1\u901a\u5e38\u5177\u6709\uff1a</p> <ul> <li>\ud83d\udcc8 \u66f4\u9ad8\u7684\u6210\u9577\u6f5b\u529b</li> <li>\ud83d\udc8e \u5e02\u5834\u95dc\u6ce8\u5ea6\u4f4e\uff0c\u5b58\u5728\u5b9a\u50f9\u932f\u8aa4</li> <li>\u26a1 \u6ce2\u52d5\u8f03\u5927\uff0c\u9700\u8981\u56b4\u683c\u7be9\u9078</li> </ul>"},{"location":"blocks/fundamentals/case-smallcap/#_2","title":"\u7b56\u7565\u7279\u8272","text":"<ol> <li>\u591a\u689d\u4ef6\u7be9\u9078 \u2192 \u6392\u540d\u6cd5\u9078\u80a1\uff1a\u5148\u7528 5 \u500b\u689d\u4ef6\u904e\u6ffe\uff0c\u518d\u6309 PEG \u6392\u5e8f\u53d6\u524d 20%</li> <li>\u98a8\u96aa\u504f\u597d\u76e3\u63a7\uff1a\u8ffd\u8e64 OTC/TSE \u6bd4\u7387\uff0c\u5224\u65b7\u5e02\u5834\u5c0d\u5c0f\u578b\u80a1\u7684\u614b\u5ea6</li> <li>\u69d3\u687f\u63a7\u5236\uff1a\u7576\u69d3\u687f &gt; 1.2 \u6642\u81ea\u52d5\u8abf\u964d\u90e8\u4f4d</li> </ol>"},{"location":"blocks/fundamentals/case-smallcap/#_3","title":"\ud83c\udfaf \u9078\u80a1\u689d\u4ef6\u8a73\u89e3","text":""},{"location":"blocks/fundamentals/case-smallcap/#15","title":"\u968e\u6bb5 1\uff1a\u57fa\u672c\u7be9\u9078\uff085 \u500b\u689d\u4ef6\uff09","text":""},{"location":"blocks/fundamentals/case-smallcap/#1-30","title":"\u689d\u4ef6 1: \u5c0f\u578b\u80a1\u904e\u6ffe\uff08\u5e02\u503c \u2264 \u5e73\u5747\u503c \u00d7 30%\uff09","text":"<p><pre><code>df['avg_mkt'] = df.groupby('mdate')['Market_Cap_Dollars'].transform('mean')\nset_1 = set(df[df['Market_Cap_Dollars'] &lt;= df['avg_mkt'] * 0.3]['coid'])\n</code></pre> \u908f\u8f2f\uff1a \u5c08\u6ce8\u65bc\u5e02\u503c\u8f03\u5c0f\u7684\u516c\u53f8\uff0c\u9019\u4e9b\u516c\u53f8\u901a\u5e38\u88ab\u5927\u578b\u6a5f\u69cb\u6295\u8cc7\u8005\u5ffd\u8996\u3002</p>"},{"location":"blocks/fundamentals/case-smallcap/#2-15","title":"\u689d\u4ef6 2: \u9ad8\u6210\u9577\uff08\u6de8\u5229\u6210\u9577\u7387 \u2265 15%\uff09","text":"<p><pre><code>set_2 = set(df[df['Net_Income_Growth_Rate_Q'] &gt;= 15]['coid'])\n</code></pre> \u908f\u8f2f\uff1a \u55ae\u5b63\u6de8\u5229\u6210\u9577\u7387\u81f3\u5c11 15%\uff0c\u78ba\u4fdd\u516c\u53f8\u8655\u65bc\u5feb\u901f\u6210\u9577\u671f\u3002</p>"},{"location":"blocks/fundamentals/case-smallcap/#3","title":"\u689d\u4ef6 3: \u6bdb\u5229\u7387 \u2265 \u7522\u696d\u5e73\u5747","text":"<p><pre><code>df['ind_gross_margin_mean'] = df.groupby(['mdate', 'Industry'])['Gross_Margin_Rate_percent_Q'].transform('mean')\nset_3 = set(df[df['Gross_Margin_Rate_percent_TTM'] &gt;= df['ind_gross_margin_mean']]['coid'])\n</code></pre> \u908f\u8f2f\uff1a \u9ad8\u6bdb\u5229\u7387\u4ee3\u8868\u7522\u54c1\u7af6\u722d\u529b\u5f37\uff0c\u5b9a\u50f9\u6b0a\u9ad8\u3002</p>"},{"location":"blocks/fundamentals/case-smallcap/#4","title":"\u689d\u4ef6 4: \u8463\u76e3\u6301\u80a1 &gt; \u5e02\u5834\u5e73\u5747","text":"<p><pre><code>df['avg_ds_ratio'] = df.groupby('mdate')['Director_and_Supervisor_Holdings_Percentage'].transform('mean')\nset_4 = set(df[df['Director_and_Supervisor_Holdings_Percentage'] &gt; df['avg_ds_ratio']]['coid'])\n</code></pre> \u908f\u8f2f\uff1a \u5167\u90e8\u4eba\u6301\u80a1\u9ad8\uff0c\u4ee3\u8868\u5c0d\u516c\u53f8\u4fe1\u5fc3\u8db3\uff0c\u5229\u76ca\u8207\u80a1\u6771\u4e00\u81f4\u3002</p>"},{"location":"blocks/fundamentals/case-smallcap/#5-peg-10","title":"\u689d\u4ef6 5: PEG &lt; 1.0\uff08\u6210\u9577\u5408\u7406\u4f30\u503c\uff09","text":"<p><pre><code>df['PEG'] = df['PER_TWSE'] / df['Operating_Income_Growth_Rate_TTM']\nset_5 = set(df[df['PEG'] &lt; 1.0]['coid'])\n</code></pre> \u908f\u8f2f\uff1a PEG = \u672c\u76ca\u6bd4 / \u6210\u9577\u7387\uff0c&lt; 1 \u4ee3\u8868\u4f30\u503c\u76f8\u5c0d\u6210\u9577\u7387\u4fbf\u5b9c\u3002</p>"},{"location":"blocks/fundamentals/case-smallcap/#2_1","title":"\u968e\u6bb5 2\uff1a\u6392\u540d\u6cd5\u9078\u80a1","text":"<pre><code>passed = set_1 &amp; set_2 &amp; set_3 &amp; set_4 &amp; set_5\ntop_n = int(len(passed) * 0.2)  # \u53d6\u524d 20%\n\nfiltered_df = df[df['coid'].isin(passed)]\ntop_df = filtered_df.sort_values(by='PEG').head(top_n)  # PEG \u6700\u5c0f\u7684\u524d 20%\n\ntickers = list(top_df['coid'])\n</code></pre> <p>\u6838\u5fc3\u601d\u60f3\uff1a \u4e0d\u662f\u6240\u6709\u901a\u904e\u689d\u4ef6\u7684\u80a1\u7968\u90fd\u8cb7\uff0c\u800c\u662f\u6311\u51fa PEG \u6700\u4f4e\uff08\u6700\u4fbf\u5b9c\uff09\u7684\u524d 20%\u3002</p>"},{"location":"blocks/fundamentals/case-smallcap/#_4","title":"\ud83d\udcbb \u5b8c\u6574\u7a0b\u5f0f\u78bc","text":"<pre><code># ====================================\n# \u5c0f\u578b\u6210\u9577\u80a1\u7b56\u7565 - \u5b8c\u6574\u5be6\u4f5c\n# ====================================\n\nimport pandas as pd\nimport numpy as np\nimport tejapi\nimport os\nimport json\nimport matplotlib.pyplot as plt\n\nplt.rcParams['font.family'] = 'Arial'\n\n# ====================================\n# TEJ API \u8a2d\u5b9a\n# ====================================\ntej_key = 'your_key'\ntejapi.ApiConfig.api_key = tej_key\nos.environ['TEJAPI_BASE'] = \"https://api.tej.com.tw\"\nos.environ['TEJAPI_KEY'] = tej_key\n\n# ====================================\n# \u53c3\u6578\u8a2d\u5b9a\n# ====================================\nstart_date = '2015-01-01'\nend_date = '2025-05-27'\nback_start = '2015-01-01'  # \u5be6\u969b\u56de\u6e2c\u8d77\u59cb\u65e5\nrebalance_freq = 20        # \u8abf\u5009\u983b\u7387\uff08\u5929\uff09\n\n# ====================================\n# \u80a1\u7968\u6c60\u8a2d\u5b9a\n# ====================================\nfrom zipline.sources.TEJ_Api_Data import get_universe\n\npool = get_universe(\n    start=start_date,\n    end=end_date,\n    mkt_bd_e=['TSE', 'OTC'],\n    stktp_e=['Common Stock-Foreign', 'Common Stock']\n)\n\nprint(f\"\u80a1\u7968\u6c60: {len(pool)} \u6a94\")\n\n# ====================================\n# \u8ca1\u5831\u6578\u64da\u4e0b\u8f09\n# ====================================\nimport TejToolAPI\n\ncolumns = [\n    'coid',       # \u80a1\u7968\u4ee3\u78bc\n    'Industry',   # \u7522\u696d\u5225\n    'roi',        # \u6295\u8cc7\u5831\u916c\u7387\n    'mktcap',     # \u5e02\u503c\n    'r403',       # \u71df\u696d\u5229\u76ca\u6210\u9577\u7387\n    'r405',       # \u6de8\u5229\u6210\u9577\u7387\n    'per',        # \u672c\u76ca\u6bd4\n    'r105',       # \u6bdb\u5229\u7387\n    'fld005'      # \u8463\u76e3\u6301\u80a1\u6bd4\u7387\n]\n\nstart_dt = pd.Timestamp(start_date, tz='UTC')\nend_dt = pd.Timestamp(end_date, tz='UTC')\n\ndata_use = TejToolAPI.get_history_data(\n    start=start_dt,\n    end=end_dt,\n    ticker=pool + ['IR0001'],\n    fin_type=['Q', 'TTM'],\n    columns=columns,\n    transfer_to_chinese=False\n)\n\n# ====================================\n# \u6578\u64da\u9810\u8655\u7406\n# ====================================\ndata_use = data_use.sort_values(['mdate', 'coid'])\n\n# \u8a08\u7b97\u5168\u5e02\u5834\u5e73\u5747\u503c\ndata_use['avg_mkt'] = data_use.groupby('mdate')['Market_Cap_Dollars'].transform('mean')\ndata_use['avg_ds_ratio'] = data_use.groupby('mdate')['Director_and_Supervisor_Holdings_Percentage'].transform('mean')\n\n# \u8a08\u7b97\u7522\u696d\u5e73\u5747\u6bdb\u5229\u7387\ndata_use['ind_gross_margin_mean'] = data_use.groupby(['mdate', 'Industry'])['Gross_Margin_Rate_percent_Q'].transform('mean')\n\n# \u8a08\u7b97 PEG\ndata_use['PEG'] = data_use['PER_TWSE'] / data_use['Operating_Income_Growth_Rate_TTM']\n\nprint(f\"\u6578\u64da\u7b46\u6578: {len(data_use):,}\")\n\n# ====================================\n# \u9078\u80a1\u51fd\u6578\n# ====================================\ndef compute_stock(date, data):\n    \"\"\"\n    \u5c0f\u578b\u6210\u9577\u80a1\u9078\u80a1\u51fd\u6578\n\n    Returns:\n    --------\n    tickers : list\n        \u5165\u9078\u80a1\u7968\u4ee3\u78bc\n    sets : list\n        \u5404\u689d\u4ef6\u901a\u904e\u6578\u91cf\uff08\u7528\u65bc\u76e3\u63a7\uff09\n    \"\"\"\n    df = data[data['mdate'] == pd.to_datetime(date)].reset_index(drop=True)\n\n    # \u689d\u4ef6 1: \u5c0f\u578b\u80a1\uff08\u5e02\u503c \u2264 \u5e73\u5747 \u00d7 30%\uff09\n    set_1 = set(df[df['Market_Cap_Dollars'] &lt;= df['avg_mkt'] * 0.3]['coid'])\n\n    # \u689d\u4ef6 2: \u9ad8\u6210\u9577\uff08\u6de8\u5229\u6210\u9577 \u2265 15%\uff09\n    set_2 = set(df[df['Net_Income_Growth_Rate_Q'] &gt;= 15]['coid'])\n\n    # \u689d\u4ef6 3: \u6bdb\u5229\u7387 \u2265 \u7522\u696d\u5e73\u5747\n    set_3 = set(df[df['Gross_Margin_Rate_percent_TTM'] &gt;= df['ind_gross_margin_mean']]['coid'])\n\n    # \u689d\u4ef6 4: \u8463\u76e3\u6301\u80a1 &gt; \u5e02\u5834\u5e73\u5747\n    set_4 = set(df[df['Director_and_Supervisor_Holdings_Percentage'] &gt; df['avg_ds_ratio']]['coid'])\n\n    # \u689d\u4ef6 5: PEG &lt; 1.0\n    set_5 = set(df[df['PEG'] &lt; 1.0]['coid'])\n\n    # \u53d6\u4ea4\u96c6\n    passed = set_1 &amp; set_2 &amp; set_3 &amp; set_5 &amp; set_4\n\n    # \u6392\u540d\u6cd5\uff1a\u53d6\u524d 20%\n    top_n = int(len(passed) * 0.2)\n\n    filtered_df = df[df['coid'].isin(passed)]\n    top_df = filtered_df.sort_values(by='PEG').head(top_n)\n\n    tickers = list(top_df['coid'])\n    sets = [len(set_1), len(set_2), len(set_3), len(set_4), len(set_5)]\n\n    return tickers, sets\n\n# ====================================\n# \u98a8\u96aa\u504f\u597d\u6307\u6a19\uff08OTC/TSE \u6bd4\u7387\uff09\n# ====================================\ncodes = ['IR0001', 'IR0043']\nco = ['coid', 'Industry', 'mkt', 'vol', 'open_d', 'high_d', 'low_d', 'close_d', \n      'roi', 'shares', 'per', 'pbr_tej', 'mktcap']\n\ndata_index = TejToolAPI.get_history_data(\n    start=start_dt,\n    end=end_dt,\n    ticker=codes,\n    columns=co,\n    transfer_to_chinese=False\n)\n\n# \u7be9\u9078\u6642\u9593\ndata_index = data_index[data_index['mdate'] &gt;= back_start]\n\n# \u5206\u5225\u53d6\u51fa TSE \u8207 OTC \u4e26\u6a19\u6e96\u5316\ntse = data_index[data_index['coid'] == 'IR0001'][['mdate', 'Close']].copy()\notc = data_index[data_index['coid'] == 'IR0043'][['mdate', 'Close']].copy()\n\ntse.rename(columns={'Close': 'TSE_Close'}, inplace=True)\notc.rename(columns={'Close': 'OTC_Close'}, inplace=True)\n\n# \u5408\u4f75\nmerged = pd.merge(tse, otc, on='mdate', how='inner')\n\n# \u6a19\u6e96\u5316\uff1a\u4ee5\u9996\u65e5\u70ba\u57fa\u6e96\nmerged['TSE_norm'] = merged['TSE_Close'] / merged['TSE_Close'].iloc[0] * 100\nmerged['OTC_norm'] = merged['OTC_Close'] / merged['OTC_Close'].iloc[0] * 100\n\n# \u8a08\u7b97\u98a8\u96aa\u504f\u597d\u6bd4\uff08OTC / TSE\uff09\nmerged['OTC_TSE_ratio'] = merged['OTC_norm'] / merged['TSE_norm']\n\n# \u7e6a\u5716\nfig, axes = plt.subplots(2, 1, figsize=(12, 8), sharex=True)\n\naxes[0].plot(merged['mdate'], merged['TSE_norm'], label='TSE')\naxes[0].plot(merged['mdate'], merged['OTC_norm'], label='OTC')\naxes[0].set_title('Normalized Index Performance (Base = 100)')\naxes[0].legend()\naxes[0].grid(True)\n\naxes[1].plot(merged['mdate'], merged['OTC_TSE_ratio'], label='OTC / TSE')\naxes[1].set_title('Risk Appetite Ratio (OTC / TSE)')\naxes[1].axhline(1.0, color='gray', linestyle='--', linewidth=1)\naxes[1].legend()\naxes[1].grid(True)\n\nplt.tight_layout()\nplt.show()\n\n# ====================================\n# \u532f\u5165\u50f9\u91cf\u8cc7\u6599\n# ====================================\nfrom zipline.data.run_ingest import simple_ingest\n\npools = pool + ['IR0001', 'IR0043']\nstart_ingest = start_date.replace('-', '')\nend_ingest = end_date.replace('-', '')\n\nprint('\u958b\u59cb\u532f\u5165\u56de\u6e2c\u8cc7\u6599')\nsimple_ingest(\n    name='tquant',\n    tickers=pools,\n    start_date=start_ingest,\n    end_date=end_ingest\n)\nprint('\u7d50\u675f\u532f\u5165\u56de\u6e2c\u8cc7\u6599')\n\n# ====================================\n# Zipline \u56de\u6e2c\u8a2d\u5b9a\n# ====================================\nfrom zipline.api import (\n    set_slippage, set_commission, set_benchmark,\n    symbol, record, order, order_target, order_value, order_target_percent\n)\nfrom zipline.finance import commission, slippage\nfrom zipline import run_algorithm\n\ndef initialize(context, re=20):\n    \"\"\"\u521d\u59cb\u5316\u51fd\u6578\"\"\"\n    set_slippage(slippage.VolumeShareSlippage(volume_limit=1, price_impact=0.01))\n    set_commission(commission.Custom_TW_Commission())\n    set_benchmark(symbol('IR0001'))\n\n    context.i = 0\n    context.state = False\n    context.order_tickers = []\n    context.last_tickers = []\n    context.rebalance = re  # \u8abf\u5009\u983b\u7387\n    context.dic = {}\n\ndef handle_data(context, data):\n    \"\"\"\u6bcf\u65e5\u57f7\u884c\u51fd\u6578\"\"\"\n    # \u907f\u514d\u524d\u8996\u504f\u5dee\uff0c\u5728\u7be9\u9078\u80a1\u7968\u4e0b\u4e00\u4ea4\u6613\u65e5\u4e0b\u55ae\n    if context.state == True:\n        # \u8ce3\u51fa\u4e0d\u5728\u65b0\u540d\u55ae\u7684\u80a1\u7968\n        for i in context.last_tickers:\n            if i not in context.order_tickers:\n                order_target_percent(symbol(i), 0)\n\n        # \u8cb7\u5165\u65b0\u540d\u55ae\u7684\u80a1\u7968\uff08\u7b49\u6b0a\u91cd\uff09\n        for i in context.order_tickers:\n            order_target_percent(symbol(i), 1.0 / len(context.order_tickers))\n            context.dic[i] = data.current(symbol(i), 'price')\n\n        record(p=context.dic)\n        context.dic = {}\n\n        print(f\"\u4e0b\u55ae\u65e5\u671f\uff1a{data.current_dt.date()}, \u64c7\u80a1\u80a1\u7968\u6578\u91cf\uff1a{len(context.order_tickers)}, Leverage: {context.account.leverage}\")\n\n        context.last_tickers = context.order_tickers.copy()\n        context.state = False\n\n    backtest_date = data.current_dt.date()\n\n    # \u56fa\u5b9a\u9031\u671f\u8abf\u5009\n    if context.i % context.rebalance == 0:\n        context.state = True\n        context.order_tickers = compute_stock(date=backtest_date, data=data_use)[0]\n\n    record(tickers=context.order_tickers)\n    record(Leverage=context.account.leverage)\n\n    # \u69d3\u687f\u76e3\u63a7\uff1a\u8d85\u904e 1.2 \u6642\u8abf\u964d\u90e8\u4f4d\n    if context.account.leverage &gt; 1.2:\n        print(f'{data.current_dt.date()}: Over Leverage, Leverage: {context.account.leverage}')\n        for i in context.order_tickers:\n            order_target_percent(symbol(i), 1 / len(context.order_tickers))\n\n    context.i += 1\n\ndef analyze(context, perf):\n    \"\"\"\u7e3e\u6548\u5206\u6790\u51fd\u6578\"\"\"\n    plt.style.use('ggplot')\n\n    fig1, axes1 = plt.subplots(nrows=3, ncols=1, figsize=(18, 15), sharex=False)\n\n    # \u7b56\u7565 vs \u5927\u76e4\n    axes1[0].plot(perf.index, perf['algorithm_period_return'], label='Strategy')\n    axes1[0].plot(merged['mdate'], (merged['TSE_norm'] / merged['TSE_norm'].iloc[0]) - 1, label='Benchmark [TSE]')\n    axes1[0].plot(merged['mdate'], (merged['OTC_norm'] / merged['OTC_norm'].iloc[0]) - 1, label='Benchmark [OTC]')\n    axes1[0].set_title(\"Backtest Results\")\n    axes1[0].legend()\n\n    # \u8d85\u984d\u5831\u916c\n    axes1[1].bar(perf.index, perf['algorithm_period_return'] - perf['benchmark_period_return'],\n                label='Excess return', color='#988ED5', alpha=1.0)\n    axes1[1].set_title('Excess Return with TSE Index')\n    axes1[1].legend()\n\n    # \u98a8\u96aa\u504f\u597d\u6bd4\u7387\n    axes1[2].plot(merged['mdate'], merged['OTC_TSE_ratio'], label='OTC / TSE')\n    axes1[2].set_title('Risk Appetite Ratio (OTC / TSE)')\n    axes1[2].axhline(1.0, color='gray', linestyle='--', linewidth=1)\n    axes1[2].legend()\n    axes1[2].grid(True)\n\n    plt.tight_layout()\n    plt.show()\n\n# ====================================\n# \u57f7\u884c\u56de\u6e2c\n# ====================================\nresults = run_algorithm(\n    start=pd.Timestamp(back_start, tz='utc'),\n    end=pd.Timestamp(end_date, tz='utc'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    bundle='tquant',\n    capital_base=1e5\n)\n\n\n# ====================================\n# Pyfolio \u7e3e\u6548\u5206\u6790\n# ====================================\nimport pyfolio as pf\nfrom pyfolio.utils import extract_rets_pos_txn_from_zipline\n\nreturns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\nbenchmark_rets = results.benchmark_return\n\npf.tears.create_full_tear_sheet(\n    returns=returns,\n    positions=positions,\n    transactions=transactions,\n    benchmark_rets=benchmark_rets\n)\nprint(\"\u56de\u6e2c\u5b8c\u6210\uff01\")\n</code></pre>"},{"location":"blocks/fundamentals/case-smallcap/#_5","title":"\ud83d\udcca \u7b56\u7565\u7279\u6027\u5206\u6790","text":""},{"location":"blocks/fundamentals/case-smallcap/#_6","title":"\u512a\u52e2 \u2705","text":"<ol> <li> <p>\u5c08\u6ce8\u5c0f\u578b\u6210\u9577\u80a1</p> <ul> <li>\u5e02\u5834\u6548\u7387\u8f03\u4f4e\uff0c\u5bb9\u6613\u767c\u73fe\u932f\u8aa4\u5b9a\u50f9</li> <li>\u6210\u9577\u6f5b\u529b\u5927\uff0c\u53ef\u80fd\u51fa\u73fe\u500d\u6578\u6210\u9577</li> </ul> </li> <li> <p>\u6392\u540d\u6cd5\u964d\u4f4e\u96dc\u8a0a</p> <ul> <li>\u4e0d\u662f\u901a\u904e\u689d\u4ef6\u5c31\u5168\u8cb7\uff0c\u800c\u662f\u6311\u6700\u4fbf\u5b9c\u7684 20%</li> <li>PEG \u6392\u5e8f\u78ba\u4fdd\u4f30\u503c\u5408\u7406</li> </ul> </li> <li> <p>\u98a8\u96aa\u76e3\u63a7\u5b8c\u5584</p> <ul> <li>OTC/TSE \u6bd4\u7387\uff1a\u5224\u65b7\u5e02\u5834\u5c0d\u5c0f\u578b\u80a1\u7684\u504f\u597d</li> <li>\u69d3\u687f\u63a7\u5236\uff1a\u907f\u514d\u904e\u5ea6\u96c6\u4e2d</li> </ul> </li> </ol>"},{"location":"blocks/fundamentals/case-smallcap/#_7","title":"\u98a8\u96aa \u26a0\ufe0f","text":"<ol> <li> <p>\u6ce2\u52d5\u8f03\u5927</p> <ul> <li>\u5c0f\u578b\u80a1\u6d41\u52d5\u6027\u5dee\uff0c\u50f9\u683c\u6ce2\u52d5\u5287\u70c8</li> <li>\u9700\u8981\u8f03\u9ad8\u7684\u98a8\u96aa\u627f\u53d7\u5ea6</li> </ul> </li> <li> <p>\u9078\u80a1\u6578\u91cf\u4e0d\u7a69\u5b9a</p> <ul> <li>\u67d0\u4e9b\u6642\u671f\u53ef\u80fd\u53ea\u9078\u51fa 2-3 \u6a94</li> <li>\u9700\u8981\u8a2d\u5b9a\u6700\u4f4e\u6301\u80a1\u6578\u91cf</li> </ul> </li> <li> <p>\u4ea4\u6613\u6210\u672c</p> <ul> <li>20 \u5929\u8abf\u5009\u983b\u7387\u8f03\u9ad8</li> <li>\u5c0d\u624b\u7e8c\u8cbb\u654f\u611f</li> </ul> </li> </ol>"},{"location":"blocks/fundamentals/case-smallcap/#_8","title":"\ud83d\udd0d \u95dc\u9375\u5b78\u7fd2\u9ede","text":""},{"location":"blocks/fundamentals/case-smallcap/#1-vs","title":"1. \u6392\u540d\u6cd5 vs \u4ea4\u96c6\u6cd5","text":"<pre><code># \u4ea4\u96c6\u6cd5\uff1a\u5168\u90e8\u8cb7\ntickers = list(set_1 &amp; set_2 &amp; set_3 &amp; set_4 &amp; set_5)\n\n# \u6392\u540d\u6cd5\uff1a\u6311\u524d 20%\npassed = set_1 &amp; set_2 &amp; set_3 &amp; set_4 &amp; set_5\nfiltered_df = df[df['coid'].isin(passed)]\ntop_df = filtered_df.sort_values(by='PEG').head(int(len(passed) * 0.2))\ntickers = list(top_df['coid'])\n</code></pre> <p>\u4f55\u6642\u7528\u6392\u540d\u6cd5\uff1f - \u901a\u904e\u689d\u4ef6\u7684\u80a1\u7968\u592a\u591a\uff08&gt;30 \u6a94\uff09 - \u5e0c\u671b\u96c6\u4e2d\u5728\u6700\u512a\u8cea\u7684\u6a19\u7684 - \u56e0\u5b50\u6709\u660e\u78ba\u6392\u5e8f\u610f\u7fa9\uff08PEG \u8d8a\u4f4e\u8d8a\u597d\uff09</p>"},{"location":"blocks/fundamentals/case-smallcap/#2-vs","title":"2. \u56fa\u5b9a\u9031\u671f vs \u56fa\u5b9a\u65e5\u671f","text":"<pre><code># \u56fa\u5b9a\u65e5\u671f\uff08\u9700\u4e8b\u5148\u8a08\u7b97\uff09\nif backtest_date in modified_day:\n    context.state = True\n\n# \u56fa\u5b9a\u9031\u671f\uff08\u7528\u8a08\u6578\u5668\uff09\nif context.i % context.rebalance == 0:\n    context.state = True\n</code></pre> <p>\u56fa\u5b9a\u9031\u671f\u7684\u512a\u52e2\uff1a - \u4e0d\u9700\u4e8b\u5148\u8a08\u7b97\u65e5\u671f - \u9069\u5408\u9ad8\u983b\u7b56\u7565 - \u53c3\u6578\u5bb9\u6613\u8abf\u6574</p>"},{"location":"blocks/fundamentals/case-smallcap/#3_1","title":"3. \u69d3\u687f\u76e3\u63a7","text":"<pre><code># \u76e3\u63a7\u69d3\u687f\u6bd4\u7387\nif context.account.leverage &gt; 1.2:\n    # \u8abf\u964d\u90e8\u4f4d\n    for ticker in context.order_tickers:\n        order_target(symbol(ticker), 1 / len(context.order_tickers))\n</code></pre> <p>\u70ba\u4ec0\u9ebc\u9700\u8981\uff1f - \u5c0f\u578b\u80a1\u6ce2\u52d5\u5927\uff0c\u5bb9\u6613\u89f8\u767c\u8ffd\u7e73 - \u4fdd\u8b77\u5e33\u6236\u5b89\u5168 - \u907f\u514d\u5f37\u5236\u5e73\u5009</p>"},{"location":"blocks/fundamentals/case-smallcap/#4-otctse","title":"4. \u98a8\u96aa\u504f\u597d\u6307\u6a19\uff08OTC/TSE \u6bd4\u7387\uff09","text":"<pre><code>merged['OTC_TSE_ratio'] = merged['OTC_norm'] / merged['TSE_norm']\n</code></pre> <p>\u89e3\u8b80\uff1a - \u6bd4\u7387 &gt; 1\uff1a\u5e02\u5834\u504f\u597d\u5c0f\u578b\u80a1\uff08\u98a8\u96aa\u504f\u597d\u4e0a\u5347\uff09 - \u6bd4\u7387 &lt; 1\uff1a\u5e02\u5834\u504f\u597d\u5927\u578b\u80a1\uff08\u907f\u96aa\u60c5\u7dd2\uff09 - \u53ef\u4f5c\u70ba\u7b56\u7565\u958b\u95dc\uff1a\u6bd4\u7387 &lt; 0.95 \u6642\u66ab\u505c\u4ea4\u6613</p>"},{"location":"blocks/fundamentals/case-smallcap/#_9","title":"\ud83c\udfaf \u5ef6\u4f38\u512a\u5316\u65b9\u5411","text":""},{"location":"blocks/fundamentals/case-smallcap/#1","title":"\u512a\u5316 1: \u52d5\u614b\u6301\u80a1\u6578\u91cf","text":"<pre><code># \u6839\u64da OTC/TSE \u6bd4\u7387\u8abf\u6574\u6301\u80a1\u6578\nif merged['OTC_TSE_ratio'].iloc[-1] &gt; 1.05:  # \u5e02\u5834\u504f\u597d\u5c0f\u578b\u80a1\n    top_n = int(len(passed) * 0.3)  # \u591a\u8cb7\u4e00\u4e9b\nelse:\n    top_n = int(len(passed) * 0.15)  # \u4fdd\u5b88\u4e00\u9ede\n</code></pre>"},{"location":"blocks/fundamentals/case-smallcap/#2_2","title":"\u512a\u5316 2: \u52a0\u5165\u6d41\u52d5\u6027\u904e\u6ffe","text":"<pre><code># \u6392\u9664\u6d41\u52d5\u6027\u592a\u5dee\u7684\u80a1\u7968\nset_liquidity = set(df[df['\u6708\u6210\u4ea4\u91cf'] &gt; threshold]['coid'])\npassed = set_1 &amp; set_2 &amp; set_3 &amp; set_4 &amp; set_5 &amp; set_liquidity\n</code></pre>"},{"location":"blocks/fundamentals/case-smallcap/#3_2","title":"\u512a\u5316 3: \u7522\u696d\u5206\u6563","text":"<pre><code># \u6bcf\u500b\u7522\u696d\u6700\u591a\u9078 2 \u6a94\ntop_df_grouped = filtered_df.groupby('Industry').apply(\n    lambda x: x.nsmallest(2, 'PEG')\n)\n</code></pre>"},{"location":"blocks/fundamentals/case-smallcap/#_10","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6a21\u677f\u9801\u9762\uff1atemplate.md - \u6392\u540d\u6cd5\u6a21\u677f</li> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md - \u7406\u89e3\u8a2d\u8a08\u539f\u7406</li> <li>\u5176\u4ed6\u6848\u4f8b\uff1a</li> <li>\u591a\u56e0\u5b50\u9078\u80a1 - \u4ea4\u96c6\u6cd5\u7bc4\u4f8b</li> <li>Dreman \u9006\u5411\u6295\u8cc7 - \u8a08\u5206\u6cd5\u7bc4\u4f8b</li> </ul>"},{"location":"blocks/fundamentals/case-smallcap/#_11","title":"\ud83d\udca1 \u7e3d\u7d50","text":"<p>\u5c0f\u578b\u6210\u9577\u80a1\u7b56\u7565\u5c55\u793a\u4e86 \u6392\u540d\u6cd5 \u7684\u7cbe\u9ad3\uff1a</p> <ol> <li>\u2705 \u964d\u4f4e\u96dc\u8a0a\uff1a\u4e0d\u662f\u5168\u8cb7\uff0c\u6311\u6700\u597d\u7684</li> <li>\u2705 \u98a8\u96aa\u76e3\u63a7\uff1a\u69d3\u687f\u63a7\u5236 + \u5e02\u5834\u60c5\u7dd2\u6307\u6a19</li> <li>\u2705 \u9748\u6d3b\u8abf\u6574\uff1a\u56fa\u5b9a\u9031\u671f\uff0c\u6613\u65bc\u512a\u5316</li> </ol> <p>\u9069\u5408\u8ab0\u4f7f\u7528\uff1f</p> <ul> <li>\u98a8\u96aa\u504f\u597d\u8f03\u9ad8\u7684\u6295\u8cc7\u8005</li> <li>\u504f\u597d\u4e2d\u77ed\u671f\u4ea4\u6613\uff0820 \u5929\u9031\u671f\uff09</li> <li>\u719f\u6089\u5c0f\u578b\u80a1\u7279\u6027\u7684\u4eba</li> </ul> <p>\u26a0\ufe0f \u6ce8\u610f\u4e8b\u9805\uff1a</p> <ul> <li>\u9700\u8981\u8f03\u9ad8\u7684\u8cc7\u91d1\u91cf\uff08\u907f\u514d\u6d41\u52d5\u6027\u554f\u984c\uff09</li> <li>\u5bc6\u5207\u76e3\u63a7\u69d3\u687f\u6bd4\u7387</li> <li>\u5e02\u5834\u6050\u614c\u6642\u61c9\u66ab\u505c\u7b56\u7565</li> </ul> <p>\ud83d\udc49 Next Step: \u524d\u5f80 case-dreman.md \u5b78\u7fd2\u8a08\u5206\u6cd5\u7684\u9032\u968e\u61c9\u7528\uff01</p>"},{"location":"blocks/fundamentals/faq/","title":"\u8ca1\u5831\u9078\u80a1\u67b6\u69cb - \u5e38\u898b\u554f\u984c FAQ","text":"<p>\u672c\u9801\u6574\u7406\u4f7f\u7528\u8ca1\u5831\u9078\u80a1\u67b6\u69cb\u6642\u6700\u5e38\u9047\u5230\u7684\u554f\u984c\u8207\u89e3\u6c7a\u65b9\u6848\u3002</p>"},{"location":"blocks/fundamentals/faq/#_1","title":"\ud83d\udcd1 \u76ee\u9304","text":"<ul> <li>\u57fa\u790e\u6982\u5ff5 </li> <li>\u6578\u64da\u8655\u7406 </li> <li>\u9078\u80a1\u908f\u8f2f </li> <li>\u56de\u6e2c\u8a2d\u5b9a </li> <li>\u9664\u932f\u6280\u5de7 </li> <li>\u6548\u80fd\u512a\u5316 </li> <li>\u5be6\u52d9\u61c9\u7528</li> </ul>"},{"location":"blocks/fundamentals/faq/#basics","title":"\u57fa\u790e\u6982\u5ff5","text":""},{"location":"blocks/fundamentals/faq/#q1-vs-pipeline","title":"Q1: \u8ca1\u5831\u9078\u80a1\u67b6\u69cb vs Pipeline \u67b6\u69cb\uff0c\u6211\u8a72\u9078\u54ea\u500b\uff1f","text":"<p>\u6c7a\u7b56\u6a39\uff1a <pre><code>graph TD\n    A[\u4f60\u7684\u7b56\u7565] --&gt; B{\u80a1\u7968\u6578\u91cf?}\n    B --&gt;|&lt;200 \u6a94| C{\u6578\u64da\u4f86\u6e90?}\n    B --&gt;|&gt;200 \u6a94| D[Pipeline \u67b6\u69cb]\n\n    C --&gt;|TEJ \u8ca1\u5831 API| E[\u8ca1\u5831\u9078\u80a1\u67b6\u69cb \u2705]\n    C --&gt;|\u81ea\u5b9a\u7fa9\u6578\u64da| F{\u719f\u6089 Pipeline?}\n\n    F --&gt;|\u662f| D\n    F --&gt;|\u5426| E\n\n    style E fill:#c8e6c9,stroke:#388e3c,stroke-width:3px</code></pre></p> <p>\u5feb\u901f\u5224\u65b7\uff1a</p> <ul> <li>\u2705 \u7528\u8ca1\u5831\u9078\u80a1\uff1a\u8cc7\u6599\u4f86\u81ea TEJ API\u3001\u8abf\u5009\u983b\u7387\u5b63/\u6708\u3001\u80a1\u7968\u6578 &lt;200</li> <li>\u2705 \u7528 Pipeline\uff1a\u5168\u5e02\u5834\u6383\u63cf\u3001\u81ea\u5b9a\u7fa9\u56e0\u5b50\u3001\u9700\u8981\u6975\u81f4\u6548\u80fd</li> </ul>"},{"location":"blocks/fundamentals/faq/#q2","title":"Q2: \u70ba\u4ec0\u9ebc\u8981\u300c\u4e8b\u524d\u8a08\u7b97 + \u4e8b\u5f8c\u57f7\u884c\u300d\u5206\u96e2\uff1f","text":"<p>\u539f\u56e0 1\uff1a\u907f\u514d\u524d\u8996\u504f\u5dee <pre><code># \u274c \u932f\u8aa4\uff1a\u56de\u6e2c\u6642\u770b\u5230\u7576\u5929\u8ca1\u5831\u5c31\u4e0b\u55ae\nif date == '2023-03-31':\n    tickers = compute_stock('2023-03-31')  # \u7528 3/31 \u8ca1\u5831\n    for t in tickers:\n        order(t, 100)  # 3/31 \u7576\u5929\u5c31\u4e0b\u55ae\uff01\n\n# \u2705 \u6b63\u78ba\uff1a\u770b\u5230\u8ca1\u5831\u5f8c\uff0c\u9694\u5929\u624d\u4e0b\u55ae\nif date == '2023-03-31':\n    context.order_tickers = compute_stock('2023-03-31')\n    context.state = True  # \u6a19\u8a18\u660e\u5929\u57f7\u884c\n\nif context.state == True:  # 4/1 \u624d\u4e0b\u55ae\n    for t in context.order_tickers:\n        order(t, 100)\n</code></pre></p> <p>\u539f\u56e0 2\uff1a\u65b9\u4fbf\u6aa2\u67e5 <pre><code># \u5728\u56de\u6e2c\u5916\u5148\u6e2c\u8a66\u9078\u80a1\u51fd\u6578\ntest_tickers = compute_stock('2023-03-31', data__)\nprint(f\"\u5165\u9078\u80a1\u7968: {test_tickers}\")  # \u78ba\u8a8d\u908f\u8f2f\u6b63\u78ba\u518d\u56de\u6e2c\n</code></pre></p> <p>\u539f\u56e0 3\uff1a\u6548\u80fd\u8003\u91cf <pre><code># \u4e00\u6b21\u7b97\u5b8c\u6240\u6709\u65e5\u671f\uff0c\u6bd4\u5728\u56de\u6e2c\u5167\u91cd\u8907\u8a08\u7b97\u5feb\u5f88\u591a\nall_results = {date: compute_stock(date, data__) for date in modified_day}\n</code></pre></p>"},{"location":"blocks/fundamentals/faq/#q3","title":"Q3: \u4ec0\u9ebc\u6642\u5019\u7528\u4ea4\u96c6\u6cd5 / \u8a08\u5206\u6cd5 / \u6392\u540d\u6cd5\uff1f","text":"\u65b9\u6cd5 \u9069\u7528\u60c5\u5883 \u512a\u9ede \u7f3a\u9ede \u4ea4\u96c6\u6cd5 \u689d\u4ef6\u660e\u78ba\uff083-5 \u500b\uff09 \u908f\u8f2f\u6e05\u6670\u3001\u6613\u7406\u89e3 \u689d\u4ef6\u592a\u56b4\u53ef\u80fd\u9078\u4e0d\u5230\u80a1\u7968 \u8a08\u5206\u6cd5 \u689d\u4ef6\u5f88\u591a\uff08&gt;5 \u500b\uff09 \u9748\u6d3b\u3001\u5bb9\u932f\u6027\u9ad8 \u6b0a\u91cd\u96e3\u4ee5\u8abf\u6574 \u6392\u540d\u6cd5 \u901a\u904e\u8005\u592a\u591a\uff08&gt;30 \u6a94\uff09 \u81ea\u52d5\u7be9\u9078\u6700\u512a \u9700\u8981\u6709\u6392\u5e8f\u6307\u6a19 <p>\u5be6\u52d9\u5efa\u8b70\uff1a <pre><code># Step 1: \u5148\u7528\u4ea4\u96c6\u6cd5\u6e2c\u8a66\ntickers = list(set_1 &amp; set_2 &amp; set_3)\n\n# Step 2: \u5982\u679c\u9078\u592a\u591a\uff0c\u6539\u7528\u6392\u540d\u6cd5\nif len(tickers) &gt; 30:\n    df_filtered = df[df['\u80a1\u7968\u4ee3\u78bc'].isin(tickers)]\n    top_20 = df_filtered.nsmallest(20, 'PEG')\n    tickers = list(top_20['\u80a1\u7968\u4ee3\u78bc'])\n\n# Step 3: \u5982\u679c\u9078\u592a\u5c11\uff0c\u6539\u7528\u8a08\u5206\u6cd5\nif len(tickers) &lt; 5:\n    # \u964d\u4f4e\u6a19\u6e96\uff0c\u5141\u8a31\u67d0\u4e9b\u689d\u4ef6\u4e0d\u7b26\n    tickers = compute_with_scoring(min_score=2)\n</code></pre></p>"},{"location":"blocks/fundamentals/faq/#data-process","title":"\u6578\u64da\u8655\u7406","text":""},{"location":"blocks/fundamentals/faq/#q4","title":"Q4: \u70ba\u4ec0\u9ebc\u6211\u6293\u5230\u7684\u6578\u64da\u662f\u7a7a\u7684\uff1f","text":"<p>\u5e38\u898b\u539f\u56e0\u8207\u89e3\u6c7a\u65b9\u6848\uff1a</p>"},{"location":"blocks/fundamentals/faq/#1","title":"\u539f\u56e0 1: \u65e5\u671f\u683c\u5f0f\u932f\u8aa4","text":"<pre><code># \u274c \u932f\u8aa4\ndata = TejToolAPI.get_history_data(\n    start='2023-01-01',  # \u5b57\u4e32\u683c\u5f0f\n    end='2023-12-31',\n    ...\n)\n\n# \u2705 \u6b63\u78ba\ndata = TejToolAPI.get_history_data(\n    start=pd.Timestamp('2023-01-01', tz='UTC'),  # Timestamp \u683c\u5f0f\n    end=pd.Timestamp('2023-12-31', tz='UTC'),\n    ...\n)\n</code></pre>"},{"location":"blocks/fundamentals/faq/#2","title":"\u539f\u56e0 2: \u80a1\u7968\u6c60\u70ba\u7a7a","text":"<pre><code># \u6aa2\u67e5\u80a1\u7968\u6c60\npool = get_universe(...)\nprint(f\"\u80a1\u7968\u6c60: {len(pool)} \u6a94\")  # \u61c9\u8a72 &gt; 0\nprint(f\"\u7bc4\u4f8b: {pool[:5]}\")\n\n# \u5982\u679c\u70ba\u7a7a\uff0c\u6aa2\u67e5\u7be9\u9078\u689d\u4ef6\npool = get_universe(\n    start=...,\n    end=...,\n    mkt_bd_e=['TSE', 'OTC'],  # \u78ba\u8a8d\u5e02\u5834\u5225\u6b63\u78ba\n    stktp_e='Common Stock'     # \u78ba\u8a8d\u80a1\u7968\u985e\u578b\u6b63\u78ba\n)\n</code></pre>"},{"location":"blocks/fundamentals/faq/#3","title":"\u539f\u56e0 3: \u6b04\u4f4d\u540d\u7a31\u932f\u8aa4","text":"<pre><code># \u274c \u932f\u8aa4\uff1a\u6b04\u4f4d\u540d\u4e0d\u5b58\u5728\ncolumns = ['mktcap', 'PE', 'ROE']  # 'PE' \u61c9\u8a72\u662f 'per'\n\n# \u2705 \u6b63\u78ba\uff1a\u53c3\u8003 TEJ \u6587\u6a94\ncolumns = ['mktcap', 'per', 'r103']  # ROE \u662f r103\n\n# \ud83d\udca1 \u5c0f\u6280\u5de7\uff1a\u5148\u7528 transfer_to_chinese=True \u78ba\u8a8d\u6b04\u4f4d\ndata = TejToolAPI.get_history_data(\n    ...,\n    transfer_to_chinese=True\n)\nprint(data.columns)  # \u67e5\u770b\u6240\u6709\u53ef\u7528\u6b04\u4f4d\n</code></pre>"},{"location":"blocks/fundamentals/faq/#q5","title":"Q5: \u8ca1\u5831\u6578\u64da\u7684\u6642\u9593\u9ede\u600e\u9ebc\u8655\u7406\uff1f","text":"<p>\u95dc\u9375\u6982\u5ff5\uff1a\u8ca1\u5831\u516c\u544a\u5ef6\u9072 <pre><code># \u4f8b\u5982\uff1a2023 Q1 \u8ca1\u5831\uff081-3 \u6708\uff09\n# - \u6703\u8a08\u671f\u9593\u7d50\u675f\uff1a2023-03-31\n# - \u5be6\u969b\u516c\u544a\u65e5\uff1a2023-05-15\uff08\u5ef6\u9072 45 \u5929\uff09\n# - \u53ef\u4f7f\u7528\u65e5\u671f\uff1a2023-05-16 \u4e4b\u5f8c\n\n# \u89e3\u6c7a\u65b9\u6848 1\uff1a\u4f7f\u7528 TEJ \u7684 include_self_acc='Y'\ndata = TejToolAPI.get_history_data(\n    ...,\n    include_self_acc='Y'  # \u5305\u542b\u81ea\u7d50\u6578\uff08\u63d0\u524d 30 \u5929\uff09\n)\n\n# \u89e3\u6c7a\u65b9\u6848 2\uff1a\u624b\u52d5\u5ef6\u9072\ndef compute_stock(date, data, delay_days=45):\n    # \u4f7f\u7528 45 \u5929\u524d\u7684\u8ca1\u5831\n    data_date = date - pd.Timedelta(days=delay_days)\n    df = data[data['\u65e5\u671f'] == data_date]\n    ...\n</code></pre></p> <p>\u6700\u4f73\u5be6\u52d9\uff1a <pre><code># \u7528\u5b63\u5831\u8cc7\u6599\uff0c\u4e26\u8a2d\u5b9a\u5408\u7406\u5ef6\u9072\ndata = TejToolAPI.get_history_data(\n    fin_type='Q',  # \u5b63\u5831\n    include_self_acc='Y'  # \u5305\u542b\u81ea\u7d50\n)\n\n# \u63db\u80a1\u65e5\u8a2d\u5728\u6bcf\u5b63\u5f8c 2 \u500b\u6708\uff08\u5b89\u5168\u908a\u969b\uff09\nrebalance_months = [5, 8, 11, 2]  # Q1\u21925\u6708, Q2\u21928\u6708, Q3\u219211\u6708, Q4\u21922\u6708\n</code></pre></p>"},{"location":"blocks/fundamentals/faq/#q6-nan","title":"Q6: \u5982\u4f55\u8655\u7406\u7f3a\u5931\u503c\uff08NaN\uff09\uff1f","text":"<pre><code>def compute_stock(date, data):\n    df = data[data['\u65e5\u671f'] == date].reset_index(drop=True)\n\n    # \u65b9\u6cd5 1: \u76f4\u63a5\u6392\u9664\u7f3a\u5931\u503c\n    df = df.dropna(subset=['\u672c\u76ca\u6bd4', 'ROE'])\n\n    # \u65b9\u6cd5 2: \u53ea\u5c0d\u6709\u6548\u503c\u8a08\u7b97\u5e73\u5747\n    avg_per = df['\u672c\u76ca\u6bd4'].mean(skipna=True)  # skipna=True \u5ffd\u7565 NaN\n\n    # \u65b9\u6cd5 3: \u586b\u88dc\u7f3a\u5931\u503c\n    df['ROE'].fillna(0, inplace=True)  # \u7528 0 \u586b\u88dc\n\n    # \u65b9\u6cd5 4: \u6aa2\u67e5\u518d\u7be9\u9078\uff08\u6700\u56b4\u8b39\uff09\n    valid_df = df[\n        (df['\u672c\u76ca\u6bd4'].notna()) &amp;    # \u672c\u76ca\u6bd4\u4e0d\u662f NaN\n        (df['\u672c\u76ca\u6bd4'] &gt; 0) &amp;         # \u4e14 &gt; 0\n        (df['\u672c\u76ca\u6bd4'] &lt; 100)         # \u4e14 &lt; 100\uff08\u6392\u9664\u6975\u7aef\u503c\uff09\n    ]\n\n    return list(valid_df['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre> <p>\u63a8\u85a6\u505a\u6cd5\uff1a <pre><code># \u5148\u6e05\u7406\u6578\u64da\uff0c\u518d\u8a08\u7b97\u689d\u4ef6\ndf = df[\n    (df['\u672c\u76ca\u6bd4'].notna()) &amp; \n    (df['\u672c\u76ca\u6bd4'] &gt; 0) &amp; \n    (df['\u672c\u76ca\u6bd4'] &lt; 100)\n].copy()\n\n# \u9019\u6a23\u5f8c\u7e8c\u8a08\u7b97\u4e0d\u6703\u51fa\u932f\navg_per = df['\u672c\u76ca\u6bd4'].mean()\nset_1 = set(df[df['\u672c\u76ca\u6bd4'] &lt; avg_per]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre></p>"},{"location":"blocks/fundamentals/faq/#q7","title":"Q7: \u7522\u696d\u5e73\u5747\u503c\u8a08\u7b97\u6709\u554f\u984c\uff1f","text":"<p>\u5e38\u898b\u932f\u8aa4\uff1a <pre><code># \u274c \u932f\u8aa4\uff1a\u7522\u696d\u5225\u6b04\u4f4d\u662f NaN\ndf['\u7522\u696d\u5e73\u5747\u672c\u76ca\u6bd4'] = df.groupby('\u4e3b\u7522\u696d\u5225_\u4e2d\u6587')['\u672c\u76ca\u6bd4'].transform('mean')\n# \u5982\u679c\u67d0\u4e9b\u80a1\u7968\u6c92\u6709\u7522\u696d\u5225\uff0cgroupby \u6703\u51fa\u932f\n\n# \u2705 \u6b63\u78ba\uff1a\u5148\u8655\u7406\u7f3a\u5931\u503c\ndf['\u4e3b\u7522\u696d\u5225_\u4e2d\u6587'].fillna('\u5176\u4ed6', inplace=True)\ndf['\u7522\u696d\u5e73\u5747\u672c\u76ca\u6bd4'] = df.groupby('\u4e3b\u7522\u696d\u5225_\u4e2d\u6587')['\u672c\u76ca\u6bd4'].transform('mean')\n</code></pre></p> <p>Debug \u6280\u5de7\uff1a <pre><code># \u6aa2\u67e5\u7522\u696d\u5206\u4f48\nprint(df['\u4e3b\u7522\u696d\u5225_\u4e2d\u6587'].value_counts())\n\n# \u6aa2\u67e5\u6bcf\u500b\u7522\u696d\u7684\u5e73\u5747\u503c\nindustry_avg = df.groupby('\u4e3b\u7522\u696d\u5225_\u4e2d\u6587')['\u672c\u76ca\u6bd4'].mean()\nprint(industry_avg)\n\n# \u6aa2\u67e5\u662f\u5426\u6709\u7522\u696d\u53ea\u6709 1 \u6a94\u80a1\u7968\nsmall_industries = industry_avg[industry_avg.index.isin(\n    df['\u4e3b\u7522\u696d\u5225_\u4e2d\u6587'].value_counts()[df['\u4e3b\u7522\u696d\u5225_\u4e2d\u6587'].value_counts() &lt; 3].index\n)]\nprint(f\"\u5c0f\u7522\u696d\uff08&lt;3 \u6a94\uff09: {small_industries}\")\n</code></pre></p>"},{"location":"blocks/fundamentals/faq/#logic","title":"\u9078\u80a1\u908f\u8f2f","text":""},{"location":"blocks/fundamentals/faq/#q8","title":"Q8: \u70ba\u4ec0\u9ebc\u6211\u9078\u4e0d\u5230\u4efb\u4f55\u80a1\u7968\uff1f","text":"<p>\u8a3a\u65b7\u6b65\u9a5f\uff1a <pre><code>def compute_stock_debug(date, data):\n    df = data[data['\u65e5\u671f'] == pd.Timestamp(date)].reset_index(drop=True)\n\n    print(f\"\\n========== Debug {date} ==========\")\n    print(f\"\u7e3d\u80a1\u7968\u6578: {len(df)}\")\n\n    # \u9010\u689d\u4ef6\u6aa2\u67e5\n    set_1 = set(df[df['\u672c\u76ca\u6bd4'] &lt; df['\u672c\u76ca\u6bd4'].mean()]['\u80a1\u7968\u4ee3\u78bc'])\n    print(f\"\u689d\u4ef6 1 \u901a\u904e: {len(set_1)} \u6a94\")\n\n    set_2 = set(df[df['\u6d41\u52d5\u6bd4\u7387'] &gt; 1.0]['\u80a1\u7968\u4ee3\u78bc'])\n    print(f\"\u689d\u4ef6 2 \u901a\u904e: {len(set_2)} \u6a94\")\n\n    set_3 = set(df[df['\u8ca0\u50b5\u6bd4'] &lt; 0.5]['\u80a1\u7968\u4ee3\u78bc'])\n    print(f\"\u689d\u4ef6 3 \u901a\u904e: {len(set_3)} \u6a94\")\n\n    # \u9010\u6b65\u53d6\u4ea4\u96c6\n    temp = set_1 &amp; set_2\n    print(f\"\u689d\u4ef6 1 &amp; 2: {len(temp)} \u6a94\")\n\n    final = temp &amp; set_3\n    print(f\"\u689d\u4ef6 1 &amp; 2 &amp; 3: {len(final)} \u6a94\")\n\n    if len(final) == 0:\n        print(\"\u26a0\ufe0f \u8b66\u544a\uff1a\u7121\u80a1\u7968\u901a\u904e\u6240\u6709\u689d\u4ef6\")\n        print(\"\u5efa\u8b70\uff1a\u653e\u5bec\u67d0\u4e9b\u689d\u4ef6\u6216\u6539\u7528\u8a08\u5206\u6cd5\")\n\n    return list(final)\n</code></pre></p> <p>\u5e38\u898b\u89e3\u6c7a\u65b9\u6848\uff1a</p> <ol> <li> <p>\u689d\u4ef6\u592a\u56b4\u683c \u2192 \u653e\u5bec <pre><code># \u539f\u672c\uff1a\u8ca0\u50b5\u6bd4 &lt; 20%\nset_3 = set(df[df['\u8ca0\u50b5\u6bd4'] &lt; 0.2]['\u80a1\u7968\u4ee3\u78bc'])\n\n# \u653e\u5bec\uff1a\u8ca0\u50b5\u6bd4 &lt; 50%\nset_3 = set(df[df['\u8ca0\u50b5\u6bd4'] &lt; 0.5]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre></p> </li> <li> <p>\u4ea4\u96c6\u6cd5 \u2192 \u8a08\u5206\u6cd5 <pre><code># \u81f3\u5c11\u6eff\u8db3 3 \u500b\u689d\u4ef6\u5373\u53ef\nscore = (\n    (ticker in set_1).astype(int) +\n    (ticker in set_2).astype(int) +\n    (ticker in set_3).astype(int)\n)\nselected = df[score &gt;= 3]['\u80a1\u7968\u4ee3\u78bc'].tolist()\n</code></pre></p> </li> <li> <p>\u4f7f\u7528\u52d5\u614b\u9580\u6abb <pre><code># \u6839\u64da\u5e02\u6cc1\u8abf\u6574\nif market_condition == 'bull':\n    min_score = 4  # \u725b\u5e02\u56b4\u683c\nelse:\n    min_score = 2  # \u718a\u5e02\u5bec\u9b06\n</code></pre></p> </li> </ol>"},{"location":"blocks/fundamentals/faq/#q9","title":"Q9: \u5982\u4f55\u8a2d\u8a08\u5408\u7406\u7684\u9078\u80a1\u689d\u4ef6\uff1f","text":"<p>SMART \u539f\u5247\uff1a</p> <ul> <li>S pecific\uff08\u5177\u9ad4\uff09\uff1a\u300cROE \u9ad8\u300d\u2192\u300cROE &gt; 15%\u300d</li> <li>M easurable\uff08\u53ef\u91cf\u5316\uff09\uff1a\u907f\u514d\u4e3b\u89c0\u689d\u4ef6</li> <li>A chievable\uff08\u53ef\u9054\u6210\uff09\uff1a\u4e0d\u8981\u592a\u56b4\u683c\uff08\u5982 ROE &gt; 50%\uff09</li> <li>R elevant\uff08\u76f8\u95dc\uff09\uff1a\u689d\u4ef6\u8981\u5c0d\u5831\u916c\u6709\u89e3\u91cb\u529b</li> <li>T ime-bound\uff08\u6709\u6642\u6548\uff09\uff1a\u8003\u616e\u8ca1\u5831\u5ef6\u9072</li> </ul> <p>\u5efa\u8b70\u6d41\u7a0b\uff1a <pre><code># Step 1: \u55ae\u8b8a\u91cf\u6e2c\u8a66\uff08\u6bcf\u500b\u689d\u4ef6\u7368\u7acb\u6e2c\u8a66\uff09\nfor condition in [\u689d\u4ef61, \u689d\u4ef62, \u689d\u4ef63]:\n    backtest_single_condition(condition)\n    # \u770b\u54ea\u4e9b\u689d\u4ef6\u6709\u6548\n\n# Step 2: \u96d9\u8b8a\u91cf\u6e2c\u8a66\uff08\u5169\u5169\u7d44\u5408\uff09\nfor c1, c2 in combinations([\u689d\u4ef61, \u689d\u4ef62, \u689d\u4ef63], 2):\n    backtest_two_conditions(c1, c2)\n    # \u627e\u51fa\u5354\u540c\u6548\u61c9\n\n# Step 3: \u591a\u8b8a\u91cf\u6e2c\u8a66\uff08\u5168\u90e8\u7d44\u5408\uff09\nbacktest_all_conditions()\n</code></pre></p> <p>\u7d93\u9a57\u6cd5\u5247\uff1a</p> <ul> <li>\u4f30\u503c\u56e0\u5b50\uff08\u672c\u76ca\u6bd4\u3001\u80a1\u50f9\u6de8\u503c\u6bd4\uff09\uff1a\u5fc5\u5099</li> <li>\u54c1\u8cea\u56e0\u5b50\uff08ROE\u3001\u6bdb\u5229\u7387\uff09\uff1a\u5efa\u8b70\u6709</li> <li>\u6210\u9577\u56e0\u5b50\uff08\u71df\u6536\u6210\u9577\u3001EPS \u6210\u9577\uff09\uff1a\u52a0\u5206\u9805</li> <li>\u52d5\u80fd\u56e0\u5b50\uff08\u80a1\u50f9\u8da8\u52e2\uff09\uff1a\u53ef\u9078</li> </ul>"},{"location":"blocks/fundamentals/faq/#q10","title":"Q10: \u689d\u4ef6\u4e4b\u9593\u6709\u885d\u7a81\u600e\u9ebc\u8fa6\uff1f","text":"<p>\u5e38\u898b\u885d\u7a81\uff1a <pre><code># \u885d\u7a81 1: \u4f4e\u672c\u76ca\u6bd4 vs \u9ad8\u6210\u9577\n# \u4f4e\u672c\u76ca\u6bd4\u516c\u53f8\u901a\u5e38\u6210\u9577\u6162\n# \u9ad8\u6210\u9577\u516c\u53f8\u901a\u5e38\u672c\u76ca\u6bd4\u9ad8\n\n# \u89e3\u6c7a\uff1a\u7528 PEG\uff08\u672c\u76ca\u6bd4 / \u6210\u9577\u7387\uff09\u5e73\u8861\ndf['PEG'] = df['\u672c\u76ca\u6bd4'] / df['\u76c8\u9918\u6210\u9577\u7387']\nset_balanced = set(df[df['PEG'] &lt; 1.0]['\u80a1\u7968\u4ee3\u78bc'])\n\n# \u885d\u7a81 2: \u9ad8\u80a1\u606f vs \u9ad8\u6210\u9577\n# \u9ad8\u80a1\u606f\u516c\u53f8\u901a\u5e38\u662f\u6210\u719f\u671f\n# \u9ad8\u6210\u9577\u516c\u53f8\u901a\u5e38\u4e0d\u914d\u606f\n\n# \u89e3\u6c7a\uff1a\u5206\u6210\u5169\u500b\u7b56\u7565\nstrategy_dividend = select_high_dividend_stocks()\nstrategy_growth = select_high_growth_stocks()\nfinal_tickers = strategy_dividend + strategy_growth\n</code></pre></p> <p>\u512a\u5148\u7d1a\u8a2d\u8a08\uff1a <pre><code># \u65b9\u6cd5 1: \u6838\u5fc3\u689d\u4ef6 + \u53ef\u9078\u689d\u4ef6\ncore = set_1 &amp; set_2  # \u5fc5\u9808\u901a\u904e\noptional = set_3 | set_4  # \u81f3\u5c11\u901a\u904e\u4e00\u500b\nfinal = core &amp; optional\n\n# \u65b9\u6cd5 2: \u52a0\u6b0a\u8a08\u5206\nscore = (\n    (ticker in set_1) * 3 +  # \u6700\u91cd\u8981\n    (ticker in set_2) * 2 +  # \u6b21\u91cd\u8981\n    (ticker in set_3) * 1    # \u52a0\u5206\u9805\n)\n</code></pre></p>"},{"location":"blocks/fundamentals/faq/#backtest","title":"\u56de\u6e2c\u8a2d\u5b9a","text":""},{"location":"blocks/fundamentals/faq/#q11","title":"Q11: \u65e5\u671f\u5c0d\u4e0d\u4e0a\uff0c\u63db\u80a1\u65e5\u6c92\u6709\u89f8\u767c\uff1f","text":"<p>\u8a3a\u65b7\u6b65\u9a5f\uff1a <pre><code># Step 1: \u6aa2\u67e5\u63db\u80a1\u65e5\u662f\u5426\u70ba\u4ea4\u6613\u65e5\nprint(\"\u63db\u80a1\u65e5:\", modified_day[:5])\nprint(\"\u56de\u6e2c\u65e5\u671f\u7bc4\u570d:\", start_date, \"~\", end_date)\n\n# Step 2: \u5728 handle_data \u4e2d\u52a0\u5165 debug\ndef handle_data(context, data):\n    backtest_date = data.current_dt.date()\n\n    # \u6bcf\u6b21\u90fd\u5370\u51fa\u4f86\u6aa2\u67e5\n    if context.i &lt; 10 or backtest_date in modified_day:\n        print(f\"Day {context.i}: {backtest_date}, \u662f\u63db\u80a1\u65e5: {backtest_date in modified_day}\")\n\n    # \u539f\u672c\u7684\u908f\u8f2f...\n</code></pre></p> <p>\u5e38\u898b\u554f\u984c\uff1a</p>"},{"location":"blocks/fundamentals/faq/#1_1","title":"\u554f\u984c 1: \u65e5\u671f\u683c\u5f0f\u4e0d\u4e00\u81f4","text":"<pre><code># \u274c \u932f\u8aa4\nmodified_day = [pd.Timestamp('2023-03-31')]  # Timestamp\nbacktest_date = data.current_dt.date()        # date\n\nif backtest_date in modified_day:  # \u6c38\u9060 False\uff01\n\n# \u2705 \u6b63\u78ba\nmodified_day = [pd.Timestamp('2023-03-31').date()]  # \u7d71\u4e00\u7528 date\n</code></pre>"},{"location":"blocks/fundamentals/faq/#2_1","title":"\u554f\u984c 2: \u975e\u4ea4\u6613\u65e5","text":"<pre><code># \u4f8b\u5982 2023-03-31 \u662f\u661f\u671f\u4e94\uff0c\u4f46\u7576\u5929\u4f11\u5e02\n# \u5be6\u969b\u4ea4\u6613\u65e5\u662f 2023-04-03\n\n# \u89e3\u6c7a\uff1a\u7528 TEJ \u4ea4\u6613\u65e5\u66c6\ntrade_days = tejapi.get('TWN/TRADEDAY_TWSE', ...)\n</code></pre>"},{"location":"blocks/fundamentals/faq/#3_1","title":"\u554f\u984c 3: \u6642\u5340\u554f\u984c","text":"<pre><code># \u274c \u932f\u8aa4\nmodified_day = [pd.Timestamp('2023-03-31')]  # \u6c92\u6709 tz\n\n# \u2705 \u6b63\u78ba\nmodified_day = [pd.Timestamp('2023-03-31', tz='UTC').date()]\n</code></pre>"},{"location":"blocks/fundamentals/faq/#q12","title":"Q12: \u70ba\u4ec0\u9ebc\u56de\u6e2c\u7d50\u679c\u8ddf\u9810\u671f\u5dee\u5f88\u591a\uff1f","text":"<p>\u6aa2\u67e5\u6e05\u55ae\uff1a</p>"},{"location":"blocks/fundamentals/faq/#1_2","title":"1. \u4ea4\u6613\u6210\u672c\u8a2d\u5b9a","text":"<pre><code># \u662f\u5426\u8a2d\u5b9a\u624b\u7e8c\u8cbb\u548c\u6ed1\u50f9\uff1f\nset_commission(commission.Custom_TW_Commission(\n    min_trade_cost=20,\n    discount=0.6,  # \u6aa2\u67e5\u6298\u6263\u662f\u5426\u5408\u7406\n    tax=0.003\n))\n\nset_slippage(slippage.VolumeShareSlippage(\n    volume_limit=0.25,  # \u6aa2\u67e5\u662f\u5426\u592a\u6a02\u89c0\n    price_impact=0.01\n))\n</code></pre>"},{"location":"blocks/fundamentals/faq/#2_2","title":"2. \u524d\u8996\u504f\u5dee","text":"<pre><code># \u274c \u7576\u5929\u9078\u80a1\u7576\u5929\u4e0b\u55ae\nif date in modified_day:\n    tickers = compute_stock(date)\n    for t in tickers:\n        order(t, 100)  # \u932f\u8aa4\uff01\n\n# \u2705 \u7576\u5929\u9078\u80a1\u9694\u5929\u4e0b\u55ae\nif date in modified_day:\n    context.order_tickers = compute_stock(date)\n    context.state = True\n\nif context.state:\n    for t in context.order_tickers:\n        order(t, 100)\n    context.state = False\n</code></pre>"},{"location":"blocks/fundamentals/faq/#3_2","title":"3. \u5016\u5b58\u8005\u504f\u5dee","text":"<pre><code># get_universe \u6703\u81ea\u52d5\u8655\u7406\u4e0b\u5e02\u80a1\u7968\npool = get_universe(\n    start=start_date,\n    end=end_date,\n    ...\n)\n# pool \u53ea\u5305\u542b\u5728\u8a72\u671f\u9593\u6709\u4ea4\u6613\u7684\u80a1\u7968\n# \u4e0b\u5e02\u80a1\u7968\u6703\u5728\u4e0b\u5e02\u524d\u5c31\u88ab\u79fb\u9664\n</code></pre>"},{"location":"blocks/fundamentals/faq/#4","title":"4. \u6578\u64da\u54c1\u8cea","text":"<pre><code># \u6aa2\u67e5\u6578\u64da\u662f\u5426\u5b8c\u6574\nprint(f\"\u6578\u64da\u7b46\u6578: {len(data__)}\")\nprint(f\"\u80a1\u7968\u6578 \u00d7 \u65e5\u671f\u6578: {len(pool)} \u00d7 {len(modified_day)}\")\nprint(f\"\u9810\u671f\u7b46\u6578: {len(pool) * len(modified_day)}\")\n\n# \u6aa2\u67e5\u662f\u5426\u6709\u7570\u5e38\u503c\nprint(data__['\u672c\u76ca\u6bd4'].describe())\n# \u5982\u679c max &gt; 1000\uff0c\u53ef\u80fd\u6709\u554f\u984c\n</code></pre>"},{"location":"blocks/fundamentals/faq/#q13","title":"Q13: \u5982\u4f55\u8a2d\u5b9a\u5408\u7406\u7684\u521d\u59cb\u8cc7\u91d1\u548c\u6301\u80a1\u6578\u91cf\uff1f","text":"<p>\u521d\u59cb\u8cc7\u91d1\u5efa\u8b70\uff1a <pre><code># \u6839\u64da\u7b56\u7565\u985e\u578b\u8abf\u6574\nstrategies = {\n    '\u591a\u56e0\u5b50\u9078\u80a1': {\n        'capital_base': 1e7,      # 1000 \u842c\uff08\u9810\u671f 15-25 \u6a94\uff09\n        'min_position': 300000,   # \u6700\u4f4e\u55ae\u4e00\u90e8\u4f4d 30 \u842c\n    },\n    '\u5c0f\u578b\u6210\u9577\u80a1': {\n        'capital_base': 5e6,      # 500 \u842c\uff08\u9810\u671f 5-10 \u6a94\uff09\n        'min_position': 500000,   # \u6700\u4f4e\u55ae\u4e00\u90e8\u4f4d 50 \u842c\n    },\n    'Dreman \u9006\u5411': {\n        'capital_base': 2e7,      # 2000 \u842c\uff08\u9810\u671f 10-20 \u6a94\uff09\n        'min_position': 500000,   # \u6700\u4f4e\u55ae\u4e00\u90e8\u4f4d 50 \u842c\n    }\n}\n</code></pre></p> <p>\u52d5\u614b\u90e8\u4f4d\u7ba1\u7406\uff1a <pre><code>def handle_data(context, data):\n    if context.state == True:\n        # \u8a08\u7b97\u76ee\u6a19\u90e8\u4f4d\n        num_stocks = len(context.order_tickers)\n\n        # \u78ba\u4fdd\u55ae\u4e00\u90e8\u4f4d\u4e0d\u6703\u592a\u5c0f\n        min_position_value = 300000  # 30 \u842c\n        max_stocks = context.portfolio.portfolio_value // min_position_value\n\n        if num_stocks &gt; max_stocks:\n            # \u80a1\u7968\u592a\u591a\uff0c\u53ea\u8cb7\u524d N \u6a94\n            context.order_tickers = context.order_tickers[:max_stocks]\n            num_stocks = max_stocks\n\n        # \u7b49\u6b0a\u91cd\u914d\u7f6e\n        weight = 1.0 / num_stocks\n        for ticker in context.order_tickers:\n            order_target_percent(symbol(ticker), weight)\n</code></pre></p>"},{"location":"blocks/fundamentals/faq/#debug","title":"\u9664\u932f\u6280\u5de7","text":""},{"location":"blocks/fundamentals/faq/#q14","title":"Q14: \u5982\u4f55\u5feb\u901f\u627e\u5230\u554f\u984c\uff1f","text":"<p>\u5206\u5c64\u9664\u932f\u6cd5\uff1a <pre><code># Layer 1: \u6e2c\u8a66\u9078\u80a1\u51fd\u6578\uff08\u4e0d\u56de\u6e2c\uff09\nprint(\"=== \u6e2c\u8a66\u9078\u80a1\u51fd\u6578 ===\")\ntest_date = pd.Timestamp('2023-03-31').date()\ntickers = compute_stock(test_date, data__, verbose=True)\nprint(f\"\u5165\u9078: {tickers}\")\n\n# Layer 2: \u6e2c\u8a66\u55ae\u4e00\u65e5\u671f\u56de\u6e2c\nprint(\"\\n=== \u6e2c\u8a66\u55ae\u65e5\u56de\u6e2c ===\")\nresults = run_algorithm(\n    start=pd.Timestamp('2023-03-31', tz='utc'),\n    end=pd.Timestamp('2023-04-05', tz='utc'),  # \u53ea\u8dd1 5 \u5929\n    ...\n)\n\n# Layer 3: \u6e2c\u8a66\u77ed\u671f\u56de\u6e2c\nprint(\"\\n=== \u6e2c\u8a66\u77ed\u671f\u56de\u6e2c ===\")\nresults = run_algorithm(\n    start=pd.Timestamp('2023-01-01', tz='utc'),\n    end=pd.Timestamp('2023-03-31', tz='utc'),  # \u53ea\u8dd1\u4e00\u5b63\n    ...\n)\n\n# Layer 4: \u5b8c\u6574\u56de\u6e2c\nprint(\"\\n=== \u5b8c\u6574\u56de\u6e2c ===\")\nresults = run_algorithm(\n    start=pd.Timestamp('2019-01-01', tz='utc'),\n    end=pd.Timestamp('2023-12-31', tz='utc'),\n    ...\n)\n</code></pre></p>"},{"location":"blocks/fundamentals/faq/#q15","title":"Q15: \u5e38\u898b\u932f\u8aa4\u8a0a\u606f\u53ca\u89e3\u6c7a\u65b9\u6cd5","text":""},{"location":"blocks/fundamentals/faq/#1-keyerror-xxx","title":"\u932f\u8aa4 1: <code>KeyError: 'XXX'</code>","text":"<pre><code># \u539f\u56e0\uff1a\u6b04\u4f4d\u540d\u7a31\u932f\u8aa4\n# \u89e3\u6c7a\uff1a\nprint(data__.columns)  # \u6aa2\u67e5\u5be6\u969b\u6b04\u4f4d\u540d\n</code></pre>"},{"location":"blocks/fundamentals/faq/#2-valueerror-cannot-convert-float-nan-to-integer","title":"\u932f\u8aa4 2: <code>ValueError: cannot convert float NaN to integer</code>","text":"<pre><code># \u539f\u56e0\uff1a\u6578\u64da\u6709 NaN\uff0c\u7121\u6cd5\u8f49\u6574\u6578\n# \u89e3\u6c7a\uff1a\ndf['\u80a1\u6578'] = df['\u80a1\u6578'].fillna(0).astype(int)\n</code></pre>"},{"location":"blocks/fundamentals/faq/#3-zerodivisionerror-division-by-zero","title":"\u932f\u8aa4 3: <code>ZeroDivisionError: division by zero</code>","text":"<pre><code># \u539f\u56e0\uff1a\u5206\u6bcd\u70ba 0\n# \u89e3\u6c7a\uff1a\ndf['\u8ca0\u50b5\u6bd4'] = df.apply(\n    lambda row: row['\u8ca0\u50b5'] / row['\u6de8\u503c'] if row['\u6de8\u503c'] != 0 else np.nan,\n    axis=1\n)\n</code></pre>"},{"location":"blocks/fundamentals/faq/#4-equityxxx-does-not-exist","title":"\u932f\u8aa4 4: <code>Equity(XXX) does not exist</code>","text":"<pre><code># \u539f\u56e0\uff1a\u80a1\u7968\u4e0d\u5728 bundle \u4e2d\n# \u89e3\u6c7a\uff1a\n# 1. \u6aa2\u67e5 ingest \u6642\u662f\u5426\u5305\u542b\u8a72\u80a1\u7968\n# 2. \u6aa2\u67e5\u65e5\u671f\u7bc4\u570d\u662f\u5426\u6b63\u78ba\npools = pool + ['IR0001']  # \u78ba\u4fdd\u57fa\u6e96\u6307\u6578\u4e5f\u5728\u5167\nsimple_ingest(name='tquant', tickers=pools, ...)\n</code></pre>"},{"location":"blocks/fundamentals/faq/#optimize","title":"\u6548\u80fd\u512a\u5316","text":""},{"location":"blocks/fundamentals/faq/#q16","title":"Q16: \u56de\u6e2c\u901f\u5ea6\u592a\u6162\u600e\u9ebc\u8fa6\uff1f","text":"<p>\u512a\u5316\u6280\u5de7\uff1a</p>"},{"location":"blocks/fundamentals/faq/#1_3","title":"1. \u6e1b\u5c11\u6578\u64da\u91cf","text":"<pre><code># \u53ea\u8f09\u5165\u9700\u8981\u7684\u6b04\u4f4d\ncolumns = ['mktcap', 'per', 'roe']  # \u4e0d\u8981\u7528 ['*']\n\n# \u53ea\u8f09\u5165\u9700\u8981\u7684\u65e5\u671f\u7bc4\u570d\ndata = TejToolAPI.get_history_data(\n    start=start_dt,\n    end=end_dt,  # \u4e0d\u8981\u6293\u592a\u9577\n    ...\n)\n</code></pre>"},{"location":"blocks/fundamentals/faq/#2_3","title":"2. \u9810\u5148\u8a08\u7b97","text":"<pre><code># \u9810\u5148\u8a08\u7b97\u6240\u6709\u63db\u80a1\u65e5\u7684\u540d\u55ae\nprint(\"\u9810\u5148\u8a08\u7b97\u9078\u80a1\u540d\u55ae...\")\nstock_lists = {}\nfor date in modified_day:\n    stock_lists[date] = compute_stock(date, data__)\n    print(f\"{date}: {len(stock_lists[date])} \u6a94\")\n\n# \u56de\u6e2c\u6642\u76f4\u63a5\u67e5\u8868\ndef handle_data(context, data):\n    backtest_date = data.current_dt.date()\n    if backtest_date in stock_lists:\n        context.order_tickers = stock_lists[backtest_date]\n        context.state = True\n</code></pre>"},{"location":"blocks/fundamentals/faq/#3_3","title":"3. \u5411\u91cf\u5316\u904b\u7b97","text":"<pre><code># \u274c \u6162\uff1a\u7528\u8ff4\u5708\nfor ticker in df['\u80a1\u7968\u4ee3\u78bc']:\n    if ticker in set_1 and ticker in set_2:\n        selected.append(ticker)\n\n# \u2705 \u5feb\uff1a\u7528\u5411\u91cf\u5316\nmask = df['\u80a1\u7968\u4ee3\u78bc'].isin(set_1) &amp; df['\u80a1\u7968\u4ee3\u78bc'].isin(set_2)\nselected = df[mask]['\u80a1\u7968\u4ee3\u78bc'].tolist()\n</code></pre>"},{"location":"blocks/fundamentals/faq/#q17","title":"Q17: \u8a18\u61b6\u9ad4\u4e0d\u8db3\u600e\u9ebc\u8fa6\uff1f","text":"<pre><code># \u65b9\u6cd5 1: \u5206\u6279\u8f09\u5165\nchunk_size = 200\nfor i in range(0, len(pool), chunk_size):\n    chunk_pool = pool[i:i+chunk_size]\n    chunk_data = TejToolAPI.get_history_data(\n        ticker=chunk_pool,\n        ...\n    )\n    # \u8655\u7406 chunk_data\n\n# \u65b9\u6cd5 2: \u53ea\u4fdd\u7559\u5fc5\u8981\u6b04\u4f4d\ndata = data[['coid', 'mdate', '\u672c\u76ca\u6bd4', 'ROE']]  # \u522a\u9664\u4e0d\u7528\u7684\u6b04\u4f4d\n\n# \u65b9\u6cd5 3: \u8f49\u63db\u6578\u64da\u985e\u578b\ndata['\u672c\u76ca\u6bd4'] = data['\u672c\u76ca\u6bd4'].astype('float32')  # float64 \u2192 float32 \u7701\u4e00\u534a\u8a18\u61b6\u9ad4\n</code></pre>"},{"location":"blocks/fundamentals/faq/#practice","title":"\u5be6\u52d9\u61c9\u7528","text":""},{"location":"blocks/fundamentals/faq/#q18","title":"Q18: \u5982\u4f55\u628a\u56de\u6e2c\u7b56\u7565\u90e8\u7f72\u5230\u5be6\u76e4\uff1f","text":"<p>\u6b65\u9a5f\uff1a <pre><code># Step 1: \u5efa\u7acb\u9078\u80a1\u6392\u7a0b\u8173\u672c\n# select_stocks.py\nimport schedule\nimport time\n\ndef daily_selection():\n    today = pd.Timestamp.now().date()\n    if today in modified_day:\n        tickers = compute_stock(today, get_latest_data())\n        save_to_file(tickers, f'portfolio_{today}.csv')\n        send_notification(f\"\u4eca\u65e5\u9078\u80a1\u5b8c\u6210\uff1a{len(tickers)} \u6a94\")\n\nschedule.every().day.at(\"18:00\").do(daily_selection)\n\nwhile True:\n    schedule.run_pending()\n    time.sleep(60)\n\n# Step 2: \u5efa\u7acb\u4e0b\u55ae\u8173\u672c\n# place_orders.py\ndef execute_orders():\n    portfolio = pd.read_csv('portfolio_latest.csv')\n    for ticker in portfolio['ticker']:\n        # \u900f\u904e\u5238\u5546 API \u4e0b\u55ae\n        broker_api.order(ticker, quantity=...)\n</code></pre></p> <p>\u6ce8\u610f\u4e8b\u9805\uff1a</p> <ul> <li>\u26a0\ufe0f \u5be6\u76e4\u4ea4\u6613\u524d\u52d9\u5fc5\u5c0f\u984d\u6e2c\u8a66</li> <li>\u26a0\ufe0f \u8a2d\u5b9a\u505c\u640d\u6a5f\u5236</li> <li>\u26a0\ufe0f \u76e3\u63a7\u7cfb\u7d71\u904b\u4f5c\u72c0\u614b</li> <li>\u26a0\ufe0f \u6e96\u5099\u7dca\u6025\u7194\u65b7\u6a5f\u5236</li> </ul>"},{"location":"blocks/fundamentals/faq/#q19","title":"Q19: \u5982\u4f55\u8a55\u4f30\u7b56\u7565\u662f\u5426\u904e\u5ea6\u64ec\u5408\uff1f","text":"<p>\u6aa2\u9a57\u65b9\u6cd5\uff1a</p>"},{"location":"blocks/fundamentals/faq/#1_4","title":"1. \u6a23\u672c\u5916\u6e2c\u8a66","text":"<pre><code># \u8a13\u7df4\u671f\uff1a2015-2020\ntrain_results = run_algorithm(\n    start=pd.Timestamp('2015-01-01', tz='utc'),\n    end=pd.Timestamp('2020-12-31', tz='utc'),\n    ...\n)\n\n# \u6e2c\u8a66\u671f\uff1a2021-2023\ntest_results = run_algorithm(\n    start=pd.Timestamp('2021-01-01', tz='utc'),\n    end=pd.Timestamp('2023-12-31', tz='utc'),\n    ...\n)\n\n# \u6bd4\u8f03\u7e3e\u6548\nprint(f\"\u8a13\u7df4\u671f\u5e74\u5316\u5831\u916c: {train_sharpe}\")\nprint(f\"\u6e2c\u8a66\u671f\u5e74\u5316\u5831\u916c: {test_sharpe}\")\n\n# \u5982\u679c\u6e2c\u8a66\u671f\u660e\u986f\u8b8a\u5dee \u2192 \u904e\u64ec\u5408\n</code></pre>"},{"location":"blocks/fundamentals/faq/#2_4","title":"2. \u6efe\u52d5\u7a97\u53e3\u6e2c\u8a66","text":"<pre><code># \u6bcf\u5e74\u91cd\u65b0\u8a13\u7df4\nfor year in range(2015, 2023):\n    train_start = f\"{year-3}-01-01\"\n    train_end = f\"{year}-12-31\"\n    test_start = f\"{year+1}-01-01\"\n    test_end = f\"{year+1}-12-31\"\n\n    # \u7528\u904e\u53bb 3 \u5e74\u8a13\u7df4\uff0c\u6e2c\u8a66\u4e0b\u4e00\u5e74\n    strategy = optimize_on(train_start, train_end)\n    results = backtest_on(test_start, test_end, strategy)\n</code></pre>"},{"location":"blocks/fundamentals/faq/#3_4","title":"3. \u53c3\u6578\u654f\u611f\u5ea6\u5206\u6790","text":"<pre><code># \u6e2c\u8a66\u53c3\u6578\u8b8a\u5316\u5c0d\u7e3e\u6548\u7684\u5f71\u97ff\nfor threshold in [0.1, 0.15, 0.2, 0.25, 0.3]:\n    results = backtest(debt_ratio_threshold=threshold)\n    print(f\"\u8ca0\u50b5\u6bd4\u9580\u6abb {threshold}: \u5831\u916c {results.annual_return}\")\n\n# \u5982\u679c\u5c0f\u5e45\u8abf\u6574\u53c3\u6578\u5c31\u5927\u5e45\u5f71\u97ff\u7e3e\u6548 \u2192 \u904e\u64ec\u5408\n</code></pre>"},{"location":"blocks/fundamentals/faq/#q20","title":"Q20: \u7b56\u7565\u7e3e\u6548\u4e0d\u5982\u9810\u671f\uff0c\u8a72\u600e\u9ebc\u6539\u9032\uff1f","text":"<p>\u8a3a\u65b7\u6d41\u7a0b\uff1a <pre><code># Step 1: \u55ae\u56e0\u5b50\u6e2c\u8a66\nfor factor in ['\u672c\u76ca\u6bd4', 'ROE', '\u8ca0\u50b5\u6bd4', '\u80a1\u606f\u7387']:\n    sharpe = backtest_single_factor(factor)\n    print(f\"{factor} Sharpe: {sharpe}\")\n\n# Step 2: \u76f8\u95dc\u6027\u5206\u6790\nimport seaborn as sns\ncorr_matrix = returns_df.corr()\nsns.heatmap(corr_matrix)\n# \u627e\u51fa\u76f8\u95dc\u6027\u4f4e\u7684\u56e0\u5b50\u7d44\u5408\n\n# Step 3: \u6b78\u56e0\u5206\u6790\nfrom pyfolio import timeseries\ntimeseries.perf_stats(returns)\n# \u5206\u6790\u5831\u916c\u4f86\u6e90\uff1aBeta? Alpha? \u7522\u696d\u66b4\u9732?\n\n# Step 4: \u6539\u9032\u65b9\u5411\nimprovements = {\n    '\u9078\u80a1\u592a\u5c11': '\u653e\u5bec\u689d\u4ef6 / \u6539\u7528\u8a08\u5206\u6cd5',\n    '\u9031\u8f49\u7387\u592a\u9ad8': '\u5ef6\u9577\u6301\u6709\u671f / \u52a0\u5165\u52d5\u91cf\u904e\u6ffe',\n    '\u56de\u64a4\u592a\u5927': '\u52a0\u5165\u505c\u640d / \u5206\u6563\u7522\u696d',\n    '\u7121\u8d85\u984d\u5831\u916c': '\u91cd\u65b0\u8a2d\u8a08\u56e0\u5b50 / \u52a0\u5165\u5e02\u5834\u64c7\u6642'\n}\n</code></pre></p>"},{"location":"blocks/fundamentals/faq/#_2","title":"\ud83d\udca1 \u6700\u4f73\u5be6\u8e10\u7e3d\u7d50","text":""},{"location":"blocks/fundamentals/faq/#do","title":"\u2705 DO\uff08\u5efa\u8b70\u505a\uff09","text":"<ol> <li>\u5148\u6e2c\u8a66\u5c0f\u7bc4\u570d\uff1a\u55ae\u65e5 \u2192 \u55ae\u5b63 \u2192 \u5168\u671f\u9593</li> <li>\u7528 verbose \u6a21\u5f0f\uff1a\u8a73\u7d30\u8a18\u9304\u9078\u80a1\u904e\u7a0b</li> <li>\u6aa2\u67e5\u6578\u64da\u54c1\u8cea\uff1a\u7f3a\u5931\u503c\u3001\u6975\u7aef\u503c\u3001\u7570\u5e38\u503c</li> <li>\u907f\u514d\u524d\u8996\u504f\u5dee\uff1a\u4f7f\u7528 <code>context.state</code> \u5ef6\u9072\u4e0b\u55ae</li> <li>\u8a2d\u5b9a\u5408\u7406\u4ea4\u6613\u6210\u672c\uff1a\u624b\u7e8c\u8cbb\u3001\u6ed1\u50f9\u3001\u7a05</li> <li>\u6a23\u672c\u5916\u6e2c\u8a66\uff1a\u8a13\u7df4\u671f + \u6e2c\u8a66\u671f\u5206\u96e2</li> <li>\u5b9a\u671f\u6aa2\u67e5\u6301\u5009\uff1a\u7528 <code>record()</code> \u8a18\u9304\u95dc\u9375\u8b8a\u6578</li> <li>\u6587\u6a94\u5316\u53c3\u6578\uff1a\u8a18\u9304\u70ba\u4ec0\u9ebc\u9078\u9019\u4e9b\u689d\u4ef6</li> </ol>"},{"location":"blocks/fundamentals/faq/#dont","title":"\u274c DON'T\uff08\u907f\u514d\u505a\uff09","text":"<ol> <li>\u76f4\u63a5\u5168\u671f\u56de\u6e2c\uff1a\u8df3\u904e\u9664\u932f\u6b65\u9a5f</li> <li>\u5ffd\u7565\u6578\u64da\u5ef6\u9072\uff1a\u7528\u7576\u5b63\u8ca1\u5831\u7576\u5b63\u4e0b\u55ae</li> <li>\u904e\u5ea6\u512a\u5316\u53c3\u6578\uff1a\u8abf\u5230\u5c0f\u6578\u9ede\u7b2c\u4e09\u4f4d</li> <li>\u5ffd\u7565\u4ea4\u6613\u6210\u672c\uff1a\u5047\u8a2d\u96f6\u6210\u672c\u4ea4\u6613</li> <li>\u53ea\u770b\u5831\u916c\u7387\uff1a\u5ffd\u7565\u98a8\u96aa\u3001\u56de\u64a4\u3001\u9031\u8f49\u7387</li> <li>\u7167\u6284\u5225\u4eba\u7b56\u7565\uff1a\u4e0d\u7406\u89e3\u908f\u8f2f\u5c31\u4f7f\u7528</li> <li>\u904e\u5ea6\u64ec\u5408\uff1a\u689d\u4ef6\u592a\u591a\u592a\u7d30</li> <li>\u6c92\u6709\u5bb9\u932f\u6a5f\u5236\uff1a\u9078\u4e0d\u5230\u80a1\u7968\u5c31\u7576\u6a5f</li> </ol>"},{"location":"blocks/fundamentals/faq/#_3","title":"\ud83d\udd17 \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md</li> <li>Code \u6a21\u677f\uff1atemplate.md</li> <li>\u6848\u4f8b\u5b78\u7fd2\uff1a</li> <li>\u591a\u56e0\u5b50\u9078\u80a1</li> <li>\u5c0f\u578b\u6210\u9577\u80a1</li> <li>Dreman \u9006\u5411\u6295\u8cc7</li> </ul> <p>\u9084\u6709\u554f\u984c\uff1f</p> <p>\u5982\u679c\u9019\u88e1\u6c92\u6709\u6db5\u84cb\u4f60\u7684\u554f\u984c\uff0c\u8acb\uff1a</p> <ol> <li>\u6aa2\u67e5 template.md \u7684\u8a3b\u89e3</li> <li>\u53c3\u8003\u4e09\u500b case study \u7684\u5be6\u4f5c</li> <li>\u56de\u5230 overview.md \u78ba\u8a8d\u662f\u5426\u9078\u5c0d\u67b6\u69cb</li> </ol> <p>\ud83d\udc49 \u6e96\u5099\u597d\u4e86\uff1f \u524d\u5f80 template.md \u958b\u59cb\u958b\u767c\u4f60\u7684\u7b56\u7565\uff01</p>"},{"location":"blocks/fundamentals/template/","title":"\u8ca1\u5831\u9078\u80a1\u67b6\u69cb - Code \u6a21\u677f","text":"<p>\u672c\u9801\u63d0\u4f9b\u53ef\u76f4\u63a5\u4f7f\u7528\u7684 Code Template\uff0c\u4e26\u6a19\u8a3b\u9700\u8981\u81ea\u5b9a\u7fa9\u7684\u90e8\u5206\u3002</p>"},{"location":"blocks/fundamentals/template/#_1","title":"\ud83d\udccb \u6a21\u677f\u7e3d\u89bd","text":"<p>\u8ca1\u5831\u9078\u80a1\u67b6\u69cb\u5305\u542b 4 \u500b\u6838\u5fc3\u6a21\u584a \uff0c\u8acb\u4f9d\u7167\u4f60\u7684\u9700\u6c42\u7d44\u88dd\uff1a</p> \u6a21\u584a (Module) \u6838\u5fc3\u529f\u80fd \u4f60\u7684\u4efb\u52d9 (Action) M1. \u57fa\u790e\u5efa\u8a2d <code>\u74b0\u5883\u8a2d\u5b9a</code> <code>\u6578\u64da\u4e0b\u8f09</code> \ud83d\udfe2 \u8a2d\u5b9a\u53c3\u6578 (\u65e5\u671f\u3001\u8cc7\u91d1\u3001\u80a1\u7968\u6c60) M2. \u7b56\u7565\u5927\u8166 <code>\u9078\u80a1\u908f\u8f2f</code> <code>\u56e0\u5b50\u7be9\u9078</code> \ud83d\udd25 \u5beb\u4e0b\u4f60\u7684\u7372\u5229\u908f\u8f2f (\u6700\u91cd\u8981!) M3. \u6230\u8853\u7bc0\u594f <code>\u63db\u80a1\u65e5\u7a0b</code> <code>\u518d\u5e73\u8861</code> \ud83d\udd35 \u9078\u64c7\u983b\u7387 (\u5b63\u63db/\u6708\u63db/\u56fa\u5b9a\u5929\u6578) M4. \u57f7\u884c\u5f15\u64ce <code>\u4e0b\u55ae\u4ea4\u6613</code> <code>\u7e3e\u6548\u56de\u5831</code> \ud83d\udd12 \u76f4\u63a5\u57f7\u884c (\u901a\u5e38\u7121\u9700\u4fee\u6539)"},{"location":"blocks/fundamentals/template/#_2","title":"\ud83c\udfaf \u5b8c\u6574\u6a21\u677f","text":""},{"location":"blocks/fundamentals/template/#module-1","title":"Module 1: \u74b0\u5883\u8a2d\u5b9a &amp; \u6578\u64da\u6e96\u5099","text":"<pre><code># ====================================\n# Module 1: \u74b0\u5883\u8a2d\u5b9a &amp; \u6578\u64da\u6e96\u5099\n# ====================================\n\nimport os\nimport pandas as pd\nimport numpy as np\nimport tejapi\nimport matplotlib.pyplot as plt\nimport warnings\nfrom dotenv import load_dotenv\n\n# \u8f09\u5165\u74b0\u5883\u8b8a\u6578\nload_dotenv()\nwarnings.filterwarnings('ignore')\n\n# TEJ API \u8a2d\u5b9a\ntejapi.ApiConfig.api_key = os.getenv('TEJAPI_KEY')\nos.environ['TEJAPI_KEY'] = os.getenv('TEJAPI_KEY')\ntejapi.ApiConfig.api_base = os.getenv('TEJAPI_BASE')\nos.environ['TEJAPI_BASE'] = os.getenv('TEJAPI_BASE')\n\n# \u4e2d\u6587\u986f\u793a\u8a2d\u5b9a\nplt.rcParams['font.sans-serif'] = ['Microsoft JhengHei', 'Arial']\nplt.rcParams['axes.unicode_minus'] = False\n\n# ====================================\n# \u53c3\u6578\u8a2d\u5b9a\n# ====================================\nstart_date = '2019-12-29'  # \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u56de\u6e2c\u8d77\u59cb\u65e5\nend_date = '2023-12-31'    # \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u56de\u6e2c\u7d50\u675f\u65e5\ncapital_base = 1e7         # \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u521d\u59cb\u8cc7\u91d1\n\n# ====================================\n# \u80a1\u7968\u6c60\u8a2d\u5b9a\n# ====================================\nfrom zipline.sources.TEJ_Api_Data import get_universe\n\npool = get_universe(\n    start=pd.Timestamp(start_date, tz='utc'), \n    end=pd.Timestamp(end_date, tz='utc'), \n    mkt_bd_e=['TSE', 'OTC'],  # \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1aTSE=\u4e0a\u5e02, OTC=\u4e0a\u6ac3\n    stktp_e='Common Stock'    # \u56fa\u5b9a\uff1a\u666e\u901a\u80a1\n)\n\nprint(f\"\u80a1\u7968\u6c60\u7e3d\u6578: {len(pool)} \u6a94\")\n\n# ====================================\n# \u8ca1\u5831\u6578\u64da\u4e0b\u8f09\n# ====================================\nimport TejToolAPI\n\n# \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u9700\u8981\u7684\u8ca1\u5831\u6b04\u4f4d\ncolumns = [\n    'mktcap',      # \u5e02\u503c\n    'per',         # \u672c\u76ca\u6bd4\n    'div_yid',     # \u80a1\u606f\u6536\u76ca\u7387\n    'a0100',       # \u6d41\u52d5\u8cc7\u7522\n    'a1100',       # \u6d41\u52d5\u8ca0\u50b5\n    'a1000',       # \u7e3d\u8ca0\u50b5\n    'a2000',       # \u7e3d\u6b0a\u76ca\n    'eps',         # \u6bcf\u80a1\u76c8\u9918\n    'r405'         # \u71df\u6536\u6210\u9577\u7387\n    # \u66f4\u591a\u6b04\u4f4d\u8acb\u53c3\u8003 TEJ API \u6587\u6a94\n]\n\ndata__ = TejToolAPI.get_history_data(\n    start=pd.Timestamp(start_date, tz='UTC'), \n    end=pd.Timestamp(end_date, tz='UTC'), \n    ticker=pool, \n    fin_type='Q',  # \ud83d\udd27 \u53ef\u9078\uff1a'Q'=\u5b63\u5831, 'A'=\u5e74\u5831, 'TTM'=\u8fd112\u6708\n    columns=columns, \n    transfer_to_chinese=True,  # \u6b04\u4f4d\u540d\u8f49\u4e2d\u6587\n    include_self_acc='Y'       # \u5305\u542b\u81ea\u7d50\u6578\n)\n\nprint(f\"\u6578\u64da\u7b46\u6578: {len(data__):,}\")\nprint(f\"\u65e5\u671f\u7bc4\u570d: {data__['\u65e5\u671f'].min().date()} ~ {data__['\u65e5\u671f'].max().date()}\")\n</code></pre>"},{"location":"blocks/fundamentals/template/#module-2","title":"Module 2: \u9078\u80a1\u908f\u8f2f\u51fd\u6578 \ud83d\udd25","text":"<p>\u9019\u662f\u6574\u500b\u7b56\u7565\u7684 \u9748\u9b42 \uff0c\u6240\u6709\u7be9\u9078\u908f\u8f2f\u90fd\u5728\u9019\u88e1\u5b9a\u7fa9\u3002</p>"},{"location":"blocks/fundamentals/template/#a","title":"\ud83d\udccc \u6a21\u677f A\uff1a\u4ea4\u96c6\u6cd5\uff08\u6700\u5e38\u7528\uff09","text":"<pre><code># ====================================\n# Module 2A: \u9078\u80a1\u908f\u8f2f - \u4ea4\u96c6\u6cd5\n# ====================================\n\ndef compute_stock(date, data, verbose=True):\n    \"\"\"\n    \u9078\u80a1\u51fd\u6578\uff1a\u6839\u64da\u8ca1\u5831\u689d\u4ef6\u7be9\u9078\u80a1\u7968\n\n    Parameters:\n    -----------\n    date : datetime.date\n        \u9078\u80a1\u65e5\u671f\n    data : pd.DataFrame\n        \u5b8c\u6574\u8ca1\u5831\u6578\u64da\n    verbose : bool\n        \u662f\u5426\u986f\u793a\u8a73\u7d30\u8a0a\u606f\n\n    Returns:\n    --------\n    list : \u5165\u9078\u80a1\u7968\u4ee3\u78bc\u5217\u8868\n    \"\"\"\n    # \u63d0\u53d6\u7576\u65e5\u6578\u64da\n    df = data[data['\u65e5\u671f'] == pd.Timestamp(date)].reset_index(drop=True)\n\n    if len(df) == 0:\n        if verbose:\n            print(f\"\u8b66\u544a\uff1a{date} \u7121\u6578\u64da\")\n        return []\n\n    # ========================================\n    # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u5b9a\u7fa9\u7be9\u9078\u689d\u4ef6\n    # ========================================\n\n    # \u689d\u4ef6 1: \u672c\u76ca\u6bd4 &lt; \u5e02\u5834\u5e73\u5747\n    market_avg_per = df['\u672c\u76ca\u6bd4'].mean(skipna=True)\n    set_1 = set(df[df['\u672c\u76ca\u6bd4'] &lt; market_avg_per]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # \u689d\u4ef6 2: \u6d41\u52d5\u6bd4\u7387 &gt; \u7522\u696d\u5e73\u5747\n    df['\u7522\u696d\u5e73\u5747\u6d41\u52d5\u6bd4\u7387'] = df.groupby('\u4e3b\u7522\u696d\u5225_\u4e2d\u6587')['\u6d41\u52d5\u8cc7\u7522_Q'].transform('mean') / \\\n                          df.groupby('\u4e3b\u7522\u696d\u5225_\u4e2d\u6587')['\u6d41\u52d5\u8ca0\u50b5_Q'].transform('mean')\n    df['\u6d41\u52d5\u6bd4\u7387'] = df['\u6d41\u52d5\u8cc7\u7522_Q'] / df['\u6d41\u52d5\u8ca0\u50b5_Q']\n    set_2 = set(df[df['\u6d41\u52d5\u6bd4\u7387'] &gt; df['\u7522\u696d\u5e73\u5747\u6d41\u52d5\u6bd4\u7387']]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # \u689d\u4ef6 3: \u8ca0\u50b5\u6bd4 &lt; 20%\n    df['\u8ca0\u50b5\u6bd4'] = df['\u8ca0\u50b5\u7e3d\u984d_Q'] / df['\u80a1\u6771\u6b0a\u76ca\u7e3d\u984d_Q']\n    set_3 = set(df[df['\u8ca0\u50b5\u6bd4'] &lt; 0.2]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # \u689d\u4ef6 4: \u80a1\u606f\u6536\u76ca\u7387 &gt; \u5e02\u5834\u5e73\u5747\n    market_avg_div = df['\u80a1\u5229\u6b96\u5229\u7387'].mean(skipna=True)\n    set_4 = set(df[df['\u80a1\u5229\u6b96\u5229\u7387'] &gt; market_avg_div]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # ========================================\n    # \u53d6\u4ea4\u96c6\n    # ========================================\n    selected_tickers = list(set_1 &amp; set_2 &amp; set_3 &amp; set_4)\n\n    if verbose:\n        print(f\"\\n========== {date} \u9078\u80a1 ==========\")\n        print(f\"\u689d\u4ef6 1 \u901a\u904e: {len(set_1)} \u6a94\")\n        print(f\"\u689d\u4ef6 2 \u901a\u904e: {len(set_2)} \u6a94\")\n        print(f\"\u689d\u4ef6 3 \u901a\u904e: {len(set_3)} \u6a94\")\n        print(f\"\u689d\u4ef6 4 \u901a\u904e: {len(set_4)} \u6a94\")\n        print(f\"\u6700\u7d42\u5165\u9078: {len(selected_tickers)} \u6a94\")\n        print(\"=\"*40)\n\n    return selected_tickers\n</code></pre>"},{"location":"blocks/fundamentals/template/#b","title":"\ud83d\udccc \u6a21\u677f B\uff1a\u8a08\u5206\u6cd5\uff08\u9032\u968e\uff09","text":"<pre><code># ====================================\n# Module 2B: \u9078\u80a1\u908f\u8f2f - \u8a08\u5206\u6cd5\n# ====================================\n\ndef compute_stock_scoring(date, data, min_score=3, verbose=True):\n    \"\"\"\n    \u9078\u80a1\u51fd\u6578\uff1a\u8a08\u5206\u5236\u7be9\u9078\n\n    \u908f\u8f2f\uff1a\n    1. \u6838\u5fc3\u689d\u4ef6\uff08\u5fc5\u9808\u901a\u904e\uff09\n    2. \u984d\u5916\u689d\u4ef6\uff08\u8a08\u5206\uff0c\u9054\u6a19\u5373\u5165\u9078\uff09\n    \"\"\"\n    df = data[data['\u65e5\u671f'] == pd.Timestamp(date)].reset_index(drop=True)\n\n    if len(df) == 0:\n        if verbose:\n            print(f\"\u8b66\u544a\uff1a{date} \u7121\u6578\u64da\")\n        return []\n\n    # ========================================\n    # \u968e\u6bb5 1: \u6838\u5fc3\u689d\u4ef6\uff08\u5fc5\u9808\u901a\u904e\uff09\n    # ========================================\n    avg_mktcap = df['\u500b\u80a1\u5e02\u503c_\u5143'].mean(skipna=True)\n    core_set_1 = set(df[df['\u500b\u80a1\u5e02\u503c_\u5143'] &gt;= avg_mktcap]['\u80a1\u7968\u4ee3\u78bc'])\n\n    avg_per = df['\u672c\u76ca\u6bd4'].mean(skipna=True)\n    core_set_2 = set(df[(df['\u672c\u76ca\u6bd4'] &gt; 0) &amp; (df['\u672c\u76ca\u6bd4'] &lt;= avg_per)]['\u80a1\u7968\u4ee3\u78bc'])\n\n    core_set = core_set_1 &amp; core_set_2\n\n    # ========================================\n    # \u968e\u6bb5 2: \u984d\u5916\u689d\u4ef6\uff08\u8a08\u5206\uff09\n    # ========================================\n    df['\u6d41\u52d5\u6bd4\u7387'] = df['\u6d41\u52d5\u8cc7\u7522_Q'] / df['\u6d41\u52d5\u8ca0\u50b5_Q']\n    df['\u8ca0\u50b5\u6bd4'] = df['\u8ca0\u50b5\u7e3d\u984d_Q'] / df['\u80a1\u6771\u6b0a\u76ca\u7e3d\u984d_Q']\n\n    avg_current_ratio = df['\u6d41\u52d5\u6bd4\u7387'].mean(skipna=True)\n    avg_debt_ratio = df['\u8ca0\u50b5\u6bd4'].mean(skipna=True)\n    avg_roe = df[df['ROE_A_\u7a05\u5f8c_Q'] &gt; 0]['ROE_A_\u7a05\u5f8c_Q'].mean()\n\n    score_set_1 = set(df[df['\u6d41\u52d5\u6bd4\u7387'] &gt;= avg_current_ratio]['\u80a1\u7968\u4ee3\u78bc'])\n    score_set_2 = set(df[df['\u8ca0\u50b5\u6bd4'] &lt;= avg_debt_ratio]['\u80a1\u7968\u4ee3\u78bc'])\n    score_set_3 = set(df[(df['ROE_A_\u7a05\u5f8c_Q'] &gt; 0) &amp; (df['ROE_A_\u7a05\u5f8c_Q'] &gt;= avg_roe)]['\u80a1\u7968\u4ee3\u78bc'])\n\n    # ========================================\n    # \u8a08\u5206\u8207\u7be9\u9078\n    # ========================================\n    selected_tickers = []\n\n    for ticker in core_set:\n        score = 0\n        if ticker in score_set_1: score += 1\n        if ticker in score_set_2: score += 1\n        if ticker in score_set_3: score += 1\n\n        if score &gt;= min_score:\n            selected_tickers.append(ticker)\n\n    # \u52d5\u614b\u964d\u7d1a\uff08\u5982\u679c\u6c92\u6709\u7b26\u5408\u7684\u80a1\u7968\uff09\n    if len(selected_tickers) == 0 and min_score &gt; 1:\n        if verbose:\n            print(f\"\u964d\u7d1a\u81f3 {min_score-1} \u5206...\")\n        return compute_stock_scoring(date, data, min_score-1, verbose=False)\n\n    if verbose:\n        print(f\"\\n========== {date} \u9078\u80a1\uff08\u8a08\u5206\u5236\uff09==========\")\n        print(f\"\u6838\u5fc3\u689d\u4ef6\u901a\u904e: {len(core_set)} \u6a94\")\n        print(f\"\u6700\u7d42\u5165\u9078\uff08\u2265{min_score}\u5206\uff09: {len(selected_tickers)} \u6a94\")\n        print(\"=\"*40)\n\n    return selected_tickers\n</code></pre>"},{"location":"blocks/fundamentals/template/#c","title":"\ud83d\udccc \u6a21\u677f C\uff1a\u6392\u540d\u6cd5","text":"<pre><code># ====================================\n# Module 2C: \u9078\u80a1\u908f\u8f2f - \u6392\u540d\u6cd5\n# ====================================\n\ndef compute_stock_ranking(date, data, top_n=20, verbose=True):\n    \"\"\"\n    \u9078\u80a1\u51fd\u6578\uff1a\u6392\u540d\u6cd5\n\n    \u908f\u8f2f\uff1a\n    1. \u901a\u904e\u57fa\u672c\u689d\u4ef6\n    2. \u6309\u67d0\u6307\u6a19\u6392\u540d\uff0c\u53d6\u524d N \u540d\n    \"\"\"\n    df = data[data['\u65e5\u671f'] == pd.Timestamp(date)].reset_index(drop=True)\n\n    if len(df) == 0:\n        if verbose:\n            print(f\"\u8b66\u544a\uff1a{date} \u7121\u6578\u64da\")\n        return []\n\n    # ========================================\n    # \u57fa\u672c\u689d\u4ef6\n    # ========================================\n    avg_mktcap = df['\u500b\u80a1\u5e02\u503c_\u5143'].mean(skipna=True)\n    basic_set = set(df[df['\u500b\u80a1\u5e02\u503c_\u5143'] &lt;= avg_mktcap * 0.3]['\u80a1\u7968\u4ee3\u78bc'])  # \u5c0f\u578b\u80a1\n\n    # ========================================\n    # \u6392\u540d\u6307\u6a19\uff1aPEG (\u672c\u76ca\u6bd4/\u6210\u9577\u7387)\n    # ========================================\n    df['PEG'] = df['\u672c\u76ca\u6bd4'] / df['\u7a05\u5f8c\u6de8\u5229\u6210\u9577\u7387_Q']\n\n    # \u7be9\u9078 + \u6392\u5e8f\n    filtered_df = df[df['\u80a1\u7968\u4ee3\u78bc'].isin(basic_set) &amp; (df['PEG'] &gt; 0)]\n    top_df = filtered_df.sort_values(by='PEG').head(top_n)\n\n    selected_tickers = list(top_df['\u80a1\u7968\u4ee3\u78bc'])\n\n    if verbose:\n        print(f\"\\n========== {date} \u9078\u80a1\uff08\u6392\u540d\u6cd5\uff09==========\")\n        print(f\"\u57fa\u672c\u689d\u4ef6\u901a\u904e: {len(basic_set)} \u6a94\")\n        print(f\"\u6700\u7d42\u5165\u9078\uff08\u524d{top_n}\u540d\uff09: {len(selected_tickers)} \u6a94\")\n        print(\"=\"*40)\n\n    return selected_tickers\n</code></pre>"},{"location":"blocks/fundamentals/template/#module-3","title":"Module 3: \u63db\u80a1\u65e5\u671f\u8a08\u7b97","text":""},{"location":"blocks/fundamentals/template/#a_1","title":"\ud83d\udccc \u65b9\u6cd5 A\uff1a\u56fa\u5b9a\u9031\u671f\uff08\u7c21\u55ae\uff09","text":"<pre><code># ====================================\n# Module 3A: \u63db\u80a1\u65e5\u671f - \u56fa\u5b9a\u9031\u671f\n# ====================================\n\n# \u624b\u52d5\u6307\u5b9a\u65e5\u671f\nmodified_day = [\n    pd.Timestamp('2020-03-31').date(),\n    pd.Timestamp('2020-06-30').date(),\n    pd.Timestamp('2020-09-30').date(),\n    pd.Timestamp('2020-12-31').date(),\n    # ... \u7e7c\u7e8c\u5217\u8209\n]\n\nprint(f\"\u63db\u80a1\u6b21\u6578: {len(modified_day)}\")\nprint(f\"\u7bc4\u4f8b\u65e5\u671f: {modified_day[:5]}\")\n</code></pre>"},{"location":"blocks/fundamentals/template/#btej","title":"\ud83d\udccc \u65b9\u6cd5 B\uff1aTEJ \u4ea4\u6613\u65e5\u66c6\uff08\u63a8\u85a6\uff09","text":"<pre><code># ====================================\n# Module 3B: \u63db\u80a1\u65e5\u671f - TEJ \u4ea4\u6613\u65e5\u66c6\n# ====================================\n\n# \u4f7f\u7528 TEJ \u5b98\u65b9\u4ea4\u6613\u65e5\u66c6\uff0c\u907f\u514d\u9047\u5230\u975e\u4ea4\u6613\u65e5\ntrade_days = tejapi.get(\n    'TWN/TRADEDAY_TWSE',\n    zdate={'gte': start_date, 'lte': end_date},\n    tradeday_cno={'ne': 0}  # \u53ea\u6293\u53d6\u4ea4\u6613\u65e5\n)\n\ntrade_days['zdate'] = pd.to_datetime(trade_days['zdate'])\ntrade_days['year'] = trade_days['zdate'].dt.year\ntrade_days['month'] = trade_days['zdate'].dt.month\n\n# \u627e\u51fa\u6bcf\u5b63\u6700\u5f8c\u4ea4\u6613\u65e5\nrebalance_months = [3, 6, 9, 12]  # \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u63db\u80a1\u6708\u4efd\nmodified_day = []\n\nfor month in rebalance_months:\n    month_data = trade_days[trade_days['month'] == month]\n    last_days = month_data.groupby('year')['zdate'].max()\n    modified_day.extend(last_days.tolist())\n\n# \u8f49\u63db\u70ba date \u683c\u5f0f\u4e26\u6392\u5e8f\nmodified_day = sorted([d.date() for d in modified_day])\n\nprint(f\"\u63db\u80a1\u6b21\u6578: {len(modified_day)}\")\nprint(f\"\u7bc4\u4f8b\u65e5\u671f: {modified_day[:8]}\")\n</code></pre>"},{"location":"blocks/fundamentals/template/#cn","title":"\ud83d\udccc \u65b9\u6cd5 C\uff1a\u56fa\u5b9a\u983b\u7387\uff08N \u5929\u8abf\u5009\uff09","text":"<pre><code># ====================================\n# Module 3C: \u63db\u80a1\u65e5\u671f - \u56fa\u5b9a\u983b\u7387\n# ====================================\n\n# \u6b64\u65b9\u6cd5\u4e0d\u9700\u4e8b\u5148\u8a08\u7b97\uff0c\u5728 handle_data \u4e2d\u7528\u8a08\u6578\u5668\u5be6\u73fe\n# \u898b Module 4 \u7684\u8b8a\u9ad4 B\n</code></pre>"},{"location":"blocks/fundamentals/template/#module-4-zipline","title":"Module 4: Zipline \u56de\u6e2c\u5f15\u64ce","text":""},{"location":"blocks/fundamentals/template/#_3","title":"\ud83d\udccc \u6a19\u6e96\u7248\uff08\u5b63\u5ea6\u8abf\u5009\uff09","text":"<pre><code># ====================================\n# Module 4: Zipline \u56de\u6e2c\u5f15\u64ce\n# ====================================\n\nfrom zipline.data.run_ingest import simple_ingest\nfrom zipline.api import (\n    set_slippage, set_commission, set_benchmark, \n    symbol, record, order_target_percent\n)\nfrom zipline.finance import commission, slippage\nfrom zipline import run_algorithm\n\n# ====================================\n# \u532f\u5165\u50f9\u91cf\u8cc7\u6599\n# ====================================\npools = pool + ['IR0001']  # \u52a0\u5165\u57fa\u6e96\u6307\u6578\n\nprint(\"\u6b63\u5728\u6e96\u5099 Zipline \u8cc7\u6599...\")\nsimple_ingest(\n    name='tquant', \n    tickers=pools, \n    start_date=start_date.replace('-', ''), \n    end_date=end_date.replace('-', '')\n)\nprint(\"\u8cc7\u6599\u6e96\u5099\u5b8c\u6210\uff01\")\n\n# ====================================\n# \u521d\u59cb\u5316\u51fd\u6578\n# ====================================\ndef initialize(context):\n    \"\"\"\u56de\u6e2c\u521d\u59cb\u5316\"\"\"\n    # \u6ed1\u50f9\u6a21\u578b\n    set_slippage(slippage.VolumeShareSlippage(\n        volume_limit=1,      # \ud83d\udd27 \u53ef\u8abf\uff1a\u6700\u5927\u6210\u4ea4\u91cf\u4f54\u6bd4\n        price_impact=0.01    # \ud83d\udd27 \u53ef\u8abf\uff1a\u50f9\u683c\u885d\u64ca\n    ))\n\n    # \u624b\u7e8c\u8cbb\u6a21\u578b\n    set_commission(commission.Custom_TW_Commission(\n        min_trade_cost=20,   # \u6700\u4f4e\u624b\u7e8c\u8cbb 20 \u5143\n        discount=1.0,        # \ud83d\udd27 \u53ef\u8abf\uff1a\u624b\u7e8c\u8cbb\u6298\u6263\uff080.5=\u4e94\u6298\uff09\n        tax=0.003            # \u8b49\u4ea4\u7a05 0.3%\n    ))\n\n    # \u8a2d\u5b9a\u57fa\u6e96\u6307\u6578\n    set_benchmark(symbol('IR0001'))\n\n    # \u521d\u59cb\u5316\u8b8a\u6578\n    context.i = 0                    # \u65e5\u671f\u8a08\u6578\u5668\n    context.state = False            # \u662f\u5426\u70ba\u63db\u80a1\u65e5\u9694\u5929\n    context.order_tickers = []       # \u672c\u671f\u5165\u9078\u80a1\u7968\n    context.last_tickers = []        # \u4e0a\u671f\u6301\u6709\u80a1\u7968\n\n# ====================================\n# \u6bcf\u65e5\u57f7\u884c\u51fd\u6578\n# ====================================\ndef handle_data(context, data):\n    \"\"\"\u6bcf\u65e5\u57f7\u884c\u908f\u8f2f\"\"\"\n    # \u907f\u514d\u524d\u8996\u504f\u5dee\uff1a\u5728\u7be9\u9078\u80a1\u7968\u4e0b\u4e00\u4ea4\u6613\u65e5\u4e0b\u55ae\n    if context.state == True:\n        print(f\"\u4e0b\u55ae\u65e5\u671f: {data.current_dt.date()}, \u5165\u9078\u80a1\u7968\u6578: {len(context.order_tickers)}\")\n\n        # \u8ce3\u51fa\u4e0d\u518d\u6301\u6709\u7684\u80a1\u7968\n        for ticker in context.last_tickers:\n            if ticker not in context.order_tickers:\n                order_target_percent(symbol(ticker), 0)\n\n        # \u8cb7\u5165\u65b0\u5165\u9078\u7684\u80a1\u7968\uff08\u7b49\u6b0a\u91cd\uff09\n        if len(context.order_tickers) &gt; 0:\n            target_weight = 1 / len(context.order_tickers)  # \ud83d\udd27 \u53ef\u6539\uff1a\u6b0a\u91cd\u8a08\u7b97\n            for ticker in context.order_tickers:\n                order_target_percent(symbol(ticker), target_weight)\n                curr = data.current(symbol(ticker), 'price')\n                record(price=curr, days=context.i)\n\n        context.last_tickers = context.order_tickers\n        context.state = False\n\n    backtest_date = data.current_dt.date()\n\n    # \u67e5\u770b\u662f\u5426\u70ba\u63db\u80a1\u65e5\n    for rebalance_date in modified_day:\n        if backtest_date == rebalance_date:\n            context.state = True\n            # \ud83d\udd25 \u547c\u53eb\u9078\u80a1\u51fd\u6578\n            context.order_tickers = compute_stock(\n                date=backtest_date, \n                data=data__,\n                verbose=True\n            )\n\n    context.i += 1\n\n# ====================================\n# \u7e3e\u6548\u5206\u6790\u51fd\u6578\n# ====================================\ndef analyze(context, perf):\n    \"\"\"\u7e6a\u88fd\u7e3e\u6548\u5716\u8868\"\"\"\n    fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(14, 10), sharex=True)\n\n    # \u4e0a\u5716\uff1a\u7d2f\u7a4d\u5831\u916c\n    perf['algorithm_period_return'].plot(ax=ax1, label='\u7b56\u7565\u5831\u916c', linewidth=2)\n    perf['benchmark_period_return'].plot(ax=ax1, label='\u5927\u76e4\u5831\u916c', linewidth=2, alpha=0.7)\n    ax1.set_title('\u7b56\u7565 vs \u5927\u76e4', fontsize=16, fontweight='bold')\n    ax1.set_ylabel('\u7d2f\u7a4d\u5831\u916c\u7387', fontsize=12)\n    ax1.legend(loc='upper left')\n    ax1.grid(True, alpha=0.3)\n\n    # \u4e0b\u5716\uff1a\u6295\u8cc7\u7d44\u5408\u50f9\u503c\n    perf['portfolio_value'].plot(ax=ax2, label='\u6295\u8cc7\u7d44\u5408\u50f9\u503c', linewidth=2)\n    ax2.set_title('\u6295\u8cc7\u7d44\u5408\u50f9\u503c', fontsize=14)\n    ax2.set_ylabel('\u50f9\u503c\uff08\u5143\uff09', fontsize=12)\n    ax2.legend(loc='upper left')\n    ax2.grid(True, alpha=0.3)\n\n    plt.tight_layout()\n    plt.show()\n\n    # \u5132\u5b58\u7e3e\u6548\u6578\u64da\n    perf.to_csv(f\"perf_{start_date}_{end_date}.csv\")\n\n# ====================================\n# \u57f7\u884c\u56de\u6e2c\n# ====================================\nprint(\"=\"*60)\nprint(\"\u958b\u59cb\u56de\u6e2c\")\nprint(\"=\"*60)\n\nresults = run_algorithm(\n    start=pd.Timestamp(start_date, tz='utc'),\n    end=pd.Timestamp(end_date, tz='utc'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    bundle='tquant',\n    capital_base=capital_base\n)\n\nprint(\"\\n\u56de\u6e2c\u5b8c\u6210\uff01\")\n</code></pre>"},{"location":"blocks/fundamentals/template/#b_1","title":"\ud83d\udccc \u8b8a\u9ad4 B\uff1a\u56fa\u5b9a\u5929\u6578\u8abf\u5009","text":"<pre><code>def initialize(context):\n    # ... \u524d\u9762\u76f8\u540c ...\n\n    context.rebalance_freq = 20  # \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u6bcf N \u5929\u8abf\u5009\n\ndef handle_data(context, data):\n    if context.state == True:\n        # ... \u4e0b\u55ae\u908f\u8f2f ...\n        context.state = False\n\n    backtest_date = data.current_dt.date()\n\n    # \ud83d\udd25 \u6539\u7528\u8a08\u6578\u5668\u5224\u65b7\n    if context.i % context.rebalance_freq == 0:\n        context.state = True\n        context.order_tickers = compute_stock(backtest_date, data__)\n\n    context.i += 1\n</code></pre>"},{"location":"blocks/fundamentals/template/#_4","title":"\ud83c\udfaf \u4f7f\u7528\u6307\u5357","text":""},{"location":"blocks/fundamentals/template/#step-1","title":"Step 1: \u8907\u88fd\u6a21\u677f","text":"<p>\u9078\u64c7\u6700\u63a5\u8fd1\u4f60\u9700\u6c42\u7684\u6a21\u677f\u7d44\u5408\uff1a</p> <ul> <li>\u4ea4\u96c6\u6cd5 + TEJ \u65e5\u66c6 \u2190 \u6700\u63a8\u85a6</li> <li>\u8a08\u5206\u6cd5 + \u56fa\u5b9a\u9031\u671f</li> <li>\u6392\u540d\u6cd5 + \u56fa\u5b9a\u983b\u7387</li> </ul>"},{"location":"blocks/fundamentals/template/#step-2","title":"Step 2: \u81ea\u5b9a\u7fa9\u6838\u5fc3\u908f\u8f2f","text":"<p>\u4fee\u6539 <code>compute_stock()</code> \u51fd\u6578\u4e2d\u7684\u7be9\u9078\u689d\u4ef6\uff1a <pre><code># \ud83d\udd25 \u5728\u9019\u88e1\u66ff\u63db\u6210\u4f60\u7684\u908f\u8f2f\nset_1 = set(df[df['\u4f60\u7684\u689d\u4ef6']]['\u80a1\u7968\u4ee3\u78bc'])\nset_2 = set(df[df['\u4f60\u7684\u689d\u4ef6']]['\u80a1\u7968\u4ee3\u78bc'])\n</code></pre></p>"},{"location":"blocks/fundamentals/template/#step-3","title":"Step 3: \u8abf\u6574\u53c3\u6578","text":"<ul> <li>\u56de\u6e2c\u671f\u9593\uff1a<code>start_date</code>, <code>end_date</code></li> <li>\u80a1\u7968\u6c60\uff1a<code>mkt_bd_e</code>, <code>stktp_e</code></li> <li>\u8ca1\u5831\u6b04\u4f4d\uff1a<code>columns</code></li> <li>\u63db\u80a1\u983b\u7387\uff1a<code>rebalance_months</code> \u6216 <code>rebalance_freq</code></li> </ul>"},{"location":"blocks/fundamentals/template/#step-4","title":"Step 4: \u57f7\u884c\u56de\u6e2c","text":"<pre><code>results = run_algorithm(...)\n</code></pre>"},{"location":"blocks/fundamentals/template/#_5","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6848\u4f8b\u5b78\u7fd2\uff1a</li> <li>\u591a\u56e0\u5b50\u9078\u80a1 - \u4ea4\u96c6\u6cd5\u5b8c\u6574\u7bc4\u4f8b</li> <li>Dreman \u9006\u5411\u6295\u8cc7 - \u8a08\u5206\u6cd5\u5b8c\u6574\u7bc4\u4f8b</li> <li>\u5c0f\u578b\u6210\u9577\u80a1 - \u6392\u540d\u6cd5\u5b8c\u6574\u7bc4\u4f8b</li> <li>\u5e38\u898b\u554f\u984c\uff1afaq.md</li> </ul> <p>\ud83d\udc49 Next Step: \u53c3\u8003 case-multifactor.md \u67e5\u770b\u5b8c\u6574\u5be6\u6230\u6848\u4f8b\uff01</p>"},{"location":"blocks/pipeline/","title":"\u67b6\u69cb C\uff1aPipeline \u56e0\u5b50\u67b6\u69cb (Pipeline Factor Framework)","text":"<p>\u6838\u5fc3\u601d\u60f3\uff1a\u6279\u6b21\u8a08\u7b97\uff0c\u9ad8\u6548\u9078\u80a1\u3002 \"Compute once, apply to all.\"</p>"},{"location":"blocks/pipeline/#_1","title":"\ud83d\udccc \u6838\u5fc3\u6982\u5ff5","text":"<p>Pipeline \u56e0\u5b50\u67b6\u69cb\u7684\u672c\u8cea\u662f\u300c\u76e4\u524d\u6279\u6b21\u8a08\u7b97 + \u7d71\u4e00\u8abf\u5ea6\u300d\u7684\u9ad8\u6548\u6846\u67b6\uff1a <pre><code>\u6bcf\u500b\u4ea4\u6613\u65e5\u958b\u76e4\u524d\uff1a\nStep 1: Pipeline \u4e00\u6b21\u8a08\u7b97\u6240\u6709\u80a1\u7968\u7684\u56e0\u5b50\u503c\nStep 2: \u6839\u64da\u56e0\u5b50\u503c\u7be9\u9078\u3001\u6392\u5e8f\u3001\u5206\u7d44\nStep 3: \u7522\u751f\u6301\u5009\u6e05\u55ae\uff08\u54ea\u4e9b\u80a1\u7968\u3001\u6b0a\u91cd\u591a\u5c11\uff09\nStep 4: \u958b\u76e4\u5f8c\u57f7\u884c\u8abf\u5009\uff08rebalance\uff09\n</code></pre></p> <p>\u9019\u7a2e\u67b6\u69cb\u662f\u91cf\u5316\u4ea4\u6613\u7684 \u5de5\u696d\u7d1a\u6a19\u6e96\uff1a</p> <ul> <li>\ud83d\udcca \u6279\u6b21\u8655\u7406\uff1a\u4e00\u6b21\u8a08\u7b97 2000 \u6a94\u80a1\u7968\u7684\u56e0\u5b50</li> <li>\u26a1 \u6975\u81f4\u6548\u80fd\uff1a\u5411\u91cf\u5316\u904b\u7b97\uff0c\u901f\u5ea6\u5feb 10-100 \u500d</li> <li>\ud83d\udd27 \u6a21\u7d44\u5316\uff1a\u56e0\u5b50\u53ef\u63d2\u62d4\u3001\u53ef\u7d44\u5408</li> <li>\ud83d\udcc8 \u53ef\u64f4\u5c55\uff1a\u5f9e 10 \u6a94\u5230 10000 \u6a94\u7121\u75db\u5347\u7d1a</li> </ul>"},{"location":"blocks/pipeline/#_2","title":"\ud83c\udfaf \u9069\u7528\u5834\u666f","text":""},{"location":"blocks/pipeline/#_3","title":"\u2705 \u6700\u9069\u5408\u7684\u60c5\u5883","text":"<ul> <li>\u5927\u898f\u6a21\u80a1\u7968\u6c60\uff1a50-2000 \u6a94\u80a1\u7968</li> <li>\u56e0\u5b50\u9078\u80a1\u7b56\u7565\uff1a\u52d5\u91cf\u3001\u50f9\u503c\u3001\u54c1\u8cea\u3001\u4f4e\u6ce2\u52d5</li> <li>\u591a\u56e0\u5b50\u7d44\u5408\uff1a3-10 \u500b\u56e0\u5b50\u52a0\u6b0a</li> <li>\u5b9a\u671f\u8abf\u5009\uff1a\u65e5\u5ea6\u3001\u9031\u5ea6\u3001\u6708\u5ea6</li> </ul>"},{"location":"blocks/pipeline/#_4","title":"\u274c \u4e0d\u9069\u5408\u7684\u60c5\u5883","text":"<ul> <li>\u274c \u5c11\u6578\u6a19\u7684\uff08&lt;10 \u6a94\uff09</li> <li>\u274c \u8907\u96dc\u908f\u8f2f\uff08\u9700\u8981 if-else \u5224\u65b7\uff09</li> <li>\u274c \u9ad8\u983b\u4ea4\u6613\uff08\u5206\u9418\u7d1a\uff09</li> <li>\u274c \u6280\u8853\u6307\u6a19\u4ea4\u53c9\u8a0a\u865f</li> </ul>"},{"location":"blocks/pipeline/#_5","title":"\ud83c\udfd7\ufe0f \u67b6\u69cb\u7279\u8272","text":""},{"location":"blocks/pipeline/#_6","title":"\u6578\u64da\u6d41\u5411\u5716","text":"<pre><code>graph TD\n    subgraph Prep[\"\u2699\ufe0f \u4e8b\u524d\u6e96\u5099\"]\n        A1[\u5b9a\u7fa9 CustomFactor&lt;br/&gt;\u81ea\u5b9a\u7fa9\u56e0\u5b50\u985e\u5225] --&gt; A2[\u5b9a\u7fa9 Pipeline&lt;br/&gt;\u7d44\u5408\u591a\u500b\u56e0\u5b50]\n    end\n\n    subgraph Daily[\"\ud83d\udd04 \u6bcf\u65e5\u5faa\u74b0\"]\n        A2 --&gt; B1[\u76e4\u524d\u904b\u7b97&lt;br/&gt;Pipeline \u6279\u6b21\u8a08\u7b97]\n        B1 --&gt; B2[pipeline_output&lt;br/&gt;\u53d6\u5f97\u56e0\u5b50 DataFrame]\n        B2 --&gt; B3[\u7be9\u9078 &amp; \u6392\u5e8f&lt;br/&gt;\u9078\u51fa\u76ee\u6a19\u80a1\u7968]\n        B3 --&gt; B4[\u8a08\u7b97\u6b0a\u91cd&lt;br/&gt;\u7b49\u6b0a / \u5e02\u503c\u52a0\u6b0a / \u56e0\u5b50\u52a0\u6b0a]\n        B4 --&gt; B5[\u57f7\u884c\u8abf\u5009&lt;br/&gt;order_optimal_portfolio]\n    end\n\n    style Prep fill:#e3f2fd,stroke:#1976d2,stroke-width:2px\n    style Daily fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    style B1 fill:#ffccbc,stroke:#d84315,stroke-width:2px\n    style B5 fill:#c5e1a5,stroke:#558b2f,stroke-width:2px</code></pre>"},{"location":"blocks/pipeline/#_7","title":"\u95dc\u9375\u8a2d\u8a08\u7406\u5ff5","text":""},{"location":"blocks/pipeline/#1","title":"1. \u5411\u91cf\u5316\u8a08\u7b97\u7684\u5a01\u529b","text":"<pre><code># \u274c Loop \u65b9\u6cd5\uff08\u6162\uff09\nfor stock in stock_list:  # 2000 \u6a94\n    close = data.history(stock, 'close', 20, '1d')\n    ma = close.mean()\n    # 2000 \u6b21 API \u8abf\u7528\uff01\n\n# \u2705 Pipeline \u65b9\u6cd5\uff08\u5feb\uff09\nclass MA20(CustomFactor):\n    window_length = 20\n    def compute(self, today, assets, out, close):\n        out[:] = np.mean(close, axis=0)\n        # \u4e00\u6b21\u8a08\u7b97 2000 \u6a94\uff01\n</code></pre> <p>\u6548\u80fd\u5c0d\u6bd4\uff1a</p> \u80a1\u7968\u6578 Loop \u65b9\u6cd5 Pipeline \u65b9\u6cd5 \u52a0\u901f\u6bd4 10 \u6a94 1 \u79d2 0.5 \u79d2 2x 100 \u6a94 10 \u79d2 0.6 \u79d2 17x 1000 \u6a94 100 \u79d2 1 \u79d2 100x 2000 \u6a94 200 \u79d2 2 \u79d2 100x"},{"location":"blocks/pipeline/#2-feature","title":"2. \u56e0\u5b50\u5373\u662f Feature","text":"<pre><code># Pipeline \u5c07\u300c\u56e0\u5b50\u300d\u8996\u70ba\u300c\u7279\u5fb5\u300d\n# \u985e\u4f3c\u6a5f\u5668\u5b78\u7fd2\u7684 Feature Engineering\n\n# \u5b9a\u7fa9\u591a\u500b\u56e0\u5b50\nmomentum = Returns(window_length=252)\nvolatility = AnnualizedVolatility(window_length=252)\nvalue = PERatio()\n\n# \u7d44\u5408\u56e0\u5b50\npipe = Pipeline(\n    columns={\n        'momentum': momentum,\n        'volatility': volatility,\n        'value': value\n    }\n)\n\n# \u7522\u51fa DataFrame\n# Stock | momentum | volatility | value\n# 2330  |   0.35   |    0.25    |  15.2\n# 2317  |   0.28   |    0.30    |  12.8\n# ...\n</code></pre>"},{"location":"blocks/pipeline/#3","title":"3. \u9078\u80a1\u908f\u8f2f\u7684\u6a21\u7d44\u5316","text":"<pre><code># \u6a21\u7d44 1: \u5b9a\u7fa9\u56e0\u5b50\nclass MyFactor(CustomFactor):\n    ...\n\n# \u6a21\u7d44 2: \u5b9a\u7fa9\u7be9\u9078\u5668\nscreen = (momentum &gt; 0) &amp; (volatility &lt; 0.3)\n\n# \u6a21\u7d44 3: \u5b9a\u7fa9 Pipeline\npipe = Pipeline(\n    columns={'momentum': momentum},\n    screen=screen\n)\n\n# \u6a21\u7d44 4: \u5b9a\u7fa9\u6b0a\u91cd\ndef compute_weights(output):\n    # \u6839\u64da\u56e0\u5b50\u503c\u8a08\u7b97\u6b0a\u91cd\n    return weights\n\n# \u5404\u6a21\u7d44\u7368\u7acb\uff0c\u6613\u65bc\u6e2c\u8a66\u548c\u66ff\u63db\n</code></pre>"},{"location":"blocks/pipeline/#_8","title":"\ud83d\udcca \u8207\u5176\u4ed6\u67b6\u69cb\u7684\u5dee\u7570","text":"\u7279\u6027 Pipeline \u67b6\u69cb \u6280\u8853\u6307\u6a19\u67b6\u69cb \u8ca1\u5831\u9078\u80a1\u67b6\u69cb \u904b\u7b97\u6642\u6a5f \u76e4\u524d\u6279\u6b21 \u76e4\u4e2d\u5373\u6642 \u76e4\u5916\u9810\u5148 \u9069\u7528\u80a1\u7968\u6578 50-2000 1-10 50-200 \u6548\u80fd \ud83d\udfe2 \u6975\u5feb \ud83d\udd34 \u6162 \ud83d\udfe1 \u4e2d \u5b78\u7fd2\u66f2\u7dda \ud83d\udd34 \u9661\u5ced \ud83d\udfe2 \u5e73\u7de9 \ud83d\udfe2 \u5e73\u7de9 \u5f48\u6027 \ud83d\udd34 \u4f4e \ud83d\udfe2 \u6975\u9ad8 \ud83d\udfe1 \u4e2d \u5178\u578b\u7528\u9014 \u56e0\u5b50\u6295\u8cc7 \u6280\u8853\u5206\u6790 \u57fa\u672c\u9762\u9078\u80a1 \u8abf\u5009\u983b\u7387 \u65e5/\u9031/\u6708 \u4e0d\u5b9a\u671f \u5b63/\u6708"},{"location":"blocks/pipeline/#_9","title":"\ud83d\udca1 \u4f55\u6642\u9078\u64c7\u9019\u500b\u67b6\u69cb\uff1f","text":""},{"location":"blocks/pipeline/#_10","title":"\u5feb\u901f\u5224\u65b7\u6aa2\u67e5\u8868","text":"<pre><code>graph TD\n    A[\u4f60\u7684\u7b56\u7565] --&gt; B{\u80a1\u7968\u6578\u91cf?}\n    B --&gt;|&lt;10 \u6a94| X[\u8003\u616e\u6280\u8853\u6307\u6a19\u67b6\u69cb]\n    B --&gt;|10-50 \u6a94| C{\u908f\u8f2f\u8907\u96dc\u5ea6?}\n    B --&gt;|&gt;50 \u6a94| D[\u2705 Pipeline \u67b6\u69cb]\n\n    C --&gt;|\u7c21\u55ae| D\n    C --&gt;|\u8907\u96dc| Y[\u8003\u616e\u6280\u8853\u6307\u6a19\u67b6\u69cb]\n\n    style D fill:#c8e6c9,stroke:#388e3c,stroke-width:3px</code></pre>"},{"location":"blocks/pipeline/#_11","title":"\u5178\u578b\u4f7f\u7528\u6848\u4f8b","text":"<ul> <li>\u2705 \u52d5\u91cf\u7b56\u7565\uff08\u5168\u5e02\u5834\u6383\u63cf\u5f37\u52e2\u80a1\uff09</li> <li>\u2705 \u50f9\u503c\u7b56\u7565\uff08\u4f4e PE\u3001\u4f4e PB\uff09</li> <li>\u2705 \u54c1\u8cea\u7b56\u7565\uff08\u9ad8 ROE\u3001\u4f4e\u8ca0\u50b5\uff09</li> <li>\u2705 \u591a\u56e0\u5b50\u7d44\u5408\uff08\u52d5\u91cf + \u50f9\u503c + \u54c1\u8cea\uff09</li> <li>\u2705 Smart Beta\uff08\u4f4e\u6ce2\u52d5\u3001\u7d05\u5229\u3001\u57fa\u672c\u9762\uff09</li> <li>\u2705 \u6a5f\u69cb\u8ffd\u8e64\uff08\u5927\u6236\u6301\u80a1\u8b8a\u5316\uff09</li> </ul>"},{"location":"blocks/pipeline/#_12","title":"\ud83c\udf93 \u5b78\u7fd2\u8def\u5f91","text":""},{"location":"blocks/pipeline/#4","title":"\u65b0\u624b\u5165\u9580\uff084 \u6b65\u9a5f\uff09","text":"<ol> <li>\u7406\u89e3 CustomFactor\uff1a\u81ea\u5b9a\u7fa9\u56e0\u5b50\u7684\u8a08\u7b97\u908f\u8f2f</li> <li>\u5b78\u7fd2 Pipeline\uff1a\u5982\u4f55\u7d44\u5408\u56e0\u5b50</li> <li>\u95b1\u8b80\u6848\u4f8b\uff1a\u5148\u770b <code>case-momentum.md</code></li> <li>\u8907\u88fd\u6a21\u677f\uff1a\u524d\u5f80 <code>template.md</code> \u958b\u59cb\u958b\u767c</li> </ol>"},{"location":"blocks/pipeline/#_13","title":"\u9032\u968e\u512a\u5316","text":"<ul> <li>\u591a\u56e0\u5b50\u52a0\u6b0a\uff08\u7b49\u6b0a\u3001\u5e02\u503c\u52a0\u6b0a\u3001\u56e0\u5b50\u52a0\u6b0a\uff09</li> <li>\u52d5\u614b\u8abf\u5009\u983b\u7387</li> <li>\u98a8\u96aa\u63a7\u7ba1\uff08\u90e8\u4f4d\u4e0a\u9650\u3001\u7522\u696d\u4e2d\u6027\uff09</li> <li>\u4ea4\u6613\u6210\u672c\u512a\u5316</li> </ul>"},{"location":"blocks/pipeline/#_14","title":"\ud83d\udd0d \u67b6\u69cb\u512a\u52e2\u8207\u9650\u5236","text":""},{"location":"blocks/pipeline/#_15","title":"\u512a\u52e2 \u2705","text":"<ol> <li> <p>\u6975\u81f4\u6548\u80fd</p> <ul> <li>\u5411\u91cf\u5316\u8a08\u7b97\uff0c\u901f\u5ea6\u5feb 100 \u500d</li> <li>\u53ef\u8655\u7406\u5168\u5e02\u5834 2000 \u6a94\u80a1\u7968</li> <li>\u9069\u5408\u5927\u898f\u6a21\u56de\u6e2c</li> </ul> </li> <li> <p>\u6a21\u7d44\u5316\u8a2d\u8a08</p> <ul> <li>\u56e0\u5b50\u53ef\u63d2\u62d4</li> <li>\u6613\u65bc\u6e2c\u8a66\u55ae\u4e00\u56e0\u5b50</li> <li>\u6613\u65bc\u7d44\u5408\u591a\u56e0\u5b50</li> </ul> </li> <li> <p>\u5de5\u696d\u7d1a\u6a19\u6e96</p> <ul> <li>Quantopian\u3001WorldQuant \u4f7f\u7528\u7684\u67b6\u69cb</li> <li>\u6709\u5927\u91cf\u958b\u6e90\u56e0\u5b50\u5eab</li> <li>\u793e\u7fa4\u8cc7\u6e90\u8c50\u5bcc</li> </ul> </li> <li> <p>\u53ef\u64f4\u5c55\u6027</p> <ul> <li>\u5f9e 10 \u6a94\u5230 10000 \u6a94\u7121\u75db\u5347\u7d1a</li> <li>\u56e0\u5b50\u6578\u91cf\u53ef\u4efb\u610f\u589e\u52a0</li> <li>\u652f\u63f4\u8907\u96dc\u7684\u7be9\u9078\u908f\u8f2f</li> </ul> </li> </ol>"},{"location":"blocks/pipeline/#_16","title":"\u9650\u5236 \u26a0\ufe0f","text":"<ol> <li> <p>\u5b78\u7fd2\u66f2\u7dda\u9661\u5ced</p> <ul> <li>\u9700\u8981\u7406\u89e3 NumPy \u5411\u91cf\u5316</li> <li>CustomFactor \u8a9e\u6cd5\u8f03\u62bd\u8c61</li> <li>Debug \u56f0\u96e3</li> </ul> </li> <li> <p>\u5f48\u6027\u53d7\u9650</p> <ul> <li>\u96e3\u4ee5\u5be6\u73fe\u8907\u96dc if-else \u908f\u8f2f</li> <li>\u7121\u6cd5\u6839\u64da\u7576\u524d\u6301\u5009\u52d5\u614b\u8abf\u6574</li> <li>\u4e0d\u9069\u5408\u9ad8\u983b\u4ea4\u6613</li> </ul> </li> <li> <p>\u6587\u6a94\u8f03\u5c11</p> <ul> <li>Zipline \u5b98\u65b9\u6587\u6a94\u4e0d\u5b8c\u6574</li> <li>\u4e2d\u6587\u8cc7\u6e90\u7a00\u7f3a</li> <li>\u9700\u8981\u95b1\u8b80\u6e90\u78bc</li> </ul> </li> </ol>"},{"location":"blocks/pipeline/#_17","title":"\ud83d\udee0\ufe0f \u6838\u5fc3\u7d44\u4ef6\u4ecb\u7d39","text":""},{"location":"blocks/pipeline/#1-customfactor-","title":"1. CustomFactor - \u81ea\u5b9a\u7fa9\u56e0\u5b50","text":"<pre><code>from zipline.pipeline import CustomFactor\nimport numpy as np\n\nclass Momentum(CustomFactor):\n    \"\"\"\n    \u52d5\u91cf\u56e0\u5b50\uff1a\u904e\u53bb N \u5929\u5831\u916c\u7387\n    \"\"\"\n    window_length = 252  # \u9700\u8981\u5e7e\u5929\u7684\u8cc7\u6599\n\n    def compute(self, today, assets, out, close):\n        \"\"\"\n        \u8a08\u7b97\u908f\u8f2f\n\n        Parameters:\n        -----------\n        today : pd.Timestamp\n            \u7576\u524d\u65e5\u671f\n        assets : np.array\n            \u80a1\u7968\u4ee3\u78bc\u9663\u5217\n        out : np.array\n            \u8f38\u51fa\u9663\u5217\uff08\u8981\u586b\u5165\u8a08\u7b97\u7d50\u679c\uff09\n        close : np.array\n            \u6536\u76e4\u50f9\u77e9\u9663\uff08window_length \u00d7 \u80a1\u7968\u6578\uff09\n        \"\"\"\n        # \u8a08\u7b97\u5831\u916c\u7387\n        returns = (close[-1] - close[0]) / close[0]\n        out[:] = returns\n</code></pre> <p>\u95dc\u9375\u6982\u5ff5\uff1a</p> <ul> <li><code>window_length</code>\uff1a\u9700\u8981\u591a\u5c11\u5929\u7684\u6b77\u53f2\u8cc7\u6599</li> <li><code>inputs</code>\uff1a\u9700\u8981\u54ea\u4e9b\u6b04\u4f4d\uff08close, volume, etc.\uff09</li> <li><code>compute</code>\uff1a\u8a08\u7b97\u908f\u8f2f\uff08\u5411\u91cf\u5316\uff09</li> </ul>"},{"location":"blocks/pipeline/#2-pipeline-","title":"2. Pipeline - \u56e0\u5b50\u7d44\u5408","text":"<pre><code>from zipline.pipeline import Pipeline\n\ndef make_pipeline():\n    # \u5b9a\u7fa9\u56e0\u5b50\n    momentum = Momentum()\n    volatility = Volatility()\n\n    # \u5b9a\u7fa9\u7be9\u9078\u5668\n    screen = (momentum &gt; 0)\n\n    # \u7d44\u5408 Pipeline\n    pipe = Pipeline(\n        columns={\n            'momentum': momentum,\n            'volatility': volatility\n        },\n        screen=screen\n    )\n\n    return pipe\n</code></pre>"},{"location":"blocks/pipeline/#3-pipeline_output-","title":"3. pipeline_output() - \u53d6\u5f97\u7d50\u679c","text":"<pre><code>def before_trading_start(context, data):\n    # \u53d6\u5f97 Pipeline \u8f38\u51fa\n    output = pipeline_output('my_pipeline')\n\n    # output \u662f DataFrame\n    # Index: \u80a1\u7968\u4ee3\u78bc\n    # Columns: \u56e0\u5b50\u503c\n\n    # \u9078\u51fa\u524d 10 \u540d\n    top10 = output.nlargest(10, 'momentum')\n\n    # \u5132\u5b58\u5230 context\n    context.stocks = top10.index.tolist()\n</code></pre>"},{"location":"blocks/pipeline/#4-rebalance-","title":"4. rebalance() - \u8abf\u5009\u51fd\u6578","text":"<pre><code>def rebalance(context, data):\n    # \u8a08\u7b97\u76ee\u6a19\u6b0a\u91cd\n    weights = {}\n    for stock in context.stocks:\n        weights[stock] = 1.0 / len(context.stocks)\n\n    # \u57f7\u884c\u8abf\u5009\n    for stock, weight in weights.items():\n        order_target_percent(stock, weight)\n</code></pre>"},{"location":"blocks/pipeline/#_18","title":"\u26a0\ufe0f \u5e38\u898b\u9677\u9631","text":""},{"location":"blocks/pipeline/#1_1","title":"\u9677\u9631 1\uff1a\u5fd8\u8a18\u5411\u91cf\u5316","text":"<pre><code># \u274c \u932f\u8aa4\uff1a\u7528\u8ff4\u5708\nclass MyFactor(CustomFactor):\n    def compute(self, today, assets, out, close):\n        for i in range(len(assets)):\n            out[i] = close[:, i].mean()  # \u6162\uff01\n\n# \u2705 \u6b63\u78ba\uff1a\u5411\u91cf\u5316\nclass MyFactor(CustomFactor):\n    def compute(self, today, assets, out, close):\n        out[:] = np.mean(close, axis=0)  # \u5feb\uff01\n</code></pre>"},{"location":"blocks/pipeline/#2window_length","title":"\u9677\u9631 2\uff1awindow_length \u8a2d\u5b9a\u932f\u8aa4","text":"<pre><code># \u274c \u932f\u8aa4\uff1a\u9700\u8981 252 \u5929\u8cc7\u6599\uff0c\u4f46\u53ea\u8a2d 20\nclass Momentum(CustomFactor):\n    window_length = 20  # \u4e0d\u5920\uff01\n    def compute(self, today, assets, out, close):\n        returns = (close[-1] - close[-252]) / close[-252]\n        # IndexError: \u53ea\u6709 20 \u7b46\u8cc7\u6599\n\n# \u2705 \u6b63\u78ba\nclass Momentum(CustomFactor):\n    window_length = 252  # \u8db3\u5920\n    def compute(self, today, assets, out, close):\n        returns = (close[-1] - close[0]) / close[0]\n</code></pre>"},{"location":"blocks/pipeline/#3-nan","title":"\u9677\u9631 3\uff1a\u5ffd\u7565 NaN \u8655\u7406","text":"<pre><code># \u274c \u932f\u8aa4\uff1a\u6c92\u8655\u7406 NaN\nclass MyFactor(CustomFactor):\n    def compute(self, today, assets, out, close):\n        out[:] = np.mean(close, axis=0)\n        # \u5982\u679c\u6709 NaN\uff0c\u7d50\u679c\u4e5f\u6703\u662f NaN\n\n# \u2705 \u6b63\u78ba\uff1a\u4f7f\u7528 nanmean\nclass MyFactor(CustomFactor):\n    def compute(self, today, assets, out, close):\n        out[:] = np.nanmean(close, axis=0)\n</code></pre>"},{"location":"blocks/pipeline/#_19","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6a21\u677f\u9801\u9762\uff1atemplate.md</li> <li>\u6848\u4f8b\u5b78\u7fd2\uff1a</li> <li>Expanded Momentum - \u52d5\u91cf\u7b56\u7565</li> <li>\u8ddf\u96a8\u5927\u6236 - \u7c4c\u78bc\u5206\u6790</li> <li>CounterTrend - \u9006\u52e2\u7b56\u7565</li> <li>\u5e38\u898b\u554f\u984c\uff1afaq.md</li> </ul>"},{"location":"blocks/pipeline/#_20","title":"\ud83d\udca1 \u7e3d\u7d50","text":"<p>Pipeline \u56e0\u5b50\u67b6\u69cb\u9069\u5408\uff1a</p> <ul> <li>\ud83d\udcca \u91cf\u5316\u7814\u7a76\u4eba\u54e1</li> <li>\ud83c\udfed \u5927\u898f\u6a21\u80a1\u7968\u6c60\uff0850+ \u6a94\uff09</li> <li>\u26a1 \u8ffd\u6c42\u6975\u81f4\u6548\u80fd</li> <li>\ud83d\udd2c \u56e0\u5b50\u6295\u8cc7\u611b\u597d\u8005</li> </ul> <p>\u6838\u5fc3\u512a\u52e2\uff1a</p> <ol> <li>\u2705 \u6548\u80fd\u6975\u81f4\uff08\u5411\u91cf\u5316\u8a08\u7b97\uff09</li> <li>\u2705 \u6a21\u7d44\u5316\u8a2d\u8a08\uff08\u56e0\u5b50\u53ef\u63d2\u62d4\uff09</li> <li>\u2705 \u53ef\u64f4\u5c55\u6027\u5f37\uff0810 \u6a94\u5230 10000 \u6a94\uff09</li> <li>\u2705 \u5de5\u696d\u7d1a\u6a19\u6e96\uff08Quantopian \u540c\u6b3e\uff09</li> </ol> <p>\u4f7f\u7528\u9650\u5236\uff1a</p> <ol> <li>\u26a0\ufe0f \u5b78\u7fd2\u66f2\u7dda\u9661\u5ced</li> <li>\u26a0\ufe0f \u5f48\u6027\u53d7\u9650\uff08\u96e3\u4ee5\u5be6\u73fe\u8907\u96dc\u908f\u8f2f\uff09</li> <li>\u26a0\ufe0f Debug \u56f0\u96e3</li> </ol> <p>\ud83d\udc49 Next Step: \u524d\u5f80 template.md \u958b\u59cb\u958b\u767c\u4f60\u7684 Pipeline \u7b56\u7565\uff01</p>"},{"location":"blocks/pipeline/#_21","title":"\ud83d\udcd6 \u5ef6\u4f38\u95b1\u8b80","text":"<p>Pipeline \u8a2d\u8a08\u54f2\u5b78\uff1a</p> <ul> <li>\u53d7 Pandas \u555f\u767c\u7684\u8072\u660e\u5f0f API</li> <li>\u985e\u4f3c SQL \u7684\u67e5\u8a62\u601d\u7dad</li> <li>\u5411\u91cf\u5316\u512a\u5148\uff08\u907f\u514d\u8ff4\u5708\uff09</li> </ul> <p>\u9069\u5408\u7684\u7b56\u7565\u985e\u578b\uff1a</p> <ul> <li>\u7d71\u8a08\u5957\u5229\uff08\u591a\u7a7a\u5c0d\u6c96\uff09</li> <li>Smart Beta\uff08\u56e0\u5b50\u6295\u8cc7\uff09</li> <li>\u91cf\u5316\u9078\u80a1\uff08\u591a\u56e0\u5b50\u6a21\u578b\uff09</li> <li>\u4e8b\u4ef6\u9a45\u52d5\uff08earnings\u3001\u5206\u62c6\uff09</li> </ul> <p>\u672c\u67b6\u69cb\u662f\u5f9e Quantopian \u79fb\u690d\u800c\u4f86\uff0c\u5df2\u88ab\u5168\u7403\u6578\u842c\u91cf\u5316\u4ea4\u6613\u8005\u9a57\u8b49\u3002</p>"},{"location":"blocks/pipeline/case-countertrend/","title":"\u6848\u4f8b 3\uff1aCounterTrend \u9006\u52e2\u7b56\u7565","text":"<p>\u7b56\u7565\u985e\u578b\uff1a Pipeline \u56e0\u5b50\u67b6\u69cb - \u5747\u503c\u56de\u6b78 \u4ea4\u6613\u6a19\u7684\uff1a 81 \u6a94\u6b0a\u503c\u80a1 \u8abf\u5009\u983b\u7387\uff1a \u65e5\u5ea6\uff08\u6bcf\u65e5\u6536\u76e4\u524d\uff09 \u56de\u6e2c\u671f\u9593\uff1a 2018-06-01 ~ 2023-07-30</p>"},{"location":"blocks/pipeline/case-countertrend/#_1","title":"\ud83d\udccc \u7b56\u7565\u6982\u8ff0","text":"<p>CounterTrend \u662f\u4e00\u500b\u7d50\u5408 \u8da8\u52e2\u904e\u6ffe \u548c \u5747\u503c\u56de\u6b78 \u7684\u9006\u52e2\u7b56\u7565\uff0c\u5728\u9577\u671f\u8da8\u52e2\u5411\u4e0a\u7684\u524d\u63d0\u4e0b\uff0c\u9022\u4f4e\u627f\u63a5\u77ed\u671f\u56de\u6a94\u3002</p>"},{"location":"blocks/pipeline/case-countertrend/#_2","title":"\u6838\u5fc3\u7406\u5ff5","text":"<p>\"Buy the dip in an uptrend.\" \u5728\u4e0a\u5347\u8da8\u52e2\u4e2d\uff0c\u8cb7\u5165\u7d71\u8a08\u4e0a\u7684\u8d85\u8dcc\u9ede\u4f4d\u3002</p> <p>\u5e02\u5834\u5e38\u898b\u73fe\u8c61\uff1a</p> <ul> <li>\ud83d\udcc8 \u9577\u671f\u8da8\u52e2\uff1a\u80a1\u50f9\u6cbf\u8457\u5747\u7dda\u5411\u4e0a</li> <li>\ud83d\udcc9 \u77ed\u671f\u56de\u6a94\uff1a\u5076\u723e\u8dcc\u7834\u652f\u6490</li> <li>\ud83d\udd04 \u5747\u503c\u56de\u6b78\uff1a\u56de\u6a94\u5f8c\u901a\u5e38\u53cd\u5f48</li> </ul> <p>CounterTrend \u7684\u667a\u6167\u5728\u65bc \u4e0d\u662f\u6240\u6709\u56de\u6a94\u90fd\u8cb7\uff0c\u53ea\u5728\u9577\u671f\u8da8\u52e2\u78ba\u8a8d\u5411\u4e0a\u6642\u624d\u9032\u5834\uff0c\u4e14\u5229\u7528\u7d71\u8a08\u5b78\u65b9\u6cd5\uff08-3\u03c3\uff09\u78ba\u8a8d\u8d85\u8dcc\u3002</p>"},{"location":"blocks/pipeline/case-countertrend/#_3","title":"\u7b56\u7565\u7279\u8272","text":"<ol> <li>EMA \u96d9\u5747\u7dda\u8da8\u52e2\u904e\u6ffe\uff1aEMA(40) &gt; EMA(80)</li> <li>\u7d71\u8a08\u5b78\u8cb7\u9ede\uff1a\u50f9\u683c &lt; 20 \u65e5\u9ad8\u9ede - 3\u03c3</li> <li>\u98a8\u96aa\u5e73\u50f9\u6b0a\u91cd\uff1a\u6839\u64da\u6ce2\u52d5\u7387\u8abf\u6574\u6301\u80a1</li> <li>\u5f37\u5236\u51fa\u5834\uff1a\u6301\u6709 20 \u5929\u6216\u8da8\u52e2\u53cd\u8f49</li> <li>\u6b0a\u503c\u80a1\u7968\u6c60\uff1a81 \u6a94\u5e02\u503c\u5927\u3001\u6d41\u52d5\u6027\u597d\u7684\u80a1\u7968</li> </ol>"},{"location":"blocks/pipeline/case-countertrend/#_4","title":"\ud83c\udfaf \u9078\u80a1\u908f\u8f2f\u8a73\u89e3","text":""},{"location":"blocks/pipeline/case-countertrend/#step-1","title":"Step 1: \u8da8\u52e2\u904e\u6ffe","text":"<p>EMA \u96d9\u5747\u7dda\u78ba\u8a8d\u591a\u982d\uff1a <pre><code># \u8a08\u7b97 EMA\nema_fast = close.ewm(span=40).mean()\nema_slow = close.ewm(span=80).mean()\n\n# \u5224\u65b7\u8da8\u52e2\ntrend_up = ema_fast &gt; ema_slow\n</code></pre></p> <p>\u70ba\u4ec0\u9ebc\u7528 EMA \u800c\u975e SMA\uff1f</p> <ul> <li>EMA \u5c0d\u8fd1\u671f\u50f9\u683c\u66f4\u654f\u611f</li> <li>\u53cd\u61c9\u901f\u5ea6\u8f03\u5feb</li> <li>\u66f4\u9069\u5408\u6355\u6349\u8da8\u52e2\u8f49\u8b8a</li> </ul>"},{"location":"blocks/pipeline/case-countertrend/#step-2","title":"Step 2: \u56de\u6a94\u8cb7\u9ede","text":"<p>\u7d71\u8a08\u5b78\u8d85\u8dcc\uff1a <pre><code># \u8a08\u7b97\u904e\u53bb 20 \u65e5\u6700\u9ad8\u50f9\nhighest_20d = close[-20:].max()\n\n# \u8a08\u7b97 60 \u65e5\u6ce2\u52d5\u7387\uff08\u6a19\u6e96\u5dee\uff09\nstd_60d = close[-60:].pct_change().std() * 100\n\n# \u8a08\u7b97\u56de\u6a94\u5e45\u5ea6\npullback = (current_price - highest_20d) / std_60d\n\n# \u8d85\u8dcc\u5224\u65b7\uff1a\u56de\u6a94 &lt; -3\u03c3\nif pullback &lt; -3:\n    buy = True\n</code></pre></p> <p>\u70ba\u4ec0\u9ebc\u7528 -3\u03c3\uff1f</p> <p>\u6839\u64da\u5e38\u614b\u5206\u4f48\uff1a</p> <ul> <li>\u00b11\u03c3\uff1a68.27% \u7684\u6578\u64da</li> <li>\u00b12\u03c3\uff1a95.45% \u7684\u6578\u64da</li> <li>\u00b13\u03c3\uff1a99.73% \u7684\u6578\u64da</li> </ul> <p>\u50f9\u683c\u8dcc\u7834 -3\u03c3 \u975e\u5e38\u7f55\u898b\uff0c\u4ee3\u8868 \u6975\u5ea6\u8d85\u8ce3\uff0c\u53cd\u5f48\u6a5f\u7387\u9ad8\u3002</p>"},{"location":"blocks/pipeline/case-countertrend/#step-3","title":"Step 3: \u98a8\u96aa\u5e73\u50f9\u6b0a\u91cd","text":"<pre><code>def position_size(portfolio_value, std, risk_factor=0.01):\n    \"\"\"\n    \u6839\u64da\u6ce2\u52d5\u7387\u8a08\u7b97\u6301\u80a1\u6578\u91cf\n\n    \u908f\u8f2f\uff1a\n    - \u76ee\u6a19\u98a8\u96aa = \u6295\u7d44\u50f9\u503c \u00d7 \u98a8\u96aa\u4fc2\u6578\n    - \u5408\u7d04\u6ce2\u52d5 = \u6a19\u6e96\u5dee \u00d7 \u9ede\u503c\n    - \u6301\u80a1\u6578 = \u76ee\u6a19\u98a8\u96aa / \u5408\u7d04\u6ce2\u52d5\n    \"\"\"\n    target_variation = portfolio_value * risk_factor\n    contract_variation = std * 1  # \u9ede\u503c = 1\n    contracts = target_variation / contract_variation\n\n    return int(contracts)\n</code></pre> <p>\u610f\u7fa9\uff1a</p> <ul> <li>\u6ce2\u52d5\u7387\u4f4e\u7684\u80a1\u7968\uff0c\u8cb7\u5165\u6578\u91cf\u591a</li> <li>\u6ce2\u52d5\u7387\u9ad8\u7684\u80a1\u7968\uff0c\u8cb7\u5165\u6578\u91cf\u5c11</li> <li>\u6bcf\u6a94\u80a1\u7968\u5c0d\u6295\u7d44\u98a8\u96aa\u7684\u8ca2\u737b\u76f8\u7b49</li> </ul>"},{"location":"blocks/pipeline/case-countertrend/#step-4","title":"Step 4: \u6301\u6709\u671f\u7ba1\u7406","text":"<p>\u5169\u7a2e\u51fa\u5834\u60c5\u5883\uff1a</p> <ol> <li>\u6642\u9593\u51fa\u5834\uff1a\u6301\u6709 20 \u5929</li> <li>\u8da8\u52e2\u51fa\u5834\uff1aEMA(40) &lt; EMA(80)</li> </ol>"},{"location":"blocks/pipeline/case-countertrend/#_5","title":"\ud83d\udd0d \u5b8c\u6574\u4ea4\u6613\u6d41\u7a0b","text":""},{"location":"blocks/pipeline/case-countertrend/#_6","title":"\u8cb7\u5165\u689d\u4ef6\uff08\u5fc5\u9808\u5168\u90e8\u6eff\u8db3\uff09","text":"<ol> <li>EMA(40) &gt; EMA(80)\uff08\u9577\u671f\u8da8\u52e2\u5411\u4e0a\uff09</li> <li>\u56de\u6a94\u5e45\u5ea6 &lt; -3\u03c3\uff08\u7d71\u8a08\u4e0a\u8d85\u8dcc\uff09</li> <li>\u76ee\u524d\u7121\u6301\u5009</li> </ol>"},{"location":"blocks/pipeline/case-countertrend/#_7","title":"\u8ce3\u51fa\u689d\u4ef6\uff08\u4efb\u4e00\u6eff\u8db3\uff09","text":"<ol> <li>\u6301\u6709\u5929\u6578 \u2265 20 \u5929\uff08\u6642\u9593\u5230\u671f\uff09</li> <li>EMA(40) &lt; EMA(80)\uff08\u8da8\u52e2\u53cd\u8f49\uff09</li> </ol>"},{"location":"blocks/pipeline/case-countertrend/#_8","title":"\ud83d\udcbb \u5b8c\u6574\u7a0b\u5f0f\u78bc","text":"<pre><code># ====================================\n# CounterTrend \u9006\u52e2\u7b56\u7565 - \u5b8c\u6574\u5be6\u4f5c\n# ====================================\n\nimport os\nimport pandas as pd\nimport numpy as np\nimport pytz\nimport matplotlib.pyplot as plt\n\n# ====================================\n# \u74b0\u5883\u8a2d\u5b9a\n# ====================================\nos.environ['TEJAPI_KEY'] = \"your_key\"\nos.environ['TEJAPI_BASE'] = \"https://api.tej.com.tw\"\n\n# ====================================\n# Zipline \u5957\u4ef6\u5f15\u5165\n# ====================================\nimport zipline\nfrom zipline.data import bundles\nfrom zipline.utils.calendar_utils import get_calendar\nfrom zipline.api import *\nfrom zipline.finance.commission import PerDollar\nfrom zipline.finance.slippage import VolumeShareSlippage\nfrom zipline.sources.TEJ_Api_Data import get_Treasury_Return\nfrom zipline.utils.run_algo import get_transaction_detail, get_record_vars\n\nimport pyfolio as pf\n\nplt.rcParams['axes.unicode_minus'] = False\nplt.rcParams['font.sans-serif'] = ['Microsoft JhengHei']\n\n# ====================================\n# \u53c3\u6578\u8a2d\u5b9a\n# ====================================\n# \u80a1\u7968\u6c60\uff1a81 \u6a94\u6b0a\u503c\u80a1\nStockList = [\n    '1101', '1102', '1216', '1301', '1303', '1326', '1402', '1722', '2002', '2105',\n    '2201', '2207', '2301', '2303', '2308', '2311', '2317', '2324', '2325', '2330',\n    '2347', '2353', '2354', '2357', '2382', '2409', '2412', '2454', '2474', '2498',\n    '2801', '2880', '2881', '2882', '2883', '2885', '2886', '2890', '2891', '2892',\n    '2912', '3008', '3045', '3231', '3481', '3673', '3697', '4904', '5880', '6505',\n    '2884', '4938', '2887', '2227', '9904', '3474', '2395', '2408', '1476', '2823',\n    '2633', '5871', '2327', '3711', '2492', '5876', '9910', '2888', '6669', '2379',\n    '6415', '3034', '1590', '8046', '2603', '2609', '2615', '8454', '3037', '6770',\n    '1605', 'IR0001'\n]\n\n# \u56de\u6e2c\u671f\u9593\nstart = '2018-06-01'\nend = '2023-07-30'\n\nstart_dt = pd.Timestamp(start, tz=pytz.utc)\nend_dt = pd.Timestamp(end, tz=pytz.utc)\n\n# ====================================\n# \u7b56\u7565\u53c3\u6578\n# ====================================\nstarting_portfolio = 10e6      # \u521d\u59cb\u8cc7\u91d1 1000 \u842c\nrisk_factor = 0.01             # \u98a8\u96aa\u4fc2\u6578 1%\nslow_ma = 80                   # \u9577\u671f\u5747\u7dda\u9031\u671f\nfast_ma = 40                   # \u77ed\u671f\u5747\u7dda\u9031\u671f\nvola_window = 60               # \u6ce2\u52d5\u7387\u8a08\u7b97\u9031\u671f\nhigh_window = 20               # \u6700\u9ad8\u50f9\u8a08\u7b97\u9031\u671f\ndays_to_hold = 20              # \u6700\u9577\u6301\u6709\u5929\u6578\ndip_buy = -3                   # \u56de\u6a94\u8cb7\u5165\u9580\u6abb\uff08-3\u03c3\uff09\n\n# \u4ea4\u6613\u6210\u672c\ncommission_pct = 0.0029        # \u4f63\u91d1 0.29%\nslippage_volume_limit = 1.0    # \u6ed1\u50f9\u9650\u5236\nslippage_impact = 0            # \u6ed1\u50f9\u5f71\u97ff 0%\n\n# ====================================\n# Ingest \u80a1\u50f9\u8cc7\u6599\n# ====================================\nos.environ['ticker'] = ' '.join(StockList)\nos.environ['mdate'] = start + ' ' + end\n\n# !zipline ingest -b tquant\n\ncalendar_name = 'TEJ_XTAI'\nbundle_name = 'tquant'\n\n# ====================================\n# \u7b56\u7565\u51fd\u6578\n# ====================================\ndef position_size(portfolio_value, std, risk_factor=0.01):\n    \"\"\"\n    \u6839\u64da\u6ce2\u52d5\u7387\u8a08\u7b97\u6301\u80a1\u50f9\u503c\n\n    \u98a8\u96aa\u5e73\u50f9\u908f\u8f2f\uff1a\n    - \u6bcf\u6a94\u80a1\u7968\u5c0d\u6295\u7d44\u98a8\u96aa\u7684\u8ca2\u737b\u76f8\u7b49\n    - \u6ce2\u52d5\u7387\u4f4e \u2192 \u8cb7\u5165\u591a\n    - \u6ce2\u52d5\u7387\u9ad8 \u2192 \u8cb7\u5165\u5c11\n    \"\"\"\n    target_variation = portfolio_value * risk_factor\n    contract_variation = std * 1  # \u9ede\u503c = 1\n    contracts = target_variation / contract_variation\n\n    return int(np.nan_to_num(contracts))\n\ndef initialize(context):\n    \"\"\"\n    \u521d\u59cb\u5316\u51fd\u6578\n    \"\"\"\n    # \u4ea4\u6613\u6210\u672c\u8a2d\u5b9a\n    set_commission(PerDollar(cost=commission_pct))\n    set_slippage(\n        VolumeShareSlippage(\n            volume_limit=slippage_volume_limit,\n            price_impact=slippage_impact\n        )\n    )\n\n    # \u8f09\u5165\u80a1\u7968\u6c60\n    bundle_data = bundles.load(bundle_name)\n    context.universe = bundle_data.asset_finder.retrieve_all(\n        bundle_data.asset_finder.equities_sids\n    )\n\n    # \u8a2d\u5b9a\u57fa\u6e96\n    set_benchmark(symbol('IR0001'))\n\n    # \u7e3e\u6548\u8ffd\u8e64\n    context.months = 0\n\n    # \u6301\u6709\u5929\u6578\u8ffd\u8e64\n    context.bars_held = {asset.symbol: 0 for asset in context.universe}\n\n    # \u6392\u7a0b\uff1a\u6bcf\u65e5\u6536\u76e4\u524d\u4ea4\u6613\n    schedule_function(\n        daily_trade,\n        date_rules.every_day(),\n        time_rules.market_close()\n    )\n\n    # \u6392\u7a0b\uff1a\u6bcf\u6708\u5831\u544a\n    schedule_function(\n        func=report_result,\n        date_rule=date_rules.month_start(),\n        time_rule=time_rules.market_open()\n    )\n\ndef report_result(context, data):\n    \"\"\"\n    \u8f38\u51fa\u7e3e\u6548\u5831\u544a\n    \"\"\"\n    context.months += 1\n    today = get_datetime().date()\n\n    # \u8a08\u7b97\u5e74\u5316\u5831\u916c\n    ann_ret = np.power(\n        context.portfolio.portfolio_value / starting_portfolio,\n        12 / context.months\n    ) - 1\n\n    print(f\"{today} \u5df2\u4ea4\u6613 {context.months} \u500b\u6708\uff0c\u5e74\u5316\u5831\u916c\uff1a{ann_ret:.2%}\")\n\ndef daily_trade(context, data):\n    \"\"\"\n    \u6bcf\u65e5\u4ea4\u6613\u908f\u8f2f\n    \"\"\"\n    today = data.current_session.date()\n    todays_universe = context.universe\n\n    # \u53d6\u5f97\u6b77\u53f2\u8cc7\u6599\n    hist_close = data.history(\n        todays_universe,\n        ['close', 'volume'],\n        bar_count=high_window + 1,\n        frequency='1d'\n    )['close']\n\n    hist_volume = data.history(\n        todays_universe,\n        ['close', 'volume'],\n        bar_count=high_window + 1,\n        frequency='1d'\n    )['volume']\n\n    for _asset in todays_universe:\n\n        # \u6392\u9664\u57fa\u6e96\u6307\u6578\n        if _asset == symbol('IR0001'):\n            continue\n\n        # \u53d6\u5f97\u8a72\u80a1\u7968\u7684\u6b77\u53f2\u8cc7\u6599\n        h_close = hist_close.unstack()[_asset]\n        h_volume = hist_volume.unstack()[_asset]\n\n        # \u8a08\u7b97\u6ce2\u52d5\u7387\uff0860 \u65e5\u6a19\u6e96\u5dee\uff09\n        h_std = (\n            hist_close.unstack()\n            .pct_change()\n            .iloc[-vola_window:]\n            .std()[_asset] * 100\n        )\n\n        # ========================================\n        # \u8a08\u7b97\u8da8\u52e2\uff08EMA \u96d9\u5747\u7dda\uff09\n        # ========================================\n        h_trend = (\n            h_close.ewm(span=fast_ma).mean() &gt;\n            h_close.ewm(span=slow_ma).mean()\n        )\n\n        # ========================================\n        # \u5df2\u6301\u5009\u7684\u8655\u7406\n        # ========================================\n        if _asset in context.portfolio.positions:\n\n            p = context.portfolio.positions[_asset]\n            context.bars_held[_asset] += 1  # \u6301\u6709\u5929\u6578 +1\n\n            if p.amount &gt; 0:  # \u591a\u982d\u90e8\u4f4d\n\n                # \u51fa\u5834\u689d\u4ef6 1: \u6301\u6709\u8d85\u904e 20 \u5929\n                if context.bars_held[_asset] &gt;= days_to_hold:\n                    order_target(_asset, 0)\n                    print(f\"{today} \u6301\u6709 {_asset.symbol} \u8d85\u904e {days_to_hold} \u5929\uff0c\u51fa\u5834\")\n\n                # \u51fa\u5834\u689d\u4ef6 2: \u8da8\u52e2\u53cd\u8f49\n                elif h_trend.iloc[-1] == False:\n                    order_target(_asset, 0)\n                    print(f\"{today} {_asset.symbol} \u8da8\u52e2\u53cd\u8f49\uff0c\u51fa\u5834\")\n\n        # ========================================\n        # \u672a\u6301\u5009\u7684\u8655\u7406\n        # ========================================\n        else:\n\n            # \u53ea\u5728\u8da8\u52e2\u5411\u4e0a\u6642\u8003\u616e\u9032\u5834\n            if h_trend.iloc[-1]:\n\n                # \u8a08\u7b97\u56de\u6a94\u5e45\u5ea6\n                pullback = (\n                    h_close.values[-1] - np.max(h_close.values[-high_window:])\n                ) / h_std\n\n                # \u9032\u5834\u689d\u4ef6\uff1a\u56de\u6a94 &lt; -3\u03c3\n                if pullback &lt; dip_buy:\n\n                    # \u8a08\u7b97\u6301\u80a1\u50f9\u503c\n                    volume_to_trade = position_size(\n                        context.portfolio.portfolio_value,\n                        h_std,\n                        risk_factor\n                    )\n\n                    # \u4e0b\u55ae\n                    order_value(_asset, volume_to_trade)\n\n                    # \u91cd\u7f6e\u6301\u6709\u5929\u6578\n                    context.bars_held[_asset] = 0\n\n                    print(f\"{today} {_asset.symbol} \u56de\u6a94 {pullback:.2f}\u03c3\uff0c\u8cb7\u5165\")\n\n# ====================================\n# \u53d6\u5f97\u7121\u98a8\u96aa\u5229\u7387\n# ====================================\nprint(\"\u6b63\u5728\u53d6\u5f97\u7121\u98a8\u96aa\u5229\u7387\u8cc7\u6599...\")\n\ntreasury_returns = get_Treasury_Return(\n    start=start_dt,\n    end=end_dt,\n    rate_type='Time_Deposit_Rate',\n    term='1y',\n    symbol='5844'  # \u7b2c\u4e00\u9280\u884c\u4e00\u5e74\u671f\u5b9a\u5b58\n)\n\nprint(f\"\u7121\u98a8\u96aa\u5229\u7387\u8cc7\u6599\u8f09\u5165\u5b8c\u6210\uff1a{len(treasury_returns)} \u7b46\")\n\n# ====================================\n# \u57f7\u884c\u56de\u6e2c\n# ====================================\nprint(\"=\"*60)\nprint(\"\u958b\u59cb\u56de\u6e2c CounterTrend \u9006\u52e2\u7b56\u7565\")\nprint(f\"\u671f\u9593\uff1a{start} ~ {end}\")\nprint(f\"\u521d\u59cb\u8cc7\u91d1\uff1a{starting_portfolio:,.0f} \u5143\")\nprint(\"=\"*60)\n\nresults = zipline.run_algorithm(\n    start=start_dt,\n    end=end_dt,\n    initialize=initialize,\n    capital_base=starting_portfolio,\n    data_frequency='daily',\n    treasury_returns=treasury_returns,\n    trading_calendar=get_calendar(calendar_name),\n    bundle=bundle_name\n)\n\nprint(\"\\n\u56de\u6e2c\u5b8c\u6210\uff01\")\n\n# ====================================\n# \u7e3e\u6548\u7d71\u8a08\n# ====================================\nprint(\"\\n========== \u7e3e\u6548\u6458\u8981 ==========\")\n\ntotal_return = (results['portfolio_value'].iloc[-1] / starting_portfolio - 1) * 100\nbenchmark_return = results['benchmark_period_return'].iloc[-1] * 100\n\nprint(f\"\u7b56\u7565\u7e3d\u5831\u916c: {total_return:.2f}%\")\nprint(f\"\u57fa\u6e96\u5831\u916c: {benchmark_return:.2f}%\")\nprint(f\"\u8d85\u984d\u5831\u916c: {(total_return - benchmark_return):.2f}%\")\nprint(f\"\u6700\u5927\u56de\u64a4: {results['max_drawdown'].min() * 100:.2f}%\")\n\nresults.to_csv('countertrend_results.csv')\nprint(f\"\\n\u8a73\u7d30\u7d50\u679c\u5df2\u5132\u5b58\u81f3: countertrend_results.csv\")\n\n# ====================================\n# Pyfolio \u7e3e\u6548\u5206\u6790\n# ====================================\ntry:\n    import pyfolio as pf\n\n    print(\"\\n\" + \"=\"*60)\n    print(\"Pyfolio \u7e3e\u6548\u5206\u6790\")\n    print(\"=\"*60)\n\n    # \u63d0\u53d6\u8cc7\u6599\n    bt_returns, bt_positions, bt_transactions = (\n        pf.utils.extract_rets_pos_txn_from_zipline(results)\n    )\n    benchmark_rets = results.benchmark_return\n\n    # \u8655\u7406\u6642\u5340\n    bt_returns.index = bt_returns.index.tz_localize(None).tz_localize('UTC')\n    bt_positions.index = bt_positions.index.tz_localize(None).tz_localize('UTC')\n    bt_transactions.index = bt_transactions.index.tz_localize(None).tz_localize('UTC')\n    benchmark_rets.index = benchmark_rets.index.tz_localize(None).tz_localize('UTC')\n\n    # \u751f\u6210\u5b8c\u6574\u7e3e\u6548\u5831\u544a\n    pf.create_full_tear_sheet(\n        bt_returns,\n        positions=bt_positions,\n        transactions=bt_transactions,\n        benchmark_rets=benchmark_rets,\n        round_trips=False\n    )\n\nexcept ImportError:\n    print(\"\\n\u672a\u5b89\u88dd pyfolio\uff0c\u7565\u904e\u8a73\u7d30\u5206\u6790\")\n    print(\"\u82e5\u9700\u5b8c\u6574\u5831\u544a\uff0c\u8acb\u57f7\u884c: pip install pyfolio\")\nexcept Exception as e:\n    print(f\"\\nPyfolio \u5206\u6790\u932f\u8aa4: {e}\")\n</code></pre>"},{"location":"blocks/pipeline/case-countertrend/#_9","title":"\ud83d\udcca \u7b56\u7565\u7279\u6027\u5206\u6790","text":""},{"location":"blocks/pipeline/case-countertrend/#_10","title":"\u512a\u52e2 \u2705","text":"<ol> <li> <p>\u8da8\u52e2 + \u5747\u503c\u56de\u6b78\u7d50\u5408</p> <ul> <li>\u4e0d\u662f\u76f2\u76ee\u9006\u52e2</li> <li>\u53ea\u5728\u591a\u982d\u8da8\u52e2\u4e2d\u8cb7\u56de\u6a94</li> <li>\u63d0\u9ad8\u52dd\u7387</li> </ul> </li> <li> <p>\u7d71\u8a08\u5b78\u8cb7\u9ede</p> <ul> <li>-3\u03c3 \u662f\u6975\u7aef\u503c</li> <li>\u53cd\u5f48\u6a5f\u7387\u9ad8</li> <li>\u6709\u7406\u8ad6\u652f\u6301</li> </ul> </li> <li> <p>\u98a8\u96aa\u5e73\u50f9\u6b0a\u91cd</p> <ul> <li>\u6839\u64da\u6ce2\u52d5\u7387\u8abf\u6574\u6301\u80a1</li> <li>\u6bcf\u6a94\u80a1\u7968\u98a8\u96aa\u8ca2\u737b\u76f8\u7b49</li> <li>\u964d\u4f4e\u7d44\u5408\u6ce2\u52d5</li> </ul> </li> <li> <p>\u6642\u9593\u51fa\u5834\u6a5f\u5236</p> <ul> <li>20 \u5929\u5f37\u5236\u51fa\u5834</li> <li>\u907f\u514d\u9577\u671f\u5957\u7262</li> <li>\u8cc7\u91d1\u5feb\u901f\u8f2a\u52d5</li> </ul> </li> <li> <p>\u6b0a\u503c\u80a1\u7968\u6c60</p> <ul> <li>\u6d41\u52d5\u6027\u597d</li> <li>\u57fa\u672c\u9762\u7a69\u5065</li> <li>\u7cfb\u7d71\u6027\u98a8\u96aa\u4f4e</li> </ul> </li> </ol>"},{"location":"blocks/pipeline/case-countertrend/#_11","title":"\u52a3\u52e2 \u26a0\ufe0f","text":"<ol> <li> <p>\u8da8\u52e2\u53cd\u8f49\u98a8\u96aa</p> <ul> <li>\u53ef\u80fd\u8cb7\u5728\u4e0b\u8dcc\u8d77\u9ede</li> <li>\u300c\u63a5\u843d\u4e0b\u7684\u5200\u300d</li> <li>\u9700\u8981\u56b4\u683c\u505c\u640d</li> </ul> </li> <li> <p>\u6301\u6709\u671f\u592a\u77ed</p> <ul> <li>20 \u5929\u53ef\u80fd\u4e0d\u5920</li> <li>\u932f\u904e\u5927\u6ce2\u6bb5</li> <li>\u4ea4\u6613\u6210\u672c\u9ad8</li> </ul> </li> <li> <p>\u53c3\u6578\u654f\u611f</p> <ul> <li>-3\u03c3 \u9580\u6abb\u4e0d\u4e00\u5b9a\u9069\u5408\u6240\u6709\u80a1\u7968</li> <li>EMA 40/80 \u662f\u7d93\u9a57\u503c</li> <li>\u9700\u8981\u512a\u5316</li> </ul> </li> <li> <p>\u9707\u76ea\u5e02\u8868\u73fe\u5dee</p> <ul> <li>\u6a6b\u76e4\u6642\u983b\u7e41\u8cb7\u8ce3</li> <li>\u8667\u640d\u7d2f\u7a4d</li> <li>\u9069\u5408\u55ae\u908a\u5e02\u5834</li> </ul> </li> <li> <p>\u9078\u80a1\u6578\u91cf\u4e0d\u7a69\u5b9a</p> <ul> <li>\u6709\u6642 20 \u6a94\uff0c\u6709\u6642 0 \u6a94</li> <li>\u5f71\u97ff\u8cc7\u91d1\u4f7f\u7528\u7387</li> <li>\u7e3e\u6548\u6ce2\u52d5\u5927</li> </ul> </li> </ol>"},{"location":"blocks/pipeline/case-countertrend/#_12","title":"\ud83d\udd0d \u95dc\u9375\u5b78\u7fd2\u9ede","text":""},{"location":"blocks/pipeline/case-countertrend/#1","title":"1. \u70ba\u4ec0\u9ebc\u9700\u8981\u8da8\u52e2\u904e\u6ffe\uff1f","text":"<p>\u6c92\u6709\u8da8\u52e2\u904e\u6ffe\uff08\u5371\u96aa\uff09\uff1a <pre><code># \u53ea\u8981\u51fa\u73fe -3\u03c3 \u5c31\u8cb7\nif pullback &lt; -3:\n    buy = True\n\n# \u554f\u984c\uff1a\u53ef\u80fd\u662f\u8da8\u52e2\u53cd\u8f49\n# \u8d8a\u8cb7\u8d8a\u8dcc\n</code></pre></p> <p>\u6709\u8da8\u52e2\u904e\u6ffe\uff08\u5b89\u5168\uff09\uff1a <pre><code># \u5148\u78ba\u8a8d\u591a\u982d\u8da8\u52e2\nif (ema_fast &gt; ema_slow):\n    # \u518d\u770b\u662f\u5426\u8d85\u8dcc\n    if pullback &lt; -3:\n        buy = True\n\n# \u53ea\u5728\u4e0a\u5347\u8da8\u52e2\u7684\u56de\u6a94\u4e2d\u8cb7\u5165\n</code></pre></p>"},{"location":"blocks/pipeline/case-countertrend/#2","title":"2. \u98a8\u96aa\u5e73\u50f9\u7684\u8a08\u7b97\u908f\u8f2f","text":"<p>\u76ee\u6a19\uff1a</p> <p>\u8b93\u6bcf\u6a94\u80a1\u7968\u5c0d\u6295\u7d44\u98a8\u96aa\u7684\u8ca2\u737b\u76f8\u7b49\u3002</p> <p>\u516c\u5f0f\u63a8\u5c0e\uff1a <pre><code>\u8a2d\u5b9a\uff1a\n- \u6295\u7d44\u50f9\u503c = P\n- \u98a8\u96aa\u4fc2\u6578 = r\uff08\u4f8b\u5982 1%\uff09\n- \u76ee\u6a19\u98a8\u96aa = P \u00d7 r\n\n\u55ae\u4e00\u80a1\u7968\uff1a\n- \u6a19\u6e96\u5dee = \u03c3\n- \u6301\u80a1\u50f9\u503c = V\n- \u8a72\u80a1\u7968\u7684\u98a8\u96aa\u8ca2\u737b = V \u00d7 \u03c3\n\n\u8981\u6c42\uff1a\nV \u00d7 \u03c3 = P \u00d7 r\n\n\u89e3\uff1a\nV = (P \u00d7 r) / \u03c3\n\n\u7d50\u8ad6\uff1a\n- \u03c3 \u8d8a\u5927\uff0cV \u8d8a\u5c0f\uff08\u8cb7\u5165\u5c11\uff09\n- \u03c3 \u8d8a\u5c0f\uff0cV \u8d8a\u5927\uff08\u8cb7\u5165\u591a\uff09\n</code></pre></p> <p>\u7a0b\u5f0f\u5be6\u4f5c\uff1a <pre><code>def position_size(portfolio_value, std, risk_factor=0.01):\n    target_variation = portfolio_value * risk_factor  # P \u00d7 r\n    contract_variation = std * 1                       # \u03c3 \u00d7 \u9ede\u503c\n    contracts = target_variation / contract_variation  # V = (P \u00d7 r) / \u03c3\n\n    return int(contracts)\n</code></pre></p>"},{"location":"blocks/pipeline/case-countertrend/#3-ema-vs-sma","title":"3. EMA vs SMA","text":"<p>SMA\uff08Simple Moving Average\uff09\uff1a <pre><code>sma = close[-40:].mean()\n\n# \u6240\u6709\u50f9\u683c\u6b0a\u91cd\u76f8\u540c\n</code></pre></p> <p>EMA\uff08Exponential Moving Average\uff09\uff1a <pre><code>ema = close.ewm(span=40).mean()\n\n# \u8fd1\u671f\u50f9\u683c\u6b0a\u91cd\u9ad8\n# \u9060\u671f\u50f9\u683c\u6b0a\u91cd\u4f4e\n</code></pre></p> <p>\u70ba\u4ec0\u9ebc\u7528 EMA\uff1f</p> <ul> <li>\u5c0d\u8fd1\u671f\u50f9\u683c\u8b8a\u5316\u66f4\u654f\u611f</li> <li>\u53cd\u61c9\u901f\u5ea6\u5feb</li> <li>\u66f4\u9069\u5408\u6355\u6349\u8da8\u52e2\u8f49\u8b8a</li> </ul>"},{"location":"blocks/pipeline/case-countertrend/#4","title":"4. \u6301\u6709\u5929\u6578\u8ffd\u8e64\u7684\u5be6\u4f5c","text":"<pre><code># \u5728 initialize \u4e2d\u521d\u59cb\u5316\ncontext.bars_held = {asset.symbol: 0 for asset in context.universe}\n\n# \u6bcf\u65e5\u66f4\u65b0\nif _asset in context.portfolio.positions:\n    context.bars_held[_asset] += 1  # \u6301\u6709\u5929\u6578 +1\n\n# \u6aa2\u67e5\u6301\u6709\u5929\u6578\nif context.bars_held[_asset] &gt;= 20:\n    order_target(_asset, 0)  # \u51fa\u5834\n\n# \u8cb7\u5165\u6642\u91cd\u7f6e\nif pullback &lt; -3:\n    order_value(_asset, volume_to_trade)\n    context.bars_held[_asset] = 0  # \u91cd\u7f6e\u70ba 0\n</code></pre>"},{"location":"blocks/pipeline/case-countertrend/#_13","title":"\ud83c\udfaf \u5ef6\u4f38\u512a\u5316\u65b9\u5411","text":""},{"location":"blocks/pipeline/case-countertrend/#1_1","title":"\u512a\u5316 1: \u52d5\u614b\u6a19\u6e96\u5dee\u500d\u6578","text":"<pre><code># \u6839\u64da\u5e02\u5834\u6ce2\u52d5\u7387\u8abf\u6574\nmarket_vol = calculate_market_volatility()\n\nif market_vol &gt; 0.3:\n    sigma_multiplier = 2  # \u9ad8\u6ce2\u52d5\u7528 -2\u03c3\nelse:\n    sigma_multiplier = 3  # \u4f4e\u6ce2\u52d5\u7528 -3\u03c3\n\nif pullback &lt; -sigma_multiplier:\n    buy = True\n</code></pre>"},{"location":"blocks/pipeline/case-countertrend/#2_1","title":"\u512a\u5316 2: \u52d5\u614b\u6301\u6709\u671f","text":"<pre><code># \u6839\u64da\u53cd\u5f48\u529b\u9053\u8abf\u6574\u6301\u6709\u671f\nif _asset in context.portfolio.positions:\n    p = context.portfolio.positions[_asset]\n    current_price = data.current(_asset, 'close')\n\n    # \u7372\u5229 &gt; 10%\uff0c\u63d0\u524d\u51fa\u5834\n    if current_price &gt; p.cost_basis * 1.1:\n        order_target(_asset, 0)\n\n    # \u672a\u7372\u5229\u4f46\u8d85\u904e 30 \u5929\uff0c\u4e5f\u51fa\u5834\n    elif context.bars_held[_asset] &gt; 30:\n        order_target(_asset, 0)\n</code></pre>"},{"location":"blocks/pipeline/case-countertrend/#3","title":"\u512a\u5316 3: \u52a0\u5165\u6210\u4ea4\u91cf\u78ba\u8a8d","text":"<pre><code># \u6210\u4ea4\u91cf &gt; 20 \u65e5\u5747\u91cf\navg_volume = h_volume[-20:].mean()\nvolume_confirm = h_volume.iloc[-1] &gt; avg_volume\n\nif h_trend.iloc[-1] and (pullback &lt; -3) and volume_confirm:\n    buy = True\n</code></pre>"},{"location":"blocks/pipeline/case-countertrend/#4_1","title":"\u512a\u5316 4: \u5206\u6279\u9032\u5834","text":"<pre><code># \u7b2c\u4e00\u6279\uff1a-3\u03c3 \u8cb7\u5165 50%\nif pullback &lt; -3:\n    order_value(_asset, volume_to_trade * 0.5)\n    context.entry_stage[_asset] = 1\n\n# \u7b2c\u4e8c\u6279\uff1a-4\u03c3 \u518d\u8cb7\u5165 50%\nelif pullback &lt; -4 and context.entry_stage[_asset] == 1:\n    order_value(_asset, volume_to_trade * 0.5)\n    context.entry_stage[_asset] = 2\n</code></pre>"},{"location":"blocks/pipeline/case-countertrend/#5","title":"\u512a\u5316 5: \u7522\u696d\u5206\u6563","text":"<pre><code># \u8a18\u9304\u6bcf\u500b\u7522\u696d\u7684\u6301\u5009\u6578\ncontext.industry_count = defaultdict(int)\n\n# \u9032\u5834\u524d\u6aa2\u67e5\u7522\u696d\u5206\u6563\nindustry = get_industry(_asset)\n\nif context.industry_count[industry] &lt; 3:  # \u6bcf\u500b\u7522\u696d\u6700\u591a 3 \u6a94\n    order_value(_asset, volume_to_trade)\n    context.industry_count[industry] += 1\n</code></pre>"},{"location":"blocks/pipeline/case-countertrend/#_14","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6a21\u677f\u9801\u9762\uff1atemplate.md - \u67b6\u69cb\u6a21\u677f</li> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md - \u7406\u89e3\u8a2d\u8a08\u539f\u7406</li> <li>\u5176\u4ed6\u6848\u4f8b\uff1a</li> <li>Expanded Momentum - \u52d5\u91cf\u7b56\u7565</li> <li>\u8ddf\u96a8\u5927\u6236 - \u7c4c\u78bc\u5206\u6790</li> </ul>"},{"location":"blocks/pipeline/case-countertrend/#_15","title":"\ud83d\udca1 \u7e3d\u7d50","text":"<p>CounterTrend \u7b56\u7565\u5c55\u793a\u4e86 \u5747\u503c\u56de\u6b78 \u7684\u7cbe\u9ad3\uff1a</p> <ol> <li>\u2705 \u8da8\u52e2\u904e\u6ffe\uff1a\u53ea\u5728\u591a\u982d\u4e2d\u9022\u4f4e\u8cb7\uff08EMA \u96d9\u5747\u7dda\uff09</li> <li>\u2705 \u7d71\u8a08\u5b78\u8cb7\u9ede\uff1a-3\u03c3 \u6975\u7aef\u503c</li> <li>\u2705 \u98a8\u96aa\u5e73\u50f9\uff1a\u6839\u64da\u6ce2\u52d5\u7387\u8abf\u6574\u6301\u80a1</li> <li>\u2705 \u5f37\u5236\u51fa\u5834\uff1a20 \u5929\u907f\u514d\u5957\u7262</li> <li>\u2705 \u6b0a\u503c\u80a1\u6c60\uff1a\u964d\u4f4e\u7cfb\u7d71\u6027\u98a8\u96aa</li> </ol> <p>\u9069\u5408\u8ab0\u4f7f\u7528\uff1f</p> <ul> <li>\u504f\u597d\u9006\u52e2\u64cd\u4f5c</li> <li>\u80fd\u627f\u53d7\u77ed\u671f\u6ce2\u52d5</li> <li>\u76f8\u4fe1\u5747\u503c\u56de\u6b78</li> </ul> <p>\u4f7f\u7528\u5efa\u8b70\uff1a</p> <ul> <li>\u2705 \u5728\u591a\u982d\u5e02\u5834\u4f7f\u7528</li> <li>\u2705 \u56b4\u683c\u57f7\u884c 20 \u5929\u51fa\u5834</li> <li>\u2705 \u6ce8\u610f\u98a8\u96aa\u5e73\u50f9\u8a08\u7b97</li> <li>\u26a0\ufe0f \u907f\u514d\u5728\u8da8\u52e2\u53cd\u8f49\u6642\u4f7f\u7528</li> <li>\u26a0\ufe0f \u6ce8\u610f\u300c\u63a5\u843d\u4e0b\u7684\u5200\u300d\u98a8\u96aa</li> </ul> <p>\ud83d\udc49 Next Step:</p> <ol> <li>\u8907\u88fd\u5b8c\u6574\u7a0b\u5f0f\u78bc</li> <li>\u8abf\u6574\u53c3\u6578\uff08\u03c3 \u500d\u6578\u3001\u6301\u6709\u671f\u3001EMA \u9031\u671f\uff09</li> <li>\u6e2c\u8a66\u4e0d\u540c\u98a8\u96aa\u4fc2\u6578</li> <li>\u52a0\u5165\u4f60\u7684\u512a\u5316\u908f\u8f2f</li> </ol>"},{"location":"blocks/pipeline/case-countertrend/#_16","title":"\ud83d\udcd6 \u5ef6\u4f38\u95b1\u8b80","text":"<p>\u5747\u503c\u56de\u6b78\u7406\u8ad6\uff1a</p> <ul> <li>\u50f9\u683c\u504f\u96e2\u5747\u503c\u5f8c\u50be\u5411\u56de\u6b78</li> <li>\u5e03\u6797\u901a\u9053\u7684\u7406\u8ad6\u57fa\u790e</li> <li>\u7d71\u8a08\u5957\u5229\u7684\u6838\u5fc3\u6982\u5ff5</li> </ul> <p>EMA \u6307\u6578\u79fb\u52d5\u5e73\u5747\uff1a</p> <ul> <li>\u5c0d\u8fd1\u671f\u50f9\u683c\u66f4\u654f\u611f</li> <li>\u8a08\u7b97\u516c\u5f0f\uff1a<code>EMA_t = \u03b1 \u00d7 Price_t + (1-\u03b1) \u00d7 EMA_{t-1}</code></li> <li>\u5176\u4e2d <code>\u03b1 = 2 / (span + 1)</code></li> </ul> <p>\u98a8\u96aa\u5e73\u50f9\uff08Risk Parity\uff09\uff1a</p> <ul> <li>\u6bcf\u500b\u8cc7\u7522\u5c0d\u6295\u7d44\u98a8\u96aa\u7684\u8ca2\u737b\u76f8\u7b49</li> <li>\u4e0d\u662f\u7b49\u6b0a\u91cd\uff0c\u800c\u662f\u7b49\u98a8\u96aa</li> <li>\u5ee3\u6cdb\u61c9\u7528\u65bc\u8cc7\u7522\u914d\u7f6e</li> </ul> <p>\u5be6\u52d9\u7d93\u9a57\uff1a</p> <ul> <li>-3\u03c3 \u89f8\u767c\u983b\u7387\uff1a\u6bcf\u6708 0-5 \u6b21</li> <li>\u52dd\u7387\uff1a\u7d04 60-70%</li> <li>\u5e73\u5747\u6301\u6709\uff1a10-15 \u5929\uff08\u5f88\u591a\u6703\u63d0\u524d\u53cd\u5f48\uff09</li> <li>\u6700\u5927\u98a8\u96aa\uff1a\u8da8\u52e2\u53cd\u8f49\u6642\u9023\u7e8c\u8667\u640d</li> <li>\u9069\u5408\u5e02\u6cc1\uff1a\u9707\u76ea\u504f\u591a\u7684\u5e02\u5834</li> </ul>"},{"location":"blocks/pipeline/case-institution/","title":"\u6848\u4f8b 2\uff1a\u8ddf\u96a8\u5927\u6236\u7b56\u7565","text":"<p>\u7b56\u7565\u985e\u578b\uff1a Pipeline \u56e0\u5b50\u67b6\u69cb - \u7c4c\u78bc\u5206\u6790 \u4ea4\u6613\u6a19\u7684\uff1a 81 \u6a94\u85cd\u7c4c\u80a1 \u8abf\u5009\u983b\u7387\uff1a \u65e5\u5ea6\uff08\u6bcf\u65e5\u958b\u76e4\u5f8c\uff09 \u56de\u6e2c\u671f\u9593\uff1a 2020-01-01 ~ 2023-08-15</p>"},{"location":"blocks/pipeline/case-institution/#_1","title":"\ud83d\udccc \u7b56\u7565\u6982\u8ff0","text":"<p>\u8ddf\u96a8\u5927\u6236\u7b56\u7565\u662f\u57fa\u65bc \u7c4c\u78bc\u9762\u5206\u6790 \u7684\u91cf\u5316\u7b56\u7565\uff0c\u8ffd\u8e64\u4e09\u5927\u6cd5\u4eba\uff08\u5916\u8cc7\u3001\u6295\u4fe1\u3001\u81ea\u71df\u5546\uff09\u7684\u6301\u80a1\u8b8a\u5316\u548c\u8cb7\u8ce3\u8d85\u52d5\u5411\u3002</p>"},{"location":"blocks/pipeline/case-institution/#_2","title":"\u6838\u5fc3\u7406\u5ff5","text":"<p>\"Follow the smart money when they're still accumulating.\" \u5728\u8070\u660e\u9322\u6301\u7e8c\u7d2f\u7a4d\u6642\u8ddf\u9032\u3002</p> <p>\u4e09\u5927\u6cd5\u4eba\u64c1\u6709\uff1a</p> <ul> <li>\ud83d\udcca \u8cc7\u8a0a\u512a\u52e2\uff1a\u7814\u7a76\u5718\u968a\u3001\u7522\u696d\u8abf\u7814</li> <li>\ud83d\udcb0 \u8cc7\u91d1\u512a\u52e2\uff1a\u5f71\u97ff\u80a1\u50f9\u8d70\u52e2</li> <li>\ud83c\udfaf \u9577\u671f\u8996\u89d2\uff1a\u4e0d\u505a\u77ed\u7dda\u7092\u4f5c</li> </ul> <p>\u672c\u7b56\u7565\u7684\u95dc\u9375\u6d1e\u5bdf\uff1a\u7576\u4e09\u5927\u6cd5\u4eba \u8cb7\u8d85 \u4f46 \u6301\u80a1\u6bd4\u7387\u4ecd\u4f4e\u65bc\u5747\u503c \u6642\uff0c\u4ee3\u8868\u6cd5\u4eba\u6b63\u5728\u300c\u5efa\u5009\u968e\u6bb5\u300d\uff0c\u5f8c\u7e8c\u53ef\u80fd\u6709\u4e00\u6ce2\u6f32\u52e2\u3002</p>"},{"location":"blocks/pipeline/case-institution/#_3","title":"\u7b56\u7565\u7279\u8272","text":"<ol> <li>\u96d9\u91cd\u78ba\u8a8d\u6a5f\u5236\uff1a\u8cb7\u8d85 + \u6301\u80a1\u7387\u4f4e\u65bc\u5747\u7dda</li> <li>5 \u65e5\u79fb\u52d5\u5e73\u5747\uff1a\u904e\u6ffe\u77ed\u671f\u96dc\u8a0a</li> <li>\u5c0f\u984d\u5206\u6563\u9032\u5834\uff1a\u6bcf\u6b21\u53ea\u7528 5% \u73fe\u91d1</li> <li>\u5168\u6578\u6e05\u5009\u51fa\u5834\uff1a\u767c\u51fa\u8ce3\u51fa\u8a0a\u865f\u7acb\u5373\u51fa\u6e05</li> <li>\u85cd\u7c4c\u80a1\u7968\u6c60\uff1a81 \u6a94\u5e02\u503c\u5927\u3001\u6d41\u52d5\u6027\u597d\u7684\u80a1\u7968</li> </ol>"},{"location":"blocks/pipeline/case-institution/#_4","title":"\ud83c\udfaf \u7c4c\u78bc\u6307\u6a19\u8a73\u89e3","text":""},{"location":"blocks/pipeline/case-institution/#_5","title":"\u6578\u64da\u4f86\u6e90","text":"<p>TEJ \u4e09\u5927\u6cd5\u4eba\u8cc7\u6599\uff1a <pre><code># \u4f7f\u7528 TejToolAPI \u53d6\u5f97\ncolumns = ['qfii_pct', 'fd_pct', 'dlr_pct', 'tot_ex']\n\n# qfii_pct: \u5916\u8cc7\u6301\u80a1\u6bd4\u7387\n# fd_pct: \u6295\u4fe1\u6301\u80a1\u6bd4\u7387\n# dlr_pct: \u81ea\u71df\u5546\u6301\u80a1\u6bd4\u7387\n# tot_ex: \u4e09\u5927\u6cd5\u4eba\u5408\u8a08\u8cb7\u8ce3\u8d85\n</code></pre></p>"},{"location":"blocks/pipeline/case-institution/#_6","title":"\u8a08\u7b97\u908f\u8f2f","text":"<p>Step 1: \u8a08\u7b97\u4e09\u5927\u6cd5\u4eba\u5408\u8a08\u6301\u80a1\u6bd4\u7387 <pre><code>Total_Pct = \u5916\u8cc7\u6301\u80a1\u6bd4\u7387 + \u6295\u4fe1\u6301\u80a1\u6bd4\u7387 + \u81ea\u71df\u5546\u6301\u80a1\u6bd4\u7387\n</code></pre></p> <p>Step 2: \u8a08\u7b97 5 \u65e5\u79fb\u52d5\u5e73\u5747 <pre><code>pct_ma = SimpleMovingAverage(\n    inputs=[CustomDataset.total_pct],\n    window_length=5\n)\n</code></pre></p> <p>Step 3: \u5224\u65b7\u8cb7\u8ce3\u8a0a\u865f <pre><code># \u8cb7\u5165\u8a0a\u865f\uff1a\u6301\u80a1\u7387 &lt; \u5747\u7dda \u4e14 \u8cb7\u8d85\nlongs = (pct &lt; pct_ma) &amp; (vol &gt; 0)\n\n# \u8ce3\u51fa\u8a0a\u865f\uff1a\u6301\u80a1\u7387 &gt; \u5747\u7dda \u4e14 \u8ce3\u8d85\nshorts = (pct &gt; pct_ma) &amp; (vol &lt; 0)\n</code></pre></p>"},{"location":"blocks/pipeline/case-institution/#_7","title":"\u8a0a\u865f\u908f\u8f2f\u89e3\u6790","text":"<p>\u8cb7\u5165\u8a0a\u865f\u7684\u610f\u7fa9\uff1a <pre><code>\u60c5\u5883\uff1a\n- \u4e09\u5927\u6cd5\u4eba\u4eca\u65e5\u8cb7\u8d85 1000 \u5f35\n- \u4f46\u6301\u80a1\u6bd4\u7387 30% &lt; 5 \u65e5\u5747\u7dda 32%\n\n\u89e3\u8b80\uff1a\n\u2192 \u6cd5\u4eba\u6b63\u5728\u300c\u5efa\u5009\u300d\n\u2192 \u6301\u80a1\u9084\u6c92\u5230\u9ad8\u9ede\n\u2192 \u5f8c\u7e8c\u53ef\u80fd\u6301\u7e8c\u8cb7\u9032\n\u2192 \u7d66\u4e88\u8cb7\u5165\u8a0a\u865f\n</code></pre></p> <p>\u8ce3\u51fa\u8a0a\u865f\u7684\u610f\u7fa9\uff1a <pre><code>\u60c5\u5883\uff1a\n- \u4e09\u5927\u6cd5\u4eba\u4eca\u65e5\u8ce3\u8d85 1000 \u5f35\n- \u4e14\u6301\u80a1\u6bd4\u7387 35% &gt; 5 \u65e5\u5747\u7dda 33%\n\n\u89e3\u8b80\uff1a\n\u2192 \u6cd5\u4eba\u958b\u59cb\u300c\u51fa\u8ca8\u300d\n\u2192 \u6301\u80a1\u5df2\u7d93\u504f\u9ad8\n\u2192 \u53ef\u80fd\u6e96\u5099\u7372\u5229\u4e86\u7d50\n\u2192 \u7d66\u4e88\u8ce3\u51fa\u8a0a\u865f\n</code></pre></p>"},{"location":"blocks/pipeline/case-institution/#_8","title":"\ud83d\udd0d \u4ea4\u6613\u908f\u8f2f\u8a73\u89e3","text":""},{"location":"blocks/pipeline/case-institution/#_9","title":"\u8cb7\u5165\u689d\u4ef6\uff08\u5fc5\u9808\u540c\u6642\u6eff\u8db3\uff09","text":"<ol> <li>\u4e09\u5927\u6cd5\u4eba\u5408\u8a08\u8cb7\u8ce3\u8d85 &gt; 0\uff08\u8cb7\u8d85\uff09</li> <li>\u4e09\u5927\u6cd5\u4eba\u5408\u8a08\u6301\u80a1\u7387 &lt; 5 \u65e5\u79fb\u52d5\u5e73\u5747</li> <li>\u6709\u8db3\u5920\u73fe\u91d1\u53ef\u7528</li> </ol>"},{"location":"blocks/pipeline/case-institution/#_10","title":"\u8ce3\u51fa\u689d\u4ef6\uff08\u5fc5\u9808\u540c\u6642\u6eff\u8db3\uff09","text":"<ol> <li>\u4e09\u5927\u6cd5\u4eba\u5408\u8a08\u8cb7\u8ce3\u8d85 &lt; 0\uff08\u8ce3\u8d85\uff09</li> <li>\u4e09\u5927\u6cd5\u4eba\u5408\u8a08\u6301\u80a1\u7387 &gt; 5 \u65e5\u79fb\u52d5\u5e73\u5747</li> <li>\u8a72\u80a1\u7968\u5728\u6295\u8cc7\u7d44\u5408\u4e2d</li> </ol>"},{"location":"blocks/pipeline/case-institution/#_11","title":"\u8cc7\u91d1\u7ba1\u7406","text":"<p>\u8cb7\u5165\uff1a <pre><code># \u6bcf\u6b21\u8cb7\u5165\u4f7f\u7528\u53ef\u7528\u73fe\u91d1\u7684 5%\norder_target_value(stock, cash * 0.05)\n</code></pre></p> <p>\u8ce3\u51fa\uff1a <pre><code># \u767c\u51fa\u8ce3\u51fa\u8a0a\u865f\uff0c\u5168\u6578\u6e05\u5009\norder_target_percent(stock, 0)\n</code></pre></p>"},{"location":"blocks/pipeline/case-institution/#_12","title":"\ud83d\udcbb \u5b8c\u6574\u7a0b\u5f0f\u78bc","text":"<pre><code># ====================================\n# \u8ddf\u96a8\u5927\u6236\u7b56\u7565 - \u5b8c\u6574\u5be6\u4f5c\n# ====================================\n\nimport tejapi\nimport os\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nfrom datetime import datetime\nimport warnings\n\nwarnings.filterwarnings('ignore')\n\n# ====================================\n# \u74b0\u5883\u8a2d\u5b9a\n# ====================================\nos.environ['TEJAPI_BASE'] = 'https://api.tej.com.tw'\nos.environ['TEJAPI_KEY'] = 'your_key'\n\ntejapi.ApiConfig.api_key = os.getenv('TEJAPI_KEY')\ntejapi.ApiConfig.api_base = os.getenv('TEJAPI_BASE')\n\n# ====================================\n# Zipline \u5957\u4ef6\u5f15\u5165\n# ====================================\nfrom zipline import run_algorithm\nfrom zipline.api import (\n    attach_pipeline, pipeline_output,\n    date_rules, time_rules, record, schedule_function,\n    commission, slippage, set_slippage, set_commission,\n    order_target, order_target_value, order_target_percent,\n    get_datetime, symbol\n)\nfrom zipline.data import bundles\nfrom zipline.pipeline import Pipeline, CustomFactor\nfrom zipline.pipeline.data import Column, DataSet\nfrom zipline.pipeline.domain import TW_EQUITIES\nfrom zipline.pipeline.loaders.frame import DataFrameLoader\nfrom zipline.pipeline.factors import SimpleMovingAverage\nfrom zipline.pipeline.data import TWEquityPricing\nfrom zipline.pipeline.loaders import EquityPricingLoader\nfrom zipline.pipeline.engine import SimplePipelineEngine\n\nfrom TejToolAPI.TejToolAPI import get_history_data\nfrom zipline.sources.TEJ_Api_Data import get_Benchmark_Return\n\nfrom logbook import Logger, StderrHandler, INFO\n\nimport seaborn as sns\nsns.set_style('whitegrid')\npd.set_option('display.expand_frame_repr', False)\n\nlog_handler = StderrHandler(\n    format_string='[{record.time:%Y-%m-%d %H:%M:%S.%f}]: ' +\n                  '{record.level_name}: {record.func_name}: {record.message}',\n    level=INFO\n)\nlog_handler.push_application()\nlog = Logger('Algorithm')\n\n# ====================================\n# \u53c3\u6578\u8a2d\u5b9a\n# ====================================\nstart_date = '2020-01-01'\nend_date = '2023-08-15'\n\n# ====================================\n# \u80a1\u7968\u6c60\u8a2d\u5b9a\uff0881 \u6a94\u85cd\u7c4c\u80a1\uff09\n# ====================================\ntickers = '1101 1102 1216 1301 1303 1326 1402 1476 1590 1605 1722 1802 2002 2105 2201 2207 \\\n2227 2301 2303 2308 2311 2317 2324 2325 2327 2330 2347 2353 2354 2357 2379 2382 2395 2408 \\\n2409 2412 2448 2454 2474 2492 2498 2603 2609 2615 2618 2633 2801 2823 2880 2881 2882 2883 \\\n2884 2885 2886 2887 2888 2890 2891 2892 2912 3008 3009 3034 3037 3045 3231 3474 3481 3673 \\\n3697 3711 4904 4938 5854 5871 5876 5880 6239 6415 6505 6669 6770 8046 8454 9904 9910'\n\nos.environ['ticker'] = tickers\nos.environ['mdate'] = f\"{start_date.replace('-', '')} {end_date.replace('-', '')}\"\n\n# ====================================\n# Ingest \u80a1\u50f9\u8cc7\u6599\n# ====================================\nfrom zipline.data.run_ingest import simple_ingest\n\nprint(\"\u6b63\u5728\u532f\u5165\u80a1\u50f9\u8cc7\u6599...\")\nsimple_ingest(\n    name='tquant',\n    tickers=tickers.split(' '),\n    start_date=start_date.replace('-', ''),\n    end_date=end_date.replace('-', '')\n)\nprint(\"\u80a1\u50f9\u8cc7\u6599\u532f\u5165\u5b8c\u6210\uff01\")\n\n# ====================================\n# \u8f09\u5165\u4e09\u5927\u6cd5\u4eba\u8cc7\u6599\n# ====================================\nprint(\"\u6b63\u5728\u4e0b\u8f09\u4e09\u5927\u6cd5\u4eba\u8cc7\u6599...\")\n\n# \u8f09\u5165 bundle\nbundle_name = 'tquant'\nbundle = bundles.load(bundle_name)\n\nsids = bundle.asset_finder.equities_sids\nassets = bundle.asset_finder.retrieve_all(sids)\nsymbols = [i.symbol for i in assets]\n\n# \u53d6\u5f97\u4e09\u5927\u6cd5\u4eba\u6301\u80a1\u6bd4\u4f8b\u8207\u8cb7\u8ce3\u8d85\ndf = get_history_data(\n    ticker=symbols,\n    columns=['qfii_pct', 'fd_pct', 'dlr_pct', 'tot_ex'],\n    start=start_date,\n    end=end_date\n)\n\ndf = df.sort_values(['coid', 'mdate'])\n\n# \u8a08\u7b97\u4e09\u5927\u6cd5\u4eba\u5408\u8a08\u6301\u80a1\u6bd4\u7387\ndf = df.assign(\n    Total_Pct=(\n        df.Fund_Stock_Holding_Pct +\n        df.Qfii_Stock_Holding_Pct +\n        df.Dealer_Stock_Holding_Pct\n    )\n)\n\nprint(f\"\u4e09\u5927\u6cd5\u4eba\u8cc7\u6599\u8f09\u5165\u5b8c\u6210\uff1a{len(df)} \u7b46\")\n\n# ====================================\n# \u8f49\u63db\u70ba Zipline \u683c\u5f0f\n# ====================================\ndef Custom_loader(df, bundle):\n    \"\"\"\n    \u5c07 DataFrame \u8f49\u63db\u70ba Zipline Pipeline \u53ef\u7528\u7684\u683c\u5f0f\n    \"\"\"\n    df['coid'] = df['coid'].astype(str)\n\n    column = df.columns[~df.columns.isin(['coid', 'mdate'])].tolist()\n\n    df1 = df.set_index(['coid', 'mdate'])\n    symbols = df1.index.get_level_values(0).unique().astype(str).tolist()\n\n    assets = bundle.asset_finder.lookup_symbols(symbols, as_of_date=None)\n    assets_map = {i.symbol: i for i in assets}\n\n    baseline_data = {}\n\n    for i in column:\n        target = df1.unstack('coid')[i]\n        target.columns = target.columns.map(assets_map)\n        target = target.tz_localize('UTC').tz_convert('UTC')\n        baseline_data.update({i: target})\n\n    return baseline_data\n\nbaseline_data = Custom_loader(df, bundle)\n\nprint(f\"\u53ef\u7528\u6b04\u4f4d\uff1a{baseline_data.keys()}\")\n\n# ====================================\n# \u5b9a\u7fa9 CustomDataset\n# ====================================\nclass CustomDataset(DataSet):\n    \"\"\"\n    \u81ea\u5b9a\u7fa9\u6578\u64da\u96c6\uff1a\u4e09\u5927\u6cd5\u4eba\u8cc7\u6599\n    \"\"\"\n    total_vol = Column(dtype=float)  # \u4e09\u5927\u6cd5\u4eba\u5408\u8a08\u8cb7\u8ce3\u8d85\n    total_pct = Column(dtype=float)  # \u4e09\u5927\u6cd5\u4eba\u5408\u8a08\u6301\u80a1\u6bd4\u7387\n\n    domain = TW_EQUITIES\n\n# \u5efa\u7acb DataFrameLoader\ntransform_data = {\n    CustomDataset.total_vol: DataFrameLoader(\n        CustomDataset.total_vol,\n        baseline_data['Total_Diff_Vol']\n    ),\n    CustomDataset.total_pct: DataFrameLoader(\n        CustomDataset.total_pct,\n        baseline_data['Total_Pct']\n    ),\n}\n\n# ====================================\n# Pipeline \u5b9a\u7fa9\n# ====================================\ndef make_pipeline(ma_days=5):\n    \"\"\"\n    \u5efa\u7acb Pipeline\n\n    \u908f\u8f2f\uff1a\n    - \u8cb7\u5165\uff1a\u6301\u80a1\u7387 &lt; \u5747\u7dda \u4e14 \u8cb7\u8d85\n    - \u8ce3\u51fa\uff1a\u6301\u80a1\u7387 &gt; \u5747\u7dda \u4e14 \u8ce3\u8d85\n    \"\"\"\n    # \u53d6\u5f97\u6700\u65b0\u8cc7\u6599\n    vol = CustomDataset.total_vol.latest\n    pct = CustomDataset.total_pct.latest\n\n    # \u8a08\u7b97 5 \u65e5\u79fb\u52d5\u5e73\u5747\n    pct_ma = SimpleMovingAverage(\n        inputs=[CustomDataset.total_pct],\n        window_length=ma_days\n    )\n\n    # \u8cb7\u5165\u8a0a\u865f\uff1a\u6301\u80a1\u7387 &lt; \u5747\u7dda \u4e14 \u8cb7\u8d85\n    longs = (pct &lt; pct_ma) &amp; (vol &gt; 0)\n\n    # \u8ce3\u51fa\u8a0a\u865f\uff1a\u6301\u80a1\u7387 &gt; \u5747\u7dda \u4e14 \u8ce3\u8d85\n    shorts = (pct &gt; pct_ma) &amp; (vol &lt; 0)\n\n    return Pipeline(\n        columns={\n            'Total_volume_diff': vol,\n            'Total_pct': pct,\n            'Total_pct_ma': pct_ma,\n            'longs': longs,\n            'shorts': shorts\n        },\n    )\n\n# ====================================\n# \u7b56\u7565\u51fd\u6578\n# ====================================\ndef initialize(context):\n    \"\"\"\n    \u521d\u59cb\u5316\u51fd\u6578\n    \"\"\"\n    # \u4ea4\u6613\u6210\u672c\u8a2d\u5b9a\n    set_slippage(slippage.FixedSlippage(spread=0.002))  # \u6ed1\u50f9 0.2%\n    set_commission(commission.PerDollar(cost=0.002))   # \u624b\u7e8c\u8cbb 0.2%\n\n    # \u7e3e\u6548\u8ffd\u8e64\n    context.last_month = 1e6\n\n    # \u6392\u7a0b\uff1a\u6bcf\u65e5\u958b\u76e4\u5f8c\u8abf\u5009\n    schedule_function(\n        rebalance_start,\n        date_rules.every_day(),\n        time_rules.market_open()\n    )\n\n    schedule_function(\n        rebalance_end,\n        date_rules.every_day(),\n        time_rules.market_open()\n    )\n\n    schedule_function(\n        output_progress,\n        date_rules.month_start(),\n        time_rules.market_open()\n    )\n\n    # \u9644\u52a0 Pipeline\n    pipeline = make_pipeline(5)\n    attach_pipeline(pipeline, 'make_pipeline')\n\ndef output_progress(context, data):\n    \"\"\"\n    \u8f38\u51fa\u7e3e\u6548\u9032\u5ea6\n    \"\"\"\n    today = get_datetime().date()\n\n    perf_pct = (context.portfolio.portfolio_value / context.last_month) - 1\n\n    log.info(f\"\u3010{today}\u3011\u6295\u7d44\u5831\u916c\u7387\uff1a{perf_pct*100:.2f}%\")\n\n    context.last_month = context.portfolio.portfolio_value\n\ndef before_trading_start(context, data):\n    \"\"\"\n    \u76e4\u524d\u57f7\u884c\uff1a\u53d6\u5f97 Pipeline \u8f38\u51fa\n    \"\"\"\n    context.trades = pipeline_output('make_pipeline').dropna(axis=0)\n\ndef rebalance_start(context, data):\n    \"\"\"\n    \u8cb7\u5165\u908f\u8f2f\n    \"\"\"\n    target = pd.DataFrame(context.trades)\n\n    # \u7be9\u9078\u51fa\u8cb7\u5165\u8a0a\u865f\u7684\u80a1\u7968\n    target = target[target['longs']]\n\n    cash = context.portfolio.cash\n\n    for stock in target.index:\n        if data.can_trade(stock) and (cash &gt; 0):\n            # \u6bcf\u6b21\u4f7f\u7528 5% \u73fe\u91d1\u8cb7\u5165\n            order_target_value(stock, cash * 0.05)\n\ndef rebalance_end(context, data):\n    \"\"\"\n    \u8ce3\u51fa\u908f\u8f2f\n    \"\"\"\n    target = pd.DataFrame(context.trades)\n\n    # \u7be9\u9078\u51fa\u8ce3\u51fa\u8a0a\u865f\u7684\u80a1\u7968\n    target = target[target['shorts']]\n\n    curr_positions = context.portfolio.positions.keys()\n\n    for stock in curr_positions:\n        if stock in target.index and data.can_trade(stock):\n            # \u5168\u6578\u6e05\u5009\n            order_target_percent(stock, 0)\n\ndef portfolio_plot(context, results):\n    \"\"\"\n    \u7e3e\u6548\u8996\u89ba\u5316\n    \"\"\"\n    import matplotlib.pyplot as plt\n\n    fig = plt.figure()\n    ax1 = fig.add_subplot(111)\n\n    results['benchmark_cum'] = results.benchmark_return.add(1).cumprod() * 1e6\n    results[['portfolio_value', 'benchmark_cum']].plot(\n        ax=ax1,\n        label='Portfolio Value($)'\n    )\n\n    ax1.set_ylabel('Portfolio value (TWD)')\n    plt.legend(loc='upper left')\n    plt.gcf().set_size_inches(18, 8)\n    plt.show()\n\n# ====================================\n# \u57f7\u884c\u56de\u6e2c\n# ====================================\nprint(\"=\"*60)\nprint(\"\u958b\u59cb\u56de\u6e2c\u8ddf\u96a8\u5927\u6236\u7b56\u7565\")\nprint(\"=\"*60)\n\nstart_dt = pd.Timestamp(start_date, tz='utc')\nend_dt = pd.Timestamp(end_date, tz='utc')\n\n# \u53d6\u5f97\u57fa\u6e96\u5831\u916c\nBindex = get_Benchmark_Return(\n    start=start_dt,\n    end=end_dt,\n    symbol='IR0001'\n).sort_index(ascending=True).tz_convert('utc')\n\n# \u57f7\u884c\u56de\u6e2c\nresults = run_algorithm(\n    start=start_dt,\n    end=end_dt,\n    initialize=initialize,\n    before_trading_start=before_trading_start,\n    capital_base=1e6,\n    benchmark_returns=Bindex,\n    data_frequency='daily',\n    bundle='tquant',\n    custom_loader=transform_data,\n    analyze=portfolio_plot\n)\n\nprint(\"\\n\u56de\u6e2c\u5b8c\u6210\uff01\")\n\n# ====================================\n# \u7e3e\u6548\u7d71\u8a08\n# ====================================\nprint(\"\\n========== \u7e3e\u6548\u6458\u8981 ==========\")\n\ntotal_return = (results['portfolio_value'].iloc[-1] / 1e6 - 1) * 100\nbenchmark_return = results['benchmark_period_return'].iloc[-1] * 100\n\nprint(f\"\u7b56\u7565\u7e3d\u5831\u916c: {total_return:.2f}%\")\nprint(f\"\u57fa\u6e96\u5831\u916c: {benchmark_return:.2f}%\")\nprint(f\"\u8d85\u984d\u5831\u916c: {(total_return - benchmark_return):.2f}%\")\nprint(f\"\u6700\u5927\u56de\u64a4: {results['max_drawdown'].min() * 100:.2f}%\")\n\nresults.to_csv('institution_results.csv')\nprint(f\"\\n\u8a73\u7d30\u7d50\u679c\u5df2\u5132\u5b58\u81f3: institution_results.csv\")\n\n# ====================================\n# Pyfolio \u7e3e\u6548\u5206\u6790\n# ====================================\ntry:\n    import pyfolio as pf\n    from pyfolio.utils import extract_rets_pos_txn_from_zipline\n\n    print(\"\\n\" + \"=\"*60)\n    print(\"Pyfolio \u7e3e\u6548\u5206\u6790\")\n    print(\"=\"*60)\n\n    returns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\n    benchmark_rets = results.benchmark_return\n\n    pf.tears.create_full_tear_sheet(\n        returns=returns,\n        positions=positions,\n        transactions=transactions,\n        benchmark_rets=benchmark_rets\n    )\n\nexcept ImportError:\n    print(\"\\n\u672a\u5b89\u88dd pyfolio\uff0c\u7565\u904e\u8a73\u7d30\u5206\u6790\")\n    print(\"\u82e5\u9700\u5b8c\u6574\u5831\u544a\uff0c\u8acb\u57f7\u884c: pip install pyfolio\")\nexcept Exception as e:\n    print(f\"\\nPyfolio \u5206\u6790\u932f\u8aa4: {e}\")\n</code></pre>"},{"location":"blocks/pipeline/case-institution/#_13","title":"\ud83d\udcca \u7b56\u7565\u7279\u6027\u5206\u6790","text":""},{"location":"blocks/pipeline/case-institution/#_14","title":"\u512a\u52e2 \u2705","text":"<ol> <li> <p>\u6355\u6349\u5efa\u5009\u968e\u6bb5</p> <ul> <li>\u6cd5\u4eba\u8cb7\u8d85\u4f46\u6301\u80a1\u7387\u4ecd\u4f4e</li> <li>\u4ee3\u8868\u6b63\u5728\u7d2f\u7a4d\u90e8\u4f4d</li> <li>\u5f8c\u7e8c\u53ef\u80fd\u6301\u7e8c\u8cb7\u9032</li> </ul> </li> <li> <p>\u96d9\u91cd\u78ba\u8a8d\u6a5f\u5236</p> <ul> <li>\u4e0d\u53ea\u770b\u8cb7\u8ce3\u8d85</li> <li>\u9084\u770b\u6301\u80a1\u7387\u76f8\u5c0d\u4f4d\u7f6e</li> <li>\u964d\u4f4e\u5047\u8a0a\u865f</li> </ul> </li> <li> <p>5 \u65e5\u5747\u7dda\u904e\u6ffe</p> <ul> <li>\u904e\u6ffe\u55ae\u65e5\u7570\u5e38</li> <li>\u78ba\u8a8d\u8da8\u52e2\u6301\u7e8c\u6027</li> <li>\u8a0a\u865f\u8f03\u7a69\u5b9a</li> </ul> </li> <li> <p>\u5c0f\u984d\u5206\u6563\u9032\u5834</p> <ul> <li>\u6bcf\u6b21\u53ea\u7528 5% \u73fe\u91d1</li> <li>\u98a8\u96aa\u5206\u6563</li> <li>\u53ef\u540c\u6642\u6301\u6709\u591a\u6a94</li> </ul> </li> <li> <p>\u5168\u6578\u6e05\u5009\u51fa\u5834</p> <ul> <li>\u767c\u51fa\u8ce3\u51fa\u8a0a\u865f\u7acb\u5373\u51fa\u6e05</li> <li>\u907f\u514d\u5957\u7262</li> <li>\u4fdd\u8b77\u7372\u5229</li> </ul> </li> </ol>"},{"location":"blocks/pipeline/case-institution/#_15","title":"\u52a3\u52e2 \u26a0\ufe0f","text":"<ol> <li> <p>\u8cc7\u8a0a\u5ef6\u9072</p> <ul> <li>\u6cd5\u4eba\u8cc7\u6599\u901a\u5e38 T+1 \u516c\u5e03</li> <li>\u5df2\u7d93\u665a\u4e00\u5929</li> <li>\u53ef\u80fd\u932f\u904e\u6700\u4f73\u6642\u6a5f</li> </ul> </li> <li> <p>\u5047\u8a0a\u865f\u98a8\u96aa</p> <ul> <li>\u6cd5\u4eba\u4e5f\u6703\u72af\u932f</li> <li>\u77ed\u671f\u8cb7\u8ce3\u4e0d\u4ee3\u8868\u9577\u671f\u770b\u597d</li> <li>\u53ef\u80fd\u88ab\u6d17\u51fa\u5834</li> </ul> </li> <li> <p>\u6301\u80a1\u5206\u6563</p> <ul> <li>\u6bcf\u6b21\u53ea\u7528 5% \u73fe\u91d1</li> <li>\u53ef\u80fd\u540c\u6642\u6301\u6709 20 \u6a94</li> <li>\u55ae\u4e00\u80a1\u7968\u5f71\u97ff\u6709\u9650</li> </ul> </li> <li> <p>\u4ea4\u6613\u6210\u672c\u9ad8</p> <ul> <li>\u65e5\u5ea6\u8abf\u5009</li> <li>\u983b\u7e41\u9032\u51fa</li> <li>\u624b\u7e8c\u8cbb\u548c\u6ed1\u50f9\u6210\u672c\u9ad8</li> </ul> </li> <li> <p>\u7121\u57fa\u672c\u9762\u9a57\u8b49</p> <ul> <li>\u53ea\u770b\u7c4c\u78bc\u9762</li> <li>\u4e0d\u7ba1\u516c\u53f8\u597d\u58de</li> <li>\u53ef\u80fd\u8cb7\u5230\u5730\u96f7\u80a1</li> </ul> </li> </ol>"},{"location":"blocks/pipeline/case-institution/#_16","title":"\ud83d\udd0d \u95dc\u9375\u5b78\u7fd2\u9ede","text":""},{"location":"blocks/pipeline/case-institution/#1","title":"1. \u70ba\u4ec0\u9ebc\u7528\u300c\u6301\u80a1\u7387 &lt; \u5747\u7dda\u300d\u800c\u975e\u300c\u6301\u80a1\u7387\u4e0a\u5347\u300d\uff1f","text":"<p>\u6301\u80a1\u7387\u4e0a\u5347\u7684\u554f\u984c\uff1a <pre><code># \u53ea\u770b\u6301\u80a1\u7387\u662f\u5426\u4e0a\u5347\nif pct_today &gt; pct_yesterday:\n    buy = True\n\n# \u554f\u984c\uff1a\n# - \u6301\u80a1\u7387\u53ef\u80fd\u5df2\u7d93\u5f88\u9ad8\uff08\u5982 50%\uff09\n# - \u6cd5\u4eba\u53ef\u80fd\u6e96\u5099\u51fa\u8ca8\n# - \u9032\u5834\u6642\u6a5f\u592a\u665a\n</code></pre></p> <p>\u6301\u80a1\u7387 &lt; \u5747\u7dda\u7684\u512a\u52e2\uff1a <pre><code># \u6301\u80a1\u7387 &lt; \u5747\u7dda \u4e14 \u8cb7\u8d85\nif (pct &lt; pct_ma) and (vol &gt; 0):\n    buy = True\n\n# \u512a\u52e2\uff1a\n# - \u78ba\u8a8d\u6cd5\u4eba\u5728\u300c\u5efa\u5009\u300d\u968e\u6bb5\n# - \u6301\u80a1\u9084\u6c92\u5230\u9ad8\u9ede\n# - \u5f8c\u7e8c\u53ef\u80fd\u6301\u7e8c\u8cb7\u9032\n</code></pre></p> <p>\u6848\u4f8b\u8aaa\u660e\uff1a <pre><code>\u60c5\u5883 A\uff08\u4e0d\u597d\uff09\uff1a\n- \u6301\u80a1\u7387\uff1a45% \u2192 46%\uff08\u4e0a\u5347\uff09\n- 5 \u65e5\u5747\u7dda\uff1a43%\n- \u4eca\u65e5\u8cb7\u8d85\uff1a500 \u5f35\n\u2192 \u6301\u80a1\u5df2\u7d93\u504f\u9ad8\uff0c\u53ef\u80fd\u6e96\u5099\u51fa\u8ca8\n\n\u60c5\u5883 B\uff08\u597d\uff09\uff1a\n- \u6301\u80a1\u7387\uff1a28% \u2192 29%\uff08\u4e0a\u5347\uff09\n- 5 \u65e5\u5747\u7dda\uff1a31%\n- \u4eca\u65e5\u8cb7\u8d85\uff1a1000 \u5f35\n\u2192 \u6301\u80a1\u9084\u5728\u4f4e\u6a94\uff0c\u6b63\u5728\u5efa\u5009\n</code></pre></p>"},{"location":"blocks/pipeline/case-institution/#2-customdataset-dataframeloader","title":"2. CustomDataset \u8207 DataFrameLoader \u7684\u4f7f\u7528","text":"<p>\u6311\u6230\uff1a</p> <p>Pipeline \u9810\u8a2d\u53ea\u80fd\u7528 <code>EquityPricing</code>\uff0c\u5982\u4f55\u6574\u5408\u4e09\u5927\u6cd5\u4eba\u8cc7\u6599\uff1f</p> <p>\u89e3\u6c7a\u65b9\u6848\uff1a <pre><code># Step 1: \u5b9a\u7fa9 CustomDataset\nclass CustomDataset(DataSet):\n    total_vol = Column(dtype=float)\n    total_pct = Column(dtype=float)\n    domain = TW_EQUITIES\n\n# Step 2: \u6e96\u5099\u6578\u64da\uff08DataFrame \u683c\u5f0f\uff09\n# index: \u65e5\u671f\uff08UTC timezone\uff09\n# columns: \u80a1\u7968\uff08Equity \u7269\u4ef6\uff09\nbaseline_data['Total_Pct'] = DataFrame(...)\n\n# Step 3: \u5efa\u7acb Loader\ntransform_data = {\n    CustomDataset.total_pct: DataFrameLoader(\n        CustomDataset.total_pct,\n        baseline_data['Total_Pct']\n    )\n}\n\n# Step 4: \u5728 Pipeline \u4e2d\u4f7f\u7528\npct = CustomDataset.total_pct.latest\n</code></pre></p>"},{"location":"blocks/pipeline/case-institution/#3-5","title":"3. \u70ba\u4ec0\u9ebc\u6bcf\u6b21\u53ea\u7528 5% \u73fe\u91d1\uff1f","text":"<p>\u5927\u984d\u8cb7\u5165\u7684\u554f\u984c\uff1a <pre><code># \u6bcf\u6b21\u7528 50% \u73fe\u91d1\norder_target_value(stock, cash * 0.5)\n\n# \u554f\u984c\uff1a\n# - \u8cc7\u91d1\u96c6\u4e2d\n# - \u98a8\u96aa\u9ad8\n# - \u53ea\u80fd\u6301\u6709 2 \u6a94\n</code></pre></p> <p>\u5c0f\u984d\u5206\u6563\u7684\u512a\u52e2\uff1a <pre><code># \u6bcf\u6b21\u7528 5% \u73fe\u91d1\norder_target_value(stock, cash * 0.05)\n\n# \u512a\u52e2\uff1a\n# - \u98a8\u96aa\u5206\u6563\n# - \u53ef\u540c\u6642\u6301\u6709 20 \u6a94\n# - \u55ae\u4e00\u80a1\u7968\u5f71\u97ff\u6709\u9650\n</code></pre></p>"},{"location":"blocks/pipeline/case-institution/#4-custom_loader","title":"4. Custom_loader \u51fd\u6578\u7684\u4f5c\u7528","text":"<p>\u76ee\u7684\uff1a</p> <p>\u5c07 TEJ \u8cc7\u6599\uff08DataFrame\uff09\u8f49\u63db\u70ba Zipline Pipeline \u53ef\u7528\u7684\u683c\u5f0f\u3002</p> <p>\u95dc\u9375\u6b65\u9a5f\uff1a <pre><code># \u539f\u59cb\u6578\u64da\u683c\u5f0f\n# coid | mdate | Total_Pct\n# 2330 | 2023-01-01 | 45.2\n# 2330 | 2023-01-02 | 45.5\n\n# \u8f49\u63db\u5f8c\u683c\u5f0f\uff08\u5bec\u8868\uff09\n# mdate | Equity(2330) | Equity(2317) | ...\n# 2023-01-01 | 45.2 | 32.1 | ...\n# 2023-01-02 | 45.5 | 32.3 | ...\n</code></pre></p> <p>\u7a0b\u5f0f\u78bc\u89e3\u6790\uff1a <pre><code># 1. \u5c07 coid, mdate \u8a2d\u70ba MultiIndex\ndf1 = df.set_index(['coid', 'mdate'])\n\n# 2. \u5c07\u80a1\u7968\u4ee3\u78bc\u8f49\u63db\u70ba Equity \u7269\u4ef6\nassets_map = {i.symbol: i for i in assets}\n\n# 3. \u8f49\u70ba\u5bec\u8868\uff08unstack\uff09\ntarget = df1.unstack('coid')[column]\n\n# 4. \u5c07\u6b04\u4f4d\u540d\u7a31\u5f9e\u5b57\u4e32\u8f49\u70ba Equity \u7269\u4ef6\ntarget.columns = target.columns.map(assets_map)\n\n# 5. \u8a2d\u5b9a\u6642\u5340\ntarget = target.tz_localize('UTC')\n</code></pre></p>"},{"location":"blocks/pipeline/case-institution/#_17","title":"\ud83c\udfaf \u5ef6\u4f38\u512a\u5316\u65b9\u5411","text":""},{"location":"blocks/pipeline/case-institution/#1_1","title":"\u512a\u5316 1: \u52d5\u614b\u8abf\u6574\u8cb7\u5165\u91d1\u984d","text":"<pre><code>def rebalance_start(context, data):\n    target = context.trades[context.trades['longs']]\n\n    # \u6839\u64da\u8cb7\u8d85\u91cf\u8abf\u6574\u8cb7\u5165\u91d1\u984d\n    for stock in target.index:\n        vol = target.loc[stock, 'Total_volume_diff']\n\n        # \u8cb7\u8d85\u8d8a\u591a\uff0c\u8cb7\u5165\u91d1\u984d\u8d8a\u5927\uff08\u4f46\u4e0d\u8d85\u904e 10%\uff09\n        weight = min(vol / 10000 * 0.01, 0.10)\n\n        order_target_value(stock, cash * weight)\n</code></pre>"},{"location":"blocks/pipeline/case-institution/#2_1","title":"\u512a\u5316 2: \u52a0\u5165\u6301\u80a1\u6bd4\u7387\u9580\u6abb","text":"<pre><code>def make_pipeline(ma_days=5):\n    vol = CustomDataset.total_vol.latest\n    pct = CustomDataset.total_pct.latest\n    pct_ma = SimpleMovingAverage(\n        inputs=[CustomDataset.total_pct],\n        window_length=ma_days\n    )\n\n    # \u6301\u80a1\u7387\u8981\u5728\u5408\u7406\u7bc4\u570d\uff0810%-40%\uff09\n    longs = (pct &lt; pct_ma) &amp; (vol &gt; 0) &amp; (pct &gt; 0.10) &amp; (pct &lt; 0.40)\n</code></pre>"},{"location":"blocks/pipeline/case-institution/#3","title":"\u512a\u5316 3: \u52a0\u5165\u57fa\u672c\u9762\u904e\u6ffe","text":"<pre><code># \u53ea\u8cb7\u672c\u76ca\u6bd4 &lt; 20 \u7684\u80a1\u7968\ndef make_pipeline(ma_days=5):\n    # ... \u539f\u672c\u7684\u908f\u8f2f ...\n\n    # \u52a0\u5165\u672c\u76ca\u6bd4\u904e\u6ffe\n    pe_ratio = PERatio()\n\n    longs = (\n        (pct &lt; pct_ma) &amp;\n        (vol &gt; 0) &amp;\n        (pe_ratio &lt; 20) &amp;  # \u672c\u76ca\u6bd4 &lt; 20\n        (pe_ratio &gt; 0)     # \u6392\u9664\u8667\u640d\u80a1\n    )\n</code></pre>"},{"location":"blocks/pipeline/case-institution/#4","title":"\u512a\u5316 4: \u505c\u640d\u6a5f\u5236","text":"<pre><code>def rebalance_end(context, data):\n    # \u539f\u672c\u7684\u8ce3\u51fa\u908f\u8f2f\n    target = context.trades[context.trades['shorts']]\n\n    # \u52a0\u5165\u505c\u640d\n    for stock in context.portfolio.positions:\n        position = context.portfolio.positions[stock]\n        current_price = data.current(stock, 'close')\n\n        # \u8667\u640d 10% \u505c\u640d\n        if current_price &lt; position.cost_basis * 0.9:\n            order_target_percent(stock, 0)\n            log.info(f\"\u505c\u640d\u51fa\u5834: {stock.symbol}\")\n</code></pre>"},{"location":"blocks/pipeline/case-institution/#5","title":"\u512a\u5316 5: \u6301\u6709\u6642\u9593\u9650\u5236","text":"<pre><code>def initialize(context):\n    # ... \u539f\u672c\u7684\u908f\u8f2f ...\n    context.buy_date = {}\n\ndef rebalance_start(context, data):\n    # \u8a18\u9304\u8cb7\u5165\u65e5\u671f\n    for stock in target.index:\n        if stock not in context.portfolio.positions:\n            order_target_value(stock, cash * 0.05)\n            context.buy_date[stock] = get_datetime()\n\ndef rebalance_end(context, data):\n    # \u6301\u6709\u8d85\u904e 30 \u5929\u5f37\u5236\u51fa\u5834\n    for stock in context.portfolio.positions:\n        if stock in context.buy_date:\n            holding_days = (get_datetime() - context.buy_date[stock]).days\n\n            if holding_days &gt; 30:\n                order_target_percent(stock, 0)\n                log.info(f\"\u6301\u6709 {holding_days} \u5929\uff0c\u5f37\u5236\u51fa\u5834\")\n</code></pre>"},{"location":"blocks/pipeline/case-institution/#_18","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6a21\u677f\u9801\u9762\uff1atemplate.md - CustomDataset \u6a21\u677f</li> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md - \u7406\u89e3\u8a2d\u8a08\u539f\u7406</li> <li>\u5176\u4ed6\u6848\u4f8b\uff1a</li> <li>Expanded Momentum - \u52d5\u91cf\u7b56\u7565</li> <li>CounterTrend - \u9006\u52e2\u7b56\u7565</li> </ul>"},{"location":"blocks/pipeline/case-institution/#_19","title":"\ud83d\udca1 \u7e3d\u7d50","text":"<p>\u8ddf\u96a8\u5927\u6236\u7b56\u7565\u5c55\u793a\u4e86 \u7c4c\u78bc\u9762\u91cf\u5316 \u7684\u95dc\u9375\u6d1e\u5bdf\uff1a</p> <ol> <li>\u2705 \u5efa\u5009\u968e\u6bb5\u9032\u5834\uff1a\u6301\u80a1\u7387\u4f4e + \u8cb7\u8d85</li> <li>\u2705 \u96d9\u91cd\u78ba\u8a8d\uff1a\u964d\u4f4e\u5047\u8a0a\u865f</li> <li>\u2705 \u5c0f\u984d\u5206\u6563\uff1a\u6bcf\u6b21 5% \u73fe\u91d1</li> <li>\u2705 \u5168\u6578\u6e05\u5009\uff1a\u767c\u51fa\u8ce3\u51fa\u8a0a\u865f\u7acb\u5373\u51fa\u6e05</li> <li>\u2705 \u81ea\u5b9a\u7fa9\u6578\u64da\uff1a\u6574\u5408 TEJ \u4e09\u5927\u6cd5\u4eba\u8cc7\u6599</li> </ol> <p>\u9069\u5408\u8ab0\u4f7f\u7528\uff1f</p> <ul> <li>\u76f8\u4fe1\u7c4c\u78bc\u9762\u5206\u6790</li> <li>\u80fd\u627f\u53d7\u9ad8\u983b\u4ea4\u6613\u6210\u672c</li> <li>\u77ed\u7dda\u64cd\u4f5c\u8005</li> </ul> <p>\u4f7f\u7528\u5efa\u8b70\uff1a</p> <ul> <li>\u2705 \u6ce8\u610f\u4ea4\u6613\u6210\u672c</li> <li>\u2705 \u642d\u914d\u57fa\u672c\u9762\u904e\u6ffe</li> <li>\u2705 \u8a2d\u5b9a\u505c\u640d\u6a5f\u5236</li> <li>\u26a0\ufe0f \u6cd5\u4eba\u8cc7\u6599\u6709\u5ef6\u9072</li> <li>\u26a0\ufe0f \u6cd5\u4eba\u4e5f\u6703\u72af\u932f</li> </ul> <p>\ud83d\udc49 Next Step:</p> <ol> <li>\u8907\u88fd\u5b8c\u6574\u7a0b\u5f0f\u78bc</li> <li>\u8abf\u6574\u53c3\u6578\uff08\u5747\u7dda\u5929\u6578\u3001\u8cb7\u5165\u91d1\u984d\uff09</li> <li>\u52a0\u5165\u57fa\u672c\u9762\u904e\u6ffe</li> <li>\u6e2c\u8a66\u4e0d\u540c\u8abf\u5009\u983b\u7387</li> </ol>"},{"location":"blocks/pipeline/case-institution/#_20","title":"\ud83d\udcd6 \u5ef6\u4f38\u95b1\u8b80","text":"<p>\u7c4c\u78bc\u5206\u6790\u7406\u8ad6\uff1a</p> <ul> <li>\u4f9b\u9700\u6cd5\u5247\uff1a\u5927\u91cf\u8cb7\u76e4\u63a8\u5347\u80a1\u50f9</li> <li>\u8cc7\u8a0a\u4e0d\u5c0d\u7a31\uff1a\u6a5f\u69cb\u6bd4\u6563\u6236\u6709\u512a\u52e2</li> <li>\u5efa\u5009\u7406\u8ad6\uff1a\u6301\u80a1\u4f4e\u6a94\u7d2f\u7a4d\uff0c\u6301\u80a1\u9ad8\u6a94\u51fa\u8ca8</li> </ul> <p>\u4e09\u5927\u6cd5\u4eba\u7279\u6027\uff1a</p> <ul> <li>\u5916\u8cc7\uff1a\u9577\u7dda\u5e03\u5c40\uff0c\u8cc7\u91d1\u9f90\u5927</li> <li>\u6295\u4fe1\uff1a\u5b63\u5e95\u4f5c\u5e33\uff0c\u6708\u5e95\u7d50\u7b97</li> <li>\u81ea\u71df\u5546\uff1a\u77ed\u7dda\u907f\u96aa\uff0c\u53c3\u8003\u50f9\u503c\u4f4e</li> </ul> <p>\u5be6\u52d9\u6ce8\u610f\u4e8b\u9805\uff1a</p> <ul> <li>\u6cd5\u4eba\u8cc7\u6599 T+1 \u516c\u5e03\uff08\u6709\u5ef6\u9072\uff09</li> <li>\u4f5c\u5e33\u884c\u60c5\uff1a\u5b63\u672b\u6708\u521d\u9700\u6ce8\u610f</li> <li>\u5047\u5916\u8cc7\uff1a\u501f\u540d\u5e33\u6236\u53ef\u80fd\u626d\u66f2\u6578\u64da</li> <li>\u5efa\u5009\u968e\u6bb5\uff1a\u6301\u80a1\u7387 20-35% \u8f03\u4f73</li> <li>\u51fa\u8ca8\u968e\u6bb5\uff1a\u6301\u80a1\u7387 &gt; 40% \u9700\u8b39\u614e</li> </ul>"},{"location":"blocks/pipeline/case-momentum/","title":"\u6848\u4f8b 1\uff1aExpanded Momentum \u7b56\u7565","text":"<p>\u7b56\u7565\u985e\u578b\uff1a Pipeline \u56e0\u5b50\u67b6\u69cb - \u52d5\u91cf\u7b56\u7565 \u4ea4\u6613\u6a19\u7684\uff1a \u53f0\u7063 50 \u6210\u5206\u80a1 \u8abf\u5009\u983b\u7387\uff1a \u6708\u5ea6\uff08\u6bcf\u6708\u7b2c\u4e00\u500b\u4ea4\u6613\u65e5\uff09 \u56de\u6e2c\u671f\u9593\uff1a 2019-01-01 ~ 2023-12-31</p>"},{"location":"blocks/pipeline/case-momentum/#_1","title":"\ud83d\udccc \u7b56\u7565\u6982\u8ff0","text":"<p>Expanded Momentum \u662f\u4e00\u500b\u6539\u826f\u7248\u7684\u52d5\u91cf\u7b56\u7565\uff0c\u7d50\u5408\u4e86 \u8da8\u52e2\u5f37\u5ea6\uff08\u7dda\u6027\u56de\u6b78\u659c\u7387\uff09\u548c \u8da8\u52e2\u7a69\u5b9a\u6027\uff08R\u00b2\uff09\u5169\u500b\u7dad\u5ea6\u3002</p>"},{"location":"blocks/pipeline/case-momentum/#_2","title":"\u6838\u5fc3\u7406\u5ff5","text":"<p>\"Strong trends with high consistency win.\" \u5f37\u52c1\u4e14\u7a69\u5b9a\u7684\u8da8\u52e2\u624d\u662f\u771f\u6b63\u7684\u52d5\u80fd\u3002</p> <p>\u50b3\u7d71\u52d5\u91cf\u7b56\u7565\u53ea\u770b\u5831\u916c\u7387\uff0c\u4f46\u5ffd\u7565\u4e86\u8da8\u52e2\u7684 \u7a69\u5b9a\u6027\u3002\u4e00\u6a94\u80a1\u7968\u53ef\u80fd\u6709 30% \u7684\u5e74\u5831\u916c\uff0c\u4f46\u5982\u679c\u904e\u7a0b\u5287\u70c8\u9707\u76ea\uff0c\u98a8\u96aa\u5f88\u9ad8\u3002Expanded Momentum \u900f\u904e R\u00b2 \u904e\u6ffe\u6389\u4e0d\u7a69\u5b9a\u7684\u8da8\u52e2\u3002</p>"},{"location":"blocks/pipeline/case-momentum/#_3","title":"\u7b56\u7565\u7279\u8272","text":"<ol> <li>\u96d9\u91cd\u8a55\u4f30\uff1a\u659c\u7387\uff08\u8da8\u52e2\u5f37\u5ea6\uff09\u00d7 R\u00b2\uff08\u8da8\u52e2\u7a69\u5b9a\u6027\uff09</li> <li>\u98a8\u96aa\u5e73\u50f9\uff1a\u53cd\u6ce2\u52d5\u7387\u52a0\u6b0a\uff0c\u964d\u4f4e\u7d44\u5408\u6ce2\u52d5</li> <li>\u6d41\u52d5\u6027\u904e\u6ffe\uff1a\u53ea\u4ea4\u6613\u53f0\u7063 50 \u6210\u5206\u80a1</li> <li>\u6708\u5ea6\u8abf\u5009\uff1a\u964d\u4f4e\u4ea4\u6613\u6210\u672c</li> </ol>"},{"location":"blocks/pipeline/case-momentum/#_4","title":"\ud83c\udfaf \u52d5\u91cf\u5206\u6578\u8a08\u7b97\u8a73\u89e3","text":""},{"location":"blocks/pipeline/case-momentum/#_5","title":"\u516c\u5f0f","text":"<pre><code>\u52d5\u91cf\u5206\u6578 = \u5e74\u5316\u659c\u7387 \u00d7 R\u00b2\n\n\u5176\u4e2d\uff1a\n- \u5e74\u5316\u659c\u7387 = \u7dda\u6027\u56de\u6b78\u659c\u7387 \u00d7 252\n- R\u00b2 = \u6c7a\u5b9a\u4fc2\u6578\uff080-1 \u4e4b\u9593\uff09\n</code></pre>"},{"location":"blocks/pipeline/case-momentum/#_6","title":"\u6b65\u9a5f\u62c6\u89e3","text":"<p>Step 1: \u7dda\u6027\u56de\u6b78</p> <p>\u5c0d\u904e\u53bb 252 \u5929\u7684\u50f9\u683c\u505a\u7dda\u6027\u56de\u6b78\uff1a <pre><code>\u50f9\u683c = \u03b2\u2080 + \u03b2\u2081 \u00d7 \u6642\u9593 + \u03b5\n\n\u5176\u4e2d \u03b2\u2081 \u5c31\u662f\u659c\u7387\n</code></pre></p> <p>Step 2: \u8a08\u7b97 R\u00b2 <pre><code>R\u00b2 = 1 - (RSS / TSS)\n\nRSS = \u03a3(\u5be6\u969b\u50f9\u683c - \u9810\u6e2c\u50f9\u683c)\u00b2\nTSS = \u03a3(\u5be6\u969b\u50f9\u683c - \u5e73\u5747\u50f9\u683c)\u00b2\n</code></pre></p> <p>R\u00b2 \u8861\u91cf\u7dda\u6027\u6a21\u578b\u7684\u89e3\u91cb\u529b\uff1a</p> <ul> <li>R\u00b2 = 1\uff1a\u5b8c\u7f8e\u7dda\u6027\u8da8\u52e2</li> <li>R\u00b2 = 0\uff1a\u5b8c\u5168\u96a8\u6a5f</li> </ul> <p>Step 3: \u7d44\u5408\u5206\u6578 <pre><code>\u52d5\u91cf\u5206\u6578 = \u03b2\u2081 \u00d7 252 \u00d7 R\u00b2\n</code></pre></p>"},{"location":"blocks/pipeline/case-momentum/#_7","title":"\u8996\u89ba\u5316\u89e3\u91cb","text":"<pre><code>\u80a1\u7968 A: \u5e74\u5831\u916c 30%\uff0cR\u00b2 = 0.9 \u2192 \u52d5\u91cf\u5206\u6578 = 0.30 \u00d7 0.9 = 0.27\n\u80a1\u7968 B: \u5e74\u5831\u916c 30%\uff0cR\u00b2 = 0.3 \u2192 \u52d5\u91cf\u5206\u6578 = 0.30 \u00d7 0.3 = 0.09\n\n\u96d6\u7136\u5831\u916c\u7387\u76f8\u540c\uff0c\u4f46 A \u7684\u8da8\u52e2\u66f4\u7a69\u5b9a\uff0c\u5206\u6578\u66f4\u9ad8\n</code></pre>"},{"location":"blocks/pipeline/case-momentum/#_8","title":"\ud83d\udd0d \u4ea4\u6613\u908f\u8f2f\u8a73\u89e3","text":""},{"location":"blocks/pipeline/case-momentum/#_9","title":"\u9078\u80a1\u908f\u8f2f","text":"<p>Step 1: \u80a1\u7968\u6c60</p> <p>\u53f0\u7063 50 \u6210\u5206\u80a1\uff08\u7d04 50 \u6a94\uff09</p> <p>Step 2: \u8a08\u7b97\u52d5\u91cf\u5206\u6578</p> <p>\u6bcf\u6a94\u80a1\u7968\u8a08\u7b97\uff1a</p> <ul> <li>\u904e\u53bb 252 \u5929\u7dda\u6027\u56de\u6b78\u659c\u7387</li> <li>R\u00b2 \u503c</li> <li>\u52d5\u91cf\u5206\u6578 = \u659c\u7387 \u00d7 R\u00b2</li> </ul> <p>Step 3: \u7be9\u9078</p> <p>\u53ea\u9078\u52d5\u91cf\u5206\u6578 &gt; 0 \u7684\u80a1\u7968\uff08\u6b63\u8da8\u52e2\uff09</p> <p>Step 4: \u6392\u5e8f</p> <p>\u6309\u52d5\u91cf\u5206\u6578\u7531\u9ad8\u5230\u4f4e\u6392\u5e8f</p>"},{"location":"blocks/pipeline/case-momentum/#_10","title":"\u6b0a\u91cd\u5206\u914d","text":"<p>\u53cd\u6ce2\u52d5\u7387\u52a0\u6b0a\uff08Risk Parity\uff09 <pre><code>\u6b0a\u91cd\u1d62 = (1/\u6ce2\u52d5\u7387\u1d62) / \u03a3(1/\u6ce2\u52d5\u7387\u2c7c)\n</code></pre></p> <p>\u610f\u7fa9\uff1a</p> <ul> <li>\u6ce2\u52d5\u7387\u4f4e\u7684\u80a1\u7968\uff0c\u6b0a\u91cd\u9ad8</li> <li>\u6ce2\u52d5\u7387\u9ad8\u7684\u80a1\u7968\uff0c\u6b0a\u91cd\u4f4e</li> <li>\u76ee\u6a19\uff1a\u964d\u4f4e\u7d44\u5408\u6574\u9ad4\u6ce2\u52d5</li> </ul> <p>\u7bc4\u4f8b\uff1a <pre><code>\u80a1\u7968 A: \u6ce2\u52d5\u7387 20% \u2192 1/0.20 = 5\n\u80a1\u7968 B: \u6ce2\u52d5\u7387 30% \u2192 1/0.30 = 3.33\n\u80a1\u7968 C: \u6ce2\u52d5\u7387 40% \u2192 1/0.40 = 2.5\n\n\u7e3d\u548c = 10.83\n\n\u6b0a\u91cd A = 5 / 10.83 = 46.2%\n\u6b0a\u91cd B = 3.33 / 10.83 = 30.7%\n\u6b0a\u91cd C = 2.5 / 10.83 = 23.1%\n</code></pre></p>"},{"location":"blocks/pipeline/case-momentum/#_11","title":"\ud83d\udcbb \u5b8c\u6574\u7a0b\u5f0f\u78bc","text":"<pre><code># ====================================\n# Expanded Momentum \u7b56\u7565 - \u5b8c\u6574\u5be6\u4f5c\n# ====================================\n\nimport os\nimport pandas as pd\nimport numpy as np\nimport tejapi\nimport matplotlib.pyplot as plt\nfrom logbook import Logger\n\n# ====================================\n# \u74b0\u5883\u8a2d\u5b9a\n# ====================================\nos.environ['TEJAPI_BASE'] = 'https://api.tej.com.tw'\nos.environ['TEJAPI_KEY'] = 'your_key'\ntejapi.ApiConfig.api_key = os.getenv('TEJAPI_KEY')\ntejapi.ApiConfig.api_base = os.getenv('TEJAPI_BASE')\n\nlog = Logger('Momentum')\n\nplt.rcParams['font.sans-serif'] = ['Microsoft JhengHei']\nplt.rcParams['axes.unicode_minus'] = False\n\n# ====================================\n# \u53c3\u6578\u8a2d\u5b9a\n# ====================================\nstart_date = '2019-01-01'\nend_date = '2023-12-31'\n\n# ====================================\n# \u53d6\u5f97\u53f0\u7063 50 \u6210\u5206\u80a1\n# ====================================\nfrom zipline.sources.TEJ_Api_Data import get_universe\n\nprint(\"\u6b63\u5728\u53d6\u5f97\u53f0\u7063 50 \u6210\u5206\u80a1...\")\n\ntw50_list = get_universe(start_date,end_date, idx_id='IX0002')\nprint(f\"\u53f0\u7063 50 \u6210\u5206\u80a1\u6578\u91cf: {len(tw50_list)}\")\n\n# \u8a2d\u5b9a\u74b0\u5883\u8b8a\u6578\nos.environ['mdate'] = f'{start_date} {end_date}'\nos.environ['ticker'] = ' '.join(tw50_list)\n\n# ====================================\n# \u532f\u5165\u80a1\u50f9\u8cc7\u6599\n# ====================================\nfrom zipline.data.run_ingest import simple_ingest\n\npools = tw50_list + ['IR0001']\n\nprint(\"\u6b63\u5728\u6e96\u5099 Zipline \u8cc7\u6599...\")\nsimple_ingest(\n    name='tquant',\n    tickers=pools,\n    start_date=start_date.replace('-', ''),\n    end_date=end_date.replace('-', '')\n)\nprint(\"\u8cc7\u6599\u6e96\u5099\u5b8c\u6210\uff01\")\n\n# ====================================\n# CustomFactor \u5b9a\u7fa9\n# ====================================\nfrom zipline.pipeline import CustomFactor\nfrom zipline.pipeline.data import EquityPricing\nfrom scipy import stats\n\nclass ExpandedMomentum(CustomFactor):\n    \"\"\"\n    Expanded Momentum: \u5e74\u5316\u659c\u7387 \u00d7 R\u00b2\n\n    \u8a08\u7b97\u904e\u53bb 252 \u5929\u7684\u7dda\u6027\u56de\u6b78\uff1a\n    - \u659c\u7387\uff1a\u8da8\u52e2\u5f37\u5ea6\n    - R\u00b2\uff1a\u8da8\u52e2\u7a69\u5b9a\u6027\n    \"\"\"\n    window_length = 252\n    inputs = [EquityPricing.close]\n\n    def compute(self, today, assets, out, close):\n        # \u6e96\u5099\u6642\u9593\u5e8f\u5217 (0, 1, 2, ..., 251)\n        x = np.arange(self.window_length)\n\n        # \u521d\u59cb\u5316\u8f38\u51fa\u9663\u5217\n        slopes = np.zeros(len(assets))\n        r_squared = np.zeros(len(assets))\n\n        # \u5c0d\u6bcf\u6a94\u80a1\u7968\u8a08\u7b97\u7dda\u6027\u56de\u6b78\n        for i in range(len(assets)):\n            y = close[:, i]\n\n            # \u8df3\u904e\u6709 NaN \u7684\u80a1\u7968\n            if np.isnan(y).any():\n                slopes[i] = np.nan\n                r_squared[i] = np.nan\n                continue\n\n            # \u7dda\u6027\u56de\u6b78\n            slope, intercept, r_value, p_value, std_err = stats.linregress(x, y)\n\n            # \u5e74\u5316\u659c\u7387\n            slopes[i] = slope * 252\n\n            # R\u00b2\n            r_squared[i] = r_value ** 2\n\n        # \u52d5\u91cf\u5206\u6578 = \u5e74\u5316\u659c\u7387 \u00d7 R\u00b2\n        momentum_score = slopes * r_squared\n\n        out[:] = momentum_score\n\n\nclass AnnualizedVolatility(CustomFactor):\n    \"\"\"\n    \u5e74\u5316\u6ce2\u52d5\u7387\n    \"\"\"\n    window_length = 252\n    inputs = [EquityPricing.close]\n\n    def compute(self, today, assets, out, close):\n        # \u8a08\u7b97\u65e5\u5831\u916c\u7387\n        daily_returns = np.diff(close, axis=0) / close[:-1]\n\n        # \u5e74\u5316\u6ce2\u52d5\u7387 = \u65e5\u6ce2\u52d5\u7387 \u00d7 \u221a252\n        volatility = np.nanstd(daily_returns, axis=0) * np.sqrt(252)\n\n        out[:] = volatility\n\n\n# ====================================\n# Pipeline \u5b9a\u7fa9\n# ====================================\nfrom zipline.pipeline import Pipeline\nfrom zipline.pipeline.filters import StaticAssets\n\ndef make_pipeline():\n    \"\"\"\n    \u5efa\u7acb Pipeline\n\n    \u6d41\u7a0b\uff1a\n    1. \u8a08\u7b97\u52d5\u91cf\u5206\u6578\n    2. \u8a08\u7b97\u6ce2\u52d5\u7387\n    3. \u7be9\u9078\uff1a\u52d5\u91cf\u5206\u6578 &gt; 0\n    \"\"\"\n    # \u5b9a\u7fa9\u80a1\u7968\u6c60\uff08\u53f0\u7063 50\uff09\n    universe = StaticAssets(symbols(*tw50_list))\n\n    # \u8a08\u7b97\u56e0\u5b50\n    momentum = ExpandedMomentum(mask=universe)\n    volatility = AnnualizedVolatility(mask=universe)\n\n    # \u7be9\u9078\uff1a\u53ea\u8981\u6b63\u52d5\u91cf\n    screen = (momentum &gt; 0) &amp; universe\n\n    return Pipeline(\n        columns={\n            'momentum': momentum,\n            'volatility': volatility\n        },\n        screen=screen\n    )\n\n\n# ====================================\n# \u7b56\u7565\u51fd\u6578\n# ====================================\nfrom zipline.api import (\n    attach_pipeline, pipeline_output,\n    order_target_percent, set_commission, set_slippage,\n    record, schedule_function, date_rules, time_rules,\n    symbol, symbols, set_benchmark\n)\nfrom zipline.finance import commission, slippage\n\ndef initialize(context):\n    \"\"\"\n    \u521d\u59cb\u5316\u51fd\u6578\n    \"\"\"\n    # \u4ea4\u6613\u6210\u672c\n    set_commission(commission.PerShare(cost=0.001425, min_trade_cost=20))\n    set_slippage(slippage.VolumeShareSlippage(volume_limit=0.025, price_impact=0.1))\n    set_benchmark(symbol('IR0001'))  # \u5927\u76e4\u4f5c\u70ba\u57fa\u6e96\n\n    # \u9644\u52a0 Pipeline\n    attach_pipeline(make_pipeline(), 'momentum_pipe')\n\n    # \u6bcf\u6708\u7b2c\u4e00\u500b\u4ea4\u6613\u65e5\u8abf\u5009\n    schedule_function(\n        rebalance,\n        date_rules.month_start(),\n        time_rules.market_open()\n    )\n\n\ndef before_trading_start(context, data):\n    \"\"\"\n    \u76e4\u524d\u57f7\u884c\uff1a\u53d6\u5f97 Pipeline \u8f38\u51fa\n    \"\"\"\n    # \u53d6\u5f97 Pipeline \u7d50\u679c\n    output = pipeline_output('momentum_pipe')\n\n    # \u5132\u5b58\u5b8c\u6574 output\uff08\u7528\u65bc\u8a08\u7b97\u6b0a\u91cd\uff09\n    context.output = output\n\n    # \u9078\u80a1\uff1a\u6240\u6709\u901a\u904e\u7be9\u9078\u7684\u80a1\u7968\n    context.stocks = output.index.tolist()\n\n    log.info(f\"\u9078\u80a1\u6578\u91cf: {len(context.stocks)}\")\n\n\ndef rebalance(context, data):\n    \"\"\"\n    \u8abf\u5009\u51fd\u6578\uff1a\u53cd\u6ce2\u52d5\u7387\u52a0\u6b0a\n    \"\"\"\n    if len(context.stocks) == 0:\n        log.warn(\"\u7121\u80a1\u7968\u901a\u904e\u7be9\u9078\")\n        return\n\n    # ========================================\n    # \u8a08\u7b97\u53cd\u6ce2\u52d5\u7387\u6b0a\u91cd\n    # ========================================\n    volatility_values = context.output.loc[context.stocks, 'volatility']\n\n    # \u53cd\u6ce2\u52d5\u7387\n    inv_vol = 1 / volatility_values\n\n    # \u6a19\u6e96\u5316\u70ba\u6b0a\u91cd\n    total_inv_vol = inv_vol.sum()\n    target_weights = inv_vol / total_inv_vol\n\n    # ========================================\n    # \u8ce3\u51fa\u4e0d\u5728\u6e05\u55ae\u7684\u80a1\u7968\n    # ========================================\n    for stock in context.portfolio.positions:\n        if stock not in context.stocks:\n            order_target_percent(stock, 0)\n            log.info(f\"\u8ce3\u51fa: {stock.symbol}\")\n\n    # ========================================\n    # \u8cb7\u5165\u76ee\u6a19\u80a1\u7968\n    # ========================================\n    for stock in context.stocks:\n        weight = target_weights[stock]\n        if data.can_trade(stock):\n            order_target_percent(stock, weight)\n\n    # ========================================\n    # \u8a18\u9304\u8cc7\u8a0a\n    # ========================================\n    record(\n        num_positions=len(context.portfolio.positions),\n        leverage=context.account.leverage\n    )\n\n\ndef analyze(context, perf):\n    \"\"\"\n    \u7e3e\u6548\u5206\u6790\n    \"\"\"\n    import matplotlib.pyplot as plt\n\n    fig = plt.figure(figsize=(16, 10))\n\n    # \u5716 1: \u6295\u8cc7\u7d44\u5408\u50f9\u503c\n    ax1 = fig.add_subplot(311)\n    perf['portfolio_value'].plot(ax=ax1, linewidth=2)\n    ax1.set_ylabel('Portfolio Value (TWD)', fontsize=12)\n    ax1.set_title('Expanded Momentum Strategy - Portfolio Performance', \n                  fontsize=14, fontweight='bold')\n    ax1.grid(True, alpha=0.3)\n\n    # \u5716 2: \u7d2f\u7a4d\u5831\u916c vs \u57fa\u6e96\n    ax2 = fig.add_subplot(312)\n\n    cumulative_returns = (1 + perf['returns']).cumprod() - 1\n    benchmark_returns = (1 + perf['benchmark_return']).cumprod() - 1\n\n    cumulative_returns.plot(ax=ax2, label='Strategy', linewidth=2, color='#2E86AB')\n    benchmark_returns.plot(ax=ax2, label='Taiwan 50', linewidth=2, alpha=0.7, color='#A23B72')\n\n    ax2.set_ylabel('Cumulative Returns', fontsize=12)\n    ax2.set_title('Strategy vs Taiwan 50 Index', fontsize=14, fontweight='bold')\n    ax2.legend(loc='upper left', fontsize=11)\n    ax2.grid(True, alpha=0.3)\n    ax2.axhline(0, color='black', linewidth=0.8, linestyle='--', alpha=0.5)\n\n    # \u5716 3: \u6301\u5009\u6578\u91cf\n    ax3 = fig.add_subplot(313)\n    perf['num_positions'].plot(ax=ax3, linewidth=2, color='#F18F01')\n    ax3.set_ylabel('Number of Positions', fontsize=12)\n    ax3.set_xlabel('Date', fontsize=12)\n    ax3.set_title('Position Count Over Time', fontsize=14, fontweight='bold')\n    ax3.grid(True, alpha=0.3)\n\n    plt.tight_layout()\n    plt.show()\n\n\n# ====================================\n# \u57f7\u884c\u56de\u6e2c\n# ====================================\nfrom zipline import run_algorithm\n\nprint(\"=\"*60)\nprint(\"\u958b\u59cb\u56de\u6e2c Expanded Momentum \u7b56\u7565\")\nprint(\"=\"*60)\n\nresults = run_algorithm(\n    start=pd.Timestamp(start_date, tz='utc'),\n    end=pd.Timestamp(end_date, tz='utc'),\n    initialize=initialize,\n    before_trading_start=before_trading_start,\n    analyze=analyze,\n    bundle='tquant',\n    capital_base=1e7\n)\n\nprint(\"\\n\u56de\u6e2c\u5b8c\u6210\uff01\")\n\n# ====================================\n# \u7e3e\u6548\u7d71\u8a08\n# ====================================\nprint(\"\\n========== \u7e3e\u6548\u6458\u8981 ==========\")\n\ntotal_return = (results['portfolio_value'].iloc[-1] / 1e7 - 1) * 100\nbenchmark_return = results['benchmark_period_return'].iloc[-1] * 100\n\nprint(f\"\u7b56\u7565\u7e3d\u5831\u916c: {total_return:.2f}%\")\nprint(f\"\u57fa\u6e96\u5831\u916c: {benchmark_return:.2f}%\")\nprint(f\"\u8d85\u984d\u5831\u916c: {(total_return - benchmark_return):.2f}%\")\nprint(f\"\u6700\u5927\u56de\u64a4: {results['max_drawdown'].min() * 100:.2f}%\")\nprint(f\"\u590f\u666e\u6bd4\u7387: {results['sharpe'].iloc[-1]:.2f}\")\nprint(f\"\u5e73\u5747\u6301\u5009\u6578: {results['num_positions'].mean():.0f}\")\n\nresults.to_csv('momentum_results.csv')\nprint(f\"\\n\u8a73\u7d30\u7d50\u679c\u5df2\u5132\u5b58\u81f3: momentum_results.csv\")\n\n# ====================================\n# Pyfolio \u7e3e\u6548\u5206\u6790\n# ====================================\ntry:\n    import pyfolio as pf\n    from pyfolio.utils import extract_rets_pos_txn_from_zipline\n\n    print(\"\\n\" + \"=\"*60)\n    print(\"Pyfolio \u7e3e\u6548\u5206\u6790\")\n    print(\"=\"*60)\n\n    returns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\n    benchmark_rets = results.benchmark_return\n\n    pf.tears.create_full_tear_sheet(\n        returns=returns,\n        positions=positions,\n        transactions=transactions,\n        benchmark_rets=benchmark_rets\n    )\n\nexcept ImportError:\n    print(\"\\n\u672a\u5b89\u88dd pyfolio\uff0c\u7565\u904e\u8a73\u7d30\u5206\u6790\")\n    print(\"\u82e5\u9700\u5b8c\u6574\u5831\u544a\uff0c\u8acb\u57f7\u884c: pip install pyfolio\")\nexcept Exception as e:\n    print(f\"\\nPyfolio \u5206\u6790\u932f\u8aa4: {e}\")\n</code></pre>"},{"location":"blocks/pipeline/case-momentum/#_12","title":"\ud83d\udcca \u7b56\u7565\u7279\u6027\u5206\u6790","text":""},{"location":"blocks/pipeline/case-momentum/#_13","title":"\u512a\u52e2 \u2705","text":"<ol> <li> <p>\u96d9\u91cd\u9a57\u8b49\u6a5f\u5236</p> <ul> <li>\u4e0d\u53ea\u770b\u5831\u916c\u7387\uff0c\u9084\u770b\u8da8\u52e2\u7a69\u5b9a\u6027</li> <li>R\u00b2 \u904e\u6ffe\u6389\u9707\u76ea\u904e\u5927\u7684\u80a1\u7968</li> <li>\u964d\u4f4e\u5047\u7a81\u7834\u98a8\u96aa</li> </ul> </li> <li> <p>\u98a8\u96aa\u5e73\u50f9\u8a2d\u8a08</p> <ul> <li>\u53cd\u6ce2\u52d5\u7387\u52a0\u6b0a</li> <li>\u4f4e\u6ce2\u52d5\u80a1\u7968\u6b0a\u91cd\u9ad8</li> <li>\u7d44\u5408\u6574\u9ad4\u6ce2\u52d5\u8f03\u4f4e</li> </ul> </li> <li> <p>\u6d41\u52d5\u6027\u4fdd\u8b49</p> <ul> <li>\u53ea\u4ea4\u6613\u53f0\u7063 50 \u6210\u5206\u80a1</li> <li>\u6d41\u52d5\u6027\u5145\u8db3</li> <li>\u6ed1\u50f9\u6210\u672c\u4f4e</li> </ul> </li> <li> <p>\u6708\u5ea6\u8abf\u5009</p> <ul> <li>\u4ea4\u6613\u6210\u672c\u53ef\u63a7</li> <li>\u907f\u514d\u904e\u5ea6\u4ea4\u6613</li> <li>\u9069\u5408\u4e2d\u9577\u671f\u6295\u8cc7</li> </ul> </li> <li> <p>\u7406\u8ad6\u57fa\u790e\u624e\u5be6</p> <ul> <li>\u52d5\u91cf\u6548\u61c9\u6709\u5b78\u8853\u652f\u6301</li> <li>\u7dda\u6027\u56de\u6b78\u662f\u7d93\u5178\u65b9\u6cd5</li> <li>R\u00b2 \u662f\u7d71\u8a08\u5b78\u6a19\u6e96\u6307\u6a19</li> </ul> </li> </ol>"},{"location":"blocks/pipeline/case-momentum/#_14","title":"\u52a3\u52e2 \u26a0\ufe0f","text":"<ol> <li> <p>\u8da8\u52e2\u53cd\u8f49\u98a8\u96aa</p> <ul> <li>\u52d5\u91cf\u7b56\u7565\u5728\u8da8\u52e2\u53cd\u8f49\u6642\u8667\u640d</li> <li>2020 \u5e74 3 \u6708\u75ab\u60c5\u66b4\u8dcc\u53d7\u50b7</li> <li>\u9700\u8981\u642d\u914d\u505c\u640d\u6a5f\u5236</li> </ul> </li> <li> <p>\u53c3\u6578\u654f\u611f</p> <ul> <li>252 \u5929\u8996\u7a97\u671f\u662f\u7d93\u9a57\u503c</li> <li>\u4e0d\u540c\u5e02\u5834\u53ef\u80fd\u9700\u8981\u8abf\u6574</li> <li>\u9700\u8981\u56de\u6e2c\u512a\u5316</li> </ul> </li> <li> <p>\u96c6\u4e2d\u5ea6\u98a8\u96aa</p> <ul> <li>\u53f0\u7063 50 \u96c6\u4e2d\u5728\u79d1\u6280\u80a1</li> <li>\u7522\u696d\u5206\u6563\u4e0d\u8db3</li> <li>\u7cfb\u7d71\u6027\u98a8\u96aa\u9ad8</li> </ul> </li> <li> <p>\u6708\u5ea6\u8abf\u5009\u5ef6\u9072</p> <ul> <li>\u7121\u6cd5\u5373\u6642\u53cd\u61c9\u5e02\u5834\u8b8a\u5316</li> <li>\u8da8\u52e2\u53cd\u8f49\u6642\u53cd\u61c9\u6162</li> <li>\u53ef\u80fd\u932f\u904e\u6700\u4f73\u51fa\u5834\u6642\u6a5f</li> </ul> </li> </ol>"},{"location":"blocks/pipeline/case-momentum/#_15","title":"\ud83d\udd0d \u95dc\u9375\u5b78\u7fd2\u9ede","text":""},{"location":"blocks/pipeline/case-momentum/#1","title":"1. \u70ba\u4ec0\u9ebc\u7528\u7dda\u6027\u56de\u6b78\u659c\u7387\u800c\u975e\u7c21\u55ae\u5831\u916c\u7387\uff1f","text":"<p>\u7c21\u55ae\u5831\u916c\u7387\u7684\u554f\u984c\uff1a <pre><code># \u7c21\u55ae\u5831\u916c\u7387\nreturns = (close[-1] - close[0]) / close[0]\n\n# \u554f\u984c\uff1a\u53ea\u770b\u982d\u5c3e\u5169\u9ede\n# \u5ffd\u7565\u4e2d\u9593\u904e\u7a0b\n</code></pre></p> <p>\u7dda\u6027\u56de\u6b78\u659c\u7387\u7684\u512a\u52e2\uff1a <pre><code># \u7dda\u6027\u56de\u6b78\u8003\u616e\u6240\u6709 252 \u500b\u9ede\nslope, intercept, r_value, p_value, std_err = stats.linregress(x, y)\n\n# \u512a\u52e2\uff1a\n# 1. \u8003\u616e\u6574\u500b\u8da8\u52e2\n# 2. \u5c0d\u7570\u5e38\u503c\u8f03\u4e0d\u654f\u611f\n# 3. \u53ef\u4ee5\u5f97\u5230 R\u00b2\n</code></pre></p>"},{"location":"blocks/pipeline/case-momentum/#2-r2","title":"2. R\u00b2 \u7684\u610f\u7fa9","text":"<p>R\u00b2 = 0.9 vs R\u00b2 = 0.3 <pre><code>\u80a1\u7968 A (R\u00b2 = 0.9):\n  \u50f9\u683c\u6cbf\u8457\u8da8\u52e2\u7dda\u7a69\u5b9a\u4e0a\u5347\n  \u2197\u2197\u2197\u2197\u2197\u2197\u2197\u2197\n\n\u80a1\u7968 B (R\u00b2 = 0.3):\n  \u50f9\u683c\u5287\u70c8\u9707\u76ea\n  \u2197\u2198\u2197\u2198\u2197\u2198\u2197\u2198\n\n\u5373\u4f7f\u5169\u8005\u6700\u7d42\u5831\u916c\u76f8\u540c\uff0cA \u7684\u8da8\u52e2\u66f4\u53ef\u9760\n</code></pre></p>"},{"location":"blocks/pipeline/case-momentum/#3","title":"3. \u5411\u91cf\u5316\u8a08\u7b97\u7684\u91cd\u8981\u6027","text":"<p>\u274c \u932f\u8aa4\uff1a\u7528\u8ff4\u5708 <pre><code>def compute(self, today, assets, out, close):\n    for i in range(len(assets)):\n        y = close[:, i]\n        slope, _, r_value, _, _ = stats.linregress(x, y)\n        out[i] = slope * 252 * r_value ** 2\n    # 50 \u6a94\u80a1\u7968\uff0c50 \u6b21\u8ff4\u5708\uff0c\u6162\uff01\n</code></pre></p> <p>\u2705 \u6b63\u78ba\uff1a\u4ecd\u9700\u8ff4\u5708\uff08\u56e0\u70ba linregress \u7121\u6cd5\u5411\u91cf\u5316\uff09 <pre><code># scipy.stats.linregress \u4e0d\u652f\u63f4\u5411\u91cf\u5316\n# \u6240\u4ee5\u9019\u88e1\u5fc5\u9808\u7528\u8ff4\u5708\n# \u4f46\u9019\u662f\u4e0d\u5f97\u5df2\u7684\uff0c\u5982\u679c\u6709\u5411\u91cf\u5316\u7248\u672c\u6703\u66f4\u5feb\n</code></pre></p>"},{"location":"blocks/pipeline/case-momentum/#4","title":"4. \u53cd\u6ce2\u52d5\u7387\u52a0\u6b0a\u7684\u908f\u8f2f","text":"<p>\u70ba\u4ec0\u9ebc\u4e0d\u7528\u7b49\u6b0a\u91cd\uff1f <pre><code>\u7b49\u6b0a\u91cd\uff1a\n\u80a1\u7968 A (\u6ce2\u52d5\u7387 20%): \u6b0a\u91cd 33.3%\n\u80a1\u7968 B (\u6ce2\u52d5\u7387 30%): \u6b0a\u91cd 33.3%\n\u80a1\u7968 C (\u6ce2\u52d5\u7387 40%): \u6b0a\u91cd 33.3%\n\n\u2192 \u7d44\u5408\u6ce2\u52d5\u7387 \u2248 30%\n\n\u53cd\u6ce2\u52d5\u7387\u52a0\u6b0a\uff1a\n\u80a1\u7968 A (\u6ce2\u52d5\u7387 20%): \u6b0a\u91cd 46.2%\n\u80a1\u7968 B (\u6ce2\u52d5\u7387 30%): \u6b0a\u91cd 30.7%\n\u80a1\u7968 C (\u6ce2\u52d5\u7387 40%): \u6b0a\u91cd 23.1%\n\n\u2192 \u7d44\u5408\u6ce2\u52d5\u7387 \u2248 24%\uff08\u964d\u4f4e 20%\uff09\n</code></pre></p>"},{"location":"blocks/pipeline/case-momentum/#_16","title":"\ud83c\udfaf \u5ef6\u4f38\u512a\u5316\u65b9\u5411","text":""},{"location":"blocks/pipeline/case-momentum/#1_1","title":"\u512a\u5316 1: \u52d5\u614b\u8abf\u6574\u8996\u7a97\u671f","text":"<pre><code>class AdaptiveMomentum(CustomFactor):\n    \"\"\"\n    \u6839\u64da\u5e02\u5834\u6ce2\u52d5\u7387\u8abf\u6574\u8996\u7a97\u671f\n    \"\"\"\n    def compute(self, today, assets, out, close):\n        # \u8a08\u7b97\u5e02\u5834\u6ce2\u52d5\u7387\n        market_vol = calculate_market_volatility()\n\n        # \u9ad8\u6ce2\u52d5\u7528\u77ed\u8996\u7a97\uff0c\u4f4e\u6ce2\u52d5\u7528\u9577\u8996\u7a97\n        if market_vol &gt; 0.3:\n            window = 126  # \u534a\u5e74\n        else:\n            window = 252  # \u4e00\u5e74\n\n        # \u4f7f\u7528\u52d5\u614b\u8996\u7a97\u8a08\u7b97\u52d5\u91cf\n        ...\n</code></pre>"},{"location":"blocks/pipeline/case-momentum/#2","title":"\u512a\u5316 2: \u52a0\u5165\u6b62\u640d\u6a5f\u5236","text":"<pre><code>def rebalance(context, data):\n    # \u6aa2\u67e5\u6301\u5009\u8667\u640d\n    for stock in context.portfolio.positions:\n        position = context.portfolio.positions[stock]\n        current_price = data.current(stock, 'close')\n\n        # \u8667\u640d\u8d85\u904e 15% \u505c\u640d\n        if current_price &lt; position.cost_basis * 0.85:\n            order_target_percent(stock, 0)\n            log.info(f\"\u505c\u640d: {stock.symbol}\")\n</code></pre>"},{"location":"blocks/pipeline/case-momentum/#3_1","title":"\u512a\u5316 3: \u7522\u696d\u4e2d\u6027","text":"<pre><code>def before_trading_start(context, data):\n    output = pipeline_output('momentum_pipe')\n\n    # \u52a0\u5165\u7522\u696d\u5206\u985e\uff08\u9700\u8981\u5916\u90e8\u6578\u64da\uff09\n    output['industry'] = get_industry_classification(output.index)\n\n    # \u6bcf\u500b\u7522\u696d\u9078\u524d 3 \u540d\n    stocks = []\n    for industry in output['industry'].unique():\n        industry_stocks = output[output['industry'] == industry]\n        top3 = industry_stocks.nlargest(3, 'momentum')\n        stocks.extend(top3.index.tolist())\n\n    context.stocks = stocks\n</code></pre>"},{"location":"blocks/pipeline/case-momentum/#4_1","title":"\u512a\u5316 4: \u52d5\u614b\u6301\u5009\u6578\u91cf","text":"<pre><code>def before_trading_start(context, data):\n    output = pipeline_output('momentum_pipe')\n\n    # \u6839\u64da\u5e02\u5834\u72c0\u6cc1\u8abf\u6574\u6301\u5009\u6578\n    avg_momentum = output['momentum'].mean()\n\n    if avg_momentum &gt; 0.5:\n        num_stocks = 15  # \u5f37\u52e2\u5e02\u5834\uff0c\u96c6\u4e2d\u6301\u5009\n    elif avg_momentum &gt; 0.2:\n        num_stocks = 25  # \u4e2d\u6027\u5e02\u5834\n    else:\n        num_stocks = 35  # \u5f31\u52e2\u5e02\u5834\uff0c\u5206\u6563\u6301\u5009\n\n    context.stocks = output.nlargest(num_stocks, 'momentum').index.tolist()\n</code></pre>"},{"location":"blocks/pipeline/case-momentum/#5","title":"\u512a\u5316 5: \u591a\u56e0\u5b50\u7d44\u5408","text":"<pre><code>class ValueFactor(CustomFactor):\n    \"\"\"\u50f9\u503c\u56e0\u5b50\uff1a\u4f4e PB\"\"\"\n    ...\n\ndef make_pipeline():\n    momentum = ExpandedMomentum()\n    value = ValueFactor()\n\n    # \u7d44\u5408\u5206\u6578\n    composite = 0.7 * momentum.rank() + 0.3 * value.rank()\n\n    return Pipeline(\n        columns={'composite': composite},\n        screen=composite.top(20)\n    )\n</code></pre>"},{"location":"blocks/pipeline/case-momentum/#_17","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6a21\u677f\u9801\u9762\uff1atemplate.md - CustomFactor \u6a21\u677f</li> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md - \u7406\u89e3\u8a2d\u8a08\u539f\u7406</li> <li>\u5176\u4ed6\u6848\u4f8b\uff1a</li> <li>\u8ddf\u96a8\u5927\u6236 - \u7c4c\u78bc\u5206\u6790</li> <li>CounterTrend - \u9006\u52e2\u7b56\u7565</li> </ul>"},{"location":"blocks/pipeline/case-momentum/#_18","title":"\ud83d\udca1 \u7e3d\u7d50","text":"<p>Expanded Momentum \u7b56\u7565\u5c55\u793a\u4e86 Pipeline \u67b6\u69cb\u7684\u6838\u5fc3\u512a\u52e2\uff1a</p> <ol> <li>\u2705 \u6279\u6b21\u8a08\u7b97\uff1a\u4e00\u6b21\u8655\u7406 50 \u6a94\u80a1\u7968</li> <li>\u2705 \u56e0\u5b50\u6a21\u7d44\u5316\uff1a\u52d5\u91cf\u548c\u6ce2\u52d5\u7387\u7368\u7acb\u8a08\u7b97</li> <li>\u2705 \u53ef\u64f4\u5c55\u6027\uff1a\u5f9e 50 \u6a94\u5230 500 \u6a94\u7121\u75db\u5347\u7d1a</li> <li>\u2705 \u7406\u8ad6\u624e\u5be6\uff1a\u7dda\u6027\u56de\u6b78 + R\u00b2 \u662f\u7d93\u5178\u65b9\u6cd5</li> </ol> <p>\u9069\u5408\u8ab0\u4f7f\u7528\uff1f</p> <ul> <li>\u91cf\u5316\u6295\u8cc7\u8005</li> <li>\u504f\u597d\u52d5\u91cf\u7b56\u7565</li> <li>\u4e2d\u9577\u671f\u6295\u8cc7\u8005\uff08\u6708\u5ea6\u8abf\u5009\uff09</li> </ul> <p>\u4f7f\u7528\u5efa\u8b70\uff1a</p> <ul> <li>\u2705 \u5728\u8da8\u52e2\u660e\u78ba\u7684\u5e02\u5834\u4f7f\u7528</li> <li>\u2705 \u642d\u914d\u505c\u640d\u6a5f\u5236</li> <li>\u2705 \u6ce8\u610f\u7522\u696d\u5206\u6563</li> <li>\u26a0\ufe0f \u907f\u514d\u5728\u9707\u76ea\u5e02\u5834\u4f7f\u7528</li> <li>\u26a0\ufe0f \u6ce8\u610f\u8da8\u52e2\u53cd\u8f49\u98a8\u96aa</li> </ul> <p>\ud83d\udc49 Next Step:</p> <ol> <li>\u8907\u88fd\u5b8c\u6574\u7a0b\u5f0f\u78bc</li> <li>\u8abf\u6574\u53c3\u6578\uff08\u8996\u7a97\u671f\u3001\u6b0a\u91cd\u65b9\u6cd5\uff09</li> <li>\u6e2c\u8a66\u4e0d\u540c\u80a1\u7968\u6c60</li> <li>\u52a0\u5165\u4f60\u7684\u512a\u5316\u908f\u8f2f</li> </ol>"},{"location":"blocks/pipeline/case-momentum/#_19","title":"\ud83d\udcd6 \u5ef6\u4f38\u95b1\u8b80","text":"<p>\u52d5\u91cf\u6548\u61c9\u7814\u7a76\uff1a</p> <ul> <li>Jegadeesh &amp; Titman (1993) \"Returns to Buying Winners and Selling Losers\"</li> <li>Carhart (1997) \"On Persistence in Mutual Fund Performance\"</li> </ul> <p>\u52d5\u91cf\u7b56\u7565\u7684\u7406\u8ad6\u89e3\u91cb\uff1a</p> <ul> <li>\u884c\u70ba\u91d1\u878d\u5b78\uff1a\u6295\u8cc7\u4eba\u53cd\u61c9\u4e0d\u8db3\uff08Underreaction\uff09</li> <li>\u8cc7\u8a0a\u64f4\u6563\uff1a\u597d\u6d88\u606f\u9010\u6b65\u50b3\u64ad</li> <li>\u7f8a\u7fa4\u6548\u61c9\uff1a\u8ffd\u6f32\u6bba\u8dcc</li> </ul> <p>R\u00b2 \u5728\u91cf\u5316\u6295\u8cc7\u7684\u61c9\u7528\uff1a</p> <ul> <li>\u8da8\u52e2\u5f37\u5ea6\u904e\u6ffe</li> <li>\u7b56\u7565\u7a69\u5b9a\u6027\u8a55\u4f30</li> <li>\u56e0\u5b50\u6709\u6548\u6027\u6aa2\u9a57</li> </ul>"},{"location":"blocks/pipeline/faq/","title":"Pipeline \u56e0\u5b50\u67b6\u69cb - \u5e38\u898b\u554f\u984c FAQ","text":"<p>\u672c\u9801\u6574\u7406\u4f7f\u7528 Pipeline \u56e0\u5b50\u67b6\u69cb\u6642\u6700\u5e38\u9047\u5230\u7684\u554f\u984c\u8207\u89e3\u6c7a\u65b9\u6848\u3002</p>"},{"location":"blocks/pipeline/faq/#_1","title":"\ud83d\udcd1 \u76ee\u9304","text":"<ul> <li>\u57fa\u790e\u6982\u5ff5</li> <li>CustomFactor \u958b\u767c</li> <li>Pipeline \u7d44\u5408</li> <li>\u6578\u64da\u8655\u7406</li> <li>\u6548\u80fd\u512a\u5316</li> <li>\u9664\u932f\u6280\u5de7</li> <li>\u5be6\u52d9\u61c9\u7528</li> </ul>"},{"location":"blocks/pipeline/faq/#basics","title":"\u57fa\u790e\u6982\u5ff5","text":""},{"location":"blocks/pipeline/faq/#q1-pipeline-vs","title":"Q1: Pipeline \u67b6\u69cb vs \u5176\u4ed6\u67b6\u69cb\uff0c\u6211\u8a72\u9078\u54ea\u500b\uff1f","text":"<p>\u6c7a\u7b56\u6d41\u7a0b\u5716\uff1a <pre><code>graph TD\n    A[\u4f60\u7684\u7b56\u7565] --&gt; B{\u80a1\u7968\u6578\u91cf?}\n    B --&gt;|&lt;10 \u6a94| C[\u6280\u8853\u6307\u6a19\u67b6\u69cb]\n    B --&gt;|10-50 \u6a94| D{\u908f\u8f2f\u8907\u96dc\u5ea6?}\n    B --&gt;|&gt;50 \u6a94| E[\u2705 Pipeline \u67b6\u69cb]\n\n    D --&gt;|\u7c21\u55ae\u56e0\u5b50| E\n    D --&gt;|\u8907\u96dc if-else| C\n\n    style E fill:#c8e6c9,stroke:#388e3c,stroke-width:3px</code></pre></p> <p>\u5feb\u901f\u5224\u65b7\uff1a</p> \u67b6\u69cb \u9069\u7528\u80a1\u7968\u6578 \u9069\u7528\u60c5\u5883 \u5b78\u7fd2\u96e3\u5ea6 Pipeline 50-2000 \u56e0\u5b50\u9078\u80a1\u3001\u6279\u6b21\u8a08\u7b97 \ud83d\udd34 \u9ad8 \u6280\u8853\u6307\u6a19 1-10 \u6280\u8853\u5206\u6790\u3001\u9748\u6d3b\u908f\u8f2f \ud83d\udfe2 \u4f4e \u8ca1\u5831\u9078\u80a1 50-200 \u57fa\u672c\u9762\u9078\u80a1\u3001\u5b63\u5ea6\u8abf\u5009 \ud83d\udfe2 \u4f4e"},{"location":"blocks/pipeline/faq/#q2-pipeline","title":"Q2: Pipeline \u7684\u6838\u5fc3\u512a\u52e2\u662f\u4ec0\u9ebc\uff1f","text":"<p>\u5411\u91cf\u5316\u8a08\u7b97\u7684\u5a01\u529b\uff1a <pre><code># \u274c Loop \u65b9\u6cd5\uff08\u6162\uff09\nfor stock in stock_list:  # 1000 \u6a94\n    history = data.history(stock, 'close', 252, '1d')\n    momentum = calculate_momentum(history)\n    # 1000 \u6b21 API \u8abf\u7528\uff01\n\n# \u2705 Pipeline \u65b9\u6cd5\uff08\u5feb\uff09\nclass Momentum(CustomFactor):\n    window_length = 252\n    def compute(self, today, assets, out, close):\n        out[:] = (close[-1] - close[0]) / close[0]\n        # \u4e00\u6b21\u8a08\u7b97 1000 \u6a94\uff01\n</code></pre></p> <p>\u6548\u80fd\u5c0d\u6bd4\uff1a</p> \u80a1\u7968\u6578 Loop \u8017\u6642 Pipeline \u8017\u6642 \u52a0\u901f\u6bd4 10 1 \u79d2 0.5 \u79d2 2x 100 10 \u79d2 0.6 \u79d2 17x 1000 100 \u79d2 1 \u79d2 100x"},{"location":"blocks/pipeline/faq/#q3-pipeline","title":"Q3: \u4ec0\u9ebc\u6642\u5019 \u4e0d\u8a72 \u7528 Pipeline\uff1f","text":"<p>\u4e0d\u9069\u5408\u7684\u60c5\u5883\uff1a</p> <ol> <li> <p>\u5c11\u6578\u6a19\u7684\uff08&lt;10 \u6a94\uff09</p> <ul> <li>Loop \u65b9\u6cd5\u66f4\u76f4\u89c0</li> <li>Pipeline \u7684\u6548\u80fd\u512a\u52e2\u4e0d\u660e\u986f</li> <li>\u5b78\u7fd2\u6210\u672c\u4e0d\u5212\u7b97</li> </ul> </li> <li> <p>\u8907\u96dc\u908f\u8f2f\uff08\u5927\u91cf if-else\uff09</p> <ul> <li>Pipeline \u96e3\u4ee5\u5be6\u73fe\u8907\u96dc\u689d\u4ef6\u5224\u65b7</li> <li>\u9700\u8981\u6839\u64da\u7576\u524d\u6301\u5009\u52d5\u614b\u8abf\u6574</li> <li>\u4f8b\u5982\uff1a\u91d1\u5b57\u5854\u52a0\u78bc\u3001\u52d5\u614b\u505c\u640d</li> </ul> </li> <li> <p>\u9ad8\u983b\u4ea4\u6613</p> <ul> <li>Pipeline \u662f\u65e5\u983b\u8a2d\u8a08</li> <li>\u7121\u6cd5\u505a\u5206\u9418\u7d1a\u6216 Tick \u7d1a\u4ea4\u6613</li> </ul> </li> <li> <p>\u9700\u8981\u5373\u6642\u53cd\u61c9</p> <ul> <li>Pipeline \u5728\u76e4\u524d\u8a08\u7b97</li> <li>\u7121\u6cd5\u6839\u64da\u76e4\u4e2d\u50f9\u683c\u8b8a\u5316\u8abf\u6574</li> </ul> </li> </ol>"},{"location":"blocks/pipeline/faq/#customfactor","title":"CustomFactor \u958b\u767c","text":""},{"location":"blocks/pipeline/faq/#q4-customfactor","title":"Q4: CustomFactor \u7684\u57fa\u672c\u7d50\u69cb\u662f\u4ec0\u9ebc\uff1f","text":"<p>\u5b8c\u6574\u6a21\u677f\uff1a <pre><code>from zipline.pipeline import CustomFactor\nfrom zipline.pipeline.data import EquityPricing\nimport numpy as np\n\nclass MyFactor(CustomFactor):\n    \"\"\"\n    \u56e0\u5b50\u8aaa\u660e\u6587\u6a94\n    \"\"\"\n    # \u9700\u8981\u591a\u5c11\u5929\u7684\u8cc7\u6599\n    window_length = 252\n\n    # \u9700\u8981\u54ea\u4e9b\u6b04\u4f4d\n    inputs = [EquityPricing.close]\n\n    def compute(self, today, assets, out, close):\n        \"\"\"\n        \u8a08\u7b97\u908f\u8f2f\n\n        Parameters:\n        -----------\n        today : pd.Timestamp\n            \u7576\u524d\u65e5\u671f\n        assets : np.array\n            \u80a1\u7968\u4ee3\u78bc\u9663\u5217 (\u9577\u5ea6 N)\n        out : np.array\n            \u8f38\u51fa\u9663\u5217 (\u9577\u5ea6 N\uff0c\u8981\u586b\u5165\u7d50\u679c)\n        close : np.array\n            \u6536\u76e4\u50f9\u77e9\u9663 (window_length \u00d7 N)\n        \"\"\"\n        # \ud83d\udd25 \u5728\u9019\u88e1\u5be6\u4f5c\u4f60\u7684\u8a08\u7b97\u908f\u8f2f\n\n        # \u7bc4\u4f8b\uff1a\u8a08\u7b97\u5831\u916c\u7387\n        returns = (close[-1] - close[0]) / close[0]\n\n        # \u586b\u5165\u8f38\u51fa\u9663\u5217\n        out[:] = returns\n</code></pre></p> <p>\u95dc\u9375\u6982\u5ff5\uff1a</p> <ul> <li><code>window_length</code>\uff1a\u6c7a\u5b9a <code>close</code> \u77e9\u9663\u7684\u884c\u6578</li> <li><code>inputs</code>\uff1a\u6c7a\u5b9a <code>compute()</code> \u7684\u53c3\u6578</li> <li><code>out[:]</code>\uff1a\u5fc5\u9808\u8ce6\u503c\u6574\u500b\u9663\u5217\uff08\u4e0d\u80fd\u7528\u8ff4\u5708\u9010\u500b\u8ce6\u503c\uff09</li> </ul>"},{"location":"blocks/pipeline/faq/#q5","title":"Q5: \u5982\u4f55\u8655\u7406\u591a\u500b\u8f38\u5165\u6b04\u4f4d\uff1f","text":"<p>\u7bc4\u4f8b\uff1a\u8a08\u7b97\u50f9\u91cf\u6bd4 <pre><code>class PriceToVolume(CustomFactor):\n    window_length = 1\n    inputs = [\n        EquityPricing.close,\n        EquityPricing.volume\n    ]\n\n    def compute(self, today, assets, out, close, volume):\n        # \u53c3\u6578\u9806\u5e8f\u8207 inputs \u4e00\u81f4\n        # close: (1 \u00d7 N)\n        # volume: (1 \u00d7 N)\n\n        # \u53d6\u6700\u65b0\u503c\n        latest_close = close[-1]\n        latest_volume = volume[-1]\n\n        # \u8a08\u7b97\u6bd4\u503c\uff08\u907f\u514d\u9664\u4ee5\u96f6\uff09\n        ratio = latest_close / (latest_volume + 1e-10)\n\n        out[:] = ratio\n</code></pre></p> <p>\u6ce8\u610f\u4e8b\u9805\uff1a <pre><code># \u274c \u932f\u8aa4\uff1a\u53c3\u6578\u540d\u7a31\u53ef\u4ee5\u96a8\u610f\ndef compute(self, today, assets, out, x, y):\n    # x \u5c0d\u61c9\u7b2c\u4e00\u500b input (close)\n    # y \u5c0d\u61c9\u7b2c\u4e8c\u500b input (volume)\n\n# \u2705 \u6b63\u78ba\uff1a\u5efa\u8b70\u4f7f\u7528\u6709\u610f\u7fa9\u7684\u540d\u7a31\ndef compute(self, today, assets, out, close, volume):\n    # \u53ef\u8b80\u6027\u66f4\u597d\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#q6-nan","title":"Q6: \u5982\u4f55\u8655\u7406 NaN \u503c\uff1f","text":"<p>\u554f\u984c\u60c5\u5883\uff1a <pre><code># \u67d0\u4e9b\u80a1\u7968\u53ef\u80fd\u6c92\u6709\u5b8c\u6574\u7684 252 \u5929\u8cc7\u6599\n# \u5c0e\u81f4 close \u77e9\u9663\u4e2d\u6709 NaN\n</code></pre></p> <p>\u89e3\u6c7a\u65b9\u6848\uff1a <pre><code>class SafeMomentum(CustomFactor):\n    window_length = 252\n    inputs = [EquityPricing.close]\n\n    def compute(self, today, assets, out, close):\n        # \u65b9\u6cd5 1: \u4f7f\u7528 nanmean, nanstd \u7b49\u51fd\u6578\n        returns = (close[-1] - close[0]) / close[0]\n        out[:] = np.where(np.isnan(returns), np.nan, returns)\n\n        # \u65b9\u6cd5 2: \u9010\u6a94\u6aa2\u67e5\uff08\u8f03\u6162\uff09\n        for i in range(len(assets)):\n            prices = close[:, i]\n            if np.isnan(prices).any():\n                out[i] = np.nan\n            else:\n                out[i] = (prices[-1] - prices[0]) / prices[0]\n\n        # \u65b9\u6cd5 3: \u7528 mask \u904e\u6ffe\uff08\u63a8\u85a6\uff09\n        # \u5728 Pipeline \u5b9a\u7fa9\u6642\u52a0\u5165 mask\n</code></pre></p> <p>\u6700\u4f73\u5be6\u8e10\uff1a <pre><code># \u5728 make_pipeline() \u4e2d\u4f7f\u7528 mask\ndef make_pipeline():\n    # \u5b9a\u7fa9\u80a1\u7968\u6c60\uff08\u81ea\u52d5\u904e\u6ffe\u8cc7\u6599\u4e0d\u8db3\u7684\u80a1\u7968\uff09\n    universe = AverageDollarVolume(window_length=30).top(500)\n\n    # \u56e0\u5b50\u8a08\u7b97\u6642\u53ea\u8003\u616e universe \u5167\u7684\u80a1\u7968\n    momentum = Momentum(mask=universe)\n\n    return Pipeline(\n        columns={'momentum': momentum},\n        screen=universe\n    )\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#q7","title":"Q7: \u5411\u91cf\u5316\u8a08\u7b97\u7684\u5e38\u898b\u932f\u8aa4\uff1f","text":"<p>\u932f\u8aa4 1\uff1a\u7528\u8ff4\u5708 <pre><code># \u274c \u932f\u8aa4\nclass SlowFactor(CustomFactor):\n    def compute(self, today, assets, out, close):\n        for i in range(len(assets)):\n            out[i] = close[:, i].mean()  # \u6162\uff01\n\n# \u2705 \u6b63\u78ba\nclass FastFactor(CustomFactor):\n    def compute(self, today, assets, out, close):\n        out[:] = np.mean(close, axis=0)  # \u5feb\uff01\n</code></pre></p> <p>\u932f\u8aa4 2\uff1a\u5fd8\u8a18 axis \u53c3\u6578 <pre><code># \u274c \u932f\u8aa4\nout[:] = np.mean(close)  # \u8a08\u7b97\u6240\u6709\u80a1\u7968\u7684\u5e73\u5747\uff08\u932f\u8aa4\uff09\n\n# \u2705 \u6b63\u78ba\nout[:] = np.mean(close, axis=0)  # \u6bcf\u6a94\u80a1\u7968\u7684\u5e73\u5747\uff08\u6b63\u78ba\uff09\n</code></pre></p> <p>axis \u53c3\u6578\u89e3\u91cb\uff1a <pre><code>close \u77e9\u9663\u7dad\u5ea6: (window_length \u00d7 \u80a1\u7968\u6578)\n\naxis=0: \u6cbf\u8457\u6642\u9593\u8ef8\u8a08\u7b97\uff08\u6bcf\u6a94\u80a1\u7968\uff09\naxis=1: \u6cbf\u8457\u80a1\u7968\u8ef8\u8a08\u7b97\uff08\u6bcf\u500b\u6642\u9593\u9ede\uff09\n\n\u6211\u5011\u901a\u5e38\u9700\u8981 axis=0\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#pipeline","title":"Pipeline \u7d44\u5408","text":""},{"location":"blocks/pipeline/faq/#q8","title":"Q8: \u5982\u4f55\u7d44\u5408\u591a\u500b\u56e0\u5b50\uff1f","text":"<p>\u65b9\u6cd5 1\uff1a\u76f4\u63a5\u7d44\u5408 <pre><code>def make_pipeline():\n    factor1 = Factor1()\n    factor2 = Factor2()\n\n    # \u52a0\u6b0a\u7d44\u5408\n    composite = 0.6 * factor1 + 0.4 * factor2\n\n    return Pipeline(\n        columns={'composite': composite}\n    )\n</code></pre></p> <p>\u65b9\u6cd5 2\uff1a\u6392\u540d\u5f8c\u7d44\u5408 <pre><code>def make_pipeline():\n    factor1 = Factor1()\n    factor2 = Factor2()\n\n    # \u6a19\u6e96\u5316\u70ba\u6392\u540d\uff080-1\uff09\n    rank1 = factor1.rank() / factor1.rank().max()\n    rank2 = factor2.rank() / factor2.rank().max()\n\n    # \u52a0\u6b0a\u7d44\u5408\n    composite = 0.6 * rank1 + 0.4 * rank2\n\n    return Pipeline(\n        columns={'composite': composite}\n    )\n</code></pre></p> <p>\u65b9\u6cd5 3\uff1a\u7be9\u9078\u5f8c\u7d44\u5408 <pre><code>def make_pipeline():\n    factor1 = Factor1()\n    factor2 = Factor2()\n\n    # \u5169\u500b\u56e0\u5b50\u90fd\u8981\u901a\u904e\n    screen = (factor1 &gt; 0) &amp; (factor2.top(100))\n\n    return Pipeline(\n        columns={\n            'factor1': factor1,\n            'factor2': factor2\n        },\n        screen=screen\n    )\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#q9-screen-mask","title":"Q9: screen \u548c mask \u6709\u4ec0\u9ebc\u5dee\u5225\uff1f","text":"<p>mask\uff08\u5728\u56e0\u5b50\u8a08\u7b97\u6642\u4f7f\u7528\uff09\uff1a <pre><code># \u9650\u5236\u56e0\u5b50\u8a08\u7b97\u7684\u7bc4\u570d\nuniverse = AverageDollarVolume().top(500)\nmomentum = Momentum(mask=universe)\n\n# momentum \u53ea\u6703\u8a08\u7b97 universe \u5167\u7684 500 \u6a94\n# \u5176\u4ed6\u80a1\u7968\u76f4\u63a5\u8df3\u904e\uff08\u7bc0\u7701\u8a08\u7b97\uff09\n</code></pre></p> <p>screen\uff08\u5728 Pipeline \u8f38\u51fa\u6642\u4f7f\u7528\uff09\uff1a <pre><code># \u904e\u6ffe Pipeline \u8f38\u51fa\nscreen = (momentum &gt; 0)\n\npipe = Pipeline(\n    columns={'momentum': momentum},\n    screen=screen\n)\n\n# \u6240\u6709\u80a1\u7968\u90fd\u6703\u8a08\u7b97 momentum\n# \u4f46\u53ea\u8f38\u51fa momentum &gt; 0 \u7684\u80a1\u7968\n</code></pre></p> <p>\u4f55\u6642\u7528 mask\uff1f\u4f55\u6642\u7528 screen\uff1f <pre><code># \u7528 mask\uff1a\n# 1. \u6e1b\u5c11\u8a08\u7b97\u91cf\uff08\u80a1\u7968\u6c60\u5f88\u5927\uff09\n# 2. \u56e0\u5b50\u8a08\u7b97\u5f88\u6162\n\n# \u7528 screen\uff1a\n# 1. \u52d5\u614b\u7be9\u9078\uff08\u6839\u64da\u56e0\u5b50\u503c\uff09\n# 2. \u7d44\u5408\u591a\u500b\u689d\u4ef6\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#q10","title":"Q10: \u5982\u4f55\u5be6\u73fe\u7522\u696d\u4e2d\u6027\uff1f","text":"<p>\u65b9\u6cd5 1\uff1a\u5728 Pipeline \u4e2d\u5206\u7d44 <pre><code># \u9700\u8981\u81ea\u5b9a\u7fa9 Classifier\nfrom zipline.pipeline import Classifier\n\nclass IndustryClassifier(Classifier):\n    \"\"\"\u7522\u696d\u5206\u985e\"\"\"\n    def compute(self, today, assets, out):\n        # \u5f9e\u5916\u90e8\u8cc7\u6599\u8b80\u53d6\u7522\u696d\u5206\u985e\n        for i, asset in enumerate(assets):\n            out[i] = get_industry(asset.symbol)\n\ndef make_pipeline():\n    industry = IndustryClassifier()\n    momentum = Momentum()\n\n    # \u6bcf\u500b\u7522\u696d\u5167\u6392\u540d\n    industry_rank = momentum.rank(groupby=industry)\n\n    # \u9078\u6bcf\u500b\u7522\u696d\u524d 3 \u540d\n    screen = industry_rank.percentile_between(80, 100)\n</code></pre></p> <p>\u65b9\u6cd5 2\uff1a\u5728 before_trading_start \u4e2d\u8655\u7406 <pre><code>def before_trading_start(context, data):\n    output = pipeline_output('my_pipeline')\n\n    # \u624b\u52d5\u52a0\u5165\u7522\u696d\u5206\u985e\n    output['industry'] = [get_industry(s) for s in output.index]\n\n    # \u6bcf\u500b\u7522\u696d\u9078\u524d 3 \u540d\n    stocks = []\n    for industry in output['industry'].unique():\n        industry_stocks = output[output['industry'] == industry]\n        top3 = industry_stocks.nlargest(3, 'momentum')\n        stocks.extend(top3.index.tolist())\n\n    context.stocks = stocks\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#data-process","title":"\u6578\u64da\u8655\u7406","text":""},{"location":"blocks/pipeline/faq/#q11-tej","title":"Q11: \u5982\u4f55\u6574\u5408\u5916\u90e8\u6578\u64da\uff08\u5982 TEJ \u8ca1\u5831\uff09\uff1f","text":"<p>\u6311\u6230\uff1a</p> <p>Pipeline \u9810\u8a2d\u53ea\u80fd\u7528 <code>EquityPricing</code>\uff08OHLCV \u8cc7\u6599\uff09\uff0c\u8ca1\u5831\u8cc7\u6599\u600e\u9ebc\u6574\u5408\uff1f</p> <p>\u65b9\u6cd5 1\uff1a\u5728 compute \u5167\u8b80\u53d6\uff08\u7c21\u55ae\u4f46\u6162\uff09 <pre><code># \u5148\u8f09\u5165\u8ca1\u5831\u8cc7\u6599\u5230\u5168\u57df\u8b8a\u6578\nfundamental_data = load_fundamental_data()\n\nclass ROEFactor(CustomFactor):\n    window_length = 1\n\n    def compute(self, today, assets, out):\n        today_str = pd.Timestamp(today).strftime('%Y-%m-%d')\n\n        for i, asset in enumerate(assets):\n            symbol = asset.symbol\n\n            # \u5f9e\u5168\u57df\u8b8a\u6578\u8b80\u53d6\n            roe = fundamental_data.loc[\n                (fundamental_data['coid'] == symbol) &amp;\n                (fundamental_data['mdate'] == today_str),\n                'roe'\n            ].values\n\n            out[i] = roe[0] if len(roe) &gt; 0 else np.nan\n</code></pre></p> <p>\u65b9\u6cd5 2\uff1a\u81ea\u5b9a\u7fa9 DataSet\uff08\u9032\u968e\u4f46\u5feb\uff09 <pre><code>from zipline.pipeline.data import DataSet, Column\n\nclass Fundamentals(DataSet):\n    roe = Column(dtype=float)\n    pe_ratio = Column(dtype=float)\n    debt_ratio = Column(dtype=float)\n\n# \u9700\u8981\u5be6\u4f5c Loader\uff08\u8f03\u8907\u96dc\uff0c\u7565\uff09\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#q12-look-ahead-bias","title":"Q12: \u5982\u4f55\u8655\u7406\u6578\u64da\u5ef6\u9072\uff08look-ahead bias\uff09\uff1f","text":"<p>\u554f\u984c\uff1a</p> <p>\u8ca1\u5831\u901a\u5e38\u6709\u516c\u544a\u5ef6\u9072\uff08\u4f8b\u5982 Q1 \u8ca1\u5831\u5728 5 \u6708\u624d\u516c\u5e03\uff09\u3002</p> <p>\u89e3\u6c7a\u65b9\u6848\uff1a <pre><code>class SafeROE(CustomFactor):\n    \"\"\"\n    \u8003\u616e\u516c\u544a\u5ef6\u9072\u7684 ROE \u56e0\u5b50\n    \"\"\"\n    window_length = 1\n\n    def compute(self, today, assets, out):\n        # \u4f7f\u7528\u300c\u5df2\u516c\u544a\u300d\u7684\u6700\u65b0\u8ca1\u5831\n        # \u800c\u975e\u300c\u6703\u8a08\u671f\u9593\u300d\u7684\u6700\u65b0\u8ca1\u5831\n\n        for i, asset in enumerate(assets):\n            # \u627e\u51fa today \u4e4b\u524d\u300c\u5df2\u516c\u544a\u300d\u7684\u8ca1\u5831\n            announced_data = fundamental_data[\n                (fundamental_data['coid'] == asset.symbol) &amp;\n                (fundamental_data['announce_date'] &lt;= today)\n            ].sort_values('announce_date', ascending=False)\n\n            if len(announced_data) &gt; 0:\n                out[i] = announced_data.iloc[0]['roe']\n            else:\n                out[i] = np.nan\n</code></pre></p> <p>\u6700\u4f73\u5be6\u8e10\uff1a <pre><code># TEJ \u7684 include_self_acc='Y' \u53c3\u6578\n# \u6703\u5305\u542b\u81ea\u7d50\u6578\uff08\u63d0\u524d 30 \u5929\uff09\ndata = TejToolAPI.get_history_data(\n    ...,\n    include_self_acc='Y'\n)\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#optimize","title":"\u6548\u80fd\u512a\u5316","text":""},{"location":"blocks/pipeline/faq/#q13","title":"Q13: \u56de\u6e2c\u901f\u5ea6\u592a\u6162\u600e\u9ebc\u8fa6\uff1f","text":"<p>\u8a3a\u65b7\u6b65\u9a5f\uff1a <pre><code># Step 1: \u78ba\u8a8d\u74f6\u9838\nimport time\n\nstart = time.time()\noutput = pipeline_output('my_pipeline')\nprint(f\"Pipeline \u8017\u6642: {time.time() - start:.2f} \u79d2\")\n\nstart = time.time()\n# ... \u8abf\u5009\u908f\u8f2f ...\nprint(f\"\u8abf\u5009\u8017\u6642: {time.time() - start:.2f} \u79d2\")\n</code></pre></p> <p>\u512a\u5316\u6280\u5de7\uff1a</p> <p>\u6280\u5de7 1\uff1a\u6e1b\u5c11\u80a1\u7968\u6c60 <pre><code># \u274c \u6162\uff1a\u8a08\u7b97\u5168\u5e02\u5834 2000 \u6a94\nuniverse = StaticAssets(all_stocks)\n\n# \u2705 \u5feb\uff1a\u53ea\u8a08\u7b97\u6d41\u52d5\u6027\u9ad8\u7684 500 \u6a94\nuniverse = AverageDollarVolume().top(500)\n</code></pre></p> <p>\u6280\u5de7 2\uff1a\u6e1b\u5c11 window_length <pre><code># \u274c \u6162\uff1a\u7528 252 \u5929\nclass MyFactor(CustomFactor):\n    window_length = 252\n\n# \u2705 \u5feb\uff1a\u7e2e\u77ed\u5230 60 \u5929\nclass MyFactor(CustomFactor):\n    window_length = 60\n</code></pre></p> <p>\u6280\u5de7 3\uff1a\u4f7f\u7528 mask <pre><code># \u274c \u6162\uff1a\u8a08\u7b97\u6240\u6709\u80a1\u7968\nfactor = MyFactor()\n\n# \u2705 \u5feb\uff1a\u53ea\u8a08\u7b97 universe \u5167\u7684\nfactor = MyFactor(mask=universe)\n</code></pre></p> <p>\u6280\u5de7 4\uff1a\u6e1b\u5c11\u56e0\u5b50\u6578\u91cf <pre><code># \u274c \u6162\uff1a\u8a08\u7b97 10 \u500b\u56e0\u5b50\ncolumns = {f'factor{i}': Factor(i) for i in range(10)}\n\n# \u2705 \u5feb\uff1a\u53ea\u8a08\u7b97\u5fc5\u8981\u7684 3 \u500b\ncolumns = {'momentum': Momentum(), 'value': Value(), 'quality': Quality()}\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#q14","title":"Q14: \u8a18\u61b6\u9ad4\u4e0d\u8db3\u600e\u9ebc\u8fa6\uff1f","text":"<p>\u554f\u984c\u60c5\u5883\uff1a <pre><code># \u5168\u5e02\u5834 2000 \u6a94 \u00d7 252 \u5929 \u00d7 10 \u500b\u56e0\u5b50\n# \u9700\u8981\u5927\u91cf\u8a18\u61b6\u9ad4\n</code></pre></p> <p>\u89e3\u6c7a\u65b9\u6848\uff1a</p> <p>\u65b9\u6848 1\uff1a\u5206\u6279\u56de\u6e2c <pre><code># \u5c07\u56de\u6e2c\u671f\u9593\u5206\u6bb5\nperiods = [\n    ('2019-01-01', '2020-12-31'),\n    ('2021-01-01', '2022-12-31'),\n    ('2023-01-01', '2023-12-31')\n]\n\nall_results = []\nfor start, end in periods:\n    results = run_algorithm(\n        start=pd.Timestamp(start, tz='utc'),\n        end=pd.Timestamp(end, tz='utc'),\n        ...\n    )\n    all_results.append(results)\n\n# \u5408\u4f75\u7d50\u679c\ncombined = pd.concat(all_results)\n</code></pre></p> <p>\u65b9\u6848 2\uff1a\u6e1b\u5c11 window_length <pre><code># \u53ea\u4fdd\u7559\u5fc5\u8981\u7684\u6b77\u53f2\u8cc7\u6599\nwindow_length = 60  # \u800c\u975e 252\n</code></pre></p> <p>\u65b9\u6848 3\uff1a\u4f7f\u7528 SSD <pre><code># Zipline \u6703\u5c07\u8cc7\u6599\u5feb\u53d6\u5230\u786c\u789f\n# \u4f7f\u7528 SSD \u53ef\u4ee5\u52a0\u901f I/O\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#debug","title":"\u9664\u932f\u6280\u5de7","text":""},{"location":"blocks/pipeline/faq/#q15-debug-customfactor","title":"Q15: \u5982\u4f55 debug CustomFactor\uff1f","text":"<p>\u65b9\u6cd5 1\uff1aprint \u9664\u932f <pre><code>class DebugFactor(CustomFactor):\n    window_length = 20\n    inputs = [EquityPricing.close]\n\n    def compute(self, today, assets, out, close):\n        print(f\"Today: {today}\")\n        print(f\"Assets: {len(assets)}\")\n        print(f\"Close shape: {close.shape}\")\n        print(f\"Close sample:\\n{close[:5, :5]}\")\n\n        returns = (close[-1] - close[0]) / close[0]\n        print(f\"Returns sample: {returns[:5]}\")\n\n        out[:] = returns\n</code></pre></p> <p>\u65b9\u6cd5 2\uff1a\u55ae\u7368\u6e2c\u8a66 <pre><code># \u4e0d\u8dd1\u56de\u6e2c\uff0c\u53ea\u6e2c\u8a66 Pipeline\nfrom zipline.pipeline.engine import SimplePipelineEngine\nfrom zipline.pipeline.loaders import USEquityPricingLoader\n\n# \u5efa\u7acb\u6e2c\u8a66\u74b0\u5883\nengine = SimplePipelineEngine(...)\nresult = engine.run_pipeline(\n    make_pipeline(),\n    start_date=pd.Timestamp('2023-01-01'),\n    end_date=pd.Timestamp('2023-01-31')\n)\n\nprint(result)\n</code></pre></p> <p>\u65b9\u6cd5 3\uff1a\u8996\u89ba\u5316\u6aa2\u67e5 <pre><code># \u6aa2\u67e5\u56e0\u5b50\u503c\u5206\u4f48\nimport matplotlib.pyplot as plt\n\noutput = pipeline_output('my_pipeline')\noutput['momentum'].hist(bins=50)\nplt.title('Momentum Distribution')\nplt.show()\n\n# \u6aa2\u67e5\u662f\u5426\u6709\u7570\u5e38\u503c\nprint(output['momentum'].describe())\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#q16-pipeline","title":"Q16: Pipeline \u6c92\u6709\u8f38\u51fa\u4efb\u4f55\u80a1\u7968\uff1f","text":"<p>\u8a3a\u65b7\u6b65\u9a5f\uff1a <pre><code># Step 1: \u6aa2\u67e5 screen \u689d\u4ef6\ndef make_pipeline():\n    factor = MyFactor()\n\n    # \u66ab\u6642\u79fb\u9664 screen\n    return Pipeline(\n        columns={'factor': factor},\n        # screen=factor &gt; 0  # \u8a3b\u89e3\u6389\n    )\n\n# \u6aa2\u67e5\u6709\u591a\u5c11\u80a1\u7968\u901a\u904e\noutput = pipeline_output('my_pipeline')\nprint(f\"\u7e3d\u80a1\u7968\u6578: {len(output)}\")\nprint(f\"\u56e0\u5b50 &gt; 0 \u7684\u80a1\u7968\u6578: {(output['factor'] &gt; 0).sum()}\")\n</code></pre></p> <p>\u5e38\u898b\u539f\u56e0\uff1a</p> <p>\u539f\u56e0 1\uff1ascreen \u592a\u56b4\u683c <pre><code># \u274c \u592a\u56b4\u683c\nscreen = (factor1 &gt; 0.5) &amp; (factor2 &lt; 0.1) &amp; (factor3.top(10))\n\n# \u2705 \u653e\u5bec\u689d\u4ef6\nscreen = (factor1 &gt; 0) | (factor2 &lt; 0.5)\n</code></pre></p> <p>\u539f\u56e0 2\uff1amask \u592a\u5c0f <pre><code># \u274c mask \u53ea\u6709 10 \u6a94\nuniverse = AverageDollarVolume().top(10)\n\n# \u2705 \u64f4\u5927\u5230 100 \u6a94\nuniverse = AverageDollarVolume().top(100)\n</code></pre></p> <p>\u539f\u56e0 3\uff1a\u56e0\u5b50\u503c\u90fd\u662f NaN <pre><code># \u6aa2\u67e5\u56e0\u5b50\u8a08\u7b97\u908f\u8f2f\noutput = pipeline_output('my_pipeline')\nprint(output['factor'].isnull().sum())  # \u6709\u591a\u5c11 NaN\uff1f\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#practice","title":"\u5be6\u52d9\u61c9\u7528","text":""},{"location":"blocks/pipeline/faq/#q17-pipeline","title":"Q17: \u5982\u4f55\u628a Pipeline \u7b56\u7565\u90e8\u7f72\u5230\u5be6\u76e4\uff1f","text":"<p>\u6b65\u9a5f\uff1a</p> <p>Step 1\uff1a\u6bcf\u65e5\u6392\u7a0b <pre><code># daily_pipeline.py\nimport schedule\nimport time\nfrom datetime import datetime\n\ndef run_daily_pipeline():\n    \"\"\"\u6bcf\u65e5\u57f7\u884c Pipeline\"\"\"\n    today = datetime.now()\n\n    # \u57f7\u884c Pipeline\n    output = run_pipeline_for_today()\n\n    # \u7522\u751f\u6301\u5009\u6e05\u55ae\n    stocks = output.nlargest(20, 'momentum').index.tolist()\n\n    # \u5132\u5b58\u7d50\u679c\n    save_portfolio(stocks, today)\n\n    # \u767c\u9001\u901a\u77e5\n    send_notification(f\"\u4eca\u65e5\u9078\u80a1\u5b8c\u6210\uff1a{len(stocks)} \u6a94\")\n\n# \u6bcf\u5929\u4e0b\u5348 5 \u9ede\u57f7\u884c\nschedule.every().day.at(\"17:00\").do(run_daily_pipeline)\n\nwhile True:\n    schedule.run_pending()\n    time.sleep(60)\n</code></pre></p> <p>Step 2\uff1a\u4e0b\u55ae\u908f\u8f2f <pre><code>def execute_orders():\n    \"\"\"\u57f7\u884c\u8abf\u5009\"\"\"\n    # \u8b80\u53d6\u76ee\u6a19\u6301\u5009\n    target_portfolio = load_portfolio()\n\n    # \u53d6\u5f97\u7576\u524d\u6301\u5009\n    current_positions = broker_api.get_positions()\n\n    # \u8ce3\u51fa\u4e0d\u5728\u6e05\u55ae\u7684\n    for stock in current_positions:\n        if stock not in target_portfolio:\n            broker_api.sell(stock)\n\n    # \u8cb7\u5165\u65b0\u80a1\u7968\n    for stock in target_portfolio:\n        if stock not in current_positions:\n            broker_api.buy(stock, weight=1/len(target_portfolio))\n</code></pre></p> <p>Step 3\uff1a\u76e3\u63a7\u8207\u5bb9\u932f <pre><code>def run_with_safety():\n    try:\n        run_daily_pipeline()\n    except Exception as e:\n        # \u8a18\u9304\u932f\u8aa4\n        log_error(e)\n\n        # \u767c\u9001\u8b66\u5831\n        send_alert(f\"Pipeline \u57f7\u884c\u5931\u6557\uff1a{e}\")\n\n        # \u4f7f\u7528\u5099\u7528\u65b9\u6848\n        use_fallback_strategy()\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#q18","title":"Q18: \u5982\u4f55\u8a55\u4f30\u56e0\u5b50\u6709\u6548\u6027\uff1f","text":"<p>\u65b9\u6cd5 1\uff1aIC\uff08Information Coefficient\uff09 <pre><code># \u8a08\u7b97\u56e0\u5b50\u503c\u8207\u672a\u4f86\u5831\u916c\u7684\u76f8\u95dc\u6027\ndef calculate_ic(factor_values, forward_returns):\n    \"\"\"\n    IC = \u56e0\u5b50\u503c\u8207\u672a\u4f86\u5831\u916c\u7684\u76f8\u95dc\u4fc2\u6578\n\n    IC &gt; 0.05: \u6709\u6548\u56e0\u5b50\n    IC &gt; 0.10: \u975e\u5e38\u6709\u6548\n    \"\"\"\n    from scipy.stats import spearmanr\n\n    ic, p_value = spearmanr(factor_values, forward_returns)\n    return ic\n\n# \u7bc4\u4f8b\noutput = pipeline_output('my_pipeline')\n\n# \u8a08\u7b97\u672a\u4f86 20 \u65e5\u5831\u916c\nforward_returns = calculate_forward_returns(output.index, days=20)\n\n# \u8a08\u7b97 IC\nic = calculate_ic(output['momentum'], forward_returns)\nprint(f\"\u56e0\u5b50 IC: {ic:.4f}\")\n</code></pre></p> <p>\u65b9\u6cd5 2\uff1a\u591a\u7a7a\u7d44\u5408\u6e2c\u8a66 <pre><code># \u505a\u591a\u524d 20%\uff0c\u505a\u7a7a\u5f8c 20%\ndef backtest_long_short(factor_name):\n    def before_trading_start(context, data):\n        output = pipeline_output('my_pipeline')\n\n        # \u524d 20%\n        long_stocks = output.nlargest(\n            int(len(output) * 0.2),\n            factor_name\n        ).index.tolist()\n\n        # \u5f8c 20%\n        short_stocks = output.nsmallest(\n            int(len(output) * 0.2),\n            factor_name\n        ).index.tolist()\n\n        context.long_stocks = long_stocks\n        context.short_stocks = short_stocks\n\n    def rebalance(context, data):\n        # \u505a\u591a\n        for stock in context.long_stocks:\n            order_target_percent(stock, 0.5 / len(context.long_stocks))\n\n        # \u505a\u7a7a\uff08\u5982\u679c\u5141\u8a31\uff09\n        for stock in context.short_stocks:\n            order_target_percent(stock, -0.5 / len(context.short_stocks))\n</code></pre></p> <p>\u65b9\u6cd5 3\uff1a\u5206\u5c64\u6e2c\u8a66 <pre><code># \u5c07\u56e0\u5b50\u503c\u5206\u6210 5 \u5c64\uff0c\u6bd4\u8f03\u5831\u916c\ndef quintile_analysis(output, forward_returns):\n    # \u5206\u6210 5 \u5c64\n    output['quintile'] = pd.qcut(output['momentum'], 5, labels=[1,2,3,4,5])\n\n    # \u6bcf\u5c64\u7684\u5e73\u5747\u5831\u916c\n    for q in range(1, 6):\n        mask = output['quintile'] == q\n        avg_return = forward_returns[mask].mean()\n        print(f\"\u7b2c {q} \u5c64\u5e73\u5747\u5831\u916c: {avg_return:.2%}\")\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#q19-pipeline","title":"Q19: \u5982\u4f55\u7d44\u5408\u591a\u500b Pipeline \u7b56\u7565\uff1f","text":"<p>\u65b9\u6cd5 1\uff1a\u96c6\u6210\u591a\u500b Pipeline <pre><code>def initialize(context):\n    # \u8a3b\u518a\u591a\u500b Pipeline\n    attach_pipeline(make_momentum_pipeline(), 'momentum')\n    attach_pipeline(make_value_pipeline(), 'value')\n    attach_pipeline(make_quality_pipeline(), 'quality')\n\ndef before_trading_start(context, data):\n    # \u53d6\u5f97\u6240\u6709\u7d50\u679c\n    momentum_stocks = pipeline_output('momentum').index.tolist()\n    value_stocks = pipeline_output('value').index.tolist()\n    quality_stocks = pipeline_output('quality').index.tolist()\n\n    # \u53d6\u4ea4\u96c6\n    context.stocks = list(\n        set(momentum_stocks) &amp; \n        set(value_stocks) &amp; \n        set(quality_stocks)\n    )\n</code></pre></p> <p>\u65b9\u6cd5 2\uff1a\u52a0\u6b0a\u7d44\u5408 <pre><code>def before_trading_start(context, data):\n    momentum_output = pipeline_output('momentum')\n    value_output = pipeline_output('value')\n\n    # \u6a19\u6e96\u5316\n    momentum_rank = momentum_output['momentum'].rank() / len(momentum_output)\n    value_rank = value_output['value'].rank() / len(value_output)\n\n    # \u52a0\u6b0a\u7d44\u5408\n    combined = pd.DataFrame({\n        'score': 0.6 * momentum_rank + 0.4 * value_rank\n    })\n\n    # \u9078\u524d 20 \u540d\n    context.stocks = combined.nlargest(20, 'score').index.tolist()\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#q20","title":"Q20: \u5982\u4f55\u907f\u514d\u904e\u5ea6\u64ec\u5408\uff1f","text":"<p>\u6aa2\u9a57\u65b9\u6cd5\uff1a</p> <p>\u65b9\u6cd5 1\uff1a\u6a23\u672c\u5916\u6e2c\u8a66 <pre><code># \u8a13\u7df4\u671f\uff1a2015-2020\ntrain_results = run_algorithm(\n    start=pd.Timestamp('2015-01-01', tz='utc'),\n    end=pd.Timestamp('2020-12-31', tz='utc'),\n    ...\n)\n\n# \u6e2c\u8a66\u671f\uff1a2021-2023\ntest_results = run_algorithm(\n    start=pd.Timestamp('2021-01-01', tz='utc'),\n    end=pd.Timestamp('2023-12-31', tz='utc'),\n    ...\n)\n\n# \u6bd4\u8f03\u590f\u666e\u6bd4\u7387\nprint(f\"\u8a13\u7df4\u671f Sharpe: {train_results['sharpe'].iloc[-1]:.2f}\")\nprint(f\"\u6e2c\u8a66\u671f Sharpe: {test_results['sharpe'].iloc[-1]:.2f}\")\n\n# \u5982\u679c\u6e2c\u8a66\u671f\u660e\u986f\u8b8a\u5dee \u2192 \u904e\u64ec\u5408\n</code></pre></p> <p>\u65b9\u6cd5 2\uff1a\u4ea4\u53c9\u9a57\u8b49 <pre><code># K-fold \u4ea4\u53c9\u9a57\u8b49\nfrom sklearn.model_selection import TimeSeriesSplit\n\ntscv = TimeSeriesSplit(n_splits=5)\n\nsharpes = []\nfor train_idx, test_idx in tscv.split(date_range):\n    train_start, train_end = date_range[train_idx[0]], date_range[train_idx[-1]]\n    test_start, test_end = date_range[test_idx[0]], date_range[test_idx[-1]]\n\n    results = backtest(train_start, train_end, test_start, test_end)\n    sharpes.append(results['sharpe'])\n\nprint(f\"\u5e73\u5747 Sharpe: {np.mean(sharpes):.2f}\")\nprint(f\"\u6a19\u6e96\u5dee: {np.std(sharpes):.2f}\")\n</code></pre></p> <p>\u65b9\u6cd5 3\uff1a\u53c3\u6578\u7a69\u5b9a\u6027\u6e2c\u8a66 <pre><code># \u6e2c\u8a66\u53c3\u6578\u8b8a\u5316\u7684\u5f71\u97ff\nresults = {}\n\nfor window in [200, 220, 240, 252, 280, 300]:\n    sharpe = backtest_with_window(window)\n    results[window] = sharpe\n\n# \u5982\u679c\u5c0f\u5e45\u8abf\u6574\u53c3\u6578\u5c31\u5927\u5e45\u5f71\u97ff\u7e3e\u6548 \u2192 \u904e\u64ec\u5408\nprint(results)\n</code></pre></p>"},{"location":"blocks/pipeline/faq/#_2","title":"\ud83d\udca1 \u6700\u4f73\u5be6\u8e10\u7e3d\u7d50","text":""},{"location":"blocks/pipeline/faq/#do","title":"\u2705 DO\uff08\u5efa\u8b70\u505a\uff09","text":"<ol> <li>\u4f7f\u7528 mask \u6e1b\u5c11\u8a08\u7b97\u91cf\uff1a<code>MyFactor(mask=universe)</code></li> <li>\u512a\u5148\u4f7f\u7528\u5411\u91cf\u5316\uff1a<code>np.mean(close, axis=0)</code> \u800c\u975e\u8ff4\u5708</li> <li>\u8655\u7406 NaN\uff1a\u4f7f\u7528 <code>np.nanmean</code>, <code>np.nanstd</code></li> <li>\u6a23\u672c\u5916\u6e2c\u8a66\uff1a\u8a13\u7df4\u671f + \u6e2c\u8a66\u671f\u5206\u96e2</li> <li>\u8996\u89ba\u5316\u6aa2\u67e5\uff1a\u7e6a\u88fd\u56e0\u5b50\u5206\u4f48\u3001\u76f8\u95dc\u6027\u77e9\u9663</li> <li>\u8a18\u9304\u95dc\u9375\u6307\u6a19\uff1a\u7528 <code>record()</code> \u8a18\u9304\u6301\u5009\u6578\u3001\u69d3\u687f</li> <li>\u5148\u5c0f\u7bc4\u570d\u6e2c\u8a66\uff1a100 \u6a94 \u2192 500 \u6a94 \u2192 2000 \u6a94</li> <li>\u4f7f\u7528 Pyfolio \u5206\u6790\uff1a\u5b8c\u6574\u7e3e\u6548\u5831\u544a</li> </ol>"},{"location":"blocks/pipeline/faq/#dont","title":"\u274c DON'T\uff08\u907f\u514d\u505a\uff09","text":"<ol> <li>\u4e0d\u8981\u5728 compute \u5167\u7528\u8ff4\u5708\uff1a\u6548\u80fd\u5dee 100 \u500d</li> <li>\u4e0d\u8981\u5ffd\u7565 axis \u53c3\u6578\uff1a<code>np.mean(close)</code> \u662f\u932f\u7684</li> <li>\u4e0d\u8981\u904e\u5ea6\u512a\u5316\u53c3\u6578\uff1a\u8abf\u5230\u5c0f\u6578\u9ede\u7b2c\u4e09\u4f4d</li> <li>\u4e0d\u8981\u5ffd\u7565\u4ea4\u6613\u6210\u672c\uff1a\u5047\u8a2d\u96f6\u6210\u672c</li> <li>\u4e0d\u8981\u53ea\u770b\u5831\u916c\u7387\uff1a\u5ffd\u7565\u98a8\u96aa\u3001\u56de\u64a4\u3001\u9031\u8f49\u7387</li> <li>\u4e0d\u8981\u8df3\u904e mask\uff1a\u6d6a\u8cbb\u8a08\u7b97\u8cc7\u6e90</li> <li>\u4e0d\u8981\u5fd8\u8a18 look-ahead bias\uff1a\u6ce8\u610f\u6578\u64da\u5ef6\u9072</li> <li>\u4e0d\u8981\u5ffd\u7565 NaN\uff1a\u6703\u5c0e\u81f4\u56e0\u5b50\u503c\u932f\u8aa4</li> </ol>"},{"location":"blocks/pipeline/faq/#_3","title":"\ud83d\udd17 \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md</li> <li>Code \u6a21\u677f\uff1atemplate.md</li> <li>\u6848\u4f8b\u5b78\u7fd2\uff1a</li> <li>Expanded Momentum</li> <li>\u8ddf\u96a8\u5927\u6236</li> <li>CounterTrend</li> </ul> <p>\u9084\u6709\u554f\u984c\uff1f</p> <p>\u5982\u679c\u9019\u88e1\u6c92\u6709\u6db5\u84cb\u4f60\u7684\u554f\u984c\uff0c\u8acb\uff1a</p> <ol> <li>\u6aa2\u67e5 template.md \u7684\u8a3b\u89e3</li> <li>\u53c3\u8003\u4e09\u500b case study \u7684\u5be6\u4f5c</li> <li>\u56de\u5230 overview.md \u78ba\u8a8d\u662f\u5426\u9078\u5c0d\u67b6\u69cb</li> </ol> <p>\ud83d\udc49 \u6e96\u5099\u597d\u4e86\uff1f \u524d\u5f80 template.md \u958b\u59cb\u958b\u767c\u4f60\u7684 Pipeline \u7b56\u7565\uff01</p>"},{"location":"blocks/pipeline/template/","title":"Pipeline \u56e0\u5b50\u67b6\u69cb - Code \u6a21\u677f","text":"<p>\u672c\u9801\u63d0\u4f9b\u53ef\u76f4\u63a5\u4f7f\u7528\u7684 Code Template\uff0c\u4e26\u6a19\u8a3b\u9700\u8981\u81ea\u5b9a\u7fa9\u7684\u90e8\u5206\u3002</p>"},{"location":"blocks/pipeline/template/#_1","title":"\ud83d\udccb \u6a21\u677f\u7e3d\u89bd","text":"<p>\u6211\u5011\u5c07\u56e0\u5b50\u6316\u6398\u6d41\u7a0b\u62c6\u89e3\u70ba\u4e94\u500b\u6a21\u584a\uff0c\u8acb\u4f9d\u7167\u4f60\u7684\u9700\u6c42\u7d44\u88dd\uff1a</p> \u6a21\u584a (Module) \u6838\u5fc3\u529f\u80fd \u4f60\u7684\u4efb\u52d9 (Action) M1. \u57fa\u790e\u5efa\u8a2d <code>\u74b0\u5883\u8a2d\u5b9a</code> <code>\u80a1\u7968\u6c60</code> \ud83d\udfe2 \u8a2d\u5b9a\u53c3\u6578 (\u56de\u6e2c\u5340\u9593\u3001\u6578\u64da Bundle) M2. \u56e0\u5b50\u5b9a\u7fa9 <code>CustomFactor</code> <code>\u904b\u7b97\u908f\u8f2f</code> \ud83d\udd25 \u5b9a\u7fa9 Alpha (\u64b0\u5beb\u6578\u5b78\u516c\u5f0f\u3001\u8cc7\u6599\u6e05\u6d17) M3. \u8a0a\u865f\u7d44\u88dd <code>Pipeline</code> <code>Filter</code> \ud83d\udd25 \u5408\u6210\u56e0\u5b50 (\u591a\u56e0\u5b50\u7d50\u5408\u3001\u7be9\u9078\u3001\u6392\u540d) M4. \u8abf\u5009\u908f\u8f2f <code>Schedule</code> <code>Rebalance</code> \ud83d\udd35 \u9078\u64c7\u983b\u7387 (\u6708\u63db/\u5b63\u63db\u3001\u6b0a\u91cd\u5206\u914d) M5. \u57f7\u884c\u5f15\u64ce <code>run_algorithm</code> <code>\u7e3e\u6548\u56de\u6e2c</code> \ud83d\udd12 \u76f4\u63a5\u57f7\u884c (\u5206\u6790 IC \u503c\u3001\u5831\u916c\u7387)"},{"location":"blocks/pipeline/template/#_2","title":"\ud83c\udfaf \u5b8c\u6574\u6a21\u677f","text":""},{"location":"blocks/pipeline/template/#module-1","title":"Module 1: \u74b0\u5883\u8a2d\u5b9a &amp; \u80a1\u7968\u6c60","text":"<pre><code># ====================================\n# Module 1: \u74b0\u5883\u8a2d\u5b9a &amp; \u80a1\u7968\u6c60\n# ====================================\n\nimport os\nimport pandas as pd\nimport numpy as np\nimport tejapi\nimport matplotlib.pyplot as plt\nfrom logbook import Logger\n\n# TEJ API \u8a2d\u5b9a\nos.environ['TEJAPI_BASE'] = 'https://api.tej.com.tw'\nos.environ['TEJAPI_KEY'] = 'your_key'\ntejapi.ApiConfig.api_key = os.getenv('TEJAPI_KEY')\ntejapi.ApiConfig.api_base = os.getenv('TEJAPI_BASE')\n\n# \u65e5\u8a8c\u8a2d\u5b9a\nlog = Logger('Strategy')\n\n# \u4e2d\u6587\u986f\u793a\u8a2d\u5b9a\nplt.rcParams['font.sans-serif'] = ['Microsoft JhengHei']\nplt.rcParams['axes.unicode_minus'] = False\n\n# ====================================\n# \u53c3\u6578\u8a2d\u5b9a\n# ====================================\n# \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u56de\u6e2c\u671f\u9593\nstart_date = '2019-01-01'\nend_date = '2023-12-31'\n\n# \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u80a1\u7968\u6c60\n# \u65b9\u6cd5 1: \u53f0\u7063 50 \u6210\u5206\u80a1\ntw50_list = get_universe(start_date,end_date, idx_id='IX0002')\nprint(f\"\u53f0\u7063 50 \u6210\u5206\u80a1\u6578\u91cf: {len(tw50_list)}\")\n\n# \u65b9\u6cd5 2: \u4e0a\u5e02 + \u4e0a\u6ac3\nfrom zipline.sources.TEJ_Api_Data import get_universe\npool = get_universe(\n    start=pd.Timestamp(start_date, tz='utc'),\n    end=pd.Timestamp(end_date, tz='utc'),\n    mkt_bd_e=['TSE', 'OTC'],\n    stktp_e='Common Stock'\n)\n\n# \u8a2d\u5b9a\u74b0\u5883\u8b8a\u6578\nos.environ['mdate'] = f'{start_date} {end_date}'\nos.environ['ticker'] = ' '.join(pool)  # \u6216 tw50_list\n\n# ====================================\n# \u532f\u5165\u80a1\u50f9\u8cc7\u6599\n# ====================================\nfrom zipline.data.run_ingest import simple_ingest\n\npools = pool + ['IR0001']  # \u52a0\u5165\u57fa\u6e96\u6307\u6578\n\nprint(\"\u6b63\u5728\u6e96\u5099 Zipline \u8cc7\u6599...\")\nsimple_ingest(\n    name='tquant',\n    tickers=pools,\n    start_date=start_date.replace('-', ''),\n    end_date=end_date.replace('-', '')\n)\nprint(\"\u8cc7\u6599\u6e96\u5099\u5b8c\u6210\uff01\")\n</code></pre>"},{"location":"blocks/pipeline/template/#module-2-customfactor","title":"Module 2: CustomFactor \u5b9a\u7fa9 \ud83d\udd25","text":"<p>\u9019\u662f \u6700\u6838\u5fc3 \u7684\u6a21\u584a\uff0c\u5b9a\u7fa9\u4f60\u7684\u56e0\u5b50\u8a08\u7b97\u908f\u8f2f\u3002</p>"},{"location":"blocks/pipeline/template/#a","title":"\ud83d\udccc \u6a21\u677f A\uff1a\u55ae\u4e00\u8cc7\u6599\u6e90\u56e0\u5b50","text":"<pre><code># ====================================\n# Module 2A: \u55ae\u4e00\u8cc7\u6599\u6e90\u56e0\u5b50\n# ====================================\n\nfrom zipline.pipeline import CustomFactor\nfrom zipline.pipeline.data import EquityPricing\nimport numpy as np\n\nclass Momentum(CustomFactor):\n    \"\"\"\n    \u52d5\u91cf\u56e0\u5b50\uff1a\u904e\u53bb N \u5929\u5831\u916c\u7387\n\n    \u516c\u5f0f\uff1a(\u6700\u65b0\u50f9 - \u8d77\u59cb\u50f9) / \u8d77\u59cb\u50f9\n    \"\"\"\n    # \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u9700\u8981\u591a\u5c11\u5929\u7684\u8cc7\u6599\n    window_length = 252  # \u5e74\u5316\u5831\u916c\uff08252 \u500b\u4ea4\u6613\u65e5\uff09\n\n    # \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u9700\u8981\u54ea\u4e9b\u6b04\u4f4d\n    inputs = [EquityPricing.close]\n\n    def compute(self, today, assets, out, close):\n        \"\"\"\n        \u8a08\u7b97\u908f\u8f2f\n\n        Parameters:\n        -----------\n        today : pd.Timestamp\n            \u7576\u524d\u65e5\u671f\n        assets : np.array\n            \u80a1\u7968\u4ee3\u78bc\u9663\u5217\n        out : np.array\n            \u8f38\u51fa\u9663\u5217\uff08\u8981\u586b\u5165\u8a08\u7b97\u7d50\u679c\uff09\n        close : np.array\n            \u6536\u76e4\u50f9\u77e9\u9663\uff08window_length \u00d7 \u80a1\u7968\u6578\uff09\n        \"\"\"\n        # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u66ff\u63db\u6210\u4f60\u7684\u8a08\u7b97\u908f\u8f2f\n\n        # \u8a08\u7b97\u5831\u916c\u7387\n        returns = (close[-1] - close[0]) / close[0]\n\n        # \u586b\u5165\u8f38\u51fa\u9663\u5217\n        out[:] = returns\n\n\nclass Volatility(CustomFactor):\n    \"\"\"\n    \u6ce2\u52d5\u7387\u56e0\u5b50\uff1a\u904e\u53bb N \u5929\u5831\u916c\u7387\u7684\u6a19\u6e96\u5dee\n    \"\"\"\n    window_length = 252\n    inputs = [EquityPricing.close]\n\n    def compute(self, today, assets, out, close):\n        # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\n\n        # \u8a08\u7b97\u65e5\u5831\u916c\u7387\n        daily_returns = np.diff(close, axis=0) / close[:-1]\n\n        # \u8a08\u7b97\u6a19\u6e96\u5dee\uff08\u5e74\u5316\uff09\n        volatility = np.nanstd(daily_returns, axis=0) * np.sqrt(252)\n\n        out[:] = volatility\n\n\nclass AverageDollarVolume(CustomFactor):\n    \"\"\"\n    \u5e73\u5747\u6210\u4ea4\u91d1\u984d\uff1a\u904e\u53bb N \u5929\u5e73\u5747\u6210\u4ea4\u91d1\u984d\n    \"\"\"\n    window_length = 30\n    inputs = [EquityPricing.close, EquityPricing.volume]\n\n    def compute(self, today, assets, out, close, volume):\n        # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\n\n        # \u6210\u4ea4\u91d1\u984d = \u6536\u76e4\u50f9 \u00d7 \u6210\u4ea4\u91cf\n        dollar_volume = close * volume\n\n        # \u8a08\u7b97\u5e73\u5747\n        avg_dollar_volume = np.nanmean(dollar_volume, axis=0)\n\n        out[:] = avg_dollar_volume\n</code></pre>"},{"location":"blocks/pipeline/template/#b","title":"\ud83d\udccc \u6a21\u677f B\uff1a\u591a\u8cc7\u6599\u6e90\u56e0\u5b50","text":"<pre><code># ====================================\n# Module 2B: \u591a\u8cc7\u6599\u6e90\u56e0\u5b50\n# ====================================\n\nclass PriceToVolume(CustomFactor):\n    \"\"\"\n    \u50f9\u91cf\u6bd4\uff1a\u6536\u76e4\u50f9 / \u6210\u4ea4\u91cf\n    \"\"\"\n    window_length = 1  # \u53ea\u9700\u8981\u6700\u65b0\u4e00\u5929\n    inputs = [EquityPricing.close, EquityPricing.volume]\n\n    def compute(self, today, assets, out, close, volume):\n        # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\n\n        # \u53d6\u6700\u65b0\u503c\n        latest_close = close[-1]\n        latest_volume = volume[-1]\n\n        # \u8a08\u7b97\u6bd4\u503c\uff08\u907f\u514d\u9664\u4ee5\u96f6\uff09\n        ratio = latest_close / (latest_volume + 1e-10)\n\n        out[:] = ratio\n\n\nclass RSI(CustomFactor):\n    \"\"\"\n    RSI \u6307\u6a19\uff1a\u76f8\u5c0d\u5f37\u5f31\u6307\u6578\n    \"\"\"\n    window_length = 15  # 14 \u5929 RSI \u9700\u8981 15 \u5929\u8cc7\u6599\n    inputs = [EquityPricing.close]\n\n    def compute(self, today, assets, out, close):\n        # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\n\n        # \u8a08\u7b97\u50f9\u683c\u8b8a\u5316\n        delta = np.diff(close, axis=0)\n\n        # \u5206\u96e2\u6f32\u8dcc\n        gains = np.where(delta &gt; 0, delta, 0)\n        losses = np.where(delta &lt; 0, -delta, 0)\n\n        # \u8a08\u7b97\u5e73\u5747\u6f32\u8dcc\u5e45\n        avg_gain = np.nanmean(gains, axis=0)\n        avg_loss = np.nanmean(losses, axis=0)\n\n        # \u8a08\u7b97 RS \u548c RSI\n        rs = avg_gain / (avg_loss + 1e-10)\n        rsi = 100 - (100 / (1 + rs))\n\n        out[:] = rsi\n</code></pre>"},{"location":"blocks/pipeline/template/#c","title":"\ud83d\udccc \u6a21\u677f C\uff1a\u6392\u540d\u56e0\u5b50","text":"<pre><code># ====================================\n# Module 2C: \u6392\u540d\u56e0\u5b50\n# ====================================\n\nclass MomentumRank(CustomFactor):\n    \"\"\"\n    \u52d5\u91cf\u6392\u540d\uff1a\u5c07\u52d5\u91cf\u8f49\u63db\u70ba\u6392\u540d\uff080-1\uff09\n    \"\"\"\n    window_length = 252\n    inputs = [EquityPricing.close]\n\n    def compute(self, today, assets, out, close):\n        # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\n\n        # \u8a08\u7b97\u5831\u916c\u7387\n        returns = (close[-1] - close[0]) / close[0]\n\n        # \u8f49\u63db\u70ba\u6392\u540d\uff080-1 \u4e4b\u9593\uff09\n        # \u6700\u9ad8\u5831\u916c = 1\uff0c\u6700\u4f4e\u5831\u916c = 0\n        from scipy.stats import rankdata\n        ranks = rankdata(returns) / len(returns)\n\n        out[:] = ranks\n</code></pre>"},{"location":"blocks/pipeline/template/#d","title":"\ud83d\udccc \u6a21\u677f D\uff1a\u7d44\u5408\u56e0\u5b50","text":"<pre><code># ====================================\n# Module 2D: \u7d44\u5408\u56e0\u5b50\n# ====================================\n\nclass QualityScore(CustomFactor):\n    \"\"\"\n    \u54c1\u8cea\u5206\u6578\uff1aROE + \u6bdb\u5229\u7387\u7684\u7d44\u5408\n\n    \u9700\u8981\u5916\u90e8\u6578\u64da\uff08TEJ\uff09\n    \"\"\"\n    window_length = 1\n\n    def compute(self, today, assets, out, roe, gross_margin):\n        # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\n\n        # \u6a19\u6e96\u5316 ROE\uff080-1\uff09\n        roe_normalized = (roe[-1] - np.nanmin(roe[-1])) / (np.nanmax(roe[-1]) - np.nanmin(roe[-1]) + 1e-10)\n\n        # \u6a19\u6e96\u5316\u6bdb\u5229\u7387\uff080-1\uff09\n        gm_normalized = (gross_margin[-1] - np.nanmin(gross_margin[-1])) / (np.nanmax(gross_margin[-1]) - np.nanmin(gross_margin[-1]) + 1e-10)\n\n        # \u52a0\u6b0a\u7d44\u5408\uff08\u53ef\u8abf\u6574\u6b0a\u91cd\uff09\n        quality_score = 0.6 * roe_normalized + 0.4 * gm_normalized\n\n        out[:] = quality_score\n</code></pre>"},{"location":"blocks/pipeline/template/#module-3-pipeline","title":"Module 3: Pipeline \u7d44\u5408 \ud83d\udd25","text":"<pre><code># ====================================\n# Module 3: Pipeline \u7d44\u5408\n# ====================================\n\nfrom zipline.pipeline import Pipeline\nfrom zipline.pipeline.filters import StaticAssets\n\ndef make_pipeline():\n    \"\"\"\n    \u5efa\u7acb Pipeline\n\n    \u6d41\u7a0b\uff1a\n    1. \u5b9a\u7fa9\u56e0\u5b50\n    2. \u5b9a\u7fa9\u7be9\u9078\u5668\uff08screen\uff09\n    3. \u7d44\u5408 Pipeline\n    \"\"\"\n    # ========================================\n    # Step 1: \u5b9a\u7fa9\u56e0\u5b50\n    # ========================================\n    # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u9078\u64c7\u4f60\u8981\u4f7f\u7528\u7684\u56e0\u5b50\n\n    momentum = Momentum()\n    volatility = Volatility()\n    dollar_volume = AverageDollarVolume()\n\n    # ========================================\n    # Step 2: \u5b9a\u7fa9\u7be9\u9078\u5668\n    # ========================================\n    # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u8a2d\u5b9a\u7be9\u9078\u689d\u4ef6\n\n    # \u7be9\u9078 1: \u6210\u4ea4\u91d1\u984d\u524d N \u540d\uff08\u6d41\u52d5\u6027\u904e\u6ffe\uff09\n    tradable = dollar_volume.top(100)\n\n    # \u7be9\u9078 2: \u52d5\u91cf &gt; 0\uff08\u6b63\u5831\u916c\uff09\n    positive_momentum = momentum &gt; 0\n\n    # \u7be9\u9078 3: \u6ce2\u52d5\u7387 &lt; 0.5\uff08\u4e0d\u8981\u592a\u6ce2\u52d5\uff09\n    low_volatility = volatility &lt; 0.5\n\n    # \u7d44\u5408\u7be9\u9078\u5668\uff08AND\uff09\n    screen = tradable &amp; positive_momentum &amp; low_volatility\n\n    # \u6216\u4f7f\u7528\u7279\u5b9a\u80a1\u7968\u6c60\n    # universe = StaticAssets(symbols(['2330', '2317', '2454']))\n    # screen = universe\n\n    # ========================================\n    # Step 3: \u7d44\u5408 Pipeline\n    # ========================================\n    pipe = Pipeline(\n        columns={\n            'momentum': momentum,\n            'volatility': volatility,\n            'dollar_volume': dollar_volume\n        },\n        screen=screen\n    )\n\n    return pipe\n</code></pre>"},{"location":"blocks/pipeline/template/#module-4","title":"Module 4: \u8abf\u5009\u908f\u8f2f","text":"<pre><code># ====================================\n# Module 4: \u8abf\u5009\u908f\u8f2f\n# ====================================\n\nfrom zipline.api import (\n    attach_pipeline, pipeline_output,\n    order_target_percent, set_commission, set_slippage,\n    record, schedule_function, date_rules, time_rules\n)\nfrom zipline.finance import commission, slippage\n\ndef initialize(context):\n    \"\"\"\n    \u521d\u59cb\u5316\u51fd\u6578\n    \"\"\"\n    # \u4ea4\u6613\u6210\u672c\u8a2d\u5b9a\n    set_commission(commission.PerShare(cost=0.001425, min_trade_cost=20))\n    set_slippage(slippage.VolumeShareSlippage(volume_limit=0.025, price_impact=0.1))\n\n    # \u9644\u52a0 Pipeline\n    attach_pipeline(make_pipeline(), 'my_pipeline')\n\n    # \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u8abf\u5009\u983b\u7387\n    # \u6bcf\u9031\u4e00\u958b\u76e4\u5f8c\u8abf\u5009\n    schedule_function(\n        rebalance,\n        date_rules.week_start(),\n        time_rules.market_open()\n    )\n\n    # \u6216\u6bcf\u6708\u7b2c\u4e00\u500b\u4ea4\u6613\u65e5\n    # schedule_function(\n    #     rebalance,\n    #     date_rules.month_start(),\n    #     time_rules.market_open()\n    # )\n\n    # \u6216\u6bcf\u65e5\n    # schedule_function(\n    #     rebalance,\n    #     date_rules.every_day(),\n    #     time_rules.market_open()\n    # )\n\n\ndef before_trading_start(context, data):\n    \"\"\"\n    \u76e4\u524d\u57f7\u884c\uff1a\u53d6\u5f97 Pipeline \u8f38\u51fa\n    \"\"\"\n    # \u53d6\u5f97 Pipeline \u7d50\u679c\n    output = pipeline_output('my_pipeline')\n\n    # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u9078\u80a1\u908f\u8f2f\n\n    # \u65b9\u6cd5 1: \u53d6\u524d N \u540d\n    context.stocks = output.nlargest(20, 'momentum').index.tolist()\n\n    # \u65b9\u6cd5 2: \u7d9c\u5408\u6392\u540d\n    # output['rank'] = output['momentum'].rank() + output['volatility'].rank(ascending=False)\n    # context.stocks = output.nlargest(20, 'rank').index.tolist()\n\n    # \u65b9\u6cd5 3: \u5206\u7d44\n    # high_momentum = output[output['momentum'] &gt; output['momentum'].median()]\n    # context.stocks = high_momentum.index.tolist()\n\n    # \u5132\u5b58\u5b8c\u6574 output\uff08\u7528\u65bc\u8a08\u7b97\u6b0a\u91cd\uff09\n    context.output = output\n\n\ndef rebalance(context, data):\n    \"\"\"\n    \u8abf\u5009\u51fd\u6578\n    \"\"\"\n    # ========================================\n    # Step 1: \u8a08\u7b97\u76ee\u6a19\u6b0a\u91cd\n    # ========================================\n    # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u6b0a\u91cd\u8a08\u7b97\u65b9\u6cd5\n\n    # \u65b9\u6cd5 1: \u7b49\u6b0a\u91cd\n    target_weights = {}\n    for stock in context.stocks:\n        target_weights[stock] = 1.0 / len(context.stocks)\n\n    # \u65b9\u6cd5 2: \u56e0\u5b50\u52a0\u6b0a\uff08\u52d5\u91cf\u8d8a\u9ad8\uff0c\u6b0a\u91cd\u8d8a\u5927\uff09\n    # momentum_values = context.output.loc[context.stocks, 'momentum']\n    # total_momentum = momentum_values.sum()\n    # target_weights = {}\n    # for stock in context.stocks:\n    #     target_weights[stock] = momentum_values[stock] / total_momentum\n\n    # \u65b9\u6cd5 3: \u53cd\u6ce2\u52d5\u7387\u52a0\u6b0a\n    # volatility_values = context.output.loc[context.stocks, 'volatility']\n    # inv_vol = 1 / volatility_values\n    # total_inv_vol = inv_vol.sum()\n    # target_weights = {}\n    # for stock in context.stocks:\n    #     target_weights[stock] = inv_vol[stock] / total_inv_vol\n\n    # ========================================\n    # Step 2: \u8ce3\u51fa\u4e0d\u5728\u6e05\u55ae\u7684\u80a1\u7968\n    # ========================================\n    for stock in context.portfolio.positions:\n        if stock not in context.stocks:\n            order_target_percent(stock, 0)\n\n    # ========================================\n    # Step 3: \u8cb7\u5165\u76ee\u6a19\u80a1\u7968\n    # ========================================\n    for stock, weight in target_weights.items():\n        if data.can_trade(stock):\n            order_target_percent(stock, weight)\n\n    # ========================================\n    # Step 4: \u8a18\u9304\u8cc7\u8a0a\n    # ========================================\n    record(\n        num_positions=len(context.portfolio.positions),\n        leverage=context.account.leverage\n    )\n</code></pre>"},{"location":"blocks/pipeline/template/#module-5","title":"Module 5: \u7e3e\u6548\u5206\u6790 &amp; \u57f7\u884c\u56de\u6e2c","text":"<pre><code># ====================================\n# Module 5: \u7e3e\u6548\u5206\u6790\u51fd\u6578\n# ====================================\n\ndef analyze(context, perf):\n    \"\"\"\n    \u7e3e\u6548\u5206\u6790\u8207\u8996\u89ba\u5316\n    \"\"\"\n    import matplotlib.pyplot as plt\n\n    fig = plt.figure(figsize=(16, 12))\n\n    # ========================================\n    # \u5716 1: \u6295\u8cc7\u7d44\u5408\u50f9\u503c\n    # ========================================\n    ax1 = fig.add_subplot(411)\n    perf['portfolio_value'].plot(ax=ax1, linewidth=2)\n    ax1.set_ylabel('Portfolio Value (TWD)', fontsize=12)\n    ax1.set_title('Portfolio Performance', fontsize=14, fontweight='bold')\n    ax1.grid(True, alpha=0.3)\n\n    # ========================================\n    # \u5716 2: \u7d2f\u7a4d\u5831\u916c vs \u57fa\u6e96\n    # ========================================\n    ax2 = fig.add_subplot(412)\n\n    cumulative_returns = (1 + perf['returns']).cumprod() - 1\n    benchmark_returns = (1 + perf['benchmark_return']).cumprod() - 1\n\n    cumulative_returns.plot(ax=ax2, label='Strategy', linewidth=2, color='#2E86AB')\n    benchmark_returns.plot(ax=ax2, label='Benchmark', linewidth=2, alpha=0.7, color='#A23B72')\n\n    ax2.set_ylabel('Cumulative Returns', fontsize=12)\n    ax2.set_title('Strategy vs Benchmark', fontsize=14, fontweight='bold')\n    ax2.legend(loc='upper left', fontsize=11)\n    ax2.grid(True, alpha=0.3)\n    ax2.axhline(0, color='black', linewidth=0.8, linestyle='--', alpha=0.5)\n\n    # ========================================\n    # \u5716 3: \u6301\u5009\u6578\u91cf\n    # ========================================\n    ax3 = fig.add_subplot(413)\n    perf['num_positions'].plot(ax=ax3, linewidth=2, color='#F18F01')\n    ax3.set_ylabel('Number of Positions', fontsize=12)\n    ax3.set_title('Position Count', fontsize=14, fontweight='bold')\n    ax3.grid(True, alpha=0.3)\n\n    # ========================================\n    # \u5716 4: \u69d3\u687f\n    # ========================================\n    ax4 = fig.add_subplot(414)\n    perf['leverage'].plot(ax=ax4, linewidth=2, color='#6A4C93')\n    ax4.set_ylabel('Leverage', fontsize=12)\n    ax4.set_xlabel('Date', fontsize=12)\n    ax4.set_title('Portfolio Leverage', fontsize=14, fontweight='bold')\n    ax4.grid(True, alpha=0.3)\n    ax4.axhline(1, color='red', linewidth=1, linestyle='--', alpha=0.5)\n\n    plt.tight_layout()\n    plt.show()\n\n    # \u5132\u5b58\u7e3e\u6548\u6578\u64da\n    perf.to_csv(f'pipeline_performance.csv')\n    print(f\"\\n\u7e3e\u6548\u6578\u64da\u5df2\u5132\u5b58\u81f3: pipeline_performance.csv\")\n\n\n# ====================================\n# \u57f7\u884c\u56de\u6e2c\n# ====================================\nfrom zipline import run_algorithm\n\nprint(\"=\"*60)\nprint(\"\u958b\u59cb\u56de\u6e2c Pipeline \u56e0\u5b50\u7b56\u7565\")\nprint(\"=\"*60)\n\nresults = run_algorithm(\n    start=pd.Timestamp(start_date, tz='utc'),\n    end=pd.Timestamp(end_date, tz='utc'),\n    initialize=initialize,\n    before_trading_start=before_trading_start,\n    analyze=analyze,\n    bundle='tquant',\n    capital_base=1e7  # 1000 \u842c\u5143\n)\n\nprint(\"\\n\u56de\u6e2c\u5b8c\u6210\uff01\")\n\n# ====================================\n# \u7e3e\u6548\u7d71\u8a08\n# ====================================\nprint(\"\\n========== \u7e3e\u6548\u6458\u8981 ==========\")\n\ntotal_return = (results['portfolio_value'].iloc[-1] / 1e7 - 1) * 100\nbenchmark_return = results['benchmark_period_return'].iloc[-1] * 100\n\nprint(f\"\u7b56\u7565\u7e3d\u5831\u916c: {total_return:.2f}%\")\nprint(f\"\u57fa\u6e96\u5831\u916c: {benchmark_return:.2f}%\")\nprint(f\"\u8d85\u984d\u5831\u916c: {(total_return - benchmark_return):.2f}%\")\nprint(f\"\u6700\u5927\u56de\u64a4: {results['max_drawdown'].min() * 100:.2f}%\")\nprint(f\"\u590f\u666e\u6bd4\u7387: {results['sharpe'].iloc[-1]:.2f}\")\nprint(f\"\u5e73\u5747\u6301\u5009\u6578: {results['num_positions'].mean():.0f}\")\n\n# ====================================\n# Pyfolio \u7e3e\u6548\u5206\u6790\n# ====================================\ntry:\n    import pyfolio as pf\n    from pyfolio.utils import extract_rets_pos_txn_from_zipline\n\n    print(\"\\n\" + \"=\"*60)\n    print(\"Pyfolio \u7e3e\u6548\u5206\u6790\")\n    print(\"=\"*60)\n\n    returns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\n    benchmark_rets = results.benchmark_return\n\n    pf.tears.create_full_tear_sheet(\n        returns=returns,\n        positions=positions,\n        transactions=transactions,\n        benchmark_rets=benchmark_rets\n    )\n\nexcept ImportError:\n    print(\"\\n\u672a\u5b89\u88dd pyfolio\uff0c\u7565\u904e\u8a73\u7d30\u5206\u6790\")\n    print(\"\u82e5\u9700\u5b8c\u6574\u5831\u544a\uff0c\u8acb\u57f7\u884c: pip install pyfolio\")\nexcept Exception as e:\n    print(f\"\\nPyfolio \u5206\u6790\u932f\u8aa4: {e}\")\n</code></pre>"},{"location":"blocks/pipeline/template/#_3","title":"\ud83c\udfaf \u4f7f\u7528\u6307\u5357","text":""},{"location":"blocks/pipeline/template/#step-1","title":"Step 1: \u9078\u64c7\u56e0\u5b50\u985e\u578b","text":"<p>\u6839\u64da\u4f60\u7684\u7b56\u7565\u9078\u64c7\u5c0d\u61c9\u7684 CustomFactor \u6a21\u677f\uff1a</p> <ul> <li>\u6a21\u677f A\uff1a\u55ae\u4e00\u8cc7\u6599\u6e90\uff08\u52d5\u91cf\u3001\u6ce2\u52d5\u7387\u3001\u6210\u4ea4\u91cf\uff09</li> <li>\u6a21\u677f B\uff1a\u591a\u8cc7\u6599\u6e90\uff08\u50f9\u91cf\u6bd4\u3001RSI\uff09</li> <li>\u6a21\u677f C\uff1a\u6392\u540d\u56e0\u5b50\uff08\u76f8\u5c0d\u6392\u540d\uff09</li> <li>\u6a21\u677f D\uff1a\u7d44\u5408\u56e0\u5b50\uff08\u591a\u56e0\u5b50\u52a0\u6b0a\uff09</li> </ul>"},{"location":"blocks/pipeline/template/#step-2-compute","title":"Step 2: \u5be6\u4f5c compute() \u51fd\u6578","text":"<p>\u4fee\u6539 <code>compute()</code> \u51fd\u6578\u4e2d\u7684\u8a08\u7b97\u908f\u8f2f\uff1a <pre><code>def compute(self, today, assets, out, close):\n    # 1. \u63d0\u53d6\u9700\u8981\u7684\u8cc7\u6599\n    latest_close = close[-1]\n    first_close = close[0]\n\n    # 2. \u8a08\u7b97\u56e0\u5b50\u503c\n    returns = (latest_close - first_close) / first_close\n\n    # 3. \u586b\u5165\u8f38\u51fa\u9663\u5217\n    out[:] = returns\n</code></pre></p>"},{"location":"blocks/pipeline/template/#step-3-pipeline","title":"Step 3: \u7d44\u5408 Pipeline","text":"<p>\u5728 <code>make_pipeline()</code> \u4e2d\u7d44\u5408\u56e0\u5b50\u548c\u7be9\u9078\u5668\uff1a <pre><code>def make_pipeline():\n    # \u5b9a\u7fa9\u56e0\u5b50\n    factor1 = MyFactor1()\n    factor2 = MyFactor2()\n\n    # \u5b9a\u7fa9\u7be9\u9078\u5668\n    screen = (factor1 &gt; 0) &amp; (factor2.top(100))\n\n    # \u7d44\u5408 Pipeline\n    return Pipeline(\n        columns={'factor1': factor1, 'factor2': factor2},\n        screen=screen\n    )\n</code></pre></p>"},{"location":"blocks/pipeline/template/#step-4","title":"Step 4: \u8a2d\u5b9a\u8abf\u5009\u908f\u8f2f","text":"<p>\u9078\u64c7\u8abf\u5009\u983b\u7387\u548c\u6b0a\u91cd\u8a08\u7b97\u65b9\u6cd5\uff1a <pre><code># \u8abf\u5009\u983b\u7387\nschedule_function(\n    rebalance,\n    date_rules.week_start(),  # \u6bcf\u9031\u4e00\n    time_rules.market_open()\n)\n\n# \u6b0a\u91cd\u8a08\u7b97\ntarget_weights = {}\nfor stock in context.stocks:\n    target_weights[stock] = 1.0 / len(context.stocks)  # \u7b49\u6b0a\n</code></pre></p>"},{"location":"blocks/pipeline/template/#_4","title":"\ud83d\udca1 \u9032\u968e\u6280\u5de7","text":""},{"location":"blocks/pipeline/template/#1","title":"\u6280\u5de7 1: \u591a\u56e0\u5b50\u7d44\u5408","text":"<pre><code>def make_pipeline():\n    # \u5b9a\u7fa9\u591a\u500b\u56e0\u5b50\n    momentum = Momentum()\n    value = ValueFactor()\n    quality = QualityFactor()\n\n    # \u6a19\u6e96\u5316\u56e0\u5b50\uff080-1\uff09\n    momentum_rank = momentum.rank(mask=universe) / universe.sum()\n    value_rank = value.rank(mask=universe) / universe.sum()\n    quality_rank = quality.rank(mask=universe) / universe.sum()\n\n    # \u7d44\u5408\u56e0\u5b50\uff08\u52a0\u6b0a\uff09\n    composite_score = (\n        0.4 * momentum_rank +\n        0.3 * value_rank +\n        0.3 * quality_rank\n    )\n\n    return Pipeline(\n        columns={'score': composite_score},\n        screen=universe\n    )\n</code></pre>"},{"location":"blocks/pipeline/template/#2","title":"\u6280\u5de7 2: \u7522\u696d\u4e2d\u6027","text":"<pre><code>def before_trading_start(context, data):\n    output = pipeline_output('my_pipeline')\n\n    # \u5047\u8a2d\u6709\u7522\u696d\u5206\u985e\u6b04\u4f4d\n    # \u6bcf\u500b\u7522\u696d\u9078\u524d 5 \u540d\n    stocks = []\n    for industry in output['industry'].unique():\n        industry_stocks = output[output['industry'] == industry]\n        top5 = industry_stocks.nlargest(5, 'momentum')\n        stocks.extend(top5.index.tolist())\n\n    context.stocks = stocks\n</code></pre>"},{"location":"blocks/pipeline/template/#3","title":"\u6280\u5de7 3: \u52d5\u614b\u8abf\u6574\u6301\u5009\u6578","text":"<pre><code>def before_trading_start(context, data):\n    output = pipeline_output('my_pipeline')\n\n    # \u6839\u64da\u5e02\u5834\u72c0\u6cc1\u8abf\u6574\u6301\u5009\u6578\n    market_volatility = calculate_market_volatility()\n\n    if market_volatility &lt; 0.2:\n        num_stocks = 30  # \u4f4e\u6ce2\u52d5\uff0c\u6301\u5009\u591a\n    elif market_volatility &lt; 0.4:\n        num_stocks = 20  # \u4e2d\u6ce2\u52d5\n    else:\n        num_stocks = 10  # \u9ad8\u6ce2\u52d5\uff0c\u6301\u5009\u5c11\n\n    context.stocks = output.nlargest(num_stocks, 'momentum').index.tolist()\n</code></pre>"},{"location":"blocks/pipeline/template/#4","title":"\u6280\u5de7 4: \u98a8\u96aa\u5e73\u50f9","text":"<pre><code>def rebalance(context, data):\n    # \u6839\u64da\u6ce2\u52d5\u7387\u5206\u914d\u6b0a\u91cd\n    volatility_values = context.output.loc[context.stocks, 'volatility']\n\n    # \u53cd\u6ce2\u52d5\u7387\u6b0a\u91cd\n    inv_vol = 1 / volatility_values\n    total_inv_vol = inv_vol.sum()\n\n    target_weights = {}\n    for stock in context.stocks:\n        target_weights[stock] = inv_vol[stock] / total_inv_vol\n\n    # \u57f7\u884c\u8abf\u5009\n    for stock, weight in target_weights.items():\n        order_target_percent(stock, weight)\n</code></pre>"},{"location":"blocks/pipeline/template/#_5","title":"\ud83d\udcda \u5e38\u7528\u56e0\u5b50\u901f\u67e5","text":""},{"location":"blocks/pipeline/template/#_6","title":"\u52d5\u91cf\u985e","text":"<pre><code># \u7c21\u55ae\u5831\u916c\u7387\nclass Returns(CustomFactor):\n    window_length = 252\n    inputs = [EquityPricing.close]\n    def compute(self, today, assets, out, close):\n        out[:] = (close[-1] - close[0]) / close[0]\n\n# \u5e74\u5316\u5831\u916c\u7387\nclass AnnualizedReturns(CustomFactor):\n    window_length = 252\n    inputs = [EquityPricing.close]\n    def compute(self, today, assets, out, close):\n        returns = (close[-1] / close[0]) - 1\n        out[:] = returns\n</code></pre>"},{"location":"blocks/pipeline/template/#_7","title":"\u6ce2\u52d5\u7387\u985e","text":"<pre><code># \u6a19\u6e96\u5dee\nclass StdDev(CustomFactor):\n    window_length = 252\n    inputs = [EquityPricing.close]\n    def compute(self, today, assets, out, close):\n        daily_returns = np.diff(close, axis=0) / close[:-1]\n        out[:] = np.nanstd(daily_returns, axis=0)\n\n# \u5e74\u5316\u6ce2\u52d5\u7387\nclass AnnualizedVolatility(CustomFactor):\n    window_length = 252\n    inputs = [EquityPricing.close]\n    def compute(self, today, assets, out, close):\n        daily_returns = np.diff(close, axis=0) / close[:-1]\n        out[:] = np.nanstd(daily_returns, axis=0) * np.sqrt(252)\n</code></pre>"},{"location":"blocks/pipeline/template/#_8","title":"\u6210\u4ea4\u91cf\u985e","text":"<pre><code># \u5e73\u5747\u6210\u4ea4\u91cf\nclass AverageVolume(CustomFactor):\n    window_length = 30\n    inputs = [EquityPricing.volume]\n    def compute(self, today, assets, out, volume):\n        out[:] = np.nanmean(volume, axis=0)\n\n# \u6210\u4ea4\u91cf\u8b8a\u5316\u7387\nclass VolumeChange(CustomFactor):\n    window_length = 2\n    inputs = [EquityPricing.volume]\n    def compute(self, today, assets, out, volume):\n        out[:] = (volume[-1] - volume[-2]) / volume[-2]\n</code></pre>"},{"location":"blocks/pipeline/template/#_9","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md - \u7406\u89e3\u8a2d\u8a08\u539f\u7406</li> <li>\u6848\u4f8b\u5b78\u7fd2\uff1a</li> <li>Expanded Momentum - \u52d5\u91cf\u7b56\u7565</li> <li>\u8ddf\u96a8\u5927\u6236 - \u7c4c\u78bc\u5206\u6790</li> <li>CounterTrend - \u9006\u52e2\u7b56\u7565</li> <li>\u5e38\u898b\u554f\u984c\uff1afaq.md</li> </ul> <p>\ud83d\udc49 Next Step: \u9078\u64c7\u4e00\u500b\u6a21\u677f\uff0c\u53c3\u8003\u5c0d\u61c9\u7684 case study\uff0c\u958b\u59cb\u958b\u767c\u4f60\u7684 Pipeline \u7b56\u7565\uff01</p>"},{"location":"blocks/technicals/","title":"\u67b6\u69cb B\uff1a\u6280\u8853\u6307\u6a19\u67b6\u69cb (Technical Indicator Framework)","text":"<p>\u6838\u5fc3\u601d\u60f3\uff1a\u6bcf\u65e5\u5373\u6642\u904b\u7b97\uff0c\u9748\u6d3b\u61c9\u5c0d\u5e02\u5834\u3002 \"Calculate on-the-fly, react to the market.\"</p>"},{"location":"blocks/technicals/#_1","title":"\ud83d\udccc \u6838\u5fc3\u6982\u5ff5","text":"<p>\u6280\u8853\u6307\u6a19\u67b6\u69cb\u7684\u672c\u8cea\u662f\u300c\u5373\u6642\u904b\u7b97 + \u52d5\u614b\u8abf\u6574\u300d\u7684\u56de\u6e2c\u6a21\u5f0f\uff1a <pre><code>\u6bcf\u500b\u4ea4\u6613\u65e5\uff1a\nStep 1: \u6293\u53d6\u904e\u53bb N \u5929\u7684 K \u7dda\u8cc7\u6599\nStep 2: \u8a08\u7b97\u6280\u8853\u6307\u6a19\uff08MACD\u3001KD\u3001\u5e03\u6797\u901a\u9053\u7b49\uff09\nStep 3: \u5224\u65b7\u8a0a\u865f\uff08\u8cb7\u5165 / \u8ce3\u51fa / \u6301\u6709\uff09\nStep 4: \u57f7\u884c\u4ea4\u6613\n</code></pre></p> <p>\u9019\u7a2e\u67b6\u69cb\u6700\u7b26\u5408\u6280\u8853\u5206\u6790\u7684\u601d\u7dad\u908f\u8f2f\uff1a</p> <ul> <li>\ud83d\udcc8 \u76e4\u4e2d\uff1a\u770b\u8457 K \u7dda\u5716\uff0c\u8a08\u7b97\u6307\u6a19</li> <li>\ud83c\udfaf \u5373\u6642\uff1a\u51fa\u73fe\u8a0a\u865f\u5c31\u4e0b\u55ae</li> <li>\ud83d\udd04 \u6bcf\u65e5\uff1a\u6301\u7e8c\u76e3\u63a7\uff0c\u52d5\u614b\u8abf\u6574</li> </ul>"},{"location":"blocks/technicals/#_2","title":"\ud83c\udfaf \u9069\u7528\u5834\u666f","text":""},{"location":"blocks/technicals/#_3","title":"\u2705 \u6700\u9069\u5408\u7684\u60c5\u5883","text":"<ul> <li>\u6280\u8853\u6307\u6a19\u4ea4\u6613\uff1aMACD\u3001KD\u3001RSI\u3001\u5e03\u6797\u901a\u9053\u7b49</li> <li>\u50f9\u91cf\u5206\u6790\uff1a\u6210\u4ea4\u91cf\u3001\u5747\u7dda\u3001\u652f\u6490\u58d3\u529b</li> <li>\u55ae\u4e00\u6216\u5c11\u6578\u6a19\u7684\uff1a1-10 \u6a94\u80a1\u7968</li> <li>\u9ad8\u983b\u8abf\u6574\uff1a\u65e5\u5167\u3001\u9694\u65e5\u3001\u9031\u5ea6\u4ea4\u6613</li> </ul>"},{"location":"blocks/technicals/#_4","title":"\u274c \u4e0d\u9069\u5408\u7684\u60c5\u5883","text":"<ul> <li>\u274c \u5927\u898f\u6a21\u80a1\u7968\u6c60\uff08&gt;50 \u6a94\uff09</li> <li>\u274c \u8ca1\u5831\u9078\u80a1\u7b56\u7565</li> <li>\u274c \u9700\u8981\u5916\u90e8\u6578\u64da\uff08\u7c4c\u78bc\u3001\u8ca1\u5831\uff09</li> <li>\u274c \u4f4e\u983b\u7b56\u7565\uff08\u5b63\u5ea6\u8abf\u5009\uff09</li> </ul>"},{"location":"blocks/technicals/#_5","title":"\ud83c\udfd7\ufe0f \u67b6\u69cb\u7279\u8272","text":""},{"location":"blocks/technicals/#_6","title":"\u6578\u64da\u6d41\u5411\u5716","text":"<pre><code>graph TD\n    subgraph Prep[\"\u2699\ufe0f \u4e8b\u524d\u6e96\u5099\"]\n        A1[\u8a2d\u5b9a\u80a1\u7968\u6e05\u55ae&lt;br/&gt;\u901a\u5e38 1-10 \u6a94] --&gt; A2[simple_ingest&lt;br/&gt;\u532f\u5165\u50f9\u91cf\u8cc7\u6599]\n    end\n\n    subgraph Daily[\"\ud83d\udd04 \u6bcf\u65e5\u5faa\u74b0 (handle_data)\"]\n        A2 --&gt; B1[data.history&lt;br/&gt;\u6293\u53d6\u904e\u53bb N \u5929 K \u7dda]\n        B1 --&gt; B2[\u8a08\u7b97\u6280\u8853\u6307\u6a19&lt;br/&gt;talib / \u624b\u5beb\u51fd\u6578]\n        B2 --&gt; B3{\u8a0a\u865f\u5224\u65b7}\n        B3 --&gt;|\u8cb7\u5165| B4[order_target&lt;br/&gt;\u5efa\u7acb\u90e8\u4f4d]\n        B3 --&gt;|\u8ce3\u51fa| B5[order_target&lt;br/&gt;\u6e05\u7a7a\u90e8\u4f4d]\n        B3 --&gt;|\u6301\u6709| B6[\u4e0d\u52d5\u4f5c]\n        B4 &amp; B5 --&gt; B7[record&lt;br/&gt;\u8a18\u9304\u8a0a\u865f\u8207\u50f9\u683c]\n    end\n\n    style Prep fill:#e3f2fd,stroke:#1976d2,stroke-width:2px\n    style Daily fill:#fff9c4,stroke:#f57f17,stroke-width:2px\n    style B2 fill:#ffccbc,stroke:#d84315,stroke-width:2px\n    style B3 fill:#c5e1a5,stroke:#558b2f,stroke-width:2px</code></pre>"},{"location":"blocks/technicals/#_7","title":"\u95dc\u9375\u8a2d\u8a08\u7406\u5ff5","text":""},{"location":"blocks/technicals/#1","title":"1. \u5373\u6642\u904b\u7b97\u7684\u512a\u52e2","text":"<pre><code># \u6bcf\u5929\u5373\u6642\u6293 K \u7dda\uff0c\u8a08\u7b97\u6700\u65b0\u6307\u6a19\ndef handle_data(context, data):\n    # \u6293\u53d6\u904e\u53bb 35 \u5929\u7684\u6536\u76e4\u50f9\n    trailing_window = data.history(context.sym, 'price', 35, '1d')\n\n    # \u8a08\u7b97 MACD\n    short_ema = talib.EMA(trailing_window.values, timeperiod=12)\n    long_ema = talib.EMA(trailing_window.values, timeperiod=26)\n    dif = short_ema - long_ema\n    macd = talib.EMA(dif, timeperiod=9)\n\n    # \u5224\u65b7\u8a0a\u865f\n    if (dif[-1] &gt; macd[-1]) and (dif[-2] &lt;= macd[-2]):\n        order_target(context.sym, 1000)  # \u9ec3\u91d1\u4ea4\u53c9\uff0c\u8cb7\u5165\n</code></pre> <p>\u512a\u9ede\uff1a - \u2705 \u53c3\u6578\u8abf\u6574\u5bb9\u6613\uff08\u76f4\u63a5\u6539 timeperiod\uff09 - \u2705 \u908f\u8f2f\u6e05\u6670\uff08\u8207\u624b\u52d5\u770b\u76e4\u4e00\u81f4\uff09 - \u2705 \u9664\u932f\u65b9\u4fbf\uff08\u53ef\u5370\u51fa\u6bcf\u65e5\u6307\u6a19\u503c\uff09</p>"},{"location":"blocks/technicals/#2-pipeline-vs-loop","title":"2. Pipeline vs Loop \u7684\u6289\u64c7","text":"\u7279\u6027 Loop \u65b9\u6cd5\uff08handle_data\uff09 Pipeline \u65b9\u6cd5 \u9069\u7528\u80a1\u7968\u6578 1-10 \u6a94 50+ \u6a94 \u5f48\u6027 \ud83d\udfe2 \u6975\u9ad8 \ud83d\udd34 \u4f4e \u6548\u80fd \ud83d\udfe1 \u4e2d \ud83d\udfe2 \u9ad8 \u5b78\u7fd2\u66f2\u7dda \ud83d\udfe2 \u5e73\u7de9 \ud83d\udd34 \u9661\u5ced Debug \u96e3\u5ea6 \ud83d\udfe2 \u6613 \ud83d\udd34 \u96e3 <p>\u672c\u67b6\u69cb\u63a1\u7528 Loop \u65b9\u6cd5\uff0c\u56e0\u70ba\u6280\u8853\u6307\u6a19\u7b56\u7565\u901a\u5e38\uff1a - \u6a19\u7684\u5c11\uff081-10 \u6a94\uff09 - \u908f\u8f2f\u8907\u96dc\uff08\u9700\u8981\u591a\u689d\u4ef6\u5224\u65b7\uff09 - \u9700\u8981\u9748\u6d3b\u8abf\u6574</p>"},{"location":"blocks/technicals/#3-talib","title":"3. \u4f7f\u7528 talib \u8a08\u7b97\u6307\u6a19","text":"<pre><code>import talib\n\n# \u5e38\u7528\u6307\u6a19\nema = talib.EMA(close, timeperiod=20)\nsma = talib.SMA(close, timeperiod=20)\nmacd, signal, hist = talib.MACD(close, fastperiod=12, slowperiod=26, signalperiod=9)\nrsi = talib.RSI(close, timeperiod=14)\nupper, middle, lower = talib.BBANDS(close, timeperiod=20, nbdevup=2, nbdevdn=2)\n</code></pre> <p>\u70ba\u4ec0\u9ebc\u7528 talib\uff1f - \u2705 \u696d\u754c\u6a19\u6e96\uff0c\u8a08\u7b97\u6b63\u78ba - \u2705 \u6548\u80fd\u512a\u7570\uff08C \u8a9e\u8a00\u5be6\u4f5c\uff09 - \u2705 \u6db5\u84cb 150+ \u6280\u8853\u6307\u6a19</p>"},{"location":"blocks/technicals/#_8","title":"\ud83d\udcca \u8207\u5176\u4ed6\u67b6\u69cb\u7684\u5dee\u7570","text":"\u7279\u6027 \u6280\u8853\u6307\u6a19\u67b6\u69cb \u8ca1\u5831\u9078\u80a1\u67b6\u69cb Pipeline \u67b6\u69cb \u904b\u7b97\u6642\u6a5f \u56de\u6e2c\u5167\uff08\u6bcf\u65e5\uff09 \u56de\u6e2c\u5916 \u56de\u6e2c\u5167\uff08\u76e4\u524d\uff09 \u6578\u64da\u4f86\u6e90 data.history() TEJ API CustomDataset \u9069\u7528\u80a1\u7968\u6578 1-10 50-200 500-2000 \u8abf\u5009\u983b\u7387 \u6bcf\u65e5 \u5b63\u5ea6/\u6708\u5ea6 \u6bcf\u65e5/\u6bcf\u9031 \u5178\u578b\u7528\u9014 \u6280\u8853\u5206\u6790 \u57fa\u672c\u9762\u9078\u80a1 \u56e0\u5b50\u6a21\u578b \u5b78\u7fd2\u96e3\u5ea6 \ud83d\udfe2 \u6613 \ud83d\udfe2 \u6613 \ud83d\udd34 \u96e3 \u5f48\u6027 \ud83d\udfe2 \u6975\u9ad8 \ud83d\udfe1 \u4e2d \ud83d\udd34 \u4f4e"},{"location":"blocks/technicals/#_9","title":"\ud83d\udca1 \u4f55\u6642\u9078\u64c7\u9019\u500b\u67b6\u69cb\uff1f","text":""},{"location":"blocks/technicals/#_10","title":"\u5feb\u901f\u5224\u65b7\u6aa2\u67e5\u8868","text":"<pre><code>graph TD\n    A[\u4f60\u7684\u7b56\u7565] --&gt; B{\u4f7f\u7528\u6280\u8853\u6307\u6a19?}\n    B --&gt;|Yes| C{\u80a1\u7968\u6578\u91cf?}\n    B --&gt;|No| X[\u8003\u616e\u8ca1\u5831\u9078\u80a1\u67b6\u69cb]\n\n    C --&gt;|1-10 \u6a94| D[\u2705 \u6280\u8853\u6307\u6a19\u67b6\u69cb]\n    C --&gt;|10-50 \u6a94| E{\u9700\u8981\u9ad8\u6548\u80fd?}\n    C --&gt;|&gt;50 \u6a94| F[\u8003\u616e Pipeline \u67b6\u69cb]\n\n    E --&gt;|Yes| F\n    E --&gt;|No| D\n\n    style D fill:#c8e6c9,stroke:#388e3c,stroke-width:3px</code></pre>"},{"location":"blocks/technicals/#_11","title":"\u5178\u578b\u4f7f\u7528\u6848\u4f8b","text":"<ul> <li>\u2705 \u5747\u7dda\u7b56\u7565\uff08\u91d1\u53c9\u6b7b\u53c9\uff09</li> <li>\u2705 MACD \u7b56\u7565\uff08DIF \u8207 MACD \u4ea4\u53c9\uff09</li> <li>\u2705 \u5e03\u6797\u901a\u9053\uff08\u7a81\u7834\u4e0a\u4e0b\u8ecc\uff09</li> <li>\u2705 KD \u6307\u6a19\uff08\u8d85\u8cb7\u8d85\u8ce3\uff09</li> <li>\u2705 \u4e56\u96e2\u7387\uff08\u504f\u96e2\u5747\u7dda\uff09</li> <li>\u2705 RSI\uff08\u76f8\u5c0d\u5f37\u5f31\uff09</li> </ul>"},{"location":"blocks/technicals/#_12","title":"\ud83c\udf93 \u5b78\u7fd2\u8def\u5f91","text":""},{"location":"blocks/technicals/#3","title":"\u65b0\u624b\u5165\u9580\uff083 \u6b65\u9a5f\uff09","text":"<ol> <li>\u95b1\u8b80\u6848\u4f8b\uff1a\u5148\u770b <code>case-macd.md</code>\uff0c\u7406\u89e3\u5b8c\u6574\u6d41\u7a0b</li> <li>\u8907\u88fd\u6a21\u677f\uff1a\u524d\u5f80 <code>template.md</code> \u8907\u88fd\u9aa8\u67b6</li> <li>\u66ff\u63db\u6307\u6a19\uff1a\u4fee\u6539\u6280\u8853\u6307\u6a19\u8a08\u7b97\u908f\u8f2f</li> </ol>"},{"location":"blocks/technicals/#_13","title":"\u9032\u968e\u512a\u5316","text":"<ul> <li>\u591a\u6307\u6a19\u7d44\u5408\uff08MACD + RSI\uff09</li> <li>\u52d5\u614b\u53c3\u6578\u8abf\u6574</li> <li>\u52a0\u5165\u505c\u640d\u505c\u5229\u6a5f\u5236</li> <li>\u90e8\u4f4d\u7ba1\u7406\uff08\u91d1\u5b57\u5854\u52a0\u78bc\uff09</li> </ul>"},{"location":"blocks/technicals/#_14","title":"\ud83d\udd0d \u67b6\u69cb\u512a\u52e2\u8207\u9650\u5236","text":""},{"location":"blocks/technicals/#_15","title":"\u512a\u52e2 \u2705","text":""},{"location":"blocks/technicals/#1_1","title":"1. \u6975\u81f4\u5f48\u6027","text":"<pre><code># \u53ef\u4ee5\u8f15\u9b06\u5be6\u73fe\u8907\u96dc\u908f\u8f2f\nif (macd_signal == 'buy') and (rsi &lt; 30) and (volume &gt; avg_volume * 1.5):\n    if context.portfolio.positions[stock].amount == 0:\n        order(stock, 1000)\n    elif current_price &lt; buy_price * 0.95:  # \u50f9\u683c\u56de\u6a94\n        order(stock, 500)  # \u52a0\u78bc\n</code></pre>"},{"location":"blocks/technicals/#2-debug","title":"2. Debug \u53cb\u5584","text":"<pre><code># \u53ef\u4ee5\u96a8\u6642\u5370\u51fa\u7576\u524d\u72c0\u614b\nprint(f\"\u65e5\u671f: {data.current_dt.date()}\")\nprint(f\"DIF: {dif[-1]:.2f}, MACD: {macd[-1]:.2f}\")\nprint(f\"\u8a0a\u865f: {'\u8cb7\u5165' if buy else '\u8ce3\u51fa' if sell else '\u6301\u6709'}\")\n</code></pre>"},{"location":"blocks/technicals/#3_1","title":"3. \u7b26\u5408\u76f4\u89ba","text":"<pre><code># \u8207\u624b\u52d5\u770b\u76e4\u908f\u8f2f\u4e00\u81f4\nif current_price &gt; upper_band:  # \u7a81\u7834\u4e0a\u8ecc\n    order_target(stock, 0)      # \u8ce3\u51fa\n</code></pre>"},{"location":"blocks/technicals/#_16","title":"\u9650\u5236 \u26a0\ufe0f","text":""},{"location":"blocks/technicals/#1_2","title":"1. \u6548\u80fd\u74f6\u9838","text":"<pre><code># \u5982\u679c\u6709 100 \u6a94\u80a1\u7968\nfor stock in stock_list:  # \u6bcf\u5929\u8dd1 100 \u6b21\n    history = data.history(stock, 'price', 50, '1d')\n    macd = calculate_macd(history)\n    # ...\n# \u6703\u975e\u5e38\u6162\uff01\n</code></pre> <p>\u89e3\u6c7a\u65b9\u6848\uff1a - \u9650\u5236\u80a1\u7968\u6578\u91cf\uff08&lt;10 \u6a94\uff09 - \u6216\u6539\u7528 Pipeline \u67b6\u69cb</p>"},{"location":"blocks/technicals/#2","title":"2. \u904e\u5ea6\u4ea4\u6613\u98a8\u96aa","text":"<pre><code># \u6280\u8853\u6307\u6a19\u7b56\u7565\u5bb9\u6613\u7522\u751f\u904e\u591a\u8a0a\u865f\n# \u9700\u8981\u52a0\u5165\u904e\u6ffe\u6a5f\u5236\nif buy_signal and (context.i - context.last_trade_day &gt; 5):\n    order(stock, 100)\n    context.last_trade_day = context.i\n</code></pre>"},{"location":"blocks/technicals/#3_2","title":"3. \u53c3\u6578\u654f\u611f","text":"<pre><code># MACD(12, 26, 9) \u5f88\u597d\n# MACD(13, 27, 10) \u53ef\u80fd\u5f88\u5dee\n# \u9700\u8981\u7a69\u5065\u6027\u6e2c\u8a66\nfor fast in range(10, 15):\n    for slow in range(24, 30):\n        test_backtest(fast, slow)\n</code></pre>"},{"location":"blocks/technicals/#_17","title":"\ud83d\udee0\ufe0f \u6838\u5fc3\u5de5\u5177\u4ecb\u7d39","text":""},{"location":"blocks/technicals/#1-datahistory-","title":"1. data.history() - \u6293\u53d6\u6b77\u53f2\u8cc7\u6599","text":"<pre><code># \u8a9e\u6cd5\ndata.history(\n    assets,          # \u80a1\u7968\u4ee3\u865f\uff08symbol \u7269\u4ef6\uff09\n    fields,          # \u6b04\u4f4d\uff1a'price', 'open', 'high', 'low', 'close', 'volume'\n    bar_count,       # \u6578\u91cf\uff08\u5f80\u56de\u5e7e\u6839 K \u68d2\uff09\n    frequency        # \u983b\u7387\uff1a'1d'\uff08\u65e5\u7dda\uff09, '1m'\uff08\u5206\u9418\u7dda\uff09\n)\n\n# \u7bc4\u4f8b\nclose_prices = data.history(symbol('2330'), 'close', 20, '1d')\n# \u56de\u50b3\uff1a\u904e\u53bb 20 \u5929\u7684\u6536\u76e4\u50f9\uff08pandas Series\uff09\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9805\uff1a - \u56de\u50b3\u7684\u8cc7\u6599**\u4e0d\u5305\u542b\u7576\u5929**\uff08\u907f\u514d\u524d\u8996\u504f\u5dee\uff09 - \u5982\u679c\u8cc7\u6599\u4e0d\u8db3\uff08\u5982\u65b0\u4e0a\u5e02\u80a1\u7968\uff09\uff0c\u6703\u56de\u50b3 NaN</p>"},{"location":"blocks/technicals/#2-talib-","title":"2. talib - \u6280\u8853\u6307\u6a19\u8a08\u7b97","text":"<pre><code>import talib\n\n# \u79fb\u52d5\u5e73\u5747\nsma = talib.SMA(close, timeperiod=20)\nema = talib.EMA(close, timeperiod=20)\n\n# \u8da8\u52e2\u6307\u6a19\nmacd, signal, hist = talib.MACD(close, fastperiod=12, slowperiod=26, signalperiod=9)\n\n# \u9707\u76ea\u6307\u6a19\nrsi = talib.RSI(close, timeperiod=14)\nstoch_k, stoch_d = talib.STOCH(high, low, close, fastk_period=14, slowk_period=3, slowd_period=3)\n\n# \u901a\u9053\u6307\u6a19\nupper, middle, lower = talib.BBANDS(close, timeperiod=20, nbdevup=2, nbdevdn=2)\n\n# \u6210\u4ea4\u91cf\u6307\u6a19\nobv = talib.OBV(close, volume)\n</code></pre>"},{"location":"blocks/technicals/#3-record-","title":"3. record() - \u8a18\u9304\u8b8a\u6578","text":"<pre><code># \u8a18\u9304\u95dc\u9375\u8b8a\u6578\uff0c\u7528\u65bc\u5f8c\u7e8c\u5206\u6790\nrecord(\n    price=current_price,\n    macd_dif=dif[-1],\n    macd_signal=macd[-1],\n    buy_signal=buy,\n    sell_signal=sell\n)\n\n# \u56de\u6e2c\u5f8c\u53ef\u4ee5\u5f9e results \u53d6\u5f97\nresults['price'].plot()\nresults['macd_dif'].plot()\n</code></pre>"},{"location":"blocks/technicals/#_18","title":"\u26a0\ufe0f \u5e38\u898b\u9677\u9631","text":""},{"location":"blocks/technicals/#1_3","title":"\u9677\u9631 1\uff1a\u5fd8\u8a18\u6aa2\u67e5\u8cc7\u6599\u5b8c\u6574\u6027","text":"<pre><code># \u274c \u932f\u8aa4\ntrailing_window = data.history(context.sym, 'price', 35, '1d')\nema = talib.EMA(trailing_window.values, timeperiod=12)\n\n# \u2705 \u6b63\u78ba\ntrailing_window = data.history(context.sym, 'price', 35, '1d')\nif trailing_window.isnull().values.any():\n    return  # \u8cc7\u6599\u4e0d\u8db3\uff0c\u8df3\u904e\nema = talib.EMA(trailing_window.values, timeperiod=12)\n</code></pre>"},{"location":"blocks/technicals/#2_1","title":"\u9677\u9631 2\uff1a\u7576\u5929\u8a08\u7b97\u7576\u5929\u4e0b\u55ae","text":"<pre><code># \u274c \u932f\u8aa4\uff1a\u7528\u4eca\u5929\u7684\u6307\u6a19\u505a\u6c7a\u7b56\uff0c\u4eca\u5929\u5c31\u4e0b\u55ae\ndef handle_data(context, data):\n    macd = calculate_macd(data.history(...))\n    if macd[-1] &gt; 0:\n        order(stock, 100)  # \u9019\u662f\u7528\u4eca\u5929\u7684 macd\uff0c\u4eca\u5929\u4e0b\u55ae\uff01\n\n# \u2705 \u6b63\u78ba\uff1a\u7528\u6628\u5929\u7684\u6307\u6a19\u5224\u65b7\uff0c\u4eca\u5929\u4e0b\u55ae\ndef handle_data(context, data):\n    macd = calculate_macd(data.history(...))\n    if (macd[-2] &lt; 0) and (macd[-1] &gt; 0):  # \u6628\u5929 &lt; 0\uff0c\u4eca\u5929 &gt; 0\n        order(stock, 100)  # \u4eca\u5929\u4e0b\u55ae\n</code></pre>"},{"location":"blocks/technicals/#3_3","title":"\u9677\u9631 3\uff1a\u904e\u5ea6\u4ea4\u6613","text":"<pre><code># \u274c \u932f\u8aa4\uff1a\u6bcf\u6b21\u8a0a\u865f\u90fd\u4ea4\u6613\nif macd_signal:\n    order_target(stock, 1000)\n# \u2192 \u53ef\u80fd\u6bcf\u5929\u90fd\u5728\u8cb7\u8ce3\n\n# \u2705 \u6b63\u78ba\uff1a\u52a0\u5165\u51b7\u537b\u671f\nif macd_signal and (context.i - context.last_trade &gt; 5):\n    order_target(stock, 1000)\n    context.last_trade = context.i\n</code></pre>"},{"location":"blocks/technicals/#_19","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6a21\u677f\u9801\u9762\uff1atemplate.md</li> <li>\u6848\u4f8b\u5b78\u7fd2\uff1a</li> <li>MACD \u7b56\u7565 - \u7d93\u5178\u96d9\u7dda\u4ea4\u53c9</li> <li>\u4e56\u96e2\u7387\u7b56\u7565 - \u5747\u7dda\u504f\u96e2\u5ea6</li> <li>\u5e03\u6797\u901a\u9053\u7b56\u7565 - \u7d71\u8a08\u901a\u9053\u7a81\u7834</li> <li>\u5e38\u898b\u554f\u984c\uff1afaq.md</li> </ul>"},{"location":"blocks/technicals/#_20","title":"\ud83d\udca1 \u7e3d\u7d50","text":"<p>\u6280\u8853\u6307\u6a19\u67b6\u69cb\u9069\u5408\uff1a</p> <ul> <li>\ud83d\udcc8 \u6280\u8853\u5206\u6790\u611b\u597d\u8005</li> <li>\ud83c\udfaf \u5c11\u6578\u6a19\u7684\u4ea4\u6613\uff081-10 \u6a94\uff09</li> <li>\u26a1 \u9700\u8981\u9748\u6d3b\u8abf\u6574\u908f\u8f2f</li> <li>\ud83d\udd04 \u65e5\u983b\u6216\u9031\u983b\u4ea4\u6613</li> </ul> <p>\u6838\u5fc3\u512a\u52e2\uff1a</p> <ol> <li>\u2705 \u908f\u8f2f\u76f4\u89c0\uff08\u8207\u624b\u52d5\u770b\u76e4\u4e00\u81f4\uff09</li> <li>\u2705 \u5f48\u6027\u6975\u9ad8\uff08\u53ef\u5be6\u73fe\u4efb\u610f\u8907\u96dc\u908f\u8f2f\uff09</li> <li>\u2705 Debug \u5bb9\u6613\uff08\u96a8\u6642\u5370\u51fa\u72c0\u614b\uff09</li> </ol> <p>\u4f7f\u7528\u9650\u5236\uff1a</p> <ol> <li>\u26a0\ufe0f \u80a1\u7968\u6578\u91cf\u6709\u9650\uff08&lt;10 \u6a94\uff09</li> <li>\u26a0\ufe0f \u9700\u6ce8\u610f\u904e\u5ea6\u4ea4\u6613</li> <li>\u26a0\ufe0f \u53c3\u6578\u654f\u611f\u6027\u9ad8</li> </ol> <p>\ud83d\udc49 Next Step: \u524d\u5f80 template.md \u958b\u59cb\u958b\u767c\u4f60\u7684\u6280\u8853\u6307\u6a19\u7b56\u7565\uff01</p>"},{"location":"blocks/technicals/case-bias/","title":"\u6848\u4f8b 2\uff1a\u4e56\u96e2\u7387\uff08BIAS\uff09\u7b56\u7565","text":"<p>\u7b56\u7565\u985e\u578b\uff1a \u6280\u8853\u6307\u6a19\u67b6\u69cb - \u53cd\u8f49\u7b56\u7565 \u4ea4\u6613\u6a19\u7684\uff1a \u53f0\u7a4d\u96fb\uff082330\uff09 \u8abf\u5009\u983b\u7387\uff1a \u8a0a\u865f\u89f8\u767c\u6642\uff08\u4e0d\u5b9a\u671f\uff09 \u56de\u6e2c\u671f\u9593\uff1a 2015-01-06 ~ 2022-11-25</p>"},{"location":"blocks/technicals/case-bias/#_1","title":"\ud83d\udccc \u7b56\u7565\u6982\u8ff0","text":"<p>\u4e56\u96e2\u7387\uff08BIAS\uff0cBias Ratio\uff09\u662f\u8861\u91cf\u80a1\u50f9\u504f\u96e2\u79fb\u52d5\u5e73\u5747\u7dda\u7a0b\u5ea6\u7684\u6307\u6a19\uff0c\u7531\u65e5\u672c\u6280\u8853\u5206\u6790\u5927\u5e2b\u300c\u9152\u7530\u4e94\u6cd5\u300d\u7684\u5275\u59cb\u4eba\u672c\u9593\u5b97\u4e45\u6240\u555f\u767c\u3002</p>"},{"location":"blocks/technicals/case-bias/#_2","title":"\u6838\u5fc3\u7406\u5ff5","text":"<p>\"Prices tend to revert to the mean.\" \u50f9\u683c\u50be\u5411\u65bc\u56de\u6b78\u5747\u503c\u3002</p> <p>\u7576\u80a1\u50f9\u904e\u5ea6\u504f\u96e2\u5747\u7dda\u6642\uff0c\u5e02\u5834\u6703\u7522\u751f **\u4fee\u6b63\u529b\u91cf* \uff0c\u5c07\u50f9\u683c\u62c9\u56de\u5747\u7dda\u9644\u8fd1\u3002\u9019\u7a2e\u300c\u5747\u503c\u56de\u6b78\u300d\u7279\u6027\u662f\u4e56\u96e2\u7387\u7b56\u7565\u7684\u57fa\u790e\u3002</p>"},{"location":"blocks/technicals/case-bias/#_3","title":"\u7b56\u7565\u7279\u8272","text":"<ol> <li>\u9006\u52e2\u4ea4\u6613\uff1a\u5728\u5e02\u5834\u6050\u614c\u6642\u8cb7\u5165\uff0c\u5728\u8caa\u5a6a\u6642\u8ce3\u51fa</li> <li>\u96d9\u91cd\u904e\u6ffe\uff1a\u4e56\u96e2\u7387 + \u50f9\u683c\u7a81\u7834\uff087 \u65e5\u9ad8\u4f4e\u9ede\uff09</li> <li>\u77ed\u7dda\u64cd\u4f5c\uff1a\u9069\u5408 3-10 \u5929\u7684\u6ce2\u6bb5</li> <li>\u98a8\u96aa\u53ef\u63a7\uff1a\u6709\u660e\u78ba\u7684\u9032\u51fa\u5834\u689d\u4ef6</li> </ol>"},{"location":"blocks/technicals/case-bias/#_4","title":"\ud83c\udfaf \u4e56\u96e2\u7387\u6307\u6a19\u8a73\u89e3","text":""},{"location":"blocks/technicals/case-bias/#_5","title":"\u8a08\u7b97\u516c\u5f0f","text":"<pre><code>BIAS = ((\u7576\u524d\u50f9\u683c - \u79fb\u52d5\u5e73\u5747\u7dda) / \u79fb\u52d5\u5e73\u5747\u7dda) \u00d7 100%\n\n\u6216\u7c21\u5316\u70ba\uff1a\nBIAS = (\u6536\u76e4\u50f9 / EMA) - 1\n</code></pre> <p>\u7bc4\u4f8b\uff1a</p> <ul> <li>\u6536\u76e4\u50f9 = 550 \u5143</li> <li>7 \u65e5 EMA = 500 \u5143</li> <li>BIAS = (550 / 500 - 1) \u00d7 100% = 10%</li> </ul>"},{"location":"blocks/technicals/case-bias/#_6","title":"\u8a0a\u865f\u89e3\u8b80","text":"<pre><code>graph TD\n    A[\u4e56\u96e2\u7387] --&gt; B{BIAS \u503c}\n\n    B --&gt;|BIAS &lt; -5%| C[\u8ca0\u4e56\u96e2&lt;br/&gt;\u80a1\u50f9\u88ab\u4f4e\u4f30]\n    B --&gt;|-5% ~ +5%| D[\u6b63\u5e38\u7bc4\u570d&lt;br/&gt;\u6301\u6709\u6216\u89c0\u671b]\n    B --&gt;|BIAS &gt; +5%| E[\u6b63\u4e56\u96e2&lt;br/&gt;\u80a1\u50f9\u88ab\u9ad8\u4f30]\n\n    C --&gt; F{\u914d\u5408\u50f9\u683c\u7a81\u7834?}\n    E --&gt; G{\u914d\u5408\u50f9\u683c\u7a81\u7834?}\n\n    F --&gt;|\u8dcc\u7834 7 \u65e5\u4f4e\u9ede| H[\u2705 \u5f37\u70c8\u8cb7\u5165\u8a0a\u865f&lt;br/&gt;\u96d9\u91cd\u78ba\u8a8d]\n    G --&gt;|\u7a81\u7834 7 \u65e5\u9ad8\u9ede| I[\u274c \u5f37\u70c8\u8ce3\u51fa\u8a0a\u865f&lt;br/&gt;\u96d9\u91cd\u78ba\u8a8d]\n\n    style H fill:#c8e6c9,stroke:#388e3c,stroke-width:3px\n    style I fill:#ffcdd2,stroke:#c62828,stroke-width:3px</code></pre> <p>\u53c3\u6578\u8aaa\u660e\uff1a</p> <ul> <li>7 \u65e5 EMA\uff1a\u77ed\u671f\u5747\u7dda\uff0c\u53cd\u61c9\u5feb\u901f</li> <li>\u00b15%\uff1a\u4e56\u96e2\u9580\u6abb\uff08\u53ef\u4f9d\u80a1\u7968\u6ce2\u52d5\u6027\u8abf\u6574\uff09</li> <li>7 \u65e5\u9ad8\u4f4e\u9ede\uff1a\u77ed\u671f\u652f\u6490\u58d3\u529b</li> </ul>"},{"location":"blocks/technicals/case-bias/#_7","title":"\ud83d\udd0d \u4ea4\u6613\u908f\u8f2f\u8a73\u89e3","text":""},{"location":"blocks/technicals/case-bias/#_8","title":"\u8cb7\u5165\u8a0a\u865f\uff08\u8d85\u8dcc\u53cd\u5f48\uff09","text":"<p>\u689d\u4ef6\uff08\u5fc5\u9808\u540c\u6642\u6eff\u8db3\uff09\uff1a</p> <ol> <li>\u6536\u76e4\u50f9 &lt; \u904e\u53bb 7 \u65e5\u6700\u4f4e\u50f9\uff08<code>close &lt; lowestlow</code>\uff09</li> <li>\u8ca0\u4e56\u96e2\uff08<code>bias &lt; 0</code>\uff09</li> <li>\u76ee\u524d\u7121\u6301\u5009</li> </ol> <p>\u610f\u7fa9\uff1a</p> <ul> <li>\u8dcc\u7834 7 \u65e5\u4f4e\u9ede\uff1a\u5e02\u5834\u6050\u614c\uff0c\u77ed\u671f\u8d85\u8ce3</li> <li>\u8ca0\u4e56\u96e2\uff1a\u50f9\u683c\u504f\u96e2\u5747\u7dda\u5411\u4e0b</li> <li>\u96d9\u91cd\u78ba\u8a8d\uff1a\u964d\u4f4e\u5047\u8a0a\u865f <pre><code># \u8cb7\u5165\u908f\u8f2f\ncondition1 = (close &lt; lowestlow) and (bias &lt; 0)\n\nif condition1 and (residual_position == 0):\n    order(stock, 10)  # \u8cb7\u5165 10 \u80a1\n</code></pre></li> </ul>"},{"location":"blocks/technicals/case-bias/#_9","title":"\u8ce3\u51fa\u8a0a\u865f\uff08\u8d85\u6f32\u56de\u843d\uff09","text":"<p>\u689d\u4ef6\uff08\u5fc5\u9808\u540c\u6642\u6eff\u8db3\uff09\uff1a</p> <ol> <li>\u6536\u76e4\u50f9 &gt; \u904e\u53bb 7 \u65e5\u6700\u9ad8\u50f9\uff08<code>close &gt; highesthigh</code>\uff09</li> <li>\u6b63\u4e56\u96e2\uff08<code>bias &gt; 0</code>\uff09</li> <li>\u76ee\u524d\u6709\u6301\u5009</li> </ol> <p>\u610f\u7fa9\uff1a</p> <ul> <li>\u7a81\u7834 7 \u65e5\u9ad8\u9ede\uff1a\u5e02\u5834\u904e\u71b1\uff0c\u77ed\u671f\u8d85\u8cb7</li> <li>\u6b63\u4e56\u96e2\uff1a\u50f9\u683c\u504f\u96e2\u5747\u7dda\u5411\u4e0a</li> <li>\u7372\u5229\u4e86\u7d50\uff1a\u4fdd\u8b77\u5229\u6f64 <pre><code># \u8ce3\u51fa\u908f\u8f2f\ncondition2 = (close &gt; highesthigh) and (bias &gt; 0) and (residual_position &gt; 0)\n\nif condition2:\n    order_target(stock, 0)  # \u6e05\u7a7a\u90e8\u4f4d\n</code></pre></li> </ul>"},{"location":"blocks/technicals/case-bias/#_10","title":"\ud83d\udcbb \u5b8c\u6574\u7a0b\u5f0f\u78bc","text":"<pre><code># ====================================\n# \u4e56\u96e2\u7387\u7b56\u7565 - \u5b8c\u6574\u5be6\u4f5c\n# ====================================\nimport os\nimport pandas as pd\nimport numpy as np\nimport tejapi\nimport matplotlib.pyplot as plt\n\n\n# ====================================\n# TEJ API \u8a2d\u5b9a\n# ====================================\nos.environ['TEJAPI_BASE'] = 'https://api.tej.com.tw'\nos.environ['TEJAPI_KEY'] = 'your_key'\n\n# ====================================\n# \u53c3\u6578\u8a2d\u5b9a\n# ====================================\nstart_date = '2015-01-06'\nend_date = '2022-11-25'\nticker = '2330'  # \u53f0\u7a4d\u96fb\n\n# \u8a2d\u5b9a\u74b0\u5883\u8b8a\u6578\nos.environ['mdate'] = f'{start_date} {end_date}'\nos.environ['ticker'] = ticker\n\n# ====================================\n# \u57f7\u884c\u8cc7\u6599\u532f\u5165 (Ingest)\n# ====================================\nfrom zipline.data.run_ingest import simple_ingest\n\nprint(f\"\u958b\u59cb\u532f\u5165\u8cc7\u6599\uff1a{ticker_list}\")\nprint(f\"\u671f\u9593\uff1a{start_date} ~ {end_date}\")\n\nsimple_ingest(\n    name='tquant',               # Bundle \u540d\u7a31\n    tickers=ticker,         # \u80a1\u7968\u6e05\u55ae (\u5fc5\u9808\u662f List)\n    start_date=start_date.replace('-', ''), # \u683c\u5f0f\u901a\u5e38\u5efa\u8b70 YYYYMMDD\n    end_date=end_date.replace('-', '')\n)\n\nprint(\"\u8cc7\u6599\u532f\u5165\u5b8c\u6210\uff01\")\n\n# ====================================\n# Pipeline \u5b9a\u7fa9\uff08\u8a08\u7b97\u4e56\u96e2\u7387\u8207\u9ad8\u4f4e\u9ede\uff09\n# ====================================\nfrom zipline.pipeline import CustomFactor, Pipeline\nfrom zipline.pipeline.data import EquityPricing\nfrom zipline.pipeline.factors import ExponentialWeightedMovingAverage\n\nclass NdaysMaxHigh(CustomFactor):\n    \"\"\"\u8a08\u7b97\u904e\u53bb N \u5929\u6700\u9ad8\u50f9\uff08\u4e0d\u542b\u4eca\u65e5\uff09\"\"\"\n    def compute(self, today, assets, out, data):\n        out[:] = np.nanmax(data[:-2], axis=0)\n\nclass NdaysMinLow(CustomFactor):\n    \"\"\"\u8a08\u7b97\u904e\u53bb N \u5929\u6700\u4f4e\u50f9\uff08\u4e0d\u542b\u4eca\u65e5\uff09\"\"\"\n    def compute(self, today, assets, out, data):\n        out[:] = np.nanmin(data[:-2], axis=0)\n\ndef make_pipeline():\n    \"\"\"\n    \u5efa\u7acb Pipeline\n\n    \u8f38\u51fa\uff1a\n    - ema: 7 \u65e5\u6307\u6578\u79fb\u52d5\u5e73\u5747\n    - highesthigh: \u904e\u53bb 7 \u65e5\u6700\u9ad8\u50f9\n    - lowestlow: \u904e\u53bb 7 \u65e5\u6700\u4f4e\u50f9\n    - latest: \u7576\u65e5\u6536\u76e4\u50f9\n    \"\"\"\n    # 7 \u65e5 EMA\n    ema = ExponentialWeightedMovingAverage(\n        inputs=[EquityPricing.close],\n        window_length=7,\n        decay_rate=1/7\n    )\n\n    # \u904e\u53bb 7 \u65e5\u6700\u9ad8\u50f9\uff08window_length=8 \u56e0\u70ba\u8981\u6392\u9664\u4eca\u65e5\uff09\n    high = NdaysMaxHigh(\n        inputs=[EquityPricing.close],\n        window_length=8\n    )\n\n    # \u904e\u53bb 7 \u65e5\u6700\u4f4e\u50f9\n    low = NdaysMinLow(\n        inputs=[EquityPricing.close],\n        window_length=8\n    )\n\n    # \u7576\u65e5\u6536\u76e4\u50f9\n    close = EquityPricing.close.latest\n\n    return Pipeline(\n        columns={\n            'ema': ema,\n            'highesthigh': high,\n            'lowestlow': low,\n            'latest': close\n        }\n    )\n\n# ====================================\n# \u7b56\u7565\u51fd\u6578\u5b9a\u7fa9\n# ====================================\nfrom zipline.api import (\n    set_slippage, set_commission, set_benchmark,\n    attach_pipeline, pipeline_output,\n    symbol, record, order, order_target\n)\nfrom zipline.finance import commission, slippage\n\ndef initialize(context):\n    \"\"\"\n    \u521d\u59cb\u5316\u51fd\u6578\n    \"\"\"\n    # \u4ea4\u6613\u6210\u672c\u8a2d\u5b9a\n    set_slippage(slippage.VolumeShareSlippage())\n    set_commission(commission.PerShare(cost=0.001425))\n\n    # \u8a2d\u5b9a\u57fa\u6e96\n    set_benchmark(symbol(ticker))\n\n    # \u9644\u52a0 Pipeline\n    attach_pipeline(make_pipeline(), 'mystrategy')\n\ndef handle_data(context, data):\n    \"\"\"\n    \u6bcf\u65e5\u57f7\u884c\u51fd\u6578\n\n    \u6d41\u7a0b\uff1a\n    1. \u5f9e Pipeline \u53d6\u5f97\u8a08\u7b97\u597d\u7684\u6307\u6a19\n    2. \u8a08\u7b97\u4e56\u96e2\u7387\n    3. \u5224\u65b7\u9032\u51fa\u5834\u8a0a\u865f\n    4. \u57f7\u884c\u4ea4\u6613\n    \"\"\"\n    # ========================================\n    # Step 1: \u53d6\u5f97 Pipeline \u8f38\u51fa\n    # ========================================\n    pipe = pipeline_output('mystrategy')\n\n    # ========================================\n    # Step 2: \u904d\u6b77\u6bcf\u6a94\u80a1\u7968\uff08\u672c\u4f8b\u53ea\u6709\u4e00\u6a94\uff09\n    # ========================================\n    for stock in pipe.index:\n        # \u53d6\u5f97\u6307\u6a19\u503c\n        ema = pipe.loc[stock, 'ema']\n        highesthigh = pipe.loc[stock, 'highesthigh']\n        lowestlow = pipe.loc[stock, 'lowestlow']\n        close = pipe.loc[stock, 'latest']\n\n        # \u8a08\u7b97\u4e56\u96e2\u7387\n        bias = close - ema\n\n        # \u53d6\u5f97\u7576\u524d\u6301\u5009\n        residual_position = context.portfolio.positions[stock].amount\n\n        # ========================================\n        # Step 3: \u8a0a\u865f\u5224\u65b7\n        # ========================================\n        # \u8cb7\u5165\u689d\u4ef6\uff1a\u8dcc\u7834 7 \u65e5\u4f4e\u9ede + \u8ca0\u4e56\u96e2\n        condition1 = (close &lt; lowestlow) and (bias &lt; 0)\n\n        # \u8ce3\u51fa\u689d\u4ef6\uff1a\u7a81\u7834 7 \u65e5\u9ad8\u9ede + \u6b63\u4e56\u96e2 + \u6709\u6301\u5009\n        condition2 = (close &gt; highesthigh) and (bias &gt; 0) and (residual_position &gt; 0)\n\n        # ========================================\n        # Step 4: \u8a18\u9304\u8b8a\u6578\uff08\u7528\u65bc\u5206\u6790\uff09\n        # ========================================\n        record(\n            con1=condition1,\n            con2=condition2,\n            price=close,\n            ema=ema,\n            bias=bias,\n            highesthigh=highesthigh,\n            lowestlow=lowestlow\n        )\n\n        # ========================================\n        # Step 5: \u57f7\u884c\u4ea4\u6613\n        # ========================================\n        if condition1:\n            # \u8cb7\u5165\u8a0a\u865f\n            order(stock, 10)\n            print(f\"[{data.current_dt.date()}] \u8cb7\u5165\u8a0a\u865f\")\n            print(f\"  \u50f9\u683c: {close:.2f}, EMA: {ema:.2f}, \u4e56\u96e2: {bias:.2f}\")\n            print(f\"  7\u65e5\u4f4e\u9ede: {lowestlow:.2f}\")\n\n        elif condition2:\n            # \u8ce3\u51fa\u8a0a\u865f\n            order_target(stock, 0)\n            print(f\"[{data.current_dt.date()}] \u8ce3\u51fa\u8a0a\u865f\")\n            print(f\"  \u50f9\u683c: {close:.2f}, EMA: {ema:.2f}, \u4e56\u96e2: {bias:.2f}\")\n            print(f\"  7\u65e5\u9ad8\u9ede: {highesthigh:.2f}\")\n\ndef analyze(context, perf):\n    \"\"\"\n    \u7e3e\u6548\u5206\u6790\u8207\u8996\u89ba\u5316\n    \"\"\"\n    import matplotlib.pyplot as plt\n\n    fig = plt.figure(figsize=(18, 10))\n\n    # ========================================\n    # \u4e0a\u5716\uff1a\u6295\u8cc7\u7d44\u5408\u50f9\u503c\n    # ========================================\n    ax1 = fig.add_subplot(211)\n    perf['portfolio_value'].plot(ax=ax1, linewidth=2)\n    ax1.set_ylabel(\"Portfolio Value (TWD)\", fontsize=12)\n    ax1.set_title(\"BIAS Strategy - Portfolio Performance\", fontsize=14, fontweight='bold')\n    ax1.grid(True, alpha=0.3)\n\n    # ========================================\n    # \u4e0b\u5716\uff1a\u50f9\u683c + \u6307\u6a19 + \u8cb7\u8ce3\u9ede\n    # ========================================\n    ax2 = fig.add_subplot(212)\n\n    # \u7e6a\u88fd\u50f9\u683c\n    perf['price'].plot(ax=ax2, label='Price', linewidth=2, color='black')\n\n    # \u7e6a\u88fd 7 \u65e5 EMA\n    perf['ema'].plot(ax=ax2, label='7-day EMA', linewidth=1.5, color='blue', alpha=0.7)\n\n    # \u7e6a\u88fd 7 \u65e5\u9ad8\u4f4e\u9ede\n    perf['highesthigh'].plot(ax=ax2, label='7-day High', linewidth=1, color='red', alpha=0.5, linestyle='--')\n    perf['lowestlow'].plot(ax=ax2, label='7-day Low', linewidth=1, color='green', alpha=0.5, linestyle='--')\n\n    # \u6a19\u8a18\u8cb7\u5165\u9ede\n    buy_signals = perf[perf['con1'] == True]  # \u6ce8\u610f\uff1acon2 \u662f\u8cb7\u5165\u8a0a\u865f\n    ax2.plot(\n        buy_signals.index,\n        buy_signals['price'],\n        '^',\n        markersize=10,\n        color='green',\n        label='Buy Signal',\n        markeredgewidth=2,\n        markeredgecolor='darkgreen'\n    )\n\n    # \u6a19\u8a18\u8ce3\u51fa\u9ede\n    sell_signals = perf[perf['con2'] == True]  # \u6ce8\u610f\uff1acon1 \u662f\u8ce3\u51fa\u8a0a\u865f\n    ax2.plot(\n        sell_signals.index,\n        sell_signals['price'],\n        'v',\n        markersize=10,\n        color='red',\n        label='Sell Signal',\n        markeredgewidth=2,\n        markeredgecolor='darkred'\n    )\n\n    ax2.set_ylabel(\"Price (TWD)\", fontsize=12)\n    ax2.set_xlabel(\"Date\", fontsize=12)\n    ax2.set_title(\"Price Chart with BIAS Signals\", fontsize=14, fontweight='bold')\n    ax2.legend(loc='upper left', fontsize=10)\n    ax2.grid(True, alpha=0.3)\n\n    plt.tight_layout()\n    plt.show()\n\n# ====================================\n# \u57f7\u884c\u56de\u6e2c\n# ====================================\nfrom zipline import run_algorithm\n\nprint(\"=\"*60)\nprint(\"\u958b\u59cb\u56de\u6e2c\u4e56\u96e2\u7387\u7b56\u7565\")\nprint(f\"\u6a19\u7684\uff1a{ticker}\")\nprint(f\"\u671f\u9593\uff1a{start_date} ~ {end_date}\")\nprint(\"=\"*60)\n\nresults = run_algorithm(\n    start=pd.Timestamp(start_date, tz='UTC'),\n    end=pd.Timestamp(end_date, tz='UTC'),\n    initialize=initialize,\n    bundle='tquant',\n    analyze=analyze,\n    capital_base=1e7,\n    handle_data=handle_data\n)\n\nprint(\"\\n\u56de\u6e2c\u5b8c\u6210\uff01\")\n\n# ====================================\n# Pyfolio \u7e3e\u6548\u5206\u6790\n# ====================================\ntry:\n    import pyfolio as pf\n    from pyfolio.utils import extract_rets_pos_txn_from_zipline\n\n    returns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\n    benchmark_rets = results.benchmark_return\n\n    print(\"------ \u5927\u76e4\u7e3e\u6548\u6307\u6a19 ------\")\n    pf.show_perf_stats(benchmark_rets)\n\n    print(\"------ \u7b56\u7565\u7e3e\u6548 ------\")\n    pf.tears.create_full_tear_sheet(\n        returns=returns,\n        positions=positions,\n        transactions=transactions,\n        benchmark_rets=benchmark_rets\n    )\n\nexcept ImportError:\n    print(\"\u672a\u5b89\u88dd pyfolio\uff0c\u7565\u904e\u8a73\u7d30\u5206\u6790\")\n    print(\"\u82e5\u9700\u5b8c\u6574\u5831\u544a\uff0c\u8acb\u57f7\u884c: pip install pyfolio\")\nexcept Exception as e:\n    print(f\"Pyfolio \u5206\u6790\u932f\u8aa4: {e}\")\n</code></pre>"},{"location":"blocks/technicals/case-bias/#_11","title":"\ud83d\udcca \u56de\u6e2c\u7d50\u679c\u5206\u6790","text":""},{"location":"blocks/technicals/case-bias/#_12","title":"\u512a\u52e2 \u2705","text":"<ol> <li> <p>\u6293\u4f4f\u77ed\u671f\u53cd\u5f48</p> <ul> <li>\u5728\u6050\u614c\u6642\u8cb7\u5165\uff0c\u7372\u53d6\u53cd\u5f48\u5229\u6f64</li> <li>\u9069\u5408\u6ce2\u52d5\u8f03\u5927\u7684\u80a1\u7968</li> </ul> </li> <li> <p>\u4ea4\u6613\u6b21\u6578\u9069\u4e2d</p> <ul> <li>\u4e0d\u6703\u904e\u5ea6\u4ea4\u6613</li> <li>\u964d\u4f4e\u4ea4\u6613\u6210\u672c</li> </ul> </li> <li> <p>\u98a8\u96aa\u5206\u6563</p> <ul> <li>\u6bcf\u6b21\u8cb7\u5165\u80a1\u6578\u56fa\u5b9a</li> <li>\u4e0d\u6703\u4e00\u6b21\u6295\u5165\u904e\u591a\u8cc7\u91d1</li> </ul> </li> <li> <p>\u908f\u8f2f\u7c21\u55ae</p> <ul> <li>\u8a0a\u865f\u660e\u78ba</li> <li>\u5bb9\u6613\u57f7\u884c</li> </ul> </li> </ol>"},{"location":"blocks/technicals/case-bias/#_13","title":"\u52a3\u52e2 \u26a0\ufe0f","text":"<ol> <li> <p>\u8da8\u52e2\u5e02\u5834\u8868\u73fe\u5dee</p> <ul> <li>\u55ae\u908a\u4e0a\u6f32\u6642\u983b\u7e41\u8ce3\u51fa</li> <li>\u932f\u904e\u5927\u6ce2\u6bb5\u884c\u60c5</li> </ul> </li> <li> <p>\u53ef\u80fd\u8cb7\u5728\u4e0b\u8dcc\u9014\u4e2d</p> <ul> <li>\u300c\u63a5\u843d\u4e0b\u7684\u5200\u300d\u98a8\u96aa</li> <li>\u9700\u8981\u56b4\u683c\u505c\u640d</li> </ul> </li> <li> <p>\u53c3\u6578\u654f\u611f</p> <ul> <li>\u4e0d\u540c\u80a1\u7968\u9700\u8981\u4e0d\u540c\u7684\u4e56\u96e2\u9580\u6abb</li> <li>\u9700\u8981\u8abf\u6574\u512a\u5316</li> </ul> </li> </ol>"},{"location":"blocks/technicals/case-bias/#_14","title":"\ud83d\udd0d \u95dc\u9375\u5b78\u7fd2\u9ede","text":""},{"location":"blocks/technicals/case-bias/#1-window_length8","title":"1. \u70ba\u4ec0\u9ebc\u7528 window_length=8\uff1f","text":"<pre><code># \u8a08\u7b97\u904e\u53bb 7 \u65e5\u6700\u9ad8\u50f9\nhigh = NdaysMaxHigh(\n    inputs=[EquityPricing.close],\n    window_length=8  # \u70ba\u4ec0\u9ebc\u662f 8 \u4e0d\u662f 7\uff1f\n)\n\ndef compute(self, today, assets, out, data):\n    out[:] = np.nanmax(data[:-2], axis=0)  # \u6392\u9664\u6700\u5f8c\u5169\u5929\n</code></pre> <p>\u539f\u56e0\uff1a</p> <ul> <li><code>data</code> \u5305\u542b\u4eca\u5929\u7684\u8cc7\u6599</li> <li><code>data[:-2]</code> \u6392\u9664\u4eca\u5929\u548c\u6628\u5929</li> <li>\u6240\u4ee5 window_length=8 \u624d\u80fd\u62ff\u5230\u300c\u904e\u53bb 7 \u65e5\u300d\u7684\u8cc7\u6599\uff08\u4e0d\u542b\u4eca\u65e5\uff09</li> </ul>"},{"location":"blocks/technicals/case-bias/#2-pipeline-vs-handle_data","title":"2. Pipeline vs handle_data \u7684\u5206\u5de5","text":"<pre><code># Pipeline\uff1a\u4e8b\u524d\u8a08\u7b97\uff08\u76e4\u524d\uff09\ndef make_pipeline():\n    ema = ExponentialWeightedMovingAverage(...)\n    return Pipeline(columns={'ema': ema})\n\n# handle_data\uff1a\u4e8b\u4e2d\u5224\u65b7\uff08\u76e4\u4e2d\uff09\ndef handle_data(context, data):\n    pipe = pipeline_output('mystrategy')\n    ema = pipe.loc[stock, 'ema']  # \u76f4\u63a5\u53d6\u7528\n\n    if close &lt; ema:  # \u5224\u65b7\u908f\u8f2f\n        order(stock, 10)\n</code></pre> <p>\u70ba\u4ec0\u9ebc\u9019\u6a23\u5206\u5de5\uff1f</p> <ul> <li>Pipeline \u9069\u5408\u8a08\u7b97\u56fa\u5b9a\u908f\u8f2f\uff08EMA\u3001\u6700\u9ad8\u4f4e\u9ede\uff09</li> <li>handle_data \u9069\u5408\u52d5\u614b\u5224\u65b7\uff08\u6839\u64da\u7576\u524d\u72c0\u614b\u6c7a\u7b56\uff09</li> </ul>"},{"location":"blocks/technicals/case-bias/#3-vs","title":"3. \u6bcf\u6b21\u8cb7\u5165\u56fa\u5b9a\u80a1\u6578 vs \u56fa\u5b9a\u91d1\u984d","text":"<pre><code># \u65b9\u6cd5 1: \u56fa\u5b9a\u80a1\u6578\uff08\u672c\u7b56\u7565\uff09\norder(stock, 10)  # \u6bcf\u6b21\u8cb7 10 \u80a1\n\n# \u65b9\u6cd5 2: \u56fa\u5b9a\u91d1\u984d\norder_value(stock, 10000)  # \u6bcf\u6b21\u8cb7 10,000 \u5143\n\n# \u65b9\u6cd5 3: \u56fa\u5b9a\u6bd4\u4f8b\norder_target_percent(stock, 0.1)  # \u6301\u5009\u4f54 10%\n</code></pre> <p>\u672c\u7b56\u7565\u9078\u64c7\u56fa\u5b9a\u80a1\u6578\u7684\u539f\u56e0\uff1a</p> <ul> <li>\u77ed\u7dda\u7b56\u7565\uff0c\u5feb\u9032\u5feb\u51fa</li> <li>\u907f\u514d\u90e8\u4f4d\u904e\u5927</li> <li>\u63a7\u5236\u98a8\u96aa</li> </ul>"},{"location":"blocks/technicals/case-bias/#4","title":"4. \u4e56\u96e2\u7387\u7684\u52d5\u614b\u9580\u6abb","text":"<pre><code># \u56fa\u5b9a\u9580\u6abb\uff08\u672c\u7b56\u7565\uff09\nif bias &lt; 0:  # \u53ea\u8981\u8ca0\u4e56\u96e2\u5c31\u8cb7\n\n# \u52d5\u614b\u9580\u6abb\uff08\u9032\u968e\u7248\uff09\nthreshold = -5  # -5% \u4ee5\u4e0b\u624d\u8cb7\nif bias &lt; threshold:\n    order(stock, 10)\n\n# \u6839\u64da\u6ce2\u52d5\u7387\u8abf\u6574\uff08\u6700\u9032\u968e\uff09\nstd = trailing_window.pct_change().std()\nthreshold = -2 * std  # \u8d85\u904e 2 \u500d\u6a19\u6e96\u5dee\nif bias &lt; threshold:\n    order(stock, 10)\n</code></pre>"},{"location":"blocks/technicals/case-bias/#_15","title":"\ud83c\udfaf \u5ef6\u4f38\u512a\u5316\u65b9\u5411","text":""},{"location":"blocks/technicals/case-bias/#1","title":"\u512a\u5316 1: \u52d5\u614b\u4e56\u96e2\u9580\u6abb","text":"<pre><code># \u6839\u64da\u6b77\u53f2\u6ce2\u52d5\u7387\u8abf\u6574\u9580\u6abb\ndef handle_data(context, data):\n    # \u8a08\u7b97\u904e\u53bb 20 \u65e5\u6ce2\u52d5\u7387\n    close_history = data.history(stock, 'close', 20, '1d')\n    volatility = close_history.pct_change().std()\n\n    # \u52d5\u614b\u9580\u6abb\n    buy_threshold = -2 * volatility\n    sell_threshold = 2 * volatility\n\n    if (bias &lt; buy_threshold) and (close &lt; lowestlow):\n        order(stock, 10)\n</code></pre>"},{"location":"blocks/technicals/case-bias/#2","title":"\u512a\u5316 2: \u52a0\u5165\u505c\u640d\u6a5f\u5236","text":"<pre><code>def initialize(context):\n    context.buy_price = {}\n\ndef handle_data(context, data):\n    # ... \u539f\u672c\u908f\u8f2f ...\n\n    if condition1:  # \u8cb7\u5165\n        order(stock, 10)\n        context.buy_price[stock] = close\n\n    # \u505c\u640d\uff1a\u8667\u640d\u8d85\u904e 5%\n    if stock in context.buy_price:\n        if close &lt; context.buy_price[stock] * 0.95:\n            order_target(stock, 0)\n            print(f\"\u505c\u640d\u51fa\u5834\")\n</code></pre>"},{"location":"blocks/technicals/case-bias/#3","title":"\u512a\u5316 3: \u5206\u6279\u9032\u5834","text":"<pre><code>def handle_data(context, data):\n    position = context.portfolio.positions[stock].amount\n\n    if (bias &lt; -3) and (close &lt; lowestlow):\n        if position == 0:\n            order(stock, 5)  # \u7b2c\u4e00\u6279\n\n    elif (bias &lt; -5) and (close &lt; lowestlow):\n        if position == 5:\n            order(stock, 5)  # \u7b2c\u4e8c\u6279\uff08\u52a0\u78bc\uff09\n</code></pre>"},{"location":"blocks/technicals/case-bias/#4_1","title":"\u512a\u5316 4: \u7d50\u5408\u8da8\u52e2\u904e\u6ffe","text":"<pre><code>def handle_data(context, data):\n    # \u53ea\u5728\u9577\u671f\u591a\u982d\u6642\u4f7f\u7528\n    ma60 = data.history(stock, 'close', 60, '1d').mean()\n\n    if close &gt; ma60:  # \u9577\u671f\u8da8\u52e2\u5411\u4e0a\n        if (bias &lt; 0) and (close &lt; lowestlow):\n            order(stock, 10)\n</code></pre>"},{"location":"blocks/technicals/case-bias/#5","title":"\u512a\u5316 5: \u6301\u6709\u6642\u9593\u9650\u5236","text":"<pre><code>def initialize(context):\n    context.holding_days = {}\n\ndef handle_data(context, data):\n    # \u8a18\u9304\u6301\u6709\u5929\u6578\n    if stock in context.portfolio.positions:\n        if stock not in context.holding_days:\n            context.holding_days[stock] = 0\n        context.holding_days[stock] += 1\n\n        # \u8d85\u904e 10 \u5929\u5f37\u5236\u51fa\u5834\n        if context.holding_days[stock] &gt; 10:\n            order_target(stock, 0)\n            context.holding_days[stock] = 0\n</code></pre>"},{"location":"blocks/technicals/case-bias/#_16","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6a21\u677f\u9801\u9762\uff1atemplate.md - \u53cd\u8f49\u7b56\u7565\u6a21\u677f</li> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md - \u7406\u89e3\u8a2d\u8a08\u539f\u7406</li> <li> <p>\u5176\u4ed6\u6848\u4f8b\uff1a</p> </li> <li> <p>MACD \u7b56\u7565 - \u96d9\u7dda\u4ea4\u53c9</p> </li> <li>\u5e03\u6797\u901a\u9053\u7b56\u7565 - \u7a81\u7834\u7b56\u7565</li> </ul>"},{"location":"blocks/technicals/case-bias/#_17","title":"\ud83d\udca1 \u7e3d\u7d50","text":"<p>\u4e56\u96e2\u7387\u7b56\u7565\u5c55\u793a\u4e86**\u53cd\u8f49\u4ea4\u6613**\u7684\u6838\u5fc3\u908f\u8f2f\uff1a</p> <ol> <li>\u2705 \u5747\u503c\u56de\u6b78\uff1a\u50f9\u683c\u504f\u96e2\u904e\u5ea6\u5fc5\u7136\u4fee\u6b63</li> <li>\u2705 \u96d9\u91cd\u78ba\u8a8d\uff1a\u4e56\u96e2 + \u7a81\u7834\u9ad8\u4f4e\u9ede</li> <li>\u2705 \u77ed\u7dda\u64cd\u4f5c\uff1a\u9069\u5408 3-10 \u5929\u6ce2\u6bb5</li> <li>\u2705 \u98a8\u96aa\u53ef\u63a7\uff1a\u56fa\u5b9a\u80a1\u6578\uff0c\u5206\u6279\u9032\u5834</li> </ol> <p>\u9069\u5408\u8ab0\u4f7f\u7528\uff1f</p> <ul> <li>\u77ed\u7dda\u4ea4\u6613\u8005</li> <li>\u504f\u597d\u9006\u52e2\u64cd\u4f5c</li> <li>\u80fd\u627f\u53d7\u983b\u7e41\u4ea4\u6613</li> </ul> <p>\u4f7f\u7528\u5efa\u8b70\uff1a</p> <ul> <li>\u2705 \u5728\u9707\u76ea\u5e02\u5834\u4f7f\u7528</li> <li>\u2705 \u642d\u914d\u505c\u640d\u6a5f\u5236</li> <li>\u26a0\ufe0f \u907f\u514d\u5728\u55ae\u908a\u8da8\u52e2\u4f7f\u7528</li> <li>\u26a0\ufe0f \u6ce8\u610f\u300c\u63a5\u843d\u4e0b\u7684\u5200\u300d\u98a8\u96aa</li> </ul> <p>\ud83d\udc49 Next Step:</p> <ol> <li>\u8907\u88fd\u5b8c\u6574\u7a0b\u5f0f\u78bc</li> <li>\u8abf\u6574\u4e56\u96e2\u9580\u6abb\uff08-5%, -3%, -10%\uff09</li> <li>\u6e2c\u8a66\u4e0d\u540c\u80a1\u7968</li> <li>\u52a0\u5165\u4f60\u7684\u512a\u5316\u908f\u8f2f</li> </ol>"},{"location":"blocks/technicals/case-bias/#_18","title":"\ud83d\udcd6 \u5ef6\u4f38\u95b1\u8b80","text":"<p>\u5747\u503c\u56de\u6b78\u7406\u8ad6\uff1a</p> <ul> <li>\u50f9\u683c\u6ce2\u52d5\u9075\u5faa\u5e38\u614b\u5206\u4f48</li> <li>\u6975\u7aef\u503c\u51fa\u73fe\u6a5f\u7387\u4f4e</li> <li>\u5e02\u5834\u6709\u81ea\u6211\u4fee\u6b63\u6a5f\u5236</li> </ul> <p>\u4e56\u96e2\u7387\u7684\u5be6\u52d9\u61c9\u7528\uff1a</p> <ul> <li>\u4e0d\u540c\u80a1\u7968\u6709\u4e0d\u540c\u7684\u5408\u7406\u4e56\u96e2\u7bc4\u570d</li> <li>\u9ad8\u6ce2\u52d5\u80a1\u7968\uff08\u79d1\u6280\u80a1\uff09\uff1a\u00b110%</li> <li>\u4f4e\u6ce2\u52d5\u80a1\u7968\uff08\u91d1\u878d\u80a1\uff09\uff1a\u00b15%</li> <li>\u9700\u8981\u6b77\u53f2\u56de\u6e2c\u627e\u51fa\u6700\u4f73\u9580\u6abb</li> </ul>"},{"location":"blocks/technicals/case-bollinger/","title":"\u6848\u4f8b 3\uff1a\u5e03\u6797\u901a\u9053\uff08Bollinger Bands\uff09\u7b56\u7565","text":"<p>\u7b56\u7565\u985e\u578b\uff1a \u6280\u8853\u6307\u6a19\u67b6\u69cb - \u7a81\u7834\u7b56\u7565 \u4ea4\u6613\u6a19\u7684\uff1a \u53cb\u9054\uff082409\uff09 \u8abf\u5009\u983b\u7387\uff1a \u8a0a\u865f\u89f8\u767c\u6642\uff08\u4e0d\u5b9a\u671f\uff09 \u56de\u6e2c\u671f\u9593\uff1a 2021-06-01 ~ 2022-12-31</p>"},{"location":"blocks/technicals/case-bollinger/#_1","title":"\ud83d\udccc \u7b56\u7565\u6982\u8ff0","text":"<p>\u5e03\u6797\u901a\u9053\uff08Bollinger Bands\uff09\u7531 John Bollinger \u65bc 1980 \u5e74\u4ee3\u767c\u660e\uff0c\u662f\u6700\u5ee3\u6cdb\u4f7f\u7528\u7684\u6280\u8853\u6307\u6a19\u4e4b\u4e00\u3002</p>"},{"location":"blocks/technicals/case-bollinger/#_2","title":"\u6838\u5fc3\u7406\u5ff5","text":"<p>\"Markets fluctuate within statistical boundaries.\" \u5e02\u5834\u5728\u7d71\u8a08\u908a\u754c\u5167\u6ce2\u52d5\u3002</p> <p>\u5e03\u6797\u901a\u9053\u5229\u7528 \u7d71\u8a08\u5b78\u7684\u5e38\u614b\u5206\u4f48\u7406\u8ad6 \uff1a\u5728\u5e38\u614b\u5206\u4f48\u4e0b\uff0c95.44% \u7684\u6a23\u672c\u6703\u843d\u5728\u6b63\u8ca0\u5169\u500b\u6a19\u6e96\u5dee\u5167\u3002\u7576\u80a1\u50f9\u8d85\u51fa\u9019\u500b\u7bc4\u570d\u6642\uff0c\u7522\u751f\u53cd\u8f49\u7684\u6a5f\u7387\u5927\u5e45\u4e0a\u5347\u3002</p>"},{"location":"blocks/technicals/case-bollinger/#_3","title":"\u7b56\u7565\u7279\u8272","text":"<ol> <li>\u7d71\u8a08\u5b78\u57fa\u790e\uff1a\u57fa\u65bc\u6a19\u6e96\u5dee\u8a08\u7b97\u901a\u9053\u5bec\u5ea6</li> <li>\u52d5\u614b\u8abf\u6574\uff1a\u901a\u9053\u96a8\u6ce2\u52d5\u7387\u81ea\u52d5\u64f4\u5f35\u6536\u7e2e</li> <li>\u53cd\u8f49\u4ea4\u6613\uff1a\u89f8\u78b0\u4e0a\u8ecc\u8ce3\u51fa\u3001\u4e0b\u8ecc\u8cb7\u5165</li> <li>\u52a0\u78bc\u6a5f\u5236\uff1a\u50f9\u683c\u6301\u7e8c\u4e0b\u8dcc\u6642\u5206\u6279\u52a0\u78bc</li> </ol>"},{"location":"blocks/technicals/case-bollinger/#_4","title":"\ud83c\udfaf \u5e03\u6797\u901a\u9053\u6307\u6a19\u8a73\u89e3","text":""},{"location":"blocks/technicals/case-bollinger/#_5","title":"\u8a08\u7b97\u516c\u5f0f","text":"<pre><code>\u4e2d\u8ecc\uff08Middle Band\uff09= 20 \u65e5\u7c21\u55ae\u79fb\u52d5\u5e73\u5747\u7dda\uff08SMA\uff09\n\n\u4e0a\u8ecc\uff08Upper Band\uff09= \u4e2d\u8ecc + (2 \u00d7 \u6a19\u6e96\u5dee)\n\n\u4e0b\u8ecc\uff08Lower Band\uff09= \u4e2d\u8ecc - (2 \u00d7 \u6a19\u6e96\u5dee)\n\n\u6a19\u6e96\u5dee\uff08STD\uff09= \u221a(\u03a3(\u6536\u76e4\u50f9 - \u4e2d\u8ecc)\u00b2 / 20)\n</code></pre> <p>\u53c3\u6578\u8aaa\u660e\uff1a</p> <ul> <li>20\uff1a\u79fb\u52d5\u5e73\u5747\u9031\u671f</li> <li>2\uff1a\u6a19\u6e96\u5dee\u500d\u6578\uff08K \u503c\uff09</li> </ul>"},{"location":"blocks/technicals/case-bollinger/#_6","title":"\u8996\u89ba\u5316\u89e3\u91cb","text":"<pre><code>graph TD\n    A[\u80a1\u50f9\u6ce2\u52d5] --&gt; B[\u5e03\u6797\u901a\u9053]\n\n    B --&gt; C[\u4e0a\u8ecc&lt;br/&gt;\u4e2d\u8ecc + 2\u03c3]\n    B --&gt; D[\u4e2d\u8ecc&lt;br/&gt;20\u65e5SMA]\n    B --&gt; E[\u4e0b\u8ecc&lt;br/&gt;\u4e2d\u8ecc - 2\u03c3]\n\n    C --&gt; F[\u50f9\u683c\u89f8\u78b0\u4e0a\u8ecc]\n    E --&gt; G[\u50f9\u683c\u89f8\u78b0\u4e0b\u8ecc]\n\n    F --&gt; H[\u274c \u8ce3\u51fa\u8a0a\u865f&lt;br/&gt;\u8d85\u8cb7\uff0c\u9810\u671f\u56de\u843d]\n    G --&gt; I[\u2705 \u8cb7\u5165\u8a0a\u865f&lt;br/&gt;\u8d85\u8ce3\uff0c\u9810\u671f\u53cd\u5f48]\n\n    style H fill:#ffcdd2,stroke:#c62828,stroke-width:3px\n    style I fill:#c8e6c9,stroke:#388e3c,stroke-width:3px</code></pre>"},{"location":"blocks/technicals/case-bollinger/#_7","title":"\u901a\u9053\u5bec\u5ea6\u7684\u610f\u7fa9","text":"<p>\u901a\u9053\u6536\u7e2e\uff08\u4f4e\u6ce2\u52d5\uff09\uff1a</p> <ul> <li>\u5e02\u5834\u5e73\u975c\uff0c\u919e\u91c0\u5927\u884c\u60c5</li> <li>\u5373\u5c07\u7a81\u7834\uff08\u65b9\u5411\u4e0d\u78ba\u5b9a\uff09</li> </ul> <p>\u901a\u9053\u64f4\u5f35\uff08\u9ad8\u6ce2\u52d5\uff09\uff1a</p> <ul> <li>\u5e02\u5834\u5287\u70c8\u6ce2\u52d5</li> <li>\u8da8\u52e2\u78ba\u7acb\u6216\u6050\u614c</li> </ul>"},{"location":"blocks/technicals/case-bollinger/#_8","title":"\ud83d\udd0d \u4ea4\u6613\u908f\u8f2f\u8a73\u89e3","text":""},{"location":"blocks/technicals/case-bollinger/#_9","title":"\u8cb7\u5165\u8a0a\u865f\uff08\u89f8\u78b0\u4e0b\u8ecc\uff09","text":"<p>\u60c5\u5883 1\uff1a\u9996\u6b21\u8cb7\u5165</p> <p>\u689d\u4ef6\uff1a</p> <ul> <li>\u6536\u76e4\u50f9 \u2264 \u4e0b\u8ecc\uff08<code>curr_price &lt;= lower</code>\uff09</li> <li>\u73fe\u91d1\u8db3\u5920\uff08<code>cash_position &gt;= curr_price * 1000</code>\uff09</li> <li>\u76ee\u524d\u7121\u6301\u5009\uff08<code>stock_position == 0</code>\uff09</li> </ul> <p>\u60c5\u5883 2\uff1a\u52a0\u78bc\u8cb7\u5165</p> <p>\u689d\u4ef6\uff1a</p> <ul> <li>\u6536\u76e4\u50f9 \u2264 \u4e0b\u8ecc</li> <li>\u6536\u76e4\u50f9 \u2264 \u4e0a\u6b21\u8cb7\u5165\u50f9\uff08<code>curr_price &lt;= context.last_signal_price</code>\uff09</li> <li>\u73fe\u91d1\u8db3\u5920</li> <li>\u76ee\u524d\u6709\u6301\u5009\uff08<code>stock_position &gt; 0</code>\uff09</li> </ul> <p>\u610f\u7fa9\uff1a</p> <ul> <li>\u50f9\u683c\u8dcc\u7834\u4e0b\u8ecc\uff1a\u7d71\u8a08\u4e0a\u8d85\u8ce3</li> <li>\u6301\u7e8c\u4e0b\u8dcc\u52a0\u78bc\uff1a\u6524\u5e73\u6210\u672c</li> <li>\u73fe\u91d1\u63a7\u7ba1\uff1a\u907f\u514d\u904e\u5ea6\u69d3\u687f <pre><code># \u8cb7\u5165\u908f\u8f2f\nif stock_position == 0:\n    if (curr_price &lt;= lower) and (cash_position &gt;= curr_price * 1000):\n        order(stock, 1000)\n        context.last_signal_price = curr_price\n\nelif stock_position &gt; 0:\n    if (curr_price &lt;= lower) and \\\n       (curr_price &lt;= context.last_signal_price) and \\\n       (cash_position &gt;= curr_price * 1000):\n        order(stock, 1000)  # \u52a0\u78bc\n        context.last_signal_price = curr_price\n</code></pre></li> </ul>"},{"location":"blocks/technicals/case-bollinger/#_10","title":"\u8ce3\u51fa\u8a0a\u865f\uff08\u89f8\u78b0\u4e0a\u8ecc\uff09","text":"<p>\u689d\u4ef6\uff08\u5fc5\u9808\u540c\u6642\u6eff\u8db3\uff09\uff1a</p> <ul> <li>\u6536\u76e4\u50f9 \u2265 \u4e0a\u8ecc\uff08<code>curr_price &gt;= upper</code>\uff09</li> <li>\u76ee\u524d\u6709\u6301\u5009\uff08<code>stock_position &gt; 0</code>\uff09</li> </ul> <p>\u610f\u7fa9\uff1a</p> <ul> <li>\u50f9\u683c\u7a81\u7834\u4e0a\u8ecc\uff1a\u7d71\u8a08\u4e0a\u8d85\u8cb7</li> <li>\u7372\u5229\u4e86\u7d50\uff1a\u4fdd\u8b77\u5229\u6f64</li> <li>\u6e05\u7a7a\u90e8\u4f4d\uff1a\u7b49\u5f85\u4e0b\u6b21\u6a5f\u6703 <pre><code># \u8ce3\u51fa\u908f\u8f2f\nif (curr_price &gt;= upper) and (stock_position &gt; 0):\n    order_target(stock, 0)  # \u5168\u90e8\u8ce3\u51fa\n    context.last_signal_price = 0\n</code></pre></li> </ul>"},{"location":"blocks/technicals/case-bollinger/#_11","title":"\ud83d\udcbb \u5b8c\u6574\u7a0b\u5f0f\u78bc","text":"<pre><code># ====================================\n# \u5e03\u6797\u901a\u9053\u7b56\u7565 - \u5b8c\u6574\u5be6\u4f5c\n# ====================================\nimport os\nimport pandas as pd\nimport numpy as np\nimport tejapi\nimport matplotlib.pyplot as plt\n\n# ====================================\n# TEJ API \u8a2d\u5b9a\n# ====================================\nos.environ['TEJAPI_BASE'] = 'https://api.tej.com.tw'\nos.environ['TEJAPI_KEY'] = 'your_key'\n\n# ====================================\n# \u53c3\u6578\u8a2d\u5b9a\n# ====================================\nstart_date = '2015-04-01'\nend_date = '2022-12-31'\nticker = '2409'  # \u53cb\u9054\n\n# \u8a2d\u5b9a\u74b0\u5883\u8b8a\u6578\nos.environ['mdate'] = f'{start_date} {end_date}'\nos.environ['ticker'] = ticker\n\n# ====================================\n# \u532f\u5165\u80a1\u50f9\u8cc7\u6599\n# ====================================\nfrom zipline.data.run_ingest import simple_ingest\n\nprint(f\"\u958b\u59cb\u532f\u5165\u8cc7\u6599\uff1a{ticker}\")\nprint(f\"\u671f\u9593\uff1a{start_date} ~ {end_date}\")\n\nsimple_ingest(\n    name='tquant',               # Bundle \u540d\u7a31\n    tickers=ticker,              # \u80a1\u7968\u6e05\u55ae (\u5fc5\u9808\u662f List)\n    start_date=start_date.replace('-', ''), # \u683c\u5f0f\u901a\u5e38\u5efa\u8b70 YYYYMMDD\n    end_date=end_date.replace('-', '')\n)\n\n# ====================================\n# Pipeline \u5b9a\u7fa9\uff08\u8a08\u7b97\u5e03\u6797\u901a\u9053\uff09\n# ====================================\nfrom zipline.pipeline import Pipeline\nfrom zipline.pipeline.data import EquityPricing\nfrom zipline.pipeline.factors import BollingerBands\n\ndef make_pipeline():\n    \"\"\"\n    \u5efa\u7acb Pipeline\n\n    \u8f38\u51fa\uff1a\n    - upper: \u5e03\u6797\u901a\u9053\u4e0a\u8ecc\n    - middle: \u5e03\u6797\u901a\u9053\u4e2d\u8ecc\n    - lower: \u5e03\u6797\u901a\u9053\u4e0b\u8ecc\n    - curr_price: \u7576\u65e5\u6536\u76e4\u50f9\n    \"\"\"\n    # \u5e03\u6797\u901a\u9053\uff0820 \u65e5\uff0c2 \u500d\u6a19\u6e96\u5dee\uff09\n    perf = BollingerBands(\n        inputs=[EquityPricing.close],\n        window_length=20,\n        k=2\n    )\n\n    upper, middle, lower = perf.upper, perf.middle, perf.lower\n    curr_price = EquityPricing.close.latest\n\n    return Pipeline(\n        columns={\n            'upper': upper,\n            'middle': middle,\n            'lower': lower,\n            'curr_price': curr_price\n        }\n    )\n\n# ====================================\n# \u7b56\u7565\u51fd\u6578\u5b9a\u7fa9\n# ====================================\nfrom zipline.api import (\n    set_slippage, set_commission, set_benchmark,\n    attach_pipeline, pipeline_output,\n    symbol, record, order, order_target\n)\nfrom zipline.finance import commission, slippage\n\ndef initialize(context):\n    \"\"\"\n    \u521d\u59cb\u5316\u51fd\u6578\n    \"\"\"\n    # \u8a18\u9304\u4e0a\u6b21\u8cb7\u5165\u8a0a\u865f\u50f9\u683c\n    context.last_signal_price = 0\n\n    # \u4ea4\u6613\u6210\u672c\u8a2d\u5b9a\n    set_slippage(slippage.VolumeShareSlippage())\n    set_commission(commission.PerShare(cost=0.001425))\n\n    # \u8a2d\u5b9a\u57fa\u6e96\n    set_benchmark(symbol(ticker))\n\n    # \u9644\u52a0 Pipeline\n    attach_pipeline(make_pipeline(), 'mystrategy')\n\ndef handle_data(context, data):\n    \"\"\"\n    \u6bcf\u65e5\u57f7\u884c\u51fd\u6578\n\n    \u6d41\u7a0b\uff1a\n    1. \u5f9e Pipeline \u53d6\u5f97\u5e03\u6797\u901a\u9053\u503c\n    2. \u5224\u65b7\u9032\u51fa\u5834\u8a0a\u865f\n    3. \u57f7\u884c\u4ea4\u6613\uff08\u542b\u52a0\u78bc\u908f\u8f2f\uff09\n    \"\"\"\n    # ========================================\n    # Step 1: \u53d6\u5f97 Pipeline \u8f38\u51fa\n    # ========================================\n    out_dir = pipeline_output('mystrategy')\n\n    # ========================================\n    # Step 2: \u904d\u6b77\u6bcf\u6a94\u80a1\u7968\uff08\u672c\u4f8b\u53ea\u6709\u4e00\u6a94\uff09\n    # ========================================\n    for stock in out_dir.index:\n        # \u53d6\u5f97\u5e03\u6797\u901a\u9053\u503c\n        upper = out_dir.loc[stock, 'upper']\n        middle = out_dir.loc[stock, 'middle']\n        lower = out_dir.loc[stock, 'lower']\n        curr_price = out_dir.loc[stock, 'curr_price']\n\n        # \u53d6\u5f97\u7576\u524d\u72c0\u614b\n        cash_position = context.portfolio.cash\n        stock_position = context.portfolio.positions[stock].amount\n\n        # \u521d\u59cb\u5316\u8a0a\u865f\n        buy, sell = False, False\n\n        # ========================================\n        # Step 3: \u8a18\u9304\u8b8a\u6578\n        # ========================================\n        record(\n            price=curr_price,\n            upper=upper,\n            lower=lower,\n            buy=buy,\n            sell=sell\n        )\n\n        # ========================================\n        # Step 4: \u4ea4\u6613\u908f\u8f2f\n        # ========================================\n        if stock_position == 0:\n            # \u60c5\u5883 1\uff1a\u9996\u6b21\u8cb7\u5165\n            if (curr_price &lt;= lower) and (cash_position &gt;= curr_price * 1000):\n                order(stock, 1000)\n                context.last_signal_price = curr_price\n                buy = True\n                record(buy=buy)\n                print(f\"[{data.current_dt.date()}] \u9996\u6b21\u8cb7\u5165\")\n                print(f\"  \u50f9\u683c: {curr_price:.2f}, \u4e0b\u8ecc: {lower:.2f}\")\n\n        elif stock_position &gt; 0:\n            # \u60c5\u5883 2\uff1a\u52a0\u78bc\u8cb7\u5165\n            if (curr_price &lt;= lower) and \\\n               (curr_price &lt;= context.last_signal_price) and \\\n               (cash_position &gt;= curr_price * 1000):\n                order(stock, 1000)\n                context.last_signal_price = curr_price\n                buy = True\n                record(buy=buy)\n                print(f\"[{data.current_dt.date()}] \u52a0\u78bc\u8cb7\u5165\")\n                print(f\"  \u50f9\u683c: {curr_price:.2f}, \u4e0a\u6b21\u8cb7\u5165: {context.last_signal_price:.2f}\")\n\n            # \u60c5\u5883 3\uff1a\u8ce3\u51fa\n            elif (curr_price &gt;= upper):\n                order_target(stock, 0)\n                context.last_signal_price = 0\n                sell = True\n                record(sell=sell)\n                print(f\"[{data.current_dt.date()}] \u8ce3\u51fa\")\n                print(f\"  \u50f9\u683c: {curr_price:.2f}, \u4e0a\u8ecc: {upper:.2f}\")\n\ndef analyze(context, perf):\n    \"\"\"\n    \u7e3e\u6548\u5206\u6790\u8207\u8996\u89ba\u5316\n    \"\"\"\n    import matplotlib.pyplot as plt\n\n    fig = plt.figure(figsize=(18, 10))\n\n    # ========================================\n    # \u4e0a\u5716\uff1a\u6295\u8cc7\u7d44\u5408\u50f9\u503c\n    # ========================================\n    ax1 = fig.add_subplot(211)\n    perf['portfolio_value'].plot(ax=ax1, linewidth=2)\n    ax1.set_ylabel(\"Portfolio Value (TWD)\", fontsize=12)\n    ax1.set_title(\"Bollinger Bands Strategy - Portfolio Performance\", \n                  fontsize=14, fontweight='bold')\n    ax1.grid(True, alpha=0.3)\n\n    # ========================================\n    # \u4e0b\u5716\uff1a\u50f9\u683c + \u5e03\u6797\u901a\u9053 + \u8cb7\u8ce3\u9ede\n    # ========================================\n    ax2 = fig.add_subplot(212)\n\n    # \u7e6a\u88fd\u50f9\u683c\n    perf['price'].plot(ax=ax2, label='Price', linewidth=2, color='black')\n\n    # \u7e6a\u88fd\u5e03\u6797\u901a\u9053\n    perf['upper'].plot(ax=ax2, label='Upper Band', linewidth=1.5, \n                       color='red', alpha=0.7, linestyle='--')\n    perf['lower'].plot(ax=ax2, label='Lower Band', linewidth=1.5, \n                       color='green', alpha=0.7, linestyle='--')\n\n    # \u6a19\u8a18\u8cb7\u5165\u9ede\n    buy_signals = perf[perf['buy'] == True]\n    ax2.plot(\n        buy_signals.index,\n        buy_signals['price'],\n        '^',\n        markersize=10,\n        color='green',\n        label='Buy Signal',\n        markeredgewidth=2,\n        markeredgecolor='darkgreen'\n    )\n\n    # \u6a19\u8a18\u8ce3\u51fa\u9ede\n    sell_signals = perf[perf['sell'] == True]\n    ax2.plot(\n        sell_signals.index,\n        sell_signals['price'],\n        'v',\n        markersize=10,\n        color='red',\n        label='Sell Signal',\n        markeredgewidth=2,\n        markeredgecolor='darkred'\n    )\n\n    ax2.set_ylabel(\"Price (TWD)\", fontsize=12)\n    ax2.set_xlabel(\"Date\", fontsize=12)\n    ax2.set_title(\"Price Chart with Bollinger Bands\", fontsize=14, fontweight='bold')\n    ax2.legend(loc='upper left', fontsize=10)\n    ax2.grid(True, alpha=0.3)\n\n    plt.tight_layout()\n    plt.show()\n\n# ====================================\n# \u57f7\u884c\u56de\u6e2c\n# ====================================\nfrom zipline import run_algorithm\n\nprint(\"=\"*60)\nprint(\"\u958b\u59cb\u56de\u6e2c\u5e03\u6797\u901a\u9053\u7b56\u7565\")\nprint(f\"\u6a19\u7684\uff1a{ticker}\")\nprint(f\"\u671f\u9593\uff1a{start_date} ~ {end_date}\")\nprint(\"=\"*60)\n\nresults = run_algorithm(\n    start=pd.Timestamp('2015-06-01', tz='UTC'),\n    end=pd.Timestamp('2022-12-31', tz='UTC'),\n    initialize=initialize,\n    bundle='tquant',\n    analyze=analyze,\n    capital_base=5e5,\n    handle_data=handle_data\n)\n\nprint(\"\\n\u56de\u6e2c\u5b8c\u6210\uff01\")\n\n# ====================================\n# \u7e3e\u6548\u7d71\u8a08\n# ====================================\nprint(\"\\n========== \u7e3e\u6548\u6458\u8981 ==========\")\n\ninitial_value = 5e5\nfinal_value = results['portfolio_value'].iloc[-1]\ntotal_return = (final_value / initial_value - 1) * 100\nbuy_hold_return = results['benchmark_period_return'].iloc[-1] * 100\n\nprint(f\"\u521d\u59cb\u8cc7\u91d1: {initial_value:,.0f} \u5143\")\nprint(f\"\u6700\u7d42\u8cc7\u91d1: {final_value:,.0f} \u5143\")\nprint(f\"\u7b56\u7565\u7e3d\u5831\u916c: {total_return:.2f}%\")\nprint(f\"\u8cb7\u5165\u6301\u6709\u5831\u916c: {buy_hold_return:.2f}%\")\nprint(f\"\u8d85\u984d\u5831\u916c: {(total_return - buy_hold_return):.2f}%\")\n\nmax_drawdown = results['max_drawdown'].min() * 100\nprint(f\"\\n\u6700\u5927\u56de\u64a4: {max_drawdown:.2f}%\")\n\nbuy_count = results['buy'].sum()\nsell_count = results['sell'].sum()\nprint(f\"\\n\u8cb7\u5165\u6b21\u6578: {buy_count}\")\nprint(f\"\u8ce3\u51fa\u6b21\u6578: {sell_count}\")\n\nresults.to_csv(f'bollinger_results_{ticker}.csv')\nprint(f\"\\n\u8a73\u7d30\u7d50\u679c\u5df2\u5132\u5b58\u81f3: bollinger_results_{ticker}.csv\")\n\n# ====================================\n# Pyfolio \u7e3e\u6548\u5206\u6790\n# ====================================\ntry:\n    import pyfolio as pf\n    from pyfolio.utils import extract_rets_pos_txn_from_zipline\n\n    print(\"\\n\" + \"=\"*60)\n    print(\"Pyfolio \u7e3e\u6548\u5206\u6790\")\n    print(\"=\"*60)\n\n    # \u63d0\u53d6\u5831\u916c\u3001\u6301\u5009\u3001\u4ea4\u6613\u6578\u64da\n    returns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\n    benchmark_rets = results.benchmark_return\n\n    # \u751f\u6210\u5b8c\u6574\u7e3e\u6548\u5831\u544a\n    pf.tears.create_full_tear_sheet(\n        returns=returns,\n        positions=positions,\n        transactions=transactions,\n        benchmark_rets=benchmark_rets\n    )\n\nexcept ImportError:\n    print(\"\\n\u672a\u5b89\u88dd pyfolio\uff0c\u7565\u904e\u8a73\u7d30\u5206\u6790\")\n    print(\"\u82e5\u9700\u5b8c\u6574\u5831\u544a\uff0c\u8acb\u57f7\u884c: pip install pyfolio\")\nexcept Exception as e:\n    print(f\"\\nPyfolio \u5206\u6790\u932f\u8aa4: {e}\")\n</code></pre>"},{"location":"blocks/technicals/case-bollinger/#_12","title":"\ud83d\udcca \u7b56\u7565\u7279\u6027\u5206\u6790","text":""},{"location":"blocks/technicals/case-bollinger/#_13","title":"\u512a\u52e2 \u2705","text":"<ol> <li> <p>\u7d71\u8a08\u5b78\u57fa\u790e\u624e\u5be6</p> <ul> <li>\u57fa\u65bc\u5e38\u614b\u5206\u4f48\u7406\u8ad6</li> <li>\u6709\u660e\u78ba\u7684\u6a5f\u7387\u610f\u7fa9\uff0895.44% \u843d\u5728 \u00b12\u03c3\uff09</li> </ul> </li> <li> <p>\u52d5\u614b\u8abf\u6574\u80fd\u529b</p> <ul> <li>\u901a\u9053\u96a8\u6ce2\u52d5\u7387\u81ea\u52d5\u8abf\u6574</li> <li>\u9ad8\u6ce2\u52d5\u6642\u901a\u9053\u8b8a\u5bec\uff08\u5bb9\u5fcd\u5ea6\u63d0\u9ad8\uff09</li> <li>\u4f4e\u6ce2\u52d5\u6642\u901a\u9053\u8b8a\u7a84\uff08\u9748\u654f\u5ea6\u63d0\u9ad8\uff09</li> </ul> </li> <li> <p>\u52a0\u78bc\u6a5f\u5236</p> <ul> <li>\u50f9\u683c\u6301\u7e8c\u4e0b\u8dcc\u6642\u5206\u6279\u8cb7\u5165</li> <li>\u6524\u5e73\u6210\u672c</li> <li>\u63d0\u9ad8\u7372\u5229\u6f5b\u529b</li> </ul> </li> <li> <p>\u98a8\u96aa\u63a7\u7ba1</p> <ul> <li>\u56fa\u5b9a\u80a1\u6578\uff0c\u63a7\u5236\u90e8\u4f4d</li> <li>\u73fe\u91d1\u6aa2\u67e5\uff0c\u907f\u514d\u904e\u5ea6\u69d3\u687f</li> <li>\u6709\u660e\u78ba\u51fa\u5834\u8a0a\u865f</li> </ul> </li> </ol>"},{"location":"blocks/technicals/case-bollinger/#_14","title":"\u52a3\u52e2 \u26a0\ufe0f","text":"<ol> <li> <p>\u8da8\u52e2\u5e02\u5834\u8868\u73fe\u5dee</p> <ul> <li>\u55ae\u908a\u4e0a\u6f32\u6642\u6703\u63d0\u65e9\u8ce3\u51fa</li> <li>\u932f\u904e\u5927\u6ce2\u6bb5\u884c\u60c5</li> <li>\u9069\u5408\u9707\u76ea\u5e02\u5834</li> </ul> </li> <li> <p>\u5047\u7a81\u7834\u98a8\u96aa</p> <ul> <li>\u50f9\u683c\u53ef\u80fd\u77ed\u66ab\u7a81\u7834\u5f8c\u7acb\u5373\u53cd\u8f49</li> <li>\u9020\u6210\u8667\u640d\u4ea4\u6613</li> <li>\u9700\u8981\u642d\u914d\u5176\u4ed6\u6307\u6a19\u904e\u6ffe</li> </ul> </li> <li> <p>\u52a0\u78bc\u98a8\u96aa</p> <ul> <li>\u53ef\u80fd\u8d8a\u6524\u8d8a\u5e73</li> <li>\u8cc7\u91d1\u58d3\u529b\u5927</li> <li>\u9700\u8981\u56b4\u683c\u7684\u8cc7\u91d1\u7ba1\u7406</li> </ul> </li> <li> <p>\u53c3\u6578\u654f\u611f</p> <ul> <li>\u4e0d\u540c\u80a1\u7968\u9700\u8981\u4e0d\u540c\u53c3\u6578</li> <li>20 \u65e5\u30012\u03c3 \u4e0d\u4e00\u5b9a\u9069\u5408\u6240\u6709\u80a1\u7968</li> <li>\u9700\u8981\u56de\u6e2c\u512a\u5316</li> </ul> </li> </ol>"},{"location":"blocks/technicals/case-bollinger/#_15","title":"\ud83d\udd0d \u95dc\u9375\u5b78\u7fd2\u9ede","text":""},{"location":"blocks/technicals/case-bollinger/#1-pipeline","title":"1. Pipeline \u8a08\u7b97\u5e03\u6797\u901a\u9053","text":"<pre><code># \u4f7f\u7528\u5167\u5efa BollingerBands\nfrom zipline.pipeline.factors import BollingerBands\n\nperf = BollingerBands(\n    inputs=[EquityPricing.close],\n    window_length=20,  # \u79fb\u52d5\u5e73\u5747\u9031\u671f\n    k=2                # \u6a19\u6e96\u5dee\u500d\u6578\n)\n\nupper, middle, lower = perf.upper, perf.middle, perf.lower\n</code></pre> <p>\u70ba\u4ec0\u9ebc\u7528 Pipeline\uff1f</p> <ul> <li>\u5167\u5efa\u51fd\u6578\uff0c\u8a08\u7b97\u6b63\u78ba</li> <li>\u6548\u80fd\u512a\u7570\uff08\u6279\u6b21\u8655\u7406\uff09</li> <li>\u7a0b\u5f0f\u78bc\u7c21\u6f54</li> </ul>"},{"location":"blocks/technicals/case-bollinger/#2","title":"2. \u52a0\u78bc\u908f\u8f2f\u7684\u5be6\u4f5c","text":"<pre><code># \u95dc\u9375\uff1a\u8ffd\u8e64\u4e0a\u6b21\u8cb7\u5165\u50f9\u683c\ncontext.last_signal_price = curr_price\n\n# \u53ea\u5728\u50f9\u683c\u66f4\u4f4e\u6642\u52a0\u78bc\nif (curr_price &lt;= lower) and (curr_price &lt;= context.last_signal_price):\n    order(stock, 1000)\n    context.last_signal_price = curr_price  # \u66f4\u65b0\n</code></pre> <p>\u70ba\u4ec0\u9ebc\u8981\u8ffd\u8e64\u4e0a\u6b21\u8cb7\u5165\u50f9\uff1f</p> <ul> <li>\u907f\u514d\u5728\u540c\u4e00\u50f9\u683c\u91cd\u8907\u8cb7\u5165</li> <li>\u78ba\u4fdd\u6524\u5e73\u6210\u672c\uff08\u8d8a\u8cb7\u8d8a\u4f4e\uff09</li> <li>\u63a7\u5236\u98a8\u96aa</li> </ul>"},{"location":"blocks/technicals/case-bollinger/#3","title":"3. \u73fe\u91d1\u6aa2\u67e5\u7684\u91cd\u8981\u6027","text":"<pre><code># \u274c \u932f\u8aa4\uff1a\u6c92\u6aa2\u67e5\u73fe\u91d1\nif curr_price &lt;= lower:\n    order(stock, 1000)  # \u53ef\u80fd\u73fe\u91d1\u4e0d\u8db3\n\n# \u2705 \u6b63\u78ba\uff1a\u5148\u6aa2\u67e5\u73fe\u91d1\nif (curr_price &lt;= lower) and (cash_position &gt;= curr_price * 1000):\n    order(stock, 1000)\n</code></pre> <p>\u70ba\u4ec0\u9ebc\u9700\u8981\u6aa2\u67e5\uff1f</p> <ul> <li>\u907f\u514d\u4e0b\u55ae\u5931\u6557</li> <li>\u907f\u514d\u69d3\u687f\u904e\u9ad8</li> <li>\u4fdd\u8b77\u5e33\u6236\u5b89\u5168</li> </ul>"},{"location":"blocks/technicals/case-bollinger/#4","title":"4. \u8ce3\u51fa\u6642\u91cd\u7f6e\u50f9\u683c\u8a18\u9304","text":"<pre><code>if curr_price &gt;= upper:\n    order_target(stock, 0)\n    context.last_signal_price = 0  # \u91cd\u7f6e\uff01\n</code></pre> <p>\u70ba\u4ec0\u9ebc\u8981\u91cd\u7f6e\uff1f</p> <ul> <li>\u6e05\u7a7a\u6301\u5009\u5f8c\uff0c\u4e0b\u6b21\u8cb7\u5165\u662f\u300c\u9996\u6b21\u8cb7\u5165\u300d</li> <li>\u4e0d\u662f\u300c\u52a0\u78bc\u300d</li> <li>\u908f\u8f2f\u6b63\u78ba\u6027</li> </ul>"},{"location":"blocks/technicals/case-bollinger/#_16","title":"\ud83c\udfaf \u5ef6\u4f38\u512a\u5316\u65b9\u5411","text":""},{"location":"blocks/technicals/case-bollinger/#1","title":"\u512a\u5316 1: \u52d5\u614b\u8abf\u6574\u6a19\u6e96\u5dee\u500d\u6578","text":"<pre><code># \u6839\u64da\u5e02\u5834\u6ce2\u52d5\u7387\u8abf\u6574 K \u503c\ndef make_pipeline():\n    # \u8a08\u7b97\u6ce2\u52d5\u7387\n    volatility = Returns(window_length=20).stddev()\n\n    # \u9ad8\u6ce2\u52d5\u6642\u7528 K=2.5\uff0c\u4f4e\u6ce2\u52d5\u6642\u7528 K=1.5\n    k_value = volatility.quantile_between(0, 1, bins=3)\n\n    # \u9019\u9700\u8981\u81ea\u5b9a\u7fa9 CustomFactor\n</code></pre>"},{"location":"blocks/technicals/case-bollinger/#2_1","title":"\u512a\u5316 2: \u52a0\u5165\u8da8\u52e2\u904e\u6ffe","text":"<pre><code>def handle_data(context, data):\n    # \u53ea\u5728\u9577\u671f\u8da8\u52e2\u5411\u4e0a\u6642\u8cb7\u5165\n    ma200 = data.history(stock, 'close', 200, '1d').mean()\n\n    if curr_price &gt; ma200:  # \u9577\u671f\u591a\u982d\n        if curr_price &lt;= lower:\n            order(stock, 1000)\n</code></pre>"},{"location":"blocks/technicals/case-bollinger/#3_1","title":"\u512a\u5316 3: \u9650\u5236\u52a0\u78bc\u6b21\u6578","text":"<pre><code>def initialize(context):\n    context.buy_count = 0\n\ndef handle_data(context, data):\n    if curr_price &lt;= lower:\n        if context.buy_count &lt; 3:  # \u6700\u591a\u52a0\u78bc 3 \u6b21\n            order(stock, 1000)\n            context.buy_count += 1\n\n    if curr_price &gt;= upper:\n        order_target(stock, 0)\n        context.buy_count = 0  # \u91cd\u7f6e\u8a08\u6578\n</code></pre>"},{"location":"blocks/technicals/case-bollinger/#4_1","title":"\u512a\u5316 4: \u90e8\u5206\u7372\u5229\u4e86\u7d50","text":"<pre><code>def handle_data(context, data):\n    if stock_position &gt; 0:\n        # \u89f8\u78b0\u4e2d\u8ecc\u6642\u8ce3\u51fa\u4e00\u534a\n        if curr_price &gt;= middle:\n            order_target_percent(stock, 0.5)\n\n        # \u89f8\u78b0\u4e0a\u8ecc\u6642\u5168\u90e8\u8ce3\u51fa\n        elif curr_price &gt;= upper:\n            order_target(stock, 0)\n</code></pre>"},{"location":"blocks/technicals/case-bollinger/#5","title":"\u512a\u5316 5: \u901a\u9053\u64e0\u58d3\u7b56\u7565","text":"<pre><code># \u901a\u9053\u5bec\u5ea6\nbandwidth = (upper - lower) / middle\n\n# \u901a\u9053\u64e0\u58d3\uff08\u919e\u91c0\u5927\u884c\u60c5\uff09\nif bandwidth &lt; bandwidth.rolling(50).mean() * 0.5:\n    print(\"\u901a\u9053\u64e0\u58d3\uff0c\u6e96\u5099\u7a81\u7834\")\n    # \u7b49\u5f85\u65b9\u5411\u78ba\u8a8d\u5f8c\u9032\u5834\n</code></pre>"},{"location":"blocks/technicals/case-bollinger/#_17","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6a21\u677f\u9801\u9762\uff1atemplate.md - \u7a81\u7834\u7b56\u7565\u6a21\u677f</li> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md - \u7406\u89e3\u8a2d\u8a08\u539f\u7406</li> <li> <p>\u5176\u4ed6\u6848\u4f8b\uff1a</p> </li> <li> <p>MACD \u7b56\u7565 - \u96d9\u7dda\u4ea4\u53c9</p> </li> <li>\u4e56\u96e2\u7387\u7b56\u7565 - \u53cd\u8f49\u7b56\u7565</li> </ul>"},{"location":"blocks/technicals/case-bollinger/#_18","title":"\ud83d\udca1 \u7e3d\u7d50","text":"<p>\u5e03\u6797\u901a\u9053\u7b56\u7565\u5c55\u793a\u4e86 \u7d71\u8a08\u5b78 \u5728\u6280\u8853\u5206\u6790\u4e2d\u7684\u61c9\u7528\uff1a</p> <ol> <li>\u2705 \u7406\u8ad6\u57fa\u790e\uff1a\u5e38\u614b\u5206\u4f48\uff0c\u6a5f\u7387\u660e\u78ba</li> <li>\u2705 \u52d5\u614b\u8abf\u6574\uff1a\u96a8\u6ce2\u52d5\u7387\u81ea\u52d5\u9069\u61c9</li> <li>\u2705 \u53cd\u8f49\u4ea4\u6613\uff1a\u8d85\u8cb7\u8ce3\u51fa\u3001\u8d85\u8ce3\u8cb7\u5165</li> <li>\u2705 \u52a0\u78bc\u6a5f\u5236\uff1a\u6524\u5e73\u6210\u672c\uff0c\u63d0\u9ad8\u7372\u5229</li> </ol> <p>\u9069\u5408\u8ab0\u4f7f\u7528\uff1f</p> <ul> <li>\u504f\u597d\u7d71\u8a08\u65b9\u6cd5\u7684\u4ea4\u6613\u8005</li> <li>\u9707\u76ea\u5e02\u5834\u64cd\u4f5c</li> <li>\u80fd\u627f\u53d7\u52a0\u78bc\u98a8\u96aa</li> </ul> <p>\u4f7f\u7528\u5efa\u8b70\uff1a</p> <ul> <li>\u2705 \u5728\u9707\u76ea\u5e02\u5834\u4f7f\u7528</li> <li>\u2705 \u642d\u914d\u8da8\u52e2\u904e\u6ffe</li> <li>\u2705 \u56b4\u683c\u8cc7\u91d1\u7ba1\u7406</li> <li>\u26a0\ufe0f \u907f\u514d\u5728\u55ae\u908a\u8da8\u52e2\u4f7f\u7528</li> <li>\u26a0\ufe0f \u6ce8\u610f\u52a0\u78bc\u98a8\u96aa</li> </ul> <p>\ud83d\udc49 Next Step:</p> <ol> <li>\u8907\u88fd\u5b8c\u6574\u7a0b\u5f0f\u78bc</li> <li>\u8abf\u6574\u53c3\u6578\uff08\u9031\u671f\u3001K \u503c\uff09</li> <li>\u6e2c\u8a66\u4e0d\u540c\u80a1\u7968</li> <li>\u52a0\u5165\u4f60\u7684\u512a\u5316\u908f\u8f2f</li> </ol>"},{"location":"blocks/technicals/case-bollinger/#_19","title":"\ud83d\udcd6 \u5ef6\u4f38\u95b1\u8b80","text":"<p>John Bollinger \u7684\u5e03\u6797\u901a\u9053\u539f\u5247\uff1a</p> <ol> <li>\u5e03\u6797\u901a\u9053\u4e0d\u662f\u7d55\u5c0d\u7684\u8cb7\u8ce3\u8a0a\u865f</li> <li>\u9700\u642d\u914d\u5176\u4ed6\u6307\u6a19\u78ba\u8a8d</li> <li>\u6ce8\u610f\u300c\u884c\u8d70\u901a\u9053\u908a\u7de3\u300d\u73fe\u8c61\uff08\u5f37\u52e2\u80a1\u6703\u6cbf\u8457\u4e0a\u8ecc\u8d70\uff09</li> <li>\u901a\u9053\u64e0\u58d3\u5f8c\u5e38\u6709\u5927\u884c\u60c5</li> </ol> <p>\u9032\u968e\u61c9\u7528\uff1a</p> <ul> <li>\u5e03\u6797\u901a\u9053 %B \u6307\u6a19\uff08\u50f9\u683c\u5728\u901a\u9053\u4e2d\u7684\u4f4d\u7f6e\uff09</li> <li>\u5e03\u6797\u901a\u9053\u5bec\u5ea6\uff08BandWidth\uff09</li> <li>\u591a\u6642\u9593\u6846\u67b6\u5e03\u6797\u901a\u9053</li> <li>\u5e03\u6797\u901a\u9053 + RSI \u7d44\u5408</li> </ul>"},{"location":"blocks/technicals/case-macd/","title":"\u6848\u4f8b 1\uff1aMACD \u4ea4\u6613\u7b56\u7565","text":"<p>\u7b56\u7565\u985e\u578b\uff1a \u6280\u8853\u6307\u6a19\u67b6\u69cb - \u96d9\u7dda\u4ea4\u53c9 \u4ea4\u6613\u6a19\u7684\uff1a \u53f0\u7a4d\u96fb\uff082330\uff09 \u8abf\u5009\u983b\u7387\uff1a \u8a0a\u865f\u89f8\u767c\u6642\uff08\u4e0d\u5b9a\u671f\uff09 \u56de\u6e2c\u671f\u9593\uff1a 2018-12-30 ~ 2023-05-26</p>"},{"location":"blocks/technicals/case-macd/#_1","title":"\ud83d\udccc \u7b56\u7565\u6982\u8ff0","text":"<p>MACD\uff08Moving Average Convergence Divergence\uff0c\u6307\u6578\u5e73\u6ed1\u7570\u540c\u79fb\u52d5\u5e73\u5747\u7dda\uff09\u662f\u6700\u7d93\u5178\u7684\u6280\u8853\u6307\u6a19\u4e4b\u4e00\uff0c\u7531 Gerald Appel \u65bc 1970 \u5e74\u4ee3\u767c\u660e\u3002</p>"},{"location":"blocks/technicals/case-macd/#_2","title":"\u6838\u5fc3\u7406\u5ff5","text":"<p>\"Follow the trend, but wait for confirmation.\" \u8ddf\u96a8\u8da8\u52e2\uff0c\u4f46\u7b49\u5f85\u78ba\u8a8d\u8a0a\u865f\u3002</p> <p>MACD \u5229\u7528\u5169\u689d\u4e0d\u540c\u901f\u5ea6\u7684 \u6307\u6578\u79fb\u52d5\u5e73\u5747\u7dda\uff08EMA\uff09 \u7684\u5dee\u8ddd\u8b8a\u5316\uff0c\u4f86\u5224\u65b7\u80a1\u50f9\u8d70\u52e2\u7684\u52d5\u80fd\u548c\u65b9\u5411\u3002</p>"},{"location":"blocks/technicals/case-macd/#_3","title":"\u7b56\u7565\u7279\u8272","text":"<ol> <li>\u96d9\u91cd\u78ba\u8a8d\u6a5f\u5236\uff1aDIF \u8207 MACD \u4ea4\u53c9 + \u67f1\u72c0\u5716\u7531\u8ca0\u8f49\u6b63</li> <li>\u8da8\u52e2\u8ddf\u96a8\uff1a\u9069\u5408\u6709\u660e\u986f\u8da8\u52e2\u7684\u5e02\u5834</li> <li>\u6eef\u5f8c\u6307\u6a19\uff1a\u907f\u514d\u8ffd\u9ad8\u6bba\u4f4e\uff0c\u7b49\u5f85\u8da8\u52e2\u78ba\u7acb</li> <li>\u7c21\u55ae\u6709\u6548\uff1a\u908f\u8f2f\u6e05\u6670\uff0c\u5be6\u52d9\u5ee3\u6cdb\u61c9\u7528</li> </ol>"},{"location":"blocks/technicals/case-macd/#macd","title":"\ud83c\udfaf MACD \u6307\u6a19\u8a73\u89e3","text":""},{"location":"blocks/technicals/case-macd/#_4","title":"\u8a08\u7b97\u516c\u5f0f","text":"<pre><code>Step 1: \u8a08\u7b97\u5feb\u7dda EMA \u8207\u6162\u7dda EMA\nEMA(12) = (\u524d\u4e00\u65e5 EMA(12) \u00d7 11 + \u4eca\u65e5\u6536\u76e4\u50f9 \u00d7 2) \u00f7 13\nEMA(26) = (\u524d\u4e00\u65e5 EMA(26) \u00d7 25 + \u4eca\u65e5\u6536\u76e4\u50f9 \u00d7 2) \u00f7 27\n\nStep 2: \u8a08\u7b97\u5dee\u96e2\u503c DIF\nDIF = EMA(12) - EMA(26)\n\nStep 3: \u8a08\u7b97 MACD \u7dda\uff08DIF \u7684 9 \u65e5 EMA\uff09\nMACD = (\u524d\u4e00\u65e5 MACD \u00d7 8 + DIF \u00d7 2) \u00f7 10\n\nStep 4: \u8a08\u7b97\u67f1\u72c0\u5716\uff08BAR\uff09\nBAR = DIF - MACD\n</code></pre> <p>\u53c3\u6578\u8aaa\u660e\uff1a - 12\uff1a\u77ed\u671f EMA\uff08\u5feb\u7dda\uff09 - 26\uff1a\u9577\u671f EMA\uff08\u6162\u7dda\uff09 - 9\uff1aDIF \u7684\u5e73\u6ed1\u9031\u671f</p>"},{"location":"blocks/technicals/case-macd/#_5","title":"\u8a0a\u865f\u89e3\u8b80","text":"<pre><code>graph LR\n    A[MACD \u6307\u6a19] --&gt; B{DIF vs MACD}\n    B --&gt;|DIF &gt; MACD| C[\u591a\u982d\u8a0a\u865f]\n    B --&gt;|DIF &lt; MACD| D[\u7a7a\u982d\u8a0a\u865f]\n\n    C --&gt; E{\u67f1\u72c0\u5716}\n    D --&gt; F{\u67f1\u72c0\u5716}\n\n    E --&gt;|\u7531\u8ca0\u8f49\u6b63| G[\u2705 \u9ec3\u91d1\u4ea4\u53c9&lt;br/&gt;\u5f37\u70c8\u8cb7\u5165\u8a0a\u865f]\n    E --&gt;|\u6301\u7e8c\u70ba\u6b63| H[\u6301\u6709]\n\n    F --&gt;|\u7531\u6b63\u8f49\u8ca0| I[\u274c \u6b7b\u4ea1\u4ea4\u53c9&lt;br/&gt;\u5f37\u70c8\u8ce3\u51fa\u8a0a\u865f]\n    F --&gt;|\u6301\u7e8c\u70ba\u8ca0| J[\u89c0\u671b]\n\n    style G fill:#c8e6c9,stroke:#388e3c,stroke-width:3px\n    style I fill:#ffcdd2,stroke:#c62828,stroke-width:3px</code></pre>"},{"location":"blocks/technicals/case-macd/#_6","title":"\ud83d\udd0d \u4ea4\u6613\u908f\u8f2f\u8a73\u89e3","text":""},{"location":"blocks/technicals/case-macd/#_7","title":"\u8cb7\u5165\u8a0a\u865f\uff08\u9ec3\u91d1\u4ea4\u53c9\uff09","text":"<p>\u689d\u4ef6\uff08\u5fc5\u9808\u540c\u6642\u6eff\u8db3\uff09\uff1a</p> <ol> <li>DIF \u7531\u4e0b\u5f80\u4e0a\u7a7f\u8d8a MACD\uff08<code>dif[-2] &lt; macd[-2]</code> \u4e14 <code>dif[-1] &gt; macd[-1]</code>\uff09</li> <li>\u67f1\u72c0\u5716\u7531\u8ca0\u8f49\u6b63\uff08<code>bar[-2] &lt; 0</code> \u4e14 <code>bar[-1] &gt; 0</code>\uff09</li> <li>\u76ee\u524d\u7121\u6301\u5009\uff08<code>context.invested == False</code>\uff09</li> </ol> <p>\u610f\u7fa9\uff1a</p> <ul> <li>DIF &gt; MACD\uff1a\u77ed\u671f\u52d5\u80fd\u5f37\u65bc\u9577\u671f\u52d5\u80fd\uff08\u8da8\u52e2\u5411\u4e0a\uff09</li> <li>\u67f1\u72c0\u5716\u8f49\u6b63\uff1a\u78ba\u8a8d\u8a0a\u865f\u5f37\u5ea6</li> <li>\u96d9\u91cd\u78ba\u8a8d\uff1a\u964d\u4f4e\u5047\u8a0a\u865f</li> </ul> <pre><code># \u8cb7\u5165\u908f\u8f2f\nif (dif[-2] &lt; macd[-2]) and (dif[-1] &gt; macd[-1]) and \\\n   (bar[-2] &lt; 0) and (bar[-1] &gt; 0) and \\\n   not context.invested:\n\n    order_target(context.sym, 1000)  # \u8cb7\u5165 1000 \u80a1\n    context.invested = True\n</code></pre>"},{"location":"blocks/technicals/case-macd/#_8","title":"\u8ce3\u51fa\u8a0a\u865f\uff08\u6b7b\u4ea1\u4ea4\u53c9\uff09","text":"<p>\u689d\u4ef6\uff08\u5fc5\u9808\u540c\u6642\u6eff\u8db3\uff09\uff1a 1. DIF \u7531\u4e0a\u5f80\u4e0b\u7a7f\u8d8a MACD\uff08<code>dif[-2] &gt; macd[-2]</code> \u4e14 <code>dif[-1] &lt; macd[-1]</code>\uff09 2. \u67f1\u72c0\u5716\u7531\u6b63\u8f49\u8ca0\uff08<code>bar[-2] &gt; 0</code> \u4e14 <code>bar[-1] &lt; 0</code>\uff09 3. \u76ee\u524d\u6709\u6301\u5009\uff08<code>context.invested == True</code>\uff09</p> <p>\u610f\u7fa9\uff1a - DIF &lt; MACD\uff1a\u77ed\u671f\u52d5\u80fd\u8f49\u5f31\uff08\u8da8\u52e2\u53cd\u8f49\uff09 - \u67f1\u72c0\u5716\u8f49\u8ca0\uff1a\u78ba\u8a8d\u8da8\u52e2\u6539\u8b8a - \u53ca\u6642\u51fa\u5834\uff1a\u4fdd\u8b77\u7372\u5229 <pre><code># \u8ce3\u51fa\u908f\u8f2f\nif (dif[-2] &gt; macd[-2]) and (dif[-1] &lt; macd[-1]) and \\\n   (bar[-2] &gt; 0) and (bar[-1] &lt; 0) and \\\n   context.invested:\n\n    order_target(context.sym, 0)  # \u6e05\u7a7a\u90e8\u4f4d\n    context.invested = False\n</code></pre></p>"},{"location":"blocks/technicals/case-macd/#_9","title":"\ud83d\udcbb \u5b8c\u6574\u7a0b\u5f0f\u78bc","text":"<p>\u958b\u59cb\u524d\u82e5\u5c1a\u672a\u4e0b\u8f09talib\u8a18\u5f97\u7368\u7acb\u4e00\u500bcell\u57f7\u884c\u4ee5\u4e0b\u7a0b\u5f0f\u78bc <pre><code>!pip install TA-Lib\n</code></pre></p> <pre><code># ====================================\n# MACD \u4ea4\u6613\u7b56\u7565 - \u5b8c\u6574\u5be6\u4f5c\n# ====================================\nimport os\nimport pandas as pd\nimport numpy as np\nimport talib\nimport matplotlib.pyplot as plt\n\n# ====================================\n# TEJ API \u8a2d\u5b9a\n# ====================================\nos.environ['TEJAPI_BASE'] = 'https://api.tej.com.tw'\nos.environ['TEJAPI_KEY'] = 'your_key'\n\n# ====================================\n# \u53c3\u6578\u8a2d\u5b9a\n# ====================================\nstart_date = '2018-12-30'\nend_date = '2023-05-26'\nticker = '2330'  # \u53f0\u7a4d\u96fb\n\n# \u8a2d\u5b9a\u74b0\u5883\u8b8a\u6578\nos.environ['mdate'] = f'{start_date} {end_date}'\nos.environ['ticker'] = ticker\n\n# ====================================\n# \u57f7\u884c\u8cc7\u6599\u532f\u5165 (Ingest)\n# ====================================\nfrom zipline.data.run_ingest import simple_ingest\n\nprint(f\"\u958b\u59cb\u532f\u5165\u8cc7\u6599\uff1a{ticker_list}\")\nprint(f\"\u671f\u9593\uff1a{start_date} ~ {end_date}\")\n\nsimple_ingest(\n    name='tquant',               # Bundle \u540d\u7a31\n    tickers=ticker,              # \u80a1\u7968\u6e05\u55ae (\u5fc5\u9808\u662f List)\n    start_date=start_date.replace('-', ''), # \u683c\u5f0f\u901a\u5e38\u5efa\u8b70 YYYYMMDD\n    end_date=end_date.replace('-', '')\n)\n\nprint(\"\u8cc7\u6599\u532f\u5165\u5b8c\u6210\uff01\")\n\n# ====================================\n# \u7b56\u7565\u51fd\u6578\u5b9a\u7fa9\n# ====================================\nfrom zipline.api import (\n    set_slippage, set_commission, symbol,\n    record, order_target, order_value, set_benchmark\n)\nfrom zipline.finance import commission, slippage\n\ndef initialize(context):\n    \"\"\"\n    \u521d\u59cb\u5316\u51fd\u6578\n\n    \u8a2d\u5b9a\uff1a\n    1. \u4ea4\u6613\u6210\u672c\n    2. \u7b56\u7565\u8b8a\u6578\n    3. \u57fa\u6e96\u6307\u6578\n    \"\"\"\n    # \u4ea4\u6613\u6210\u672c\u8a2d\u5b9a\n    context.set_commission(commission.PerDollar(cost=0.001425))\n    context.set_slippage(slippage.VolumeShareSlippage())\n    context.set_benchmark(symbol('ticker'))\n\n    # \u7b56\u7565\u8b8a\u6578\n    context.sym = symbol(ticker)\n    context.i = 0\n    context.invested = False\n\ndef handle_data(context, data):\n    \"\"\"\n    \u6bcf\u65e5\u57f7\u884c\u51fd\u6578\n\n    \u6d41\u7a0b\uff1a\n    1. \u6293\u53d6\u904e\u53bb 35 \u5929 K \u7dda\uff0826+9\uff09\n    2. \u8a08\u7b97 MACD \u6307\u6a19\n    3. \u5224\u65b7\u4ea4\u53c9\u8a0a\u865f\n    4. \u57f7\u884c\u4ea4\u6613\n    \"\"\"\n    # ========================================\n    # Step 1: \u6293\u53d6\u6b77\u53f2\u8cc7\u6599\n    # ========================================\n    trailing_window = data.history(\n        context.sym,\n        'price',\n        35,  # MACD(12,26,9) \u9700\u8981 26+9=35 \u5929\n        '1d'\n    )\n\n    # \u6aa2\u67e5\u8cc7\u6599\u5b8c\u6574\u6027\n    if trailing_window.isnull().values.any():\n        return\n\n    # ========================================\n    # Step 2: \u8a08\u7b97 MACD \u6307\u6a19\n    # ========================================\n    # \u5feb\u7dda EMA(12)\n    short_ema = talib.EMA(trailing_window.values, timeperiod=12)\n\n    # \u6162\u7dda EMA(26)\n    long_ema = talib.EMA(trailing_window.values, timeperiod=26)\n\n    # DIF = \u5feb\u7dda - \u6162\u7dda\n    dif = short_ema - long_ema\n\n    # MACD = DIF \u7684 9 \u65e5 EMA\n    MACD = talib.EMA(dif, timeperiod=9)\n\n    # \u67f1\u72c0\u5716 = DIF - MACD\n    bar = dif - MACD\n\n    # ========================================\n    # Step 3: \u8a0a\u865f\u5224\u65b7\n    # ========================================\n    buy = False\n    sell = False\n\n    # \u8cb7\u5165\u8a0a\u865f\uff1a\u9ec3\u91d1\u4ea4\u53c9\n    if (dif[-2] &lt; MACD[-2]) and (dif[-1] &gt; MACD[-1]) and \\\n       (bar[-2] &lt; 0) and (bar[-1] &gt; 0):\n\n        if not context.invested:\n            buy = True\n\n    # \u8ce3\u51fa\u8a0a\u865f\uff1a\u6b7b\u4ea1\u4ea4\u53c9\n    elif (dif[-2] &gt; MACD[-2]) and (dif[-1] &lt; MACD[-1]) and \\\n         (bar[-2] &gt; 0) and (bar[-1] &lt; 0):\n\n        if context.invested:\n            sell = True\n\n    # ========================================\n    # Step 4: \u57f7\u884c\u4ea4\u6613\n    # ========================================\n    if buy:\n        order_target(context.sym, 1000)\n        context.invested = True\n        print(f\"[{data.current_dt.date()}] \u9ec3\u91d1\u4ea4\u53c9 - \u8cb7\u5165\")\n        print(f\"  DIF: {dif[-1]:.2f}, MACD: {MACD[-1]:.2f}, BAR: {bar[-1]:.2f}\")\n\n    elif sell:\n        order_target(context.sym, 0)\n        context.invested = False\n        print(f\"[{data.current_dt.date()}] \u6b7b\u4ea1\u4ea4\u53c9 - \u8ce3\u51fa\")\n        print(f\"  DIF: {dif[-1]:.2f}, MACD: {MACD[-1]:.2f}, BAR: {bar[-1]:.2f}\")\n\n    # ========================================\n    # Step 5: \u8a18\u9304\u8b8a\u6578\n    # ========================================\n    record(\n        TSMC=data.current(symbol(ticker), 'close'),\n        dif=dif[-1],\n        MACD=MACD[-1],\n        bar=bar[-1],\n        buy=buy,\n        sell=sell\n    )\n\n    context.i += 1\n\ndef analyze(context, results):\n    \"\"\"\n    \u7e3e\u6548\u5206\u6790\u8207\u8996\u89ba\u5316\n    \"\"\"\n    import matplotlib.pyplot as plt\n\n    fig = plt.figure(figsize=(18, 12))\n\n    # ========================================\n    # \u4e0a\u5716\uff1a\u6295\u8cc7\u7d44\u5408\u50f9\u503c\n    # ========================================\n    ax1 = fig.add_subplot(311)\n    results['portfolio_value'].plot(ax=ax1, linewidth=2)\n    ax1.set_ylabel('Portfolio Value (TWD)', fontsize=12)\n    ax1.set_title('MACD Strategy - Portfolio Performance', fontsize=14, fontweight='bold')\n    ax1.grid(True, alpha=0.3)\n\n    # ========================================\n    # \u4e2d\u5716\uff1a\u80a1\u50f9 + \u8cb7\u8ce3\u9ede\n    # ========================================\n    ax2 = fig.add_subplot(312)\n    results['TSMC'].plot(ax=ax2, label='Price', linewidth=2, color='black')\n\n    # \u6a19\u8a18\u8cb7\u5165\u9ede\n    buy_signals = results[results['buy'] == True]\n    ax2.plot(\n        buy_signals.index,\n        buy_signals['TSMC'],\n        '^',\n        markersize=12,\n        color='green',\n        label='Buy Signal',\n        markeredgewidth=2,\n        markeredgecolor='darkgreen'\n    )\n\n    # \u6a19\u8a18\u8ce3\u51fa\u9ede\n    sell_signals = results[results['sell'] == True]\n    ax2.plot(\n        sell_signals.index,\n        sell_signals['TSMC'],\n        'v',\n        markersize=12,\n        color='red',\n        label='Sell Signal',\n        markeredgewidth=2,\n        markeredgecolor='darkred'\n    )\n\n    ax2.set_ylabel('Price (TWD)', fontsize=12)\n    ax2.set_title('Price Chart with Trade Signals', fontsize=14, fontweight='bold')\n    ax2.legend(loc='upper left', fontsize=11)\n    ax2.grid(True, alpha=0.3)\n\n    # ========================================\n    # \u4e0b\u5716\uff1aMACD \u6307\u6a19 + \u67f1\u72c0\u5716\n    # ========================================\n    ax3 = fig.add_subplot(313)\n\n    # \u7e6a\u88fd DIF \u8207 MACD \u7dda\n    results['dif'].plot(ax=ax3, label='DIF', linewidth=2, color='blue')\n    results['MACD'].plot(ax=ax3, label='MACD', linewidth=2, color='red')\n\n    # \u7e6a\u88fd\u8cb7\u5165\u9ede\uff08\u5728 MACD \u7dda\u4e0a\uff09\n    ax3.plot(\n        buy_signals.index,\n        buy_signals['MACD'],\n        '^',\n        markersize=12,\n        color='green',\n        markeredgewidth=2,\n        markeredgecolor='darkgreen'\n    )\n\n    # \u7e6a\u88fd\u8ce3\u51fa\u9ede\uff08\u5728 MACD \u7dda\u4e0a\uff09\n    ax3.plot(\n        sell_signals.index,\n        sell_signals['MACD'],\n        'v',\n        markersize=12,\n        color='red',\n        markeredgewidth=2,\n        markeredgecolor='darkred'\n    )\n\n    # \u7e6a\u88fd\u67f1\u72c0\u5716\uff08\u96d9\u8ef8\uff09\n    ax3_twin = ax3.twinx()\n    colors = [\"red\" if i &gt; 0 else \"green\" for i in results['bar']]\n    ax3_twin.bar(\n        results.index,\n        results['bar'],\n        color=colors,\n        alpha=0.3,\n        width=0.8,\n        label='MACD Histogram'\n    )\n\n    # \u8a2d\u5b9a Y \u8ef8\u6a19\u7c64\n    ax3.set_ylabel('MACD / DIF', fontsize=12)\n    ax3_twin.set_ylabel('Histogram', fontsize=12)\n    ax3.set_xlabel('Date', fontsize=12)\n    ax3.set_title('MACD Indicator', fontsize=14, fontweight='bold')\n\n    # \u5408\u4f75\u5716\u4f8b\n    lines1, labels1 = ax3.get_legend_handles_labels()\n    lines2, labels2 = ax3_twin.get_legend_handles_labels()\n    ax3.legend(lines1 + lines2, labels1 + labels2, loc='upper left', fontsize=11)\n\n    ax3.grid(True, alpha=0.3)\n    ax3.axhline(0, color='black', linewidth=1, linestyle='--', alpha=0.5)\n\n    plt.tight_layout()\n    plt.show()\n\n# ====================================\n# \u57f7\u884c\u56de\u6e2c\n# ====================================\nfrom zipline import run_algorithm\n\nprint(\"=\"*60)\nprint(\"\u958b\u59cb\u56de\u6e2c MACD \u7b56\u7565\")\nprint(f\"\u6a19\u7684\uff1a{ticker}\")\nprint(f\"\u671f\u9593\uff1a{start_date} ~ {end_date}\")\nprint(\"=\"*60)\n\nresults = run_algorithm(\n    start=pd.Timestamp(start_date, tz='utc'),\n    end=pd.Timestamp(end_date, tz='utc'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    bundle='tquant',\n    capital_base=1e6\n)\n\nprint(\"\\n\u56de\u6e2c\u5b8c\u6210\uff01\")\n\n# ====================================\n# Pyfolio \u7e3e\u6548\u5206\u6790\n# ====================================\ntry:\n    import pyfolio as pf\n    from pyfolio.utils import extract_rets_pos_txn_from_zipline\n\n    returns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\n    benchmark_rets = results.benchmark_return\n\n    print(\"------ \u5927\u76e4\u7e3e\u6548\u6307\u6a19 ------\")\n    pf.show_perf_stats(benchmark_rets)\n\n    print(\"------ \u7b56\u7565\u7e3e\u6548 ------\")\n    pf.tears.create_full_tear_sheet(\n        returns=returns,\n        positions=positions,\n        transactions=transactions,\n        benchmark_rets=benchmark_rets\n    )\n\nexcept ImportError:\n    print(\"\u672a\u5b89\u88dd pyfolio\uff0c\u7565\u904e\u8a73\u7d30\u5206\u6790\")\n    print(\"\u82e5\u9700\u5b8c\u6574\u5831\u544a\uff0c\u8acb\u57f7\u884c: pip install pyfolio\")\nexcept Exception as e:\n    print(f\"Pyfolio \u5206\u6790\u932f\u8aa4: {e}\")\n</code></pre>"},{"location":"blocks/technicals/case-macd/#_10","title":"\ud83d\udcca \u56de\u6e2c\u7d50\u679c\u5206\u6790","text":""},{"location":"blocks/technicals/case-macd/#_11","title":"\u7b56\u7565\u7279\u6027","text":""},{"location":"blocks/technicals/case-macd/#strengths","title":"\u2705 \u512a\u52e2 (Strengths)","text":"<ol> <li> <p>\u8da8\u52e2\u6355\u6349\u80fd\u529b\u5f37</p> <ul> <li>\u5728\u660e\u986f\u8da8\u52e2\u4e2d\u8868\u73fe\u512a\u7570</li> <li>\u80fd\u5920\u6293\u4f4f\u5927\u6ce2\u6bb5\u884c\u60c5</li> </ul> </li> <li> <p>\u96d9\u91cd\u78ba\u8a8d\u964d\u4f4e\u5047\u8a0a\u865f</p> <ul> <li>DIF \u8207 MACD \u4ea4\u53c9</li> <li>\u67f1\u72c0\u5716\u8f49\u6298\u78ba\u8a8d</li> <li>\u6e1b\u5c11\u983b\u7e41\u9032\u51fa</li> </ul> </li> <li> <p>\u908f\u8f2f\u7c21\u55ae\u6613\u61c2</p> <ul> <li>\u8a0a\u865f\u660e\u78ba\uff08\u91d1\u53c9\u8cb7\u3001\u6b7b\u53c9\u8ce3\uff09</li> <li>\u5bb9\u6613\u57f7\u884c\u8207\u56de\u6e2c</li> </ul> </li> <li> <p>\u98a8\u96aa\u53ef\u63a7</p> <ul> <li>\u6709\u660e\u78ba\u51fa\u5834\u8a0a\u865f</li> <li>\u4e0d\u6703\u9577\u671f\u5957\u7262</li> </ul> </li> </ol>"},{"location":"blocks/technicals/case-macd/#weaknesses","title":"\u26a0\ufe0f \u52a3\u52e2 (Weaknesses)","text":"<ol> <li> <p>\u76e4\u6574\u5e02\u5834\u8868\u73fe\u5dee</p> <ul> <li>\u6a6b\u76e4\u6642\u5bb9\u6613\u7522\u751f\u5047\u8a0a\u865f</li> <li>\u983b\u7e41\u9032\u51fa\u9020\u6210\u640d\u5931</li> </ul> </li> <li> <p>\u6eef\u5f8c\u6027</p> <ul> <li>\u7b49\u5f85\u4ea4\u53c9\u78ba\u8a8d\uff0c\u9032\u5834\u8f03\u665a</li> <li>\u53ef\u80fd\u932f\u904e\u521d\u671f\u6f32\u5e45</li> </ul> </li> <li> <p>\u56de\u64a4\u8f03\u5927</p> <ul> <li>\u8da8\u52e2\u53cd\u8f49\u6642\u53cd\u61c9\u8f03\u6162</li> <li>\u7372\u5229\u56de\u5410\u8f03\u591a</li> </ul> </li> </ol>"},{"location":"blocks/technicals/case-macd/#_12","title":"\ud83d\udd0d \u95dc\u9375\u5b78\u7fd2\u9ede","text":""},{"location":"blocks/technicals/case-macd/#1","title":"1. \u70ba\u4ec0\u9ebc\u9700\u8981\u96d9\u91cd\u78ba\u8a8d\uff1f","text":"<pre><code># \u274c \u55ae\u4e00\u689d\u4ef6\uff1a\u5bb9\u6613\u5047\u8a0a\u865f\nif dif[-1] &gt; macd[-1]:\n    buy = True\n\n# \u2705 \u96d9\u91cd\u78ba\u8a8d\uff1a\u964d\u4f4e\u5047\u8a0a\u865f\nif (dif[-2] &lt; macd[-2]) and (dif[-1] &gt; macd[-1]) and \\\n   (bar[-2] &lt; 0) and (bar[-1] &gt; 0):\n    buy = True\n</code></pre> <p>\u539f\u56e0\uff1a</p> <ul> <li>DIF \u53ef\u80fd\u5728 MACD \u9644\u8fd1\u9707\u76ea</li> <li>\u67f1\u72c0\u5716\u8f49\u6298\u78ba\u8a8d\u52d5\u80fd\u5f37\u5ea6</li> <li>\u907f\u514d\u300c\u5047\u4ea4\u53c9\u300d</li> </ul>"},{"location":"blocks/technicals/case-macd/#2","title":"2. \u6aa2\u67e5\u8cc7\u6599\u5b8c\u6574\u6027\u7684\u91cd\u8981\u6027","text":"<pre><code># \u274c \u932f\u8aa4\uff1a\u672a\u6aa2\u67e5\ntrailing_window = data.history(context.sym, 'price', 35, '1d')\ndif = calculate_macd(trailing_window)  # \u5982\u679c\u8cc7\u6599\u6709 NaN \u6703\u51fa\u932f\n\n# \u2705 \u6b63\u78ba\uff1a\u5148\u6aa2\u67e5\ntrailing_window = data.history(context.sym, 'price', 35, '1d')\nif trailing_window.isnull().values.any():\n    return  # \u8cc7\u6599\u4e0d\u8db3\uff0c\u8df3\u904e\ndif = calculate_macd(trailing_window)\n</code></pre> <p>\u4f55\u6642\u6703\u9047\u5230 NaN\uff1f</p> <ul> <li>\u80a1\u7968\u525b\u4e0a\u5e02\uff08\u6b77\u53f2\u8cc7\u6599\u4e0d\u8db3\uff09</li> <li>\u505c\u724c\u671f\u9593</li> <li>\u56de\u6e2c\u521d\u671f\uff08\u9700\u8981 warm-up\uff09</li> </ul>"},{"location":"blocks/technicals/case-macd/#3-1-2","title":"3. \u4f7f\u7528 [-1] \u8207 [-2] \u7684\u908f\u8f2f","text":"<pre><code># dif[-1]\uff1a\u4eca\u5929\u7684 DIF\n# dif[-2]\uff1a\u6628\u5929\u7684 DIF\n\n# \u6aa2\u67e5\u300c\u6628\u5929 &lt; \u4eca\u5929\u300d\u624d\u7b97\u7a81\u7834\nif (dif[-2] &lt; macd[-2]) and (dif[-1] &gt; macd[-1]):\n    # \u6628\u5929 DIF \u5728 MACD \u4e0b\u65b9\n    # \u4eca\u5929 DIF \u5728 MACD \u4e0a\u65b9\n    # \u2192 \u767c\u751f\u9ec3\u91d1\u4ea4\u53c9\n</code></pre> <p>\u70ba\u4ec0\u9ebc\u4e0d\u7528 <code>dif[-1] &gt; dif[-2]</code>\uff1f</p> <ul> <li>\u9019\u53ea\u6aa2\u67e5 DIF \u662f\u5426\u4e0a\u5347</li> <li>\u4f46\u6c92\u6aa2\u67e5\u662f\u5426\u7a7f\u8d8a MACD</li> <li>\u5169\u8005\u6982\u5ff5\u4e0d\u540c</li> </ul>"},{"location":"blocks/technicals/case-macd/#4-talib","title":"4. talib \u7684\u4f7f\u7528\u6280\u5de7","text":"<pre><code># EMA \u8a08\u7b97\nema = talib.EMA(\n    trailing_window.values,  # \u5fc5\u9808\u662f numpy array\uff0c\u4e0d\u80fd\u662f pandas Series\n    timeperiod=12            # \u9031\u671f\u53c3\u6578\n)\n\n# \u56de\u50b3\u503c\u4e5f\u662f numpy array\nprint(type(ema))  # &lt;class 'numpy.ndarray'&gt;\n\n# \u53d6\u6700\u65b0\u503c\nlatest_ema = ema[-1]\n</code></pre>"},{"location":"blocks/technicals/case-macd/#_13","title":"\ud83c\udfaf \u5ef6\u4f38\u512a\u5316\u65b9\u5411","text":""},{"location":"blocks/technicals/case-macd/#1_1","title":"\u512a\u5316 1: \u52a0\u5165\u8da8\u52e2\u904e\u6ffe\u5668","text":"<pre><code># \u53ea\u5728\u660e\u78ba\u8da8\u52e2\u4e2d\u4ea4\u6613\nma200 = talib.SMA(trailing_window.values, timeperiod=200)\n\n# \u53ea\u5728\u50f9\u683c &gt; 200MA \u6642\u8cb7\u5165\uff08\u591a\u982d\u5e02\u5834\uff09\nif (dif[-1] &gt; macd[-1]) and (current_price &gt; ma200[-1]):\n    buy = True\n</code></pre>"},{"location":"blocks/technicals/case-macd/#2_1","title":"\u512a\u5316 2: \u52d5\u614b\u505c\u640d\u505c\u5229","text":"<pre><code>def handle_data(context, data):\n    # ... \u539f\u672c\u908f\u8f2f ...\n\n    if context.invested:\n        current_price = data.current(context.sym, 'price')\n\n        # ATR \u505c\u640d\n        atr = talib.ATR(high.values, low.values, close.values, timeperiod=14)\n        stop_loss = context.buy_price - (atr[-1] * 2)\n\n        if current_price &lt; stop_loss:\n            order_target(context.sym, 0)\n            context.invested = False\n            print(f\"ATR \u505c\u640d\u51fa\u5834\")\n</code></pre>"},{"location":"blocks/technicals/case-macd/#3","title":"\u512a\u5316 3: \u53c3\u6578\u512a\u5316","text":"<pre><code># \u6e2c\u8a66\u4e0d\u540c\u53c3\u6578\u7d44\u5408\nbest_sharpe = 0\nbest_params = None\n\nfor fast in range(8, 16):\n    for slow in range(20, 32):\n        for signal in range(7, 12):\n            results = backtest_macd(fast, slow, signal)\n            if results['sharpe'] &gt; best_sharpe:\n                best_sharpe = results['sharpe']\n                best_params = (fast, slow, signal)\n\nprint(f\"\u6700\u4f73\u53c3\u6578: {best_params}\")\nprint(f\"\u6700\u4f73\u590f\u666e: {best_sharpe:.2f}\")\n</code></pre>"},{"location":"blocks/technicals/case-macd/#4","title":"\u512a\u5316 4: \u52a0\u5165\u6210\u4ea4\u91cf\u78ba\u8a8d","text":"<pre><code># \u7a81\u7834\u6642\u6210\u4ea4\u91cf\u9700\u653e\u5927\nvolume = data.history(context.sym, 'volume', 20, '1d')\navg_volume = talib.SMA(volume.values, timeperiod=20)\ncurrent_volume = data.current(context.sym, 'volume')\n\n# \u8cb7\u5165\u689d\u4ef6\u52a0\u5165\u91cf\u80fd\u78ba\u8a8d\nif (dif[-1] &gt; macd[-1]) and (current_volume &gt; avg_volume[-1] * 1.2):\n    buy = True\n</code></pre>"},{"location":"blocks/technicals/case-macd/#5","title":"\u512a\u5316 5: \u91d1\u5b57\u5854\u52a0\u78bc","text":"<pre><code>def handle_data(context, data):\n    # ... \u8a08\u7b97 MACD ...\n\n    if buy_signal:\n        if not context.invested:\n            # \u9996\u6b21\u8cb7\u5165 1000 \u80a1\n            order(context.sym, 1000)\n            context.invested = True\n            context.position_count = 1\n\n        elif (bar[-1] &gt; bar[-2]) and (context.position_count &lt; 3):\n            # \u67f1\u72c0\u5716\u6301\u7e8c\u653e\u5927\uff0c\u52a0\u78bc\n            order(context.sym, 500)\n            context.position_count += 1\n            print(f\"\u52a0\u78bc\u81f3 {context.position_count} \u500b\u55ae\u4f4d\")\n</code></pre>"},{"location":"blocks/technicals/case-macd/#_14","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u6a21\u677f\u9801\u9762\uff1atemplate.md - \u96d9\u7dda\u4ea4\u53c9\u6a21\u677f</li> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md - \u7406\u89e3\u8a2d\u8a08\u539f\u7406</li> <li>\u5176\u4ed6\u6848\u4f8b\uff1a</li> <li>\u4e56\u96e2\u7387\u7b56\u7565 - \u53cd\u8f49\u7b56\u7565</li> <li>\u5e03\u6797\u901a\u9053\u7b56\u7565 - \u7a81\u7834\u7b56\u7565</li> </ul>"},{"location":"blocks/technicals/case-macd/#_15","title":"\ud83d\udca1 \u7e3d\u7d50","text":"<p>MACD \u7b56\u7565\u5c55\u793a\u4e86\u6280\u8853\u6307\u6a19\u67b6\u69cb\u7684\u6838\u5fc3\u512a\u52e2\uff1a</p> <ol> <li>\u2705 \u908f\u8f2f\u76f4\u89c0\uff1a\u8207\u624b\u52d5\u770b\u76e4\u4e00\u81f4</li> <li>\u2705 \u8a0a\u865f\u660e\u78ba\uff1a\u91d1\u53c9\u8cb7\u3001\u6b7b\u53c9\u8ce3</li> <li>\u2705 \u96d9\u91cd\u78ba\u8a8d\uff1a\u964d\u4f4e\u5047\u8a0a\u865f</li> <li>\u2705 \u8da8\u52e2\u8ddf\u96a8\uff1a\u9069\u5408\u6ce2\u6bb5\u64cd\u4f5c</li> </ol> <p>\u9069\u5408\u8ab0\u4f7f\u7528\uff1f</p> <ul> <li>\u6280\u8853\u5206\u6790\u611b\u597d\u8005</li> <li>\u504f\u597d\u8da8\u52e2\u8ddf\u96a8\u7b56\u7565</li> <li>\u4e2d\u9577\u7dda\u6ce2\u6bb5\u4ea4\u6613\u8005</li> </ul> <p>\u4f7f\u7528\u5efa\u8b70\uff1a</p> <ul> <li>\u2705 \u5728\u8da8\u52e2\u660e\u78ba\u7684\u5e02\u5834\u4f7f\u7528</li> <li>\u2705 \u642d\u914d\u5176\u4ed6\u6307\u6a19\u904e\u6ffe\uff08\u5982\u5747\u7dda\u3001\u6210\u4ea4\u91cf\uff09</li> <li>\u26a0\ufe0f \u907f\u514d\u5728\u76e4\u6574\u5e02\u5834\u4f7f\u7528</li> <li>\u26a0\ufe0f \u6ce8\u610f\u6eef\u5f8c\u6027\uff0c\u53ef\u80fd\u932f\u904e\u521d\u671f\u6f32\u5e45</li> </ul> <p>\ud83d\udc49 Next Step: </p> <ol> <li>\u8907\u88fd\u5b8c\u6574\u7a0b\u5f0f\u78bc\u5230 Jupyter Notebook</li> <li>\u4fee\u6539\u53c3\u6578\uff08\u5feb\u7dda\u3001\u6162\u7dda\u3001\u8a0a\u865f\u7dda\uff09</li> <li>\u6e2c\u8a66\u4e0d\u540c\u80a1\u7968</li> <li>\u52a0\u5165\u4f60\u7684\u512a\u5316\u908f\u8f2f</li> </ol>"},{"location":"blocks/technicals/case-macd/#_16","title":"\ud83d\udcd6 \u5ef6\u4f38\u95b1\u8b80","text":"<p>Gerald Appel \u7684 MACD \u539f\u5247\uff1a</p> <ol> <li>\u7528\u65bc\u5224\u65b7\u8da8\u52e2\u65b9\u5411\u8207\u5f37\u5ea6</li> <li>\u4e0d\u662f\u7d55\u5c0d\u7684\u8cb7\u8ce3\u8a0a\u865f</li> <li>\u9700\u642d\u914d\u5176\u4ed6\u5206\u6790\u5de5\u5177</li> <li>\u6ce8\u610f\u80cc\u96e2\u73fe\u8c61\uff08\u50f9\u683c\u8207 MACD \u4e0d\u4e00\u81f4\uff09</li> </ol> <p>\u9032\u968e\u61c9\u7528\uff1a</p> <ul> <li>MACD \u80cc\u96e2\uff08Divergence\uff09</li> <li>MACD \u67f1\u72c0\u5716\u7b56\u7565</li> <li>\u591a\u6642\u9593\u6846\u67b6 MACD</li> <li>MACD + RSI \u7d44\u5408</li> </ul>"},{"location":"blocks/technicals/faq/","title":"\u6280\u8853\u6307\u6a19\u67b6\u69cb - \u5e38\u898b\u554f\u984c FAQ","text":"<p>\u672c\u9801\u6574\u7406\u4f7f\u7528\u6280\u8853\u6307\u6a19\u67b6\u69cb\u6642\u6700\u5e38\u9047\u5230\u7684\u554f\u984c\u8207\u89e3\u6c7a\u65b9\u6848\u3002</p>"},{"location":"blocks/technicals/faq/#_1","title":"\ud83d\udcd1 \u76ee\u9304","text":"<ul> <li>\u57fa\u790e\u6982\u5ff5</li> <li>\u6578\u64da\u8655\u7406</li> <li>\u6307\u6a19\u8a08\u7b97</li> <li>\u8a0a\u865f\u5224\u65b7</li> <li>\u4ea4\u6613\u57f7\u884c</li> <li>\u9664\u932f\u6280\u5de7 </li> <li>\u6548\u80fd\u512a\u5316 </li> <li>\u5be6\u52d9\u61c9\u7528</li> </ul>"},{"location":"blocks/technicals/faq/#basics","title":"\u57fa\u790e\u6982\u5ff5","text":""},{"location":"blocks/technicals/faq/#q1-vs","title":"Q1: \u6280\u8853\u6307\u6a19\u67b6\u69cb vs \u8ca1\u5831\u9078\u80a1\u67b6\u69cb\uff0c\u6211\u8a72\u9078\u54ea\u500b\uff1f","text":"<p>\u6c7a\u7b56\u6a39\uff1a <pre><code>graph TD\n    A[\u4f60\u7684\u7b56\u7565] --&gt; B{\u4f7f\u7528\u4ec0\u9ebc\u6578\u64da?}\n    B --&gt;|\u50f9\u91cf\u8cc7\u6599| C{\u80a1\u7968\u6578\u91cf?}\n    B --&gt;|\u8ca1\u5831\u8cc7\u6599| D[\u8ca1\u5831\u9078\u80a1\u67b6\u69cb]\n\n    C --&gt;|1-10 \u6a94| E[\u2705 \u6280\u8853\u6307\u6a19\u67b6\u69cb]\n    C --&gt;|&gt;10 \u6a94| F{\u9700\u8981\u6975\u81f4\u6548\u80fd?}\n\n    F --&gt;|\u662f| G[Pipeline \u67b6\u69cb]\n    F --&gt;|\u5426| E\n\n    style E fill:#c8e6c9,stroke:#388e3c,stroke-width:3px</code></pre></p> <p>\u5feb\u901f\u5224\u65b7\uff1a</p> <ul> <li>\u2705 \u7528\u6280\u8853\u6307\u6a19\uff1aMACD\u3001KD\u3001RSI\u3001\u5747\u7dda\u7b49\u6280\u8853\u5206\u6790</li> <li>\u2705 \u7528\u8ca1\u5831\u9078\u80a1\uff1a\u672c\u76ca\u6bd4\u3001ROE\u3001\u8ca0\u50b5\u6bd4\u7b49\u57fa\u672c\u9762</li> <li>\u2705 \u7528 Pipeline\uff1a\u5927\u898f\u6a21\u80a1\u7968\u6c60 + \u81ea\u5b9a\u7fa9\u56e0\u5b50</li> </ul>"},{"location":"blocks/technicals/faq/#q2","title":"Q2: \u70ba\u4ec0\u9ebc\u6280\u8853\u6307\u6a19\u67b6\u69cb\u53ea\u9069\u5408\u5c11\u6578\u80a1\u7968\uff1f","text":"<p>\u539f\u56e0\uff1aLoop \u65b9\u6cd5\u7684\u6548\u80fd\u74f6\u9838 <pre><code># \u6bcf\u5929\u90fd\u8981\u57f7\u884c\u9019\u6bb5\u7a0b\u5f0f\nfor stock in stock_list:  # \u5047\u8a2d\u6709 100 \u6a94\n    history = data.history(stock, 'close', 50, '1d')  # \u6293 50 \u5929\u8cc7\u6599\n    macd = calculate_macd(history)  # \u8a08\u7b97\u6307\u6a19\n    # ... \u5224\u65b7\u8a0a\u865f ...\n# 100 \u6a94 \u00d7 \u6bcf\u5929 = \u975e\u5e38\u6162\uff01\n</code></pre></p> <p>\u6548\u80fd\u5c0d\u6bd4\uff1a</p> \u80a1\u7968\u6578 \u6280\u8853\u6307\u6a19\u67b6\u69cb Pipeline \u67b6\u69cb 1 \u6a94 \ud83d\udfe2 \u5feb\uff080.1 \u79d2/\u65e5\uff09 \ud83d\udfe1 \u4e2d\uff080.5 \u79d2/\u65e5\uff09 10 \u6a94 \ud83d\udfe1 \u4e2d\uff081 \u79d2/\u65e5\uff09 \ud83d\udfe2 \u5feb\uff080.6 \u79d2/\u65e5\uff09 50 \u6a94 \ud83d\udd34 \u6162\uff085 \u79d2/\u65e5\uff09 \ud83d\udfe2 \u5feb\uff081 \u79d2/\u65e5\uff09 100 \u6a94 \ud83d\udd34 \u8d85\u6162\uff0810 \u79d2/\u65e5\uff09 \ud83d\udfe2 \u5feb\uff081.5 \u79d2/\u65e5\uff09 <p>\u5efa\u8b70\uff1a</p> <ul> <li>1-10 \u6a94\uff1a\u6280\u8853\u6307\u6a19\u67b6\u69cb</li> <li>10-50 \u6a94\uff1a\u8996\u60c5\u6cc1\u9078\u64c7</li> <li>50+ \u6a94\uff1aPipeline \u67b6\u69cb</li> </ul>"},{"location":"blocks/technicals/faq/#q3","title":"Q3: \u4ec0\u9ebc\u662f\u300c\u524d\u8996\u504f\u5dee\u300d\uff1f\u6280\u8853\u6307\u6a19\u7b56\u7565\u600e\u9ebc\u907f\u514d\uff1f","text":"<p>\u524d\u8996\u504f\u5dee\u7684\u5b9a\u7fa9\uff1a</p> <p>\u4f7f\u7528\u300c\u672a\u4f86\u8cc7\u6599\u300d\u505a\u6c7a\u7b56\uff0c\u5c0e\u81f4\u56de\u6e2c\u7d50\u679c\u904e\u5ea6\u6a02\u89c0\u3002</p> <p>\u5e38\u898b\u932f\u8aa4\uff1a <pre><code># \u274c \u932f\u8aa4\u793a\u7bc4\uff1a\u7528\u4eca\u5929\u7684\u6307\u6a19\uff0c\u4eca\u5929\u5c31\u4e0b\u55ae\ndef handle_data(context, data):\n    # \u9019\u88e1\u7684 history \u300c\u4e0d\u5305\u542b\u300d\u4eca\u5929\u7684\u6536\u76e4\u50f9\n    trailing_window = data.history(stock, 'close', 20, '1d')\n    macd = calculate_macd(trailing_window)\n\n    # \u4f46\u662f\uff01\u5982\u679c\u4f60\u9019\u6a23\u5beb\uff1a\n    current_macd = macd[-1]  # \u9019\u662f\u300c\u6628\u5929\u300d\u7684 MACD\n\n    if current_macd &gt; 0:\n        order(stock, 100)  # \u4eca\u5929\u4e0b\u55ae\n    # \u9019\u662f\u5c0d\u7684\uff01\u7528\u6628\u5929\u7684\u6307\u6a19\uff0c\u4eca\u5929\u4e0b\u55ae\n</code></pre></p> <p>\u6b63\u78ba\u505a\u6cd5\uff1a <pre><code># \u2705 \u6b63\u78ba\uff1a\u7528\u6628\u5929\u7684\u6307\u6a19\u5224\u65b7\uff0c\u4eca\u5929\u4e0b\u55ae\nif (macd[-2] &lt; 0) and (macd[-1] &gt; 0):  # \u6628\u5929 &lt; 0\uff0c\u4eca\u5929 &gt; 0\n    order(stock, 100)  # \u4eca\u5929\u4e0b\u55ae\n\n# \u6216\u8005\u660e\u78ba\u8aaa\u660e\nyesterday_macd = macd[-2]\ntoday_macd = macd[-1]\n\nif (yesterday_macd &lt; 0) and (today_macd &gt; 0):\n    order(stock, 100)\n</code></pre></p> <p>\u95dc\u9375\u7406\u89e3\uff1a</p> <ul> <li><code>data.history()</code> \u4e0d\u5305\u542b\u7576\u5929 \u7684\u6536\u76e4\u50f9</li> <li><code>macd[-1]</code> \u662f \u6700\u65b0\u53ef\u7528 \u7684\u503c\uff08\u901a\u5e38\u662f\u6628\u5929\uff09</li> <li><code>macd[-2]</code> \u662f \u524d\u4e00\u5929 \u7684\u503c\uff08\u901a\u5e38\u662f\u524d\u5929\uff09</li> </ul>"},{"location":"blocks/technicals/faq/#data-process","title":"\u6578\u64da\u8655\u7406","text":""},{"location":"blocks/technicals/faq/#q4-datahistory","title":"Q4: data.history() \u56de\u50b3\u7684\u8cc7\u6599\u662f\u4ec0\u9ebc\u683c\u5f0f\uff1f","text":"<p>\u56de\u50b3\u683c\u5f0f\uff1apandas Series <pre><code>trailing_window = data.history(symbol('2330'), 'close', 20, '1d')\n\nprint(type(trailing_window))\n# &lt;class 'pandas.core.series.Series'&gt;\n\nprint(trailing_window)\n# 2023-01-01    500.0\n# 2023-01-02    505.0\n# ...\n# 2023-01-20    550.0\n# Name: Equity(2330 [2330]), Length: 20, dtype: float64\n</code></pre></p> <p>\u5e38\u7528\u64cd\u4f5c\uff1a <pre><code># \u8f49\u63db\u70ba numpy array\uff08talib \u9700\u8981\uff09\nclose_array = trailing_window.values\n\n# \u53d6\u6700\u65b0\u503c\nlatest = trailing_window.iloc[-1]  # \u6216 trailing_window[-1]\n\n# \u53d6\u524d\u4e00\u5929\nprevious = trailing_window.iloc[-2]\n\n# \u8a08\u7b97\u8b8a\u5316\u7387\npct_change = trailing_window.pct_change()\n</code></pre></p>"},{"location":"blocks/technicals/faq/#q5-datahistory-nan","title":"Q5: \u70ba\u4ec0\u9ebc data.history() \u6709\u6642\u5019\u56de\u50b3 NaN\uff1f","text":"<p>\u5e38\u898b\u539f\u56e0\uff1a</p> <p>\u539f\u56e0 1\uff1a\u8cc7\u6599\u4e0d\u8db3\uff08\u56de\u6e2c\u521d\u671f\uff09 <pre><code># \u56de\u6e2c\u7b2c\u4e00\u5929\ndef handle_data(context, data):\n    trailing_window = data.history(stock, 'close', 50, '1d')\n    # \u5982\u679c\u56de\u6e2c\u624d\u7b2c 10 \u5929\uff0c\u53ea\u6709 10 \u7b46\u8cc7\u6599\n    # \u5176\u4ed6 40 \u7b46\u6703\u662f NaN\n</code></pre></p> <p>\u89e3\u6c7a\u65b9\u6848\uff1a <pre><code># \u65b9\u6cd5 1: \u6aa2\u67e5 NaN\nif trailing_window.isnull().values.any():\n    return  # \u8df3\u904e\u9019\u4e00\u5929\n\n# \u65b9\u6cd5 2: \u8a2d\u5b9a\u6700\u5c0f\u8cc7\u6599\u91cf\nif len(trailing_window.dropna()) &lt; 50:\n    return\n</code></pre></p> <p>\u539f\u56e0 2\uff1a\u80a1\u7968\u505c\u724c <pre><code># \u67d0\u5929\u80a1\u7968\u505c\u724c\uff0c\u6c92\u6709\u4ea4\u6613\u8cc7\u6599\n# \u8a72\u5929\u6703\u662f NaN\n</code></pre></p> <p>\u89e3\u6c7a\u65b9\u6848\uff1a <pre><code># \u4f7f\u7528\u524d\u5411\u586b\u5145\ntrailing_window = trailing_window.fillna(method='ffill')\n\n# \u6216\u76f4\u63a5\u522a\u9664 NaN\ntrailing_window = trailing_window.dropna()\n</code></pre></p> <p>\u539f\u56e0 3\uff1a\u80a1\u7968\u525b\u4e0a\u5e02 <pre><code># \u65b0\u4e0a\u5e02\u80a1\u7968\u6b77\u53f2\u8cc7\u6599\u4e0d\u8db3\n</code></pre></p> <p>\u89e3\u6c7a\u65b9\u6848\uff1a <pre><code># \u5728\u56de\u6e2c\u524d\u904e\u6ffe\u6389\u65b0\u80a1\ndef initialize(context):\n    # \u53ea\u4ea4\u6613\u4e0a\u5e02\u8d85\u904e 1 \u5e74\u7684\u80a1\u7968\n    context.stocks = [s for s in stock_list if has_enough_history(s)]\n</code></pre></p>"},{"location":"blocks/technicals/faq/#q6","title":"Q6: \u5982\u4f55\u6293\u53d6\u591a\u500b\u6b04\u4f4d\u7684\u8cc7\u6599\uff1f","text":"<p>\u65b9\u6cd5 1\uff1a\u5206\u5225\u6293\u53d6 <pre><code>close = data.history(stock, 'close', 20, '1d')\nvolume = data.history(stock, 'volume', 20, '1d')\nhigh = data.history(stock, 'high', 20, '1d')\nlow = data.history(stock, 'low', 20, '1d')\n</code></pre></p> <p>\u65b9\u6cd5 2\uff1a\u4e00\u6b21\u6293\u53d6\uff08\u63a8\u85a6\uff09 <pre><code># \u6293\u53d6\u591a\u500b\u6b04\u4f4d\nbars = data.history(\n    stock,\n    ['open', 'high', 'low', 'close', 'volume'],\n    20,\n    '1d'\n)\n\n# bars \u662f DataFrame\nprint(type(bars))  # &lt;class 'pandas.core.frame.DataFrame'&gt;\n\n# \u53d6\u5f97\u5404\u6b04\u4f4d\nclose = bars['close']\nvolume = bars['volume']\nhigh = bars['high']\nlow = bars['low']\n</code></pre></p> <p>\u6548\u80fd\u6bd4\u8f03\uff1a <pre><code># \u6162\uff085 \u6b21 API \u8abf\u7528\uff09\nclose = data.history(stock, 'close', 20, '1d')\nvolume = data.history(stock, 'volume', 20, '1d')\nhigh = data.history(stock, 'high', 20, '1d')\nlow = data.history(stock, 'low', 20, '1d')\nopen_ = data.history(stock, 'open', 20, '1d')\n\n# \u5feb\uff081 \u6b21 API \u8abf\u7528\uff09\nbars = data.history(stock, ['open', 'high', 'low', 'close', 'volume'], 20, '1d')\n</code></pre></p>"},{"location":"blocks/technicals/faq/#indicator_cal","title":"\u6307\u6a19\u8a08\u7b97","text":""},{"location":"blocks/technicals/faq/#q7-talib","title":"Q7: talib \u8a08\u7b97\u7684\u7d50\u679c\u8ddf\u6211\u624b\u7b97\u4e0d\u4e00\u6a23\uff1f","text":"<p>\u5e38\u898b\u539f\u56e0\uff1aEMA \u521d\u59cb\u503c\u4e0d\u540c <pre><code># talib \u7684 EMA \u521d\u59cb\u503c\u662f\u7528 SMA\nema = talib.EMA(close, timeperiod=12)\n\n# \u624b\u7b97\u53ef\u80fd\u76f4\u63a5\u7528\u7b2c\u4e00\u7b46\u8cc7\u6599\n# \u5c0e\u81f4\u524d\u9762\u5e7e\u7b46\u5dee\u7570\u8f03\u5927\n</code></pre></p> <p>\u9a57\u8b49\u65b9\u6cd5\uff1a <pre><code>import talib\nimport pandas as pd\n\nclose = pd.Series([100, 102, 101, 103, 105])\n\n# talib \u8a08\u7b97\nema_talib = talib.EMA(close.values, timeperiod=3)\nprint(\"talib:\", ema_talib)\n\n# pandas \u8a08\u7b97\nema_pandas = close.ewm(span=3, adjust=False).mean()\nprint(\"pandas:\", ema_pandas.values)\n\n# \u524d\u9762\u5e7e\u7b46\u6703\u6709\u5dee\u7570\uff0c\u5f8c\u9762\u6703\u6536\u6582\n</code></pre></p> <p>\u5efa\u8b70\uff1a</p> <ul> <li>\u4f7f\u7528 talib \u8a08\u7b97\uff08\u696d\u754c\u6a19\u6e96\uff09</li> <li>\u5ffd\u7565\u524d\u9762\u5e7e\u7b46\u8cc7\u6599\uff08warm-up period\uff09</li> <li>\u6216\u7b49\u8cc7\u6599\u8db3\u5920\u5f8c\u518d\u958b\u59cb\u4ea4\u6613</li> </ul>"},{"location":"blocks/technicals/faq/#q8-talib","title":"Q8: \u5982\u4f55\u81ea\u5df1\u8a08\u7b97\u6280\u8853\u6307\u6a19\uff08\u4e0d\u7528 talib\uff09\uff1f","text":"<p>\u7bc4\u4f8b 1\uff1a\u7c21\u55ae\u79fb\u52d5\u5e73\u5747\uff08SMA\uff09 <pre><code>def calculate_sma(prices, period):\n    \"\"\"\u8a08\u7b97\u7c21\u55ae\u79fb\u52d5\u5e73\u5747\"\"\"\n    return prices.rolling(window=period).mean()\n\n# \u4f7f\u7528\nclose = data.history(stock, 'close', 50, '1d')\nsma20 = calculate_sma(close, 20)\n</code></pre></p> <p>\u7bc4\u4f8b 2\uff1a\u6307\u6578\u79fb\u52d5\u5e73\u5747\uff08EMA\uff09 <pre><code>def calculate_ema(prices, period):\n    \"\"\"\u8a08\u7b97\u6307\u6578\u79fb\u52d5\u5e73\u5747\"\"\"\n    return prices.ewm(span=period, adjust=False).mean()\n\n# \u4f7f\u7528\nema12 = calculate_ema(close, 12)\n</code></pre></p> <p>\u7bc4\u4f8b 3\uff1aMACD <pre><code>def calculate_macd(prices, fast=12, slow=26, signal=9):\n    \"\"\"\u8a08\u7b97 MACD\"\"\"\n    ema_fast = prices.ewm(span=fast, adjust=False).mean()\n    ema_slow = prices.ewm(span=slow, adjust=False).mean()\n\n    dif = ema_fast - ema_slow\n    macd = dif.ewm(span=signal, adjust=False).mean()\n    histogram = dif - macd\n\n    return dif, macd, histogram\n\n# \u4f7f\u7528\ndif, macd, hist = calculate_macd(close)\n</code></pre></p> <p>\u7bc4\u4f8b 4\uff1aRSI <pre><code>def calculate_rsi(prices, period=14):\n    \"\"\"\u8a08\u7b97 RSI\"\"\"\n    delta = prices.diff()\n\n    gain = delta.where(delta &gt; 0, 0)\n    loss = -delta.where(delta &lt; 0, 0)\n\n    avg_gain = gain.rolling(window=period).mean()\n    avg_loss = loss.rolling(window=period).mean()\n\n    rs = avg_gain / avg_loss\n    rsi = 100 - (100 / (1 + rs))\n\n    return rsi\n\n# \u4f7f\u7528\nrsi = calculate_rsi(close)\n</code></pre></p>"},{"location":"blocks/technicals/faq/#q9","title":"Q9: \u8a08\u7b97\u6307\u6a19\u6642\u9047\u5230\u9664\u4ee5\u96f6\u7684\u932f\u8aa4\uff1f","text":"<p>\u5e38\u898b\u60c5\u5883\uff1a <pre><code># \u8a08\u7b97 RSI\navg_loss = loss.rolling(window=14).mean()\nrs = avg_gain / avg_loss  # \u5982\u679c avg_loss = 0 \u6703\u51fa\u932f\n</code></pre></p> <p>\u89e3\u6c7a\u65b9\u6848\uff1a <pre><code># \u65b9\u6cd5 1: \u52a0\u4e0a\u5c0f\u6578\u907f\u514d\u9664\u4ee5\u96f6\nrs = avg_gain / (avg_loss + 1e-10)\n\n# \u65b9\u6cd5 2: \u4f7f\u7528 numpy.where\nimport numpy as np\nrs = np.where(avg_loss == 0, 0, avg_gain / avg_loss)\n\n# \u65b9\u6cd5 3: \u7528 pandas \u7684 replace\navg_loss = avg_loss.replace(0, np.nan)\nrs = avg_gain / avg_loss\n</code></pre></p>"},{"location":"blocks/technicals/faq/#signal","title":"\u8a0a\u865f\u5224\u65b7","text":""},{"location":"blocks/technicals/faq/#q10","title":"Q10: \u5982\u4f55\u5224\u65b7\u300c\u4ea4\u53c9\u300d\u8a0a\u865f\uff1f","text":"<p>\u9ec3\u91d1\u4ea4\u53c9\uff08\u5411\u4e0a\u7a7f\u8d8a\uff09\uff1a <pre><code># DIF \u5411\u4e0a\u7a7f\u8d8a MACD\ngolden_cross = (dif[-2] &lt; macd[-2]) and (dif[-1] &gt; macd[-1])\n\n# \u6216\u4f7f\u7528 pandas\ngolden_cross = (dif.shift(1) &lt; macd.shift(1)) &amp; (dif &gt; macd)\n</code></pre></p> <p>\u6b7b\u4ea1\u4ea4\u53c9\uff08\u5411\u4e0b\u7a7f\u8d8a\uff09\uff1a <pre><code># DIF \u5411\u4e0b\u7a7f\u8d8a MACD\ndeath_cross = (dif[-2] &gt; macd[-2]) and (dif[-1] &lt; macd[-1])\n</code></pre></p> <p>\u6ce8\u610f\u4e8b\u9805\uff1a <pre><code># \u274c \u932f\u8aa4\uff1a\u53ea\u6aa2\u67e5\u7576\u524d\u95dc\u4fc2\nif dif[-1] &gt; macd[-1]:\n    buy = True  # \u9019\u4e0d\u662f\u4ea4\u53c9\uff01\u53ea\u662f DIF \u5728 MACD \u4e0a\u65b9\n\n# \u2705 \u6b63\u78ba\uff1a\u6aa2\u67e5\u300c\u7a7f\u8d8a\u300d\u52d5\u4f5c\nif (dif[-2] &lt;= macd[-2]) and (dif[-1] &gt; macd[-1]):\n    buy = True  # \u9019\u624d\u662f\u4ea4\u53c9\n</code></pre></p>"},{"location":"blocks/technicals/faq/#q11","title":"Q11: \u5982\u4f55\u907f\u514d\u300c\u5047\u8a0a\u865f\u300d\uff1f","text":"<p>\u65b9\u6cd5 1\uff1a\u96d9\u91cd\u78ba\u8a8d <pre><code># MACD \u7b56\u7565\uff1aDIF \u7a7f\u8d8a MACD + \u67f1\u72c0\u5716\u8f49\u6b63\ngolden_cross = (dif[-2] &lt; macd[-2]) and (dif[-1] &gt; macd[-1])\nhistogram_turn_positive = (bar[-2] &lt; 0) and (bar[-1] &gt; 0)\n\nif golden_cross and histogram_turn_positive:\n    buy = True\n</code></pre></p> <p>\u65b9\u6cd5 2\uff1a\u52a0\u5165\u904e\u6ffe\u5668 <pre><code># \u53ea\u5728\u9577\u671f\u8da8\u52e2\u5411\u4e0a\u6642\u8cb7\u5165\nma200 = data.history(stock, 'close', 200, '1d').mean()\ncurrent_price = data.current(stock, 'price')\n\nif (macd_signal) and (current_price &gt; ma200):\n    buy = True\n</code></pre></p> <p>\u65b9\u6cd5 3\uff1a\u8a2d\u5b9a\u51b7\u537b\u671f <pre><code>def initialize(context):\n    context.last_trade_day = 0\n\ndef handle_data(context, data):\n    if buy_signal:\n        # \u8ddd\u96e2\u4e0a\u6b21\u4ea4\u6613\u81f3\u5c11 5 \u5929\n        if context.i - context.last_trade_day &gt;= 5:\n            order(stock, 100)\n            context.last_trade_day = context.i\n</code></pre></p> <p>\u65b9\u6cd5 4\uff1a\u78ba\u8a8d\u529b\u9053 <pre><code># \u6210\u4ea4\u91cf\u78ba\u8a8d\nvolume = data.current(stock, 'volume')\navg_volume = data.history(stock, 'volume', 20, '1d').mean()\n\nif (buy_signal) and (volume &gt; avg_volume * 1.5):\n    buy = True  # \u91cf\u50f9\u9f4a\u63da\n</code></pre></p>"},{"location":"blocks/technicals/faq/#q12","title":"Q12: \u591a\u500b\u6307\u6a19\u600e\u9ebc\u7d44\u5408\uff1f","text":"<p>\u65b9\u6cd5 1\uff1a\u5168\u90e8\u540c\u610f\uff08AND\uff09 <pre><code># MACD + RSI + \u5747\u7dda\nmacd_buy = (dif[-1] &gt; macd[-1])\nrsi_ok = (rsi[-1] &gt; 30) and (rsi[-1] &lt; 70)\nma_ok = (current_price &gt; ma20)\n\nif macd_buy and rsi_ok and ma_ok:\n    buy = True\n</code></pre></p> <p>\u65b9\u6cd5 2\uff1a\u4efb\u4e00\u540c\u610f\uff08OR\uff09 <pre><code># MACD \u6216 RSI \u4efb\u4e00\u7d66\u51fa\u8a0a\u865f\nmacd_buy = (dif[-1] &gt; macd[-1])\nrsi_buy = (rsi[-1] &lt; 30)\n\nif macd_buy or rsi_buy:\n    buy = True\n</code></pre></p> <p>\u65b9\u6cd5 3\uff1a\u8a08\u5206\u5236 <pre><code>score = 0\n\nif dif[-1] &gt; macd[-1]:\n    score += 2  # MACD \u7d66 2 \u5206\n\nif rsi[-1] &gt; 50:\n    score += 1  # RSI \u7d66 1 \u5206\n\nif current_price &gt; ma20:\n    score += 1  # \u5747\u7dda\u7d66 1 \u5206\n\nif score &gt;= 3:  # \u81f3\u5c11 3 \u5206\n    buy = True\n</code></pre></p> <p>\u65b9\u6cd5 4\uff1a\u968e\u5c64\u5f0f\u5224\u65b7 <pre><code># \u5148\u770b\u8da8\u52e2\uff0c\u518d\u770b\u6307\u6a19\nif current_price &gt; ma60:  # \u9577\u671f\u591a\u982d\n    if dif[-1] &gt; macd[-1]:  # MACD \u8cb7\u5165\n        if rsi[-1] &lt; 70:  # RSI \u672a\u8d85\u8cb7\n            buy = True\n</code></pre></p>"},{"location":"blocks/technicals/faq/#trade_excution","title":"\u4ea4\u6613\u57f7\u884c","text":""},{"location":"blocks/technicals/faq/#q13-orderorder_targetorder_target_percent","title":"Q13: order\u3001order_target\u3001order_target_percent \u6709\u4ec0\u9ebc\u5dee\u5225\uff1f","text":"<p>order\uff1a\u8cb7\u5165\u56fa\u5b9a\u80a1\u6578 <pre><code>order(stock, 100)   # \u8cb7\u5165 100 \u80a1\norder(stock, -100)  # \u8ce3\u51fa 100 \u80a1\n</code></pre></p> <p>order_target\uff1a\u8abf\u6574\u5230\u76ee\u6a19\u80a1\u6578 <pre><code># \u5047\u8a2d\u76ee\u524d\u6301\u6709 50 \u80a1\norder_target(stock, 100)  # \u6703\u518d\u8cb7 50 \u80a1\uff08\u8abf\u6574\u5230 100 \u80a1\uff09\norder_target(stock, 0)    # \u6703\u8ce3 50 \u80a1\uff08\u8abf\u6574\u5230 0 \u80a1\uff09\n</code></pre></p> <p>order_target_percent\uff1a\u8abf\u6574\u5230\u76ee\u6a19\u6bd4\u4f8b <pre><code># \u5047\u8a2d\u6295\u8cc7\u7d44\u5408\u50f9\u503c 1,000,000 \u5143\norder_target_percent(stock, 0.1)  # \u8a72\u80a1\u6301\u5009\u4f54 10%\uff08100,000 \u5143\uff09\norder_target_percent(stock, 0)    # \u6e05\u7a7a\u8a72\u80a1\n</code></pre></p> <p>\u4f7f\u7528\u60c5\u5883\uff1a <pre><code># \u60c5\u5883 1\uff1a\u56fa\u5b9a\u80a1\u6578\u7b56\u7565\nif buy_signal:\n    order(stock, 1000)  # \u6bcf\u6b21\u8cb7 1000 \u80a1\n\n# \u60c5\u5883 2\uff1a\u5168\u6709\u6216\u5168\u7121\nif buy_signal:\n    order_target_percent(stock, 1.0)  # \u5168\u5009\nelif sell_signal:\n    order_target(stock, 0)  # \u6e05\u7a7a\n\n# \u60c5\u5883 3\uff1a\u591a\u6a94\u7b49\u6b0a\u91cd\nstocks = [stock1, stock2, stock3]\nfor s in stocks:\n    order_target_percent(s, 1.0 / len(stocks))  # \u5404 33.3%\n</code></pre></p>"},{"location":"blocks/technicals/faq/#q14","title":"Q14: \u5982\u4f55\u5be6\u73fe\u300c\u505c\u640d\u505c\u5229\u300d\uff1f","text":"<p>\u65b9\u6cd5 1\uff1a\u56fa\u5b9a\u767e\u5206\u6bd4 <pre><code>def initialize(context):\n    context.buy_price = {}\n\ndef handle_data(context, data):\n    current_price = data.current(stock, 'price')\n\n    # \u8cb7\u5165\u6642\u8a18\u9304\u50f9\u683c\n    if buy_signal:\n        order(stock, 1000)\n        context.buy_price[stock] = current_price\n\n    # \u505c\u640d\uff1a\u8667\u640d 10%\n    if stock in context.buy_price:\n        if current_price &lt; context.buy_price[stock] * 0.9:\n            order_target(stock, 0)\n            print(f\"\u505c\u640d\u51fa\u5834: {current_price}\")\n\n    # \u505c\u5229\uff1a\u7372\u5229 20%\n    if stock in context.buy_price:\n        if current_price &gt; context.buy_price[stock] * 1.2:\n            order_target(stock, 0)\n            print(f\"\u505c\u5229\u51fa\u5834: {current_price}\")\n</code></pre></p> <p>\u65b9\u6cd5 2\uff1aATR \u505c\u640d <pre><code># \u4f7f\u7528 ATR\uff08Average True Range\uff09\u52d5\u614b\u8abf\u6574\natr = talib.ATR(high.values, low.values, close.values, timeperiod=14)\n\n# \u505c\u640d\u8ddd\u96e2 = 2 \u500d ATR\nstop_loss = context.buy_price[stock] - (atr[-1] * 2)\n\nif current_price &lt; stop_loss:\n    order_target(stock, 0)\n</code></pre></p> <p>\u65b9\u6cd5 3\uff1a\u8ffd\u8e64\u505c\u640d <pre><code>def initialize(context):\n    context.highest_price = {}\n\ndef handle_data(context, data):\n    current_price = data.current(stock, 'price')\n\n    # \u66f4\u65b0\u6700\u9ad8\u50f9\n    if stock in context.highest_price:\n        context.highest_price[stock] = max(\n            context.highest_price[stock],\n            current_price\n        )\n    else:\n        context.highest_price[stock] = current_price\n\n    # \u5f9e\u6700\u9ad8\u9ede\u56de\u843d 15% \u505c\u640d\n    if current_price &lt; context.highest_price[stock] * 0.85:\n        order_target(stock, 0)\n        print(f\"\u8ffd\u8e64\u505c\u640d: {current_price}\")\n</code></pre></p>"},{"location":"blocks/technicals/faq/#q15","title":"Q15: \u5982\u4f55\u907f\u514d\u300c\u904e\u5ea6\u4ea4\u6613\u300d\uff1f","text":"<p>\u554f\u984c\uff1a\u8a0a\u865f\u592a\u983b\u7e41 <pre><code># \u53ef\u80fd\u6bcf\u5929\u90fd\u6709\u8a0a\u865f\nif macd[-1] &gt; 0:\n    order(stock, 100)  # \u6bcf\u5929\u90fd\u8cb7\n</code></pre></p> <p>\u89e3\u6c7a\u65b9\u6848 1\uff1a\u51b7\u537b\u671f <pre><code>def initialize(context):\n    context.last_trade_day = 0\n    context.cooldown = 5  # \u51b7\u537b 5 \u5929\n\ndef handle_data(context, data):\n    if buy_signal:\n        if context.i - context.last_trade_day &gt;= context.cooldown:\n            order(stock, 100)\n            context.last_trade_day = context.i\n</code></pre></p> <p>\u89e3\u6c7a\u65b9\u6848 2\uff1a\u8a0a\u865f\u5f37\u5ea6\u904e\u6ffe <pre><code># \u53ea\u5728\u8a0a\u865f\u300c\u5920\u5f37\u300d\u6642\u4ea4\u6613\nif (dif[-1] - macd[-1]) &gt; threshold:  # DIF \u8981\u660e\u986f\u5927\u65bc MACD\n    buy = True\n</code></pre></p> <p>\u89e3\u6c7a\u65b9\u6848 3\uff1a\u72c0\u614b\u6a5f <pre><code>def initialize(context):\n    context.state = 'WAIT'  # WAIT, LONG, SHORT\n\ndef handle_data(context, data):\n    if context.state == 'WAIT':\n        if buy_signal:\n            order(stock, 1000)\n            context.state = 'LONG'\n\n    elif context.state == 'LONG':\n        if sell_signal:\n            order_target(stock, 0)\n            context.state = 'WAIT'\n        # \u6301\u6709\u671f\u9593\u4e0d\u6703\u91cd\u8907\u8cb7\u5165\n</code></pre></p>"},{"location":"blocks/technicals/faq/#debug","title":"\u9664\u932f\u6280\u5de7","text":""},{"location":"blocks/technicals/faq/#q16","title":"Q16: \u5982\u4f55\u5feb\u901f\u627e\u5230\u7b56\u7565\u554f\u984c\uff1f","text":"<p>\u5206\u5c64\u9664\u932f\u6cd5\uff1a</p> <p>Step 1\uff1a\u6e2c\u8a66\u6307\u6a19\u8a08\u7b97 <pre><code># \u55ae\u7368\u6e2c\u8a66\u6307\u6a19\nimport talib\n\nclose = [100, 102, 101, 103, 105, 104, 106, 108]\nema = talib.EMA(close, timeperiod=5)\nprint(ema)  # \u78ba\u8a8d\u8a08\u7b97\u6b63\u78ba\n</code></pre></p> <p>Step 2\uff1a\u6e2c\u8a66\u8a0a\u865f\u5224\u65b7 <pre><code>def handle_data(context, data):\n    # \u5370\u51fa\u95dc\u9375\u8b8a\u6578\n    print(f\"\u65e5\u671f: {data.current_dt.date()}\")\n    print(f\"DIF: {dif[-1]:.2f}, MACD: {macd[-1]:.2f}\")\n    print(f\"\u8cb7\u5165\u8a0a\u865f: {buy}, \u8ce3\u51fa\u8a0a\u865f: {sell}\")\n\n    # \u6aa2\u67e5\u908f\u8f2f\n    if buy:\n        print(\"  \u2192 \u57f7\u884c\u8cb7\u5165\")\n    elif sell:\n        print(\"  \u2192 \u57f7\u884c\u8ce3\u51fa\")\n</code></pre></p> <p>Step 3\uff1a\u77ed\u671f\u56de\u6e2c <pre><code># \u53ea\u56de\u6e2c 1 \u500b\u6708\nresults = run_algorithm(\n    start=pd.Timestamp('2023-01-01', tz='utc'),\n    end=pd.Timestamp('2023-02-01', tz='utc'),  # \u53ea\u8dd1 1 \u500b\u6708\n    ...\n)\n</code></pre></p> <p>Step 4\uff1a\u8996\u89ba\u5316\u6aa2\u67e5 <pre><code># \u5728 analyze \u4e2d\u7e6a\u88fd\u5716\u8868\ndef analyze(context, perf):\n    # \u6aa2\u67e5\u8cb7\u8ce3\u9ede\u4f4d\u7f6e\n    plt.plot(perf.index, perf['price'])\n    buy_signals = perf[perf['buy'] == True]\n    plt.scatter(buy_signals.index, buy_signals['price'], color='green')\n    plt.show()\n</code></pre></p>"},{"location":"blocks/technicals/faq/#q17","title":"Q17: \u5e38\u898b\u932f\u8aa4\u8a0a\u606f\u53ca\u89e3\u6c7a\u65b9\u6cd5","text":"<p>\u932f\u8aa4 1: <code>AttributeError: 'Series' object has no attribute 'values'</code> <pre><code># \u539f\u56e0\uff1apandas \u7248\u672c\u554f\u984c\n# \u89e3\u6c7a\uff1a\nclose_array = trailing_window.to_numpy()  # \u65b0\u7248\n# \u6216\nclose_array = trailing_window.values      # \u820a\u7248\n</code></pre></p> <p>\u932f\u8aa4 2: <code>ValueError: operands could not be broadcast together</code> <pre><code># \u539f\u56e0\uff1a\u9663\u5217\u9577\u5ea6\u4e0d\u4e00\u81f4\nema12 = talib.EMA(close, timeperiod=12)  # \u9577\u5ea6 N\nema26 = talib.EMA(close, timeperiod=26)  # \u9577\u5ea6 N\ndif = ema12 - ema26  # \u53ef\u4ee5\u76f8\u6e1b\n\n# \u4f46\u5982\u679c\uff1a\nclose_short = close[-10:]  # \u9577\u5ea6 10\nclose_long = close         # \u9577\u5ea6 N\n# \u4e0d\u80fd\u76f8\u6e1b\uff01\n\n# \u89e3\u6c7a\uff1a\u78ba\u4fdd\u9577\u5ea6\u4e00\u81f4\n</code></pre></p> <p>\u932f\u8aa4 3: <code>KeyError: Equity(XXX) does not exist</code> <pre><code># \u539f\u56e0\uff1a\u80a1\u7968\u4e0d\u5728 bundle \u4e2d\n# \u89e3\u6c7a\uff1a\n# 1. \u78ba\u8a8d ingest \u6642\u6709\u5305\u542b\u8a72\u80a1\u7968\n# 2. \u78ba\u8a8d\u65e5\u671f\u7bc4\u570d\u6b63\u78ba\n# 3. \u78ba\u8a8d\u80a1\u7968\u4ee3\u78bc\u6b63\u78ba\n</code></pre></p> <p>\u932f\u8aa4 4: <code>IndexError: index -1 is out of bounds</code> <pre><code># \u539f\u56e0\uff1a\u9663\u5217\u70ba\u7a7a\n# \u89e3\u6c7a\uff1a\u5148\u6aa2\u67e5\u9577\u5ea6\nif len(trailing_window) &gt; 0:\n    latest = trailing_window[-1]\n</code></pre></p>"},{"location":"blocks/technicals/faq/#optimize","title":"\u6548\u80fd\u512a\u5316","text":""},{"location":"blocks/technicals/faq/#q18","title":"Q18: \u56de\u6e2c\u901f\u5ea6\u592a\u6162\u600e\u9ebc\u8fa6\uff1f","text":"<p>\u512a\u5316\u6280\u5de7 1\uff1a\u6e1b\u5c11 history \u8abf\u7528 <pre><code># \u274c \u6162\uff1a\u591a\u6b21\u8abf\u7528\nclose = data.history(stock, 'close', 20, '1d')\nvolume = data.history(stock, 'volume', 20, '1d')\nhigh = data.history(stock, 'high', 20, '1d')\n\n# \u2705 \u5feb\uff1a\u4e00\u6b21\u8abf\u7528\nbars = data.history(stock, ['close', 'volume', 'high'], 20, '1d')\nclose = bars['close']\nvolume = bars['volume']\nhigh = bars['high']\n</code></pre></p> <p>\u512a\u5316\u6280\u5de7 2\uff1a\u5feb\u53d6\u8a08\u7b97\u7d50\u679c <pre><code>def initialize(context):\n    context.indicator_cache = {}\n\ndef handle_data(context, data):\n    current_date = data.current_dt.date()\n\n    # \u6aa2\u67e5\u5feb\u53d6\n    if current_date in context.indicator_cache:\n        macd = context.indicator_cache[current_date]\n    else:\n        # \u8a08\u7b97\u4e26\u5feb\u53d6\n        macd = calculate_macd(...)\n        context.indicator_cache[current_date] = macd\n</code></pre></p> <p>\u512a\u5316\u6280\u5de7 3\uff1a\u6e1b\u5c11\u8996\u89ba\u5316 <pre><code># \u56de\u6e2c\u6642\u95dc\u9589\u8996\u89ba\u5316\nresults = run_algorithm(\n    ...\n    # analyze=analyze  # \u8a3b\u89e3\u6389\n)\n</code></pre></p> <p>\u512a\u5316\u6280\u5de7 4\uff1a\u7e2e\u77ed\u56de\u6e2c\u671f\u9593 <pre><code># \u958b\u767c\u6642\u7528\u77ed\u671f\u6e2c\u8a66\nstart = '2023-01-01'\nend = '2023-03-31'  # \u53ea\u6e2c 3 \u500b\u6708\n\n# \u78ba\u8a8d\u908f\u8f2f\u6b63\u78ba\u5f8c\u518d\u8dd1\u5b8c\u6574\u671f\u9593\n</code></pre></p>"},{"location":"blocks/technicals/faq/#practice","title":"\u5be6\u52d9\u61c9\u7528","text":""},{"location":"blocks/technicals/faq/#q19","title":"Q19: \u5982\u4f55\u628a\u56de\u6e2c\u7b56\u7565\u90e8\u7f72\u5230\u5be6\u76e4\uff1f","text":"<p>\u6b65\u9a5f\uff1a</p> <p>Step 1\uff1a\u5efa\u7acb\u9078\u80a1\u8173\u672c <pre><code># daily_signal.py\nimport pandas as pd\nimport talib\nfrom get_data import get_latest_prices  # \u81ea\u5b9a\u7fa9\u51fd\u6578\n\ndef generate_signal(ticker):\n    \"\"\"\u7522\u751f\u4ea4\u6613\u8a0a\u865f\"\"\"\n    # \u6293\u53d6\u6700\u65b0\u50f9\u683c\n    close = get_latest_prices(ticker, days=50)\n\n    # \u8a08\u7b97 MACD\n    dif, macd, hist = talib.MACD(close)\n\n    # \u5224\u65b7\u8a0a\u865f\n    if (dif[-2] &lt; macd[-2]) and (dif[-1] &gt; macd[-1]):\n        return 'BUY'\n    elif (dif[-2] &gt; macd[-2]) and (dif[-1] &lt; macd[-1]):\n        return 'SELL'\n    else:\n        return 'HOLD'\n\n# \u6bcf\u65e5\u57f7\u884c\nsignal = generate_signal('2330')\nprint(f\"\u4eca\u65e5\u8a0a\u865f: {signal}\")\n</code></pre></p> <p>Step 2\uff1a\u5efa\u7acb\u6392\u7a0b <pre><code># \u4f7f\u7528 schedule \u6392\u7a0b\nimport schedule\nimport time\n\ndef job():\n    signal = generate_signal('2330')\n    if signal == 'BUY':\n        # \u767c\u9001\u901a\u77e5\u6216\u81ea\u52d5\u4e0b\u55ae\n        send_notification(f\"\u8cb7\u5165\u8a0a\u865f\uff1a2330\")\n\n# \u6bcf\u5929\u4e0b\u5348 1:30 \u57f7\u884c\nschedule.every().day.at(\"13:30\").do(job)\n\nwhile True:\n    schedule.run_pending()\n    time.sleep(60)\n</code></pre></p> <p>Step 3\uff1a\u98a8\u96aa\u63a7\u7ba1 <pre><code>def execute_with_safety(ticker, action, quantity):\n    \"\"\"\u5b89\u5168\u57f7\u884c\u4ea4\u6613\"\"\"\n    # \u6aa2\u67e5 1\uff1a\u5e33\u6236\u9918\u984d\n    if action == 'BUY' and get_cash() &lt; get_price(ticker) * quantity:\n        print(\"\u73fe\u91d1\u4e0d\u8db3\")\n        return False\n\n    # \u6aa2\u67e5 2\uff1a\u55ae\u4e00\u90e8\u4f4d\u9650\u5236\n    if get_position_value(ticker) / get_portfolio_value() &gt; 0.3:\n        print(\"\u55ae\u4e00\u90e8\u4f4d\u904e\u5927\")\n        return False\n\n    # \u57f7\u884c\u4ea4\u6613\n    broker_api.order(ticker, action, quantity)\n    return True\n</code></pre></p>"},{"location":"blocks/technicals/faq/#q20","title":"Q20: \u5982\u4f55\u8a55\u4f30\u7b56\u7565\u662f\u5426\u904e\u5ea6\u64ec\u5408\uff1f","text":"<p>\u6aa2\u9a57\u65b9\u6cd5\uff1a</p> <p>\u65b9\u6cd5 1\uff1a\u6a23\u672c\u5916\u6e2c\u8a66 <pre><code># \u8a13\u7df4\u671f\uff1a2018-2020\ntrain_results = run_algorithm(\n    start=pd.Timestamp('2018-01-01', tz='utc'),\n    end=pd.Timestamp('2020-12-31', tz='utc'),\n    ...\n)\n\n# \u6e2c\u8a66\u671f\uff1a2021-2023\ntest_results = run_algorithm(\n    start=pd.Timestamp('2021-01-01', tz='utc'),\n    end=pd.Timestamp('2023-12-31', tz='utc'),\n    ...\n)\n\n# \u6bd4\u8f03\u7e3e\u6548\nprint(f\"\u8a13\u7df4\u671f\u590f\u666e: {train_results['sharpe'].iloc[-1]:.2f}\")\nprint(f\"\u6e2c\u8a66\u671f\u590f\u666e: {test_results['sharpe'].iloc[-1]:.2f}\")\n\n# \u5982\u679c\u6e2c\u8a66\u671f\u660e\u986f\u8b8a\u5dee \u2192 \u904e\u64ec\u5408\n</code></pre></p> <p>\u65b9\u6cd5 2\uff1a\u53c3\u6578\u654f\u611f\u5ea6\u5206\u6790 <pre><code># \u6e2c\u8a66\u53c3\u6578\u8b8a\u5316\u7684\u5f71\u97ff\nresults = {}\n\nfor fast in [10, 12, 14]:\n    for slow in [24, 26, 28]:\n        sharpe = backtest_macd(fast, slow)\n        results[(fast, slow)] = sharpe\n\n# \u6aa2\u67e5\u7a69\u5b9a\u6027\nprint(results)\n# \u5982\u679c\u5c0f\u5e45\u8abf\u6574\u53c3\u6578\u5c31\u5927\u5e45\u5f71\u97ff\u7e3e\u6548 \u2192 \u904e\u64ec\u5408\n</code></pre></p> <p>\u65b9\u6cd5 3\uff1a\u4e0d\u540c\u5e02\u6cc1\u6e2c\u8a66 <pre><code># \u725b\u5e02\u671f\u9593\nbull_results = backtest('2019-01-01', '2020-02-01')\n\n# \u718a\u5e02\u671f\u9593\nbear_results = backtest('2020-03-01', '2020-06-01')\n\n# \u76e4\u6574\u671f\u9593\nsideways_results = backtest('2021-01-01', '2021-12-31')\n\n# \u7b56\u7565\u61c9\u8a72\u5728\u4e0d\u540c\u5e02\u6cc1\u90fd\u6709\u4e00\u5b9a\u8868\u73fe\n</code></pre></p> <p>\u65b9\u6cd5 4\uff1a\u591a\u6a94\u80a1\u7968\u6e2c\u8a66 <pre><code># \u6e2c\u8a66\u4e0d\u540c\u80a1\u7968\nstocks = ['2330', '2317', '2454', '2881', '2412']\nresults = {}\n\nfor stock in stocks:\n    sharpe = backtest_strategy(stock)\n    results[stock] = sharpe\n\n# \u5982\u679c\u53ea\u5728\u67d0\u4e00\u6a94\u8868\u73fe\u597d \u2192 \u53ef\u80fd\u904e\u64ec\u5408\n</code></pre></p>"},{"location":"blocks/technicals/faq/#_2","title":"\ud83d\udca1 \u6700\u4f73\u5be6\u8e10\u7e3d\u7d50","text":""},{"location":"blocks/technicals/faq/#do","title":"\u2705 DO\uff08\u5efa\u8b70\u505a\uff09","text":"<ol> <li>\u5148\u6e2c\u8a66\u5c0f\u7bc4\u570d\uff1a1 \u5929 \u2192 1 \u9031 \u2192 1 \u500b\u6708 \u2192 \u5168\u671f\u9593</li> <li>\u6aa2\u67e5\u8cc7\u6599\u5b8c\u6574\u6027\uff1a\u4f7f\u7528 <code>isnull()</code> \u6aa2\u67e5 NaN</li> <li>\u907f\u514d\u524d\u8996\u504f\u5dee\uff1a\u4f7f\u7528 <code>[-2]</code> \u548c <code>[-1]</code> \u5224\u65b7\u4ea4\u53c9</li> <li>\u52a0\u5165\u904e\u6ffe\u6a5f\u5236\uff1a\u907f\u514d\u5047\u8a0a\u865f\u548c\u904e\u5ea6\u4ea4\u6613</li> <li>\u8a18\u9304\u95dc\u9375\u8b8a\u6578\uff1a\u7528 <code>record()</code> \u8a18\u9304\u6307\u6a19\u503c</li> <li>\u6a23\u672c\u5916\u6e2c\u8a66\uff1a\u8a13\u7df4\u671f + \u6e2c\u8a66\u671f\u5206\u96e2</li> <li>\u53c3\u6578\u654f\u611f\u5ea6\u6e2c\u8a66\uff1a\u78ba\u4fdd\u7a69\u5b9a\u6027</li> <li>\u8996\u89ba\u5316\u6aa2\u67e5\uff1a\u7528\u5716\u8868\u6aa2\u67e5\u8cb7\u8ce3\u9ede</li> </ol>"},{"location":"blocks/technicals/faq/#dont","title":"\u274c DON'T\uff08\u907f\u514d\u505a\uff09","text":"<ol> <li>\u4e0d\u8981\u904e\u5ea6\u512a\u5316\u53c3\u6578\uff1a\u8abf\u5230\u5c0f\u6578\u9ede\u7b2c\u4e09\u4f4d</li> <li>\u4e0d\u8981\u5ffd\u7565\u4ea4\u6613\u6210\u672c\uff1a\u5047\u8a2d\u96f6\u6210\u672c</li> <li>\u4e0d\u8981\u53ea\u770b\u5831\u916c\u7387\uff1a\u5ffd\u7565\u98a8\u96aa\u3001\u56de\u64a4</li> <li>\u4e0d\u8981\u7528\u672a\u4f86\u8cc7\u6599\uff1a\u907f\u514d\u524d\u8996\u504f\u5dee</li> <li>\u4e0d\u8981\u904e\u5ea6\u4ea4\u6613\uff1a\u6bcf\u5929\u90fd\u8cb7\u8ce3</li> <li>\u4e0d\u8981\u55ae\u4e00\u6307\u6a19\uff1a\u6c92\u6709\u904e\u6ffe\u6a5f\u5236</li> <li>\u4e0d\u8981\u5ffd\u7565 NaN\uff1a\u76f4\u63a5\u8a08\u7b97\u6703\u51fa\u932f</li> <li>\u4e0d\u8981\u8df3\u904e\u9664\u932f\uff1a\u76f4\u63a5\u5168\u671f\u56de\u6e2c</li> </ol>"},{"location":"blocks/technicals/faq/#_3","title":"\ud83d\udd17 \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md</li> <li>Code \u6a21\u677f\uff1atemplate.md</li> <li>\u6848\u4f8b\u5b78\u7fd2\uff1a</li> <li>MACD \u7b56\u7565</li> <li>\u4e56\u96e2\u7387\u7b56\u7565</li> <li>\u5e03\u6797\u901a\u9053\u7b56\u7565</li> </ul> <p>\u9084\u6709\u554f\u984c\uff1f</p> <p>\u5982\u679c\u9019\u88e1\u6c92\u6709\u6db5\u84cb\u4f60\u7684\u554f\u984c\uff0c\u8acb\uff1a</p> <ol> <li>\u6aa2\u67e5 template.md \u7684\u8a3b\u89e3</li> <li>\u53c3\u8003\u4e09\u500b case study \u7684\u5be6\u4f5c</li> <li>\u56de\u5230 overview.md \u78ba\u8a8d\u662f\u5426\u9078\u5c0d\u67b6\u69cb</li> </ol> <p>\ud83d\udc49 \u6e96\u5099\u597d\u4e86\uff1f \u524d\u5f80 template.md \u958b\u59cb\u958b\u767c\u4f60\u7684\u7b56\u7565\uff01</p>"},{"location":"blocks/technicals/template/","title":"\u6280\u8853\u6307\u6a19\u67b6\u69cb - Code \u6a21\u677f","text":"<p>\u672c\u9801\u63d0\u4f9b\u53ef\u76f4\u63a5\u4f7f\u7528\u7684 Code Template\uff0c\u4e26\u6a19\u8a3b\u9700\u8981\u81ea\u5b9a\u7fa9\u7684\u90e8\u5206\u3002</p>"},{"location":"blocks/technicals/template/#_1","title":"\ud83d\udccb \u6a21\u677f\u7e3d\u89bd","text":"<p>\u6211\u5011\u5c07\u6280\u8853\u6307\u6a19\u56de\u6e2c\u6d41\u7a0b\u62c6\u89e3\u70ba\u56db\u500b\u6a21\u584a\uff0c\u8acb\u4f9d\u7167\u4f60\u7684\u9700\u6c42\u7d44\u88dd\uff1a</p> \u6a21\u584a (Module) \u6838\u5fc3\u529f\u80fd \u4f60\u7684\u4efb\u52d9 (Action) M1. \u57fa\u790e\u5efa\u8a2d <code>\u74b0\u5883\u8a2d\u5b9a</code> <code>\u6578\u64da\u532f\u5165</code> \ud83d\udfe2 \u8a2d\u5b9a\u53c3\u6578 (\u56de\u6e2c\u5340\u9593\u3001\u8cc7\u91d1\u3001\u6a19\u7684) M2. \u521d\u59cb\u8a2d\u5b9a <code>initialize</code> <code>\u5168\u57df\u8b8a\u6578</code> \ud83d\udd35 \u5b9a\u7fa9\u53c3\u6578 (\u6307\u6a19\u9031\u671f\u3001\u6ed1\u50f9\u3001\u624b\u7e8c\u8cbb) M3. \u4ea4\u6613\u6838\u5fc3 <code>handle_data</code> <code>\u6307\u6a19\u8a08\u7b97</code> \ud83d\udd25 \u5beb\u4e0b\u8cb7\u8ce3\u8a0a\u865f (\u9ec3\u91d1\u4ea4\u53c9\u3001RSI...) M4. \u57f7\u884c\u5f15\u64ce <code>run_algorithm</code> <code>\u7e3e\u6548\u5716\u8868</code> \ud83d\udd12 \u76f4\u63a5\u57f7\u884c (\u901a\u5e38\u7121\u9700\u4fee\u6539)"},{"location":"blocks/technicals/template/#_2","title":"\ud83c\udfaf \u5b8c\u6574\u6a21\u677f","text":""},{"location":"blocks/technicals/template/#module-1","title":"Module 1: \u74b0\u5883\u8a2d\u5b9a &amp; \u6578\u64da\u532f\u5165","text":"<pre><code># ====================================\n# Module 1: \u74b0\u5883\u8a2d\u5b9a &amp; \u6578\u64da\u532f\u5165\n# ====================================\n\nimport os\nimport pandas as pd\nimport numpy as np\nimport tejapi\nimport matplotlib.pyplot as plt\nimport talib\n\n# TEJ API \u8a2d\u5b9a\nos.environ['TEJAPI_BASE'] = 'https://api.tej.com.tw'\nos.environ['TEJAPI_KEY'] = 'your_key'\n\n# \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u56de\u6e2c\u53c3\u6578\nstart_date = '2018-12-30'\nend_date = '2023-05-26'\ncapital_base = 1e6  # \u521d\u59cb\u8cc7\u91d1\n\n# \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u6a19\u7684\u80a1\u7968\uff08\u901a\u5e38 1-10 \u6a94\uff09\nticker = '2330'  # \u53f0\u7a4d\u96fb\n\n# \u8a2d\u5b9a\u74b0\u5883\u8b8a\u6578\uff08\u4f9b zipline ingest \u4f7f\u7528\uff09\nos.environ['mdate'] = f'{start_date} {end_date}'\nos.environ['ticker'] = ticker\n\n# ====================================\n# \u532f\u5165\u80a1\u50f9\u8cc7\u6599\u5230 Zipline\n# ====================================\n# \u57f7\u884c\u6b64\u6307\u4ee4\uff08\u5728 Jupyter \u4e2d\u7528 ! \u958b\u982d\uff09\n# !zipline ingest -b tquant\n\n# \u6216\u662f\u4f7f\u7528 simple_ingest \u51fd\u6578\u532f\u5165\u8cc7\u6599\nfrom zipline.data.run_ingest import simple_ingest\n\nprint(f\"\u958b\u59cb\u532f\u5165\u8cc7\u6599\uff1a{ticker}\")\nprint(f\"\u671f\u9593\uff1a{start_date} ~ {end_date}\")\n\nsimple_ingest(\n    name='tquant',               # Bundle \u540d\u7a31\n    tickers=ticker,              # \u80a1\u7968\u6e05\u55ae (\u5fc5\u9808\u662f List)\n    start_date=start_date.replace('-', ''), # \u683c\u5f0f\u901a\u5e38\u5efa\u8b70 YYYYMMDD\n    end_date=end_date.replace('-', '')\n)\n</code></pre>"},{"location":"blocks/technicals/template/#module-2","title":"Module 2: \u521d\u59cb\u5316\u51fd\u6578","text":"<pre><code># ====================================\n# Module 2: \u521d\u59cb\u5316\u51fd\u6578\n# ====================================\n\nfrom zipline.api import (\n    set_slippage, set_commission, set_benchmark,\n    symbol, record, order, order_target, order_target_percent\n)\nfrom zipline.finance import commission, slippage\n\ndef initialize(context):\n    \"\"\"\n    \u56de\u6e2c\u521d\u59cb\u5316\u51fd\u6578\n\n    \u7528\u9014\uff1a\n    1. \u8a2d\u5b9a\u4ea4\u6613\u6210\u672c\n    2. \u8a2d\u5b9a\u57fa\u6e96\u6307\u6578\n    3. \u521d\u59cb\u5316\u7b56\u7565\u8b8a\u6578\n    \"\"\"\n    # ====================================\n    # \u4ea4\u6613\u6210\u672c\u8a2d\u5b9a\n    # ====================================\n    # \u6ed1\u50f9\u6a21\u578b\n    set_slippage(slippage.VolumeShareSlippage(\n        volume_limit=1,      # \ud83d\udd27 \u53ef\u8abf\uff1a\u6700\u5927\u6210\u4ea4\u91cf\u4f54\u6bd4\uff081 = 100%\uff09\n        price_impact=0.01    # \ud83d\udd27 \u53ef\u8abf\uff1a\u50f9\u683c\u885d\u64ca\uff080.01 = 1%\uff09\n    ))\n\n    # \u624b\u7e8c\u8cbb\u6a21\u578b\n    set_commission(commission.PerShare(\n        cost=0.001425,       # \ud83d\udd27 \u53ef\u8abf\uff1a\u6bcf\u80a1\u624b\u7e8c\u8cbb\uff080.1425%\uff09\n        min_trade_cost=20    # \u6700\u4f4e\u624b\u7e8c\u8cbb 20 \u5143\n    ))\n\n    # \u6216\u4f7f\u7528\u53f0\u7063\u5c08\u7528\u6a21\u578b\n    # set_commission(commission.Custom_TW_Commission(\n    #     min_trade_cost=20,\n    #     discount=0.6,\n    #     tax=0.003\n    # ))\n\n    # ====================================\n    # \u57fa\u6e96\u8a2d\u5b9a\n    # ====================================\n    context.sym = symbol(ticker)  # \u8a2d\u5b9a\u4ea4\u6613\u6a19\u7684\n    set_benchmark(context.sym)    # \u8a2d\u5b9a\u57fa\u6e96\uff08\u8cb7\u5165\u4e26\u6301\u6709\uff09\n\n    # ====================================\n    # \u7b56\u7565\u8b8a\u6578\u521d\u59cb\u5316\n    # ====================================\n    context.i = 0                # \u65e5\u671f\u8a08\u6578\u5668\n    context.invested = False     # \u662f\u5426\u6301\u6709\u90e8\u4f4d\n\n    # \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u7b56\u7565\u5c08\u7528\u8b8a\u6578\n    context.last_trade_day = 0   # \u4e0a\u6b21\u4ea4\u6613\u65e5\uff08\u907f\u514d\u904e\u5ea6\u4ea4\u6613\uff09\n    context.buy_price = 0        # \u8cb7\u5165\u50f9\u683c\uff08\u7528\u65bc\u505c\u640d\u505c\u5229\uff09\n</code></pre>"},{"location":"blocks/technicals/template/#module-3","title":"Module 3: \u6bcf\u65e5\u57f7\u884c\u51fd\u6578 \ud83d\udd25","text":"<p>\u9019\u662f\u6574\u500b\u7b56\u7565\u7684 \u6838\u5fc3 \uff0c\u6240\u6709\u6280\u8853\u6307\u6a19\u8a08\u7b97\u548c\u4ea4\u6613\u908f\u8f2f\u90fd\u5728\u9019\u88e1\u3002</p>"},{"location":"blocks/technicals/template/#a","title":"\ud83d\udccc \u6a21\u677f A\uff1a\u96d9\u7dda\u4ea4\u53c9\uff08\u6700\u5e38\u7528\uff09","text":"<pre><code># ====================================\n# Module 3A: \u6bcf\u65e5\u57f7\u884c - \u96d9\u7dda\u4ea4\u53c9\n# ====================================\n\ndef handle_data(context, data):\n    \"\"\"\n    \u6bcf\u65e5\u57f7\u884c\u51fd\u6578\n\n    \u908f\u8f2f\uff1a\n    1. \u6293\u53d6\u6b77\u53f2 K \u7dda\n    2. \u8a08\u7b97\u6280\u8853\u6307\u6a19\uff08\u5feb\u7dda\u3001\u6162\u7dda\uff09\n    3. \u5224\u65b7\u4ea4\u53c9\u8a0a\u865f\n    4. \u57f7\u884c\u4ea4\u6613\n    \"\"\"\n    # ========================================\n    # Step 1: \u6293\u53d6\u6b77\u53f2\u8cc7\u6599\n    # ========================================\n    # \ud83d\udd27 \u81ea\u5b9a\u7fa9\uff1a\u9700\u8981\u591a\u5c11\u5929\u7684\u8cc7\u6599\n    window_length = 35  # MACD(12,26,9) \u9700\u8981 26+9=35 \u5929\n\n    trailing_window = data.history(\n        context.sym,\n        'price',           # \u6b04\u4f4d\uff1a'open', 'high', 'low', 'close', 'volume'\n        window_length,\n        '1d'               # \u65e5\u7dda\n    )\n\n    # \u6aa2\u67e5\u8cc7\u6599\u5b8c\u6574\u6027\n    if trailing_window.isnull().values.any():\n        return  # \u8cc7\u6599\u4e0d\u8db3\uff0c\u8df3\u904e\n\n    # ========================================\n    # Step 2: \u8a08\u7b97\u6280\u8853\u6307\u6a19\n    # ========================================\n    # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u66ff\u63db\u6210\u4f60\u7684\u6307\u6a19\n\n    # \u7bc4\u4f8b 1: MACD\n    short_ema = talib.EMA(trailing_window.values, timeperiod=12)\n    long_ema = talib.EMA(trailing_window.values, timeperiod=26)\n    dif = short_ema - long_ema\n    macd = talib.EMA(dif, timeperiod=9)\n    bar = dif - macd\n\n    # \u7bc4\u4f8b 2: \u5747\u7dda\u4ea4\u53c9\n    # fast_ma = talib.SMA(trailing_window.values, timeperiod=5)\n    # slow_ma = talib.SMA(trailing_window.values, timeperiod=20)\n\n    # \u7bc4\u4f8b 3: KD \u6307\u6a19\n    # high = data.history(context.sym, 'high', window_length, '1d')\n    # low = data.history(context.sym, 'low', window_length, '1d')\n    # k, d = talib.STOCH(high.values, low.values, trailing_window.values)\n\n    # ========================================\n    # Step 3: \u8a0a\u865f\u5224\u65b7\n    # ========================================\n    buy = False\n    sell = False\n\n    # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u66ff\u63db\u6210\u4f60\u7684\u9032\u51fa\u5834\u908f\u8f2f\n\n    # \u8cb7\u5165\u8a0a\u865f\uff1a\u9ec3\u91d1\u4ea4\u53c9\n    if (dif[-2] &lt; macd[-2]) and (dif[-1] &gt; macd[-1]) and (bar[-2] &lt; 0) and (bar[-1] &gt; 0):\n        if not context.invested:\n            buy = True\n\n    # \u8ce3\u51fa\u8a0a\u865f\uff1a\u6b7b\u4ea1\u4ea4\u53c9\n    elif (dif[-2] &gt; macd[-2]) and (dif[-1] &lt; macd[-1]) and (bar[-2] &gt; 0) and (bar[-1] &lt; 0):\n        if context.invested:\n            sell = True\n\n    # ========================================\n    # Step 4: \u57f7\u884c\u4ea4\u6613\n    # ========================================\n    if buy:\n        order_target(context.sym, 1000)  # \ud83d\udd27 \u53ef\u8abf\uff1a\u8cb7\u5165\u80a1\u6578\n        context.invested = True\n        context.buy_price = data.current(context.sym, 'price')\n        print(f\"[{data.current_dt.date()}] \u8cb7\u5165\u8a0a\u865f\uff0c\u50f9\u683c: {context.buy_price:.2f}\")\n\n    elif sell:\n        order_target(context.sym, 0)  # \u6e05\u7a7a\u90e8\u4f4d\n        context.invested = False\n        sell_price = data.current(context.sym, 'price')\n        profit = ((sell_price / context.buy_price) - 1) * 100\n        print(f\"[{data.current_dt.date()}] \u8ce3\u51fa\u8a0a\u865f\uff0c\u50f9\u683c: {sell_price:.2f}, \u5831\u916c: {profit:.2f}%\")\n\n    # ========================================\n    # Step 5: \u8a18\u9304\u8b8a\u6578\uff08\u7528\u65bc\u5f8c\u7e8c\u5206\u6790\uff09\n    # ========================================\n    record(\n        price=data.current(context.sym, 'close'),\n        dif=dif[-1],\n        macd=macd[-1],\n        bar=bar[-1],\n        buy=buy,\n        sell=sell\n    )\n\n    context.i += 1\n</code></pre>"},{"location":"blocks/technicals/template/#b","title":"\ud83d\udccc \u6a21\u677f B\uff1a\u7a81\u7834\u7b56\u7565","text":"<pre><code># ====================================\n# Module 3B: \u6bcf\u65e5\u57f7\u884c - \u7a81\u7834\u7b56\u7565\n# ====================================\n\ndef handle_data(context, data):\n    \"\"\"\n    \u7a81\u7834\u7b56\u7565\u908f\u8f2f\n\n    \u8cb7\u5165\uff1a\u50f9\u683c\u7a81\u7834\u4e0a\u8ecc\n    \u8ce3\u51fa\uff1a\u50f9\u683c\u8dcc\u7834\u4e0b\u8ecc\n    \"\"\"\n    # ========================================\n    # \u6293\u53d6\u6b77\u53f2\u8cc7\u6599\n    # ========================================\n    window_length = 20\n    trailing_window = data.history(context.sym, 'close', window_length + 1, '1d')\n\n    if trailing_window.isnull().values.any():\n        return\n\n    # ========================================\n    # \u8a08\u7b97\u6280\u8853\u6307\u6a19\n    # ========================================\n    # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u8a08\u7b97\u4e0a\u8ecc\u3001\u4e0b\u8ecc\n\n    # \u7bc4\u4f8b 1: \u5e03\u6797\u901a\u9053\n    upper, middle, lower = talib.BBANDS(\n        trailing_window.values,\n        timeperiod=20,\n        nbdevup=2,    # \u4e0a\u8ecc\uff1a\u4e2d\u8ecc + 2 \u500d\u6a19\u6e96\u5dee\n        nbdevdn=2     # \u4e0b\u8ecc\uff1a\u4e2d\u8ecc - 2 \u500d\u6a19\u6e96\u5dee\n    )\n\n    # \u7bc4\u4f8b 2: \u5510\u5947\u5b89\u901a\u9053\n    # upper = trailing_window.rolling(20).max().iloc[-1]\n    # lower = trailing_window.rolling(20).min().iloc[-1]\n\n    # \u7bc4\u4f8b 3: \u56fa\u5b9a\u767e\u5206\u6bd4\u901a\u9053\n    # middle = talib.SMA(trailing_window.values, timeperiod=20)\n    # upper = middle[-1] * 1.05\n    # lower = middle[-1] * 0.95\n\n    current_price = data.current(context.sym, 'price')\n\n    # ========================================\n    # \u8a0a\u865f\u5224\u65b7\n    # ========================================\n    buy = False\n    sell = False\n\n    # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u7a81\u7834\u908f\u8f2f\n\n    # \u8cb7\u5165\uff1a\u7a81\u7834\u4e0a\u8ecc\n    if (current_price &gt; upper[-1]) and not context.invested:\n        buy = True\n\n    # \u8ce3\u51fa\uff1a\u8dcc\u7834\u4e0b\u8ecc\n    elif (current_price &lt; lower[-1]) and context.invested:\n        sell = True\n\n    # ========================================\n    # \u57f7\u884c\u4ea4\u6613\n    # ========================================\n    if buy:\n        order_target(context.sym, 1000)\n        context.invested = True\n        print(f\"[{data.current_dt.date()}] \u7a81\u7834\u8cb7\u5165\uff0c\u50f9\u683c: {current_price:.2f}\")\n\n    elif sell:\n        order_target(context.sym, 0)\n        context.invested = False\n        print(f\"[{data.current_dt.date()}] \u8dcc\u7834\u8ce3\u51fa\uff0c\u50f9\u683c: {current_price:.2f}\")\n\n    # ========================================\n    # \u8a18\u9304\u8b8a\u6578\n    # ========================================\n    record(\n        price=current_price,\n        upper=upper[-1],\n        middle=middle[-1],\n        lower=lower[-1],\n        buy=buy,\n        sell=sell\n    )\n\n    context.i += 1\n</code></pre>"},{"location":"blocks/technicals/template/#c","title":"\ud83d\udccc \u6a21\u677f C\uff1a\u53cd\u8f49\u7b56\u7565","text":"<pre><code># ====================================\n# Module 3C: \u6bcf\u65e5\u57f7\u884c - \u53cd\u8f49\u7b56\u7565\n# ====================================\n\ndef handle_data(context, data):\n    \"\"\"\n    \u53cd\u8f49\u7b56\u7565\u908f\u8f2f\n\n    \u8cb7\u5165\uff1a\u6307\u6a19\u8d85\u8ce3\uff08\u50f9\u683c\u504f\u96e2\u5747\u7dda\uff09\n    \u8ce3\u51fa\uff1a\u6307\u6a19\u8d85\u8cb7\n    \"\"\"\n    # ========================================\n    # \u6293\u53d6\u6b77\u53f2\u8cc7\u6599\n    # ========================================\n    window_length = 20\n    trailing_window = data.history(context.sym, 'close', window_length + 1, '1d')\n\n    if trailing_window.isnull().values.any():\n        return\n\n    # ========================================\n    # \u8a08\u7b97\u6280\u8853\u6307\u6a19\n    # ========================================\n    # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u8a08\u7b97\u53cd\u8f49\u6307\u6a19\n\n    # \u7bc4\u4f8b 1: \u4e56\u96e2\u7387\n    ema = talib.EMA(trailing_window.values, timeperiod=7)\n    current_price = data.current(context.sym, 'price')\n    bias = ((current_price - ema[-1]) / ema[-1]) * 100\n\n    # \u7bc4\u4f8b 2: RSI\n    # rsi = talib.RSI(trailing_window.values, timeperiod=14)\n\n    # \u7bc4\u4f8b 3: KD \u6307\u6a19\n    # high = data.history(context.sym, 'high', window_length, '1d')\n    # low = data.history(context.sym, 'low', window_length, '1d')\n    # k, d = talib.STOCH(high.values, low.values, trailing_window.values)\n\n    # ========================================\n    # \u984d\u5916\u904e\u6ffe\uff1a\u50f9\u683c\u7a81\u7834\n    # ========================================\n    high_prices = data.history(context.sym, 'high', 7, '1d')\n    low_prices = data.history(context.sym, 'low', 7, '1d')\n\n    highest_high = high_prices.max()\n    lowest_low = low_prices.min()\n\n    # ========================================\n    # \u8a0a\u865f\u5224\u65b7\n    # ========================================\n    buy = False\n    sell = False\n\n    # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u53cd\u8f49\u908f\u8f2f\n\n    # \u8cb7\u5165\uff1a\u8ca0\u4e56\u96e2 + \u5275\u65b0\u4f4e\n    if (bias &lt; -5) and (current_price &lt; lowest_low) and not context.invested:\n        buy = True\n\n    # \u8ce3\u51fa\uff1a\u6b63\u4e56\u96e2 + \u5275\u65b0\u9ad8\n    elif (bias &gt; 5) and (current_price &gt; highest_high) and context.invested:\n        sell = True\n\n    # \u7bc4\u4f8b\uff1aRSI \u8d85\u8cb7\u8d85\u8ce3\n    # if (rsi[-1] &lt; 30) and not context.invested:  # \u8d85\u8ce3\n    #     buy = True\n    # elif (rsi[-1] &gt; 70) and context.invested:    # \u8d85\u8cb7\n    #     sell = True\n\n    # ========================================\n    # \u57f7\u884c\u4ea4\u6613\n    # ========================================\n    if buy:\n        order_target(context.sym, 1000)\n        context.invested = True\n        context.buy_price = current_price\n        print(f\"[{data.current_dt.date()}] \u53cd\u8f49\u8cb7\u5165\uff0c\u4e56\u96e2: {bias:.2f}%\")\n\n    elif sell:\n        order_target(context.sym, 0)\n        context.invested = False\n        profit = ((current_price / context.buy_price) - 1) * 100\n        print(f\"[{data.current_dt.date()}] \u53cd\u8f49\u8ce3\u51fa\uff0c\u4e56\u96e2: {bias:.2f}%, \u5831\u916c: {profit:.2f}%\")\n\n    # ========================================\n    # \u8a18\u9304\u8b8a\u6578\n    # ========================================\n    record(\n        price=current_price,\n        ema=ema[-1],\n        bias=bias,\n        buy=buy,\n        sell=sell\n    )\n\n    context.i += 1\n</code></pre>"},{"location":"blocks/technicals/template/#d","title":"\ud83d\udccc \u6a21\u677f D\uff1a\u591a\u6307\u6a19\u7d44\u5408","text":"<pre><code># ====================================\n# Module 3D: \u6bcf\u65e5\u57f7\u884c - \u591a\u6307\u6a19\u7d44\u5408\n# ====================================\n\ndef handle_data(context, data):\n    \"\"\"\n    \u591a\u6307\u6a19\u7d44\u5408\u7b56\u7565\n\n    \u908f\u8f2f\uff1a\u591a\u500b\u6307\u6a19\u540c\u6642\u78ba\u8a8d\u624d\u4ea4\u6613\n    \"\"\"\n    # ========================================\n    # \u6293\u53d6\u6b77\u53f2\u8cc7\u6599\n    # ========================================\n    window_length = 50  # \u53d6\u8f03\u9577\u7684\u9031\u671f\n    close = data.history(context.sym, 'close', window_length, '1d')\n    high = data.history(context.sym, 'high', window_length, '1d')\n    low = data.history(context.sym, 'low', window_length, '1d')\n    volume = data.history(context.sym, 'volume', window_length, '1d')\n\n    if close.isnull().values.any():\n        return\n\n    # ========================================\n    # \u8a08\u7b97\u591a\u500b\u6307\u6a19\n    # ========================================\n    # \u6307\u6a19 1: MACD\n    macd, signal, hist = talib.MACD(close.values, fastperiod=12, slowperiod=26, signalperiod=9)\n\n    # \u6307\u6a19 2: RSI\n    rsi = talib.RSI(close.values, timeperiod=14)\n\n    # \u6307\u6a19 3: \u5747\u7dda\n    ma20 = talib.SMA(close.values, timeperiod=20)\n    ma60 = talib.SMA(close.values, timeperiod=60)\n\n    # \u6307\u6a19 4: \u6210\u4ea4\u91cf\n    avg_volume = talib.SMA(volume.values, timeperiod=20)\n\n    current_price = data.current(context.sym, 'price')\n    current_volume = data.current(context.sym, 'volume')\n\n    # ========================================\n    # \u8a0a\u865f\u5224\u65b7\uff08\u591a\u689d\u4ef6\u78ba\u8a8d\uff09\n    # ========================================\n    buy = False\n    sell = False\n\n    # \ud83d\udd25 \u81ea\u5b9a\u7fa9\u5340\uff1a\u7d44\u5408\u908f\u8f2f\n\n    # \u8cb7\u5165\u689d\u4ef6\uff08\u9700\u5168\u90e8\u6eff\u8db3\uff09\n    condition_1 = (macd[-1] &gt; signal[-1])           # MACD \u591a\u982d\n    condition_2 = (rsi[-1] &gt; 50) and (rsi[-1] &lt; 70) # RSI \u4e2d\u6027\u504f\u591a\n    condition_3 = (current_price &gt; ma20[-1])        # \u7ad9\u4e0a 20 \u65e5\u5747\u7dda\n    condition_4 = (ma20[-1] &gt; ma60[-1])             # \u77ed\u5747 &gt; \u9577\u5747\n    condition_5 = (current_volume &gt; avg_volume[-1]) # \u91cf\u80fd\u653e\u5927\n\n    if all([condition_1, condition_2, condition_3, condition_4, condition_5]) and not context.invested:\n        buy = True\n\n    # \u8ce3\u51fa\u689d\u4ef6\uff08\u4efb\u4e00\u6eff\u8db3\uff09\n    exit_1 = (macd[-1] &lt; signal[-1])           # MACD \u6b7b\u53c9\n    exit_2 = (rsi[-1] &gt; 70)                    # RSI \u8d85\u8cb7\n    exit_3 = (current_price &lt; ma20[-1])        # \u8dcc\u7834 20 \u65e5\u5747\u7dda\n\n    if any([exit_1, exit_2, exit_3]) and context.invested:\n        sell = True\n\n    # ========================================\n    # \u57f7\u884c\u4ea4\u6613\n    # ========================================\n    if buy:\n        order_target_percent(context.sym, 1.0)  # \u5168\u5009\u8cb7\u5165\n        context.invested = True\n        context.buy_price = current_price\n        print(f\"[{data.current_dt.date()}] \u591a\u6307\u6a19\u78ba\u8a8d\u8cb7\u5165\")\n        print(f\"  MACD: {macd[-1]:.2f}, RSI: {rsi[-1]:.2f}, \u50f9\u683c: {current_price:.2f}\")\n\n    elif sell:\n        order_target(context.sym, 0)\n        context.invested = False\n        profit = ((current_price / context.buy_price) - 1) * 100\n        print(f\"[{data.current_dt.date()}] \u89f8\u767c\u8ce3\u51fa\")\n        print(f\"  \u5831\u916c: {profit:.2f}%\")\n\n    # ========================================\n    # \u8a18\u9304\u8b8a\u6578\n    # ========================================\n    record(\n        price=current_price,\n        macd=macd[-1],\n        signal=signal[-1],\n        rsi=rsi[-1],\n        ma20=ma20[-1],\n        ma60=ma60[-1],\n        buy=buy,\n        sell=sell\n    )\n\n    context.i += 1\n</code></pre>"},{"location":"blocks/technicals/template/#module-4","title":"Module 4: \u7e3e\u6548\u5206\u6790 &amp; \u57f7\u884c\u56de\u6e2c","text":"<pre><code># ====================================\n# Module 4: \u7e3e\u6548\u5206\u6790\u51fd\u6578\n# ====================================\n\ndef analyze(context, perf):\n    \"\"\"\n    \u7e3e\u6548\u5206\u6790\u8207\u8996\u89ba\u5316\n    \"\"\"\n    import matplotlib.pyplot as plt\n\n    fig = plt.figure(figsize=(14, 10))\n\n    # ========================================\n    # \u4e0a\u5716\uff1a\u6295\u8cc7\u7d44\u5408\u50f9\u503c\n    # ========================================\n    ax1 = fig.add_subplot(311)\n    perf['portfolio_value'].plot(ax=ax1, label='Portfolio Value')\n    ax1.set_ylabel('Portfolio Value (TWD)')\n    ax1.set_title('Portfolio Performance')\n    ax1.legend()\n    ax1.grid(True, alpha=0.3)\n\n    # ========================================\n    # \u4e2d\u5716\uff1a\u7d2f\u7a4d\u5831\u916c vs \u57fa\u6e96\n    # ========================================\n    ax2 = fig.add_subplot(312)\n    cumulative_returns = (1 + perf['returns']).cumprod() - 1\n    benchmark_returns = (1 + perf['benchmark_return']).cumprod() - 1\n\n    cumulative_returns.plot(ax=ax2, label='Strategy', linewidth=2)\n    benchmark_returns.plot(ax=ax2, label='Buy &amp; Hold', linewidth=2, alpha=0.7)\n    ax2.set_ylabel('Cumulative Returns')\n    ax2.set_title('Strategy vs Buy &amp; Hold')\n    ax2.legend()\n    ax2.grid(True, alpha=0.3)\n\n    # ========================================\n    # \u4e0b\u5716\uff1a\u6280\u8853\u6307\u6a19 + \u8cb7\u8ce3\u9ede\n    # ========================================\n    ax3 = fig.add_subplot(313)\n\n    # \u7e6a\u88fd\u50f9\u683c\n    perf['price'].plot(ax=ax3, label='Price', color='black', linewidth=1.5)\n\n    # \u7e6a\u88fd\u6280\u8853\u6307\u6a19\uff08\u6839\u64da\u4f60\u7684\u7b56\u7565\u8abf\u6574\uff09\n    if 'dif' in perf.columns and 'macd' in perf.columns:\n        # MACD \u7b56\u7565\n        ax3_twin = ax3.twinx()\n        perf['dif'].plot(ax=ax3_twin, label='DIF', color='blue', alpha=0.5)\n        perf['macd'].plot(ax=ax3_twin, label='MACD', color='red', alpha=0.5)\n        ax3_twin.set_ylabel('MACD')\n        ax3_twin.legend(loc='upper right')\n\n    elif 'upper' in perf.columns and 'lower' in perf.columns:\n        # \u5e03\u6797\u901a\u9053\u7b56\u7565\n        perf['upper'].plot(ax=ax3, label='Upper Band', color='red', alpha=0.5)\n        perf['lower'].plot(ax=ax3, label='Lower Band', color='green', alpha=0.5)\n\n    # \u6a19\u8a18\u8cb7\u8ce3\u9ede\n    buy_signals = perf[perf['buy'] == True]\n    sell_signals = perf[perf['sell'] == True]\n\n    ax3.plot(\n        buy_signals.index,\n        buy_signals['price'],\n        '^',\n        markersize=10,\n        color='green',\n        label='Buy'\n    )\n    ax3.plot(\n        sell_signals.index,\n        sell_signals['price'],\n        'v',\n        markersize=10,\n        color='red',\n        label='Sell'\n    )\n\n    ax3.set_ylabel('Price (TWD)')\n    ax3.set_xlabel('Date')\n    ax3.set_title('Price &amp; Indicators')\n    ax3.legend(loc='upper left')\n    ax3.grid(True, alpha=0.3)\n\n    plt.tight_layout()\n    plt.show()\n\n    # \u5132\u5b58\u7e3e\u6548\u6578\u64da\n    perf.to_csv(f'performance_{ticker}.csv')\n    print(f\"\\n\u7e3e\u6548\u6578\u64da\u5df2\u5132\u5b58\u81f3: performance_{ticker}.csv\")\n\n# ====================================\n# \u57f7\u884c\u56de\u6e2c\n# ====================================\nfrom zipline import run_algorithm\n\nprint(\"=\"*60)\nprint(\"\u958b\u59cb\u56de\u6e2c\u6280\u8853\u6307\u6a19\u7b56\u7565\")\nprint(\"=\"*60)\n\nresults = run_algorithm(\n    start=pd.Timestamp(start_date, tz='utc'),\n    end=pd.Timestamp(end_date, tz='utc'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    bundle='tquant',\n    capital_base=capital_base,\n    data_frequency='daily'\n)\n\nprint(\"\\n\u56de\u6e2c\u5b8c\u6210\uff01\")\n\n# ====================================\n# \u7e3e\u6548\u7d71\u8a08\n# ====================================\nprint(\"\\n========== \u7e3e\u6548\u6458\u8981 ==========\")\ntotal_return = (results['portfolio_value'].iloc[-1] / capital_base - 1) * 100\nbuy_hold_return = (results['benchmark_period_return'].iloc[-1]) * 100\n\nprint(f\"\u521d\u59cb\u8cc7\u91d1: {capital_base:,.0f} \u5143\")\nprint(f\"\u6700\u7d42\u8cc7\u91d1: {results['portfolio_value'].iloc[-1]:,.0f} \u5143\")\nprint(f\"\u7b56\u7565\u7e3d\u5831\u916c: {total_return:.2f}%\")\nprint(f\"\u8cb7\u5165\u6301\u6709\u5831\u916c: {buy_hold_return:.2f}%\")\nprint(f\"\u8d85\u984d\u5831\u916c: {(total_return - buy_hold_return):.2f}%\")\nprint(f\"\u6700\u5927\u56de\u64a4: {results['max_drawdown'].min() * 100:.2f}%\")\nprint(f\"\u590f\u666e\u6bd4\u7387: {results['sharpe'].iloc[-1]:.2f}\")\n\n# \u4ea4\u6613\u7d71\u8a08\ntransactions = results['transactions']\nif len(transactions) &gt; 0:\n    num_trades = len(transactions)\n    print(f\"\u4ea4\u6613\u6b21\u6578: {num_trades}\")\n    print(f\"\u5e73\u5747\u6301\u6709\u5929\u6578: {len(results) / (num_trades / 2):.0f} \u5929\")\n</code></pre>"},{"location":"blocks/technicals/template/#_3","title":"\ud83c\udfaf \u4f7f\u7528\u6307\u5357","text":""},{"location":"blocks/technicals/template/#step-1","title":"Step 1: \u9078\u64c7\u6a21\u677f","text":"<p>\u6839\u64da\u4f60\u7684\u7b56\u7565\u985e\u578b\u9078\u64c7\uff1a</p> <ul> <li>\u6a21\u677f A\uff08\u96d9\u7dda\u4ea4\u53c9\uff09\uff1aMACD\u3001\u5747\u7dda\u4ea4\u53c9\u3001KD \u4ea4\u53c9</li> <li>\u6a21\u677f B\uff08\u7a81\u7834\u7b56\u7565\uff09\uff1a\u5e03\u6797\u901a\u9053\u3001\u5510\u5947\u5b89\u901a\u9053</li> <li>\u6a21\u677f C\uff08\u53cd\u8f49\u7b56\u7565\uff09\uff1a\u4e56\u96e2\u7387\u3001RSI\u3001KD \u8d85\u8cb7\u8d85\u8ce3</li> <li>\u6a21\u677f D\uff08\u591a\u6307\u6a19\u7d44\u5408\uff09\uff1a\u7d9c\u5408\u5224\u65b7</li> </ul>"},{"location":"blocks/technicals/template/#step-2","title":"Step 2: \u81ea\u5b9a\u7fa9\u6838\u5fc3\u908f\u8f2f","text":"<p>\u4fee\u6539 <code>handle_data()</code> \u51fd\u6578\u4e2d\u7684 \ud83d\udd25 \u6a19\u8a18\u5340\u57df\uff1a <pre><code># 1. \u8abf\u6574\u6b77\u53f2\u8cc7\u6599\u9577\u5ea6\nwindow_length = 35  # \u6539\u6210\u4f60\u9700\u8981\u7684\u5929\u6578\n\n# 2. \u66ff\u63db\u6280\u8853\u6307\u6a19\u8a08\u7b97\nshort_ema = talib.EMA(trailing_window.values, timeperiod=12)  # \u6539\u6210\u4f60\u7684\u6307\u6a19\n\n# 3. \u4fee\u6539\u9032\u51fa\u5834\u908f\u8f2f\nif (your_condition):\n    buy = True\n</code></pre></p>"},{"location":"blocks/technicals/template/#step-3","title":"Step 3: \u8abf\u6574\u53c3\u6578","text":"<pre><code># \u56de\u6e2c\u671f\u9593\nstart_date = '2020-01-01'\nend_date = '2023-12-31'\n\n# \u4ea4\u6613\u6a19\u7684\nticker = '2330'  # \u6539\u6210\u4f60\u60f3\u6e2c\u8a66\u7684\u80a1\u7968\n\n# \u4ea4\u6613\u80a1\u6578\norder_target(context.sym, 1000)  # \u6539\u6210\u4f60\u7684\u90e8\u4f4d\u5927\u5c0f\n</code></pre>"},{"location":"blocks/technicals/template/#step-4","title":"Step 4: \u57f7\u884c\u56de\u6e2c","text":"<pre><code>results = run_algorithm(...)\n</code></pre>"},{"location":"blocks/technicals/template/#_4","title":"\ud83d\udcda \u5e38\u7528\u6280\u8853\u6307\u6a19\u901f\u67e5","text":""},{"location":"blocks/technicals/template/#_5","title":"\u8da8\u52e2\u6307\u6a19","text":"<pre><code># \u79fb\u52d5\u5e73\u5747\nsma = talib.SMA(close, timeperiod=20)\nema = talib.EMA(close, timeperiod=20)\nwma = talib.WMA(close, timeperiod=20)\n\n# MACD\nmacd, signal, hist = talib.MACD(close, fastperiod=12, slowperiod=26, signalperiod=9)\n\n# ADX\uff08\u8da8\u52e2\u5f37\u5ea6\uff09\nadx = talib.ADX(high, low, close, timeperiod=14)\n</code></pre>"},{"location":"blocks/technicals/template/#_6","title":"\u9707\u76ea\u6307\u6a19","text":"<pre><code># RSI\nrsi = talib.RSI(close, timeperiod=14)\n\n# KD \u6307\u6a19\nk, d = talib.STOCH(high, low, close, \n                   fastk_period=14, slowk_period=3, slowd_period=3)\n\n# CCI\ncci = talib.CCI(high, low, close, timeperiod=14)\n\n# \u5a01\u5ec9\u6307\u6a19\nwillr = talib.WILLR(high, low, close, timeperiod=14)\n</code></pre>"},{"location":"blocks/technicals/template/#_7","title":"\u901a\u9053\u6307\u6a19","text":"<pre><code># \u5e03\u6797\u901a\u9053\nupper, middle, lower = talib.BBANDS(close, timeperiod=20, nbdevup=2, nbdevdn=2)\n\n# \u5510\u5947\u5b89\u901a\u9053\uff08\u624b\u5beb\uff09\nupper_band = close.rolling(20).max()\nlower_band = close.rolling(20).min()\n</code></pre>"},{"location":"blocks/technicals/template/#_8","title":"\u6210\u4ea4\u91cf\u6307\u6a19","text":"<pre><code># OBV\nobv = talib.OBV(close, volume)\n\n# \u6210\u4ea4\u91cf\u79fb\u52d5\u5e73\u5747\nvol_ma = talib.SMA(volume, timeperiod=20)\n</code></pre>"},{"location":"blocks/technicals/template/#_9","title":"\ud83d\udca1 \u9032\u968e\u6280\u5de7","text":""},{"location":"blocks/technicals/template/#1","title":"\u6280\u5de7 1: \u907f\u514d\u904e\u5ea6\u4ea4\u6613","text":"<pre><code># \u52a0\u5165\u51b7\u537b\u671f\ndef handle_data(context, data):\n    # ... \u8a08\u7b97\u8a0a\u865f ...\n\n    if buy_signal:\n        # \u6aa2\u67e5\u8ddd\u96e2\u4e0a\u6b21\u4ea4\u6613\u662f\u5426\u8d85\u904e 5 \u5929\n        if context.i - context.last_trade_day &gt; 5:\n            order_target(stock, 1000)\n            context.last_trade_day = context.i\n</code></pre>"},{"location":"blocks/technicals/template/#2","title":"\u6280\u5de7 2: \u505c\u640d\u505c\u5229","text":"<pre><code>def handle_data(context, data):\n    current_price = data.current(context.sym, 'price')\n\n    # \u505c\u640d\uff1a\u8667\u640d\u8d85\u904e 10%\n    if context.invested and (current_price &lt; context.buy_price * 0.9):\n        order_target(context.sym, 0)\n        context.invested = False\n        print(f\"\u505c\u640d\u51fa\u5834: {current_price}\")\n\n    # \u505c\u5229\uff1a\u7372\u5229\u8d85\u904e 20%\n    elif context.invested and (current_price &gt; context.buy_price * 1.2):\n        order_target(context.sym, 0)\n        context.invested = False\n        print(f\"\u505c\u5229\u51fa\u5834: {current_price}\")\n</code></pre>"},{"location":"blocks/technicals/template/#3","title":"\u6280\u5de7 3: \u91d1\u5b57\u5854\u52a0\u78bc","text":"<pre><code>def handle_data(context, data):\n    current_price = data.current(context.sym, 'price')\n\n    if buy_signal:\n        if not context.invested:\n            # \u9996\u6b21\u8cb7\u5165 1000 \u80a1\n            order(context.sym, 1000)\n            context.invested = True\n            context.buy_price = current_price\n\n        elif current_price &lt; context.buy_price * 0.95:\n            # \u50f9\u683c\u56de\u6a94 5%\uff0c\u52a0\u78bc 500 \u80a1\n            order(context.sym, 500)\n            print(f\"\u52a0\u78bc: {current_price}\")\n</code></pre>"},{"location":"blocks/technicals/template/#4","title":"\u6280\u5de7 4: \u52d5\u614b\u90e8\u4f4d\u7ba1\u7406","text":"<pre><code>def handle_data(context, data):\n    # \u6839\u64da ATR \u8abf\u6574\u90e8\u4f4d\u5927\u5c0f\n    atr = talib.ATR(high.values, low.values, close.values, timeperiod=14)\n\n    # \u56fa\u5b9a\u98a8\u96aa\uff1a\u6bcf\u7b46\u4ea4\u6613\u98a8\u96aa 1%\n    risk_per_trade = context.portfolio.portfolio_value * 0.01\n    position_size = risk_per_trade / (atr[-1] * 2)  # \u4ee5 2 \u500d ATR \u4f5c\u70ba\u505c\u640d\u8ddd\u96e2\n\n    if buy_signal:\n        order(context.sym, int(position_size))\n</code></pre>"},{"location":"blocks/technicals/template/#_10","title":"\ud83d\udcda \u76f8\u95dc\u8cc7\u6e90","text":"<ul> <li>\u67b6\u69cb\u8aaa\u660e\uff1aindex.md</li> <li>\u6848\u4f8b\u5b78\u7fd2\uff1a</li> <li>MACD \u7b56\u7565</li> <li>\u4e56\u96e2\u7387\u7b56\u7565</li> <li>\u5e03\u6797\u901a\u9053\u7b56\u7565</li> <li>\u5e38\u898b\u554f\u984c\uff1afaq.md</li> </ul> <p>\ud83d\udc49 Next Step: \u9078\u64c7\u4e00\u500b\u6a21\u677f\uff0c\u53c3\u8003\u5c0d\u61c9\u7684 case study\uff0c\u958b\u59cb\u958b\u767c\u4f60\u7684\u6280\u8853\u6307\u6a19\u7b56\u7565\uff01</p>"},{"location":"concepts/alphalens-overview/","title":"Alphalens \u56e0\u5b50\u5206\u6790\u6982\u8ad6","text":"<p>Info</p> <p>\u672c\u9801\u4ecb\u7d39 TQuant Lab \u4e2d\u6574\u5408\u7684\u5f37\u5927\u56e0\u5b50\u5206\u6790\u5de5\u5177 Alphalens\uff0c\u5167\u5bb9\u6db5\u84cb\u5176\u6838\u5fc3\u529f\u80fd\u3001\u5982\u4f55\u5f9e Pipeline \u56e0\u5b50\u6578\u64da\u4e2d\u751f\u6210\u56e0\u5b50\u5206\u6790\u5831\u544a\uff0c\u4ee5\u53ca\u5982\u4f55\u89e3\u8b80\u5831\u544a\u4e2d\u7684\u95dc\u9375\u6307\u6a19\u548c\u5716\u8868\uff0c\u5e6b\u52a9\u60a8\u6df1\u5165\u8a55\u4f30\u56e0\u5b50\u7684\u6709\u6548\u6027\u3002</p> <p>\u5728\u91cf\u5316\u6295\u8cc7\u4e2d\uff0c\u56e0\u5b50 (Factor) \u662f\u9a45\u52d5\u7b56\u7565\u7684\u6838\u5fc3\u3002\u4e00\u500b\u6709\u6548\u7684\u56e0\u5b50\u80fd\u5920\u9810\u6e2c\u8cc7\u7522\u672a\u4f86\u7684\u5831\u916c\uff0c\u5f9e\u800c\u70ba\u7b56\u7565\u5e36\u4f86\u8d85\u984d\u6536\u76ca\u3002\u7136\u800c\uff0c\u5982\u4f55\u79d1\u5b78\u5730\u8a55\u4f30\u4e00\u500b\u56e0\u5b50\u7684\u6709\u6548\u6027\u3001\u7a69\u5b9a\u6027\u4ee5\u53ca\u5176\u6f5b\u5728\u7684\u4ea4\u6613\u6210\u672c\uff0c\u662f\u56e0\u5b50\u7814\u7a76\u4e2d\u7684\u95dc\u9375\u6311\u6230\u3002Alphalens \u6b63\u662f\u70ba\u4e86\u89e3\u6c7a\u9019\u4e9b\u554f\u984c\u800c\u8a2d\u8a08\u7684 Python \u5957\u4ef6\u3002</p> <p>Alphalens \u80fd\u5920\u5c07\u60a8\u5f9e Pipeline \u4e2d\u751f\u6210\u7684\u56e0\u5b50\u6578\u64da\uff0c\u8207\u5e02\u5834\u50f9\u683c\u6578\u64da\u7d50\u5408\uff0c\u81ea\u52d5\u8a08\u7b97\u4e00\u7cfb\u5217\u6a19\u6e96\u5316\u7684\u56e0\u5b50\u5206\u6790\u6307\u6a19\u548c\u8996\u89ba\u5316\u5716\u8868\uff0c\u5e6b\u52a9\u60a8\u5168\u9762\u4e86\u89e3\u56e0\u5b50\u7684\u54c1\u8cea\u3002</p>"},{"location":"concepts/alphalens-overview/#1-alphalens","title":"1. Alphalens \u7684\u6838\u5fc3\u6982\u5ff5","text":"<p>\u5728\u6df1\u5165\u4e86\u89e3 Alphalens \u7684\u4f7f\u7528\u4e4b\u524d\uff0c\u8b93\u6211\u5011\u5148\u56de\u9867\u5e7e\u500b\u6838\u5fc3\u6982\u5ff5\uff1a</p>"},{"location":"concepts/alphalens-overview/#factor","title":"\u56e0\u5b50 (Factor)","text":"<ul> <li>\u5b9a\u7fa9 \uff1a\u56e0\u5b50\u662f\u80fd\u5920\u89e3\u91cb\u6216\u9810\u6e2c\u8cc7\u7522\u5831\u916c\u7684\u7279\u5fb5\u3002\u4f8b\u5982\uff0c\u5e02\u503c\u3001\u672c\u76ca\u6bd4\u3001\u52d5\u91cf\u3001\u6ce2\u52d5\u7387\u7b49\u90fd\u53ef\u4ee5\u662f\u56e0\u5b50\u3002</li> <li>\u4f86\u6e90 \uff1a\u5728 TQuant Lab \u4e2d\uff0c\u56e0\u5b50\u901a\u5e38\u900f\u904e Zipline Pipeline \u751f\u6210\u3002</li> </ul>"},{"location":"concepts/alphalens-overview/#factor-returns","title":"\u56e0\u5b50\u5831\u916c (Factor Returns)","text":"<ul> <li>\u5b9a\u7fa9 \uff1a\u5c07\u80a1\u7968\u6839\u64da\u56e0\u5b50\u503c\u9032\u884c\u5206\u7d44\uff08\u4f8b\u5982\uff0c\u5206\u70ba 5 \u500b\u5206\u4f4d\u6578\u7d44\uff09\uff0c\u7136\u5f8c\u8a08\u7b97\u6bcf\u500b\u5206\u7d44\u5728\u672a\u4f86\u4e00\u6bb5\u6642\u9593\u5167\u7684\u5e73\u5747\u5831\u916c\u3002\u56e0\u5b50\u5831\u916c\u8861\u91cf\u4e86\u56e0\u5b50\u503c\u9ad8\u4f4e\u8207\u672a\u4f86\u5831\u916c\u4e4b\u9593\u7684\u95dc\u4fc2\u3002</li> <li>\u591a\u7a7a\u7d44\u5408 \uff1a\u901a\u5e38\u6703\u6bd4\u8f03\u56e0\u5b50\u503c\u6700\u9ad8\u7684\u5206\u7d44\uff08\u591a\u982d\uff09\u8207\u6700\u4f4e\u7684\u5206\u7d44\uff08\u7a7a\u982d\uff09\u4e4b\u9593\u7684\u5831\u916c\u5dee\u7570\uff0c\u4ee5\u8a55\u4f30\u56e0\u5b50\u7684\u9810\u6e2c\u80fd\u529b\u3002</li> </ul>"},{"location":"concepts/alphalens-overview/#information-coefficient-ic","title":"\u8cc7\u8a0a\u4fc2\u6578 (Information Coefficient, IC)","text":"<ul> <li>\u5b9a\u7fa9 \uff1aIC \u8861\u91cf\u4e86\u56e0\u5b50\u503c\u8207\u672a\u4f86\u5831\u916c\u4e4b\u9593\u7684 \u79e9\u76f8\u95dc\u6027 (Rank Correlation) \u3002\u7c21\u55ae\u4f86\u8aaa\uff0c\u5b83\u8a55\u4f30\u4e86\u56e0\u5b50\u5c0d\u672a\u4f86\u5831\u916c\u7684\u9810\u6e2c\u80fd\u529b\u3002</li> <li>\u7bc4\u570d \uff1aIC \u503c\u4ecb\u65bc -1 \u5230 1 \u4e4b\u9593\u3002<ul> <li><code>IC &gt; 0</code>\uff1a\u56e0\u5b50\u503c\u8d8a\u9ad8\uff0c\u672a\u4f86\u5831\u916c\u8d8a\u9ad8\uff08\u6b63\u76f8\u95dc\uff09\u3002</li> <li><code>IC &lt; 0</code>\uff1a\u56e0\u5b50\u503c\u8d8a\u9ad8\uff0c\u672a\u4f86\u5831\u916c\u8d8a\u4f4e\uff08\u8ca0\u76f8\u95dc\uff09\u3002</li> <li><code>IC = 0</code>\uff1a\u56e0\u5b50\u8207\u672a\u4f86\u5831\u916c\u7121\u95dc\u3002</li> </ul> </li> <li>\u91cd\u8981\u6027 \uff1a\u4e00\u500b\u7a69\u5b9a\u4e14\u986f\u8457\u70ba\u6b63\uff08\u6216\u8ca0\uff09\u7684 IC \u503c\uff0c\u662f\u56e0\u5b50\u6709\u6548\u6027\u7684\u91cd\u8981\u8b49\u64da\u3002</li> </ul>"},{"location":"concepts/alphalens-overview/#factor-rank-autocorrelation","title":"\u56e0\u5b50\u6392\u5e8f\u81ea\u76f8\u95dc (Factor Rank Autocorrelation)","text":"<ul> <li>\u5b9a\u7fa9 \uff1a\u8861\u91cf\u56e0\u5b50\u5728\u4e0d\u540c\u6642\u9593\u9ede\u4e0a\u7684\u6392\u5e8f\u7a69\u5b9a\u6027\u3002\u4f8b\u5982\uff0c\u4e00\u500b\u80a1\u7968\u4eca\u5929\u5728\u56e0\u5b50\u503c\u4e0a\u6392\u540d\u9760\u524d\uff0c\u90a3\u9ebc\u5b83\u660e\u5929\u662f\u5426\u4ecd\u7136\u6392\u540d\u9760\u524d\uff1f</li> <li>\u91cd\u8981\u6027 \uff1a\u9ad8\u81ea\u76f8\u95dc\u6027\u610f\u5473\u8457\u56e0\u5b50\u503c\u8b8a\u5316\u7de9\u6162\uff0c\u9019\u6709\u52a9\u65bc\u964d\u4f4e\u7b56\u7565\u7684\u63db\u624b\u7387 (Turnover)\uff0c\u5f9e\u800c\u6e1b\u5c11\u4ea4\u6613\u6210\u672c\u3002\u4f4e\u81ea\u76f8\u95dc\u6027\u5247\u53ef\u80fd\u5c0e\u81f4\u9ad8\u63db\u624b\u7387\u3002</li> </ul>"},{"location":"concepts/alphalens-overview/#2-alphalens","title":"2. Alphalens \u5de5\u4f5c\u6d41\u7a0b","text":"<p>\u4f7f\u7528 Alphalens \u9032\u884c\u56e0\u5b50\u5206\u6790\u7684\u6a19\u6e96\u6d41\u7a0b\u5982\u4e0b\uff1a</p>"},{"location":"concepts/alphalens-overview/#1","title":"\u6b65\u9a5f 1\uff1a\u6e96\u5099\u56e0\u5b50\u6578\u64da\u8207\u50f9\u683c\u6578\u64da","text":"<p>\u60a8\u9700\u8981\u6e96\u5099\u5169\u500b\u4e3b\u8981\u7684\u6578\u64da\u96c6\uff1a</p> <ol> <li> <p>\u56e0\u5b50\u6578\u64da (Factor Data) \uff1a</p> <ul> <li>\u4e00\u500b Pandas Series \u6216 DataFrame\uff0c\u7d22\u5f15\u70ba <code>(\u65e5\u671f, \u8cc7\u7522)</code> \u7684 MultiIndex\u3002</li> <li>\u503c\u70ba\u6bcf\u500b\u8cc7\u7522\u5728\u6bcf\u500b\u65e5\u671f\u4e0a\u7684\u56e0\u5b50\u503c\u3002</li> <li>\u901a\u5e38\u4f86\u81ea Zipline Pipeline \u7684\u8f38\u51fa\u3002</li> </ul> </li> <li> <p>\u50f9\u683c\u6578\u64da (Pricing Data) \uff1a</p> <ul> <li>\u4e00\u500b Pandas DataFrame\uff0c\u7d22\u5f15\u70ba <code>\u65e5\u671f</code>\uff0c\u6b04\u4f4d\u70ba <code>\u8cc7\u7522</code>\u3002</li> <li>\u503c\u70ba\u6bcf\u500b\u8cc7\u7522\u5728\u6bcf\u500b\u65e5\u671f\u4e0a\u7684\u6536\u76e4\u50f9\uff08\u6216\u5176\u4ed6\u7528\u65bc\u8a08\u7b97\u5831\u916c\u7684\u50f9\u683c\uff09\u3002</li> <li>\u901a\u5e38\u4f86\u81ea Zipline \u7684 <code>data.history()</code> \u6216\u76f4\u63a5\u5f9e TEJ \u7372\u53d6\u3002</li> </ul> </li> </ol>"},{"location":"concepts/alphalens-overview/#2-get_clean_factor_and_forward_returns","title":"\u6b65\u9a5f 2\uff1a\u6e05\u6d17\u8207\u5c0d\u9f4a\u6578\u64da (get_clean_factor_and_forward_returns)","text":"<p>\u9019\u662f Alphalens \u5de5\u4f5c\u6d41\u7a0b\u4e2d\u6700\u95dc\u9375\u7684\u4e00\u6b65\u3002<code>alphalens.utils.get_clean_factor_and_forward_returns()</code> \u51fd\u6578\u6703\u81ea\u52d5\u8655\u7406\u4ee5\u4e0b\u4efb\u52d9\uff1a</p> <ul> <li>\u6578\u64da\u5c0d\u9f4a \uff1a\u5c07\u56e0\u5b50\u6578\u64da\u8207\u50f9\u683c\u6578\u64da\u6309\u65e5\u671f\u548c\u8cc7\u7522\u9032\u884c\u5c0d\u9f4a\u3002</li> <li>\u8a08\u7b97\u672a\u4f86\u5831\u916c \uff1a\u6839\u64da\u6307\u5b9a\u7684\u6301\u6709\u671f (<code>periods</code>)\uff0c\u8a08\u7b97\u6bcf\u500b\u8cc7\u7522\u5728\u56e0\u5b50\u503c\u767c\u5e03\u5f8c\u672a\u4f86\u4e00\u6bb5\u6642\u9593\u7684\u5831\u916c\u7387\u3002</li> <li>\u6578\u64da\u6e05\u6d17 \uff1a\u8655\u7406\u7f3a\u5931\u503c\u3001\u7570\u5e38\u503c\uff0c\u4e26\u78ba\u4fdd\u6578\u64da\u683c\u5f0f\u7b26\u5408 Alphalens \u7684\u8981\u6c42\u3002</li> </ul> <p>\u6b64\u51fd\u6578\u63d0\u4f9b\u591a\u500b\u53c3\u6578\u4f86\u63a7\u5236\u56e0\u5b50\u7684\u5206\u7d44\u65b9\u5f0f\uff1a</p> <ul> <li> <p><code>quantiles</code> (int, default 5)\uff1a</p> <ul> <li>\u7528\u9014 \uff1a\u5c07\u56e0\u5b50\u503c\u5206\u70ba\u6307\u5b9a\u6578\u91cf\u7684\u5206\u4f4d\u6578\u7d44\u3002\u4f8b\u5982\uff0c<code>quantiles=5</code> \u6703\u5c07\u80a1\u7968\u5206\u70ba 5 \u7d44\uff0c\u6bcf\u7d44\u5305\u542b\u5927\u81f4\u76f8\u540c\u6578\u91cf\u7684\u80a1\u7968\u3002</li> <li>\u9069\u7528\u5834\u666f \uff1a\u7576\u60a8\u5e0c\u671b\u6309\u80a1\u7968\u6578\u91cf\u5e73\u5747\u5206\u7d44\u6642\u4f7f\u7528\u3002</li> </ul> </li> <li> <p><code>bins</code> (list or array, optional)\uff1a</p> <ul> <li>\u7528\u9014 \uff1a\u63d0\u4f9b\u81ea\u5b9a\u7fa9\u7684\u56e0\u5b50\u503c\u908a\u754c\u4f86\u9032\u884c\u5206\u7d44\u3002\u4f8b\u5982\uff0c<code>bins=[-np.inf, -1, 0, 1, np.inf]</code> \u6703\u5c07\u56e0\u5b50\u503c\u5206\u70ba\u5c0f\u65bc -1\u3001-1 \u5230 0\u30010 \u5230 1\u3001\u5927\u65bc 1 \u7684\u56db\u7d44\u3002</li> <li>\u9069\u7528\u5834\u666f \uff1a\u7576\u60a8\u5e0c\u671b\u6839\u64da\u56e0\u5b50\u503c\u7684\u5be6\u969b\u5206\u4f48\u6216\u7279\u5b9a\u95be\u503c\u9032\u884c\u5206\u7d44\u6642\u4f7f\u7528\u3002</li> </ul> </li> <li> <p><code>binning_by_group</code> (bool, default False)\uff1a</p> <ul> <li>\u7528\u9014 \uff1a\u7576\u8a2d\u7f6e\u70ba <code>True</code> \u6642\uff0c\u6703\u6839\u64da <code>groupby</code> \u53c3\u6578\u6307\u5b9a\u7684\u7d44\uff08\u4f8b\u5982\u884c\u696d\uff09\u5206\u5225\u9032\u884c\u5206\u4f4d\u6578\u6216\u5206\u7bb1\u64cd\u4f5c\u3002</li> <li>\u9069\u7528\u5834\u666f \uff1a\u7576\u60a8\u5e0c\u671b\u5728\u6bcf\u500b\u884c\u696d\u5167\u90e8\u7368\u7acb\u9032\u884c\u56e0\u5b50\u5206\u7d44\uff0c\u4ee5\u6d88\u9664\u884c\u696d\u504f\u898b\u6642\u4f7f\u7528\u3002</li> </ul> </li> </ul> <pre><code>import alphalens as al\nimport pandas as pd\nimport numpy as np\n\n# \u5047\u8a2d factor_data \u662f\u60a8\u5f9e Pipeline \u7372\u53d6\u7684\u56e0\u5b50\u503c (MultiIndex: date, asset)\n# \u5047\u8a2d pricing_data \u662f\u60a8\u7372\u53d6\u7684\u80a1\u7968\u50f9\u683c\u6578\u64da (DataFrame: index=date, columns=asset)\n\n# \u70ba\u4e86\u6f14\u793a\uff0c\u6211\u5011\u5275\u5efa\u4e00\u4e9b\u6a21\u64ec\u6578\u64da\nfactor_data = pd.Series(np.random.rand(100), index=pd.MultiIndex.from_product([[pd.Timestamp('2023-01-01', tz='utc')], ['2330', '2454', '2303', '2881']]))\npricing_data = pd.DataFrame(np.random.rand(10, 4), index=pd.date_range('2023-01-01', periods=10, tz='utc'), columns=['2330', '2454', '2303', '2881'])\n\n# \u7bc4\u4f8b 1: \u4f7f\u7528 quantiles \u9032\u884c\u5206\u7d44 (\u9810\u8a2d\u884c\u70ba)\nfactor_data_quantiles = al.utils.get_clean_factor_and_forward_returns(\n    factor=factor_data,\n    prices=pricing_data,\n    periods=(1, 5, 10), # \u8a08\u7b97\u672a\u4f86 1, 5, 10 \u5929\u7684\u5831\u916c\n    quantiles=5, # \u5c07\u56e0\u5b50\u5206\u70ba 5 \u500b\u5206\u4f4d\u6578\u7d44\n    groupby=None,\n    max_loss=0.35\n)\n\n# \u7bc4\u4f8b 2: \u4f7f\u7528 bins \u9032\u884c\u81ea\u5b9a\u7fa9\u5206\u7d44\nfactor_data_bins = al.utils.get_clean_factor_and_forward_returns(\n    factor=factor_data,\n    prices=pricing_data,\n    periods=(1, 5, 10),\n    bins=[-np.inf, 0.2, 0.4, 0.6, 0.8, np.inf], # \u81ea\u5b9a\u7fa9 5 \u500b\u5206\u7bb1\u908a\u754c\n    groupby=None,\n    max_loss=0.35\n)\n\n# \u7bc4\u4f8b 3: \u5047\u8a2d\u6709\u884c\u696d\u5206\u7d44\u6578\u64da\uff0c\u4e26\u6309\u884c\u696d\u9032\u884c\u5206\u7d44 (binning_by_group=True)\n# industry_data = pd.Series(..., index=pd.MultiIndex.from_product(...))\n# factor_data_by_group = al.utils.get_clean_factor_and_forward_returns(\n# factor=factor_data,\n# prices=pricing_data,\n# periods=(1, 5, 10),\n# quantiles=5,\n# groupby=industry_data, # \u50b3\u5165\u884c\u696d\u5206\u7d44\u6578\u64da\n# binning_by_group=True, # \u5728\u6bcf\u500b\u884c\u696d\u5167\u90e8\u7368\u7acb\u5206\u7d44\n# max_loss=0.35\n# )\n\nprint(\"\u4f7f\u7528 quantiles \u5206\u7d44\u7684\u6578\u64da\u982d\u90e8\uff1a\")\nprint(factor_data_quantiles.head())\n</code></pre>"},{"location":"concepts/alphalens-overview/#3-tear-sheet","title":"\u6b65\u9a5f 3\uff1a\u751f\u6210\u56e0\u5b50\u5206\u6790\u5831\u544a (Tear Sheet)","text":"<p>Alphalens \u63d0\u4f9b\u4e86\u591a\u7a2e Tear Sheet \u51fd\u6578\uff0c\u7528\u65bc\u751f\u6210\u4e0d\u540c\u5074\u91cd\u9ede\u7684\u5831\u544a\u3002\u6700\u5e38\u7528\u7684\u662f <code>create_full_tear_sheet()</code>\uff0c\u5b83\u6703\u751f\u6210\u4e00\u4efd\u5305\u542b\u6240\u6709\u6a19\u6e96\u5206\u6790\u5716\u8868\u548c\u6307\u6a19\u7684\u7d9c\u5408\u5831\u544a\u3002</p> <pre><code># \u751f\u6210\u5b8c\u6574\u7684\u56e0\u5b50\u5206\u6790\u5831\u544a\nal.tears.create_full_tear_sheet(factor_data_cleaned)\n\n# \u60a8\u4e5f\u53ef\u4ee5\u751f\u6210\u7279\u5b9a\u985e\u578b\u7684\u5831\u544a\uff0c\u4f8b\u5982\uff1a\n# al.tears.create_returns_tear_sheet(factor_data_cleaned) # \u50c5\u5831\u916c\u76f8\u95dc\u5206\u6790\n# al.tears.create_information_tear_sheet(factor_data_cleaned) # \u50c5 IC \u76f8\u95dc\u5206\u6790\n# al.tears.create_turnover_tear_sheet(factor_data_cleaned) # \u50c5\u63db\u624b\u7387\u76f8\u95dc\u5206\u6790\n</code></pre>"},{"location":"concepts/alphalens-overview/#3-alphalens","title":"3. \u89e3\u8b80 Alphalens \u95dc\u9375\u5716\u8868\u8207\u6307\u6a19","text":"<p>Alphalens \u5831\u544a\u63d0\u4f9b\u4e86\u8c50\u5bcc\u7684\u8996\u89ba\u5316\u548c\u7d71\u8a08\u6578\u64da\uff0c\u5e6b\u52a9\u60a8\u5168\u9762\u8a55\u4f30\u56e0\u5b50\u7684\u54c1\u8cea\u3002</p>"},{"location":"concepts/alphalens-overview/#_1","title":"\u56e0\u5b50\u5831\u916c\u5206\u6790","text":"<ul> <li> <p>\u5206\u4f4d\u6578\u7d2f\u7a4d\u5831\u916c\u5716 (Cumulative Returns by Factor Quantile)     \u6b64\u5716\u5c07\u80a1\u7968\u6309\u56e0\u5b50\u503c\u5206\u70ba\u4e0d\u540c\u7684\u5206\u4f4d\u6578\u7d44\uff08\u4f8b\u5982 5 \u7d44\uff09\uff0c\u7136\u5f8c\u7e6a\u88fd\u6bcf\u500b\u5206\u4f4d\u6578\u7d44\u7684\u7d2f\u7a4d\u5831\u916c\u3002\u4e00\u500b\u6709\u6548\u7684\u56e0\u5b50\u901a\u5e38\u6703\u986f\u793a\u51fa\u56e0\u5b50\u503c\u6700\u9ad8\u7684\u5206\u7d44\uff08\u591a\u982d\uff09\u7d2f\u7a4d\u5831\u916c\u986f\u8457\u9ad8\u65bc\u56e0\u5b50\u503c\u6700\u4f4e\u7684\u5206\u7d44\uff08\u7a7a\u982d\uff09\u7684\u8da8\u52e2\u3002</p> </li> <li> <p>\u5206\u4f4d\u6578\u5e73\u5747\u5831\u916c\u689d\u5f62\u5716 (Mean Return by Quantile Bar Plot)     \u6b64\u5716\u4ee5\u689d\u5f62\u5716\u7684\u5f62\u5f0f\u5c55\u793a\u6bcf\u500b\u56e0\u5b50\u5206\u4f4d\u6578\u7d44\u7684\u5e73\u5747\u5831\u916c\u3002\u7406\u60f3\u60c5\u6cc1\u4e0b\uff0c\u60a8\u6703\u770b\u5230\u5831\u916c\u7387\u96a8\u8457\u56e0\u5b50\u5206\u4f4d\u6578\u7684\u589e\u52a0\u800c\u55ae\u8abf\u905e\u589e\uff08\u6216\u905e\u6e1b\uff09\u3002</p> </li> </ul>"},{"location":"concepts/alphalens-overview/#ic","title":"\u8cc7\u8a0a\u4fc2\u6578 (IC) \u5206\u6790","text":"<ul> <li> <p>IC \u6642\u9593\u5e8f\u5217\u5716 (IC Time Series)     \u6b64\u5716\u986f\u793a\u4e86 IC \u503c\u96a8\u6642\u9593\u7684\u8b8a\u5316\u3002\u60a8\u53ef\u4ee5\u89c0\u5bdf IC \u7684\u7a69\u5b9a\u6027\u3001\u5747\u503c\u548c\u6ce2\u52d5\u6027\u3002\u4e00\u500b\u597d\u7684\u56e0\u5b50\u61c9\u8a72\u6709\u7a69\u5b9a\u4e14\u986f\u8457\u7684 IC \u503c\u3002</p> </li> <li> <p>IC \u5206\u4f48\u76f4\u65b9\u5716 (IC Histogram)     \u6b64\u5716\u5c55\u793a\u4e86 IC \u503c\u7684\u983b\u7387\u5206\u4f48\u3002\u60a8\u53ef\u4ee5\u5224\u65b7 IC \u503c\u662f\u5426\u96c6\u4e2d\u5728\u6b63\u503c\u5340\u57df\uff0c\u4ee5\u53ca\u5176\u5206\u4f48\u662f\u5426\u63a5\u8fd1\u5e38\u614b\u5206\u4f48\u3002</p> </li> <li> <p>\u6708\u5ea6 IC \u71b1\u529b\u5716 (Monthly IC Heatmap)     \u6b64\u5716\u4ee5\u71b1\u529b\u5716\u7684\u5f62\u5f0f\u5c55\u793a\u56e0\u5b50\u5728\u6bcf\u5e74\u5404\u6708\u4efd\u7684\u5e73\u5747 IC \u503c\uff0c\u6709\u52a9\u65bc\u767c\u73fe\u56e0\u5b50\u662f\u5426\u5b58\u5728\u5b63\u7bc0\u6027\u6548\u61c9\u3002</p> </li> </ul>"},{"location":"concepts/alphalens-overview/#_2","title":"\u63db\u624b\u7387\u5206\u6790","text":"<ul> <li> <p>\u56e0\u5b50\u63db\u624b\u7387\u5716 (Factor Turnover)     \u6b64\u5716\u8861\u91cf\u4e86\u56e0\u5b50\u5206\u4f4d\u6578\u7d44\u4e2d\u80a1\u7968\u7684\u63db\u624b\u901f\u5ea6\u3002\u9ad8\u63db\u624b\u7387\u610f\u5473\u8457\u56e0\u5b50\u503c\u8b8a\u5316\u983b\u7e41\uff0c\u53ef\u80fd\u5c0e\u81f4\u8f03\u9ad8\u7684\u4ea4\u6613\u6210\u672c\u3002</p> </li> <li> <p>\u56e0\u5b50\u6392\u5e8f\u81ea\u76f8\u95dc\u5716 (Factor Rank Autocorrelation)     \u6b64\u5716\u986f\u793a\u4e86\u56e0\u5b50\u6392\u5e8f\u7684\u7a69\u5b9a\u6027\u3002\u9ad8\u81ea\u76f8\u95dc\u6027\u610f\u5473\u8457\u56e0\u5b50\u503c\u5728\u4e00\u6bb5\u6642\u9593\u5167\u76f8\u5c0d\u7a69\u5b9a\uff0c\u6709\u52a9\u65bc\u964d\u4f4e\u63db\u624b\u7387\u3002</p> </li> </ul>"},{"location":"concepts/alphalens-overview/#4-demeaning","title":"4. \u53bb\u5e02\u5834\u5316 (Demeaning) \u6982\u5ff5","text":"<p>\u5728\u56e0\u5b50\u5206\u6790\u4e2d\uff0c\u300c\u53bb\u5e02\u5834\u5316 (Demeaning)\u300d\u662f\u4e00\u500b\u91cd\u8981\u7684\u6982\u5ff5\uff0c\u5b83\u65e8\u5728\u6d88\u9664\u6574\u9ad4\u5e02\u5834\u6ce2\u52d5\u5c0d\u56e0\u5b50\u5831\u916c\u7684\u5f71\u97ff\uff0c\u5f9e\u800c\u66f4\u6e05\u6670\u5730\u63ed\u793a\u56e0\u5b50\u672c\u8eab\u7684\u9810\u6e2c\u80fd\u529b\u3002</p>"},{"location":"concepts/alphalens-overview/#_3","title":"\u4ec0\u9ebc\u662f\u53bb\u5e02\u5834\u5316\uff1f","text":"<p>\u7576\u6211\u5011\u8a08\u7b97\u80a1\u7968\u5831\u916c\u6642\uff0c\u9019\u4e9b\u5831\u916c\u5f80\u5f80\u5305\u542b\u5169\u90e8\u5206\uff1a\u4e00\u90e8\u5206\u4f86\u81ea\u5e02\u5834\u7684\u6574\u9ad4\u6ce2\u52d5\uff0c\u53e6\u4e00\u90e8\u5206\u4f86\u81ea\u80a1\u7968\u81ea\u8eab\u7684\u7279\u8cea\uff08\u5373\u56e0\u5b50\uff09\u3002\u53bb\u5e02\u5834\u5316\u5c31\u662f\u5c07\u6bcf\u6a94\u80a1\u7968\u7684\u5831\u916c\u7387\u6263\u9664\u5168\u5e02\u5834\uff08\u6216\u7279\u5b9a\u7d44\u5225\uff09\u7684\u5e73\u5747\u5831\u916c\uff0c\u4f7f\u5f97\u5206\u6790\u7684\u91cd\u9ede\u805a\u7126\u65bc\u56e0\u5b50\u5e36\u4f86\u7684\u76f8\u5c0d\u6536\u76ca\uff0c\u800c\u975e\u5e02\u5834\u7684\u6f32\u8dcc\u3002</p>"},{"location":"concepts/alphalens-overview/#demeaned","title":"demeaned \u53c3\u6578\u7684\u4f7f\u7528","text":"<p>Alphalens \u7684\u8a31\u591a\u51fd\u6578\uff08\u7279\u5225\u662f\u8207\u5831\u916c\u76f8\u95dc\u7684\u5206\u6790\u51fd\u6578\uff0c\u4f8b\u5982 <code>alphalens.tears.create_returns_tear_sheet</code> \u6216 <code>alphalens.performance.mean_return_by_quantile</code>\uff09\u90fd\u63d0\u4f9b\u4e86 <code>demeaned</code> \u53c3\u6578\u3002\u7576 <code>demeaned</code> \u8a2d\u7f6e\u70ba <code>True</code> \u6642\uff0cAlphalens \u6703\u5728\u8a08\u7b97\u56e0\u5b50\u5831\u916c\u4e4b\u524d\uff0c\u5c0d\u80a1\u7968\u5831\u916c\u9032\u884c\u53bb\u5e02\u5834\u5316\u8655\u7406\u3002</p> <ul> <li><code>demeaned=True</code>\uff1a\u8a08\u7b97\u53bb\u5e02\u5834\u5316\u5f8c\u7684\u56e0\u5b50\u5831\u916c\uff0c\u6709\u52a9\u65bc\u8a55\u4f30\u56e0\u5b50\u7684 \u7d14\u7cb9 Alpha \u8ca2\u737b \u3002</li> <li><code>demeaned=False</code> (\u9810\u8a2d\u503c)\uff1a\u8a08\u7b97\u539f\u59cb\u56e0\u5b50\u5831\u916c\uff0c\u5305\u542b\u5e02\u5834\u6ce2\u52d5\u7684\u5f71\u97ff\u3002</li> </ul> <pre><code>import alphalens as al\n\n# \u5047\u8a2d factor_data_cleaned \u662f\u7d93\u904e get_clean_factor_and_forward_returns \u8655\u7406\u5f8c\u7684\u6578\u64da\n\n# \u7bc4\u4f8b 1: \u8a08\u7b97\u672a\u53bb\u5e02\u5834\u5316\u7684\u56e0\u5b50\u5831\u916c (\u9810\u8a2d\u884c\u70ba)\nal.tears.create_returns_tear_sheet(factor_data_cleaned, demeaned=False)\n\n# \u7bc4\u4f8b 2: \u8a08\u7b97\u53bb\u5e02\u5834\u5316\u5f8c\u7684\u56e0\u5b50\u5831\u916c\nal.tears.create_returns_tear_sheet(factor_data_cleaned, demeaned=True)\n\n# \u60a8\u4e5f\u53ef\u4ee5\u5728\u8a08\u7b97 mean_return_by_quantile \u6642\u6307\u5b9a demeaned \u53c3\u6578\n# mean_return_by_q_demeaned = al.performance.mean_return_by_quantile(\n# factor_data_cleaned, \n# demeaned=True\n# )\n</code></pre>"},{"location":"concepts/alphalens-overview/#_4","title":"\u4f55\u6642\u4f7f\u7528\u53bb\u5e02\u5834\u5316\uff1f","text":"<ul> <li>\u8a55\u4f30\u56e0\u5b50\u7d14\u7cb9 Alpha \uff1a\u7576\u60a8\u5e0c\u671b\u8a55\u4f30\u56e0\u5b50\u5728\u5254\u9664\u5e02\u5834\u5f71\u97ff\u5f8c\u7684\u7368\u7acb\u9810\u6e2c\u80fd\u529b\u6642\uff0c\u61c9\u4f7f\u7528\u53bb\u5e02\u5834\u5316\u3002</li> <li>\u6bd4\u8f03\u4e0d\u540c\u56e0\u5b50 \uff1a\u5728\u6bd4\u8f03\u4e0d\u540c\u56e0\u5b50\u7684\u8868\u73fe\u6642\uff0c\u53bb\u5e02\u5834\u5316\u53ef\u4ee5\u63d0\u4f9b\u66f4\u516c\u5e73\u7684\u57fa\u790e\uff0c\u56e0\u70ba\u5b83\u6e1b\u5c11\u4e86\u5e02\u5834\u98a8\u683c\u5c0d\u6bd4\u8f03\u7684\u5e72\u64fe\u3002</li> <li>\u69cb\u5efa\u4e2d\u6027\u7b56\u7565 \uff1a\u5c0d\u65bc\u65e8\u5728\u69cb\u5efa\u5e02\u5834\u4e2d\u6027\u7b56\u7565\u7684\u7814\u7a76\u8005\u4f86\u8aaa\uff0c\u53bb\u5e02\u5834\u5316\u662f\u7406\u89e3\u56e0\u5b50\u8ca2\u737b\u7684\u95dc\u9375\u4e00\u6b65\u3002</li> </ul>"},{"location":"concepts/alphalens-overview/#_5","title":"\u7e3d\u7d50","text":"<p>Alphalens \u662f\u91cf\u5316\u56e0\u5b50\u7814\u7a76\u4e2d\u4e0d\u53ef\u6216\u7f3a\u7684\u5de5\u5177\u3002\u5b83\u63d0\u4f9b\u4e86\u4e00\u5957\u6a19\u6e96\u5316\u3001\u7cfb\u7d71\u5316\u7684\u65b9\u6cd5\u4f86\u8a55\u4f30\u56e0\u5b50\u7684\u9810\u6e2c\u80fd\u529b\u3001\u7a69\u5b9a\u6027\u548c\u4ea4\u6613\u6210\u672c\u3002\u900f\u904e\u719f\u7df4\u904b\u7528 Alphalens \u751f\u6210\u4e26\u89e3\u8b80\u56e0\u5b50\u5206\u6790\u5831\u544a\uff0c\u4e26\u7406\u89e3 <code>quantiles</code>\u3001<code>bins</code>\u3001<code>binning_by_group</code> \u4ee5\u53ca\u300c\u53bb\u5e02\u5834\u5316 (Demeaning)\u300d\u7b49\u95dc\u9375\u53c3\u6578\uff0c\u60a8\u53ef\u4ee5\u66f4\u79d1\u5b78\u5730\u7be9\u9078\u548c\u512a\u5316\u60a8\u7684\u6295\u8cc7\u56e0\u5b50\uff0c\u5f9e\u800c\u69cb\u5efa\u51fa\u66f4\u5177\u7af6\u722d\u529b\u7684\u91cf\u5316\u7b56\u7565\u3002</p>"},{"location":"concepts/calendars/","title":"\u6838\u5fc3\u6982\u5ff5\uff1a\u4ea4\u6613\u65e5\u66c6 (Trading Calendars)","text":"<p>Info</p> <p>\u672c\u9801\u8aaa\u660e\u4ea4\u6613\u65e5\u66c6\u5728\u91cf\u5316\u56de\u6e2c\u4e2d\u7684\u91cd\u8981\u6027\uff0c\u4ee5\u53ca\u5982\u4f55\u5728 TQuant Lab \u4e2d\u4f7f\u7528\u548c\u61c9\u7528\u4ea4\u6613\u65e5\u66c6\u3002</p>"},{"location":"concepts/calendars/#_1","title":"\u70ba\u4ec0\u9ebc\u9700\u8981\u4ea4\u6613\u65e5\u66c6\uff1f","text":"<p>\u91d1\u878d\u5e02\u5834\u4e26\u975e\u5168\u5e74\u7121\u4f11\u3002\u5404\u570b\u5e02\u5834\u90fd\u6709\u81ea\u5df1\u7684\u4ea4\u6613\u6642\u9593\u3001\u5047\u65e5\u3001\u4ee5\u53ca\u56e0\u7279\u6b8a\u4e8b\u4ef6\uff08\u5982\u98b1\u98a8\uff09\u7684\u4f11\u5e02\u65e5\u3002\u5728\u9032\u884c\u91cf\u5316\u56de\u6e2c\u6642\uff0c\u5982\u679c\u5ffd\u7565\u4e86\u9019\u4e9b\u975e\u4ea4\u6613\u65e5\uff0c\u53ef\u80fd\u6703\u5c0e\u81f4\u4ee5\u4e0b\u56b4\u91cd\u554f\u984c\uff1a</p> <ol> <li>\u4e0d\u5207\u5be6\u969b\u7684\u4ea4\u6613\uff1a\u7b56\u7565\u53ef\u80fd\u6703\u5728\u5e02\u5834\u4f11\u5e02\u6642\u7522\u751f\u4ea4\u6613\u8a0a\u865f\u4e26\u8a66\u5716\u4e0b\u55ae\uff0c\u9019\u5728\u73fe\u5be6\u4e16\u754c\u4e2d\u662f\u4e0d\u53ef\u80fd\u7684\u3002</li> <li>\u932f\u8aa4\u7684\u7e3e\u6548\u8a08\u7b97\uff1a\u82e5\u5c07\u975e\u4ea4\u6613\u65e5\u7d0d\u5165\u5831\u916c\u7387\u8a08\u7b97\uff0c\u6703\u7a00\u91cb\u6ce2\u52d5\u7387\uff0c\u9ad8\u4f30\u590f\u666e\u6bd4\u7387\u7b49\u98a8\u96aa\u6307\u6a19\u3002</li> <li>\u524d\u8996\u504f\u5dee (Lookahead Bias)\uff1a\u82e5\u5728\u5047\u65e5\u62ff\u5230\u4e0b\u4e00\u500b\u958b\u76e4\u65e5\u7684\u8cc7\u8a0a\uff0c\u6703\u7522\u751f\u4e0d\u516c\u5e73\u7684\u9810\u77e5\u512a\u52e2\u3002</li> </ol> <p>\u56e0\u6b64\uff0c\u4e00\u500b\u6e96\u78ba\u7684\u4ea4\u6613\u65e5\u66c6\u662f\u4efb\u4f55\u56b4\u8b39\u56de\u6e2c\u6846\u67b6\u7684\u57fa\u790e\u3002\u5b83\u5b9a\u7fa9\u4e86\u56de\u6e2c\u904e\u7a0b\u4e2d\u6bcf\u4e00\u5929\u662f\u5426\u70ba\u300c\u4ea4\u6613\u65e5\u300d\uff08session\uff09\uff0c\u4ee5\u53ca\u8a72\u65e5\u7684\u958b\u76e4\u8207\u6536\u76e4\u6642\u9593\u3002</p>"},{"location":"concepts/calendars/#zipline","title":"Zipline \u4e2d\u7684\u65e5\u66c6\u6a5f\u5236","text":"<p>Zipline \u900f\u904e\u4e00\u500b\u5f37\u5927\u7684\u65e5\u66c6\u7cfb\u7d71\u4f86\u6a21\u64ec\u771f\u5be6\u4e16\u754c\u7684\u4ea4\u6613\u6642\u9593\u3002\u6bcf\u500b\u56de\u6e2c\u90fd\u5fc5\u9808\u7d81\u5b9a\u4e00\u500b\u7279\u5b9a\u7684\u4ea4\u6613\u65e5\u66c6\u3002\u9019\u500b\u65e5\u66c6\u7269\u4ef6\u6703\u544a\u8a34\u56de\u6e2c\u5f15\u64ce\uff1a</p> <ul> <li>\u54ea\u4e9b\u65e5\u671f\u662f\u4ea4\u6613\u65e5\u3002</li> <li>\u6bcf\u500b\u4ea4\u6613\u65e5\u7684\u78ba\u5207\u958b\u76e4\u6642\u9593\u8207\u6536\u76e4\u6642\u9593\u3002</li> <li>\u662f\u5426\u6709\u63d0\u65e9\u6536\u76e4\u7684\u72c0\u6cc1\u3002</li> </ul>"},{"location":"concepts/calendars/#tquant-lab","title":"\u5728 TQuant Lab \u4e2d\u53d6\u5f97\u65e5\u66c6","text":"<p>TQuant Lab \u5167\u5efa\u4e86\u53f0\u7063\u5e02\u5834\u7684\u4ea4\u6613\u65e5\u66c6\uff0c\u60a8\u53ef\u4ee5\u900f\u904e <code>get_calendar</code> \u51fd\u6578\u8f15\u6613\u53d6\u5f97\u3002\u53f0\u7063\u8b49\u5238\u4ea4\u6613\u6240\u7684\u5b98\u65b9\u65e5\u66c6\u540d\u7a31\u70ba <code>XTAI</code>\uff0c\u800c TQuant Lab \u70ba\u4e86\u65b9\u4fbf\u4f7f\u7528\u8005\uff0c\u5c07\u5176\u8a3b\u518a\u70ba <code>TEJ</code>\u3002</p> <p>\u56e0\u6b64\uff0c\u5728 TQuant Lab \u74b0\u5883\u4e2d\uff0c<code>TEJ</code> \u662f\u60a8\u6700\u5e38\u6703\u7528\u5230\u7684\u4ea4\u6613\u65e5\u66c6\u3002</p> <pre><code>from zipline.utils.calendar_utils import get_calendar\n\n# \u53d6\u5f97\u53f0\u7063\u5e02\u5834\u7684\u4ea4\u6613\u65e5\u66c6\ntaiwan_calendar = get_calendar('TEJ')\n\n# \u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5b98\u65b9\u540d\u7a31 XTAI\uff0c\u5169\u8005\u662f\u76f8\u540c\u7684\n# taiwan_calendar_xtai = get_calendar('XTAI')\n</code></pre>"},{"location":"concepts/calendars/#_2","title":"\u5982\u4f55\u61c9\u7528\u65bc\u56de\u6e2c","text":"<p>\u5728\u8a2d\u5b9a\u4e26\u57f7\u884c <code>run_algorithm</code> \u51fd\u6578\u6642\uff0c\u60a8\u53ef\u4ee5\u900f\u904e <code>trading_calendar</code> \u53c3\u6578\u5c07\u60a8\u60f3\u4f7f\u7528\u7684\u65e5\u66c6\u50b3\u5165\u3002\u9019\u6a23\u4e00\u4f86\uff0c\u6574\u500b\u56de\u6e2c\u904e\u7a0b\u5c31\u6703\u56b4\u683c\u9075\u5b88\u8a72\u65e5\u66c6\u5b9a\u7fa9\u7684\u4ea4\u6613\u6642\u9593\u3002</p> <pre><code>from zipline import run_algorithm\nfrom zipline.utils.calendar_utils import get_calendar\nimport pandas as pd\n\n# ... (\u6b64\u8655\u7701\u7565 initialize, handle_data \u7b49\u51fd\u6578\u7684\u5b9a\u7fa9)\n\n# \u57f7\u884c\u56de\u6e2c\u6642\uff0c\u50b3\u5165 TEJ \u65e5\u66c6\nresults = run_algorithm(\n    start=pd.Timestamp('2020-01-01', tz='utc'),\n    end=pd.Timestamp('2024-09-30', tz='utc'),\n    initialize=initialize,\n    capital_base=1000000,\n    bundle='tquant_future',\n    trading_calendar=get_calendar('TEJ') # &lt;--- \u5728\u6b64\u6307\u5b9a\u4ea4\u6613\u65e5\u66c6\n)\n</code></pre>"},{"location":"concepts/calendars/#_3","title":"\u7e3d\u7d50","text":"<p>\u4f7f\u7528\u6b63\u78ba\u7684\u4ea4\u6613\u65e5\u66c6\u662f\u78ba\u4fdd\u56de\u6e2c\u6e96\u78ba\u6027\u7684\u57fa\u672c\u8981\u6c42\u3002\u5728 TQuant Lab \u4e2d\uff0c\u60a8\u61c9\u8a72\u96a8\u6642\u5728 <code>run_algorithm</code> \u51fd\u6578\u4e2d\u660e\u78ba\u6307\u5b9a <code>trading_calendar=get_calendar('TEJ')</code>\uff0c\u4ee5\u78ba\u4fdd\u60a8\u7684\u7b56\u7565\u884c\u70ba\u8207\u53f0\u7063\u5e02\u5834\u7684\u771f\u5be6\u958b\u4f11\u5e02\u72c0\u6cc1\u4fdd\u6301\u4e00\u81f4\u3002</p>"},{"location":"concepts/performance-metrics/","title":"\u7e3e\u6548\u6307\u6a19\u8a73\u89e3\uff1aPyfolio \u5168\u65b9\u4f4d\u5206\u6790","text":"<p>Info</p> <p>\u672c\u9801\u9762\u8aaa\u660e TQuant Lab \u751f\u6210\u4e4b Pyfolio \u5168\u7248\u5831\u8868 (Full Tear Sheet) \u4e2d\u7684\u5404\u9805\u95dc\u9375\u6307\u6a19\u5b9a\u7fa9\u8207\u5224\u8b80\u65b9\u5f0f\u3002</p> <p>\u6ce8\u610f\uff1a\u672c\u6587\u6a94\u4e2d\u51fa\u73fe\u7684\u6578\u503c\u8207\u5716\u8868\u50c5\u70ba \u7bc4\u4f8b\u6578\u64da (Sample Data)\uff0c\u65e8\u5728\u6f14\u793a\u5982\u4f55\u89e3\u8b80\u5831\u8868\uff0c\u4e26\u975e\u7279\u5b9a\u7b56\u7565\u7684\u4fdd\u8b49\u7e3e\u6548\u3002</p>"},{"location":"concepts/performance-metrics/#1-performance-statistics","title":"1. \u6838\u5fc3\u7e3e\u6548\u6982\u89bd (Performance Statistics)","text":"<p>\u6b64\u5340\u584a\u4f4d\u65bc\u5831\u8868\u6700\u4e0a\u65b9\uff0c\u63d0\u4f9b\u7b56\u7565\u7684\u6574\u9ad4\u7372\u5229\u80fd\u529b\u8207\u98a8\u96aa\u8abf\u6574\u5f8c\u8868\u73fe\u7684\u7d71\u8a08\u6458\u8981\u3002</p>"},{"location":"concepts/performance-metrics/#11","title":"1.1. \u5831\u916c\u8207\u6ce2\u52d5\u985e","text":""},{"location":"concepts/performance-metrics/#annual-return","title":"Annual return (\u5e74\u5316\u5831\u916c\u7387)","text":"<ul> <li>\u5b9a\u7fa9\uff1a\u5c07\u7b56\u7565\u7684\u7e3d\u5831\u916c\u63db\u7b97\u70ba\u6bcf\u5e74\u7684\u5e73\u5747\u8907\u5229\u589e\u9577\u7387\u3002</li> <li>\u5224\u8b80\uff1a\u8861\u91cf\u7b56\u7565\u7372\u5229\u80fd\u529b\u6700\u76f4\u89c0\u7684\u6307\u6a19\u3002</li> </ul>"},{"location":"concepts/performance-metrics/#annual-volatility","title":"Annual volatility (\u5e74\u5316\u6ce2\u52d5\u7387)","text":"<ul> <li>\u5b9a\u7fa9\uff1a\u8861\u91cf\u8cc7\u7522\u6536\u76ca\u7387\u7684\u6a19\u6e96\u5dee\uff0c\u53cd\u6620\u50f9\u683c\u8b8a\u52d5\u7684\u5287\u70c8\u7a0b\u5ea6\u3002</li> <li>\u5224\u8b80\uff1a\u6578\u503c\u8d8a\u9ad8\uff0c\u4ee3\u8868\u8cc7\u7522\u50f9\u683c\u6ce2\u52d5\u8d8a\u5927\uff0c\u98a8\u96aa\u8d8a\u9ad8\u3002\u53f0\u80a1\u5927\u76e4\u9577\u671f\u5e73\u5747\u6ce2\u52d5\u7387\u7d04\u5728 15%~20% \u4e4b\u9593\u3002</li> </ul> <p>\u7bc4\u4f8b\u89e3\u8b80</p> <ul> <li>Annual return: <code>37.43%</code> \u2014\u2014 \u4ee3\u8868\u6b64\u7bc4\u4f8b\u7b56\u7565\u6bcf\u5e74\u5e73\u5747\u589e\u9577 37%\u3002</li> <li>Annual volatility: <code>24.67%</code> \u2014\u2014 \u4ee3\u8868\u6ce2\u52d5\u7a0b\u5ea6\u9ad8\u65bc\u4e00\u822c\u5927\u76e4\uff0c\u5c6c\u65bc\u7a4d\u6975\u578b\u7b56\u7565\u3002</li> </ul>"},{"location":"concepts/performance-metrics/#12","title":"1.2. \u98a8\u96aa\u8abf\u6574\u6536\u76ca\u985e","text":""},{"location":"concepts/performance-metrics/#sharpe-ratio","title":"Sharpe ratio (\u590f\u666e\u6bd4\u7387)","text":"<ul> <li>\u5b9a\u7fa9\uff1a\u8861\u91cf\u6bcf\u627f\u64d4\u4e00\u55ae\u4f4d\u7e3d\u98a8\u96aa (\u6ce2\u52d5\u7387)\uff0c\u80fd\u63db\u53d6\u591a\u5c11\u8d85\u984d\u5831\u916c\u3002</li> <li>\u516c\u5f0f\uff1a\\((R_p - R_f) / \\sigma_p\\)</li> <li>\u5224\u8b80\uff1a<ul> <li><code>&gt; 1.0</code>\uff1a\u7b56\u7565\u8868\u73fe\u826f\u597d\uff0c\u5831\u916c\u8db3\u4ee5\u5f4c\u88dc\u98a8\u96aa\u3002</li> <li><code>&gt; 2.0</code>\uff1a\u7b56\u7565\u8868\u73fe\u512a\u79c0\u3002</li> <li><code>&lt; 0</code>\uff1a\u7b56\u7565\u8868\u73fe\u4e0d\u5982\u7121\u98a8\u96aa\u8cc7\u7522\uff08\u5982\u5b9a\u5b58\uff09\u3002</li> </ul> </li> </ul>"},{"location":"concepts/performance-metrics/#sortino-ratio","title":"Sortino ratio (\u7d22\u63d0\u8afe\u6bd4\u7387)","text":"<ul> <li>\u5b9a\u7fa9\uff1a\u590f\u666e\u6bd4\u7387\u7684\u6539\u826f\u7248\u3002\u8a08\u7b97\u6642\u53ea\u8003\u616e \u4e0b\u6a94\u6ce2\u52d5 (Downside Volatility)\uff0c\u5373\u53ea\u5c07\u300c\u8667\u640d\u7684\u6ce2\u52d5\u300d\u8996\u70ba\u98a8\u96aa\uff0c\u5ffd\u7565\u4e0a\u6f32\u5e36\u4f86\u7684\u6ce2\u52d5\u3002</li> <li>\u5224\u8b80\uff1a\u82e5 Sortino \u6bd4 Sharpe \u9ad8\uff0c\u4ee3\u8868\u7b56\u7565\u7684\u6ce2\u52d5\u4e3b\u8981\u4f86\u81ea\u65bc\u50f9\u683c\u4e0a\u6f32\uff08\u9019\u662f\u597d\u7684\u6ce2\u52d5\uff09\u3002</li> </ul> <p>\u7bc4\u4f8b\u89e3\u8b80</p> <p>\u5728\u6b64\u7bc4\u4f8b\u4e2d\uff0cSharpe \u70ba <code>1.41</code>\uff0c\u800c Sortino \u9ad8\u9054 <code>2.11</code>\u3002\u9019\u986f\u793a\u7b56\u7565\u96d6\u7136\u6ce2\u52d5\u7387\u9ad8 (24%)\uff0c\u4f46\u5927\u90e8\u5206\u6ce2\u52d5\u662f\u5411\u4e0a\u7372\u5229\u7684\uff0c\u4e0b\u6a94\u98a8\u96aa\u76f8\u5c0d\u53ef\u63a7\u3002</p>"},{"location":"concepts/performance-metrics/#2-risk-metrics","title":"2. \u9032\u968e\u98a8\u96aa\u6307\u6a19 (Risk Metrics)","text":"<p>\u6b64\u5340\u584a\u63ed\u9732\u4e86\u6975\u7aef\u60c5\u6cc1\u4e0b\u7684\u98a8\u96aa\u7279\u5fb5\uff0c\u5c0d\u65bc\u98a8\u96aa\u63a7\u7ba1\u81f3\u95dc\u91cd\u8981\u3002</p>"},{"location":"concepts/performance-metrics/#max-drawdown","title":"Max drawdown (\u6700\u5927\u56de\u64a4)","text":"<ul> <li>\u5b9a\u7fa9\uff1a\u5728\u9078\u5b9a\u671f\u9593\u5167\uff0c\u8cc7\u7522\u5f9e\u6b77\u53f2\u6700\u9ad8\u9ede\u8dcc\u843d\u81f3\u6700\u4f4e\u9ede\u7684\u6700\u5927\u8dcc\u5e45\u3002</li> <li>\u5224\u8b80\uff1a\u4ee3\u8868\u6295\u8cc7\u4eba\u53ef\u80fd\u9762\u81e8\u7684\u6700\u58de\u5e33\u9762\u8667\u640d\u3002</li> </ul>"},{"location":"concepts/performance-metrics/#omega-ratio","title":"Omega ratio (\u6b50\u7c73\u4f3d\u6bd4\u7387)","text":"<ul> <li>\u5b9a\u7fa9\uff1a\u7372\u5229\u5e45\u5ea6\u8207\u8667\u640d\u5e45\u5ea6\u7684\u6a5f\u7387\u52a0\u6b0a\u6bd4\u7387\u3002</li> <li>\u5224\u8b80\uff1a\u8861\u91cf\u300c\u7372\u5229\u6f5b\u529b\u300d\u76f8\u5c0d\u65bc\u300c\u8667\u640d\u6f5b\u529b\u300d\u7684\u76c8\u8667\u6bd4\u3002\u6578\u503c\u5927\u65bc 1 \u4ee3\u8868\u7372\u5229\u671f\u671b\u503c\u5927\u65bc\u8667\u640d\u3002</li> </ul>"},{"location":"concepts/performance-metrics/#skew-kurtosis","title":"Skew (\u504f\u5ea6) \u8207 Kurtosis (\u5cf0\u5ea6)","text":"<ul> <li>Skew (\u504f\u5ea6)\uff1a\u8861\u91cf\u5831\u916c\u5206\u4f48\u7684\u5c0d\u7a31\u6027\u3002<ul> <li>\u8ca0\u503c (\u5de6\u504f)\uff1a\u4ee3\u8868\u7b56\u7565\u5bb9\u6613\u51fa\u73fe\u6975\u7aef\u7684\u5c0f\u6a5f\u7387\u8667\u640d\uff08\u9ed1\u5929\u9d5d\u4e8b\u4ef6\uff09\u3002</li> </ul> </li> <li>Kurtosis (\u5cf0\u5ea6)\uff1a\u8861\u91cf\u5206\u4f48\u7684\u300c\u80a5\u5c3e\u300d\u7a0b\u5ea6\u3002<ul> <li>\u9ad8\u6578\u503c\uff1a\u4ee3\u8868\u6975\u7aef\u884c\u60c5\u767c\u751f\u7684\u983b\u7387\u9ad8\u65bc\u5e38\u614b\u5206\u4f48\u7684\u9810\u671f\u3002</li> </ul> </li> </ul> <p>\u7bc4\u4f8b\u89e3\u8b80</p> <ul> <li>Max drawdown: <code>-34.80%</code> \u2014\u2014 \u6b77\u53f2\u6700\u5927\u8dcc\u5e45\u66fe\u9054\u4e09\u5206\u4e4b\u4e00\uff0c\u4f7f\u7528\u8005\u9700\u8a55\u4f30\u8cc7\u91d1\u627f\u53d7\u529b\u3002</li> <li>Kurtosis: <code>5.78</code> \u2014\u2014 \u6578\u503c\u504f\u9ad8\uff0c\u6697\u793a\u7b56\u7565\u5177\u6709\u80a5\u5c3e\u6548\u61c9\uff0c\u9700\u63d0\u9632\u7a81\u767c\u6027\u7684\u6975\u7aef\u884c\u60c5\u3002</li> </ul>"},{"location":"concepts/performance-metrics/#3-holdings-trading","title":"3. \u6301\u5009\u8207\u4ea4\u6613\u7279\u5fb5 (Holdings &amp; Trading)","text":"<p>\u6b64\u90e8\u5206\u53cd\u6620\u7b56\u7565\u7684\u904b\u4f5c\u98a8\u683c\u3001\u4ea4\u6613\u6210\u672c\u8207\u6f5b\u5728\u7684\u7d50\u69cb\u6027\u98a8\u96aa\u3002</p>"},{"location":"concepts/performance-metrics/#daily-turnover","title":"Daily turnover (\u6bcf\u65e5\u63db\u624b\u7387)","text":"<ul> <li>\u5b9a\u7fa9\uff1a\u6bcf\u65e5\u8cb7\u8ce3\u91d1\u984d\u4f54\u7e3d\u8cc7\u7522\u7684\u6bd4\u4f8b\u3002</li> <li>\u5224\u8b80\uff1a<ul> <li>\u6578\u503c\u8d8a\u9ad8\uff0c\u4ee3\u8868\u4ea4\u6613\u8d8a\u983b\u7e41\uff0c\u624b\u7e8c\u8cbb\u8207\u6ed1\u50f9\u6210\u672c\u8d8a\u9ad8\u3002</li> <li>\u5e73\u5747\u6301\u5009\u9031\u671f\u7d04\u70ba \\(1 / Turnover\\)\u3002</li> </ul> </li> </ul>"},{"location":"concepts/performance-metrics/#top-10-positions","title":"Top 10 Positions (\u5341\u5927\u6301\u5009\u4f54\u6bd4)","text":"<ul> <li>\u5b9a\u7fa9\uff1a\u524d\u5341\u5927\u6301\u80a1\u4f54\u7e3d\u8cc7\u7522\u7684\u767e\u5206\u6bd4\u3002</li> <li>\u5224\u8b80\uff1a\u7528\u65bc\u8a55\u4f30 \u96c6\u4e2d\u5ea6\u98a8\u96aa (Concentration Risk)\u3002\u82e5\u55ae\u4e00\u500b\u80a1\u4f54\u6bd4\u904e\u9ad8\uff0c\u7b56\u7565\u7e3e\u6548\u5c07\u904e\u5ea6\u4f9d\u8cf4\u55ae\u4e00\u6a19\u7684\u3002</li> </ul> <p>\u7bc4\u4f8b\u89e3\u8b80\uff1a\u9ad8\u5ea6\u96c6\u4e2d\u7684\u98a8\u96aa</p> <p>\u4e0b\u8868\u70ba\u67d0\u7b56\u7565\u7684\u6301\u5009\u7bc4\u4f8b\u3002\u53ef\u898b\u524d\u5169\u5927\u6301\u80a1\u4f54\u6bd4\u7686\u8d85\u904e 42%\uff1a</p> Stock Max % 2615 42.38% 2915 42.14% <p>\u9019\u986f\u793a\u8a72\u7bc4\u4f8b\u7b56\u7565\u5177\u6709\u6975\u9ad8\u7684\u96c6\u4e2d\u5ea6\u98a8\u96aa\uff0c\u55ae\u4e00\u500b\u80a1\u7684\u6f32\u8dcc\u5c0d\u6de8\u503c\u5f71\u97ff\u5de8\u5927\u3002</p>"},{"location":"concepts/performance-metrics/#4-key-charts","title":"4. \u95dc\u9375\u5716\u8868\u8aaa\u660e (Key Charts)","text":""},{"location":"concepts/performance-metrics/#41-worst-drawdown-periods","title":"4.1. \u6700\u5dee\u56de\u64a4\u671f (Worst Drawdown Periods)","text":"<p>\u6b64\u8868\u683c\u5217\u51fa\u4e86\u6b77\u53f2\u4e0a\u8dcc\u5e45\u6700\u6df1\u7684\u5e7e\u6b21\u4e8b\u4ef6\uff0c\u5e6b\u52a9\u4f7f\u7528\u8005\u4e86\u89e3\u7b56\u7565\u5728\u9006\u5883\u4e2d\u7684\u8868\u73fe\u3002</p> <ul> <li>Net drawdown\uff1a\u8dcc\u5e45\u767e\u5206\u6bd4\u3002</li> <li>Peak / Valley\uff1a\u8d77\u8dcc\u9ede\u8207\u6700\u4f4e\u9ede\u65e5\u671f\u3002</li> <li>Duration\uff1a\u5f9e\u8d77\u8dcc\u5230\u5b8c\u5168\u89e3\u5957\uff08\u6de8\u503c\u5275\u65b0\u9ad8\uff09\u6240\u7d93\u6b77\u7684\u6642\u9593\u3002</li> </ul> <p>\u7bc4\u4f8b\u6578\u64da</p> Rank Net Drawdown Duration \u8aaa\u660e 1 -34.80% 471 Days \u7bc4\u4f8b\u7b56\u7565\u66fe\u7d93\u6b77\u9577\u9054 1 \u5e74\u4ee5\u4e0a\u7684\u8cc7\u91d1\u5957\u7262\u671f\u3002 2 -31.02% 105 Days \u6b21\u5927\u8dcc\u5e45\u767c\u751f\u5728\u77ed\u6642\u9593\u5167\uff0c\u4f46\u6062\u5fa9\u901f\u5ea6\u8f03\u5feb\u3002"},{"location":"concepts/performance-metrics/#42-underwater-plot","title":"4.2. \u6c34\u4e0b\u5716 (Underwater Plot)","text":"<ul> <li>\u5b9a\u7fa9\uff1a\u5c07\u6b77\u53f2\u9ad8\u9ede\u8a2d\u70ba 0%\uff0c\u8996\u89ba\u5316\u5448\u73fe\u6de8\u503c\u56de\u843d\u7684\u5e45\u5ea6\u8207\u6642\u9593\u9577\u5ea6\u3002</li> <li>\u7528\u9014\uff1a\u5feb\u901f\u8b58\u5225\u7b56\u7565\u7684\u300c\u75db\u82e6\u671f\u300d\u3002\u82e5\u9670\u5f71\u9762\u7a4d\u5927\u4e14\u6df1\uff0c\u4ee3\u8868\u7b56\u7565\u9577\u671f\u8655\u65bc\u8667\u640d\u6216\u56de\u88dc\u72c0\u614b\u3002</li> </ul>"},{"location":"concepts/performance-metrics/#5-factor-analysis","title":"5. \u56e0\u5b50\u5206\u6790 (Factor Analysis)","text":"<p>\u8a55\u4f30\u7b56\u7565\u5831\u916c\u4f86\u6e90\u662f\u4f86\u81ea\u65bc\u9078\u80a1\u80fd\u529b (Alpha) \u9084\u662f\u5e02\u5834\u8da8\u52e2 (Beta)\u3002</p> <ul> <li>Alpha (\u963f\u723e\u6cd5)\uff1a\u6263\u9664\u5e02\u5834\u98a8\u96aa\u5f8c\u7684\u8d85\u984d\u5831\u916c\u3002\u6b63\u503c\u4ee3\u8868\u7b56\u7565\u5177\u6709\u64ca\u6557\u5927\u76e4\u7684\u80fd\u529b\u3002</li> <li>Beta (\u8c9d\u5854)\uff1a\u7b56\u7565\u5c0d\u5927\u76e4\u6ce2\u52d5\u7684\u654f\u611f\u5ea6\u3002<ul> <li>\\(\\beta = 1\\)\uff1a\u8207\u5927\u76e4\u540c\u6b65\u3002</li> <li>\\(\\beta = 0\\)\uff1a\u8207\u5927\u76e4\u7121\u95dc\uff08\u5e02\u5834\u4e2d\u6027\uff09\u3002</li> </ul> </li> </ul> <p>\u7bc4\u4f8b\u89e3\u8b80</p> <ul> <li>Alpha: <code>0.20</code> \u2014\u2014 \u7b56\u7565\u5177\u5099\u9078\u80a1\u80fd\u529b\uff0c\u80fd\u5275\u9020\u5e74\u5316 20% \u7684\u8d85\u984d\u5831\u916c\u3002</li> <li>Beta: <code>0.88</code> \u2014\u2014 \u7b56\u7565\u8207\u5927\u76e4\u9ad8\u5ea6\u6b63\u76f8\u95dc\uff0c\u5c6c\u65bc\u9806\u52e2\u578b\u7b56\u7565\u3002</li> </ul>"},{"location":"concepts/performance-metrics/#6-pitfalls","title":"6. \u5e38\u898b\u56de\u6e2c\u9677\u9631 (Pitfalls)","text":"<p>\u524d\u8996\u504f\u5dee (Look-ahead Bias)</p> <p>\u5728\u56de\u6e2c\u4e2d\u4f7f\u7528\u4e86\u300c\u672a\u4f86\u624d\u77e5\u9053\u300d\u7684\u8cc7\u8a0a\u3002\u4f8b\u5982\uff1a\u5728\u8a08\u7b97\u4eca\u65e5\u8a0a\u865f\u6642\uff0c\u4e0d\u5c0f\u5fc3\u7528\u5230\u4e86\u300c\u4eca\u65e5\u6536\u76e4\u50f9\u300d\uff08\u73fe\u5be6\u4e2d\u76e4\u4e2d\u7121\u6cd5\u9810\u77e5\u6536\u76e4\u50f9\uff09\u3002\u9019\u662f\u5c0e\u81f4\u56de\u6e2c\u5931\u771f\u7684\u982d\u865f\u6bba\u624b\u3002</p> <p>\u751f\u5b58\u504f\u5dee (Survivorship Bias)</p> <p>\u53ea\u9078\u4e86\u300c\u73fe\u5728\u9084\u6d3b\u8457\u300d\u7684\u80a1\u7968\u56de\u6e2c\u3002\u4f8b\u5982\u56de\u6e2c 2000 \u5e74\u79d1\u6280\u80a1\u6642\uff0c\u5ffd\u7565\u4e86\u90a3\u4e9b\u5df2\u7d93\u5012\u9589\u4e0b\u5e02\u7684\u516c\u53f8\uff0c\u5c0e\u81f4\u7e3e\u6548\u88ab\u56b4\u91cd\u9ad8\u4f30\u3002</p> <p>\u904e\u5ea6\u64ec\u5408 (Overfitting)</p> <p>\u5728\u6b77\u53f2\u6578\u64da\u4e0a\u8868\u73fe\u5b8c\u7f8e\uff08\u4f8b\u5982\u5e74\u5316 200%\uff09\uff0c\u4f46\u5728\u771f\u5be6\u4ea4\u6613\u4e2d\u4e00\u584c\u7cca\u5857\u3002\u901a\u5e38\u662f\u56e0\u70ba\u53c3\u6578\u904e\u591a\uff0c\u523b\u610f\u8fce\u5408\u4e86\u6b77\u53f2\u96dc\u8a0a\u3002</p>"},{"location":"concepts/pipeline-overview/","title":"Pipeline \u6295\u8cc7\u8a0a\u865f\u751f\u6210","text":"<p>Info</p> <p>\u672c\u9801\u6df1\u5165\u89e3\u91cb Zipline Pipeline \u7684\u904b\u4f5c\u539f\u7406\uff0c\u5305\u62ec\u5176\u6838\u5fc3\u7d44\u4ef6\uff08Factors, Filters, Classifiers\uff09\u3001\u8cc7\u6599\u96c6 (DataSets) \u7684\u6982\u5ff5\u3001\u4ee5\u53ca\u5982\u4f55\u900f\u904e Pipeline \u9ad8\u6548\u5730\u751f\u6210\u4ea4\u6613\u8a0a\u865f\uff0c\u70ba\u4f7f\u7528\u8005\u5efa\u7acb\u5c0d Pipeline \u7684\u5168\u9762\u7406\u89e3\u3002</p> <p>Zipline Pipeline \u662f\u4e00\u500b\u5f37\u5927\u4e14\u9ad8\u6548\u7684\u5de5\u5177\uff0c\u5c08\u70ba\u5728\u5927\u91cf\u7684\u8b49\u5238\u6642\u9593\u5e8f\u5217\u6578\u64da\u4e0a\u9032\u884c\u9ad8\u6548\u8a08\u7b97\u800c\u8a2d\u8a08\u3002\u5728\u91cf\u5316\u4ea4\u6613\u4e2d\uff0c\u6211\u5011\u7d93\u5e38\u9700\u8981\u5c0d\u6574\u500b\u5e02\u5834\u7684\u80a1\u7968\u8a08\u7b97\u5404\u7a2e\u6307\u6a19\uff08\u5982\u79fb\u52d5\u5e73\u5747\u3001\u6ce2\u52d5\u7387\uff09\uff0c\u4e26\u6839\u64da\u9019\u4e9b\u6307\u6a19\u7be9\u9078\u51fa\u7b26\u5408\u7279\u5b9a\u689d\u4ef6\u7684\u80a1\u7968\u6c60\u3002\u5982\u679c\u4f7f\u7528\u50b3\u7d71\u7684 for-loop \u9010\u4e00\u8655\u7406\u6bcf\u96bb\u80a1\u7968\uff0c\u7576\u80a1\u7968\u6578\u91cf\u9f90\u5927\u6216\u8a08\u7b97\u8907\u96dc\u6642\uff0c\u6548\u7387\u6703\u975e\u5e38\u4f4e\u4e0b\u3002</p> <p>\u5b83\u5c07\u6240\u6709\u8a08\u7b97 \u5411\u91cf\u5316 (Vectorized)\uff0c\u5229\u7528\u5e95\u5c64\u512a\u5316\u7684 <code>NumPy</code> \u548c <code>Pandas</code> \u904b\u7b97\uff0c \u4e00\u6b21\u6027 \u5730\u5c0d\u6240\u6709\u8cc7\u7522\u9032\u884c\u6a6b\u622a\u9762\u8a08\u7b97\uff0c\u5f9e\u4ece\u800c\u6975\u5927\u5730\u63d0\u5347\u4e86\u904b\u7b97\u6548\u7387\u3002</p>"},{"location":"concepts/pipeline-overview/#1-pipeline","title":"1. Pipeline \u7c21\u4ecb","text":"<p>\u60a8\u53ef\u4ee5\u5c07 Pipeline \u60f3\u50cf\u6210\u4e00\u689d\u8655\u7406\u8b49\u5238\u6578\u64da\u7684\u300c\u7ba1\u7dda\u300d\u3002\u6578\u64da\u5f9e\u4e00\u7aef\u6d41\u5165\uff0c\u7d93\u904e\u7ba1\u7dda\u4e2d\u4e00\u7cfb\u5217\u7684\u8655\u7406\u7ad9\uff08\u8a08\u7b97\u3001\u7be9\u9078\u3001\u5206\u985e\uff09\uff0c\u6700\u7d42\u5728\u53e6\u4e00\u7aef\u7522\u51fa\u4e00\u500b\u7d50\u69cb\u5316\u7684\u6578\u64da\u8868 (DataFrame)\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u60a8\u5728\u7576\u5929\u4ea4\u6613\u6240\u9700\u8981\u7684\u6240\u6709\u8cc7\u8a0a\u3002</p> <p>\u5728 Zipline \u7b56\u7565\u4e2d\uff0cPipeline \u7684\u4e3b\u8981\u8077\u8cac\u662f\u5728\u6bcf\u500b\u4ea4\u6613\u65e5\u958b\u76e4\u524d\uff0c\u70ba <code>handle_data</code> \u51fd\u6578\u6e96\u5099\u597d\u7576\u65e5\u7814\u7a76\u6240\u9700\u7684\u6578\u64da\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u8a08\u7b97\u6bcf\u96bb\u80a1\u7968\u7684 20 \u65e5\u79fb\u52d5\u5e73\u5747\u50f9\u3002</li> <li>\u7be9\u9078\u51fa\u7576\u524d\u5e02\u503c\u6392\u540d\u524d 10% \u7684\u80a1\u7968\u3002</li> <li>\u6a19\u8a18\u51fa\u6bcf\u96bb\u80a1\u7968\u6240\u5c6c\u7684\u7522\u696d\u985e\u5225\u3002</li> </ul>"},{"location":"concepts/pipeline-overview/#2-pipeline","title":"2. Pipeline \u7684\u4e09\u5927\u6838\u5fc3\u7d44\u4ef6","text":"<p>Pipeline \u4e3b\u8981\u7531\u4e09\u7a2e\u985e\u578b\u7684\u7d44\u4ef6\u69cb\u6210\uff0c\u5b83\u5011\u53ef\u4ee5\u88ab\u9748\u6d3b\u5730\u7d44\u5408\uff0c\u4ee5\u69cb\u5efa\u8907\u96dc\u7684\u6578\u64da\u8655\u7406\u908f\u8f2f\u3002</p>"},{"location":"concepts/pipeline-overview/#factors","title":"Factors (\u56e0\u5b50)","text":"<ul> <li>\u4f5c\u7528\uff1a\u8a08\u7b97\u4e00\u500b\u6578\u503c\u3002\u6bcf\u500b\u8cc7\u7522\u5728\u6bcf\u500b\u6642\u9593\u9ede\u90fd\u6703\u88ab\u8ce6\u4e88\u4e00\u500b\u7531 Factor \u8a08\u7b97\u51fa\u7684\u6d6e\u9ede\u6578\u6216\u6574\u6578\u3002</li> <li>\u7bc4\u4f8b\uff1a<ul> <li><code>SimpleMovingAverage(inputs=[TWEquityPricing.close], window_length=20)</code>\uff1a\u8a08\u7b97 20 \u65e5\u6536\u76e4\u50f9\u7684\u79fb\u52d5\u5e73\u5747\u3002</li> <li><code>Momentum(inputs=[TWEquityPricing.close], window_length=10)</code>\uff1a\u8a08\u7b97 10 \u65e5\u52d5\u91cf\u3002</li> <li><code>CustomFactor</code>\uff1a\u60a8\u53ef\u4ee5\u7e7c\u627f <code>CustomFactor</code> \u985e\u5225\u4f86\u5275\u5efa\u81ea\u5df1\u7684\u56e0\u5b50\uff0c\u5be6\u73fe\u4efb\u610f\u8907\u96dc\u7684\u8a08\u7b97\u908f\u8f2f\u3002</li> </ul> </li> </ul>"},{"location":"concepts/pipeline-overview/#filters","title":"Filters (\u6ffe\u7db2)","text":"<ul> <li>\u4f5c\u7528\uff1a\u7be9\u9078\u51fa\u4e00\u7d44\u7b26\u5408\u689d\u4ef6\u7684\u8cc7\u7522\u3002\u6bcf\u500b\u8cc7\u7522\u5728\u6bcf\u500b\u6642\u9593\u9ede\u90fd\u6703\u88ab\u8ce6\u4e88\u4e00\u500b\u5e03\u6797\u503c (True/False)\u3002</li> <li>\u7bc4\u4f8b\uff1a<ul> <li><code>SimpleMovingAverage(...) &gt; 100</code>\uff1a\u7be9\u9078\u51fa 20 \u65e5\u5747\u7dda\u5927\u65bc 100 \u7684\u80a1\u7968\u3002</li> <li><code>MarketCap().top(100)</code>\uff1a\u7be9\u9078\u51fa\u5e02\u503c\u6392\u540d\u524d 100 \u7684\u80a1\u7968\u3002</li> <li><code>StaticAssets([...])</code>\uff1a\u7be9\u9078\u51fa\u4e00\u500b\u975c\u614b\u7684\u80a1\u7968\u5217\u8868\u3002</li> </ul> </li> </ul>"},{"location":"concepts/pipeline-overview/#classifiers","title":"Classifiers (\u5206\u985e\u5668)","text":"<ul> <li>\u4f5c\u7528\uff1a\u70ba\u8cc7\u7522\u9032\u884c\u5206\u985e\u3002\u6bcf\u500b\u8cc7\u7522\u5728\u6bcf\u500b\u6642\u9593\u9ede\u90fd\u6703\u88ab\u8ce6\u4e88\u4e00\u500b\u6a19\u7c64\uff08\u901a\u5e38\u662f\u5b57\u4e32\u6216\u6574\u6578\uff09\uff0c\u7528\u65bc\u5206\u7d44\u3002</li> <li>\u7bc4\u4f8b\uff1a<ul> <li><code>Sector()</code>\uff1a\u8fd4\u56de\u6bcf\u96bb\u80a1\u7968\u6240\u5c6c\u7684\u7522\u696d\u985e\u5225\u3002 <p>\u8a73\u898b\uff1a\u5167\u5efa\u56e0\u5b50/\u6ffe\u7db2/\u5206\u985e\u5668</p> </li> </ul> </li> </ul>"},{"location":"concepts/pipeline-overview/#3-datasets","title":"3. \u8cc7\u6599\u96c6 (DataSets)","text":"<p>Pipeline \u9700\u8981\u5f9e\u4e00\u500b\u5b9a\u7fa9\u597d\u7684\u8cc7\u6599\u96c6\u4e2d\u7372\u53d6\u539f\u59cb\u6578\u64da\u3002TQuant Lab \u63d0\u4f9b\u4e86\u591a\u7a2e\u5167\u5efa\u7684\u8cc7\u6599\u96c6\uff1a</p> <ul> <li><code>TWEquityPricing</code>\uff1a\u63d0\u4f9b\u53f0\u7063\u5e02\u5834\u7684\u80a1\u7968\u50f9\u91cf\u8cc7\u6599\uff0c\u5305\u62ec\u958b\u3001\u9ad8\u3001\u4f4e\u3001\u6536\u3001\u91cf (<code>open</code>, <code>high</code>, <code>low</code>, <code>close</code>, <code>volume</code>)\u3002</li> <li><code>TQDataSet</code> / <code>TQAltDataSet</code>\uff1a\u63d0\u4f9b\u7531 TEJ \u6574\u7406\u7684\u8ca1\u52d9\u3001\u975e\u8ca1\u52d9\u6578\u64da\uff0c\u4f8b\u5982 <code>Market_Cap_Dollars</code> (\u5e02\u503c)\u3001<code>PER</code> (\u672c\u76ca\u6bd4) \u7b49\u3002</li> </ul> <p>\u8a73\u898b\uff1a\u8cc7\u6599\u96c6 (\u6982\u8ad6)</p>"},{"location":"concepts/pipeline-overview/#4-pipeline","title":"4. Pipeline \u7684\u904b\u4f5c\u6d41\u7a0b","text":"<p>\u5728\u4e00\u500b\u5178\u578b\u7684 Zipline \u7b56\u7565\u4e2d\uff0cPipeline \u7684\u904b\u4f5c\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <pre><code>graph TD\n    subgraph \"\u6bcf\u65e5\u76e4\u524d (before_trading_start)\"\n        A[1. \u5b9a\u7fa9 make_pipeline \u51fd\u6578] --&gt; B[2. \u8a3b\u518a Pipeline];\n        B --&gt; C[3. Zipline \u5f15\u64ce\u57f7\u884c Pipeline];\n        C --&gt; D[4. \u7522\u751f\u7576\u65e5\u8a0a\u865f DataFrame];\n    end\n\n    subgraph \"\u6bcf\u65e5\u76e4\u4e2d (handle_data)\"\n        D --&gt; E[5. \u7372\u53d6 Pipeline \u8f38\u51fa];\n        E --&gt; F[6. \u57f7\u884c\u4ea4\u6613\u908f\u8f2f];\n    end\n\n    A -- \u5305\u542b Factors, Filters, Classifiers --&gt; B;\n    B -- `attach_pipeline(make_pipeline(), 'my_pipe')` --&gt; C;\n    E -- `pipeline_output('my_pipe')` --&gt; F;</code></pre> <ol> <li> <p>\u5b9a\u7fa9 <code>make_pipeline()</code> \u51fd\u6578\uff1a     \u60a8\u9700\u8981\u5275\u5efa\u4e00\u500b\u540d\u70ba <code>make_pipeline()</code> \u7684\u51fd\u6578\uff0c\u4e26\u5728\u5176\u4e2d\u5b9a\u7fa9 Pipeline \u7684\u7d50\u69cb\uff0c\u5305\u62ec\u8981\u8a08\u7b97\u7684 Factors\u3001\u7be9\u9078\u7684 Filters \u7b49\u3002</p> <pre><code>from zipline.pipeline import Pipeline\nfrom zipline.pipeline.factors import SimpleMovingAverage\nfrom zipline.pipeline.data import TWEquityPricing\n\ndef make_pipeline():\n    mean_close_20 = SimpleMovingAverage(inputs=[TWEquityPricing.close], window_length=20)\n\n    return Pipeline(\n        columns={\n            'mean_close_20': mean_close_20\n        },\n        screen = (mean_close_20 &gt; 10) # \u50c5\u8a08\u7b97\u5747\u7dda\u5927\u65bc 10 \u7684\u80a1\u7968\n    )\n</code></pre> </li> <li> <p>\u5728 <code>initialize</code> \u4e2d\u8a3b\u518a Pipeline\uff1a     \u4f7f\u7528 <code>attach_pipeline()</code> \u51fd\u6578\u5c07\u60a8\u5b9a\u7fa9\u7684 <code>make_pipeline</code> \u8a3b\u518a\u5230 Zipline \u5f15\u64ce\u4e2d\uff0c\u4e26\u70ba\u5176\u547d\u540d\uff08\u4f8b\u5982 <code>'my_pipe'</code>\uff09\u3002</p> <pre><code>def initialize(context):\n    attach_pipeline(make_pipeline(), 'my_pipe')\n</code></pre> </li> <li> <p>\u5728 <code>handle_data</code> \u4e2d\u7372\u53d6\u7d50\u679c\uff1a     \u5728 <code>handle_data</code> \u51fd\u6578\u4e2d\uff0c\u4f7f\u7528 <code>pipeline_output()</code> \u4e26\u50b3\u5165\u60a8\u4e4b\u524d\u8a2d\u5b9a\u7684\u540d\u7a31\uff0c\u5373\u53ef\u7372\u53d6\u4e00\u500b Pandas DataFrame\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u7576\u5929 Pipeline \u8a08\u7b97\u548c\u7be9\u9078\u5f8c\u7684\u7d50\u679c\u3002</p> <pre><code>def handle_data(context, data):\n    pipe_results = pipeline_output('my_pipe')\n\n    # pipe_results \u662f\u4e00\u500b DataFrame\uff0c\u5305\u542b\u4e86\u6240\u6709\u901a\u904e screen \u7be9\u9078\u7684\u80a1\u7968\n    # \u4ee5\u53ca\u60a8\u5728 columns \u4e2d\u5b9a\u7fa9\u7684 'mean_close_20' \u6b04\u4f4d\n    for asset in pipe_results.index:\n        mean_price = pipe_results.loc[asset, 'mean_close_20']\n        # ... \u57f7\u884c\u60a8\u7684\u4ea4\u6613\u908f\u8f2f ...\n</code></pre> </li> </ol>"},{"location":"concepts/pipeline-overview/#5-customfactor","title":"5. \u81ea\u8a02\u56e0\u5b50 (CustomFactor)","text":"<p>\u7576\u5167\u5efa\u7684\u56e0\u5b50\u7121\u6cd5\u6eff\u8db3\u60a8\u7684\u9700\u6c42\u6642\uff0c\u53ef\u4ee5\u900f\u904e\u7e7c\u627f <code>CustomFactor</code> \u985e\u5225\u4f86\u5275\u5efa\u81ea\u5df1\u7684\u56e0\u5b50\u3002\u60a8\u53ea\u9700\u8981\u5b9a\u7fa9 <code>inputs</code>\uff08\u9700\u8981\u54ea\u4e9b\u539f\u59cb\u6578\u64da\uff09\u548c <code>window_length</code>\uff08\u9700\u8981\u591a\u9577\u7684\u6642\u9593\u7a97\u53e3\uff09\uff0c\u4e26\u5be6\u73fe <code>compute</code> \u65b9\u6cd5\u4f86\u63cf\u8ff0\u60a8\u7684\u8a08\u7b97\u908f\u8f2f\u3002</p> <pre><code>from zipline.pipeline import CustomFactor\nimport numpy as np\n\nclass MyMomentum(CustomFactor):\n    inputs = [TWEquityPricing.close]\n    window_length = 10\n\n    def compute(self, today, assets, out, close_prices):\n        # close_prices \u662f\u4e00\u500b 10xN \u7684 NumPy array\n        # (window_length x number of assets)\n\n        # \u8a08\u7b97 10 \u65e5\u52d5\u91cf\uff1a(\u4eca\u65e5\u50f9\u683c / 10\u5929\u524d\u50f9\u683c) - 1\n        out[:] = (close_prices[-1] / close_prices[0]) - 1\n</code></pre> <p>\u8a73\u898b\uff1a\u81ea\u8a02\u56e0\u5b50</p>"},{"location":"concepts/pipeline-overview/#6-pipeline","title":"6. Pipeline \u5728\u7b56\u7565\u4e2d\u7684\u4f7f\u7528","text":"<p>Pipeline \u7684\u8a2d\u8a08\u65e8\u5728\u8207 Zipline \u7684\u4e8b\u4ef6\u9a45\u52d5\u56de\u6e2c\u6846\u67b6\u7121\u7e2b\u5354\u4f5c\uff0c\u70ba\u7b56\u7565\u63d0\u4f9b\u6bcf\u65e5\u66f4\u65b0\u7684\u4ea4\u6613\u8a0a\u865f\u3002</p>"},{"location":"concepts/pipeline-overview/#handle_data-pipeline","title":"\u5728 handle_data \u4e2d\u7372\u53d6 Pipeline \u7d50\u679c","text":"<p>\u5982\u524d\u6240\u8ff0\uff0c\u5728 <code>handle_data(context, data)</code> \u51fd\u6578\u4e2d\uff0c\u60a8\u53ef\u4ee5\u900f\u904e <code>pipeline_output('\u60a8\u7684 Pipeline \u540d\u7a31')</code> \u4f86\u7372\u53d6 Pipeline \u5728\u7576\u65e5\u8a08\u7b97\u51fa\u7684\u7d50\u679c\u3002\u9019\u500b\u7d50\u679c\u662f\u4e00\u500b Pandas DataFrame\uff0c\u5176\u7d22\u5f15\u70ba\u8cc7\u7522 (Asset)\uff0c\u6b04\u4f4d\u70ba\u60a8\u5728 Pipeline \u4e2d\u5b9a\u7fa9\u7684 Factors\u3001Filters \u6216 Classifiers \u7684\u8f38\u51fa\u3002</p> <pre><code>def handle_data(context, data):\n    # \u7372\u53d6 Pipeline \u5728\u7576\u65e5\u8a08\u7b97\u51fa\u7684\u7d50\u679c\n    current_signals = pipeline_output('my_pipeline_name')\n\n    if current_signals is not None and not current_signals.empty:\n        for asset_id, row in current_signals.iterrows():\n            # \u6839\u64da Pipeline \u7522\u751f\u7684\u8a0a\u865f\u57f7\u884c\u4ea4\u6613\u908f\u8f2f\n            # \u4f8b\u5982\uff1a\u5982\u679c\u67d0\u500b\u56e0\u5b50\u503c\u9054\u5230\u95be\u503c\uff0c\u5247\u4e0b\u55ae\n            pass\n</code></pre>"},{"location":"concepts/pipeline-overview/#_1","title":"\u57f7\u884c\u6642\u6a5f\u8207\u6027\u80fd\u8003\u91cf","text":"<p>Pipeline \u7684\u8a08\u7b97\u901a\u5e38\u5728\u6bcf\u500b\u4ea4\u6613\u65e5\u7684 <code>before_trading_start()</code> \u51fd\u6578\u4e2d\u57f7\u884c\uff0c\u9019\u78ba\u4fdd\u4e86\u5728 <code>handle_data()</code> \u57f7\u884c\u6642\uff0c\u6240\u6709\u57fa\u65bc Pipeline \u7684\u8a0a\u865f\u90fd\u5df2\u6e96\u5099\u5c31\u7dd2\u3002\u9019\u7a2e\u8a2d\u8a08\u5c07\u8017\u6642\u7684\u6578\u64da\u8655\u7406\u8207\u4ea4\u6613\u6c7a\u7b56\u5206\u96e2\uff0c\u6709\u52a9\u65bc\u63d0\u5347\u56de\u6e2c\u6548\u7387\u3002</p> <ul> <li>\u7f3a\u5931\u8cc7\u6599\u8655\u7406\uff1a     Pipeline \u5728\u8655\u7406\u6578\u64da\u6642\u6703\u81ea\u52d5\u8655\u7406\u7f3a\u5931\u503c (NaN)\u3002\u60a8\u53ef\u4ee5\u900f\u904e\u5728 Pipeline \u4e2d\u4f7f\u7528 <code>Factor().fillna()</code> \u6216\u5728 <code>handle_data</code> \u4e2d\u6aa2\u67e5 <code>current_signals</code> \u662f\u5426\u70ba\u7a7a\u6216\u5305\u542b NaN \u503c\u4f86\u9032\u4e00\u6b65\u7ba1\u7406\u9019\u4e9b\u60c5\u6cc1\u3002</li> </ul>"},{"location":"concepts/pipeline-overview/#7","title":"7. \u5e38\u898b\u9677\u9631\u8207\u6700\u4f73\u5be6\u8e10","text":"<p>\u70ba\u4e86\u5145\u5206\u5229\u7528 Pipeline \u7684\u5f37\u5927\u529f\u80fd\u4e26\u907f\u514d\u5e38\u898b\u554f\u984c\uff0c\u8acb\u8003\u616e\u4ee5\u4e0b\u5e7e\u9ede\uff1a</p> <ul> <li> <p>\u907f\u514d\u5728 <code>handle_data</code> \u4e2d\u91cd\u8907\u8a08\u7b97\u56e0\u5b50\uff1a     Pipeline \u7684\u4e3b\u8981\u76ee\u7684\u5c31\u662f\u5c07\u56e0\u5b50\u8a08\u7b97\u5f9e <code>handle_data</code> \u4e2d\u5206\u96e2\u51fa\u4f86\u4e26\u9032\u884c\u512a\u5316\u3002\u5728 <code>handle_data</code> \u4e2d\u76f4\u63a5\u9032\u884c\u8907\u96dc\u7684\u6b77\u53f2\u6578\u64da\u8a08\u7b97\u6703\u5c0e\u81f4\u56b4\u91cd\u7684\u6027\u80fd\u554f\u984c\u548c\u6f5b\u5728\u7684\u5411\u524d\u770b\u504f\u8aa4\u3002</p> </li> <li> <p>\u7406\u89e3 <code>window_length</code> \u7684\u542b\u7fa9\uff1a     <code>window_length</code> \u53c3\u6578\u5b9a\u7fa9\u4e86\u56e0\u5b50\u8a08\u7b97\u6240\u9700\u7684\u6b77\u53f2\u6578\u64da\u7a97\u53e3\u3002\u8acb\u78ba\u4fdd\u60a8\u7406\u89e3\u5176\u8a08\u7b97\u65b9\u5f0f\uff08\u901a\u5e38\u662f\u5305\u542b\u7576\u524d\u65e5\u4e4b\u524d\u7684 N \u500b\u4ea4\u6613\u65e5\uff09\uff0c\u4ee5\u907f\u514d\u5f15\u5165\u5411\u524d\u770b\u504f\u8aa4\u3002</p> </li> <li> <p>\u5584\u7528 <code>mask</code> \u53c3\u6578\u9032\u884c\u7be9\u9078\uff1a     \u5728 Pipeline \u4e2d\u4f7f\u7528 <code>mask</code> \u53c3\u6578\u53ef\u4ee5\u6709\u6548\u5730\u9650\u5236\u8a08\u7b97\u7bc4\u570d\uff0c\u53ea\u5c0d\u60a8\u611f\u8208\u8da3\u7684\u8cc7\u7522\u9032\u884c\u56e0\u5b50\u8a08\u7b97\uff0c\u9032\u4e00\u6b65\u63d0\u5347\u6548\u7387\u3002</p> </li> <li> <p>\u9010\u6b65\u69cb\u5efa\u8907\u96dc Pipeline\uff1a     \u5c0d\u65bc\u8907\u96dc\u7684\u7b56\u7565\uff0c\u5efa\u8b70\u5f9e\u7c21\u55ae\u7684 Pipeline \u958b\u59cb\uff0c\u9010\u6b65\u6dfb\u52a0 Factors\u3001Filters \u548c Classifiers\uff0c\u4e26\u5728\u6bcf\u500b\u968e\u6bb5\u9a57\u8b49\u8f38\u51fa\uff0c\u4ee5\u78ba\u4fdd\u908f\u8f2f\u6b63\u78ba\u3002</p> </li> </ul>"},{"location":"concepts/pipeline-overview/#_2","title":"\u7e3d\u7d50","text":"<p>Zipline Pipeline \u662f TQuant Lab \u4e2d\u7528\u65bc\u9ad8\u6548\u751f\u6210\u6295\u8cc7\u8a0a\u865f\u7684\u57fa\u77f3\u3002\u900f\u904e\u7406\u89e3\u5176\u6838\u5fc3\u7d44\u4ef6\u3001\u8cc7\u6599\u96c6\u548c\u904b\u4f5c\u6d41\u7a0b\uff0c\u4e26\u9075\u5faa\u6700\u4f73\u5be6\u8e10\uff0c\u60a8\u53ef\u4ee5\u69cb\u5efa\u51fa\u5f37\u5927\u3001\u9ad8\u6548\u4e14\u53ef\u64f4\u5c55\u7684\u91cf\u5316\u4ea4\u6613\u7b56\u7565\u3002\u719f\u7df4\u638c\u63e1 Pipeline \u7684\u4f7f\u7528\uff0c\u5c07\u6975\u5927\u5730\u63d0\u5347\u60a8\u7684\u7b56\u7565\u7814\u7a76\u80fd\u529b\u3002</p> <p>\u8a73\u898b\uff1a\u5167\u5efa\u56e0\u5b50/\u6ffe\u7db2/\u5206\u985e\u5668</p>"},{"location":"concepts/pyfolio-overview/","title":"Pyfolio \u7e3e\u6548\u5206\u6790\u6982\u8ad6","text":"<p>Info</p> <p>\u672c\u9801\u4ecb\u7d39 TQuant Lab \u4e2d\u6574\u5408\u7684\u5f37\u5927\u7e3e\u6548\u5206\u6790\u5de5\u5177 Pyfolio\uff0c\u5167\u5bb9\u6db5\u84cb\u5176\u6838\u5fc3\u529f\u80fd\u3001\u5982\u4f55\u5f9e Zipline \u56de\u6e2c\u7d50\u679c\u751f\u6210\u8996\u89ba\u5316\u7684\u7e3e\u6548\u5831\u544a (Tear Sheet)\uff0c\u4ee5\u53ca\u5982\u4f55\u89e3\u8b80\u5831\u544a\u4e2d\u7684\u95dc\u9375\u6307\u6a19\u8207\u5716\u8868\uff0c\u5e6b\u52a9\u60a8\u6df1\u5165\u8a55\u4f30\u7b56\u7565\u7684\u8868\u73fe\u3002</p> <p>\u5728\u91cf\u5316\u7814\u7a76\u6d41\u7a0b\u4e2d\uff0c\u50c5\u6709\u56de\u6e2c\u7d50\u679c\u7684\u539f\u59cb\u6578\u64da\u662f\u4e0d\u5920\u7684\u3002\u4e00\u500b\u5c08\u696d\u7684\u91cf\u5316\u7814\u7a76\u8005\u9700\u8981\u4e00\u5957\u6a19\u6e96\u5316\u3001\u7cfb\u7d71\u5316\u7684\u5de5\u5177\u4f86\u8a55\u4f30\u7b56\u7565\u7684\u98a8\u96aa\u8207\u5831\u916c\u3002Pyfolio \u6b63\u662f\u70ba\u6b64\u800c\u751f\u7684 Python \u5957\u4ef6\uff0c\u5b83\u80fd\u5c07 Zipline \u7684\u56de\u6e2c\u7d50\u679c\u8f49\u63db\u70ba\u4e00\u4efd\u5305\u542b\u6578\u5341\u7a2e\u95dc\u9375\u6307\u6a19\u548c\u8996\u89ba\u5316\u5716\u8868\u7684\u5c08\u696d\u5831\u544a\uff0c\u7a31\u70ba\u300cTear Sheet\u300d\u3002</p>"},{"location":"concepts/pyfolio-overview/#1-pyfolio","title":"1. Pyfolio \u7684\u6838\u5fc3\u4f5c\u7528","text":"<p>Pyfolio \u662f TQuant Lab \u5206\u6790\u6d41\u7a0b\u4e2d\u7684\u95dc\u9375\u4e00\u74b0\uff0c\u5b83\u626e\u6f14\u8457\u300c\u7b56\u7565\u5065\u6aa2\u5831\u544a\u300d\u7684\u89d2\u8272\uff0c\u4e3b\u8981\u63d0\u4f9b\u4ee5\u4e0b\u529f\u80fd\uff1a</p> <ul> <li>\u6a19\u6e96\u5316\u7e3e\u6548\u6307\u6a19\uff1a\u81ea\u52d5\u8a08\u7b97\u590f\u666e\u6bd4\u7387 (Sharpe Ratio)\u3001\u6700\u5927\u56de\u64a4 (Max Drawdown)\u3001Alpha\u3001Beta \u7b49\u696d\u754c\u901a\u7528\u7684\u98a8\u96aa\u8207\u5831\u916c\u6307\u6a19\u3002</li> <li>\u8996\u89ba\u5316\u5206\u6790\uff1a\u63d0\u4f9b\u8c50\u5bcc\u7684\u5716\u8868\uff0c\u5982\u7d2f\u7a4d\u5831\u916c\u5716\u3001\u6c34\u4e0b\u5716\u3001\u6708\u5ea6\u5831\u916c\u5206\u4f48\u7b49\uff0c\u8b93\u60a8\u80fd\u76f4\u89c0\u5730\u8a55\u4f30\u7b56\u7565\u7684\u8868\u73fe\u7279\u5fb5\u3002</li> <li>\u8207 Zipline \u7121\u7e2b\u6574\u5408\uff1a\u63d0\u4f9b\u5de5\u5177\u51fd\u5f0f\uff0c\u53ef\u4ee5\u8f15\u9b06\u5730\u5c07 Zipline \u7684\u56de\u6e2c\u8f38\u51fa\u8f49\u63db\u70ba Pyfolio \u6240\u9700\u7684\u683c\u5f0f\u3002</li> </ul>"},{"location":"concepts/pyfolio-overview/#2-zipline-pyfolio","title":"2. \u5f9e Zipline \u5230 Pyfolio\uff1a\u6a19\u6e96\u5de5\u4f5c\u6d41\u7a0b","text":"<p>\u5728 TQuant Lab \u4e2d\uff0c\u4f7f\u7528 Pyfolio \u5206\u6790 Zipline \u56de\u6e2c\u7d50\u679c\u7684\u6d41\u7a0b\u975e\u5e38\u56fa\u5b9a\uff0c\u4e3b\u8981\u5206\u70ba\u4ee5\u4e0b\u4e09\u500b\u6b65\u9a5f\uff1a</p>"},{"location":"concepts/pyfolio-overview/#1-zipline","title":"\u6b65\u9a5f 1\uff1a\u57f7\u884c Zipline \u56de\u6e2c","text":"<p>\u9996\u5148\uff0c\u60a8\u9700\u8981\u50cf\u5f80\u5e38\u4e00\u6a23\u57f7\u884c\u60a8\u7684 Zipline \u7b56\u7565\uff0c\u4e26\u5c07\u7d50\u679c\u5132\u5b58\u5728\u4e00\u500b\u8b8a\u6578\u4e2d (\u901a\u5e38\u547d\u540d\u70ba <code>results</code>)\u3002</p> <pre><code>from zipline import run_algorithm\n\n# ... (\u60a8\u7684 initialize \u548c handle_data \u51fd\u6578\u5b9a\u7fa9) ...\n\nresults = run_algorithm(\n    # ... \u60a8\u7684 run_algorithm \u53c3\u6578 ...\n)\n</code></pre>"},{"location":"concepts/pyfolio-overview/#2-pyfolio","title":"\u6b65\u9a5f 2\uff1a\u63d0\u53d6 Pyfolio \u6240\u9700\u7684\u6578\u64da","text":"<p>Zipline \u7684 <code>results</code> DataFrame \u683c\u5f0f\u7121\u6cd5\u76f4\u63a5\u88ab Pyfolio \u4f7f\u7528\u3002\u60a8\u9700\u8981\u4f7f\u7528 <code>pyfolio.utils.extract_rets_pos_txn_from_zipline()</code> \u9019\u500b\u8f14\u52a9\u51fd\u5f0f\uff0c\u5c07 <code>results</code> \u8f49\u63db\u70ba Pyfolio \u6240\u9700\u7684\u4e09\u4e2a\u6838\u5fc3\u7269\u4ef6\uff1a</p> <ul> <li><code>returns</code> (pandas.Series)\uff1a\u6bcf\u65e5\u7684\u7b56\u7565\u5831\u916c\u7387\u3002</li> <li><code>positions</code> (pandas.DataFrame)\uff1a\u6bcf\u65e5\u7684\u6301\u5009\u72c0\u614b\u3002</li> <li><code>transactions</code> (pandas.DataFrame)\uff1a\u6240\u6709\u7684\u4ea4\u6613\u7d00\u9304\u3002</li> </ul> <pre><code>import pyfolio as pf\n\n# \u5f9e Zipline results \u4e2d\u63d0\u53d6 Pyfolio \u6240\u9700\u7684\u6578\u64da\nreturns, positions, transactions = pf.utils.extract_rets_pos_txn_from_zipline(results)\n</code></pre>"},{"location":"concepts/pyfolio-overview/#3","title":"\u6b65\u9a5f 3\uff1a\u751f\u6210\u7e3e\u6548\u5831\u544a","text":"<p>\u5b8c\u6210\u6578\u64da\u63d0\u53d6\u5f8c\uff0c\u60a8\u53ef\u4ee5\u6839\u64da\u9700\u6c42\u9078\u64c7\u751f\u6210\u5b8c\u6574\u7684\u8996\u89ba\u5316\u5831\u544a\uff0c\u6216\u50c5\u5feb\u901f\u67e5\u770b\u7d71\u8a08\u6578\u64da\u3002</p>"},{"location":"concepts/pyfolio-overview/#a-tear-sheet","title":"\u9078\u9805 A\uff1a\u751f\u6210\u5b8c\u6574 Tear Sheet (\u5efa\u8b70)","text":"<p>\u8abf\u7528 <code>pyfolio.tears.create_full_tear_sheet()</code> \u51fd\u6578\uff0c\u53ef\u4ee5\u751f\u6210\u4e00\u4efd\u5305\u542b\u6240\u6709\u5716\u8868\u548c\u7d71\u8a08\u6578\u64da\u7684\u5b8c\u6574\u5831\u544a\u3002</p> <pre><code># \u7372\u53d6\u56de\u6e2c\u671f\u9593\u7684\u57fa\u6e96\u6307\u6578\u5831\u916c\nbenchmark_rets = results.benchmark_return\n\n# \u7522\u751f\u5b8c\u6574\u7684\u7e3e\u6548\u5206\u6790\u5831\u544a\npf.create_full_tear_sheet(\n    returns,\n    positions=positions,\n    transactions=transactions,\n    benchmark_rets=benchmark_rets, # \u50b3\u5165\u57fa\u6e96\u6307\u6578\u5831\u916c\u4ee5\u9032\u884c\u6bd4\u8f03\n    round_trips=False # \u5efa\u8b70\u8a2d\u70ba False \u4ee5\u52a0\u901f\u904b\u7b97\n)\n</code></pre>"},{"location":"concepts/pyfolio-overview/#b","title":"\u9078\u9805 B\uff1a\u50c5\u986f\u793a\u95dc\u9375\u7e3e\u6548\u7d71\u8a08","text":"<p>\u5982\u679c\u60a8\u53ea\u60f3\u5feb\u901f\u9810\u89bd\u6838\u5fc3\u7684\u7e3e\u6548\u6307\u6a19\uff0c\u800c\u4e0d\u9700\u8981\u751f\u6210\u6240\u6709\u5716\u8868\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>pyfolio.plotting.show_perf_stats()</code>\u3002\u9019\u500b\u65b9\u6cd5\u66f4\u8f15\u91cf\uff0c\u57f7\u884c\u901f\u5ea6\u66f4\u5feb\u3002</p> <pre><code># \u50c5\u986f\u793a\u95dc\u9375\u7e3e\u6548\u6307\u6a19\u8868\u683c\npf.show_perf_stats(returns, positions=positions, transactions=transactions)\n</code></pre>"},{"location":"concepts/pyfolio-overview/#3-tear-sheet","title":"3. \u89e3\u8b80 Tear Sheet \u95dc\u9375\u6307\u6a19","text":"<p>\u7121\u8ad6\u662f\u4f7f\u7528 <code>create_full_tear_sheet</code> \u9084\u662f <code>show_perf_stats</code>\uff0c\u60a8\u90fd\u6703\u770b\u5230\u4e00\u500b\u5305\u542b\u591a\u9805\u95dc\u9375\u7e3e\u6548\u6307\u6a19 (KPIs) \u7684\u8868\u683c\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u6700\u91cd\u8981\u7684\u6307\u6a19\uff1a</p> \u6307\u6a19 (Metric) \u8aaa\u660e Annual return \u5e74\u5316\u5831\u916c\u7387\uff1a\u7b56\u7565\u5728\u4e00\u5e74\u671f\u9593\u7684\u5e73\u5747\u5831\u916c\u7387\u3002 Cumulative returns \u7d2f\u7a4d\u5831\u916c\u7387\uff1a\u7b56\u7565\u5728\u6574\u500b\u56de\u6e2c\u671f\u9593\u7684\u7e3d\u5831\u916c\u7387\u3002 Annual volatility \u5e74\u5316\u6ce2\u52d5\u7387\uff1a\u7b56\u7565\u5831\u916c\u7387\u7684\u5e74\u5316\u6a19\u6e96\u5dee\uff0c\u8861\u91cf\u98a8\u96aa\u7684\u5e38\u7528\u6307\u6a19\u3002 Sharpe ratio \u590f\u666e\u6bd4\u7387\uff1a\u8861\u91cf\u6bcf\u55ae\u4f4d\u98a8\u96aa\u6240\u80fd\u63db\u53d6\u7684\u8d85\u984d\u5831\u916c\u3002\u6578\u503c\u8d8a\u9ad8\uff0c\u4ee3\u8868\u7b56\u7565\u7684\u98a8\u96aa\u8abf\u6574\u5f8c\u5831\u916c\u8d8a\u597d\u3002 Calmar ratio \u5361\u746a\u6bd4\u7387\uff1a\u5e74\u5316\u5831\u916c\u7387\u8207\u6700\u5927\u56de\u64a4\u7684\u6bd4\u503c\uff0c\u8861\u91cf\u7b56\u7565\u627f\u53d7\u6700\u5927\u98a8\u96aa\u6642\u7684\u56de\u5831\u80fd\u529b\u3002 Max drawdown \u6700\u5927\u56de\u64a4\uff1a\u7b56\u7565\u5728\u56de\u6e2c\u671f\u9593\u5167\uff0c\u6de8\u503c\u5f9e\u6700\u9ad8\u9ede\u56de\u843d\u5230\u6700\u4f4e\u9ede\u7684\u6700\u5927\u5e45\u5ea6\u3002\u9019\u662f\u8861\u91cf\u7b56\u7565\u98a8\u96aa\u7684\u91cd\u8981\u6307\u6a19\u3002 Alpha Alpha (\u03b1)\uff1a\u76f8\u5c0d\u65bc\u57fa\u6e96\u6307\u6578\u7684\u8d85\u984d\u5831\u916c\u3002\u6b63\u7684 Alpha \u4ee3\u8868\u7b56\u7565\u8868\u73fe\u512a\u65bc\u5e02\u5834\u3002 Beta Beta (\u03b2)\uff1a\u7b56\u7565\u76f8\u5c0d\u65bc\u57fa\u6e96\u6307\u6578\u7684\u7cfb\u7d71\u6027\u98a8\u96aa\u3002Beta \u70ba 1 \u8868\u793a\u7b56\u7565\u8207\u5e02\u5834\u540c\u6b65\u6ce2\u52d5\u3002"},{"location":"concepts/pyfolio-overview/#4-tear-sheet","title":"4. \u89e3\u8b80 Tear Sheet \u95dc\u9375\u5716\u8868","text":"<p><code>create_full_tear_sheet</code> \u7522\u751f\u7684\u8996\u89ba\u5316\u5716\u8868\u63d0\u4f9b\u4e86\u66f4\u76f4\u89c0\u7684\u6d1e\u5bdf\u3002</p> <ul> <li> <p>\u7d2f\u7a4d\u5831\u916c\u5716 (Cumulative returns)     \u9019\u662f\u6700\u91cd\u8981\u7684\u5716\u8868\u4e4b\u4e00\uff0c\u5b83\u5c07\u7b56\u7565\u7684\u7d2f\u7a4d\u5831\u916c\u8207\u57fa\u6e96\u6307\u6578\u7684\u7d2f\u7a4d\u5831\u916c\u7e6a\u88fd\u5728\u4e00\u8d77\uff0c\u8b93\u60a8\u80fd\u4e00\u76ee\u4e86\u7136\u5730\u770b\u51fa\u7b56\u7565\u5728\u4e0d\u540c\u6642\u9593\u6bb5\u7684\u8868\u73fe\u662f\u512a\u65bc\u9084\u662f\u52a3\u65bc\u5e02\u5834\u3002</p> </li> <li> <p>\u6c34\u4e0b\u5716 (Underwater plot / Drawdown plot)     \u6b64\u5716\u986f\u793a\u4e86\u7b56\u7565\u6de8\u503c\u5f9e\u6b77\u53f2\u9ad8\u9ede\u56de\u64a4\u7684\u767e\u5206\u6bd4\u3002\u5716\u4e2d\u66f2\u7dda\u5728 0 \u8ef8\u4ee5\u4e0b\u7684\u5340\u57df\u4ee3\u8868\u7b56\u7565\u8655\u65bc\u8667\u640d\u72c0\u614b\u3002\u6b64\u5716\u80fd\u5e6b\u52a9\u60a8\u76f4\u89c0\u5730\u611f\u53d7\u7b56\u7565\u53ef\u80fd\u9762\u81e8\u7684\u6700\u5927\u8667\u640d\u5e45\u5ea6\u548c\u6301\u7e8c\u6642\u9593\u3002</p> </li> <li> <p>\u6efe\u52d5 Beta / Alpha (Rolling Beta / Alpha)     \u9019\u4e9b\u5716\u8868\u986f\u793a\u4e86\u7b56\u7565\u7684 Alpha \u548c Beta \u5728\u4e0d\u540c\u6642\u9593\u7a97\u53e3\uff08\u4f8b\u5982 6 \u500b\u6708\uff09\u5167\u7684\u8b8a\u5316\u60c5\u6cc1\uff0c\u6709\u52a9\u65bc\u5224\u65b7\u7b56\u7565\u7684\u98a8\u683c\u662f\u5426\u7a69\u5b9a\u3002</p> </li> <li> <p>\u6708\u5ea6\u5831\u916c\u7387\u5206\u4f48\u5716 (Monthly returns distribution)     \u6b64\u5716\u901a\u5e38\u4ee5 \u71b1\u529b\u5716 (Heatmap) \u7684\u5f62\u5f0f\u5448\u73fe\uff0c\u5c07\u6bcf\u500b\u6708\u4efd\u7684\u5831\u916c\u7387\u7528\u984f\u8272\u6df1\u6dfa\u8868\u793a\uff08\u7da0\u8272\u70ba\u6b63\uff0c\u7d05\u8272\u70ba\u8ca0\uff09\uff0c\u8b93\u60a8\u53ef\u4ee5\u5feb\u901f\u8b58\u5225\u7b56\u7565\u5728\u54ea\u500b\u6708\u4efd\u6216\u5e74\u4efd\u8868\u73fe\u8f03\u597d\u6216\u8f03\u5dee\uff0c\u5f9e\u800c\u767c\u73fe\u6f5b\u5728\u7684\u5b63\u7bc0\u6027\u6548\u61c9\u3002</p> </li> </ul>"},{"location":"concepts/pyfolio-overview/#5","title":"5. \u5e38\u898b\u554f\u984c\u8207\u89e3\u6c7a\u65b9\u6848","text":""},{"location":"concepts/pyfolio-overview/#extract_rets_pos_txn_from_zipline","title":"extract_rets_pos_txn_from_zipline \u57f7\u884c\u5931\u6557","text":"<p>\u5728\u6975\u5c11\u6578\u60c5\u6cc1\u4e0b\uff08\u4f8b\u5982\u56de\u6e2c\u6642\u9593\u904e\u77ed\u6216\u6c92\u6709\u4efb\u4f55\u4ea4\u6613\uff09\uff0c<code>extract_rets_pos_txn_from_zipline</code> \u53ef\u80fd\u6703\u56e0\u70ba\u7121\u6cd5\u63d0\u53d6\u6709\u6548\u7684\u4ea4\u6613\u6578\u64da\u800c\u57f7\u884c\u5931\u6557\u3002\u70ba\u4e86\u589e\u5f37\u7a0b\u5f0f\u78bc\u7684\u7a69\u5065\u6027\uff0c\u5efa\u8b70\u4f7f\u7528 <code>try-except</code> \u5340\u584a\u4f86\u8655\u7406\u9019\u7a2e\u7570\u5e38\u60c5\u6cc1\u3002</p> <p>\u5099\u7528\u65b9\u6848\uff1a\u5982\u679c\u63d0\u53d6\u5931\u6557\uff0c\u60a8\u53ef\u4ee5\u9000\u800c\u6c42\u5176\u6b21\uff0c\u50c5\u5206\u6790\u7b56\u7565\u7684\u7e3d\u5831\u916c\u7387 (<code>algorithm_period_return</code>)\u3002</p> <pre><code>import pyfolio as pf\n\ntry:\n    # \u5617\u8a66\u6b63\u5e38\u63d0\u53d6\u6578\u64da\n    returns, positions, transactions = pf.utils.extract_rets_pos_txn_from_zipline(results)\nexcept Exception as e:\n    print(f\"\u5f9e Zipline \u7d50\u679c\u4e2d\u63d0\u53d6\u6578\u64da\u6642\u767c\u751f\u932f\u8aa4: {e}\")\n    # \u5982\u679c\u5931\u6557\uff0c\u5247\u4f7f\u7528\u5099\u7528\u65b9\u6848\uff0c\u50c5\u7372\u53d6\u7e3d\u5831\u916c\u7387\n    returns = results.get('algorithm_period_return', None)\n    positions = None\n    transactions = None\n\n# \u5373\u4f7f\u63d0\u53d6\u5931\u6557\uff0c\u4ecd\u7136\u53ef\u4ee5\u5206\u6790\u7e3d\u5831\u916c\u7387\nif returns is not None:\n    pf.create_returns_tear_sheet(returns, benchmark_rets=results.benchmark_return)\nelse:\n    print(\"\u7121\u6cd5\u7372\u53d6\u4efb\u4f55\u6709\u6548\u7684\u5831\u916c\u6578\u64da\u9032\u884c\u5206\u6790\u3002\")\n</code></pre>"},{"location":"concepts/pyfolio-overview/#_1","title":"\u7e3d\u7d50","text":"<p>Pyfolio \u662f\u91cf\u5316\u7814\u7a76\u4e2d\u4e0d\u53ef\u6216\u7f3a\u7684\u7e3e\u6548\u5206\u6790\u5de5\u5177\u3002\u5b83\u5c07\u8907\u96dc\u7684\u98a8\u96aa\u5831\u916c\u6307\u6a19\u548c\u7b56\u7565\u8868\u73fe\u7279\u5fb5\uff0c\u4ee5\u6a19\u6e96\u5316\u3001\u8996\u89ba\u5316\u7684\u65b9\u5f0f\u5448\u73fe\u51fa\u4f86\uff0c\u5e6b\u52a9\u7814\u7a76\u8005\u5feb\u901f\u3001\u6e96\u78ba\u5730\u8a55\u4f30\u7b56\u7565\u7684\u512a\u52a3\u3002\u5728 TQuant Lab \u4e2d\uff0c\u719f\u7df4\u904b\u7528 <code>create_full_tear_sheet</code> \u548c <code>show_perf_stats</code>\uff0c\u4e26\u4e86\u89e3\u5982\u4f55\u8655\u7406\u6f5b\u5728\u7684\u6578\u64da\u63d0\u53d6\u554f\u984c\uff0c\u662f\u5f9e\u7b56\u7565\u958b\u767c\u9081\u5411\u7b56\u7565\u512a\u5316\u7684\u95dc\u9375\u4e00\u6b65\u3002</p>"},{"location":"concepts/workflow/","title":"TQuant Lab \u5206\u6790\u6d41\u7a0b","text":"<p>Info</p> <p>\u672c\u9801\u5b8f\u89c0\u5730\u4ecb\u7d39 TQuant Lab \u7684\u6838\u5fc3\u5206\u6790\u6d41\u7a0b\uff0c\u5f9e\u8cc7\u6599\u7372\u53d6\u3001\u7b56\u7565\u767c\u60f3\u3001\u56de\u6e2c\u57f7\u884c\u5230\u7e3e\u6548\u5206\u6790\uff0c\u70ba\u4f7f\u7528\u8005\u5efa\u7acb\u4e00\u500b\u6574\u9ad4\u7684\u6982\u5ff5\u6846\u67b6\u3002</p> <p>TQuant Lab \u627f\u8972\u4e86 Quantopian \u7684\u6838\u5fc3\u67b6\u69cb\uff0c\u63d0\u4f9b\u4e00\u500b\u5f9e\u7b56\u7565\u7814\u7a76\u3001\u56de\u6e2c\u5230\u7e3e\u6548\u5206\u6790\u7684\u5b8c\u6574\u91cf\u5316\u4ea4\u6613\u6d41\u7a0b\u3002\u6574\u500b\u5de5\u4f5c\u6d41\u7a0b\u53ef\u4ee5\u88ab\u62c6\u89e3\u70ba\u56db\u5927\u6838\u5fc3\u6b65\u9a5f\uff0c\u6bcf\u500b\u6b65\u9a5f\u74b0\u74b0\u76f8\u6263\uff0c\u69cb\u6210\u4e00\u500b\u9ad8\u6548\u7684\u7814\u7a76\u5faa\u74b0\u3002</p>"},{"location":"concepts/workflow/#1","title":"1. \u6838\u5fc3\u56db\u5927\u6d41\u7a0b","text":"<pre><code>graph TD\n    A[1. \u8cc7\u6599\u6e96\u5099\u8207\u8f09\u5165] --&gt; B[2. \u7b56\u7565\u5efa\u69cb\u8207\u56de\u6e2c];\n    B --&gt; C[3. \u7e3e\u6548\u8207\u98a8\u96aa\u5206\u6790];\n    C --&gt; D{4. \u7b56\u7565\u512a\u5316\u8207\u8fed\u4ee3};\n    D --&gt; B;\n\n    subgraph \"Zipline \u5f15\u64ce\"\n        B\n    end\n\n    subgraph \"Pyfolio &amp; Alphalens\"\n        C\n    end</code></pre>"},{"location":"concepts/workflow/#1-data-preparation","title":"1. \u8cc7\u6599\u6e96\u5099\u8207\u8f09\u5165 (Data Preparation)","text":"<p>\u5728\u4efb\u4f55\u91cf\u5316\u5206\u6790\u958b\u59cb\u4e4b\u524d\uff0c\u9996\u8981\u4efb\u52d9\u662f\u6e96\u5099\u4e7e\u6de8\u4e14\u6e96\u78ba\u7684\u8cc7\u6599\u3002TQuant Lab \u900f\u904e <code>zipline ingest</code> \u6307\u4ee4\u5c07\u8cc7\u6599\u8f09\u5165\u5230 Zipline Bundle \u4e2d\uff0c\u4f9b\u56de\u6e2c\u5f15\u64ce\u4f7f\u7528\u3002</p> <ul> <li> <p>\u5b9a\u7fa9\u80a1\u7968\u6c60 (<code>get_universe</code>) \uff1a     \u9996\u5148\uff0c\u60a8\u9700\u8981\u5b9a\u7fa9\u56de\u6e2c\u7684\u6a19\u7684\u7bc4\u570d\uff0c\u4f8b\u5982\u53f0\u7063 50 \u6307\u6578\u6210\u5206\u80a1\u3001\u7279\u5b9a\u7522\u696d\u985e\u80a1\uff0c\u6216\u662f\u60a8\u81ea\u8a02\u7684\u80a1\u7968\u5217\u8868\u3002</p> </li> <li> <p>\u8cc7\u6599\u64f7\u53d6 (<code>zipline ingest</code>) \uff1a     \u4f7f\u7528 <code>zipline ingest</code> \u6307\u4ee4\uff0cTQuant Lab \u6703\u81ea\u52d5\u5f9e TEJ API \u4e0b\u8f09\u60a8\u6240\u9700\u7684\u50f9\u91cf\u3001\u57fa\u672c\u9762\u3001\u6216\u53e6\u985e\u8cc7\u6599\uff0c\u4e26\u5c07\u5176\u8f49\u63db\u70ba Zipline \u9ad8\u6548\u80fd\u7684 bcolz \u683c\u5f0f\u3002\u9019\u500b\u904e\u7a0b\u78ba\u4fdd\u4e86\u56de\u6e2c\u6642\u80fd\u5feb\u901f\u8b80\u53d6\u6578\u64da\u3002</p> </li> <li> <p>\u591a\u8cc7\u6599\u985e\u578b\u652f\u63f4 \uff1a     \u9664\u80a1\u7968\u50f9\u91cf\u5916\uff0cTQuant Lab \u652f\u63f4\u57fa\u672c\u9762\u8cc7\u6599\u3001\u671f\u8ca8\u3001ETF \u7b49\u3002\u6839\u64da\u60a8\u7684\u7b56\u7565\u9700\u6c42\u9078\u64c7\u5c0d\u61c9\u7684\u8cc7\u6599 bundle\u3002</p> </li> </ul> <p>\u8a73\u898b\uff1a\u5982\u4f55 Ingest \u80a1\u7968\u50f9\u91cf\u8cc7\u6599</p>"},{"location":"concepts/workflow/#2-strategy-backtest","title":"2. \u7b56\u7565\u5efa\u69cb\u8207\u56de\u6e2c (Strategy &amp; Backtest)","text":"<p>\u9019\u662f\u91cf\u5316\u7814\u7a76\u7684\u6838\u5fc3\u3002\u60a8\u5c07\u5728\u9019\u88e1\u628a\u4ea4\u6613\u601d\u60f3\u8f49\u5316\u70ba\u5177\u9ad4\u7684\u7a0b\u5f0f\u78bc\uff0c\u4e26\u5728\u6b77\u53f2\u8cc7\u6599\u4e0a\u9a57\u8b49\u5176\u6709\u6548\u6027\u3002\u6b64\u968e\u6bb5\u4e3b\u8981\u5728 Zipline \u5f15\u64ce\u4e2d\u5b8c\u6210\u3002</p> <ul> <li> <p>Pipeline API - \u8a0a\u865f\u751f\u6210 \uff1a     Pipeline \u662f\u4e00\u500b\u5f37\u5927\u7684 API\uff0c\u7528\u65bc\u9ad8\u6548\u5730\u8a08\u7b97\u3001\u904e\u6ffe\u548c\u7be9\u9078\u5927\u91cf\u7684\u8b49\u5238\u8cc7\u6599\u3002\u60a8\u53ef\u4ee5\u900f\u904e\u7d44\u5408\u5167\u5efa\u6216\u81ea\u8a02\u7684\u56e0\u5b50 (Factors)\u3001\u6ffe\u7db2 (Filters) \u548c\u5206\u985e\u5668 (Classifiers) \u4f86\u7522\u751f\u6bcf\u65e5\u7684\u4ea4\u6613\u8a0a\u865f\u3002</p> </li> <li> <p>\u6838\u5fc3\u56de\u6e2c\u51fd\u6578 (<code>initialize</code> &amp; <code>handle_data</code>) \uff1a</p> <ul> <li><code>initialize(context)</code>\uff1a\u6b64\u51fd\u6578\u5728\u56de\u6e2c\u958b\u59cb\u6642 \u50c5\u57f7\u884c\u4e00\u6b21 \uff0c\u7528\u65bc\u8a2d\u5b9a\u521d\u59cb\u53c3\u6578\uff0c\u4f8b\u5982\u521d\u59cb\u8cc7\u91d1\u3001\u624b\u7e8c\u8cbb/\u6ed1\u50f9\u6a21\u578b\u3001\u4ee5\u53ca\u8a3b\u518a Pipeline\u3002</li> <li><code>handle_data(context, data)</code>\uff1a\u6b64\u51fd\u6578\u662f\u7b56\u7565\u7684\u5fc3\u81df\uff0c\u5b83\u6703\u5728\u6bcf\u500b\u4ea4\u6613\u65e5 \u76e4\u4e2d \u88ab\u8abf\u7528\u3002\u60a8\u5c07\u5728\u6b64\u8655\u7372\u53d6 Pipeline \u7684\u8a08\u7b97\u7d50\u679c\uff0c\u4e26\u6839\u64da\u4ea4\u6613\u908f\u8f2f\u57f7\u884c\u4e0b\u55ae\u6307\u4ee4 (<code>order_target_percent</code>, <code>order</code>, etc.)\u3002</li> </ul> </li> <li> <p>\u57f7\u884c\u56de\u6e2c (<code>run_algorithm</code>) \uff1a     \u8a2d\u5b9a\u597d\u56de\u6e2c\u7684\u8d77\u59cb/\u7d50\u675f\u65e5\u671f\u3001\u521d\u59cb\u8cc7\u91d1\u7b49\u53c3\u6578\u5f8c\uff0c<code>run_algorithm</code> \u51fd\u6578\u5c07\u6703\u555f\u52d5 Zipline \u5f15\u64ce\uff0c\u9010\u65e5\u6a21\u64ec\u60a8\u7684\u4ea4\u6613\u7b56\u7565\uff0c\u4e26\u8a18\u9304\u4e0b\u6bcf\u65e5\u7684\u6295\u8cc7\u7d44\u5408\u72c0\u614b\u3001\u4ea4\u6613\u7d00\u9304\u7b49\u8a73\u7d30\u8cc7\u8a0a\u3002</p> </li> </ul>"},{"location":"concepts/workflow/#_1","title":"\u9032\u968e\u6982\u5ff5\uff1a\u624b\u7e8c\u8cbb\u8207\u6ed1\u50f9\u6a21\u578b","text":"<p>\u5728\u5be6\u969b\u4ea4\u6613\u4e2d\uff0c\u624b\u7e8c\u8cbb\u548c\u6ed1\u50f9\u662f\u91cd\u8981\u7684\u6210\u672c\u56e0\u5b50\u3002\u900f\u904e <code>set_commission()</code> \u548c <code>set_slippage()</code> \u51fd\u6578\uff0c\u60a8\u53ef\u4ee5\u7cbe\u78ba\u6a21\u64ec\u4ea4\u6613\u6210\u672c\uff0c\u4f7f\u56de\u6e2c\u7d50\u679c\u66f4\u8cbc\u8fd1\u73fe\u5be6\u3002</p>"},{"location":"concepts/workflow/#_2","title":"\u9032\u968e\u6982\u5ff5\uff1a\u671f\u8ca8\u8207\u9023\u7e8c\u5408\u7d04","text":"<p>\u5c0d\u65bc\u671f\u8ca8\u4ea4\u6613\uff0cTQuant Lab \u63d0\u4f9b\u4e86 <code>continuous_future()</code> API \u4f86\u7372\u53d6\u9023\u7e8c\u5408\u7d04\u7269\u4ef6\uff0c\u89e3\u6c7a\u4e86\u671f\u8ca8\u5408\u7d04\u5230\u671f\u63db\u6708\u7684\u8907\u96dc\u554f\u984c\uff0c\u8b93\u60a8\u53ef\u4ee5\u5c08\u6ce8\u65bc\u7b56\u7565\u908f\u8f2f\u672c\u8eab\u3002</p> <p>\u8a73\u898b\uff1aZipline \u5f15\u64ce\u6838\u5fc3\u6a5f\u5236</p>"},{"location":"concepts/workflow/#3-performance-risk-analysis","title":"3. \u7e3e\u6548\u8207\u98a8\u96aa\u5206\u6790 (Performance &amp; Risk Analysis)","text":"<p>\u56de\u6e2c\u5b8c\u6210\u5f8c\uff0c\u6703\u7522\u51fa\u4e00\u500b\u5305\u542b\u8a73\u7d30\u4ea4\u6613\u6b77\u53f2\u7684 <code>results</code> DataFrame\u3002\u63a5\u4e0b\u4f86\uff0c\u60a8\u9700\u8981\u4f7f\u7528\u5c08\u696d\u7684\u5de5\u5177\u4f86\u8a55\u4f30\u7b56\u7565\u7684\u8868\u73fe\u3002</p> <ul> <li> <p>Pyfolio \u8996\u89ba\u5316\u5831\u8868 \uff1a     Pyfolio \u662f Quantopian \u958b\u767c\u7684\u5c08\u696d\u7e3e\u6548\u5206\u6790\u5957\u4ef6\u3002\u53ea\u9700\u5c07 <code>results</code> \u50b3\u5165 <code>pyfolio.create_full_tear_sheet</code> \u51fd\u6578\uff0c\u5373\u53ef\u81ea\u52d5\u751f\u6210\u5305\u542b\u7d2f\u8a08\u5831\u916c\u3001\u590f\u666e\u6bd4\u7387 (Sharpe Ratio)\u3001\u6700\u5927\u56de\u64a4 (Max Drawdown)\u3001\u98a8\u96aa\u56e0\u5b50\u5206\u6790 (Alpha, Beta) \u7b49\u6578\u5341\u7a2e\u95dc\u9375\u6307\u6a19\u7684\u8996\u89ba\u5316\u5831\u544a\u3002</p> </li> <li> <p>Alphalens \u56e0\u5b50\u5206\u6790 \uff1a     \u5982\u679c\u60a8\u60f3\u6df1\u5165\u8a55\u4f30 Pipeline \u4e2d\u7279\u5b9a\u56e0\u5b50\u7684\u6709\u6548\u6027\uff0cAlphalens \u53ef\u4ee5\u5e6b\u52a9\u60a8\u5206\u6790\u56e0\u5b50\u7684\u9810\u6e2c\u80fd\u529b (Information Coefficient)\u3001\u5831\u916c\u5206\u4f48\u3001\u4ee5\u53ca\u63db\u624b\u7387\u7b49\uff0c\u5f9e\u800c\u5224\u65b7\u60a8\u7684 Alpha \u4f86\u6e90\u662f\u5426\u7a69\u5065\u3002</p> </li> </ul> <p>\u8a73\u898b\uff1aPyfolio \u7e3e\u6548\u5206\u6790\u6982\u8ad6 \u8a73\u898b\uff1aAlphalens \u56e0\u5b50\u5206\u6790\u6982\u8ad6</p>"},{"location":"concepts/workflow/#4-optimization-iteration","title":"4. \u7b56\u7565\u512a\u5316\u8207\u8fed\u4ee3 (Optimization &amp; Iteration)","text":"<p>\u91cf\u5316\u7814\u7a76\u662f\u4e00\u500b\u4e0d\u65b7\u8fed\u4ee3\u7684\u904e\u7a0b\u3002\u6839\u64da\u7e3e\u6548\u5206\u6790\u5831\u544a\u7684\u7d50\u679c\uff0c\u60a8\u53ef\u80fd\u6703\u767c\u73fe\u7b56\u7565\u7684\u4e0d\u8db3\u4e4b\u8655\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u4ea4\u6613\u6210\u672c\u904e\u9ad8\uff0c\u9700\u8981\u8abf\u6574\u63db\u624b\u7387\u3002</li> <li>\u5728\u7279\u5b9a\u5e02\u5834\u98a8\u683c\u4e0b\u8868\u73fe\u4e0d\u4f73\uff0c\u9700\u8981\u52a0\u5165\u65b0\u7684\u56e0\u5b50\u3002</li> <li>\u6700\u5927\u56de\u64a4\u904e\u5927\uff0c\u9700\u8981\u6539\u9032\u98a8\u96aa\u63a7\u5236\u6a5f\u5236\u3002</li> </ul> <p>\u57fa\u65bc\u9019\u4e9b\u6d1e\u898b\uff0c\u60a8\u53ef\u4ee5\u56de\u5230 \u6b65\u9a5f 2 \uff0c\u8abf\u6574\u60a8\u7684 Pipeline \u56e0\u5b50\u6216 <code>handle_data</code> \u4e2d\u7684\u4ea4\u6613\u908f\u8f2f\uff0c\u7136\u5f8c\u91cd\u65b0\u57f7\u884c\u56de\u6e2c\u8207\u5206\u6790\uff0c\u5f62\u6210\u4e00\u500b\u5b8c\u6574\u7684\u7814\u7a76\u9589\u74b0\u3002</p>"},{"location":"concepts/workflow/#5-pitfalls-best-practices","title":"5. \u5e38\u898b\u9677\u9631\u8207\u6700\u4f73\u5be6\u8e10 (Pitfalls &amp; Best Practices)","text":"<p>\u5728\u91cf\u5316\u7814\u7a76\u7684\u9053\u8def\u4e0a\uff0c\u9b54\u9b3c\u5f80\u5f80\u85cf\u5728\u7d30\u7bc0\u88e1\u3002\u8acb\u7279\u5225\u7559\u610f\u4ee5\u4e0b\u5e38\u898b\u554f\u984c\uff1a</p> <p>\u81f4\u547d\u932f\u8aa4\uff1a\u5411\u524d\u770b\u504f\u8aa4 (Look-ahead Bias)</p> <p>\u9019\u662f\u6700\u5e38\u898b\u4e5f\u6700\u5371\u96aa\u7684\u932f\u8aa4\u3002\u78ba\u4fdd\u60a8\u7684\u7b56\u7565\u5728 T \u65e5\u505a\u6c7a\u7b56\u6642\uff0c\u7d55\u5c0d\u6c92\u6709 \u4f7f\u7528\u5230 T+1 \u65e5\u4ee5\u5f8c\u7684\u8cc7\u8a0a\uff08\u4f8b\u5982\uff1a\u5728\u9031\u4e00\u958b\u76e4\u6642\u5c31\u4f7f\u7528\u4e86\u9031\u4e00\u7684\u6536\u76e4\u50f9\uff09\u3002Zipline \u7684 Pipeline \u6a5f\u5236\u5df2\u5167\u5efa\u9632\u5446\uff0c\u4f46\u81ea\u8a02\u6578\u64da\u6642\u4ecd\u9700\u5c0f\u5fc3\u3002</p> <p>\u904e\u5ea6\u512a\u5316 (Overfitting)</p> <p>\u4e0d\u8981\u70ba\u4e86\u8b93\u56de\u6e2c\u66f2\u7dda\u8b8a\u6f02\u4eae\u800c\u904e\u5ea6\u8abf\u6574\u53c3\u6578\u3002\u4e00\u500b\u53c3\u6578\u7d44\u5728\u904e\u53bb 5 \u5e74\u8868\u73fe\u5b8c\u7f8e\uff0c\u5f80\u5f80\u610f\u5473\u8457\u5b83\u5728\u672a\u4f86\u6703\u8868\u73fe\u6975\u5dee\u3002\u8acb\u52d9\u5fc5\u9032\u884c \u6a23\u672c\u5916\u6e2c\u8a66 (Out-of-Sample Testing)\u3002</p> <p>\u4e0d\u53ef\u5ffd\u8996\u7684\u6210\u672c\uff1a\u6ed1\u50f9\u8207\u624b\u7e8c\u8cbb</p> <p>\u6c38\u9060\u4e0d\u8981\u5047\u8a2d\u4ea4\u6613\u662f\u514d\u8cbb\u7684\u3002\u5728 <code>initialize</code> \u4e2d\u52d9\u5fc5\u8a2d\u5b9a <code>set_commission</code> \u548c <code>set_slippage</code>\u3002</p> <ul> <li>\u624b\u7e8c\u8cbb\uff1a\u5f71\u97ff\u9ad8\u983b\u4ea4\u6613\u7b56\u7565\u7684\u5b58\u6d3b\u7387\u3002</li> <li>\u6ed1\u50f9\uff1a\u5f71\u97ff\u5927\u8cc7\u91d1\u7b56\u7565\u7684\u9032\u51fa\u6210\u672c\u3002</li> </ul>"},{"location":"concepts/zipline-engine/","title":"Zipline \u5f15\u64ce\u6838\u5fc3\u6a5f\u5236","text":"<p>Info</p> <p>\u672c\u9801\u6df1\u5165\u89e3\u91cb Zipline \u5f15\u64ce\u7684\u904b\u4f5c\u539f\u7406\uff0c\u5305\u62ec\u5176\u6838\u5fc3\u7d44\u4ef6\uff08\u5982 <code>initialize</code>, <code>handle_data</code>, <code>before_trading_start</code>\uff09\u3001\u4e8b\u4ef6\u9a45\u52d5\u6a21\u578b\u3001\u4ee5\u53ca\u8cc7\u6599\u8655\u7406\u6a5f\u5236\uff0c\u70ba\u4f7f\u7528\u8005\u5efa\u7acb\u5c0d Zipline \u5f15\u64ce\u7684\u5168\u9762\u7406\u89e3\u3002</p> <p>Zipline \u662f TQuant Lab \u7684\u6838\u5fc3\u56de\u6e2c\u5f15\u64ce\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u500b\u5f37\u5927\u4e14\u9748\u6d3b\u7684\u6846\u67b6\uff0c\u7528\u65bc\u6a21\u64ec\u80a1\u7968\u3001\u671f\u8ca8\u7b49\u91d1\u878d\u8cc7\u7522\u7684\u4ea4\u6613\u7b56\u7565\u3002Zipline \u7684\u8a2d\u8a08\u7406\u5ff5\u662f \u4e8b\u4ef6\u9a45\u52d5 (Event-Driven) \uff0c\u9019\u610f\u5473\u8457\u5b83\u6703\u6309\u7167\u6642\u9593\u9806\u5e8f\u8655\u7406\u5e02\u5834\u4e8b\u4ef6\uff08\u5982\u958b\u76e4\u3001\u6536\u76e4\u3001\u4ea4\u6613\u6578\u64da\u66f4\u65b0\uff09\uff0c\u4e26\u6839\u64da\u7b56\u7565\u908f\u8f2f\u57f7\u884c\u76f8\u61c9\u7684\u64cd\u4f5c\u3002</p>"},{"location":"concepts/zipline-engine/#1-zipline","title":"1. Zipline \u7c21\u4ecb","text":"<p>Zipline \u662f\u4e00\u500b\u7531 Quantopian \u958b\u6e90\u7684 Python \u51fd\u5f0f\u5eab\uff0c\u5c08\u70ba\u91cf\u5316\u4ea4\u6613\u7b56\u7565\u7684\u56de\u6e2c\u800c\u8a2d\u8a08\u3002\u5b83\u63d0\u4f9b\u4e86\u4e00\u5957\u5b8c\u6574\u7684\u5de5\u5177\uff0c\u8b93\u7814\u7a76\u8005\u80fd\u5920\uff1a</p> <ul> <li>\u6a21\u64ec\u771f\u5be6\u5e02\u5834\u74b0\u5883 \uff1a\u7cbe\u78ba\u91cd\u73fe\u6b77\u53f2\u5e02\u5834\u6578\u64da\uff0c\u5305\u62ec\u50f9\u683c\u3001\u6210\u4ea4\u91cf\u3001\u4ea4\u6613\u6210\u672c\u7b49\u3002</li> <li>\u5feb\u901f\u958b\u767c\u7b56\u7565 \uff1a\u900f\u904e\u7c21\u6f54\u7684 API \u64b0\u5beb\u4ea4\u6613\u908f\u8f2f\u3002</li> <li>\u9ad8\u6548\u57f7\u884c\u56de\u6e2c \uff1a\u512a\u5316\u5f8c\u7684\u6578\u64da\u7d50\u69cb\u548c\u4e8b\u4ef6\u8655\u7406\u6a5f\u5236\uff0c\u78ba\u4fdd\u56de\u6e2c\u6548\u7387\u3002</li> <li>\u6574\u5408\u5206\u6790\u5de5\u5177 \uff1a\u8207 Pyfolio \u7b49\u5de5\u5177\u7121\u7e2b\u6574\u5408\uff0c\u63d0\u4f9b\u8c50\u5bcc\u7684\u7e3e\u6548\u5206\u6790\u5831\u544a\u3002</li> </ul> <p>\u5728 TQuant Lab \u4e2d\uff0cZipline \u5f15\u64ce\u662f\u6240\u6709\u7b56\u7565\u56de\u6e2c\u7684\u57fa\u77f3\uff0c\u8ca0\u8cac\u8655\u7406\u8cc7\u6599\u6d41\u3001\u57f7\u884c\u4ea4\u6613\u6307\u4ee4\u3001\u7ba1\u7406\u6295\u8cc7\u7d44\u5408\u72c0\u614b\uff0c\u4e26\u6700\u7d42\u7522\u51fa\u8a73\u7d30\u7684\u56de\u6e2c\u7d50\u679c\u3002</p>"},{"location":"concepts/zipline-engine/#2","title":"2. \u4e8b\u4ef6\u9a45\u52d5\u6a21\u578b","text":"<p>Zipline \u7684\u4e8b\u4ef6\u9a45\u52d5\u6a21\u578b\u662f\u5176\u6838\u5fc3\u7279\u8272\u3002\u5b83\u4e0d\u662f\u7c21\u55ae\u5730\u904d\u6b77\u6642\u9593\u5e8f\u5217\u6578\u64da\uff0c\u800c\u662f\u6a21\u64ec\u5e02\u5834\u4e2d\u767c\u751f\u7684\u5404\u7a2e\u4e8b\u4ef6\uff0c\u4e26\u5728\u9019\u4e9b\u4e8b\u4ef6\u767c\u751f\u6642\u89f8\u767c\u7b56\u7565\u4e2d\u5b9a\u7fa9\u7684\u51fd\u6578\u3002\u9019\u4f7f\u5f97\u7b56\u7565\u80fd\u5920\u5c0d\u5e02\u5834\u8b8a\u5316\u505a\u51fa\u5373\u6642\u53cd\u61c9\uff0c\u66f4\u8cbc\u8fd1\u771f\u5be6\u4ea4\u6613\u3002</p> <pre><code>graph TD\n    Start[\u56de\u6e2c\u958b\u59cb] --&gt; Initialize(initialize\u51fd\u6578); \n    Initialize --&gt; LoopDay{\u6bcf\u65e5\u5faa\u74b0}; \n    LoopDay -- \u6bcf\u500b\u4ea4\u6613\u65e5\u958b\u59cb --&gt; BeforeTradingStart(before_trading_start\u51fd\u6578); \n    BeforeTradingStart --&gt; HandleData(handle_data\u51fd\u6578); \n    HandleData --&gt; EndDay{\u6bcf\u65e5\u7d50\u675f}; \n    EndDay -- \u9084\u6709\u4ea4\u6613\u65e5? --&gt; LoopDay; \n    LoopDay -- \u7121\u4ea4\u6613\u65e5 --&gt; Analyze(analyze\u51fd\u6578); \n    Analyze --&gt; End[\u56de\u6e2c\u7d50\u675f];\n\n    %% --- \u6a23\u5f0f\u5b9a\u7fa9\u5340 (\u6539\u70ba\u908a\u6846\u98a8\u683c) ---\n    %% \u958b\u59cb\u8207\u7d50\u675f\u7bc0\u9ede (\u4f7f\u7528\u8f03\u4eae\u7684\u9752\u8272\u908a\u6846\uff0c\u589e\u52a0\u6df1\u8272\u6a21\u5f0f\u5c0d\u6bd4\u5ea6)\n    style Start fill:none,stroke:#26a69a,stroke-width:2px,color:inherit\n    style End fill:none,stroke:#26a69a,stroke-width:2px,color:inherit\n\n    %% \u6838\u5fc3\u51fd\u6578\u7bc0\u9ede (\u4f7f\u7528\u8f03\u4eae\u7684\u85cd\u8272\u908a\u6846)\n    style Initialize fill:none,stroke:#42a5f5,stroke-width:2px,color:inherit\n    style BeforeTradingStart fill:none,stroke:#42a5f5,stroke-width:2px,color:inherit\n    style HandleData fill:none,stroke:#42a5f5,stroke-width:2px,color:inherit\n    style Analyze fill:none,stroke:#42a5f5,stroke-width:2px,color:inherit\n\n    %% \u6c7a\u7b56\u7bc0\u9ede (\u7dad\u6301\u9810\u8a2d\uff0c\u6216\u52a0\u4e0a\u4e00\u500b\u4e2d\u6027\u7070\u908a\u6846)\n    style LoopDay fill:none,stroke:#90a4ae,stroke-width:2px,stroke-dasharray: 5 5,color:inherit\n    style EndDay fill:none,stroke:#90a4ae,stroke-width:2px,stroke-dasharray: 5 5,color:inherit</code></pre>"},{"location":"concepts/zipline-engine/#3","title":"3. \u6838\u5fc3\u751f\u547d\u9031\u671f\u51fd\u6578","text":"<p>Zipline \u7b56\u7565\u4e3b\u8981\u7531\u4ee5\u4e0b\u5e7e\u500b\u751f\u547d\u9031\u671f\u51fd\u6578\u69cb\u6210\uff0c\u5b83\u5011\u5728\u56de\u6e2c\u7684\u4e0d\u540c\u968e\u6bb5\u88ab\u8abf\u7528\uff1a</p>"},{"location":"concepts/zipline-engine/#31-initializecontext","title":"3.1. initialize(context)","text":"<ul> <li>\u57f7\u884c\u6642\u6a5f \uff1a\u5728\u56de\u6e2c\u958b\u59cb\u6642 \u50c5\u57f7\u884c\u4e00\u6b21 \u3002</li> <li>\u4f5c\u7528 \uff1a\u7528\u65bc\u8a2d\u5b9a\u7b56\u7565\u7684\u521d\u59cb\u72c0\u614b\u548c\u53c3\u6578\uff0c\u4f8b\u5982\uff1a<ul> <li>\u5b9a\u7fa9\u521d\u59cb\u8cc7\u91d1 (<code>context.capital_base</code>)\u3002</li> <li>\u8a2d\u5b9a\u624b\u7e8c\u8cbb (<code>set_commission</code>) \u548c\u6ed1\u50f9 (<code>set_slippage</code>) \u6a21\u578b\u3002</li> <li>\u8a3b\u518a Pipeline (<code>attach_pipeline</code>)\u3002</li> <li>\u8a2d\u5b9a\u57fa\u6e96\u6307\u6578 (<code>set_benchmark</code>)\u3002</li> <li>\u521d\u59cb\u5316\u7b56\u7565\u6240\u9700\u7684\u8b8a\u6578 (<code>context.my_variable = ...</code>)\u3002</li> </ul> </li> </ul>"},{"location":"concepts/zipline-engine/#32-handle_datacontext-data","title":"3.2. handle_data(context, data)","text":"<ul> <li>\u57f7\u884c\u6642\u6a5f \uff1a\u5728\u6bcf\u500b\u4ea4\u6613\u65e5 \u76e4\u4e2d \u88ab\u8abf\u7528\u4e00\u6b21\u3002\u5c0d\u65bc\u65e5\u983b\u56de\u6e2c\uff0c\u901a\u5e38\u5728\u958b\u76e4\u5f8c\u57f7\u884c\uff0c\u4e26\u53ef\u7372\u53d6\u7576\u65e5\u958b\u76e4\u5f8c\u7684\u6700\u65b0\u6578\u64da\u3002</li> <li>\u4f5c\u7528 \uff1a\u9019\u662f\u7b56\u7565\u7684\u6838\u5fc3\u908f\u8f2f\u6240\u5728\u3002\u60a8\u5c07\u5728\u6b64\u8655\uff1a<ul> <li>\u7372\u53d6\u6700\u65b0\u7684\u5e02\u5834\u6578\u64da (<code>data.current()</code>, <code>data.history()</code>)\u3002</li> <li>\u7372\u53d6 Pipeline \u8a08\u7b97\u51fa\u7684\u4ea4\u6613\u8a0a\u865f (<code>pipeline_output()</code>)\u3002</li> <li>\u6839\u64da\u4ea4\u6613\u908f\u8f2f\u5224\u65b7\u8cb7\u8ce3\u6642\u6a5f\u3002</li> <li>\u57f7\u884c\u4e0b\u55ae\u64cd\u4f5c (<code>order</code>, <code>order_target_percent</code>)\u3002</li> <li>\u8a18\u9304\u81ea\u8a02\u6307\u6a19 (<code>record</code>)\u3002</li> </ul> </li> </ul>"},{"location":"concepts/zipline-engine/#33-before_trading_startcontext-data","title":"3.3. before_trading_start(context, data) (\u53ef\u9078)","text":"<ul> <li>\u57f7\u884c\u6642\u6a5f \uff1a\u5728\u6bcf\u500b\u4ea4\u6613\u65e5 \u958b\u76e4\u524d \u88ab\u8abf\u7528\u4e00\u6b21\u3002</li> <li>\u4f5c\u7528 \uff1a\u9069\u7528\u65bc\u9700\u8981\u5728\u76e4\u524d\u9032\u884c\u8cc7\u6599\u9810\u8655\u7406\u3001\u8a08\u7b97\u6216\u8abf\u6574\u7b56\u7565\u72c0\u614b\u7684\u5834\u666f\uff0c\u4f8b\u5982\uff1a<ul> <li>\u66f4\u65b0\u6bcf\u65e5\u7684\u80a1\u7968\u6c60\u3002</li> <li>\u8a08\u7b97\u76e4\u524d\u56e0\u5b50\u3002</li> <li>\u8abf\u6574\u7b56\u7565\u7684\u98a8\u96aa\u53c3\u6578\u3002</li> </ul> </li> </ul>"},{"location":"concepts/zipline-engine/#34-analyzecontext-perf","title":"3.4. analyze(context, perf) (\u53ef\u9078)","text":"<ul> <li>\u57f7\u884c\u6642\u6a5f \uff1a\u5728\u6574\u500b\u56de\u6e2c\u7d50\u675f\u6642 \u50c5\u57f7\u884c\u4e00\u6b21 \u3002</li> <li>\u4f5c\u7528 \uff1a\u7528\u65bc\u5c0d\u56de\u6e2c\u7d50\u679c\u9032\u884c\u6700\u7d42\u5206\u6790\u548c\u8996\u89ba\u5316\uff0c\u4f8b\u5982\uff1a<ul> <li>\u4f7f\u7528 Pyfolio \u751f\u6210\u7e3e\u6548\u5831\u544a\u3002</li> <li>\u7e6a\u88fd\u81ea\u8a02\u7684\u7b56\u7565\u8868\u73fe\u5716\u8868\u3002</li> <li>\u8f38\u51fa\u6700\u7d42\u7684\u7d71\u8a08\u6578\u64da\u3002</li> </ul> </li> </ul> <p>\u8a73\u898b\uff1a\u751f\u547d\u9031\u671f\u51fd\u6578</p>"},{"location":"concepts/zipline-engine/#4-context","title":"4. context \u7269\u4ef6\uff1a\u7b56\u7565\u7684\u8a18\u61b6\u9ad4","text":"<p><code>context</code> \u7269\u4ef6\u662f Zipline \u7b56\u7565\u4e2d\u4e00\u500b\u81f3\u95dc\u91cd\u8981\u7684\u6982\u5ff5\uff0c\u5b83\u5728\u6574\u500b\u56de\u6e2c\u904e\u7a0b\u4e2d\u6301\u7e8c\u5b58\u5728\uff0c\u4e26\u5728\u4e0d\u540c\u7684\u751f\u547d\u9031\u671f\u51fd\u6578\u4e4b\u9593\u50b3\u905e\u7b56\u7565\u7684\u72c0\u614b\u548c\u8cc7\u8a0a\u3002\u60a8\u53ef\u4ee5\u5c07\u5176\u8996\u70ba\u7b56\u7565\u7684\u300c\u8a18\u61b6\u9ad4\u300d\u6216\u300c\u5168\u5c40\u8b8a\u6578\u5132\u5b58\u5eab\u300d\u3002</p> <p><code>context</code> \u5305\u542b\u4e86\u591a\u500b\u91cd\u8981\u7684\u5c6c\u6027\uff0c\u8b93\u60a8\u53ef\u4ee5\u5b58\u53d6\u6295\u8cc7\u7d44\u5408\u3001\u5e33\u6236\u3001\u8a02\u55ae\u7b49\u5373\u6642\u8cc7\u8a0a\uff1a</p> <ul> <li><code>context.portfolio</code>\uff1a\u5305\u542b\u6295\u8cc7\u7d44\u5408\u7684\u8a73\u7d30\u8cc7\u8a0a\uff0c\u5982\u7e3d\u8cc7\u7522\u50f9\u503c (<code>portfolio_value</code>)\u3001\u73fe\u91d1\u9918\u984d (<code>cash</code>)\u3001\u7576\u524d\u6301\u5009 (<code>positions</code>) \u7b49\u3002</li> <li><code>context.account</code>\uff1a\u63d0\u4f9b\u5e33\u6236\u5c64\u7d1a\u7684\u8cc7\u8a0a\uff0c\u5982\u69d3\u687f\u7387 (<code>leverage</code>)\u3001\u53ef\u7528\u8cc7\u91d1 (<code>buying_power</code>) \u7b49\u3002</li> <li><code>context.blotter</code>\uff1a\u8a18\u9304\u6240\u6709\u8a02\u55ae\u548c\u4ea4\u6613\u7684\u8cc7\u8a0a\uff0c\u5305\u62ec\u672a\u6210\u4ea4\u8a02\u55ae (<code>open_orders</code>)\u3001\u5df2\u6210\u4ea4\u8a02\u55ae (<code>orders</code>) \u7b49\u3002</li> <li><code>context.sim_params</code>\uff1a\u5305\u542b\u56de\u6e2c\u7684\u6a21\u64ec\u53c3\u6578\uff0c\u5982\u8d77\u59cb/\u7d50\u675f\u65e5\u671f\u3001\u521d\u59cb\u8cc7\u91d1 (<code>capital_base</code>)\u3001\u8cc7\u6599\u983b\u7387 (<code>data_frequency</code>) \u7b49\u3002</li> <li>\u81ea\u8a02\u5c6c\u6027 \uff1a\u60a8\u53ef\u4ee5\u5728 <code>initialize</code> \u51fd\u6578\u4e2d\u70ba <code>context</code> \u6dfb\u52a0\u4efb\u4f55\u81ea\u8a02\u5c6c\u6027\uff0c\u4ee5\u4fbf\u5728 <code>handle_data</code> \u6216\u5176\u4ed6\u51fd\u6578\u4e2d\u4f7f\u7528\u548c\u66f4\u65b0\uff0c\u4f8b\u5982 <code>context.my_indicator = []</code>\u3002</li> </ul> <p>\u8a73\u898b\uff1acontext \u8b8a\u6578</p>"},{"location":"concepts/zipline-engine/#5","title":"5. \u8cc7\u6599\u8655\u7406\u6a5f\u5236","text":"<p>Zipline \u63d0\u4f9b\u4e86\u5169\u7a2e\u4e3b\u8981\u65b9\u5f0f\u4f86\u7372\u53d6\u5e02\u5834\u6578\u64da\uff1a</p> <ul> <li> <p><code>data.history(asset, field, bar_count, frequency)</code> \uff1a     \u7528\u65bc\u7372\u53d6\u6307\u5b9a\u8cc7\u7522\u5728\u904e\u53bb\u4e00\u6bb5\u6642\u9593\u5167\u7684\u6b77\u53f2\u6578\u64da\u3002\u4f8b\u5982\uff0c\u7372\u53d6\u67d0\u80a1\u7968\u904e\u53bb 100 \u5929\u7684\u6536\u76e4\u50f9\u3002</p> </li> <li> <p><code>data.current(asset, field)</code> \uff1a     \u7528\u65bc\u7372\u53d6\u6307\u5b9a\u8cc7\u7522\u5728\u7576\u524d\u4ea4\u6613\u65e5\uff08\u6216\u7576\u524d\u6a21\u64ec\u6642\u9593\u9ede\uff09\u7684\u6700\u65b0\u6578\u64da\u3002\u4f8b\u5982\uff0c\u7372\u53d6\u7576\u524d\u80a1\u7968\u7684\u6700\u65b0\u50f9\u683c\u6216\u6210\u4ea4\u91cf\u3002</p> </li> <li> <p>Pipeline \u8207\u8cc7\u6599\u6574\u5408 \uff1a     Pipeline API \u80fd\u5920\u9ad8\u6548\u5730\u8655\u7406\u5927\u91cf\u6b77\u53f2\u6578\u64da\uff0c\u8a08\u7b97\u51fa\u8907\u96dc\u7684\u56e0\u5b50\u548c\u4ea4\u6613\u8a0a\u865f\u3002\u9019\u4e9b\u8a0a\u865f\u5728 <code>handle_data</code> \u4e2d\u900f\u904e <code>pipeline_output()</code> \u51fd\u6578\u88ab\u7372\u53d6\uff0c\u4e26\u7528\u65bc\u9a45\u52d5\u4ea4\u6613\u6c7a\u7b56\u3002</p> </li> </ul>"},{"location":"concepts/zipline-engine/#edge-case-handling","title":"\u908a\u754c\u60c5\u6cc1\u8655\u7406 (Edge Case Handling)","text":"<p>\u5728\u5be6\u969b\u56de\u6e2c\u4e2d\uff0c\u9700\u8981\u6ce8\u610f\u8cc7\u6599\u7684\u5b8c\u6574\u6027\u548c\u5404\u7a2e\u53ef\u80fd\u767c\u751f\u7684\u908a\u754c\u60c5\u6cc1\uff1a</p> <ul> <li>\u7f3a\u5931\u8cc7\u6599 (NaN) \uff1a\u7576 <code>data.history()</code> \u6216 <code>pipeline_output()</code> \u8fd4\u56de NaN \u6642\uff0c\u7b56\u7565\u61c9\u6709\u76f8\u61c9\u7684\u8655\u7406\u908f\u8f2f\uff0c\u4f8b\u5982\u8df3\u904e\u8a72\u8cc7\u7522\u6216\u4f7f\u7528\u524d\u4e00\u5929\u7684\u6578\u64da\u3002</li> <li>\u505c\u724c\u6216\u5df2\u4e0b\u5e02\u8cc7\u7522 \uff1aZipline \u6703\u81ea\u52d5\u8655\u7406\u505c\u724c\u6216\u5df2\u4e0b\u5e02\u7684\u8cc7\u7522\uff0c\u907f\u514d\u5728\u9019\u4e9b\u8cc7\u7522\u4e0a\u57f7\u884c\u4ea4\u6613\u3002\u60a8\u4e5f\u53ef\u4ee5\u5728\u7b56\u7565\u4e2d\u6aa2\u67e5 <code>data.is_lively()</code> \u4f86\u78ba\u8a8d\u8cc7\u7522\u662f\u5426\u53ef\u4ea4\u6613\u3002</li> <li>\u73fe\u91d1\u4e0d\u8db3 \uff1a\u7576\u5617\u8a66\u4e0b\u55ae\u7684\u8cc7\u91d1\u8d85\u904e\u53ef\u7528\u73fe\u91d1\u6642\uff0cZipline \u6703\u81ea\u52d5\u8abf\u6574\u8a02\u55ae\u6578\u91cf\u6216\u62d2\u7d55\u8a02\u55ae\u3002\u7b56\u7565\u8a2d\u8a08\u6642\u61c9\u8003\u616e\u8cc7\u91d1\u7ba1\u7406\uff0c\u907f\u514d\u904e\u5ea6\u4e0b\u55ae\u3002</li> </ul> <p>\u8a73\u898b\uff1aZipline \u8cc7\u6599\u7269\u4ef6 \u8a73\u898b\uff1aPipeline API (\u6982\u8ad6)</p>"},{"location":"concepts/zipline-engine/#6","title":"6. \u4ea4\u6613\u57f7\u884c\u8207\u90e8\u4f4d\u7ba1\u7406","text":"<p>Zipline \u63d0\u4f9b\u4e86\u76f4\u89c0\u7684 API \u4f86\u57f7\u884c\u4ea4\u6613\u548c\u7ba1\u7406\u6295\u8cc7\u7d44\u5408\uff1a</p> <ul> <li> <p>\u4e0b\u55ae\u51fd\u6578 \uff1a</p> <ul> <li><code>order(asset, amount)</code>\uff1a\u4ee5\u5e02\u50f9\u55ae\u5f62\u5f0f\u8cb7\u5165\u6216\u8ce3\u51fa\u6307\u5b9a\u6578\u91cf\u7684\u8cc7\u7522\u3002</li> <li><code>order(asset, amount, style=LimitOrder(limit_price))</code>\uff1a\u9650\u50f9\u55ae (Limit Order)\uff0c\u6307\u5b9a\u50f9\u683c\u6210\u4ea4\u3002</li> <li><code>order_target_percent(asset, percent)</code>\uff1a\u8abf\u6574\u6307\u5b9a\u8cc7\u7522\u7684\u6301\u5009\u6bd4\u4f8b\u81f3\u76ee\u6a19\u767e\u5206\u6bd4\u3002Zipline \u6703\u81ea\u52d5\u8a08\u7b97\u9700\u8981\u8cb7\u8ce3\u7684\u6578\u91cf\u3002</li> <li><code>order_target_value(asset, value)</code>\uff1a\u8abf\u6574\u6307\u5b9a\u8cc7\u7522\u7684\u6301\u5009\u50f9\u503c\u81f3\u76ee\u6a19\u91d1\u984d\u3002</li> </ul> </li> <li> <p>\u624b\u7e8c\u8cbb\u8207\u6ed1\u50f9\u6a21\u578b \uff1a     Zipline \u5141\u8a31\u60a8\u8a2d\u5b9a\u8a73\u7d30\u7684\u624b\u7e8c\u8cbb (<code>set_commission</code>) \u548c\u6ed1\u50f9 (<code>set_slippage</code>) \u6a21\u578b\uff0c\u4ee5\u66f4\u771f\u5be6\u5730\u6a21\u64ec\u4ea4\u6613\u6210\u672c\u5c0d\u7b56\u7565\u7e3e\u6548\u7684\u5f71\u97ff\u3002</p> </li> <li> <p>\u90e8\u4f4d\u67e5\u8a62 \uff1a     \u60a8\u53ef\u4ee5\u96a8\u6642\u900f\u904e <code>context.portfolio.positions</code> \u67e5\u8a62\u7576\u524d\u6301\u6709\u7684\u6240\u6709\u8cc7\u7522\u53ca\u5176\u8a73\u7d30\u8cc7\u8a0a\uff08\u5982\u6578\u91cf\u3001\u6210\u672c\u50f9\u3001\u6700\u65b0\u5e02\u50f9\uff09\u3002</p> </li> </ul> <p>\u8a73\u898b\uff1a\u4e0b\u55ae\u51fd\u6578</p>"},{"location":"concepts/zipline-engine/#7","title":"7. \u4ea4\u6613\u57f7\u884c\u6a21\u5f0f\u8207\u8a02\u55ae\u7ba1\u7406","text":"<p>Zipline \u4e0d\u50c5\u6a21\u64ec\u4ea4\u6613\u884c\u70ba\uff0c\u4e5f\u8655\u7406\u8a02\u55ae\u7684\u751f\u547d\u9031\u671f\uff0c\u7406\u89e3\u9019\u4e9b\u6709\u52a9\u65bc\u7b56\u7565\u7684\u7cbe\u78ba\u63a7\u5236\u3002</p>"},{"location":"concepts/zipline-engine/#market-order-limit-order","title":"\u5e02\u50f9\u55ae (Market Order) \u8207\u9650\u50f9\u55ae (Limit Order)","text":"<p>Zipline \u9810\u8a2d\u4ee5\u4e0b\u55ae\u51fd\u6578\u5982 <code>order()</code> \u767c\u51fa \u5e02\u50f9\u55ae \uff0c\u6839\u64da\u56de\u6e2c\u983b\u7387\uff08\u65e5\u983b\u6216\u5206\u9418\u983b\uff09\u5728\u4e0b\u4e00\u500b\u53ef\u7528\u7684\u689d\u5f62\u6578\u64da\u9ede\u9032\u884c\u6210\u4ea4\u3002\u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528 <code>order_target_value()</code> \u6216 <code>order_target_percent()</code> \u4f86\u7ba1\u7406\u60a8\u7684\u6301\u5009\u6bd4\u91cd\u3002</p>"},{"location":"concepts/zipline-engine/#_1","title":"\u8a02\u55ae\u57f7\u884c\u9806\u5e8f\u8207\u512a\u5148\u7d1a","text":"<p>\u5728\u65e5\u983b\u56de\u6e2c\u4e2d\uff0c\u6240\u6709 <code>handle_data</code> \u4e2d\u767c\u51fa\u7684\u8a02\u55ae\u6703\u88ab\u6536\u96c6\uff0c\u4e26\u5728\u7576\u65e5\u6536\u76e4\u6642\u4ee5\u6536\u76e4\u50f9\u57f7\u884c\uff0c\u8003\u616e\u6ed1\u50f9\u548c\u624b\u7e8c\u8cbb\u3002Zipline \u5167\u90e8\u6703\u76e1\u53ef\u80fd\u6a21\u64ec\u771f\u5be6\u5e02\u5834\u4e2d\u7684\u8a02\u55ae\u64ae\u5408\u908f\u8f2f\u3002</p>"},{"location":"concepts/zipline-engine/#_2","title":"\u672a\u6210\u4ea4\u8a02\u55ae\u7684\u904e\u591c\u8655\u7406","text":"<p>\u5982\u679c\u8a02\u55ae\u5728\u7576\u5929\u672a\u80fd\u5b8c\u5168\u6210\u4ea4\uff08\u4f8b\u5982\uff0c\u56e0\u70ba\u6d41\u52d5\u6027\u4e0d\u8db3\u6216\u8a2d\u5b9a\u4e86\u9650\u50f9\uff09\uff0c\u672a\u6210\u4ea4\u7684\u90e8\u5206\u5c07\u6703\u300c\u904e\u591c\u300d\u4e26\u5728\u4e0b\u4e00\u500b\u4ea4\u6613\u65e5\u7e7c\u7e8c\u5617\u8a66\u6210\u4ea4\uff0c\u76f4\u5230\u8a02\u55ae\u88ab\u5b8c\u5168\u6210\u4ea4\u3001\u53d6\u6d88\u6216\u9054\u5230\u9810\u8a2d\u7684\u8d85\u6642\u671f\u9650\u3002\u5728 <code>initialize</code> \u6216 <code>before_trading_start</code> \u4e2d\uff0c\u60a8\u53ef\u4ee5\u900f\u904e <code>context.blotter.open_orders</code> \u6aa2\u67e5\u672a\u6210\u4ea4\u8a02\u55ae\u3002</p>"},{"location":"concepts/zipline-engine/#8","title":"8. \u6548\u80fd\u8207\u6700\u4f73\u5be6\u8e10","text":"<p>\u70ba\u4e86\u9ad8\u6548\u5730\u904b\u884c\u56de\u6e2c\u4e26\u7372\u5f97\u53ef\u9760\u7684\u7d50\u679c\uff0c\u9075\u5faa\u4e00\u4e9b\u6700\u4f73\u5be6\u8e10\u81f3\u95dc\u91cd\u8981\u3002</p> <ul> <li> <p>\u5728 <code>handle_data()</code> \u4e2d\u907f\u514d\u8907\u96dc\u8a08\u7b97 \uff1a     <code>handle_data()</code> \u5728\u6bcf\u500b\u4ea4\u6613\u65e5\u90fd\u6703\u88ab\u547c\u53eb\uff0c\u61c9\u76e1\u91cf\u4fdd\u6301\u5176\u8f15\u91cf\u5316\u3002\u5c07\u5927\u898f\u6a21\u7684\u6578\u64da\u8655\u7406\u548c\u56e0\u5b50\u8a08\u7b97\u79fb\u81f3 Pipeline \u4e2d\uff0c\u6216\u4f7f\u7528 <code>before_trading_start()</code> \u9032\u884c\u76e4\u524d\u4e00\u6b21\u6027\u8a08\u7b97\uff0c\u53ef\u4ee5\u986f\u8457\u63d0\u5347\u56de\u6e2c\u901f\u5ea6\u3002</p> </li> <li> <p>\u4f7f\u7528 Pipeline \u800c\u975e for-loop \u9032\u884c\u5927\u898f\u6a21\u56e0\u5b50\u8a08\u7b97 \uff1a     Pipeline \u5c08\u70ba\u8655\u7406\u591a\u8cc7\u7522\u6642\u9593\u5e8f\u5217\u6578\u64da\u800c\u512a\u5316\uff0c\u4f7f\u7528 C \u8a9e\u8a00\u5e95\u5c64\u5be6\u73fe\uff0c\u6bd4 Python \u7684 for-loop \u6548\u7387\u9ad8\u51fa\u6578\u500b\u91cf\u7d1a\u3002\u5c0d\u65bc\u6d89\u53ca\u5927\u91cf\u80a1\u7968\u6216\u8907\u96dc\u56e0\u5b50\u7684\u8a08\u7b97\uff0c\u52d9\u5fc5\u4f7f\u7528 Pipeline\u3002</p> </li> <li> <p>\u5408\u7406\u8a2d\u5b9a\u56de\u6e2c\u983b\u7387\u8207\u8cc7\u6599\u91cf \uff1a     \u904e\u9ad8\u7684\u56de\u6e2c\u983b\u7387\uff08\u4f8b\u5982\u5206\u9418\u983b\u6578\u64da\uff09\u548c\u904e\u9577\u7684\u6b77\u53f2\u5340\u9593\u6703\u5927\u5e45\u589e\u52a0\u56de\u6e2c\u6642\u9593\u548c\u8a18\u61b6\u9ad4\u6d88\u8017\u3002\u6839\u64da\u7b56\u7565\u7684\u7279\u6027\u9078\u64c7\u6700\u5408\u9069\u7684\u6578\u64da\u983b\u7387\uff0c\u4e26\u53ea\u8f09\u5165\u5fc5\u8981\u7684\u6b77\u53f2\u8cc7\u6599\u3002</p> </li> </ul>"},{"location":"concepts/zipline-engine/#_3","title":"\u7e3d\u7d50","text":"<p>Zipline \u5f15\u64ce\u662f TQuant Lab \u91cf\u5316\u4ea4\u6613\u7b56\u7565\u7684\u57fa\u77f3\u3002\u900f\u904e\u5176 \u4e8b\u4ef6\u9a45\u52d5\u6a21\u578b \u3001\u6e05\u6670\u7684\u751f\u547d\u9031\u671f\u51fd\u6578\u3001\u5f37\u5927\u7684 <code>context</code> \u7269\u4ef6\u4ee5\u53ca\u9748\u6d3b\u7684\u8cc7\u6599\u8207\u4ea4\u6613 API\uff0c\u7814\u7a76\u8005\u53ef\u4ee5\u9ad8\u6548\u5730\u958b\u767c\u3001\u6e2c\u8a66\u548c\u512a\u5316\u8907\u96dc\u7684\u4ea4\u6613\u7b56\u7565\uff0c\u5f9e\u800c\u5c07\u91cf\u5316\u601d\u60f3\u8f49\u5316\u70ba\u5be6\u969b\u7684\u6295\u8cc7\u6210\u679c\u3002</p>"},{"location":"futures/first-futures-strategy/","title":"\u5efa\u7acb\u4f60\u7684\u7b2c\u4e00\u500b\u671f\u8ca8\u7b56\u7565","text":"<p>Info</p> <p>\u672c\u6559\u5b78\u6587\u4ef6\u5f15\u5c0e\u60a8\u4f7f\u7528 TQuant Lab\uff0c\u5f9e\u96f6\u958b\u59cb\u5efa\u7acb\u4e00\u500b\u5b8c\u6574\u4e14\u53ef\u57f7\u884c\u7684\u671f\u8ca8\u56de\u6e2c\u7b56\u7565\u3002\u6211\u5011\u5c07\u4ee5\u4e00\u500b\u7c21\u55ae\u7684\u300c\u5747\u7dda\u4ea4\u53c9\u7b56\u7565\u300d\u70ba\u7bc4\u4f8b\uff0c\u8aaa\u660e\u4e00\u500b\u671f\u8ca8\u7b56\u7565\u7684\u5b8c\u6574\u751f\u547d\u9031\u671f\u3002</p>"},{"location":"futures/first-futures-strategy/#1","title":"1. \u8cc7\u6599\u6e96\u5099","text":"<p>\u8a2d\u5b9a TEJ API \u91d1\u9470\uff0c\u4e0b\u8f09\u671f\u8ca8\u5546\u54c1\u8cc7\u6599\u81f3\u672c\u5730\u74b0\u5883\u3002</p>"},{"location":"futures/first-futures-strategy/#2","title":"2. \u7b56\u7565\u521d\u59cb\u5316","text":"<p>\u8a2d\u5b9a\u9023\u7e8c\u5408\u7d04\u3001\u4ea4\u6613\u6210\u672c\u3001\u7e3e\u6548\u57fa\u6e96\u8207\u6392\u7a0b\u51fd\u6578\u3002</p>"},{"location":"futures/first-futures-strategy/#3","title":"3. \u4ea4\u6613\u908f\u8f2f","text":"<p>\u5be6\u4f5c\u5747\u7dda\u4ea4\u53c9\u7b56\u7565\u7684\u8cb7\u8ce3\u4fe1\u865f\u8207\u4e0b\u55ae\u908f\u8f2f\u3002</p>"},{"location":"futures/first-futures-strategy/#4","title":"4. \u8f49\u5009\u8655\u7406","text":"<p>\u8655\u7406\u671f\u8ca8\u5408\u7d04\u5230\u671f\u524d\u7684\u81ea\u52d5\u8f49\u5009\u6a5f\u5236\u3002</p>"},{"location":"futures/first-futures-strategy/#1-data-preparation","title":"1. \u8cc7\u6599\u6e96\u5099 (Data Preparation)","text":"<p>\u5728\u9032\u884c\u4efb\u4f55\u56de\u6e2c\u4e4b\u524d\uff0c\u6211\u5011\u9700\u8981\u5148\u5c07\u5e02\u5834\u8cc7\u6599\u4e0b\u8f09\u5230\u672c\u5730\u74b0\u5883\u3002Zipline \u4f7f\u7528 <code>ingest</code> \u547d\u4ee4\u4f86\u5b8c\u6210\u9019\u500b\u6b65\u9a5f\u3002</p> <p>\u4ee5\u4e0b\u7a0b\u5f0f\u78bc\u6703\u8a2d\u5b9a\u60a8\u7684 TEJ API \u91d1\u9470\uff0c\u4e26\u6307\u5b9a\u8981\u4e0b\u8f09\u7684\u671f\u8ca8\u5546\u54c1\uff08\u6b64\u8655\u70ba\u53f0\u6307\u671f <code>TX</code>\uff09\u8207\u5c0d\u61c9\u7684\u6307\u6578\uff08<code>IR0001</code> \u4f5c\u70ba\u5927\u76e4\u6307\u6a19\uff09\uff0c\u7136\u5f8c\u57f7\u884c <code>ingest</code>\u3002</p> <pre><code>import os\n\n# \u586b\u5165\u60a8\u7684 TEJ API Key\nos.environ['TEJAPI_KEY'] = 'YOUR_KEY'\nos.environ['TEJAPI_BASE'] = 'https://api.tej.com.tw'\n\n# \u8a2d\u5b9a\u8981\u4e0b\u8f09\u7684\u671f\u8ca8\u8207\u5c0d\u61c9\u7684\u6307\u6578/\u80a1\u7968\nos.environ['future'] = 'TX'\nos.environ['ticker'] = 'IR0001'\n\n# \u8a2d\u5b9a\u4e0b\u8f09\u7684\u8d77\u8a16\u65e5\u671f\nos.environ['mdate'] = '20100101 20250930'\n\n# \u57f7\u884c ingest \u547d\u4ee4 (\u9996\u6b21\u57f7\u884c\u6216\u9700\u66f4\u65b0\u6578\u64da\u6642\u53d6\u6d88\u8a3b\u89e3)\n# !zipline ingest -b tquant_future\n</code></pre> <p>Note</p> <p><code>ingest</code> \u547d\u4ee4\u53ea\u9700\u8981\u5728\u7b2c\u4e00\u6b21\u57f7\u884c\uff0c\u6216\u7576\u60a8\u9700\u8981\u66f4\u65b0\u672c\u5730\u8cc7\u6599\u6642\u57f7\u884c\u3002\u5728\u5e73\u5e38\u7684\u7b56\u7565\u958b\u767c\u4e2d\uff0c\u53ef\u4ee5\u5c07\u5176\u8a3b\u89e3\u6389\u4ee5\u7bc0\u7701\u6642\u9593\u3002</p>"},{"location":"futures/first-futures-strategy/#2-","title":"2. \u7b56\u7565\u67b6\u69cb - \u521d\u59cb\u5316\u8207\u6392\u7a0b","text":"<p><code>initialize</code> \u51fd\u6578\u662f Zipline \u7b56\u7565\u7684\u8d77\u9ede\uff0c\u5b83\u5728\u6574\u500b\u56de\u6e2c\u958b\u59cb\u6642\u53ea\u6703\u88ab\u547c\u53eb\u4e00\u6b21\u3002\u6240\u6709\u95dc\u65bc\u7b56\u7565\u7684\u57fa\u790e\u8a2d\u5b9a\u90fd\u5728\u9019\u88e1\u5b8c\u6210\u3002</p> <ul> <li><code>continuous_future(...)</code>: \u5efa\u7acb\u4e00\u500b\u9023\u7e8c\u5408\u7d04\u7269\u4ef6\uff0c\u8b93 Zipline \u81ea\u52d5\u8655\u7406\u63db\u6708\uff0c\u65b9\u4fbf\u6211\u5011\u5c0d\u4e00\u500b\u9023\u7e8c\u7684\u50f9\u683c\u5e8f\u5217\u9032\u884c\u5206\u6790\u3002</li> <li><code>set_commission()</code> / <code>set_slippage()</code>: \u8a2d\u5b9a\u4ea4\u6613\u6210\u672c\uff0c\u5305\u542b\u624b\u7e8c\u8cbb\u8207\u6ed1\u50f9\u3002</li> <li><code>set_benchmark()</code>: \u8a2d\u5b9a\u7e3e\u6548\u6bd4\u8f03\u7684\u57fa\u6e96\uff0c\u901a\u5e38\u70ba\u5927\u76e4\u6307\u6578\u3002</li> <li><code>schedule_function(...)</code>: Zipline \u7684\u6392\u7a0b\u5668\uff0c\u7528\u4f86\u5b89\u6392\u5728\u56de\u6e2c\u7684\u7279\u5b9a\u6642\u9593\u9ede\uff08\u5982\u6bcf\u65e5\u958b\u76e4\u3001\u6536\u76e4\uff09\u57f7\u884c\u6307\u5b9a\u7684\u51fd\u6578\u3002</li> </ul> <pre><code>from zipline.api import (\n    continuous_future, schedule_function, date_rules, time_rules,\n    set_commission, set_slippage, set_benchmark, symbol\n)\nfrom zipline.finance import commission, slippage\n\ndef initialize(context):\n    # --- 1. \u8a2d\u5b9a\u8981\u4ea4\u6613\u7684\u8cc7\u7522 ---\n    # \u5efa\u7acb\u53f0\u6307\u671f\u7684\u9023\u7e8c\u8fd1\u6708\u5408\u7d04\n    context.future = continuous_future('TX', offset=0, roll='calendar', adjustment='add')\n\n    # --- 2. \u8a2d\u5b9a\u4ea4\u6613\u6210\u672c ---\n    set_commission(futures=commission.PerContract(cost=200, exchange_fee=0))\n    set_slippage(futures=slippage.FixedSlippage(spread=6))\n\n    # --- 3. \u8a2d\u5b9a\u7b56\u7565\u53c3\u6578\u8207\u7e3e\u6548\u57fa\u6e96 ---\n    context.ma_period = 20  # \u8a2d\u5b9a\u5747\u7dda\u8a08\u7b97\u9031\u671f\n    set_benchmark(symbol('IR0001'))\n\n    # --- 4. \u8a2d\u5b9a\u6392\u7a0b ---\n    # \u6bcf\u65e5\u958b\u76e4\u5f8c 30 \u5206\u9418\uff0c\u57f7\u884c\u4e3b\u8981\u7684\u4ea4\u6613\u908f\u8f2f\n    schedule_function(daily_trade, date_rules.every_day(), time_rules.market_open(minutes=30))\n    # \u6bcf\u65e5\u6536\u76e4\u6642\uff0c\u6aa2\u67e5\u662f\u5426\u9700\u8981\u8f49\u5009\n    schedule_function(roll_futures, date_rules.every_day(), time_rules.market_close())\n</code></pre>"},{"location":"futures/first-futures-strategy/#3_1","title":"3. \u64b0\u5beb\u4ea4\u6613\u908f\u8f2f","text":"<p><code>daily_trade</code> \u51fd\u6578\u662f\u6211\u5011\u7b56\u7565\u7684\u6838\u5fc3\uff0c\u5b83\u6703\u6839\u64da\u6211\u5011\u5728 <code>initialize</code> \u4e2d\u8a2d\u5b9a\u7684\u6392\u7a0b\u88ab\u6bcf\u65e5\u547c\u53eb\u3002</p> <p>\u9019\u500b\u7bc4\u4f8b\u7b56\u7565\u7684\u908f\u8f2f\u5f88\u7c21\u55ae\uff1a</p> <ol> <li>\u4f7f\u7528 <code>data.history()</code> \u7372\u53d6\u904e\u53bb\u4e00\u6bb5\u6642\u9593\u7684\u6b77\u53f2\u50f9\u683c\u3002</li> <li>\u8a08\u7b97\u77ed\u671f\uff0810\u65e5\uff09\u8207\u9577\u671f\uff0820\u65e5\uff09\u7684\u79fb\u52d5\u5e73\u5747\u7dda (MA)\u3002</li> <li>\u7576\u77ed\u671f\u5747\u7dda\u7531\u4e0b\u5f80\u4e0a\u7a7f\u8d8a\u9577\u671f\u5747\u7dda\u6642\uff08\u9ec3\u91d1\u4ea4\u53c9\uff09\uff0c\u5efa\u7acb\u591a\u55ae\u3002</li> <li>\u7576\u77ed\u671f\u5747\u7dda\u7531\u4e0a\u5f80\u4e0b\u7a7f\u8d8a\u9577\u671f\u5747\u7dda\u6642\uff08\u6b7b\u4ea1\u4ea4\u53c9\uff09\uff0c\u5e73\u5009\u3002</li> <li>\u4f7f\u7528 <code>order_target()</code> \u51fd\u6578\u4f86\u4e0b\u55ae\uff0c\u5b83\u6703\u81ea\u52d5\u8a08\u7b97\u9700\u8981\u8cb7\u8ce3\u7684\u53e3\u6578\u4ee5\u9054\u5230\u6211\u5011\u7684\u76ee\u6a19\u90e8\u4f4d\u3002</li> <li>\u4f7f\u7528 <code>record()</code> \u8a18\u9304\u6211\u5011\u60f3\u8981\u5728\u5716\u8868\u4e0a\u89c0\u5bdf\u7684\u6578\u503c\u3002</li> </ol> <pre><code>from zipline.api import order_target, record\n\ndef daily_trade(context, data):\n    # --- 1. \u7372\u53d6\u6b77\u53f2\u6578\u64da ---\n    hist = data.history(context.future, 'price', bar_count=context.ma_period + 5, frequency='1d')\n\n    # --- 2. \u8a08\u7b97\u6307\u6a19 ---\n    short_ma = hist.rolling(window=10).mean().iloc[-1]\n    long_ma = hist.rolling(window=context.ma_period).mean().iloc[-1]\n\n    # --- 3. \u7522\u751f\u4ea4\u6613\u4fe1\u865f ---\n    buy_signal = short_ma &gt; long_ma\n    sell_signal = short_ma &lt; long_ma\n\n    # --- 4. \u53d6\u5f97\u7576\u524d\u5408\u7d04\u8207\u90e8\u4f4d ---\n    # \u5fc5\u9808\u5148\u5f9e\u9023\u7e8c\u5408\u7d04\u7269\u4ef6\u4e2d\uff0c\u53d6\u5f97\u7576\u524d\u61c9\u8a72\u4ea4\u6613\u7684\u300c\u5177\u9ad4\u300d\u5408\u7d04\n    current_contract = data.current(context.future, 'contract')\n    # \u6aa2\u67e5\u76ee\u524d\u53f0\u6307\u671f\u7522\u54c1\u7684\u7e3d\u6301\u5009\u53e3\u6578\n    current_position = context.portfolio.positions.get(current_contract, None)\n    root_qty = current_position.amount if current_position else 0\n\n    # --- 5. \u57f7\u884c\u4e0b\u55ae\u908f\u8f2f ---\n    if buy_signal and root_qty == 0:\n        order_target(current_contract, 1)  # \u76ee\u6a19\u6301\u6709 1 \u53e3\u591a\u55ae\n    elif sell_signal and root_qty != 0:\n        order_target(current_contract, 0)  # \u5e73\u5009\n\n    # --- 6. \u8a18\u9304\u6578\u64da ---\n    record(price=hist.iloc[-1], short_ma=short_ma, long_ma=long_ma)\n</code></pre>"},{"location":"futures/first-futures-strategy/#4_1","title":"4. \u8655\u7406\u671f\u8ca8\u8f49\u5009","text":"<p>\u671f\u8ca8\u5408\u7d04\u6709\u5230\u671f\u65e5\u3002\u70ba\u4e86\u8b93\u7b56\u7565\u53ef\u4ee5\u9577\u671f\u904b\u884c\uff0c\u6211\u5011\u5fc5\u9808\u5728\u820a\u5408\u7d04\u5230\u671f\u524d\uff0c\u5c07\u90e8\u4f4d\u300c\u8f49\u79fb\u300d\u5230\u65b0\u7684\u5408\u7d04\u4e0a\uff0c\u9019\u500b\u904e\u7a0b\u7a31\u70ba\u300c\u8f49\u5009\u300d\u3002<code>roll_futures</code> \u51fd\u6578\u5c31\u662f\u5c08\u9580\u7528\u4f86\u8655\u7406\u9019\u4ef6\u4e8b\u3002</p> <p>\u5b83\u7684\u908f\u8f2f\u5982\u4e0b\uff1a</p> <ol> <li>\u6bcf\u65e5\u6536\u76e4\u6642\u6aa2\u67e5\u76ee\u524d\u6301\u6709\u7684\u6240\u6709\u671f\u8ca8\u90e8\u4f4d\u3002</li> <li>\u8a08\u7b97\u8a72\u5408\u7d04\u8ddd\u96e2\u81ea\u52d5\u5e73\u5009\u65e5 (<code>auto_close_date</code>) \u9084\u6709\u5e7e\u5929\u3002</li> <li>\u5982\u679c\u5373\u5c07\u5230\u671f\uff08\u4f8b\u5982\uff0c5\u5929\u5167\uff09\uff0c\u5c31\u57f7\u884c\u8f49\u5009\uff1a<ul> <li>\u53d6\u6d88\u6240\u6709\u639b\u5728\u820a\u5408\u7d04\u4e0a\u7684\u8a02\u55ae\u3002</li> <li>\u5c07\u820a\u5408\u7d04\u7684\u90e8\u4f4d\u5e73\u5009 (<code>order_target(old_contract, 0)</code>)\u3002</li> <li>\u5728 <code>continuous_future</code> \u6307\u5411\u7684\u65b0\u5408\u7d04\u4e0a\uff0c\u5efa\u7acb\u76f8\u540c\u6578\u91cf\u7684\u90e8\u4f4d (<code>order_target(new_contract, amount)</code>)\u3002</li> </ul> </li> </ol> <pre><code>from zipline.api import get_open_orders, cancel_order\n\ndef roll_futures(context, data):\n    for asset, pos in context.portfolio.positions.items():\n        # \u5ffd\u7565\u975e\u671f\u8ca8\u8cc7\u7522\u6216\u7a7a\u90e8\u4f4d\n        if pos.amount == 0 or getattr(asset, 'auto_close_date', None) is None:\n            continue\n\n        # \u8a08\u7b97\u8ddd\u96e2\u5230\u671f\u65e5\u5929\u6578\n        days_to_auto_close = (asset.auto_close_date.date() - data.current_session.date()).days\n        if days_to_auto_close &gt; 5:\n            continue\n\n        # \u53d6\u5f97\u65b0\u7684\u76ee\u6a19\u5408\u7d04\n        new_contract = data.current(context.future, \"contract\")\n        if new_contract == asset:\n            continue\n\n        # \u57f7\u884c\u8f49\u5009\n        # 1. \u53d6\u6d88\u820a\u5408\u7d04\u7684\u6240\u6709\u639b\u55ae\n        for o in get_open_orders(asset):\n            cancel_order(o.id)\n\n        print(f\"\u57f7\u884c\u8f49\u5009: \u5f9e {asset.symbol} \u5230 {new_contract.symbol}\")\n        # 2. \u5e73\u6389\u820a\u5009\u4f4d\n        order_target(asset, 0)\n        # 3. \u5efa\u7acb\u65b0\u5009\u4f4d\n        order_target(new_contract, pos.amount)\n</code></pre>"},{"location":"futures/first-futures-strategy/#5","title":"5. \u57f7\u884c\u56de\u6e2c","text":"<p>\u7576\u6240\u6709\u51fd\u6578\u90fd\u5b9a\u7fa9\u597d\u4e4b\u5f8c\uff0c\u6700\u5f8c\u4e00\u6b65\u5c31\u662f\u547c\u53eb <code>run_algorithm()</code> \u4f86\u555f\u52d5\u6574\u500b\u56de\u6e2c\u6d41\u7a0b\u3002</p> <p>\u60a8\u9700\u8981\u63d0\u4f9b\u56de\u6e2c\u7684\u8d77\u8a16\u65e5\u671f\u3001<code>initialize</code> \u51fd\u6578\u7684\u540d\u7a31\u3001\u521d\u59cb\u8cc7\u91d1\u3001\u8cc7\u6599\u96c6\u540d\u7a31 (<code>bundle</code>) \u7b49\u53c3\u6578\u3002\u56de\u6e2c\u7d50\u675f\u5f8c\uff0c\u5b83\u6703\u56de\u50b3\u4e00\u500b\u5305\u542b\u6240\u6709\u7e3e\u6548\u8207\u81ea\u5b9a\u7fa9\u8a18\u9304\u6578\u64da\u7684 <code>results</code> DataFrame\u3002</p> <pre><code>import pandas as pd\nfrom zipline import run_algorithm\nfrom zipline.utils.calendar_utils import get_calendar\n\nresults = run_algorithm(\n    start=pd.Timestamp('2020-01-01', tz='utc'),\n    end=pd.Timestamp('2024-09-30', tz='utc'),\n    initialize=initialize,\n    capital_base=1000000,\n    data_frequency='daily',\n    bundle='tquant_future',\n    trading_calendar=get_calendar('TEJ')\n)\n\n# \u60a8\u53ef\u4ee5\u63a5\u8457\u5206\u6790 results DataFrame\n# print(results.head())\n</code></pre>"},{"location":"futures/first-futures-strategy/#6","title":"6. \u4e0b\u4e00\u6b65","text":"<p>\u606d\u559c\uff01\u60a8\u5df2\u7d93\u5b8c\u6210\u4e86\u4e00\u500b\u5b8c\u6574\u7684\u671f\u8ca8\u7b56\u7565\u3002\u60a8\u53ef\u4ee5\uff1a</p> <ul> <li>\u8a66\u8457\u8abf\u6574\u5747\u7dda\u7684\u9031\u671f</li> <li>\u4fee\u6539\u4ea4\u6613\u4fe1\u865f\u7684\u908f\u8f2f</li> <li>\u66f4\u63db\u4e0d\u540c\u7684\u671f\u8ca8\u5546\u54c1</li> <li>\u4f7f\u7528 Pyfolio \u5206\u6790\u7b56\u7565\u7e3e\u6548</li> </ul>"},{"location":"futures/futures-cheat-sheet/","title":"Zipline \u671f\u8ca8\u7b56\u7565\u5099\u5fd8\u9304 (API Cheat Sheet)","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b TQuant Lab \u671f\u8ca8\u7b56\u7565\u958b\u767c\u7684 API \u5feb\u901f\u53c3\u8003\uff0c\u5305\u542b\u521d\u59cb\u5316\u3001\u6578\u64da\u7372\u53d6\u3001\u4ea4\u6613\u4e0b\u55ae\u3001\u90e8\u4f4d\u7ba1\u7406\u53ca\u56de\u6e2c\u57f7\u884c\u7b49\u5e38\u7528\u51fd\u6578\u3002</p> <p>\u9019\u662f\u4e00\u4efd\u5c08\u70ba TQuant Lab \u4e2d\u9032\u884c \u671f\u8ca8 \u7b56\u7565\u56de\u6e2c\u8a2d\u8a08\u7684 API \u5feb\u901f\u53c3\u8003\u5099\u5fd8\u9304\u3002</p>"},{"location":"futures/futures-cheat-sheet/#1-initialize","title":"1. \u521d\u59cb\u5316 (<code>initialize</code>)","text":"API \u51fd\u6578/\u5c6c\u6027 \u8aaa\u660e \u7bc4\u4f8b <code>continuous_future(...)</code> (\u6700\u91cd\u8981) \u5efa\u7acb\u4e00\u500b\u9023\u7e8c\u5408\u7d04\u7269\u4ef6\uff0c\u7528\u4ee5\u9032\u884c\u5206\u6790\u8207\u4ea4\u6613\u3002 <code>context.future = continuous_future('TX', offset=0)</code> <code>set_benchmark(asset)</code> \u8a2d\u5b9a\u56de\u6e2c\u7684\u7e3e\u6548\u6bd4\u8f03\u57fa\u6e96\u3002 <code>set_benchmark(symbol('IR0001'))</code> <code>set_commission(...)</code> \u8a2d\u5b9a\u4ea4\u6613\u624b\u7e8c\u8cbb\u6a21\u578b\uff0c\u671f\u8ca8\u901a\u5e38\u6309\u53e3\u8a08\u8cbb\u3002 <code>set_commission(futures=commission.PerContract(cost=200))</code> <code>set_slippage(...)</code> \u8a2d\u5b9a\u6ed1\u50f9\u6a21\u578b\uff0c\u671f\u8ca8\u5e38\u7528\u56fa\u5b9a\u9ede\u6578\u6ed1\u50f9\u3002 <code>set_slippage(futures=slippage.FixedSlippage(spread=6.0))</code> <code>schedule_function(...)</code> \u8a3b\u518a\u4e00\u500b\u6392\u7a0b\u51fd\u6578\u3002\u671f\u8ca8\u7b56\u7565\u901a\u5e38\u9700\u8981\u6392\u7a0b \u4ea4\u6613 \u8207 \u8f49\u5009 \u5169\u500b\u51fd\u6578\u3002 <code>schedule_function(daily_trade, date_rules.every_day())</code>"},{"location":"futures/futures-cheat-sheet/#2-data-access","title":"2. \u6578\u64da\u7372\u53d6 (Data Access)","text":"API \u51fd\u6578/\u5c6c\u6027 \u8aaa\u660e \u7bc4\u4f8b <code>data.current(cf, 'contract')</code> (\u6700\u91cd\u8981) \u5f9e\u9023\u7e8c\u5408\u7d04(<code>cf</code>)\u4e2d\uff0c\u53d6\u5f97\u7576\u524d\u53ef\u4ea4\u6613\u7684 \u5177\u9ad4\u5408\u7d04 \u7269\u4ef6\u3002 <code>contract = data.current(context.future, 'contract')</code> <code>data.history(cf, ...)</code> \u7372\u53d6\u9023\u7e8c\u5408\u7d04\u7684\u6b77\u53f2\u6578\u64da\u3002 <code>hist = data.history(context.future, 'price', 50, '1d')</code> <code>data.can_trade(contract)</code> \u6aa2\u67e5 \u5177\u9ad4\u5408\u7d04 \u5728\u7576\u524d\u6642\u9593\u9ede\u662f\u5426\u53ef\u4ea4\u6613\u3002 <code>if data.can_trade(contract): ...</code> <code>get_datetime()</code> \u53d6\u5f97\u76ee\u524d\u56de\u6e2c\u7684\u6642\u9593\u9ede (UTC)\u3002 <code>current_time = get_datetime()</code>"},{"location":"futures/futures-cheat-sheet/#3-trading-orders","title":"3. \u4ea4\u6613\u8207\u8a02\u55ae (Trading &amp; Orders)","text":"<p>\u6838\u5fc3\u89c0\u5ff5\uff1a\u6240\u6709\u4e0b\u55ae\u51fd\u6578\u7684 <code>asset</code> \u53c3\u6578\u90fd\u5fc5\u9808\u662f <code>data.current()</code> \u56de\u50b3\u7684**\u5177\u9ad4\u5408\u7d04**\uff0c\u800c\u975e <code>continuous_future</code> \u7269\u4ef6\u3002</p> API \u51fd\u6578/\u5c6c\u6027 \u8aaa\u660e \u7bc4\u4f8b <code>order_target(contract, amount)</code> \u4e0b\u55ae\u5c07 \u5177\u9ad4\u5408\u7d04 \u7684\u90e8\u4f4d\u8abf\u6574\u81f3\u76ee\u6a19 <code>amount</code> \u53e3\u6578\u3002 <code>order_target(contract, 1)</code> <code>order(contract, amount)</code> \u4e0b\u4e00\u5f35\u5e02\u50f9\u55ae\uff0c\u8cb7\u5165/\u8ce3\u51fa\u6307\u5b9a <code>amount</code> \u7684\u53e3\u6578\u3002 <code>order(contract, -1)</code> <code>get_order(order_id)</code> \u900f\u904e\u8a02\u55ae ID \u67e5\u8a62\u8a02\u55ae\u7269\u4ef6\u3002 <code>my_order = get_order(order_id)</code> <code>get_open_orders(contract)</code> \u53d6\u5f97\u6307\u5b9a \u5177\u9ad4\u5408\u7d04 \u4e0a\u6240\u6709\u672a\u6210\u4ea4\u7684\u639b\u55ae\u3002 <code>open_orders = get_open_orders(my_contract)</code> <code>cancel_order(order_id)</code> \u6839\u64da\u8a02\u55ae ID \u53d6\u6d88\u4e00\u7b46\u672a\u6210\u4ea4\u7684\u639b\u55ae\u3002 <code>cancel_order(my_order_id)</code>"},{"location":"futures/futures-cheat-sheet/#4-position-contract-attributes","title":"4. \u90e8\u4f4d\u8207\u5408\u7d04\u5c6c\u6027 (Position &amp; Contract Attributes)","text":"API \u51fd\u6578/\u5c6c\u6027 \u8aaa\u660e \u7bc4\u4f8b <code>context.portfolio.positions</code> (\u5c6c\u6027) \u4e00\u500b\u5b57\u5178\uff0c\u5305\u542b\u6240\u6709\u7576\u524d\u6301\u6709\u7684\u90e8\u4f4d\u3002 <code>for asset, pos in context.portfolio.positions.items(): ...</code> <code>position.amount</code> (\u5c6c\u6027) \u6301\u6709\u7684\u53e3\u6578\u3002\u591a\u55ae\u70ba\u6b63\uff0c\u7a7a\u55ae\u70ba\u8ca0\u3002 <code>contracts_held = position.amount</code> <code>asset.auto_close_date</code> (\u5c6c\u6027) (\u8f49\u5009\u95dc\u9375) \u5177\u9ad4\u5408\u7d04\u7684\u5230\u671f\u7d50\u7b97\u65e5\u3002 <code>days_left = (asset.auto_close_date - today).days</code> <code>asset.root_symbol</code> (\u5c6c\u6027) \u5177\u9ad4\u5408\u7d04\u7684\u6839\u4ee3\u78bc\u3002 <code>if asset.root_symbol == 'TX': ...</code> <code>asset.symbol</code> (\u5c6c\u6027) \u5177\u9ad4\u5408\u7d04\u7684\u5b8c\u6574\u4ee3\u78bc\u3002 <code>print(asset.symbol) # e.g., 'TXF2410'</code>"},{"location":"futures/futures-cheat-sheet/#5-execution-analysis","title":"5. \u57f7\u884c\u8207\u5206\u6790 (Execution &amp; Analysis)","text":"API \u51fd\u6578/\u5c6c\u6027 \u8aaa\u660e \u7bc4\u4f8b <code>run_algorithm(...)</code> \u6838\u5fc3\u57f7\u884c\u51fd\u6578 \uff0c\u555f\u52d5\u6574\u500b\u56de\u6e2c\u3002 <code>results = run_algorithm(...)</code> <code>record(**kwargs)</code> \u5728\u6bcf\u500b\u6642\u9593\u9ede\u8a18\u9304\u4e00\u500b\u6216\u591a\u500b\u8b8a\u6578\uff0c\u4ee5\u4fbf\u5f8c\u7e8c\u5206\u6790\u3002 <code>record(my_ma=ma_value, price=current_price)</code> <code>get_calendar(name)</code> \u53d6\u5f97\u4e00\u500b\u4ea4\u6613\u65e5\u66c6\u7269\u4ef6\u3002\u671f\u8ca8\u8207\u80a1\u7968\u5171\u7528 <code>TEJ</code> \u65e5\u66c6\u3002 <code>trading_calendar=get_calendar('TEJ')</code>"},{"location":"futures/futures-commission-slippage/","title":"\u671f\u8ca8\u624b\u7e8c\u8cbb\u8207\u6ed1\u50f9\u8a2d\u5b9a","text":"<p>Info</p> <p>\u672c\u6307\u5357\u8aaa\u660e\u5982\u4f55\u5728 TQuant Lab \u4e2d\u70ba\u671f\u8ca8\u7b56\u7565\u8a2d\u5b9a\u5408\u7406\u7684\u4ea4\u6613\u6210\u672c\uff0c\u5305\u542b\u624b\u7e8c\u8cbb (Commission) \u8207\u6ed1\u50f9 (Slippage) \u6a21\u578b\u3002</p>"},{"location":"futures/futures-commission-slippage/#1","title":"1. \u6982\u8ff0","text":"<p>\u5728\u9032\u884c\u671f\u8ca8\u56de\u6e2c\u6642\uff0c\u6b63\u78ba\u8a2d\u5b9a\u4ea4\u6613\u6210\u672c\u662f\u78ba\u4fdd\u56de\u6e2c\u7d50\u679c\u8cbc\u8fd1\u771f\u5be6\u4ea4\u6613\u7684\u95dc\u9375\u3002TQuant Lab \u63d0\u4f9b\u4e86\u5c08\u70ba\u671f\u8ca8\u8a2d\u8a08\u7684\u6210\u672c\u6a21\u578b\uff1a</p> <ul> <li>\u624b\u7e8c\u8cbb (Commission)\uff1a\u6bcf\u6b21\u4ea4\u6613\u6642\u652f\u4ed8\u7d66\u5238\u5546\u7684\u8cbb\u7528</li> <li>\u6ed1\u50f9 (Slippage)\uff1a\u5be6\u969b\u6210\u4ea4\u50f9\u683c\u8207\u9810\u671f\u50f9\u683c\u4e4b\u9593\u7684\u5dee\u7570</li> </ul>"},{"location":"futures/futures-commission-slippage/#2","title":"2. \u624b\u7e8c\u8cbb\u8a2d\u5b9a","text":""},{"location":"futures/futures-commission-slippage/#21-percontract","title":"2.1 PerContract \u6a21\u578b","text":"<p>\u671f\u8ca8\u624b\u7e8c\u8cbb\u901a\u5e38\u4ee5\u300c\u6bcf\u53e3\u300d\u8a08\u7b97\uff0c\u4f7f\u7528 PerContract \u6a21\u578b\uff1a</p> <pre><code>from zipline.api import set_commission\nfrom zipline.finance import commission\n\ndef initialize(context):\n    # \u8a2d\u5b9a\u671f\u8ca8\u624b\u7e8c\u8cbb\uff1a\u6bcf\u53e3 200 \u5143\n    set_commission(futures=commission.PerContract(cost=200, exchange_fee=0))\n</code></pre> <p>\u53c3\u6578\u8aaa\u660e\uff1a</p> \u53c3\u6578 \u8aaa\u660e \u7bc4\u4f8b cost \u6bcf\u53e3\u624b\u7e8c\u8cbb (\u65b0\u53f0\u5e63) 200 exchange_fee \u4ea4\u6613\u6240\u8cbb\u7528 0 <p>\u5be6\u52d9\u5efa\u8b70</p> <p>\u53f0\u6307\u671f\u4e00\u822c\u5238\u5546\u624b\u7e8c\u8cbb\u7d04\u70ba\u6bcf\u53e3 50~200 \u5143\uff0c\u5efa\u8b70\u6839\u64da\u60a8\u7684\u5be6\u969b\u8cbb\u7387\u8a2d\u5b9a\u3002</p>"},{"location":"futures/futures-commission-slippage/#3","title":"3. \u6ed1\u50f9\u8a2d\u5b9a","text":""},{"location":"futures/futures-commission-slippage/#31-fixedslippage","title":"3.1 FixedSlippage \u6a21\u578b","text":"<p>\u671f\u8ca8\u6ed1\u50f9\u4f7f\u7528 FixedSlippage \u6a21\u578b\uff0c\u4ee5\u56fa\u5b9a\u9ede\u6578\u8a08\u7b97\uff1a</p> <pre><code>from zipline.api import set_slippage\nfrom zipline.finance import slippage\n\ndef initialize(context):\n    # \u8a2d\u5b9a\u671f\u8ca8\u6ed1\u50f9\uff1a\u6bcf\u6b21\u6210\u4ea4\u6ed1\u50f9 6 \u9ede\n    set_slippage(futures=slippage.FixedSlippage(spread=6))\n</code></pre> <p>\u53c3\u6578\u8aaa\u660e\uff1a</p> \u53c3\u6578 \u8aaa\u660e \u7bc4\u4f8b spread \u8cb7\u8ce3\u50f9\u5dee (\u9ede\u6578) 6 <p>\u6ed1\u50f9\u5f71\u97ff</p> <p>\u4ee5\u53f0\u6307\u671f\u70ba\u4f8b\uff0c\u6bcf\u9ede\u50f9\u503c\u7d04 200 \u5143\u3002\u82e5\u8a2d\u5b9a <code>spread=6</code>\uff0c\u5247\u6bcf\u6b21\u6210\u4ea4\u6703\u7522\u751f\u7d04 6 \u00d7 200 = 1,200 \u5143\u7684\u6ed1\u50f9\u6210\u672c\u3002</p>"},{"location":"futures/futures-commission-slippage/#4","title":"4. \u5b8c\u6574\u7bc4\u4f8b","text":"<pre><code>from zipline.api import (\n    continuous_future, set_commission, set_slippage, set_benchmark, symbol\n)\nfrom zipline.finance import commission, slippage\n\ndef initialize(context):\n    # \u8a2d\u5b9a\u8981\u4ea4\u6613\u7684\u671f\u8ca8\n    context.future = continuous_future('TX', offset=0, roll='calendar', adjustment='add')\n\n    # \u8a2d\u5b9a\u624b\u7e8c\u8cbb\uff1a\u6bcf\u53e3 200 \u5143\n    set_commission(futures=commission.PerContract(cost=200, exchange_fee=0))\n\n    # \u8a2d\u5b9a\u6ed1\u50f9\uff1a\u6bcf\u6b21\u6210\u4ea4\u6ed1\u50f9 6 \u9ede\n    set_slippage(futures=slippage.FixedSlippage(spread=6))\n\n    # \u8a2d\u5b9a\u7e3e\u6548\u57fa\u6e96\n    set_benchmark(symbol('IR0001'))\n</code></pre>"},{"location":"futures/futures-commission-slippage/#5-vs","title":"5. \u73fe\u8ca8 vs \u671f\u8ca8\u6210\u672c\u6a21\u578b\u6bd4\u8f03","text":"\u7279\u6027 \u73fe\u8ca8 \u671f\u8ca8 \u624b\u7e8c\u8cbb\u6a21\u578b PerShare / PerDollar PerContract \u6ed1\u50f9\u6a21\u578b VolumeShareSlippage FixedSlippage \u8a08\u7b97\u57fa\u790e \u80a1\u6578/\u91d1\u984d \u53e3\u6578/\u9ede\u6578"},{"location":"futures/futures-commission-slippage/#6","title":"6. \u5ef6\u4f38\u95b1\u8b80","text":"<ul> <li>\u5efa\u7acb\u4f60\u7684\u7b2c\u4e00\u500b\u671f\u8ca8\u7b56\u7565</li> <li>\u5982\u4f55\u8a2d\u5b9a\u624b\u7e8c\u8cbb\u6a21\u578b</li> <li>\u5982\u4f55\u8a2d\u5b9a\u6ed1\u50f9\u6a21\u578b</li> </ul>"},{"location":"futures/futures-index/","title":"\u671f\u8ca8\u5c08\u5340","text":"<p>Info</p> <p>\u672c\u5c08\u5340\u6db5\u84cb TQuant Lab \u671f\u8ca8\u56de\u6e2c\u76f8\u95dc\u7684\u6240\u6709\u5167\u5bb9\uff0c\u5f9e\u8cc7\u6599\u6e96\u5099\u5230\u7b56\u7565\u5be6\u4f5c\uff0c\u5e6b\u52a9\u60a8\u5feb\u901f\u4e0a\u624b\u671f\u8ca8\u91cf\u5316\u4ea4\u6613\u3002</p>"},{"location":"futures/futures-index/#1","title":"1. \u5c08\u5340\u5c0e\u89bd","text":"<ul> <li> <p> \u5feb\u901f\u5165\u9580</p> <p>\u5efa\u7acb\u60a8\u7684\u7b2c\u4e00\u500b\u671f\u8ca8\u7b56\u7565\uff0c\u5f9e\u96f6\u958b\u59cb\u5b78\u7fd2\u671f\u8ca8\u56de\u6e2c\u7684\u5b8c\u6574\u6d41\u7a0b\u3002</p> <p> \u958b\u59cb\u5b78\u7fd2</p> </li> <li> <p> \u8cc7\u6599\u6e96\u5099</p> <p>\u5b78\u7fd2\u5982\u4f55 Ingest \u671f\u8ca8\u50f9\u91cf\u8cc7\u6599\u5230 TQuant Lab \u672c\u5730\u8cc7\u6599\u5eab\u3002</p> <p> \u8cc7\u6599\u6307\u5357</p> </li> <li> <p> \u624b\u7e8c\u8cbb\u8207\u6ed1\u50f9</p> <p>\u4e86\u89e3\u671f\u8ca8\u5c08\u7528\u7684\u624b\u7e8c\u8cbb\u8207\u6ed1\u50f9\u6a21\u578b\u8a2d\u5b9a\u65b9\u5f0f\u3002</p> <p> \u6210\u672c\u8a2d\u5b9a</p> </li> <li> <p> \u8f49\u5009\u6a5f\u5236</p> <p>\u6df1\u5165\u7406\u89e3\u671f\u8ca8\u5408\u7d04\u5230\u671f\u8207\u8f49\u5009\u7684\u8655\u7406\u908f\u8f2f\u3002</p> <p> \u8f49\u5009\u8aaa\u660e</p> </li> </ul>"},{"location":"futures/futures-index/#2-vs","title":"2. \u671f\u8ca8 vs \u73fe\u8ca8\uff1a\u4e3b\u8981\u5dee\u7570","text":"\u7279\u6027 \u73fe\u8ca8 (Equity) \u671f\u8ca8 (Futures) \u8cc7\u6599\u5305 (Bundle) tquant tquant_future \u8cc7\u7522\u7269\u4ef6 symbol('2330') continuous_future('TX', ...) \u5408\u7d04\u5230\u671f \u7121 \u6709\uff0c\u9700\u8655\u7406\u8f49\u5009 \u4fdd\u8b49\u91d1 \u7121 \u6709\uff0c\u5f71\u97ff\u69d3\u687f \u624b\u7e8c\u8cbb\u985e\u578b PerShare / PerDollar PerContract"},{"location":"futures/futures-index/#3","title":"3. \u652f\u63f4\u7684\u671f\u8ca8\u5546\u54c1","text":"<p>TQuant Lab \u76ee\u524d\u652f\u63f4\u4ee5\u4e0b\u53f0\u7063\u671f\u8ca8\u5546\u54c1\uff1a</p> \u4ee3\u78bc \u540d\u7a31 \u8aaa\u660e TX \u53f0\u6307\u671f \u53f0\u7063\u52a0\u6b0a\u6307\u6578\u671f\u8ca8 MTX \u5c0f\u53f0\u6307 \u5c0f\u578b\u53f0\u6307\u671f\u8ca8 CDF \u53f0\u7a4d\u96fb\u671f \u53f0\u7a4d\u96fb\u500b\u80a1\u671f\u8ca8 DVF \u806f\u767c\u79d1\u671f \u806f\u767c\u79d1\u500b\u80a1\u671f\u8ca8 <p>\u6ce8\u610f\uff1a\u500b\u80a1\u671f\u8ca8\u4ee3\u78bc\u9700\u52a0\u4e0a F \u5f8c\u7db4\uff0c\u4f8b\u5982\u53f0\u7a4d\u96fb\u500b\u80a1\u671f\u70ba CDF\u3002</p>"},{"location":"futures/futures-index/#4","title":"4. \u5ef6\u4f38\u95b1\u8b80","text":"<ul> <li>Zipline \u5f15\u64ce\u6838\u5fc3\u6a5f\u5236</li> <li>\u5982\u4f55\u57f7\u884c\u4e00\u500b\u57fa\u672c\u7684\u56de\u6e2c</li> <li>\u5982\u4f55\u8a2d\u5b9a\u624b\u7e8c\u8cbb\u6a21\u578b</li> </ul>"},{"location":"futures/futures-rollover/","title":"\u671f\u8ca8\u8f49\u5009\u6a5f\u5236","text":"<p>Info</p> <p>\u672c\u6307\u5357\u6df1\u5165\u8aaa\u660e\u671f\u8ca8\u5408\u7d04\u5230\u671f\u8207\u8f49\u5009\u7684\u8655\u7406\u908f\u8f2f\uff0c\u5e6b\u52a9\u60a8\u7406\u89e3\u5982\u4f55\u5728 TQuant Lab \u4e2d\u6b63\u78ba\u8655\u7406\u671f\u8ca8\u63db\u6708\u3002</p>"},{"location":"futures/futures-rollover/#1","title":"1. \u4ec0\u9ebc\u662f\u8f49\u5009\uff1f","text":"<p>\u671f\u8ca8\u5408\u7d04\u6709\u5230\u671f\u65e5\uff0c\u4e0d\u50cf\u80a1\u7968\u53ef\u4ee5\u7121\u9650\u671f\u6301\u6709\u3002\u7576\u5408\u7d04\u5373\u5c07\u5230\u671f\u6642\uff0c\u5982\u679c\u60a8\u60f3\u7e7c\u7e8c\u6301\u6709\u90e8\u4f4d\uff0c\u5c31\u5fc5\u9808\uff1a</p> <ol> <li>\u5e73\u5009\uff1a\u5c07\u5373\u5c07\u5230\u671f\u7684\u820a\u5408\u7d04\u5e73\u5009</li> <li>\u958b\u65b0\u5009\uff1a\u5728\u65b0\u7684\u5408\u7d04\u4e0a\u5efa\u7acb\u76f8\u540c\u7684\u90e8\u4f4d</li> </ol> <p>\u9019\u500b\u904e\u7a0b\u7a31\u70ba\u300c\u8f49\u5009\u300d(Roll Over) \u6216\u300c\u63db\u6708\u300d\u3002</p>"},{"location":"futures/futures-rollover/#2-continuous-future","title":"2. \u9023\u7e8c\u5408\u7d04 (Continuous Future)","text":"<p>TQuant Lab \u4f7f\u7528 <code>continuous_future</code> \u7269\u4ef6\u4f86\u7c21\u5316\u671f\u8ca8\u7684\u8655\u7406\uff1a</p> <pre><code>from zipline.api import continuous_future\n\ndef initialize(context):\n    # \u5efa\u7acb\u53f0\u6307\u671f\u7684\u9023\u7e8c\u8fd1\u6708\u5408\u7d04\n    context.future = continuous_future(\n        'TX',           # \u671f\u8ca8\u6839\u4ee3\u78bc\n        offset=0,       # 0 = \u8fd1\u6708\u5408\u7d04\n        roll='calendar', # \u63db\u6708\u898f\u5247\n        adjustment='add' # \u50f9\u683c\u8abf\u6574\u65b9\u5f0f\n    )\n</code></pre>"},{"location":"futures/futures-rollover/#21","title":"2.1 \u53c3\u6578\u8aaa\u660e","text":"\u53c3\u6578 \u8aaa\u660e \u53ef\u9078\u503c root_symbol \u671f\u8ca8\u6839\u4ee3\u78bc TX, MTX, CDF \u7b49 offset \u5408\u7d04\u6708\u4efd\u504f\u79fb 0 (\u8fd1\u6708), 1 (\u6b21\u6708), 2 (\u5b63\u6708)... roll \u63db\u6708\u6642\u6a5f calendar (\u5230\u671f\u524d), volume (\u6210\u4ea4\u91cf) adjustment \u50f9\u683c\u8abf\u6574 add (\u52a0\u6cd5), mul (\u4e58\u6cd5), None"},{"location":"futures/futures-rollover/#3","title":"3. \u8f49\u5009\u908f\u8f2f\u5be6\u4f5c","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u500b\u5b8c\u6574\u7684\u8f49\u5009\u51fd\u6578\u5be6\u4f5c\uff1a</p> <pre><code>from zipline.api import order_target, get_open_orders, cancel_order\n\ndef roll_futures(context, data):\n    \"\"\"\n    \u6bcf\u65e5\u6536\u76e4\u6642\u6aa2\u67e5\u662f\u5426\u9700\u8981\u8f49\u5009\n    \"\"\"\n    for asset, pos in context.portfolio.positions.items():\n        # \u5ffd\u7565\u975e\u671f\u8ca8\u8cc7\u7522\u6216\u7a7a\u90e8\u4f4d\n        if pos.amount == 0:\n            continue\n\n        # \u6aa2\u67e5\u662f\u5426\u70ba\u671f\u8ca8\u5408\u7d04\n        if not hasattr(asset, 'auto_close_date') or asset.auto_close_date is None:\n            continue\n\n        # \u8a08\u7b97\u8ddd\u96e2\u5230\u671f\u65e5\u5929\u6578\n        days_to_auto_close = (asset.auto_close_date.date() - data.current_session.date()).days\n\n        # \u5982\u679c\u9084\u6709\u8d85\u904e 5 \u5929\uff0c\u4e0d\u9700\u8981\u8f49\u5009\n        if days_to_auto_close &gt; 5:\n            continue\n\n        # \u53d6\u5f97\u65b0\u7684\u76ee\u6a19\u5408\u7d04\n        new_contract = data.current(context.future, \"contract\")\n\n        # \u5982\u679c\u65b0\u820a\u5408\u7d04\u76f8\u540c\uff0c\u4e0d\u9700\u8981\u8f49\u5009\n        if new_contract == asset:\n            continue\n\n        # === \u57f7\u884c\u8f49\u5009 ===\n        print(f\"\u57f7\u884c\u8f49\u5009: {asset.symbol} \u2192 {new_contract.symbol}\")\n\n        # 1. \u53d6\u6d88\u820a\u5408\u7d04\u7684\u6240\u6709\u639b\u55ae\n        for order in get_open_orders(asset):\n            cancel_order(order.id)\n\n        # 2. \u5e73\u6389\u820a\u5009\u4f4d\n        order_target(asset, 0)\n\n        # 3. \u5efa\u7acb\u65b0\u5009\u4f4d (\u4fdd\u6301\u76f8\u540c\u53e3\u6578)\n        order_target(new_contract, pos.amount)\n</code></pre>"},{"location":"futures/futures-rollover/#4","title":"4. \u6392\u7a0b\u8f49\u5009\u6aa2\u67e5","text":"<p>\u5728 <code>initialize</code> \u4e2d\u8a2d\u5b9a\u6392\u7a0b\uff0c\u6bcf\u65e5\u6536\u76e4\u6642\u57f7\u884c\u8f49\u5009\u6aa2\u67e5\uff1a</p> <pre><code>from zipline.api import schedule_function, date_rules, time_rules\n\ndef initialize(context):\n    context.future = continuous_future('TX', offset=0, roll='calendar', adjustment='add')\n\n    # \u6bcf\u65e5\u6536\u76e4\u6642\u6aa2\u67e5\u662f\u5426\u9700\u8981\u8f49\u5009\n    schedule_function(\n        roll_futures,\n        date_rules.every_day(),\n        time_rules.market_close()\n    )\n</code></pre>"},{"location":"futures/futures-rollover/#5","title":"5. \u8f49\u5009\u6642\u6a5f\u9078\u64c7","text":"\u7b56\u7565 \u8aaa\u660e \u512a\u9ede \u7f3a\u9ede \u63d0\u524d 5 \u5929 \u5230\u671f\u524d 5 \u5929\u8f49\u5009 \u907f\u514d\u6d41\u52d5\u6027\u554f\u984c \u53ef\u80fd\u6709\u50f9\u5dee\u640d\u5931 \u5230\u671f\u524d 1 \u5929 \u6700\u5f8c\u4e00\u523b\u8f49\u5009 \u6700\u5927\u5316\u6301\u5009\u6642\u9593 \u6d41\u52d5\u6027\u98a8\u96aa \u4f9d\u6210\u4ea4\u91cf \u65b0\u5408\u7d04\u6210\u4ea4\u91cf\u8d85\u904e\u820a\u5408\u7d04\u6642\u8f49\u5009 \u6d41\u52d5\u6027\u6700\u4f73 \u5be6\u4f5c\u8f03\u8907\u96dc <p>\u5efa\u8b70</p> <p>\u5c0d\u65bc\u5927\u591a\u6578\u7b56\u7565\uff0c\u5efa\u8b70\u5728\u5230\u671f\u524d 3~5 \u5929\u57f7\u884c\u8f49\u5009\uff0c\u4ee5\u78ba\u4fdd\u8db3\u5920\u7684\u6d41\u52d5\u6027\u3002</p>"},{"location":"futures/futures-rollover/#6","title":"6. \u5e38\u898b\u554f\u984c","text":""},{"location":"futures/futures-rollover/#q","title":"Q: \u70ba\u4ec0\u9ebc\u8981\u53d6\u6d88\u820a\u5408\u7d04\u7684\u639b\u55ae\uff1f","text":"<p>A: \u56e0\u70ba\u820a\u5408\u7d04\u5373\u5c07\u5230\u671f\uff0c\u4efb\u4f55\u672a\u6210\u4ea4\u7684\u639b\u55ae\u90fd\u6703\u5931\u6548\u3002\u5982\u679c\u4e0d\u53d6\u6d88\uff0c\u53ef\u80fd\u9020\u6210\u7b56\u7565\u908f\u8f2f\u6df7\u4e82\u3002</p>"},{"location":"futures/futures-rollover/#q_1","title":"Q: \u8f49\u5009\u6703\u7522\u751f\u984d\u5916\u6210\u672c\u55ce\uff1f","text":"<p>A: \u662f\u7684\uff0c\u8f49\u5009\u7b49\u65bc\u57f7\u884c\u4e00\u6b21\u5e73\u5009\u548c\u4e00\u6b21\u958b\u5009\uff0c\u6703\u7522\u751f\u5169\u6b21\u624b\u7e8c\u8cbb\u548c\u6ed1\u50f9\u6210\u672c\u3002</p>"},{"location":"futures/futures-rollover/#q_2","title":"Q: \u5982\u4f55\u8655\u7406\u591a\u500b\u671f\u8ca8\u5546\u54c1\u7684\u8f49\u5009\uff1f","text":"<p>A: \u4e0a\u8ff0 <code>roll_futures</code> \u51fd\u6578\u6703\u904d\u6b77\u6240\u6709\u6301\u5009\uff0c\u81ea\u52d5\u8655\u7406\u6240\u6709\u671f\u8ca8\u5546\u54c1\u7684\u8f49\u5009\u3002</p>"},{"location":"futures/futures-rollover/#7","title":"7. \u5ef6\u4f38\u95b1\u8b80","text":"<ul> <li>\u5efa\u7acb\u4f60\u7684\u7b2c\u4e00\u500b\u671f\u8ca8\u7b56\u7565</li> <li>\u671f\u8ca8\u624b\u7e8c\u8cbb\u8207\u6ed1\u50f9\u8a2d\u5b9a</li> <li>Zipline \u5f15\u64ce\u6838\u5fc3\u6a5f\u5236</li> </ul>"},{"location":"futures/ingest-futures-pricing/","title":"\u5982\u4f55 Ingest \u671f\u8ca8\u50f9\u91cf\u8cc7\u6599","text":"<p>Info</p> <p>\u672c\u6307\u5357\u5c07\u5f15\u5c0e\u60a8\u5b8c\u6210\u5c07 TEJ \u671f\u8ca8\u8cc7\u6599\u4e0b\u8f09\u4e26\u6574\u5408\u81f3 TQuant Lab \u672c\u5730\u8cc7\u6599\u5eab\u7684\u5b8c\u6574\u6b65\u9a5f\u3002\u9019\u500b\u904e\u7a0b\u7a31\u70ba \"ingest\"\uff0c\u5b83\u662f\u9032\u884c\u4efb\u4f55\u56de\u6e2c\u524d\u6700\u57fa\u790e\u4e14\u5fc5\u8981\u7684\u7b2c\u4e00\u6b65\u3002</p>"},{"location":"futures/ingest-futures-pricing/#1-tej-api","title":"1. \u8a2d\u5b9a TEJ API \u91d1\u9470","text":"<p>\u9996\u5148\uff0c\u60a8\u5fc5\u9808\u63d0\u4f9b\u60a8\u7684 TEJ API \u91d1\u9470\uff0c\u4ee5\u4fbf TQuant Lab \u80fd\u5920\u5b58\u53d6 TEJ \u7684\u8cc7\u6599\u5eab\u3002\u6211\u5011\u900f\u904e\u8a2d\u5b9a\u74b0\u5883\u8b8a\u6578\u4f86\u5b8c\u6210\u6b64\u64cd\u4f5c\u3002</p> <p>\u8acb\u5c07 <code>'YOUR_KEY'</code> \u66ff\u63db\u6210\u60a8\u81ea\u5df1\u7684\u91d1\u9470\u3002</p> <pre><code>import os\n\n# \u586b\u5165\u60a8\u7684 TEJ API Key\nos.environ['TEJAPI_KEY'] = 'YOUR_KEY'\nos.environ['TEJAPI_BASE'] = 'https://api.tej.com.tw'\n</code></pre>"},{"location":"futures/ingest-futures-pricing/#2","title":"2. \u8a2d\u5b9a\u8981\u4e0b\u8f09\u7684\u5546\u54c1\u8207\u671f\u9593","text":"<p>\u63a5\u8457\uff0c\u60a8\u9700\u8981\u8a2d\u5b9a\u8981\u4e0b\u8f09\u7684\u671f\u8ca8\u5546\u54c1\u4ee3\u78bc (<code>future</code>)\u3001\u76f8\u95dc\u7684\u73fe\u8ca8/\u6307\u6578\u4ee3\u78bc (<code>ticker</code>)\uff0c\u4ee5\u53ca\u8cc7\u6599\u7684\u8d77\u8a16\u65e5\u671f (<code>mdate</code>)\u3002</p> <ul> <li><code>future</code>: \u6307\u5b9a\u4e00\u500b\u6216\u591a\u500b\u671f\u8ca8\u6839\u4ee3\u78bc (root symbol)\uff0c\u4ee5\u7a7a\u683c\u5206\u9694\u3002\u4f8b\u5982\uff1a<code>'TX'</code> (\u53f0\u6307\u671f), <code>'MTX'</code> (\u5c0f\u53f0\u6307)\u3002</li> <li><code>ticker</code>: \u6307\u5b9a\u76f8\u95dc\u7684\u73fe\u8ca8\u6a19\u7684\uff0c\u901a\u5e38\u7528\u65bc\u8a2d\u5b9a\u56de\u6e2c\u7684\u6bd4\u8f03\u57fa\u6e96 (benchmark)\u3002\u4f8b\u5982\uff1a<code>'IR0001'</code> (\u767c\u884c\u91cf\u52a0\u6b0a\u80a1\u50f9\u5831\u916c\u6307\u6578)\u3002</li> <li><code>mdate</code>: \u8a2d\u5b9a\u8cc7\u6599\u7684\u8d77\u8a16\u65e5\u671f\uff0c\u683c\u5f0f\u70ba <code>'YYYYMMDD YYYYMMDD'</code>\u3002</li> </ul> <p>\u500b\u80a1\u671f\u8ca8\u4ee3\u78bc</p> <p>\u5047\u5982\u60f3\u8981\u4e0b\u8f09\u500b\u80a1\u671f\u8ca8\u9700\u8981\u52a0 <code>F</code>\uff0c\u5982\u53f0\u7a4d\u96fb\u500b\u80a1\u671f\u70ba <code>CDF</code>\uff0c\u806f\u767c\u79d1\u70ba <code>DVF</code>\u3002</p> <pre><code># \u8a2d\u5b9a\u8981\u4e0b\u8f09\u7684\u671f\u8ca8\u5546\u54c1\nos.environ['future'] = 'TX MTX'\n\n# \u8a2d\u5b9a\u76f8\u95dc\u7684\u6307\u6578/\u80a1\u7968 (\u7528\u65bc benchmark)\nos.environ['ticker'] = 'IR0001'\n\n# \u8a2d\u5b9a\u4e0b\u8f09\u7684\u8d77\u8a16\u65e5\u671f\nos.environ['mdate'] = '20100101 20250930'\n</code></pre>"},{"location":"futures/ingest-futures-pricing/#3-ingest","title":"3. \u57f7\u884c Ingest \u547d\u4ee4","text":"<p>\u8a2d\u5b9a\u597d\u6240\u6709\u74b0\u5883\u8b8a\u6578\u5f8c\uff0c\u6700\u5f8c\u4e00\u6b65\u5c31\u662f\u57f7\u884c <code>zipline ingest</code> \u547d\u4ee4\u3002\u9019\u500b\u547d\u4ee4\u6703\u8b80\u53d6\u60a8\u525b\u624d\u8a2d\u5b9a\u7684\u74b0\u5883\u8b8a\u6578\uff0c\u5f9e TEJ \u8cc7\u6599\u5eab\u4e0b\u8f09\u6307\u5b9a\u7684\u8cc7\u6599\uff0c\u4e26\u5c07\u5176\u8f49\u63db\u3001\u5132\u5b58\u81f3 Zipline \u7684\u672c\u5730\u8cc7\u6599\u5eab\u4e2d\u3002</p> <ul> <li><code>-b tquant_future</code>: \u9019\u500b\u53c3\u6578\u6307\u5b9a\u4e86\u8981\u5beb\u5165\u7684\u8cc7\u6599\u5305 (bundle) \u540d\u7a31\u3002\u5728 TQuant Lab \u4e2d\uff0c\u671f\u8ca8\u8cc7\u6599\u56fa\u5b9a\u4f7f\u7528 <code>tquant_future</code> \u9019\u500b bundle\u3002</li> </ul> <pre><code>!zipline ingest -b tquant_future\n</code></pre> <p>\u57f7\u884c\u5f8c\uff0c\u60a8\u6703\u770b\u5230\u7cfb\u7d71\u958b\u59cb\u4e0b\u8f09\u4e26\u8655\u7406\u8cc7\u6599\u3002\u9019\u500b\u904e\u7a0b\u53ef\u80fd\u9700\u8981\u6578\u5206\u9418\uff0c\u5177\u9ad4\u6642\u9593\u53d6\u6c7a\u65bc\u60a8\u8acb\u6c42\u7684\u8cc7\u6599\u91cf\u5927\u5c0f\u3002</p>"},{"location":"futures/ingest-futures-pricing/#4","title":"4. \u5b8c\u6574\u7bc4\u4f8b","text":"<p>\u60a8\u53ef\u4ee5\u76f4\u63a5\u8907\u88fd\u4e0b\u65b9\u7684\u5b8c\u6574\u7a0b\u5f0f\u78bc\u5340\u584a\uff0c\u8cbc\u5230\u60a8\u7684 Notebook \u4e2d\u57f7\u884c\uff0c\u5373\u53ef\u4e00\u6b21\u6027\u5b8c\u6210\u671f\u8ca8\u8cc7\u6599\u7684 Ingest\u3002</p> <pre><code>import os\n\n# 1. \u8a2d\u5b9a\u91d1\u9470\nos.environ['TEJAPI_KEY'] = 'YOUR_KEY'\nos.environ['TEJAPI_BASE'] = 'https://api.tej.com.tw'\n\n# 2. \u8a2d\u5b9a\u5546\u54c1\u8207\u671f\u9593\nos.environ['future'] = 'TX MTX'  # \u4e0b\u8f09\u53f0\u6307\u671f\u8207\u5c0f\u53f0\u6307\nos.environ['ticker'] = 'IR0001'  # \u4e0b\u8f09\u52a0\u6b0a\u6307\u6578\u4f5c\u70ba benchmark\nos.environ['mdate'] = '20100101 20250930'\n\n# 3. \u57f7\u884c Ingest\n# \u6ce8\u610f\uff1a\u6b64\u547d\u4ee4\u50c5\u5728\u9996\u6b21\u4f7f\u7528\u6216\u9700\u8981\u66f4\u65b0\u8cc7\u6599\u6642\u57f7\u884c\n!zipline ingest -b tquant_future\n</code></pre>"},{"location":"futures/ingest-futures-pricing/#5","title":"5. \u4f55\u6642\u9700\u8981\u91cd\u65b0\u57f7\u884c\uff1f","text":"\u60c5\u5883 \u8aaa\u660e \u9996\u6b21\u8a2d\u5b9a\u74b0\u5883 \u5fc5\u9808\u57f7\u884c\u4e00\u6b21\u4ee5\u5efa\u7acb\u672c\u5730\u8cc7\u6599\u5eab \u589e\u52a0\u65b0\u7684\u671f\u8ca8\u5546\u54c1 \u4fee\u6539 os.environ['future'] \u5f8c\uff0c\u9700\u91cd\u65b0\u57f7\u884c \u5ef6\u9577\u8cc7\u6599\u671f\u9593 \u4fee\u6539 os.environ['mdate'] \u5f8c\uff0c\u9700\u91cd\u65b0\u57f7\u884c \u66f4\u65b0\u81f3\u6700\u65b0\u8cc7\u6599 \u5c07\u7d50\u675f\u65e5\u671f\u8a2d\u70ba\u7576\u524d\u65e5\u671f\u4e26\u91cd\u65b0\u57f7\u884c"},{"location":"futures/ingest-futures-pricing/#6","title":"6. \u5ef6\u4f38\u95b1\u8b80","text":"<ul> <li>\u5efa\u7acb\u4f60\u7684\u7b2c\u4e00\u500b\u671f\u8ca8\u7b56\u7565</li> <li>\u5982\u4f55 Ingest \u80a1\u7968\u50f9\u91cf\u8cc7\u6599</li> </ul>"},{"location":"how-to/installation/","title":"TQuant Lab \u5b89\u88dd\u6559\u5b78","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b TQuant Lab \u7684\u8a73\u7d30\u5b89\u88dd\u8207\u74b0\u5883\u8a2d\u5b9a\u6307\u5357\uff0c\u5305\u62ec\u7cfb\u7d71\u8981\u6c42\u3001\u591a\u7a2e\u5b89\u88dd\u65b9\u5f0f\uff08Docker\u3001Anaconda\u3001pip\uff09\u4ee5\u53ca\u9a57\u8b49\u548c\u66f4\u65b0\u65b9\u6cd5\u3002</p>"},{"location":"how-to/installation/#1","title":"1. \u4f7f\u7528\u7684\u5957\u4ef6\u8207\u74b0\u5883","text":"<ul> <li>Main package \uff1aZipline</li> <li>\u652f\u63f4 Python \u7248\u672c \uff1aPython 3.8 ~ 3.11\uff08 \u5efa\u8b70\u4f7f\u7528 Python 3.11 \uff09</li> <li>\u652f\u63f4\u4f5c\u696d\u7cfb\u7d71 \uff1aWindows OS \u6216 macOS</li> <li>\u5efa\u8b70 Pandas \u7248\u672c \uff1a1.5.3 \u6216 2.0.0\uff08\u9ad8\u65bc 2.0.0 \u53ef\u80fd\u6703\u6709\u672a\u9810\u671f\u932f\u8aa4\uff09</li> <li>\u5efa\u8b70 Numpy \u7248\u672c \uff1a1.23.5\uff08\u9ad8\u65bc 1.23.5 \u53ef\u80fd\u6703\u6709\u672a\u9810\u671f\u932f\u8aa4\uff09</li> </ul>"},{"location":"how-to/installation/#2-a-b","title":"2. \u5b89\u88dd\u65b9\u5f0f\uff08\u64c7\u4e00\u5373\u53ef\uff0c \u63a8\u85a6\u4f7f\u7528\u65b9\u6cd5 A \u6216 B \uff09","text":""},{"location":"how-to/installation/#21-docker-zipline-tej","title":"2.1. \u900f\u904e Docker \u5b89\u88dd zipline-tej\uff08 \u63a8\u85a6 \uff09","text":""},{"location":"how-to/installation/#211","title":"2.1.1. \u5148\u6c7a\u689d\u4ef6","text":"<ul> <li>\u5df2\u5b89\u88dd Docker Desktop</li> </ul>"},{"location":"how-to/installation/#212-dockerfile","title":"2.1.2. \u65b9\u6cd5\u4e00\uff1a\u4f7f\u7528\u672c\u5730 Dockerfile \u5efa\u69cb","text":"<pre><code># \u4e0b\u8f09 tquant_jupyter\uff08\u9069\u7528 Jupyter \u4f7f\u7528\uff09\n# \u4e0b\u8f09 tquant_bash\uff08\u9069\u7528\u6392\u7a0b\u4f7f\u7528\uff09\n\n# \u9032\u5165 Dockerfile \u6240\u5728\u76ee\u9304\ncd &lt;path_to_dockerfile&gt;\n\n# \u5efa\u7acb\u6620\u50cf\u6a94\ndocker build -f tquant_jupyter . -t \"tquant:latest\"\n</code></pre>"},{"location":"how-to/installation/#213-docker-hub","title":"2.1.3. \u65b9\u6cd5\u4e8c\uff1a\u76f4\u63a5\u5f9e Docker Hub \u4e0b\u8f09\uff08 \u63a8\u85a6 \uff09","text":""},{"location":"how-to/installation/#2131-docker-hub","title":"2.1.3.1. \u5f9e Docker Hub \u4e0b\u8f09\u6620\u50cf\u6a94","text":"<p>\u65bc\u7d42\u7aef\u6a5f\u8f38\u5165\u4ee5\u4e0b\u6307\u4ee4\uff1a <pre><code>docker pull tej87681088/tquant:latest\n</code></pre></p>"},{"location":"how-to/installation/#2132-volume","title":"2.1.3.2. \u5efa\u7acb\u4e00\u500b volume \u4ee5\u50b3\u8f38\u8cc7\u6599","text":"<p>\u65bc\u7d42\u7aef\u6a5f\u8f38\u5165\u4ee5\u4e0b\u6307\u4ee4\uff1a <pre><code>docker volume create data\n</code></pre></p>"},{"location":"how-to/installation/#2133-image-container","title":"2.1.3.3. \u900f\u904e Image \u5efa\u7acb Container \u4e26\u555f\u52d5","text":"<p>\u82e5\u900f\u904e\u65b9\u6cd5\u4e00\uff08Dockerfile\uff09\u4e0b\u8f09\uff1a <pre><code>docker run -v data:/app -p 8888:8888 --name tquant tquant\n</code></pre> \u82e5\u900f\u904e\u65b9\u6cd5\u4e8c\uff08Docker Hub\uff09\u4e0b\u8f09\uff1a <pre><code>docker run -v data:/app -p 8888:8888 --name tquant tej87681088/tquant\n</code></pre> \u6b64\u547d\u4ee4\u5c07\uff1a</p> <ul> <li>\u555f\u52d5\u4e00\u500b container</li> <li>\u5c07 container \u5167\u7684 8888 \u57e0 \u6620\u5c04\u81f3\u672c\u6a5f\u7684 8888 \u57e0</li> <li>\u5229\u7528 volume data \u8207\u672c\u6a5f\u9032\u884c\u8cc7\u6599\u4ea4\u63db</li> </ul> <p>\u82e5\u4e0d\u5e0c\u671b\u4fdd\u7559 container\uff0c\u8acb\u52a0\u4e0a <code>--rm</code> \u53c3\u6578\uff1a <pre><code>docker run --rm -v data:/app -p 8888:8888 --name tquant tej87681088/tquant\n</code></pre></p>"},{"location":"how-to/installation/#2134-jupyter","title":"2.1.3.4. \u958b\u59cb\u4f7f\u7528 Jupyter","text":"<p>\u555f\u52d5\u5f8c\uff0c\u7d42\u7aef\u6a5f\u6703\u986f\u793a\u985e\u4f3c\u4e0b\u5217\u7db2\u5740\uff1a</p> <p><pre><code>http://127.0.0.1:8888/tree?token=XXXXXXXXXXXXXXXX\n</code></pre> \u8907\u88fd\u4e26\u8cbc\u4e0a\u81f3\u700f\u89bd\u5668\uff0c\u5373\u53ef\u958b\u555f Jupyter Notebook \u4f7f\u7528\u4ecb\u9762\u3002</p>"},{"location":"how-to/installation/#2135-appendix","title":"2.1.3.5. \u9644\u9304 (Appendix)","text":"<p>\u82e5\u60f3\u4f7f\u7528\u4e4b\u524d\u5df2\u5275\u5efa\u904e\u7684\u4f46\u95dc\u9589\u7684container\u64cd\u4f5c\uff0c\u53ef\u900f\u904e\u4ee5\u4e0b\u6307\u4ee4\u53d6\u5f97\u7db2\u5740 <pre><code># \u67e5\u770b\u6240\u6709 Container\uff08\u5305\u542b\u95dc\u9589\u7684\uff09\ndocker ps -a\n\n# \u555f\u52d5\u6307\u5b9a Container\ndocker start &lt;CONTAINER_ID&gt;\n\n# \u67e5\u770b Container \u7d42\u7aef\u6a5f\u6700\u8fd1\u7684\u8f38\u51fa\uff08\u542b Jupyter token\uff09\ndocker logs --tail 3 &lt;CONTAINER_ID&gt;\n</code></pre></p>"},{"location":"how-to/installation/#22-anaconda-prompt-zipline-tej","title":"2.2. \u900f\u904e Anaconda Prompt \u4e00\u9375\u5b89\u88dd zipline-tej\uff08 \u63a8\u85a6 \uff09","text":""},{"location":"how-to/installation/#221","title":"2.2.1. \u4e0b\u8f09\u5957\u4ef6\u8a2d\u5b9a\u6a94","text":"<p>\u8acb\u5148\u4e0b\u8f09\u4ee5\u4e0b\u5c0d\u61c9\u4f5c\u696d\u7cfb\u7d71\u7684\u5b89\u88dd\u8a2d\u5b9a\u6a94\uff08<code>.yml</code> \u6a94\u6848\uff09\uff1a</p> <ul> <li>Windows \u7248\u672c\uff1azipline-tej.yml</li> <li>Mac \u7248\u672c\uff1azipline-tej_mac.yml</li> </ul> <p>\u5efa\u8b70\u4f7f\u7528\u865b\u64ec\u74b0\u5883</p> <p>\u6211\u5011\u5f37\u70c8\u63a8\u85a6\u4f7f\u7528\u865b\u64ec\u74b0\u5883\uff0c\u4ee5\u4fdd\u6301\u6bcf\u500b\u5c08\u6848\u7684\u7368\u7acb\u6027\u4e26\u907f\u514d\u5957\u4ef6\u7248\u672c\u885d\u7a81\u3002</p>"},{"location":"how-to/installation/#222","title":"2.2.2. \u4f7f\u7528\u8005\u64cd\u4f5c\u8aaa\u660e","text":""},{"location":"how-to/installation/#windows","title":"Windows \u4f7f\u7528\u8005","text":"<pre><code># \u5c07\u4e0b\u8f09\u597d\u7684 zipline-tej.yml \u6a94\u6848\u653e\u5230\u4e0b\u8f09\u8cc7\u6599\u593e\u5f8c\uff0c\u958b\u555f Anaconda Prompt \u4e26\u57f7\u884c\uff1a\n\ncd C:\\Users\\&lt;your_username&gt;\\Downloads\n\n# \u900f\u904e yml \u6a94\u5275\u5efa\u865b\u64ec\u74b0\u5883\u4e26\u5b89\u88dd\u5957\u4ef6\nconda env create -f zipline-tej.yml\n\n# \u555f\u7528\u865b\u64ec\u74b0\u5883\nconda activate zipline-tej\n</code></pre>"},{"location":"how-to/installation/#macos","title":"macOS \u4f7f\u7528\u8005","text":"<p><pre><code># \u5c07\u4e0b\u8f09\u597d\u7684 zipline-tej_mac.yml \u6a94\u6848\u653e\u5230\u4e0b\u8f09\u8cc7\u6599\u593e\u5f8c\uff0c\u958b\u555f\u7d42\u7aef\u6a5f\u4e26\u57f7\u884c\uff1a\n\ncd /Users/&lt;your_username&gt;\\Downloads\n\n# \u900f\u904e yml \u6a94\u5275\u5efa\u865b\u64ec\u74b0\u5883\nconda env create -f zipline-tej_mac.yml\n\n# \u555f\u7528\u865b\u64ec\u74b0\u5883\nconda activate zipline-tej\n</code></pre> \u81f3\u6b64\uff0c\u4fbf\u53ef\u958b\u59cb\u4f7f\u7528zipline-tej\u3002</p>"},{"location":"how-to/installation/#23-pip-install-zipline-tej","title":"2.3. \u76f4\u63a5\u900f\u904e pip install \u5b89\u88dd zipline-tej","text":"<p>\u6b64\u65b9\u5f0f\u5b89\u88dd zipline-tej \u53ef\u80fd\u6703\u51fa\u73fe\u672a\u9810\u671f\u932f\u8aa4</p> <p>\u5efa\u8b70\u9032\u968e\u4f7f\u7528\u8005\u63a1\u7528\u3002</p>"},{"location":"how-to/installation/#3-virtual-environment","title":"3. \u5efa\u8b70\u4f7f\u7528\u865b\u64ec\u74b0\u5883 (Virtual Environment)","text":"<p>\u70ba\u907f\u514d\u5957\u4ef6\u7248\u672c\u885d\u7a81\uff0c\u5efa\u8b70\u5148\u5efa\u7acb\u865b\u64ec\u74b0\u5883\u5f8c\u518d\u5b89\u88dd zipline-tej\u3002\u4ee5\u4e0b\u63d0\u4f9b\u5169\u7a2e\u5efa\u7acb\u65b9\u5f0f\uff08\u64c7\u4e00\u5373\u53ef\uff09\uff1a</p>"},{"location":"how-to/installation/#31-anaconda","title":"3.1. \u65b9\u6cd5\u4e00\uff1a\u4f7f\u7528 Anaconda \u6307\u4ee4\uff08 \u63a8\u85a6 \uff09","text":"<p>\u65bc Anaconda Prompt \u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4\uff1a</p> <pre><code># \u5efa\u7acb\u865b\u64ec\u74b0\u5883\uff08Python 3.11\uff09\n$ conda create -n &lt;env_name&gt; python=3.11\n\n# activate virtual env\n$ conda activate &lt;env_name&gt;\n\n# download packages\n$ pip install zipline-tej\n$ pip install notebook\n$ conda install -c conda-forge nb_conda_kernels\n</code></pre>"},{"location":"how-to/installation/#32-python","title":"3.2. \u65b9\u6cd5\u4e8c\uff1a\u900f\u904e Python \u539f\u751f\u6307\u4ee4","text":"<p>\u65bc CMD \u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4\uff1a</p> <pre><code># create virtual env\n$ python -m venv venv\n\n# activate virtual env\n$ venv\\Scripts\\activate.bat\n# download packages\n$ pip install zipline-tej\n$ pip install notebook\n</code></pre>"},{"location":"how-to/installation/#4-google-colab-zipline-tej","title":"4. \u65bc Google Colab \u4f7f\u7528 zipline-tej","text":"<p>\u82e5\u60a8\u4f7f\u7528 google colab\uff0c\u53ef\u4ee5\u76f4\u63a5\u57f7\u884c\u4ee5\u4e0b\u7a0b\u5f0f\u78bc\uff0c\u4e0b\u8f09 zipline-tej <pre><code>!pip install zipline-tej\n</code></pre> \u82e5\u6709\u4f7f\u7528Pyfolio\uff0c\u53ef\u4ee5\u4e00\u4f75\u57f7\u884c\u4e0b\u5217\u6307\u4ee4\u907f\u514d\u51fa\u73fe Warning <pre><code>import matplotlib\nimport matplotlib.font_manager as fm\n!wget -O MicrosoftJhengHei.ttf https://github.com/a7532ariel/ms-web/raw/master/Microsoft-JhengHei.ttf\n!wget -O ArialUnicodeMS.ttf https://github.com/texttechnologylab/DHd2019BoA/raw/master/fonts/Arial%20Unicode%20MS.TTF\n\nfm.fontManager.addfont('MicrosoftJhengHei.ttf')\nmatplotlib.rc('font', family='Microsoft Jheng Hei')\n\nmatplotlib.font_manager.fontManager.addfont('ArialUnicodeMS.ttf')\nmatplotlib.rc('font', family='Arial Unicode MS')\n</code></pre></p>"},{"location":"how-to/installation/#5-tquant-lab","title":"5. \u6aa2\u67e5\u8207\u66f4\u65b0 TQuant Lab","text":""},{"location":"how-to/installation/#51","title":"5.1. \u6aa2\u67e5\u7248\u672c","text":"<p>\u5b89\u88dd\u5b8c\u6210\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u6307\u4ee4\u6aa2\u67e5 <code>zipline-tej</code> \u7684\u7576\u524d\u7248\u672c\uff1a</p> <pre><code>!pip show zipline-tej\n</code></pre>"},{"location":"how-to/installation/#52","title":"5.2. \u66f4\u65b0\u81f3\u6700\u65b0\u7248\u672c","text":"<p>\u70ba\u78ba\u4fdd\u60a8\u4f7f\u7528\u7684\u662f\u6700\u65b0\u529f\u80fd\u8207\u4fee\u5fa9\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4\u66f4\u65b0 <code>zipline-tej</code>\uff1a</p> <pre><code>!pip install --upgrade zipline-tej\n</code></pre> <ul> <li>\u5b98\u65b9\u7248\u672c\u8cc7\u8a0a \uff1a\u60a8\u53ef\u4ee5\u5728 PyPI - zipline-tej \u9801\u9762\u67e5\u770b\u6700\u65b0\u7684\u7248\u672c\u8cc7\u8a0a\u3002</li> </ul>"},{"location":"how-to/backtest/run-algorithm/","title":"\u5982\u4f55\u57f7\u884c\u4e00\u500b\u57fa\u672c\u7684\u56de\u6e2c","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b\u5982\u4f55\u4f7f\u7528 <code>zipline.run_algorithm()</code> \u51fd\u6578\u57f7\u884c\u57fa\u672c\u7b56\u7565\u56de\u6e2c\u7684\u6307\u5357\uff0c\u5305\u62ec Zipline \u56de\u6e2c\u51fd\u6578\u67b6\u69cb\u3001\u4e3b\u8981\u53c3\u6578\u8aaa\u660e\u548c\u5b8c\u6574\u7684\u7bc4\u4f8b\u3002</p> <p>\u5728 TQuant Lab \u4e2d\uff0c\u57f7\u884c\u7b56\u7565\u56de\u6e2c\u7684\u6838\u5fc3\u662f <code>zipline.run_algorithm()</code> \u51fd\u6578\u3002\u9019\u500b\u51fd\u6578\u6574\u5408\u4e86\u6578\u64da\u52a0\u8f09\u3001\u7b56\u7565\u908f\u8f2f\u57f7\u884c\u4ee5\u53ca\u7e3e\u6548\u8a08\u7b97\u7b49\u6240\u6709\u6b65\u9a5f\uff0c\u662f\u60a8\u5c07\u7b56\u7565\u60f3\u6cd5\u8f49\u5316\u70ba\u56de\u6e2c\u7d50\u679c\u7684\u4e3b\u8981\u5165\u53e3\u3002</p>"},{"location":"how-to/backtest/run-algorithm/#1-zipline","title":"1. Zipline \u7684\u56de\u6e2c\u51fd\u6578\u67b6\u69cb","text":"<p>\u4e00\u500b\u6a19\u6e96\u7684 Zipline/TQuant Lab \u7b56\u7565\u8173\u672c\u4e3b\u8981\u7531\u4e09\u500b\u51fd\u6578\u69cb\u6210\uff0c\u5b83\u5011\u5b9a\u7fa9\u4e86\u56de\u6e2c\u7684\u5b8c\u6574\u751f\u547d\u9031\u671f\uff1a</p> <ol> <li> <p><code>initialize(context)</code></p> <ul> <li>\u57f7\u884c\u6642\u6a5f\uff1a\u5728\u56de\u6e2c\u958b\u59cb\u6642\u50c5\u57f7\u884c \u4e00\u6b21\u3002</li> <li>\u4e3b\u8981\u7528\u9014\uff1a\u9032\u884c\u6240\u6709\u521d\u59cb\u8a2d\u5b9a\u3002\u9019\u5305\u62ec\u8a2d\u5b9a Benchmark\u3001\u8a2d\u5b9a\u624b\u7e8c\u8cbb/\u6ed1\u50f9\u6a21\u578b\u3001\u5b9a\u7fa9\u8981\u4ea4\u6613\u7684\u8cc7\u7522\uff0c\u4ee5\u53ca\u521d\u59cb\u5316\u60a8\u60f3\u5728\u6574\u500b\u7b56\u7565\u4e2d\u8ffd\u8e64\u7684\u8b8a\u6578\u3002</li> </ul> </li> <li> <p><code>handle_data(context, data)</code></p> <ul> <li>\u57f7\u884c\u6642\u6a5f\uff1a\u5728\u56de\u6e2c\u7684\u6bcf\u500b\u6642\u9593\u55ae\u4f4d\uff08\u4f8b\u5982\uff0c\u6bcf\u65e5\u6216\u6bcf\u5206\u9418\uff09\u90fd\u6703\u88ab\u547c\u53eb\u3002</li> <li>\u4e3b\u8981\u7528\u9014\uff1a\u9019\u662f\u7b56\u7565\u7684\u6838\u5fc3\u908f\u8f2f\u6240\u5728\u3002\u60a8\u6703\u5728\u9019\u500b\u51fd\u6578\u4e2d\u6aa2\u67e5\u5e02\u5834\u6578\u64da (<code>data</code>)\u3001\u5224\u65b7\u4ea4\u6613\u4fe1\u865f\u3001\u4e26\u4e0b\u9054\u8cb7\u8ce3\u8a02\u55ae\u3002<code>context</code> \u7269\u4ef6\u5247\u7528\u65bc\u5728\u4e0d\u540c\u6642\u9593\u9ede\u4e4b\u9593\u50b3\u905e\u72c0\u614b\u3002</li> </ul> </li> <li> <p><code>analyze(context, results)</code></p> <ul> <li>\u57f7\u884c\u6642\u6a5f\uff1a\u5728\u56de\u6e2c\u7d50\u675f\u5f8c\u50c5\u57f7\u884c \u4e00\u6b21\u3002</li> <li>\u4e3b\u8981\u7528\u9014\uff1a\u5c0d\u56de\u6e2c\u7d50\u679c\u9032\u884c\u5206\u6790\u8207\u8996\u89ba\u5316\u3002<code>results</code> \u53c3\u6578\u662f\u4e00\u500b\u5305\u542b\u4e86\u6bcf\u65e5\u7e3e\u6548\u6307\u6a19\u7684 <code>pandas.DataFrame</code>\uff0c\u60a8\u53ef\u4ee5\u5229\u7528\u5b83\u4f86\u7e6a\u88fd\u5716\u8868\u6216\u8a08\u7b97\u81ea\u5b9a\u7fa9\u7684\u7d71\u8a08\u6578\u64da\u3002</li> </ul> </li> </ol>"},{"location":"how-to/backtest/run-algorithm/#2-run_algorithm","title":"2. run_algorithm() \u51fd\u6578","text":"<p>\u7576\u60a8\u5b9a\u7fa9\u597d\u4e0a\u8ff0\u4e09\u500b\u51fd\u6578\u5f8c\uff0c\u5c31\u53ef\u4ee5\u5c07\u5b83\u5011\u50b3\u905e\u7d66 <code>run_algorithm()</code> \u4f86\u555f\u52d5\u56de\u6e2c\u3002</p>"},{"location":"how-to/backtest/run-algorithm/#_2","title":"\u4e3b\u8981\u53c3\u6578\uff1a","text":"<ul> <li><code>start</code>: (<code>pd.Timestamp</code>) \u56de\u6e2c\u7684\u8d77\u59cb\u65e5\u671f\u3002</li> <li><code>end</code>: (<code>pd.Timestamp</code>) \u56de\u6e2c\u7684\u7d50\u675f\u65e5\u671f\u3002</li> <li><code>initialize</code>: (\u51fd\u6578) \u4e0a\u8ff0\u7684 <code>initialize</code> \u51fd\u6578\u3002</li> <li><code>handle_data</code>: (\u51fd\u6578) \u4e0a\u8ff0\u7684 <code>handle_data</code> \u51fd\u6578\u3002</li> <li><code>analyze</code>: (\u51fd\u6578, \u53ef\u9078) \u4e0a\u8ff0\u7684 <code>analyze</code> \u51fd\u6578\u3002</li> <li><code>capital_base</code>: (<code>float</code>) \u521d\u59cb\u8cc7\u91d1\u3002</li> <li><code>bundle</code>: (<code>str</code>) \u8981\u4f7f\u7528\u7684\u8cc7\u6599\u5305\u540d\u7a31\uff0c\u4f8b\u5982 <code>'tquant'</code>\u3002</li> </ul>"},{"location":"how-to/backtest/run-algorithm/#3","title":"3. \u57fa\u672c\u56de\u6e2c\u7bc4\u4f8b\uff1a\u8cb7\u5165\u4e26\u6301\u6709","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u500b\u5b8c\u6574\u7684\u300c\u8cb7\u5165\u4e26\u6301\u6709\u53f0\u7a4d\u96fb (2330)\u300d\u7b56\u7565\uff0c\u5b83\u6f14\u793a\u4e86\u5982\u4f55\u7d44\u7e54\u4e26\u57f7\u884c\u4e00\u500b\u57fa\u672c\u7684\u56de\u6e2c\u3002</p> <p>Tip</p> <p>\u5728\u57f7\u884c\u6b64\u7bc4\u4f8b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u7d93\u4f7f\u7528 <code>zipline ingest -b tquant</code> \u532f\u5165\u4e86\u50f9\u91cf\u8cc7\u6599\uff0c\u4e26\u4e14\u8cc7\u6599\u7bc4\u570d\u6db5\u84cb\u4e86\u56de\u6e2c\u671f\u9593\u3002\u8a73\u898b\uff1a\u532f\u5165\u50f9\u91cf\u8cc7\u6599\u6307\u5357</p> <pre><code>import pandas as pd\nfrom zipline import run_algorithm\nfrom zipline.api import (\n    set_benchmark,\n    symbol,\n    order_target_percent,\n    record\n)\nimport matplotlib.pyplot as plt\n\n# 1. \u521d\u59cb\u5316\u51fd\u6578\ndef initialize(context):\n    \"\"\"\n    \u56de\u6e2c\u958b\u59cb\u524d\u50c5\u57f7\u884c\u4e00\u6b21\u3002\n    \"\"\"\n    # \u8a2d\u5b9a\u8981\u4ea4\u6613\u7684\u80a1\u7968\n    context.asset = symbol('2330')\n\n    # \u8a2d\u5b9a Benchmark\n    set_benchmark(symbol('IR0001'))\n\n    # \u7528\u65bc\u5224\u65b7\u662f\u5426\u5df2\u4e0b\u55ae\u7684\u65d7\u6a19\n    context.has_ordered = False\n\n# 2. \u6838\u5fc3\u4ea4\u6613\u908f\u8f2f\u51fd\u6578\ndef handle_data(context, data):\n    \"\"\"\n    \u6bcf\u500b\u4ea4\u6613\u65e5\u90fd\u6703\u88ab\u547c\u53eb\u3002\n    \"\"\"\n    # \u5982\u679c\u5c1a\u672a\u4e0b\u55ae\uff0c\u5247\u4e0b\u55ae\u4e00\u6b21\n    if not context.has_ordered:\n        # \u5c07 100% \u7684\u8cc7\u91d1\u8cb7\u5165 context.asset (2330)\n        order_target_percent(context.asset, 1.0)\n\n        # \u5c07\u65d7\u6a19\u8a2d\u70ba True\uff0c\u78ba\u4fdd\u4e4b\u5f8c\u4e0d\u518d\u91cd\u8907\u4e0b\u55ae\n        context.has_ordered = True\n\n    # \u8a18\u9304\u6bcf\u65e5\u7684\u80a1\u50f9\uff0c\u65b9\u4fbf\u5f8c\u7e8c\u7e6a\u5716\n    record(price=data.current(context.asset, 'price'))\n\n# 3. \u56de\u6e2c\u7d50\u675f\u5f8c\u7684\u5206\u6790\u51fd\u6578\ndef analyze(context, results):\n    \"\"\"\n    \u56de\u6e2c\u7d50\u675f\u5f8c\u57f7\u884c\u4e00\u6b21\u3002\n    \"\"\"\n    fig, axes = plt.subplots(2, 1, figsize=(12, 10), sharex=True)\n\n    # \u7e6a\u88fd\u6295\u8cc7\u7d44\u5408\u50f9\u503c\n    results['portfolio_value'].plot(ax=axes[0])\n    axes[0].set_title('Portfolio Value')\n\n    # \u7e6a\u88fd\u80a1\u50f9\n    results['price'].plot(ax=axes[1])\n    axes[1].set_title(f'{context.asset.symbol} Price')\n\n    plt.tight_layout()\n    plt.show()\n\n# 4. \u57f7\u884c\u56de\u6e2c\nresults = run_algorithm(\n    start=pd.Timestamp('2022-01-01', tz='UTC'),\n    end=pd.Timestamp('2023-01-01', tz='UTC'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    capital_base=1_000_000,\n    bundle='tquant'\n)\n</code></pre>"},{"location":"how-to/backtest/set-commission/","title":"\u64cd\u4f5c\u6307\u5357\uff1a\u5982\u4f55\u8a2d\u5b9a\u624b\u7e8c\u8cbb (How-to: Set Commission)","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b\u5982\u4f55\u4f7f\u7528 <code>set_commission()</code> \u51fd\u6578\u5728 Zipline \u56de\u6e2c\u4e2d\u8a2d\u5b9a\u4ea4\u6613\u624b\u7e8c\u8cbb\u7684\u8a73\u7d30\u6307\u5357\uff0c\u5305\u62ec\u671f\u8ca8\u3001\u80a1\u7968\u7684\u57fa\u790e\u8a08\u8cbb\u6a21\u578b\uff0c\u4ee5\u53ca\u91dd\u5c0d\u53f0\u80a1\u7279\u6b8a\u7a05\u5236\u7684\u81ea\u5b9a\u7fa9\u6a21\u578b\u5be6\u4f5c\u3002</p>"},{"location":"how-to/backtest/set-commission/#_1","title":"\u76ee\u6a19","text":"<p>\u5728\u9032\u884c\u4efb\u4f55\u5be6\u969b\u7684\u56de\u6e2c\u6642\uff0c\u7d0d\u5165\u4ea4\u6613\u6210\u672c\uff08\u5982\u624b\u7e8c\u8cbb\u3001\u8b49\u4ea4\u7a05\uff09\u662f\u8a55\u4f30\u7b56\u7565\u771f\u5be6\u8868\u73fe\u7684\u95dc\u9375\u4e00\u6b65\u3002\u82e5\u5ffd\u7565\u4ea4\u6613\u6210\u672c\uff0c\u6703\u5c0e\u81f4\u56de\u6e2c\u7e3e\u6548\u904e\u65bc\u6a02\u89c0\uff0c\u5f9e\u800c\u7522\u751f\u8aa4\u5224\u3002</p> <p>\u672c\u6307\u5357\u5c07\u8aaa\u660e\u5982\u4f55\u5728 TQuant Lab (Zipline) \u4e2d\u4f7f\u7528 <code>set_commission</code> \u51fd\u6578\uff0c\u5305\u542b\u57fa\u790e\u8a2d\u5b9a\u4ee5\u53ca\u91dd\u5c0d\u53f0\u80a1\u7279\u6b8a\u7a05\u5236\uff08\u8ce3\u51fa\u624d\u6536\u7a05\u3001\u6709\u4f4e\u6d88\uff09\u7684\u9032\u968e\u81ea\u5b9a\u7fa9\u6a21\u578b\u3002</p>"},{"location":"how-to/backtest/set-commission/#set_commission","title":"\u6838\u5fc3\u51fd\u6578\uff1a<code>set_commission()</code>","text":"<p><code>set_commission()</code> \u662f Zipline \u4e2d\u7528\u4f86\u5b9a\u7fa9\u4ea4\u6613\u8cbb\u7528\u7684\u6838\u5fc3\u51fd\u6578\uff0c\u5b83\u5fc5\u9808\u5728 <code>initialize</code> \u51fd\u6578\u4e2d\u88ab\u547c\u53eb\u3002</p> <p>\u9019\u500b\u51fd\u6578\u7684\u4e3b\u8981\u53c3\u6578\u662f <code>futures</code> \u548c <code>equities</code>\uff0c\u60a8\u53ef\u4ee5\u5206\u5225\u70ba\u9019\u5169\u985e\u8cc7\u7522\u50b3\u5165\u4e0d\u540c\u7684\u8cbb\u7528\u6a21\u578b\u7269\u4ef6\u3002</p> <pre><code>from zipline.api import set_commission\nfrom zipline.finance import commission\n\ndef initialize(context):\n    # \u5728\u6b64\u8655\u547c\u53eb set_commission \u51fd\u6578\n    # ...\n</code></pre>"},{"location":"how-to/backtest/set-commission/#_2","title":"\u60c5\u5883\u4e00\uff1a\u8a2d\u5b9a\u671f\u8ca8\u624b\u7e8c\u8cbb (\u57fa\u790e)","text":"<p>\u5c0d\u65bc\u671f\u8ca8\u4ea4\u6613\uff0c\u6700\u5e38\u898b\u7684\u8a08\u8cbb\u65b9\u5f0f\u662f \u6309\u53e3\u6578 (Per Contract)  \u6536\u53d6\u56fa\u5b9a\u8cbb\u7528\u3002</p> <ul> <li>\u6a21\u578b : <code>commission.PerContract()</code></li> <li>\u4e3b\u8981\u53c3\u6578 :<ul> <li><code>cost</code>: \u6bcf\u53e3\u55ae\u908a\u4ea4\u6613\u7684\u624b\u7e8c\u8cbb\u91d1\u984d\u3002</li> <li><code>exchange_fee</code>: \u4ea4\u6613\u6240\u8cbb\u7528\uff0c\u53ef\u9078\u586b\u3002</li> </ul> </li> </ul>"},{"location":"how-to/backtest/set-commission/#_3","title":"\u7bc4\u4f8b\uff1a","text":"<p>\u5047\u8a2d\u53f0\u6307\u671f\u8ca8\u6bcf\u53e3\u55ae\u908a\u624b\u7e8c\u8cbb\u70ba 200 \u5143\uff1a</p> <pre><code># \u5728 initialize \u51fd\u6578\u4e2d\nfrom zipline.finance import commission\n\nset_commission(futures=commission.PerContract(cost=200, exchange_fee=0))\n</code></pre> <p>\u9019\u884c\u7a0b\u5f0f\u78bc\u6703\u544a\u8a34\u56de\u6e2c\u5f15\u64ce\uff0c\u6bcf\u4e00\u6b21\u8cb7\u5165\u6216\u8ce3\u51fa\u4e00\u53e3\u671f\u8ca8\uff0c\u90fd\u8981\u5f9e\u5e33\u6236\u4e2d\u6263\u9664 200 \u5143\u7684\u8cbb\u7528\u3002</p>"},{"location":"how-to/backtest/set-commission/#_4","title":"\u60c5\u5883\u4e8c\uff1a\u8a2d\u5b9a\u80a1\u7968\u624b\u7e8c\u8cbb (\u57fa\u790e)","text":"<p>\u5c0d\u65bc\u80a1\u7968\u4ea4\u6613\uff0c\u82e5\u4e0d\u8003\u616e\u7a05\u5236\u5dee\u7570\uff0c\u57fa\u790e\u8a08\u8cbb\u65b9\u5f0f\u662f \u6309\u6210\u4ea4\u91d1\u984d\u7684\u767e\u5206\u6bd4 (Per Dollar) \u6536\u53d6\u3002</p> <ul> <li>\u6a21\u578b : <code>commission.PerDollar()</code></li> <li>\u4e3b\u8981\u53c3\u6578 :<ul> <li><code>cost</code>: \u624b\u7e8c\u8cbb\u4f54\u6210\u4ea4\u91d1\u984d\u7684\u6bd4\u4f8b\u3002\u4f8b\u5982\uff0c\u5238\u5546\u624b\u7e8c\u8cbb\u70ba 0.1425%\uff0c\u5247 <code>cost</code> \u61c9\u8a2d\u70ba <code>0.001425</code>\u3002</li> </ul> </li> </ul>"},{"location":"how-to/backtest/set-commission/#_5","title":"\u7bc4\u4f8b\uff1a","text":"<p>\u5047\u8a2d\u80a1\u7968\u4ea4\u6613\u624b\u7e8c\u8cbb\u70ba\u6210\u4ea4\u91d1\u984d\u7684 0.1425%\uff1a</p> <pre><code># \u5728 initialize \u51fd\u6578\u4e2d\nfrom zipline.finance import commission\n\nset_commission(equities=commission.PerDollar(cost=0.001425))\n</code></pre>"},{"location":"how-to/backtest/set-commission/#custom-commission-model","title":"\u9032\u968e\u7528\u6cd5\uff1a\u81ea\u5b9a\u7fa9\u624b\u7e8c\u8cbb\u6a21\u578b (Custom Commission Model)","text":""},{"location":"how-to/backtest/set-commission/#_6","title":"\u70ba\u4f55\u9700\u8981\u81ea\u5b9a\u7fa9\uff1f","text":"<p>Zipline \u5167\u5efa\u7684 <code>PerDollar</code> \u6a21\u578b\u5047\u8a2d\u8cb7\u9032\u8207\u8ce3\u51fa\u7684\u8cbb\u7387\u662f\u76f8\u540c\u7684\u3002\u7136\u800c\uff0c\u5728 \u53f0\u80a1\u73fe\u8ca8 \u4ea4\u6613\u4e2d\uff0c\u898f\u5247\u901a\u5e38\u8f03\u70ba\u8907\u96dc\uff1a 1.   \u8b49\u4ea4\u7a05 : \u53ea\u6709\u5728 \u8ce3\u51fa \u6642\u624d\u6536\u53d6\uff08\u901a\u5e38\u70ba 0.3%\uff09\u3002 2.   \u6700\u4f4e\u624b\u7e8c\u8cbb : \u5238\u5546\u901a\u5e38\u8a2d\u6709\u55ae\u7b46\u6700\u4f4e\u624b\u7e8c\u8cbb\uff08\u4f8b\u5982 20 \u5143\uff09\u3002</p> <p>\u70ba\u4e86\u7cbe\u78ba\u6a21\u64ec\u9019\u4e9b\u898f\u5247\uff0c\u6211\u5011\u9700\u8981\u900f\u904e\u7e7c\u627f <code>CommissionModel</code> \u4f86\u64b0\u5beb\u81ea\u5df1\u7684\u8cbb\u7528\u908f\u8f2f\u3002</p>"},{"location":"how-to/backtest/set-commission/#_7","title":"\u5be6\u4f5c\u6b65\u9a5f","text":"<ol> <li>\u5b9a\u7fa9\u985e\u5225 : \u5efa\u7acb\u4e00\u500b\u65b0\u985e\u5225\u4e26\u7e7c\u627f <code>zipline.finance.commission.CommissionModel</code>\u3002</li> <li>\u5be6\u4f5c <code>calculate</code> \u65b9\u6cd5 : \u9019\u662f\u8a08\u7b97\u8cbb\u7528\u7684\u6838\u5fc3\uff0cZipline \u6703\u5728\u6bcf\u7b46\u6210\u4ea4\u6642\u547c\u53eb\u6b64\u65b9\u6cd5\uff0c\u4e26\u50b3\u5165\u8a02\u55ae (<code>order</code>) \u8207\u6210\u4ea4\u8cc7\u8a0a (<code>transaction</code>)\u3002</li> </ol>"},{"location":"how-to/backtest/set-commission/#_8","title":"\u7bc4\u4f8b\u7a0b\u5f0f\u78bc\uff1a\u53f0\u80a1\u5c08\u7528\u6a21\u578b","text":"<p>\u4ee5\u4e0b\u7bc4\u4f8b\u5c55\u793a\u4e86\u5982\u4f55\u5efa\u7acb\u4e00\u500b\u7b26\u5408\u53f0\u80a1\u898f\u5247\uff08\u542b\u8b49\u4ea4\u7a05\u8207\u4f4e\u6d88\uff09\u7684\u6a21\u578b\u3002</p> <pre><code>from zipline.api import set_commission\nfrom zipline.finance.commission import CommissionModel\n\n# 1. \u5b9a\u7fa9\u81ea\u5b9a\u7fa9\u6a21\u578b\u985e\u5225\nclass TaiwanStockCommission(CommissionModel):\n    \"\"\"\n    \u5ba2\u88fd\u5316\u53f0\u80a1\u624b\u7e8c\u8cbb\u6a21\u578b\uff1a\n    - \u8cb7\u9032: \u50c5\u6536\u624b\u7e8c\u8cbb (\u9810\u8a2d 0.1425%)\n    - \u8ce3\u51fa: \u624b\u7e8c\u8cbb + \u8b49\u4ea4\u7a05 (\u9810\u8a2d 0.3%)\n    - \u6700\u4f4e\u624b\u7e8c\u8cbb: \u9810\u8a2d 20 \u5143 (\u91dd\u5c0d\u624b\u7e8c\u8cbb\u90e8\u5206)\n    \"\"\"\n    def __init__(self, cost=0.001425, tax=0.003, min_cost=20):\n        self.cost = cost\n        self.tax = tax\n        self.min_cost = min_cost\n\n    def calculate(self, order, transaction):\n        \"\"\"\n        \u8a08\u7b97\u55ae\u7b46\u6210\u4ea4\u7684\u8cbb\u7528\n        :param order: \u8a02\u55ae\u7269\u4ef6\n        :param transaction: \u6210\u4ea4\u8cc7\u8a0a\u7269\u4ef6 (\u5305\u542b amount, price)\n        \"\"\"\n        # \u8a08\u7b97\u6210\u4ea4\u91d1\u984d (\u53d6\u7d55\u5c0d\u503c\uff0c\u56e0\u70ba\u8ce3\u51fa\u7684 amount \u70ba\u8ca0\u6578)\n        trade_value = abs(transaction.amount * transaction.price)\n\n        # A. \u8a08\u7b97\u57fa\u790e\u624b\u7e8c\u8cbb\n        execution_cost = trade_value * self.cost\n\n        # B. \u8655\u7406\u6700\u4f4e\u624b\u7e8c\u8cbb (\u4f4e\u6d88)\n        if execution_cost &lt; self.min_cost:\n            execution_cost = self.min_cost\n\n        # C. \u5224\u65b7\u662f\u5426\u70ba\u8ce3\u51fa (amount &lt; 0 \u4ee3\u8868\u8ce3\u51fa)\n        # \u82e5\u662f\u8ce3\u51fa\uff0c\u9700\u984d\u5916\u52a0\u4e0a\u8b49\u4ea4\u7a05 (\u8b49\u4ea4\u7a05\u6c92\u6709\u4f4e\u6d88\u9650\u5236)\n        if transaction.amount &lt; 0:\n            execution_cost += trade_value * self.tax\n\n        return execution_cost\n\n# 2. \u5728 initialize \u4e2d\u4f7f\u7528\ndef initialize(context):\n    # \u5c07\u80a1\u7968\u7684\u624b\u7e8c\u8cbb\u6a21\u578b\u8a2d\u5b9a\u70ba\u6211\u5011\u81ea\u5b9a\u7fa9\u7684\u985e\u5225\n    set_commission(equities=TaiwanStockCommission(cost=0.001425, tax=0.003))\n\n    # \u671f\u8ca8\u4ecd\u53ef\u7dad\u6301\u5167\u5efa\u7684\u56fa\u5b9a\u8cbb\u7528\u6a21\u578b\n    # set_commission(futures=commission.PerContract(cost=200))\n</code></pre>"},{"location":"how-to/backtest/set-commission/#transaction","title":"\u53c3\u6578\u89e3\u8aaa (<code>transaction</code> \u7269\u4ef6)","text":"<p>\u5728 <code>calculate</code> \u65b9\u6cd5\u4e2d\uff0c<code>transaction</code> \u7269\u4ef6\u5305\u542b\u4e86\u8a72\u7b46\u6210\u4ea4\u7684\u95dc\u9375\u8cc7\u8a0a\uff1a -   <code>transaction.amount</code>: \u6210\u4ea4\u80a1\u6578\u3002 \u6b63\u6578\u70ba\u8cb7\u5165\uff0c\u8ca0\u6578\u70ba\u8ce3\u51fa \u3002 -   <code>transaction.price</code>: \u6210\u4ea4\u50f9\u683c\u3002</p> <p>\u900f\u904e\u5224\u65b7 <code>transaction.amount</code> \u7684\u6b63\u8ca0\u865f\uff0c\u6211\u5011\u5c31\u80fd\u8f15\u6613\u5340\u5206\u8cb7\u8ce3\u65b9\u5411\uff0c\u4e26\u9069\u7528\u4e0d\u540c\u7684\u7a05\u7387\u3002</p>"},{"location":"how-to/backtest/set-commission/#initialize","title":"\u5b8c\u6574 <code>initialize</code> \u6574\u5408\u7bc4\u4f8b","text":"<p>\u5728\u4e00\u500b\u540c\u6642\u4ea4\u6613\u80a1\u7968\u548c\u671f\u8ca8\u7684\u7b56\u7565\u4e2d\uff0c\u60a8\u53ef\u4ee5\u540c\u6642\u8a2d\u5b9a\u5169\u8005\u7684\u624b\u7e8c\u8cbb\u6a21\u578b\u3002</p> <pre><code>from zipline.api import set_commission, set_slippage\nfrom zipline.finance import commission, slippage\n\n# (\u5047\u8a2d TaiwanStockCommission \u985e\u5225\u5df2\u5b9a\u7fa9\u5728\u4e0a\u65b9)\n\ndef initialize(context):\n    # ... \u5176\u4ed6\u8a2d\u5b9a ...\n\n    # 1. \u8a2d\u5b9a\u671f\u8ca8\u4ea4\u6613\u6210\u672c\uff1a\u6bcf\u53e3\u56fa\u5b9a 200 \u5143\n    set_commission(futures=commission.PerContract(cost=200))\n\n    # 2. \u8a2d\u5b9a\u80a1\u7968\u4ea4\u6613\u6210\u672c\uff1a\u4f7f\u7528\u81ea\u5b9a\u7fa9\u53f0\u80a1\u6a21\u578b (\u8cb7\u9032\u624b\u7e8c\u8cbb\uff0c\u8ce3\u51fa\u542b\u7a05)\n    set_commission(equities=TaiwanStockCommission(cost=0.001425, tax=0.003))\n\n    # 3. \u8a2d\u5b9a\u6ed1\u50f9\u6a21\u578b (\u9078\u7528)\n    # VolumeShareSlippage: \u9650\u5236\u6210\u4ea4\u91cf\u4e0d\u8d85\u904e\u7576\u65e5\u7684 2.5%\n    set_slippage(slippage.VolumeShareSlippage(volume_limit=0.025, price_impact=0.1))\n\n    # ... \u5176\u4ed6\u8a2d\u5b9a ...\n</code></pre>"},{"location":"how-to/backtest/set-commission/#_9","title":"\u7e3d\u7d50","text":"<ul> <li>\u5728 <code>initialize</code> \u51fd\u6578\u4e2d\u4f7f\u7528 <code>set_commission</code> \u4f86\u5b9a\u7fa9\u4ea4\u6613\u6210\u672c\u3002</li> <li>\u671f\u8ca8\u901a\u5e38\u4f7f\u7528 <code>commission.PerContract</code> \u6309\u53e3\u8a08\u8cbb\u3002</li> <li>\u80a1\u7968\u82e5\u9700\u7cbe\u78ba\u6a21\u64ec\u53f0\u80a1\u7a05\u5236\uff08\u8ce3\u51fa\u6536\u7a05\u3001\u8cb7\u9032\u4e0d\u6536\uff09\uff0c\u5efa\u8b70\u4f7f\u7528 \u7e7c\u627f <code>CommissionModel</code> \u7684\u81ea\u5b9a\u7fa9\u985e\u5225 \u3002</li> </ul> <p>\u6e96\u78ba\u5730\u6a21\u64ec\u4ea4\u6613\u6210\u672c\uff0c\u662f\u8b93\u60a8\u7684\u56de\u6e2c\u7d50\u679c\u66f4\u8cbc\u8fd1\u771f\u5be6\u5e02\u5834\u8868\u73fe\u7684\u5fc5\u8981\u6b65\u9a5f\u3002</p>"},{"location":"how-to/backtest/set-slippage/","title":"\u64cd\u4f5c\u6307\u5357\uff1a\u5982\u4f55\u8a2d\u5b9a\u6ed1\u50f9 (How-to: Set Slippage)","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b\u5982\u4f55\u4f7f\u7528 <code>set_slippage()</code> \u51fd\u6578\u5728 Zipline \u56de\u6e2c\u4e2d\u8a2d\u5b9a\u6ed1\u50f9\u6a21\u578b\u7684\u8a73\u7d30\u6307\u5357\uff0c\u5305\u62ec\u671f\u8ca8\u3001\u80a1\u7968\u7684\u5e38\u898b\u6ed1\u50f9\u6a21\u578b\u8a2d\u5b9a\u65b9\u6cd5\u3002</p>"},{"location":"how-to/backtest/set-slippage/#_1","title":"\u76ee\u6a19","text":"<p>\u6ed1\u50f9\uff08Slippage\uff09\u662f\u6307\u5728\u91d1\u878d\u5e02\u5834\u4e2d\uff0c\u6700\u7d42\u6210\u4ea4\u50f9\u683c\u8207\u4e0b\u55ae\u6642\u9810\u671f\u50f9\u683c\u4e4b\u9593\u7684\u5dee\u7570\u3002\u9019\u7a2e\u5dee\u7570\u53ef\u80fd\u7531\u5e02\u5834\u6ce2\u52d5\u3001\u6d41\u52d5\u6027\u4e0d\u8db3\u6216\u8a02\u55ae\u5927\u5c0f\u9020\u6210\u3002\u5728\u56de\u6e2c\u4e2d\u6a21\u64ec\u6ed1\u50f9\uff0c\u662f\u8b93\u7b56\u7565\u7e3e\u6548\u66f4\u8cbc\u8fd1\u771f\u5be6\u5e02\u5834\u72c0\u6cc1\u7684\u95dc\u9375\u6b65\u9a5f\u3002</p> <p>\u672c\u6307\u5357\u5c07\u8aaa\u660e\u5982\u4f55\u5728 TQuant Lab \u4e2d\u4f7f\u7528 <code>set_slippage</code> \u51fd\u6578\u4f86\u70ba\u60a8\u7684\u7b56\u7565\u8a2d\u5b9a\u4e0d\u540c\u7684\u6ed1\u50f9\u6a21\u578b\u3002</p>"},{"location":"how-to/backtest/set-slippage/#set_slippage","title":"\u6838\u5fc3\u51fd\u6578\uff1a<code>set_slippage()</code>","text":"<p>\u8207 <code>set_commission</code> \u985e\u4f3c\uff0c<code>set_slippage()</code> \u51fd\u6578\u4e5f\u61c9\u8a72\u5728 <code>initialize</code> \u51fd\u6578\u4e2d\u88ab\u547c\u53eb\u3002\u5b83\u540c\u6a23\u53ef\u4ee5\u91dd\u5c0d <code>futures</code> \u548c <code>equities</code> \u8a2d\u5b9a\u4e0d\u540c\u7684\u6ed1\u50f9\u6a21\u578b\u3002</p> <pre><code>from zipline.api import set_slippage\nfrom zipline.finance import slippage\n\ndef initialize(context):\n    # \u5728\u6b64\u8655\u547c\u53eb set_slippage \u51fd\u6578\n    # ...\n</code></pre>"},{"location":"how-to/backtest/set-slippage/#1-fixed-slippage","title":"1. \u8a2d\u5b9a\u671f\u8ca8\u7684\u56fa\u5b9a\u6ed1\u50f9 (Fixed Slippage)","text":"<p>\u5c0d\u65bc\u6d41\u52d5\u6027\u8f03\u597d\u7684\u671f\u8ca8\u5e02\u5834\uff0c\u4e00\u500b\u5e38\u898b\u7684\u7c21\u5316\u6a21\u578b\u662f\u5047\u8a2d\u6bcf\u6b21\u4ea4\u6613\u90fd\u6709\u4e00\u500b\u56fa\u5b9a\u7684\u6ed1\u50f9\u6210\u672c\u3002<code>FixedSlippage</code> \u6a21\u578b\u5c31\u662f\u70ba\u6b64\u8a2d\u8a08\u7684\u3002</p> <ul> <li>** \u6a21\u578b ** : <code>slippage.FixedSlippage()</code></li> <li>** \u4e3b\u8981\u53c3\u6578 ** :<ul> <li><code>spread</code>: \u8a2d\u5b9a\u4e00\u500b\u56fa\u5b9a\u7684\u50f9\u5dee\u3002Zipline \u6703\u5c07\u9019\u500b\u50f9\u5dee\u7684\u4e00\u534a\u61c9\u7528\u65bc\u8cb7\u55ae\uff08\u6210\u4ea4\u50f9\u66f4\u9ad8\uff09\uff0c\u53e6\u4e00\u534a\u61c9\u7528\u65bc\u8ce3\u55ae\uff08\u6210\u4ea4\u50f9\u66f4\u4f4e\uff09\u3002</li> </ul> </li> </ul>"},{"location":"how-to/backtest/set-slippage/#11","title":"1.1 \u7bc4\u4f8b\uff1a","text":"<p>\u5047\u8a2d\u6211\u5011\u9810\u671f\u6bcf\u6b21\u4ea4\u6613\u7684\u7e3d\u6ed1\u50f9\u6210\u672c\u70ba 6 \u9ede\uff08tick\uff09\u3002\u9019\u610f\u5473\u8457\u8cb7\u9032\u6642\u6703\u6bd4\u5e02\u50f9\u591a\u4ed8 3 \u9ede\uff0c\u8ce3\u51fa\u6642\u6703\u6bd4\u5e02\u50f9\u5c11\u6536 3 \u9ede\u3002</p> <pre><code># \u5728 initialize \u51fd\u6578\u4e2d\n\nfrom zipline.finance import slippage\n\n# \u8a2d\u5b9a\u7e3d\u50f9\u5dee\u70ba 6 \u9ede\nset_slippage(futures=slippage.FixedSlippage(spread=6.0))\n</code></pre>"},{"location":"how-to/backtest/set-slippage/#2-volume-share-slippage","title":"2. \u8a2d\u5b9a\u80a1\u7968\u7684\u6210\u4ea4\u91cf\u6ed1\u50f9 (Volume Share Slippage)","text":"<p>\u5c0d\u65bc\u80a1\u7968\uff0c\u7279\u5225\u662f\u7576\u4ea4\u6613\u91cf\u53ef\u80fd\u5f71\u97ff\u5e02\u5834\u50f9\u683c\u6642\uff0c\u4f7f\u7528\u8207\u6210\u4ea4\u91cf\u76f8\u95dc\u7684\u6ed1\u50f9\u6a21\u578b\u6703\u66f4\u8cbc\u8fd1\u771f\u5be6\u3002<code>VolumeShareSlippage</code> \u6703\u6839\u64da\u60a8\u7684\u8a02\u55ae\u4f54\u7576\u524d K \u68d2\u6210\u4ea4\u91cf\u7684\u6bd4\u4f8b\u4f86\u6a21\u64ec\u50f9\u683c\u885d\u64ca\u3002</p> <ul> <li>** \u6a21\u578b ** : <code>slippage.VolumeShareSlippage()</code></li> <li>** \u4e3b\u8981\u53c3\u6578 ** :<ul> <li><code>volume_limit</code>: \u60a8\u7684\u8a02\u55ae\u6210\u4ea4\u91cf\u4f54 K \u68d2\u7e3d\u6210\u4ea4\u91cf\u7684\u6700\u5927\u6bd4\u4f8b\uff0c\u9810\u8a2d\u70ba 0.1 (10%)\u3002</li> <li><code>price_impact</code>: \u50f9\u683c\u885d\u64ca\u4fc2\u6578\uff0c\u9810\u8a2d\u70ba 0.1\u3002\u60a8\u7684\u8a02\u55ae\u91cf\u8d8a\u5927\uff0c\u5c0d\u50f9\u683c\u7684\u5f71\u97ff\u5c31\u8d8a\u5927\u3002</li> </ul> </li> </ul>"},{"location":"how-to/backtest/set-slippage/#21","title":"2.1 \u7bc4\u4f8b\uff1a","text":"<pre><code># \u5728 initialize \u51fd\u6578\u4e2d\n\nfrom zipline.finance import slippage\n\n# \u4f7f\u7528\u9810\u8a2d\u53c3\u6578\u8a2d\u5b9a\u6210\u4ea4\u91cf\u6ed1\u50f9\u6a21\u578b\nset_slippage(equities=slippage.VolumeShareSlippage())\n</code></pre>"},{"location":"how-to/backtest/set-slippage/#3","title":"3. \u7121\u6ed1\u50f9","text":"<p>\u5728\u7b56\u7565\u958b\u767c\u7684\u521d\u671f\u968e\u6bb5\uff0c\u60a8\u53ef\u80fd\u5e0c\u671b\u5728\u4e00\u500b\u7406\u60f3\u5316\u7684\u74b0\u5883\u4e2d\u6e2c\u8a66\u6838\u5fc3\u908f\u8f2f\uff0c\u6b64\u6642\u53ef\u4ee5\u8a2d\u5b9a\u7121\u6ed1\u50f9\u3002</p> <ul> <li>** \u6a21\u578b ** : <code>slippage.NoSlippage()</code></li> </ul>"},{"location":"how-to/backtest/set-slippage/#31","title":"3.1 \u7bc4\u4f8b\uff1a","text":"<pre><code># \u5728 initialize \u51fd\u6578\u4e2d\n\nfrom zipline.finance import slippage\n\nset_slippage(futures=slippage.NoSlippage())\n</code></pre>"},{"location":"how-to/backtest/set-slippage/#_2","title":"\u7e3d\u7d50","text":"<ul> <li>\u5728 <code>initialize</code> \u51fd\u6578\u4e2d\u4f7f\u7528 <code>set_slippage</code> \u4f86\u5b9a\u7fa9\u6ed1\u50f9\u6a21\u578b\u3002</li> <li>\u671f\u8ca8 \u5e38\u7528 <code>slippage.FixedSlippage</code> \u4f86\u6a21\u64ec\u56fa\u5b9a\u7684\u4ea4\u6613\u6210\u672c\u3002</li> <li>\u80a1\u7968 \u53ef\u4f7f\u7528 <code>slippage.VolumeShareSlippage</code> \u4f86\u6a21\u64ec\u66f4\u771f\u5be6\u7684\u5e02\u5834\u885d\u64ca\u3002</li> <li>\u70ba\u4e86\u9032\u884c\u6700\u56b4\u8b39\u7684\u56de\u6e2c\uff0c\u8acb\u52d9\u5fc5\u70ba\u60a8\u7684\u7b56\u7565\u8a2d\u5b9a\u4e00\u500b\u5408\u7406\u7684\u6ed1\u50f9\u6a21\u578b\u3002</li> </ul>"},{"location":"how-to/backtest/set-trading-controls/","title":"\u5982\u4f55\u8a2d\u5b9a\u4ea4\u6613\u9650\u5236","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b\u5982\u4f55\u5728 Zipline \u56de\u6e2c\u4e2d\u8a2d\u5b9a\u4ea4\u6613\u9650\u5236\u7684\u8a73\u7d30\u6307\u5357\uff0c\u5305\u62ec <code>set_max_leverage()</code>\u3001<code>set_max_position_size()</code> \u548c <code>set_max_order_size()</code> \u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u5e6b\u52a9\u60a8\u6a21\u64ec\u771f\u5be6\u4e16\u754c\u7684\u5e02\u5834\u7d04\u675f\u3002</p> <p>\u5728\u91cf\u5316\u56de\u6e2c\u4e2d\u8a2d\u5b9a\u4ea4\u6613\u9650\u5236\u662f\u81f3\u95dc\u91cd\u8981\u7684\u4e00\u74b0\u3002\u9019\u4e9b\u9650\u5236\u6709\u52a9\u65bc\u6a21\u64ec\u771f\u5be6\u4e16\u754c\u7684\u5e02\u5834\u7d04\u675f\u3001\u7ba1\u7406\u7b56\u7565\u98a8\u96aa\uff0c\u4e26\u78ba\u4fdd\u56de\u6e2c\u7d50\u679c\u66f4\u5177\u53ef\u4fe1\u5ea6\u3002Zipline \u63d0\u4f9b\u4e86\u591a\u500b API \u51fd\u6578\u4f86\u5be6\u65bd\u9019\u4e9b\u4ea4\u6613\u63a7\u5236\u3002</p>"},{"location":"how-to/backtest/set-trading-controls/#1-set_max_leverage","title":"1. set_max_leverage()\uff1a\u8a2d\u5b9a\u6700\u5927\u69d3\u687f\u500d\u6578","text":"<p>\u6b64\u51fd\u6578\u7528\u65bc\u9650\u5236\u60a8\u7684\u6295\u8cc7\u7d44\u5408\u5728\u56de\u6e2c\u671f\u9593\u7684\u6700\u5927\u69d3\u687f\u500d\u6578\u3002\u5982\u679c\u6295\u8cc7\u7d44\u5408\u7684\u69d3\u687f\u8d85\u904e\u6b64\u8a2d\u5b9a\uff0cZipline \u5c07\u6703\u7d42\u6b62\u56de\u6e2c\u4e26\u5831\u932f\u3002</p> <p>\u53c3\u6578 :</p> <ul> <li><code>max_leverage</code> (float)<ul> <li><code>max_leverage</code> \u61c9\u70ba\u4e00\u500b\u5927\u65bc 0 \u7684\u6d6e\u9ede\u6578\uff0c\u8868\u793a\u5141\u8a31\u7684\u6700\u5927\u69d3\u687f\u500d\u6578\u3002</li> </ul> </li> </ul> <pre><code>from zipline.api import set_max_leverage\n\ndef initialize(context):\n    # \u8a2d\u5b9a\u6700\u5927\u69d3\u687f\u500d\u6578\u70ba 3.0\n    set_max_leverage(3.0)\n</code></pre> <p>Warning</p> <p>\u904e\u9ad8\u7684\u69d3\u687f\u53ef\u80fd\u6703\u5c0e\u81f4\u5728\u5e02\u5834\u6ce2\u52d5\u6642\uff0c\u6295\u8cc7\u7d44\u5408\u50f9\u503c\u8fc5\u901f\u6b78\u96f6\u3002\u8acb\u6839\u64da\u60a8\u7684\u98a8\u96aa\u627f\u53d7\u80fd\u529b\u5be9\u614e\u8a2d\u5b9a\u3002</p>"},{"location":"how-to/backtest/set-trading-controls/#2-set_max_position_size","title":"2. set_max_position_size()\uff1a\u8a2d\u5b9a\u55ae\u4e00\u8cc7\u7522\u6700\u5927\u90e8\u4f4d\u9650\u5236","text":"<p>\u6b64\u51fd\u6578\u7528\u65bc\u9650\u5236\u55ae\u4e00\u8cc7\u7522\u5728\u6295\u8cc7\u7d44\u5408\u4e2d\u7684\u6700\u5927\u6301\u6709\u90e8\u4f4d\u3002\u9019\u6709\u52a9\u65bc\u5206\u6563\u98a8\u96aa\uff0c\u907f\u514d\u55ae\u4e00\u8cc7\u7522\u5c0d\u6574\u500b\u6295\u8cc7\u7d44\u5408\u7522\u751f\u904e\u5927\u7684\u5f71\u97ff\u3002</p> <p>\u53c3\u6578 :</p> <ul> <li><code>asset</code>: (Asset, \u53ef\u9078) \u6b32\u8a2d\u5b9a\u9650\u5236\u7684\u8cc7\u7522\u7269\u4ef6\u3002\u82e5\u70ba <code>None</code>\uff0c\u5247\u9650\u5236\u9069\u7528\u65bc\u6240\u6709\u8cc7\u7522\u3002</li> <li><code>max_shares</code>: (int, \u53ef\u9078) \u5141\u8a31\u6301\u6709\u7684\u6700\u5927\u80a1\u6578\u3002</li> <li><code>max_notional</code>: (float, \u53ef\u9078) \u5141\u8a31\u6301\u6709\u7684\u6700\u5927\u5e02\u503c (\u7f8e\u5143)\u3002</li> <li><code>on_error</code>: (str, \u53ef\u9078) \u7576\u9650\u5236\u88ab\u9055\u53cd\u6642\u7684\u8655\u7406\u65b9\u5f0f\u3002\u9078\u9805\u5305\u62ec <code>'fail'</code> (\u7d42\u6b62\u56de\u6e2c)\u3001<code>'log'</code> (\u8a18\u9304\u8b66\u544a\u4e26\u7e7c\u7e8c)\u3001<code>'warn'</code> (\u767c\u51fa\u8b66\u544a\u4e26\u7e7c\u7e8c)\u3001<code>'ignore'</code> (\u5ffd\u7565)\u3002\u9810\u8a2d\u70ba <code>'fail'</code>\u3002</li> </ul> <p><code>max_shares</code> \u548c <code>max_notional</code> \u81f3\u5c11\u5fc5\u9808\u8a2d\u5b9a\u5176\u4e2d\u4e00\u500b\u3002</p> <pre><code>from zipline.api import set_max_position_size, symbol\n\ndef initialize(context):\n    # \u8a2d\u5b9a\u53f0\u6ce5 (1101) \u7684\u6700\u5927\u6301\u6709\u80a1\u6578\u70ba 1050 \u80a1\uff0c\u9055\u53cd\u6642\u8a18\u9304\u8b66\u544a\n    set_max_position_size(asset=symbol('1101'), max_shares=1050, on_error='log')\n\n    # \u8a2d\u5b9a\u53f0\u7a4d\u96fb (2330) \u7684\u6700\u5927\u6301\u6709\u80a1\u6578\u70ba 2000 \u80a1\uff0c\u4e14\u6700\u5927\u5e02\u503c\u4e0d\u8d85\u904e 600,000 \u5143\uff0c\u9055\u53cd\u6642\u8a18\u9304\u8b66\u544a\n    set_max_position_size(asset=symbol('2330'), max_shares=2000, max_notional=600000, on_error='log')\n</code></pre>"},{"location":"how-to/backtest/set-trading-controls/#3-set_max_order_size","title":"3. set_max_order_size()\uff1a\u8a2d\u5b9a \u55ae\u7b46\u8a02\u55ae\u6700\u5927\u6578\u91cf\u9650\u5236","text":"<p>\u6b64\u51fd\u6578\u7528\u65bc\u9650\u5236\u55ae\u6b21\u4e0b\u55ae\u7684\u6700\u5927\u6578\u91cf\u3002\u9019\u53ef\u4ee5\u9632\u6b62\u56e0\u610f\u5916\u6216\u908f\u8f2f\u932f\u8aa4\u800c\u4e0b\u9054\u904e\u5927\u7684\u8a02\u55ae\uff0c\u540c\u6642\u4e5f\u80fd\u6a21\u64ec\u5e02\u5834\u6df1\u5ea6\u4e0d\u8db3\u7684\u72c0\u6cc1\u3002</p> <p>\u53c3\u6578 : \u540c <code>set_max_position_size()</code> \u7684\u53c3\u6578\u3002</p> <pre><code>from zipline.api import set_max_order_size, symbol\n\ndef initialize(context):\n    # \u8a2d\u5b9a\u53f0\u6ce5 (1101) \u7684\u55ae\u7b46\u6700\u5927\u4e0b\u55ae\u80a1\u6578\u70ba 1000 \u80a1\n    set_max_order_size(asset=symbol('1101'), max_shares=1000, on_error='log')\n\n    # \u8a2d\u5b9a\u53f0\u7a4d\u96fb (2330) \u7684\u55ae\u7b46\u6700\u5927\u4e0b\u55ae\u80a1\u6578\u70ba 2000 \u80a1\uff0c\u4e14\u6700\u5927\u5e02\u503c\u4e0d\u8d85\u904e 481,000 \u5143\n    set_max_order_size(asset=symbol('2330'), max_shares=2000, max_notional=481000, on_error='log')\n</code></pre> <p><code>max_notional</code> \u662f\u6839\u64da\u4e0b\u55ae\u6642\u7684\u6536\u76e4\u50f9\u8a08\u7b97\u3002\u56e0\u6b64\uff0c\u7531\u65bc\u5be6\u969b\u6210\u4ea4\u50f9\u8207\u6536\u76e4\u50f9\u53ef\u80fd\u5b58\u5728\u5dee\u7570\uff0c\u6700\u7d42\u6210\u4ea4\u7684\u80a1\u6578\u548c\u91d1\u984d\u4ecd\u53ef\u80fd\u5fae\u5e45\u8d85\u51fa <code>max_notional</code> \u7684\u9650\u5236\u3002</p>"},{"location":"how-to/backtest/set-trading-controls/#4-set_min_order_size","title":"4. set_min_order_size()\uff1a\u8a2d\u5b9a \u55ae\u7b46\u8a02\u55ae\u6700\u5c0f\u6578\u91cf\u9650\u5236","text":"<p>[TODO: \u5167\u5bb9\u7f3a\u5931]</p> <p>\u64b0\u5beb\u8005\u8a3b\uff1a \u5728 <code>TQuant-Lab</code> \u5c08\u6848\u7684\u7bc4\u4f8b\u4e2d\uff0c\u4e26\u672a\u627e\u5230 <code>set_min_order_size</code> \u51fd\u6578\u7684\u660e\u78ba\u4f7f\u7528\u7bc4\u4f8b\u3002 \u6839\u64da [RULE-T1] (\u7d55\u5c0d\u771f\u5be6\u6027)\uff0c\u5728\u6c92\u6709\u53ef\u9a57\u8b49\u7684\u53c3\u8003\u8cc7\u6599\u524d\uff0c\u7121\u6cd5\u64b0\u5beb\u6b64\u6587\u4ef6\u7684\u6280\u8853\u5167\u5bb9\u3002 \u6b64\u554f\u984c\u5df2\u8a18\u9304\u5728 <code>_CURRENT_TASK.md</code> \u4e2d\uff0c\u7b49\u5f85\u5be9\u67e5\u8005\u63d0\u4f9b\u9032\u4e00\u6b65\u7684\u6307\u5f15\u3002</p>"},{"location":"how-to/backtest/simulation-params/","title":"Zipline \u56de\u6e2c\u6a21\u64ec\u53c3\u6578 (Simulation Parameters)","text":"<p>Info</p> <p>\u672c\u9801\u8a73\u7d30\u8aaa\u660e Zipline \u56de\u6e2c\u4e2d\u7684\u6a21\u64ec\u53c3\u6578\uff0c\u5305\u62ec <code>run_algorithm()</code> \u51fd\u6578\u7684\u6838\u5fc3\u53c3\u6578\u3001\u5982\u4f55\u8a2d\u5b9a\u56de\u6e2c\u671f\u9593\u3001\u521d\u59cb\u8cc7\u91d1\u3001\u6578\u64da\u983b\u7387\u3001\u4ee5\u53ca\u5176\u4ed6\u5f71\u97ff\u56de\u6e2c\u884c\u70ba\u7684\u91cd\u8981\u8a2d\u5b9a\u3002</p> <p>\u5728 Zipline \u4e2d\uff0c\u6a21\u64ec\u53c3\u6578 (Simulation Parameters) \u6c7a\u5b9a\u4e86\u56de\u6e2c\u5f15\u64ce\u5982\u4f55\u904b\u884c\u60a8\u7684\u4ea4\u6613\u7b56\u7565\u3002\u9019\u4e9b\u53c3\u6578\u63a7\u5236\u8457\u56de\u6e2c\u7684\u6642\u9593\u7bc4\u570d\u3001\u53ef\u7528\u7684\u8cc7\u91d1\u3001\u6578\u64da\u7684\u7c92\u5ea6\u4ee5\u53ca\u5176\u4ed6\u74b0\u5883\u56e0\u7d20\u3002\u7cbe\u78ba\u5730\u8a2d\u5b9a\u9019\u4e9b\u53c3\u6578\u5c0d\u65bc\u78ba\u4fdd\u56de\u6e2c\u7d50\u679c\u7684\u6709\u6548\u6027\u548c\u53ef\u9760\u6027\u81f3\u95dc\u91cd\u8981\u3002</p> <p>\u672c\u6587\u4ef6\u5c07\u4e3b\u8981\u4ecb\u7d39 <code>zipline.run_algorithm()</code> \u51fd\u6578\u4e2d\u7684\u95dc\u9375\u53c3\u6578\uff0c\u56e0\u70ba\u5b83\u662f\u63a7\u5236 Zipline \u56de\u6e2c\u884c\u70ba\u7684\u4e3b\u8981\u5165\u53e3\u3002</p>"},{"location":"how-to/backtest/simulation-params/#1-run_algorithm","title":"1. <code>run_algorithm()</code> \u51fd\u6578\u7684\u6838\u5fc3\u53c3\u6578","text":"<p><code>zipline.run_algorithm()</code> \u51fd\u6578\u662f\u555f\u52d5 Zipline \u56de\u6e2c\u7684\u6838\u5fc3\u3002\u4ee5\u4e0b\u662f\u5176\u4e00\u4e9b\u6700\u5e38\u7528\u7684\u53c3\u6578\uff1a</p> <ul> <li> <p><code>start</code> (<code>pd.Timestamp</code>)</p> <ul> <li>\u7528\u9014\uff1a\u5b9a\u7fa9\u56de\u6e2c\u7684\u8d77\u59cb\u65e5\u671f\u3002\u5fc5\u9808\u662f UTC \u6642\u5340\u7684 <code>pandas.Timestamp</code> \u7269\u4ef6\u3002</li> <li>\u7bc4\u4f8b\uff1a<code>pd.Timestamp('2020-01-01', tz='utc')</code></li> </ul> </li> <li> <p><code>end</code> (<code>pd.Timestamp</code>)</p> <ul> <li>\u7528\u9014\uff1a\u5b9a\u7fa9\u56de\u6e2c\u7684\u7d50\u675f\u65e5\u671f\u3002\u5fc5\u9808\u662f UTC \u6642\u5340\u7684 <code>pandas.Timestamp</code> \u7269\u4ef6\u3002</li> <li>\u7bc4\u4f8b\uff1a<code>pd.Timestamp('2023-12-31', tz='utc')</code></li> </ul> </li> <li> <p><code>initialize</code> (<code>function</code>)</p> <ul> <li>\u7528\u9014\uff1a\u5728\u56de\u6e2c\u958b\u59cb\u6642\u50c5\u57f7\u884c\u4e00\u6b21\u7684\u51fd\u6578\uff0c\u7528\u65bc\u8a2d\u5b9a\u7b56\u7565\u7684\u521d\u59cb\u72c0\u614b\u3002</li> <li>\u8a73\u898b\uff1a\u751f\u547d\u9031\u671f\u51fd\u6578</li> </ul> </li> <li> <p><code>handle_data</code> (<code>function</code>)</p> <ul> <li>\u7528\u9014\uff1a\u5728\u6bcf\u500b\u4ea4\u6613\u65e5\u88ab\u8abf\u7528\u4e00\u6b21\u7684\u6838\u5fc3\u4ea4\u6613\u908f\u8f2f\u51fd\u6578\u3002</li> <li>\u8a73\u898b\uff1a\u751f\u547d\u9031\u671f\u51fd\u6578</li> </ul> </li> <li> <p><code>analyze</code> (<code>function</code>, optional)</p> <ul> <li>\u7528\u9014\uff1a\u5728\u6574\u500b\u56de\u6e2c\u7d50\u675f\u5f8c\u57f7\u884c\u4e00\u6b21\u7684\u51fd\u6578\uff0c\u7528\u65bc\u7e3e\u6548\u5206\u6790\u548c\u8996\u89ba\u5316\u3002</li> <li>\u8a73\u898b\uff1a\u751f\u547d\u9031\u671f\u51fd\u6578</li> </ul> </li> <li> <p><code>capital_base</code> (<code>float</code>)</p> <ul> <li>\u7528\u9014\uff1a\u8a2d\u5b9a\u56de\u6e2c\u958b\u59cb\u6642\u7684\u521d\u59cb\u8cc7\u91d1\u91d1\u984d\u3002</li> <li>\u7bc4\u4f8b\uff1a<code>1_000_000</code> (100 \u842c)</li> </ul> </li> <li> <p><code>data_frequency</code> (<code>str</code>, optional)</p> <ul> <li>\u7528\u9014\uff1a\u6307\u5b9a\u6578\u64da\u7684\u983b\u7387\u3002\u53ef\u9078 <code>'daily'</code> (\u65e5\u983b) \u6216 <code>'minute'</code> (\u5206\u9418\u983b)\u3002</li> <li>\u9810\u8a2d\uff1a<code>'daily'</code></li> </ul> </li> <li> <p><code>bundle</code> (<code>str</code>, optional)</p> <ul> <li>\u7528\u9014\uff1a\u6307\u5b9a\u8981\u4f7f\u7528\u7684 Zipline \u8cc7\u6599\u5305\u540d\u7a31\u3002</li> <li>\u9810\u8a2d\uff1a<code>'tquant'</code> (TQuant Lab \u9810\u8a2d\u7684\u8cc7\u6599\u5305)</li> </ul> </li> <li> <p><code>trading_calendar</code> (<code>zipline.utils.calendars.TradingCalendar</code>, optional)</p> <ul> <li>\u7528\u9014\uff1a\u6307\u5b9a\u56de\u6e2c\u8981\u4f7f\u7528\u7684\u4ea4\u6613\u65e5\u66c6\u3002\u4f8b\u5982 <code>'TEJ_XTAI'</code> (\u53f0\u7063\u80a1\u7968) \u6216 <code>'TEJ'</code> (\u53f0\u7063\u671f\u8ca8)\u3002</li> <li>\u8a73\u898b\uff1a\u4ea4\u6613\u65e5\u66c6</li> </ul> </li> <li> <p><code>benchmark_sid</code> (<code>int</code>, optional) \u6216 <code>benchmark_symbol</code> (<code>str</code>, optional)</p> <ul> <li>\u7528\u9014\uff1a\u8a2d\u5b9a\u7528\u65bc\u6bd4\u8f03\u7684\u57fa\u6e96\u6307\u6578\u7684 Zipline ID \u6216\u80a1\u7968\u4ee3\u78bc\u3002</li> <li>\u8a73\u898b\uff1a\u5982\u4f55\u8a2d\u5b9a\u8207\u53d6\u5f97 Benchmark \u5831\u916c\u7387</li> </ul> </li> <li> <p><code>treasury_returns</code> (<code>pd.Series</code>, optional)</p> <ul> <li>\u7528\u9014\uff1a\u63d0\u4f9b\u81ea\u5b9a\u7fa9\u7684\u7121\u98a8\u96aa\u5229\u7387\u5e8f\u5217\u3002</li> <li>\u8a73\u898b\uff1a\u5982\u4f55\u8a2d\u5b9a\u7121\u98a8\u96aa\u5229\u7387</li> </ul> </li> <li> <p><code>before_trading_start</code> (<code>function</code>, optional)</p> <ul> <li>\u7528\u9014\uff1a\u5728\u6bcf\u500b\u4ea4\u6613\u65e5\u958b\u76e4\u524d\u57f7\u884c\u4e00\u6b21\u7684\u51fd\u6578\uff0c\u901a\u5e38\u7528\u65bc\u76e4\u524d\u6578\u64da\u6e96\u5099\u3002</li> <li>\u8a73\u898b\uff1a\u751f\u547d\u9031\u671f\u51fd\u6578</li> </ul> </li> <li> <p><code>warm_up_days</code> (<code>int</code>, optional)</p> <ul> <li>\u7528\u9014\uff1a\u8a2d\u5b9a\u5728\u56de\u6e2c\u958b\u59cb\u524d\uff0c\u7b56\u7565\u9700\u8981\u300c\u9810\u71b1\u300d\u7684\u4ea4\u6613\u65e5\u6578\u3002\u9019\u4e9b\u5929\u6578\u7684\u6578\u64da\u6703\u88ab\u52a0\u8f09\uff0c\u4f46\u4e0d\u6703\u57f7\u884c\u4ea4\u6613\u6216\u8a18\u9304\u7e3e\u6548\uff0c\u4ee5\u78ba\u4fdd\u56e0\u5b50\u8a08\u7b97\u6709\u8db3\u5920\u7684\u6b77\u53f2\u6578\u64da\u3002</li> <li>\u9810\u8a2d\uff1a0</li> </ul> </li> <li> <p><code>metrics_set</code> (<code>zipline.finance.metrics.MetricsSet</code>, optional)</p> <ul> <li>\u7528\u9014\uff1a\u6307\u5b9a\u8981\u4f7f\u7528\u7684\u7e3e\u6548\u6307\u6a19\u96c6\u3002\u901a\u5e38\u4f7f\u7528\u9810\u8a2d\u503c\u3002</li> </ul> </li> </ul>"},{"location":"how-to/backtest/simulation-params/#2-simulationparameters","title":"2. <code>SimulationParameters</code> \u7269\u4ef6 (\u9032\u968e)","text":"<p>\u5728 Zipline \u7684\u5167\u90e8\uff0c\u9019\u4e9b <code>run_algorithm()</code> \u7684\u53c3\u6578\u6700\u7d42\u6703\u88ab\u5c01\u88dd\u6210\u4e00\u500b <code>SimulationParameters</code> \u7269\u4ef6\u3002\u5c0d\u65bc\u5927\u591a\u6578\u4f7f\u7528\u8005\u800c\u8a00\uff0c\u76f4\u63a5\u900f\u904e <code>run_algorithm()</code> \u50b3\u5165\u53c3\u6578\u5df2\u7d93\u8db3\u5920\u3002</p> <p>\u7136\u800c\uff0c\u5982\u679c\u60a8\u9700\u8981\u66f4\u7d30\u7c92\u5ea6\u7684\u63a7\u5236\uff0c\u4f8b\u5982\u81ea\u5b9a\u7fa9 Zipline \u7684\u884c\u70ba\uff0c\u53ef\u4ee5\u624b\u52d5\u69cb\u5efa <code>SimulationParameters</code> \u7269\u4ef6\u3002\u4f46\u9019\u901a\u5e38\u5c6c\u65bc\u9032\u968e\u7528\u6cd5\uff0c\u4e14\u5728 TQuant Lab \u4e2d\u8f03\u5c11\u76f4\u63a5\u64cd\u4f5c\u3002</p>"},{"location":"how-to/backtest/simulation-params/#3","title":"3. \u7bc4\u4f8b","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u500b\u7d50\u5408\u591a\u500b\u6a21\u64ec\u53c3\u6578\u7684 <code>run_algorithm()</code> \u7bc4\u4f8b\uff1a</p> <pre><code>import pandas as pd\nfrom zipline import run_algorithm\nfrom zipline.api import (\n    set_benchmark,\n    symbol,\n    order_target_percent\n)\nfrom zipline.utils.calendar_utils import get_calendar\n\n# \u5047\u8a2d\u9019\u662f\u60a8\u7684\u7b56\u7565\u908f\u8f2f\ndef initialize(context):\n    set_benchmark(symbol('IR0001'))\n    context.asset = symbol('2330')\n    context.ordered = False\n\ndef handle_data(context, data):\n    if not context.ordered:\n        order_target_percent(context.asset, 1.0)\n        context.ordered = True\n\ndef analyze(context, results):\n    print(\"\u56de\u6e2c\u5206\u6790\u5b8c\u6210\u3002\")\n\n# \u8a2d\u5b9a\u7121\u98a8\u96aa\u5229\u7387 (\u4f8b\u5982\uff1a\u4f7f\u7528\u56fa\u5b9a\u7684\u5e74\u5316 1% \u7121\u98a8\u96aa\u5229\u7387)\nstart_date = pd.Timestamp('2020-01-01', tz='utc')\nend_date = pd.Timestamp('2022-01-01', tz='utc')\ndate_range = pd.date_range(start=start_date, end=end_date, freq='D', tz='utc')\nfixed_treasury_returns = pd.Series(data=(0.01 / 252), index=date_range) # \u5047\u8a2d 252 \u500b\u4ea4\u6613\u65e5\n\n# \u57f7\u884c\u56de\u6e2c\nresults = run_algorithm(\n    start=start_date,\n    end=end_date,\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    capital_base=500_000,              # \u521d\u59cb\u8cc7\u91d1 50 \u842c\n    data_frequency='daily',           # \u65e5\u983b\u6578\u64da\n    bundle='tquant',                  # \u4f7f\u7528 'tquant' \u8cc7\u6599\u5305\n    trading_calendar=get_calendar('TEJ_XTAI'), # \u6307\u5b9a\u53f0\u7063\u80a1\u7968\u4ea4\u6613\u65e5\u66c6\n    benchmark_symbol='IR0001',        # \u8a2d\u5b9a Benchmark \u70ba IR0001\n    treasury_returns=fixed_treasury_returns, # \u81ea\u5b9a\u7fa9\u7121\u98a8\u96aa\u5229\u7387\n    warm_up_days=50                   # \u9810\u71b1 50 \u500b\u4ea4\u6613\u65e5\n)\n</code></pre>"},{"location":"how-to/data/get-benchmark-roi/","title":"\u5982\u4f55\u8a2d\u5b9a\u8207\u53d6\u5f97 Benchmark \u5831\u916c\u7387","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b\u5982\u4f55\u5728 Zipline \u56de\u6e2c\u4e2d\u8a2d\u5b9a\u8207\u53d6\u5f97 Benchmark \u5831\u916c\u7387\u7684\u8a73\u7d30\u6307\u5357\uff0c\u5305\u62ec <code>set_benchmark()</code> \u7684\u4f7f\u7528\u65b9\u6cd5\u548c Benchmark \u5831\u916c\u7387\u7684\u8a08\u7b97\u65b9\u5f0f\u3002</p> <p>\u5728\u91cf\u5316\u5206\u6790\u4e2d\uff0cBenchmark (\u5927\u76e4/\u5e02\u5834\u57fa\u6e96) \u662f\u4e00\u500b\u8861\u91cf\u60a8\u7684\u6295\u8cc7\u7b56\u7565\u8868\u73fe\u597d\u58de\u7684\u95dc\u9375\u6307\u6a19\u3002\u900f\u904e\u5c07\u7b56\u7565\u7684\u5831\u916c\u7387\u8207 Benchmark \u7684\u5831\u916c\u7387\u9032\u884c\u6bd4\u8f03\uff0c\u60a8\u53ef\u4ee5\u5ba2\u89c0\u5730\u8a55\u4f30\u7b56\u7565\u662f\u5426\u7522\u751f\u4e86\u8d85\u8d8a\u5e02\u5834\u7684\u300c\u8d85\u984d\u5831\u916c (Alpha)\u300d\u3002</p> <p>\u5728 TQuant Lab (Zipline) \u4e2d\uff0c\u8a2d\u5b9a Benchmark \u4e3b\u8981\u900f\u904e <code>set_benchmark()</code> \u51fd\u6578\u5b8c\u6210\uff0c\u5176\u7d50\u679c\u4e3b\u8981\u7528\u65bc Pyfolio \u7e3e\u6548\u5831\u8868 \u7684\u8996\u89ba\u5316\u5206\u6790\u3002</p>"},{"location":"how-to/data/get-benchmark-roi/#1-benchmark","title":"1. \u8a2d\u5b9a Benchmark","text":"<p>\u60a8\u901a\u5e38\u6703\u5728 <code>initialize</code> \u51fd\u6578\u4e2d\u547c\u53eb <code>set_benchmark()</code> \u4f86\u6307\u5b9a\u672c\u6b21\u56de\u6e2c\u8981\u4f7f\u7528\u7684\u5e02\u5834\u57fa\u6e96\u3002</p> <p>Important</p> <p>\u7528\u65bc\u8a2d\u5b9a Benchmark \u7684\u8cc7\u7522 (\u7121\u8ad6\u662f\u6307\u6578\u6216\u500b\u80a1)\uff0c\u90fd\u5fc5\u9808 \u9810\u5148\u900f\u904e <code>ingest</code> \u6307\u4ee4\u532f\u5165 \u81f3 <code>tquant</code> \u8cc7\u6599\u5305\u4e2d\u3002</p>"},{"location":"how-to/data/get-benchmark-roi/#_1","title":"\u65b9\u6cd5\u4e00\uff1a\u4f7f\u7528\u9810\u8a2d\u7684\u5e02\u5834\u6307\u6578","text":"<p>TQuant Lab \u9810\u8a2d\u4f7f\u7528 <code>'IR0001'</code> (\u53f0\u7063\u52a0\u6b0a\u5831\u916c\u6307\u6578) \u4f5c\u70ba\u5e02\u5834\u57fa\u6e96\u3002\u9019\u662f\u6700\u5e38\u7528\u7684\u8a2d\u5b9a\u65b9\u6cd5\u3002</p> <pre><code>from zipline.api import set_benchmark, symbol\n\ndef initialize(context):\n    # \u5c07\u53f0\u7063\u52a0\u6b0a\u5831\u916c\u6307\u6578\u8a2d\u5b9a\u70ba Benchmark\n    set_benchmark(symbol('IR0001'))\n</code></pre>"},{"location":"how-to/data/get-benchmark-roi/#benchmark_1","title":"\u65b9\u6cd5\u4e8c\uff1a\u4f7f\u7528\u81ea\u5b9a\u7fa9\u7684\u80a1\u7968\u4f5c\u70ba Benchmark","text":"<p>\u60a8\u4e5f\u53ef\u4ee5\u6307\u5b9a\u4efb\u610f\u4e00\u652f\u80a1\u7968\u4f5c\u70ba Benchmark\uff0c\u4f8b\u5982\uff0c\u5c07\u53f0\u7a4d\u96fb (<code>'2330'</code>) \u4f5c\u70ba\u6bd4\u8f03\u57fa\u6e96\uff0c\u4ee5\u8a55\u4f30\u60a8\u7684\u7b56\u7565\u76f8\u5c0d\u65bc\u7279\u5b9a\u9f8d\u982d\u80a1\u7684\u8868\u73fe\u3002</p> <pre><code>from zipline.api import set_benchmark, symbol\n\ndef initialize(context):\n    # \u5c07\u53f0\u7a4d\u96fb (2330) \u8a2d\u5b9a\u70ba Benchmark\n    set_benchmark(symbol('2330'))\n</code></pre>"},{"location":"how-to/data/get-benchmark-roi/#2-benchmark","title":"2. \u53d6\u5f97 Benchmark \u5831\u916c\u7387","text":"<p>\u5728 TQuant Lab \u7684\u5de5\u4f5c\u6d41\u7a0b\u4e2d\uff0c\u60a8 \u901a\u5e38\u4e0d\u9700\u8981\u624b\u52d5\u547c\u53eb <code>get_benchmark_returns()</code>\u3002</p> <p>\u7576\u60a8\u57f7\u884c\u56de\u6e2c\u4e26\u7522\u751f Pyfolio \u5831\u8868\u6642\uff0cZipline \u6703\u5728\u5f8c\u53f0\u81ea\u52d5\u6839\u64da\u60a8\u7528 <code>set_benchmark()</code> \u8a2d\u5b9a\u7684\u57fa\u6e96\uff0c\u8a08\u7b97\u6bcf\u65e5\u7684 Benchmark \u5831\u916c\u7387\uff0c\u4e26\u5c07\u5176\u8207\u60a8\u7684\u7b56\u7565\u5831\u916c\u7387\u4e26\u5217\u5448\u73fe\u5728\u5716\u8868\u548c\u6578\u64da\u7d71\u8a08\u4e2d\u3002</p> <p>Benchmark \u7684\u6bcf\u65e5\u5831\u916c\u7387\u8a08\u7b97\u65b9\u5f0f\u70ba\uff1a<code>(\u7576\u65e5\u6536\u76e4\u50f9 / \u524d\u4e00\u65e5\u6536\u76e4\u50f9) - 1</code>\u3002</p> <p>\u5982\u679c\u60a8\u78ba\u5be6\u5728\u7279\u6b8a\u5834\u666f\u4e0b\u9700\u8981\u624b\u52d5\u53d6\u5f97 Benchmark \u7684\u6b77\u53f2\u5831\u916c\u5e8f\u5217\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>get_benchmark_returns()</code> \u51fd\u6578\uff0c\u4f46\u9019\u5728\u591a\u6578\u5206\u6790\u6d41\u7a0b\u4e2d\u4e26\u975e\u5fc5\u8981\u6b65\u9a5f\u3002</p> <pre><code>from zipline.api import get_benchmark_returns, date_rules, time_rules\n\ndef initialize(context):\n    # ... (\u8a2d\u5b9a benchmark)\n\n    # \u7bc4\u4f8b\uff1a\u6bcf\u65e5\u958b\u76e4\u5f8c\u53d6\u5f97 benchmark \u6b77\u53f2\u5831\u916c\n    schedule_function(\n        log_benchmark,\n        date_rules.every_day(),\n        time_rules.market_open()\n    )\n\ndef log_benchmark(context, data):\n    # \u53d6\u5f97\u5f9e\u56de\u6e2c\u958b\u59cb\u5230\u7576\u5929\u7684 benchmark \u5831\u916c\u7387 (\u4e00\u500b Pandas Series)\n    # \u6ce8\u610f\uff1a\u6b64\u51fd\u6578\u5728 TQuant Lab \u7bc4\u4f8b\u4e2d\u8f03\u5c11\u88ab\u76f4\u63a5\u4f7f\u7528\n    benchmark_returns = get_benchmark_returns() \n    print(benchmark_returns.tail())\n</code></pre>"},{"location":"how-to/data/get-risk-free-rate/","title":"\u5982\u4f55\u8a2d\u5b9a\u7121\u98a8\u96aa\u5229\u7387 (Risk-Free Rate)","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b\u5982\u4f55\u5728 Zipline \u56de\u6e2c\u4e2d\u8a2d\u5b9a\u7121\u98a8\u96aa\u5229\u7387\u7684\u8a73\u7d30\u6307\u5357\uff0c\u5305\u62ec <code>run_algorithm()</code> \u7684\u53c3\u6578\u8a2d\u5b9a\u548c <code>TargetPercentPipeAlgo</code> \u7684\u9078\u9805\uff0c\u5e6b\u52a9\u60a8\u7cbe\u78ba\u8a08\u7b97\u7b56\u7565\u7e3e\u6548\u6307\u6a19\u3002</p> <p>\u5728\u91cf\u5316\u5206\u6790\u4e2d\uff0c\u7121\u98a8\u96aa\u5229\u7387 (Risk-Free Rate) \u662f\u8a08\u7b97\u590f\u666e\u6bd4\u7387 (Sharpe Ratio) \u7b49\u95dc\u9375\u7e3e\u6548\u6307\u6a19\u6642\u4e0d\u53ef\u6216\u7f3a\u7684\u57fa\u6e96\u3002\u5b83\u4ee3\u8868\u4e86\u5728\u6c92\u6709\u627f\u64d4\u4efb\u4f55\u98a8\u96aa\u7684\u60c5\u6cc1\u4e0b\uff0c\u7406\u8ad6\u4e0a\u80fd\u5920\u7372\u5f97\u7684\u6295\u8cc7\u5831\u916c\u7387\u3002</p> <p>\u5728 TQuant Lab \u4e2d\uff0c\u8a2d\u5b9a\u7121\u98a8\u96aa\u5229\u7387\u7684\u65b9\u6cd5\u4e26\u975e\u4f7f\u7528 <code>set_risk_free_rate</code>\uff0c\u800c\u662f\u6839\u64da\u60a8\u7684\u4f7f\u7528\u5834\u666f\uff0c\u900f\u904e <code>run_algorithm()</code> \u51fd\u6578\u6216 <code>TargetPercentPipeAlgo</code> \u985e\u5225\u7684\u53c3\u6578\u4f86\u6307\u5b9a\u3002</p>"},{"location":"how-to/data/get-risk-free-rate/#run_algorithm","title":"\u65b9\u6cd5\u4e00\uff1a\u5728 run_algorithm() \u4e2d\u50b3\u5165\u81ea\u5b9a\u7fa9\u5229\u7387","text":"<p>\u7576\u60a8\u547c\u53eb <code>run_algorithm()</code> \u4f86\u57f7\u884c\u56de\u6e2c\u6642\uff0c\u53ef\u4ee5\u900f\u904e <code>treasury_returns</code> \u53c3\u6578\u50b3\u5165\u4e00\u500b\u81ea\u5b9a\u7fa9\u7684\u7121\u98a8\u96aa\u5229\u7387\u6642\u9593\u5e8f\u5217\u3002\u9019\u7d66\u4e86\u60a8\u6700\u9ad8\u7684\u5f48\u6027\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u4f86\u6e90\u7684\u6578\u64da\u4f5c\u70ba\u7121\u98a8\u96aa\u5229\u7387\u3002</p> <ul> <li>\u53c3\u6578: <code>treasury_returns</code></li> <li>\u985e\u578b: <code>pandas.Series</code></li> <li>\u7d22\u5f15 (Index): \u65e5\u671f (datetimes)</li> <li>\u503c (Values): \u6bcf\u65e5\u7684\u7121\u98a8\u96aa\u5831\u916c\u7387 (float)</li> </ul>"},{"location":"how-to/data/get-risk-free-rate/#2","title":"\u7bc4\u4f8b\uff1a\u8a2d\u5b9a\u4e00\u500b\u56fa\u5b9a\u7684 2% \u5e74\u5316\u7121\u98a8\u96aa\u5229\u7387","text":"<p>\u5728\u4ee5\u4e0b\u7bc4\u4f8b\u4e2d\uff0c\u6211\u5011\u5275\u5efa\u4e00\u500b\u8207\u56de\u6e2c\u671f\u9593\u9577\u5ea6\u76f8\u540c\u7684 <code>pd.Series</code>\uff0c\u6bcf\u65e5\u5229\u7387\u70ba <code>0.02 / 252</code> (\u5047\u8a2d\u4e00\u5e74\u6709 252 \u500b\u4ea4\u6613\u65e5)\u3002</p> <pre><code>import pandas as pd\nfrom zipline import run_algorithm\n\n# ... (\u5b9a\u7fa9\u60a8\u7684 initialize, handle_data, analyze \u51fd\u6578)\n\nstart_date = pd.Timestamp('2020-01-01', tz='UTC')\nend_date = pd.Timestamp('2023-01-01', tz='UTC')\n\n# \u5275\u5efa\u4e00\u500b\u56fa\u5b9a\u7684\u6bcf\u65e5\u7121\u98a8\u96aa\u5229\u7387\u5e8f\u5217\ndate_range = pd.date_range(start=start_date, end=end_date, freq='D', tz='UTC')\nfixed_rate_series = pd.Series(data=(0.02 / 252), index=date_range)\n\n# \u57f7\u884c\u56de\u6e2c\u6642\u50b3\u5165 treasury_returns \u53c3\u6578\nresults = run_algorithm(\n    start=start_date,\n    end=end_date,\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    capital_base=1e7,\n    bundle='tquant',\n    treasury_returns=fixed_rate_series  # &lt;--- \u5728\u6b64\u50b3\u5165\n)\n</code></pre>"},{"location":"how-to/data/get-risk-free-rate/#targetpercentpipealgo","title":"\u65b9\u6cd5\u4e8c\uff1a\u4f7f\u7528 TargetPercentPipeAlgo \u7684\u9810\u8a2d\u9078\u9805","text":"<p><code>TargetPercentPipeAlgo</code> \u662f TQuant Lab \u4e2d\u4e00\u500b\u65b9\u4fbf\u7684 Pipeline \u6f14\u7b97\u6cd5\u985e\u5225\u3002\u5728\u521d\u59cb\u5316\u6b64\u985e\u5225\u6642\uff0c\u60a8\u53ef\u4ee5\u900f\u904e <code>zero_treasury_returns</code> \u53c3\u6578\u4f86\u63a7\u5236\u7121\u98a8\u96aa\u5229\u7387\u7684\u884c\u70ba\u3002</p> <ul> <li>\u53c3\u6578: <code>zero_treasury_returns</code></li> <li>\u985e\u578b: <code>bool</code> (\u5e03\u6797\u503c)</li> </ul>"},{"location":"how-to/data/get-risk-free-rate/#_1","title":"\u7528\u6cd5","text":"<ul> <li> <p><code>zero_treasury_returns=True</code> (\u9810\u8a2d\u503c)</p> <ul> <li>\u9019\u6703\u5c07\u6574\u500b\u56de\u6e2c\u671f\u9593\u7684\u7121\u98a8\u96aa\u5229\u7387 \u8a2d\u5b9a\u70ba 0 \u3002\u9019\u662f\u6700\u7c21\u55ae\u7684\u65b9\u5f0f\uff0c\u9069\u7528\u65bc\u4e0d\u8003\u616e\u7121\u98a8\u96aa\u5229\u7387\u6216\u5e0c\u671b\u7c21\u5316\u8a08\u7b97\u7684\u5834\u666f\u3002</li> </ul> </li> <li> <p><code>zero_treasury_returns=False</code></p> <ul> <li>TQuant Lab \u6703\u81ea\u52d5\u900f\u904e TEJ API \u53d6\u5f97 \u7b2c\u4e00\u9280\u884c\u7684\u5e74\u5b9a\u5b58\u5229\u7387 \u4f5c\u70ba\u6bcf\u65e5\u7684\u7121\u98a8\u96aa\u5229\u7387\u3002</li> <li> <p>Important</p> <pre><code>\u4f7f\u7528\u6b64\u9078\u9805 (`False`) \u5c07\u6703 **\u6d88\u8017\u60a8\u7684 TEJ API \u6d41\u91cf** \u3002\n</code></pre> </li> </ul> </li> </ul>"},{"location":"how-to/data/get-risk-free-rate/#_2","title":"\u7bc4\u4f8b","text":"<pre><code>from zipline.algo.pipeline_algo import TargetPercentPipeAlgo\n\n# ... (\u5b9a\u7fa9\u60a8\u7684 create_pipeline \u51fd\u6578)\n\n# \u521d\u59cb\u5316\u6f14\u7b97\u6cd5\uff0c\u4e26\u8a2d\u5b9a\u4f7f\u7528 TEJ API \u63d0\u4f9b\u7684\u7121\u98a8\u96aa\u5229\u7387\nalgo = TargetPercentPipeAlgo(\n    create_pipeline=create_pipeline,\n    zero_treasury_returns=False  # &lt;--- \u5728\u6b64\u8a2d\u5b9a\n)\n\n# ... (\u4f7f\u7528 run_algorithm \u57f7\u884c algo)\n</code></pre>"},{"location":"how-to/data/ingest-spot-pricing/","title":"\u5982\u4f55 Ingest \u80a1\u7968\u50f9\u91cf\u8cc7\u6599","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b\u5982\u4f55\u5c07\u80a1\u7968\u50f9\u91cf\u8cc7\u6599 Ingest \u5230 TQuant Lab \u7684\u8a73\u7d30\u6307\u5357\uff0c\u4e26\u8aaa\u660e\u76f8\u95dc\u7684\u53c3\u6578\u8a2d\u5b9a\u8207\u6b65\u9a5f\u3002</p> <p>\u672c\u8ab2\u7a0b\u5be6\u4f5c\u5982\u4f55\u5c07\u8cc7\u6599\uff08\u5982\u50f9\u91cf\u3001\u57fa\u672c\u9762\u3001\u7c4c\u78bc\u9762\u7b49\uff09ingest \u5230 zipline \u56de\u6e2c\u5f15\u64ce\u4e2d\u3002\u900f\u904e\u9019\u500b\u52d5\u4f5c\uff0c\u5f8c\u7e8c\u4f7f\u7528 Pipeline API \u6642\uff0c\u5c31\u53ef\u4ee5\u5f88\u6709\u6548\u7387\u5730\u7372\u53d6\u8cc7\u6599\u4e26\u8a08\u7b97\u56e0\u5b50\u3002</p>"},{"location":"how-to/data/ingest-spot-pricing/#1","title":"1. \u8f09\u5165\u6240\u9700\u5957\u4ef6","text":"<pre><code>import os\n</code></pre>"},{"location":"how-to/data/ingest-spot-pricing/#2-bundle","title":"2. Bundle \u8a2d\u7f6e","text":"<p>\u4ecb\u7d39\u74b0\u5883\u8b8a\u6578\u8a2d\u5b9a\uff0c\u4e26\u904b\u7528\u8a2d\u5b9a\u7684\u74b0\u5883\u8b8a\u6578\u505a\u50f9\u91cf\u3001\u975e\u50f9\u91cf\u8cc7\u6599\u7684 bundle\u3002</p> <p>\u5728 import zipline \u524d\uff0c\u5fc5\u9808\u5148\u8a2d\u5b9a\u4ee5\u4e0b\u74b0\u5883\u8b8a\u6578(os.environ)\uff1a</p>"},{"location":"how-to/data/ingest-spot-pricing/#bundletquant-bundle","title":"\u50f9\u91cf\u8cc7\u6599 bundle\uff08tquant bundle\uff09\u8a2d\u5b9a","text":"<ul> <li><code>os.environ['TEJAPI_BASE'] = \"https://api.tej.com.tw\"</code><ul> <li>\u7528\u65bc\u9023\u7d50TEJ\u8cc7\u6599\u5eab</li> </ul> </li> <li><code>os.environ['TEJAPI_KEY'] = \"Your_Key\"</code><ul> <li>\u7528\u65bc\u8b58\u5225\u4f7f\u7528\u8005</li> </ul> </li> <li><code>os.environ['ticker'] = \"xxxx xxxx xxxx\"</code><ul> <li>\u8a2d\u7f6e\u6211\u5011\u6240\u9700\u8981\u7684\u80a1\u7968\u4ee3\u78bc</li> </ul> </li> <li><code>os.environ['mdate'] = \"yyyymmdd yyyymmdd\"</code><ul> <li>\u8a2d\u7f6e\u53d6\u5f97\u8cc7\u6599\u7684\u8d77\u59cb\u6642\u9593\u8207\u7d50\u675f\u6642\u9593</li> </ul> </li> <li><code>!zipline ingest -b tquant</code><ul> <li>\u5c07\u4e0a\u65b9\u8cc7\u6599 ingest \u9032 bundle\u3002</li> </ul> </li> </ul>"},{"location":"how-to/data/ingest-spot-pricing/#bundlefundamentals-bundle","title":"\u975e\u50f9\u91cf\u8cc7\u6599 bundle\uff08fundamentals bundle\uff09\u9700\u8981\u7684\u8cc7\u8a0a\uff1a","text":"<ul> <li><code>os.environ['fields'] = 'field1, field2, field3'</code><ul> <li>\u8a2d\u7f6e\u6488\u53d6\u975e\u50f9\u91cf\u8cc7\u6599\u7684\u6b04\u4f4d\uff0c\u5176\u4e2d field1\u3001field2\u3001field3 \u4ee3\u8868\u8cc7\u6599\u6b04\u4f4d\u540d\u7a31</li> </ul> </li> <li><code>os.environ['include_self_acc'] = 'N'(\u9810\u8a2d)</code><ul> <li>\u8a2d\u7f6e\u662f\u5426\u6db5\u84cb\u516c\u53f8\u81ea\u7d50\u8ca1\u52d9\uff0c\u5176\u4e2d\u8a2d\u5b9a<code>'Y'</code>\u4ee3\u8868\u8ca1\u52d9\u8cc7\u6599\u5305\u542b\u81ea\u7d50\u8ca1\u52d9\uff0c<code>'N'</code>\u5247\u8868\u793a\u4e0d\u5305\u542b</li> </ul> </li> <li><code>!zipline ingest -b fundamentals</code><ul> <li>\u5c07\u975e\u50f9\u91cf\u8cc7\u6599 ingest \u9032 bundle\u3002</li> </ul> </li> </ul>"},{"location":"how-to/data/ingest-spot-pricing/#3-zipline-ingest","title":"3. \u57f7\u884c zipline ingest \u8f09\u5165\u50f9\u91cf\u8cc7\u6599","text":"<p>\u50f9\u91cf\u8cc7\u6599\u6307 OHLCV \u8207\u9664\u6b0a\u606f\u76f8\u95dc\u8cc7\u8a0a\u3002\u4ee5\u4e0b\u7bc4\u4f8b\u8f09\u5165\u6307\u5b9a\u80a1\u7968\u50f9\u91cf\u8cc7\u6599\uff0c\u5176\u4e2d IR0001 \u70ba\u53f0\u7063\u767c\u884c\u91cf\u52a0\u6b0a\u80a1\u50f9\u5831\u916c\u6307\u6578\u3002</p> <pre><code>tickers = 'IR0001 0050 0056 00737 1108 1101 1102 1103 6243 6451 1216 1301 1303 1326 1402 1476 1590 1605 1722 1802 2002 2105 2201 2207 2227 2301 2939 4108 4148 6431 6541 6657 2883 2891 2543 2929 2303 6505 9926 2308 2311 2317 2324 2325 2327 2330 2347 2353 2354 2357 2379 2382 2395 2408 2409 2412 2448 2454 2474 2492 2498 2603 2609 2615 2618 2633 2801 2823 2880 2881 2882 2883 2884 2885 2886 2887 2888 2890 2891 2892 2912 3008 3009 3034 3037 3045 3231 3474 3481 3673 3697 3711 4904 4938 5854 5871 5876 5880 6239 6415 6505 6669 6770 8046 8454 9904 9910'\nprint(\"\u7e3d\u5171\u6709 :\",len(tickers.split()),\"\u7b46\u8cc7\u6599\")\n\n\nos.environ[\"TEJAPI_BASE\"] = 'https://api.tej.com.tw'\nos.environ['TEJAPI_KEY'] = \"Your_Key\"\nos.environ['ticker'] = tickers\nos.environ['mdate'] = '20200103 20230530'\n\n!zipline ingest -b tquant\n</code></pre>"},{"location":"how-to/data/ingest-spot-pricing/#4-simple_ingest","title":"4. \u4f7f\u7528 simple_ingest() \u8f09\u5165\u50f9\u91cf\u8cc7\u6599","text":"<p><code>simple_ingest()</code>\u51fd\u6578\u63d0\u4f9b\u53e6\u4e00\u7a2e\u53d6\u5f97\u6307\u5b9a\u80a1\u7968\u50f9\u91cf\u8cc7\u6599\u7684\u65b9\u6cd5\uff0c\u8cc7\u6599\u540c\u6a23\u6703\u5b58\u5165 bundle \u4e2d\uff1a</p> <p><code>simple_ingest()</code>\u51fd\u6578\u8f09\u5165\u50f9\u91cf\u8cc7\u6599\u6240\u9700\u53c3\u6578\u8cc7\u8a0a\u5982\u4e0b\uff1a</p> <ul> <li><code>name</code> (<code>str</code>) = <code>'tquant'</code><ul> <li>\u5b9a\u7fa9 bundle \u540d\u7a31</li> </ul> </li> <li><code>tickers</code> (<code>list</code> or <code>str</code>) = <code>['xxxx', 'xxxx', 'xxxx']</code> or <code>'xxxx xxxx xxxx'</code><ul> <li>\u8a2d\u7f6e\u6211\u5011\u9700\u8981\u7684\u80a1\u7968\u4ee3\u78bc</li> </ul> </li> <li><code>start_date</code> (<code>str</code>) = <code>'yyyy-mm-dd'</code><ul> <li>\u8a2d\u7f6e\u8d77\u59cb\u65e5\u671f</li> </ul> </li> <li><code>end_date</code> (<code>str</code>) = <code>'yyyy-mm-dd'</code><ul> <li>\u8a2d\u7f6e\u7d50\u675f\u65e5\u671f</li> </ul> </li> </ul> <p>Important</p> <p>\u8acb\u6ce8\u610f\uff0c<code>zipline ingest</code> \u548c <code>zipline add</code> \u6307\u4ee4\u5728\u57f7\u884c\u6642\u6703\u9023\u63a5\u81f3 TEJ \u4f3a\u670d\u5668\u4ee5\u8f09\u5165\u8cc7\u6599\u3002\u9019\u6703 \u6d88\u8017\u60a8\u7684 TEJ API \u6d41\u91cf\u3002</p> <pre><code>from zipline.data.run_ingest import simple_ingest\n\nstart = '2020-01-03'\nend = '2023-05-30'\n\nsimple_ingest(name = 'tquant',\n              tickers = tickers,\n              start_date = start,\n              end_date = end\n              )\n</code></pre>"},{"location":"how-to/data/ingest-spot-pricing/#5","title":"5. \u66f4\u65b0\u50f9\u91cf\u8cc7\u6599","text":"<p>\u900f\u904e\u8f38\u5165 <code>zipline update -b tquant</code> \u6307\u4ee4\uff0c\u53ef\u4ee5\u66f4\u65b0\u7576\u524d\u4f7f\u7528\u7684 tquant bundle\uff0c\u4ee5\u7372\u5f97\u6700\u65b0\u7684\u4ea4\u6613\u50f9\u683c\u548c\u4ea4\u6613\u91cf\u8cc7\u8a0a\u3002</p> <p><pre><code># \u57f7\u884c\u524d\n!zipline bundle-info\n</code></pre> <pre><code>!zipline update -b tquant\n</code></pre> <pre><code># \u57f7\u884c\u5f8c\n!zipline bundle-info\n</code></pre></p>"},{"location":"how-to/data/ingest-spot-pricing/#6","title":"6. \u65b0\u589e\u50f9\u91cf\u8cc7\u6599","text":"<p>\u4f7f\u7528 <code>zipline add -t &lt;tickers_want_to_add&gt;</code> \u6307\u4ee4\uff0c\u53ef\u4ee5\u5411\u73fe\u6709\u7684 tquant bundle \u4e2d\u65b0\u589e\u6240\u9078\u7684\u80a1\u7968\u3002</p> <p><pre><code># \u57f7\u884c\u524d\n!zipline bundle-info\n</code></pre> <pre><code>!zipline add -t \"6523 6208\"\n</code></pre> <pre><code># \u57f7\u884c\u5f8c\n!zipline bundle-info\n</code></pre></p>"},{"location":"how-to/data/ingest-tej-fundamental/","title":"\u5982\u4f55 Ingest TEJ \u8ca1\u52d9/\u975e\u8ca1\u52d9\u8cc7\u6599","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b\u5982\u4f55\u5c07 TEJ \u8ca1\u52d9/\u975e\u8ca1\u52d9\u8cc7\u6599 Ingest \u5230 TQuant Lab \u7684\u8a73\u7d30\u6307\u5357\uff0c\u4e26\u8aaa\u660e\u76f8\u95dc\u7684\u53c3\u6578\u8a2d\u5b9a\u8207\u6b65\u9a5f\u3002</p>"},{"location":"how-to/data/ingest-tej-fundamental/#1-zipline-ingest","title":"1. \u4f7f\u7528 zipline ingest \u8f09\u5165\u975e\u50f9\u91cf\u8cc7\u6599","text":"<ul> <li>\u6b04\u4f4d\u5c0d\u7167\u6e05\u55ae\u53ef\u53c3\u8003TQuant\u5b98\u65b9\u7db2\u7ad9\u6700\u4e0b\u65b9\u7684 TEJ TOOL API \u6b04\u4f4d\u5c0d\u7167\u6e05\u55ae\u3002 \u8a2d\u5b9a\u5b8c <code>os.environ['fields']</code> \u5f8c\uff0c\u4fbf\u53ef\u4f7f\u7528 <code>!zipline ingest -b fundamentals</code> \u8f09\u5165\u6240\u9700\u8981\u7684\u975e\u50f9\u91cf\u8cc7\u6599\u3002</li> </ul> <p><pre><code>columns = ['Sales_Growth_Rate','Operating_Income_Growth_Rate', \n           'Pre_Tax_Income_Growth_Rate','Net_Income_Growth_Rate',\n           'Industry_Eng','Industry', 'roi', 'YoY_Monthly_Sales','mktcap']\n</code></pre> <pre><code>os.environ['fields'] = \" \".join(columns)\n!zipline ingest -b fundamentals\n</code></pre></p>"},{"location":"how-to/data/ingest-tej-fundamental/#2-simple_ingest","title":"2. \u4f7f\u7528 simple_ingest() \u8f09\u5165\u975e\u50f9\u91cf\u8cc7\u6599","text":"<p><code>simple_ingest()</code>\u51fd\u6578\u63d0\u4f9b\u53e6\u4e00\u7a2e\u53d6\u5f97\u6307\u5b9a\u80a1\u7968\u975e\u50f9\u91cf\u8cc7\u6599\u7684\u65b9\u6cd5\uff0c\u8cc7\u6599\u540c\u6a23\u6703\u5b58\u5165 bundle \u4e2d\uff1a</p> <p><code>simple_ingest()</code>\u51fd\u6578\u8f09\u5165\u975e\u50f9\u91cf\u8cc7\u6599\u6240\u9700\u53c3\u6578\u8cc7\u8a0a\u5982\u4e0b\uff1a</p> <ul> <li><code>name</code> (<code>str</code>) = <code>'fundamentals'</code><ul> <li>\u5b9a\u7fa9 bundle \u540d\u7a31</li> </ul> </li> <li><code>tickers</code> (<code>list</code> or <code>str</code>) = <code>['xxxx', 'xxxx', 'xxxx']</code> or <code>'xxxx xxxx xxxx'</code><ul> <li>\u8a2d\u7f6e\u6211\u5011\u9700\u8981\u7684\u80a1\u7968\u4ee3\u78bc</li> </ul> </li> <li><code>fields</code> (<code>list</code> or <code>str</code>) = <code>['field1', 'field2', 'field3']</code> or <code>'field1, field2, field3'</code><ul> <li>\u8a2d\u7f6e\u6488\u53d6\u975e\u50f9\u91cf\u8cc7\u6599\u7684\u6b04\u4f4d\uff0c\u5176\u4e2d field1\u3001field2\u3001field3 \u4ee3\u8868\u8cc7\u6599\u6b04\u4f4d\u540d\u7a31</li> </ul> </li> <li><code>start_date</code> (<code>str</code>) = <code>'yyyy-mm-dd'</code><ul> <li>\u8a2d\u7f6e\u8d77\u59cb\u65e5\u671f</li> </ul> </li> <li><code>end_date</code> (<code>str</code>) = <code>'yyyy-mm-dd'</code><ul> <li>\u8a2d\u7f6e\u7d50\u675f\u65e5\u671f</li> </ul> </li> <li><code>self_acc</code> (<code>str</code>) = <code>'N'</code>(\u9810\u8a2d)<ul> <li>\u8a2d\u7f6e\u662f\u5426\u6db5\u84cb\u516c\u53f8\u81ea\u7d50\u8ca1\u52d9\uff0c\u5176\u4e2d\u8a2d\u5b9a<code>'Y'</code>\u4ee3\u8868\u8ca1\u52d9\u8cc7\u6599\u5305\u542b\u81ea\u7d50\u8ca1\u52d9\uff0c<code>'N'</code>\u5247\u8868\u793a\u4e0d\u5305\u542b</li> </ul> </li> </ul> <p>Note</p> <p>\u9810\u8a2d <code>self_acc</code> \u70ba <code>'N'</code>\uff0c\u5373\u4e0d\u5305\u542b\u516c\u53f8\u81ea\u7d50\u8ca1\u52d9\u3002\u82e5\u8981\u5305\u542b\uff0c\u8acb\u8a2d\u5b9a\u70ba <code>'Y'</code>\u3002</p> <pre><code>simple_ingest(name = 'fundamentals',\n              tickers = tickers,\n              fields = columns,\n              start_date = start,\n              end_date = end,\n              # self_acc = 'Y'\n              )\n</code></pre>"},{"location":"how-to/data/ingest-tej-fundamental/#3","title":"3. \u66f4\u65b0\u975e\u50f9\u91cf\u8cc7\u6599","text":"<p>\u900f\u904e\u8f38\u5165 <code>!zipline update -b tquant</code> \u6307\u4ee4\uff0c\u53ef\u4ee5\u66f4\u65b0\u7576\u524d\u4f7f\u7528\u7684 fundamentals bundle\uff0c\u4ee5\u7372\u5f97\u6700\u65b0\u7684\u8cc7\u8a0a\u3002</p> <p><pre><code>## update \u524d\nfrom zipline.data.data_portal import get_fundamentals\ndf = get_fundamentals()\nprint('\u80a1\u7968\u6c60\u70ba:',df['symbol'].unique())\nprint('\u8d77\u59cb\u65e5:',df['date'].min())\nprint('\u7d50\u675f\u65e5:',df['date'].max())\nprint('\u6b04\u4f4d:',df.columns)\n</code></pre> <pre><code>!zipline update -b fundamentals\n</code></pre> <pre><code># update \u5f8c\ndf = get_fundamentals()\nprint('\u80a1\u7968\u6c60\u70ba:',df['symbol'].unique())\nprint('\u8d77\u59cb\u65e5:',df['date'].min())\nprint('\u7d50\u675f\u65e5:',df['date'].max())\nprint('\u6b04\u4f4d:',df.columns)\n</code></pre></p>"},{"location":"how-to/data/ingest-tej-fundamental/#4","title":"4. \u65b0\u589e\u975e\u50f9\u91cf\u8cc7\u6599","text":"<ul> <li> <p>\u57f7\u884c\u6307\u4ee4 <code>zipline add -b fundamentals -t &lt;tickers_want_to_add&gt;</code> \u53ef\u4ee5\u6839\u64da\u7576\u524d fundamentls bundle \u7684\u6b04\u4f4d\uff0c\u65b0\u589e\u6240\u9078\u64c7\u7684\u516c\u53f8\u5230 bundle \u4e2d\u3002</p> </li> <li> <p>\uff08fundamentls bundle \u9650\u5b9a\uff09\u900f\u904e\u6307\u4ee4 <code>!zipline add -b fundamentals -f &lt;columns_want_to_add&gt;</code>\uff08\u5176\u4e2d -f \u4ee3\u8868 field\uff09\u4f86\u65b0\u589e\u7576\u524d\u5df2\u6709\u516c\u53f8\u7684\u6307\u5b9a\u8cc7\u6599\u6b04\u4f4d\u3002</p> </li> <li> <p>\u8acb\u6ce8\u610f\uff0c\u76ee\u524d\u7cfb\u7d71\u4e0d\u652f\u63f4\u540c\u6642\u65b0\u589e\u516c\u53f8\u548c\u8cc7\u6599\u6b04\u4f4d\uff0c\u56e0\u6b64\u9700\u8981\u5206\u5225\u9032\u884c\u9019\u4e9b\u64cd\u4f5c\u3002</p> </li> </ul> <p><pre><code># add \u516c\u53f8\n!zipline add -b fundamentals -t \"6523 6208\"\n</code></pre> <pre><code># add \u516c\u53f8\u5f8c\ndf = get_fundamentals()\nprint('\u80a1\u7968\u6c60\u70ba:',df['symbol'].unique())\nprint('\u8d77\u59cb\u65e5:',df['date'].min())\nprint('\u7d50\u675f\u65e5:',df['date'].max())\nprint('\u6b04\u4f4d:',df.columns)\n</code></pre> <pre><code># add \u6b04\u4f4d\n!zipline add -b fundamentals -f Gross_Margin_Growth_Rate\n</code></pre> <pre><code># add \u6b04\u4f4d\u5f8c\ndf = get_fundamentals()\nprint('\u80a1\u7968\u6c60\u70ba:',df['symbol'].unique())\nprint('\u8d77\u59cb\u65e5:',df['date'].min())\nprint('\u7d50\u675f\u65e5:',df['date'].max())\nprint('\u6b04\u4f4d:',df.columns)\n</code></pre></p>"},{"location":"how-to/data/use-dataframeloader/","title":"\u5982\u4f55\u4f7f\u7528 Pipeline DataFrameLoader \u5efa\u7acb Custom Data","text":"<p>Info</p> <p>\u672c\u9801\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 <code>DataFrameLoader</code> \u5c07\u5ba2\u88fd\u5316\u6578\u64da\u5c0e\u5165 Zipline Pipeline\uff0c\u4e26\u6f14\u793a\u5176\u5728\u6578\u64da\u6574\u5408\u8207\u8655\u7406\u4e0a\u7684\u61c9\u7528\uff0c\u64f4\u5c55 Pipeline \u7684\u6578\u64da\u4f86\u6e90\u3002</p> <p><code>DataFrameLoader</code> \u5141\u8a31\u5c07\u5ba2\u88fd\u5316\u7684\u6578\u64da\u900f\u904e DataFrame \u5c0e\u5165\u81f3 pipeline \u4e2d\uff0c\u672c\u7bc4\u4f8b\u5c07\u6f14\u793a <code>DataFrameLoader</code> \u7684\u7528\u6cd5\u3002</p>"},{"location":"how-to/data/use-dataframeloader/#imports-settings","title":"Imports &amp; Settings","text":"<pre><code>import os\nimport pandas as pd\n\nos.environ['TEJAPI_BASE'] = 'https://api.tej.com.tw'\nos.environ['TEJAPI_KEY'] = 'YOUR KEY'\n\n\nfrom zipline.pipeline import Pipeline\nfrom zipline.pipeline.loaders import EquityPricingLoader\nfrom zipline.pipeline.loaders.frame import DataFrameLoader\nfrom zipline.pipeline.data import Column, DataSet, TQAltDataSet, EquityPricing\nfrom zipline.pipeline.engine import SimplePipelineEngine\nfrom zipline.pipeline.domain import TW_EQUITIES\n\nfrom zipline.data.data_portal import bundles\nfrom zipline.data.run_ingest import simple_ingest\n\nfrom zipline.sources.TEJ_Api_Data import get_universe\n\nfrom TejToolAPI.TejToolAPI import get_history_data\n</code></pre>"},{"location":"how-to/data/use-dataframeloader/#1-tquant-bundle","title":"1. \u8f09\u5165\u5148\u524d\u5df2\u5c0e\u5165\u7684 tquant bundle","text":"<ul> <li>\u82e5\u5c1a\u672a\u57f7\u884c tquant bundle ingest \u7684\u6d41\u7a0b\uff0c\u8acb\u5148\u57f7\u884c\u4ee5\u4e0b simple_ingest \u7a0b\u5f0f\u3002</li> <li><code>bundles.load</code> \u51fd\u5f0f\u8ca0\u8cac\u5f9e\u5148\u524d\u5df2\u7d93 ingest \u7684 bundle \u4e2d\u8f09\u5165\u6578\u64da\uff0c\u4f7f\u4f7f\u7528\u8005\u80fd\u5920\u5728 Zipline \u74b0\u5883\u4e2d\u5229\u7528 <code>AssetFinder</code> \u5b58\u53d6\u8b49\u5238 <code>SID</code>\uff08Security Identifier\uff09\u3002</li> </ul> <pre><code>start = '2020-01-03'\nend = '2025-02-07'\n\nstart_dt = pd.Timestamp(start, tz='utc')\nend_dt = pd.Timestamp(end, tz='utc')\n\npool = get_universe(start, end, idx_id=['IX0002'])\n\n#simple_ingest(name = 'tquant', tickers = pool, start_date = start , end_date = end)\n</code></pre> <pre><code>bundle_name = 'tquant'\nbundle = bundles.load(bundle_name)\n</code></pre>"},{"location":"how-to/data/use-dataframeloader/#2-symbols","title":"2. \u53d6\u5f97\u8b49\u5238\u6a19\u7684\uff08Symbols\uff09","text":"<p>\u5728 Zipline \u4e2d\uff0c<code>AssetFinder</code> \u662f\u4e00\u500b\u5c08\u9580\u8ca0\u8cac\u7ba1\u7406\u8cc7\u7522\uff08<code>Asset</code>\uff09\u8cc7\u8a0a\u7684\u5de5\u5177\uff0c\u63d0\u4f9b\u67e5\u627e\u548c\u6aa2\u7d22\u8b49\u5238\u6a19\u7684\u7684\u529f\u80fd\u3002\u4ee5\u4e0b\u56db\u884c\u7a0b\u5f0f\u78bc\u5206\u5225\u57f7\u884c\uff1a</p> <ol> <li>\u53d6\u5f97 bundle \u4e2d\u6240\u6709\u80a1\u7968\u7684 <code>SID</code>\u3002</li> <li>\u900f\u904e SID \u53d6\u5f97\u5c0d\u61c9\u7684 <code>Asset</code> \u7269\u4ef6\u3002</li> <li>\u900f\u904e <code>Asset</code> \u7269\u4ef6\u53d6\u5f97\u4ea4\u6613\u4ee3\u78bc\uff08<code>symbol</code>\uff09\u3002</li> <li>\u5efa\u7acb <code>symbol</code> mapping <code>SID</code> \u7684\u5c0d\u7167\u3002</li> </ol> <pre><code>sids = bundle.asset_finder.equities_sids\nassets = bundle.asset_finder.retrieve_all(sids)\nsymbols = [i.symbol for i in assets]\nsymbol_map = dict(zip(symbols, sids))\n</code></pre>"},{"location":"how-to/data/use-dataframeloader/#3-tej-tool-api","title":"3. \u5229\u7528 TEJ TOOL API \u7372\u53d6\u8cc7\u6599","text":"<p>\u9019\u908a\u53d6\u5f97\u5916\u8cc7\u8cb7\u8ce3\u8d85\u5f35\u6578\uff08<code>Qfii_Diff_Vol</code>\uff09\u8cc7\u6599\u4f5c\u70ba\u793a\u7bc4\u3002</p> <pre><code>custom_data = get_history_data(\n    ticker=symbols,\n    columns=['Qfii_Diff_Vol'],\n    start=start,\n    end=end,\n    transfer_to_chinese=False\n)\n</code></pre> <pre><code>custom_data.head()\n</code></pre>"},{"location":"how-to/data/use-dataframeloader/#4-dataframeloader","title":"4. \u6574\u7406\u5916\u90e8\u8cc7\u6599\u4ee5\u7b26\u5408 DataFrameLoader \u8981\u6c42\u7684\u683c\u5f0f","text":"<ul> <li>\u5c07\u5916\u90e8\u8cc7\u6599\u4f5c\u8f49\u7f6e\uff0c\u4e00\u500b\u6b04\u4f4d\u6574\u7406\u70ba\u4e00\u500b DataFrame\u3002</li> <li>\u63a5\u8457\u5c07\u5916\u90e8\u8cc7\u6599\u7684 coid \u66ff\u63db\u6210 <code>SID</code>\u3002</li> <li>\u6700\u5f8c\u5c07\u5916\u90e8\u8cc7\u6599\u7684 mdate \u8a2d\u5b9a\u70ba UTC \u6642\u5340\u3002</li> </ul> <p>\u8a3b\uff1a\u6b64\u8655\u8cc7\u6599\u63a1\u7528 \u4e0d\u5e73\u79fb \u7684\u65b9\u5f0f\u9032\u884c\u8655\u7406</p> <pre><code>transform_data = (\n    custom_data\n    .set_index(['coid', 'mdate'])['Qfii_Diff_Vol']\n    .unstack('coid')\n    .rename(columns=symbol_map, errors='raise') # errors = 'raise' \u6703\u5728\u9047\u5230\u932f\u8aa4\u6642\u62cb\u51fa\u7570\u5e38\uff0c\u907f\u514d bundle \u8207 custom_data \u8cc7\u7522\u4e0d\u4e00\u81f4\n    .tz_localize('UTC')\n)\n</code></pre> <pre><code>transform_data.head()\n</code></pre>"},{"location":"how-to/factor-analysis/alphalens-tearsheet/","title":"\u5982\u4f55\u57f7\u884c Alphalens \u56e0\u5b50\u5206\u6790","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b\u5982\u4f55\u5728 TQuant Lab \u4e2d\u4f7f\u7528 Alphalens \u9032\u884c\u56e0\u5b50\u5206\u6790\u7684\u8a73\u7d30\u6307\u5357\uff0c\u5305\u62ec\u56e0\u5b50\u6578\u64da\u6e96\u5099\u3001\u6e05\u6d17\u3001\u5c0d\u9f4a\uff0c\u4ee5\u53ca\u751f\u6210\u5b8c\u6574\u7684\u56e0\u5b50\u5206\u6790\u5831\u8868 (Tear Sheet)\u3002</p> <p>Alphalens \u662f\u4e00\u500b\u5f37\u5927\u7684 Python \u5eab\uff0c\u5c08\u70ba\u91cf\u5316\u6295\u8cc7\u4e2d\u7684\u56e0\u5b50\uff08Alpha\uff09\u5206\u6790\u800c\u8a2d\u8a08\u3002\u5b83\u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u5de5\u5177\uff0c\u7528\u65bc\u8a55\u4f30\u56e0\u5b50\uff08\u5982\u50f9\u503c\u3001\u52d5\u91cf\u3001\u6210\u9577\u7b49\uff09\u7684\u9810\u6e2c\u80fd\u529b\u3001\u6536\u76ca\u8ca2\u737b\u3001\u7a69\u5b9a\u6027\u4ee5\u53ca\u4ea4\u6613\u6210\u672c\u5f71\u97ff\u3002\u900f\u904e Alphalens\uff0c\u60a8\u53ef\u4ee5\u6df1\u5165\u4e86\u89e3\u56e0\u5b50\u7684\u8cea\u91cf\uff0c\u70ba\u7b56\u7565\u958b\u767c\u548c\u512a\u5316\u63d0\u4f9b\u95dc\u9375\u6d1e\u5bdf\u3002</p> <p>\u672c\u6307\u5357\u5c07\u8aaa\u660e\u5982\u4f55\u5c07 Zipline <code>Pipeline</code> \u7522\u751f\u7684\u56e0\u5b50\u6578\u64da\u5c0e\u5165 Alphalens\uff0c\u4e26\u751f\u6210\u5b8c\u6574\u7684\u56e0\u5b50\u5206\u6790\u5831\u8868 (tearsheet)\u3002</p>"},{"location":"how-to/factor-analysis/alphalens-tearsheet/#1","title":"1. \u56e0\u5b50\u6578\u64da\u6e96\u5099","text":"<p>\u5728\u5c07\u56e0\u5b50\u6578\u64da\u50b3\u905e\u7d66 Alphalens \u4e4b\u524d\uff0c\u60a8\u9700\u8981\u5f9e Zipline <code>Pipeline</code> \u7684\u8f38\u51fa\u4e2d\u63d0\u53d6\u56e0\u5b50\u503c\u548c\u76f8\u61c9\u7684\u80a1\u7968\u50f9\u683c\uff0c\u4e26\u5c07\u5b83\u5011\u6574\u7406\u6210 Alphalens \u6240\u9700\u7684\u7279\u5b9a\u683c\u5f0f\u3002<code>alphalens.utils.get_clean_factor_and_forward_returns()</code> \u51fd\u6578\u662f\u5b8c\u6210\u6b64\u6b65\u9a5f\u7684\u6838\u5fc3\u5de5\u5177\u3002</p>"},{"location":"how-to/factor-analysis/alphalens-tearsheet/#_1","title":"\u6838\u5fc3\u6578\u64da\u985e\u578b\uff1a","text":"<ul> <li><code>factor</code>: <code>pd.Series</code>\uff0c\u5305\u542b\u56e0\u5b50\u503c\uff0c\u7d22\u5f15\u901a\u5e38\u70ba <code>(\u65e5\u671f, \u8cc7\u7522)</code> \u7684 MultiIndex\u3002</li> <li><code>prices</code>: <code>pd.DataFrame</code> \u6216 <code>pd.Series</code>\uff0c\u5305\u542b\u80a1\u7968\u7684\u6b77\u53f2\u50f9\u683c\u6578\u64da\uff0c\u901a\u5e38\u662f\u6536\u76e4\u50f9\u3002</li> <li><code>groupby</code>: (\u53ef\u9078) <code>pd.Series</code> \u6216 <code>dict</code>\uff0c\u7528\u65bc\u6307\u5b9a\u80a1\u7968\u7684\u6240\u5c6c\u5206\u7d44\uff08\u4f8b\u5982\u884c\u696d\u3001\u677f\u584a\uff09\uff0c\u4ee5\u4fbf\u9032\u884c\u5206\u7d44\u5206\u6790\u3002</li> </ul>"},{"location":"how-to/factor-analysis/alphalens-tearsheet/#get_clean_factor_and_forward_returns","title":"\u6578\u64da\u63d0\u53d6\u8207\u6e05\u6d17\u51fd\u6578\uff1aget_clean_factor_and_forward_returns()","text":"<p>\u6b64\u51fd\u6578\u6703\u6e05\u6d17\u56e0\u5b50\u6578\u64da\uff08\u8655\u7406 NaN \u503c\u3001\u6975\u7aef\u503c\u7b49\uff09\uff0c\u4e26\u6839\u64da\u63d0\u4f9b\u7684\u50f9\u683c\u6578\u64da\u8a08\u7b97\u51fa\u4e0d\u540c\u6301\u6709\u671f\u7684\u9060\u671f\u5831\u916c\u7387 (forward returns)\uff0c\u6700\u7d42\u5c07\u6578\u64da\u8f49\u63db\u70ba Alphalens \u5206\u6790\u6240\u9700\u7684 <code>factor_data</code> \u683c\u5f0f\u3002</p> <ul> <li><code>factor</code>: (\u5fc5\u8981) \u56e0\u5b50\u6578\u64da\u3002</li> <li><code>prices</code>: (\u5fc5\u8981) \u50f9\u683c\u6578\u64da\u3002</li> <li><code>groupby</code>: (\u53ef\u9078) \u5206\u7d44\u6578\u64da\u3002</li> <li><code>periods</code>: (\u53ef\u9078) \u9060\u671f\u5831\u916c\u7387\u7684\u6301\u6709\u671f\u5217\u8868\uff0c\u4f8b\u5982 <code>[1, 5, 10]</code> \u4ee3\u8868\u8a08\u7b97 1 \u5929\u30015 \u5929\u300110 \u5929\u5f8c\u7684\u5831\u916c\u7387\u3002</li> </ul> <pre><code>import pandas as pd\nimport alphalens.utils as alu\n\n# \u5047\u8a2d factor_values \u662f\u60a8\u5f9e Zipline Pipeline \u7372\u5f97\u7684\u56e0\u5b50\u6578\u64da (pd.Series)\n# \u5047\u8a2d pricing_data \u662f\u60a8\u7684\u80a1\u7968\u6b77\u53f2\u50f9\u683c\u6578\u64da (pd.DataFrame)\n\n# \u4f8b\u5982\uff1a\u5f9e Zipline \u56de\u6e2c\u7d50\u679c\u4e2d\u7372\u53d6\u56e0\u5b50\u548c\u50f9\u683c\n# from zipline.pipeline import Pipeline\n# from zipline.pipeline.factors import SimpleMovingAverage\n# from zipline.pipeline.data import EquityPricing\n# from zipline import run_algorithm\n# ... (Zipline \u56de\u6e2c\u8a2d\u7f6e)\n\n# # \u5047\u8a2d\u4f60\u5df2\u7d93\u904b\u884c\u4e86\u5305\u542b Pipeline \u7684 backtest\uff0cresults \u4e2d\u5305\u542b\u4e86 factor_values \u548c pricing_data\n# # \u70ba\u4e86\u7bc4\u4f8b\u4e2d\u7368\u7acb\u6f14\u793a\uff0c\u9019\u88e1\u5275\u5efa\u4e00\u4e9b\u6a21\u64ec\u6578\u64da\n# dates = pd.to_datetime(pd.date_range('2020-01-01', periods=100, freq='D'), tz='UTC')\n# assets = ['2330', '2303', '2454']\n# # factor_index = pd.MultiIndex.from_product([dates, assets], names=['date', 'asset'])\n# factor_values = pd.Series(np.random.rand(len(factor_index)), index=factor_index)\n# # price_index = pd.MultiIndex.from_product([dates, assets], names=['date', 'asset'])\n# price_values = pd.Series(100 + np.random.randn(len(price_index)).cumsum(), index=price_index)\n# pricing_data = price_values.unstack().loc[dates, assets] # \u8f49\u63db\u70ba DataFrame \u683c\u5f0f\n# # # --- \u5be6\u969b\u5f9e Zipline \u7372\u53d6\u6578\u64da\u7684\u7bc4\u4f8b ---\n# # from zipline.pipeline import Pipeline\n# # from zipline.pipeline.factors import SimpleMovingAverage\n# # from zipline.pipeline.data import EquityPricing\n# # from zipline.api import attach_pipeline, pipeline_output, symbol, set_benchmark\n# # from zipline import run_algorithm\n# #\n# # def make_simple_pipeline():\n# #     sma_factor = SimpleMovingAverage(inputs=[EquityPricing.close], window_length=20)\n# #     return Pipeline(columns={'my_factor': sma_factor})\n# #\n# # def initialize(context):\n# #     context.assets = [symbol('2330'), symbol('2303')]\n# #     attach_pipeline(make_simple_pipeline(), 'my_pipeline')\n# #     set_benchmark(symbol('IR0001'))\n# #\n# # def handle_data(context, data):\n# #     pass\n# #\n# # def analyze(context, perf):\n# #     pass\n# #\n# # results = run_algorithm(\n# #     start=pd.Timestamp('2020-01-01', tz='UTC'),\n# #     end=pd.Timestamp('2021-01-01', tz='UTC'),\n# #     initialize=initialize,\n# #     handle_data=handle_data,\n# #     analyze=analyze,\n# #     capital_base=1e6,\n# #     bundle='tquant'\n# # )\n# #\n# # # \u63d0\u53d6 factor\n# # factor_values = results.xs('my_pipeline', level=1, axis=1)['my_factor']\n# #\n# # # \u63d0\u53d6\u50f9\u683c\u6578\u64da (\u901a\u5e38\u662f Zipline results \u4e2d\u7684 'close_price')\n# # pricing_data = results['close_price'] # \u9019\u9700\u8981\u6839\u64da\u5be6\u969b results \u7d50\u69cb\u8abf\u6574\n\n\n# \u7372\u53d6\u6e05\u6d17\u5f8c\u7684\u56e0\u5b50\u6578\u64da\u548c\u9060\u671f\u5831\u916c\n# \u9019\u88e1\u4f7f\u7528\u4e00\u500b\u7c21\u55ae\u7684\u6a21\u64ec factor \u548c pricing_data \u9032\u884c\u6f14\u793a\n# \u5728\u771f\u5be6\u5834\u666f\u4e2d\uff0c\u9019\u4e9b\u6578\u64da\u6703\u4f86\u81ea Zipline Pipeline \u7684\u8f38\u51fa\nfactor_values = pd.Series(\n    data=[0.5, 0.2, -0.1, 0.8, -0.3, 0.1],\n    index=pd.MultiIndex.from_tuples([\n        (pd.Timestamp('2022-01-03', tz='UTC'), '2330'),\n        (pd.Timestamp('2022-01-03', tz='UTC'), '2454'),\n        (pd.Timestamp('2022-01-04', tz='UTC'), '2330'),\n        (pd.Timestamp('2022-01-04', tz='UTC'), '2454'),\n        (pd.Timestamp('2022-01-05', tz='UTC'), '2330'),\n        (pd.Timestamp('2022-01-05', tz='UTC'), '2454'),\n    ], names=['date', 'asset'])\n)\n\npricing_data = pd.DataFrame(\n    data={'2330': [100, 101, 102], '2454': [50, 51, 52]},\n    index=pd.to_datetime(['2022-01-03', '2022-01-04', '2022-01-05'], tz='UTC')\n)\n\n\nfactor_data = alu.get_clean_factor_and_forward_returns(\n    factor=factor_values,\n    prices=pricing_data,\n    periods=[1, 5, 10] # \u8a08\u7b97 1, 5, 10 \u65e5\u7684\u9060\u671f\u5831\u916c\n)\n\nprint(factor_data.head())\n</code></pre>"},{"location":"how-to/factor-analysis/alphalens-tearsheet/#2-create_full_tear_sheet","title":"2. \u751f\u6210\u5b8c\u6574\u7684\u56e0\u5b50\u5206\u6790\u5831\u8868 (create_full_tear_sheet())","text":"<p>\u7576\u60a8\u6e96\u5099\u597d <code>factor_data</code> \u5f8c\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>alphalens.tears.create_full_tear_sheet()</code> \u51fd\u6578\u4f86\u751f\u6210\u5305\u542b\u5404\u9805\u5716\u8868\u548c\u7d71\u8a08\u6578\u64da\u7684\u5b8c\u6574\u56e0\u5b50\u5206\u6790\u5831\u8868\u3002</p>"},{"location":"how-to/factor-analysis/alphalens-tearsheet/#_2","title":"\u4e3b\u8981\u53c3\u6578\uff1a","text":"<ul> <li><code>factor_data</code>: (\u5fc5\u8981) \u7d93\u904e <code>get_clean_factor_and_forward_returns()</code> \u8655\u7406\u5f8c\u7684\u56e0\u5b50\u6578\u64da\u3002</li> <li><code>gross_returns</code>: (\u53ef\u9078) \u7b56\u7565\u7684\u6bcf\u65e5\u7e3d\u5831\u916c\u7387 (<code>pd.Series</code>)\u3002\u5982\u679c\u63d0\u4f9b\uff0c\u4e00\u4e9b\u8207\u7b56\u7565\u7e3d\u5831\u916c\u76f8\u95dc\u7684\u5206\u6790\u4e5f\u6703\u88ab\u5305\u542b\u3002</li> </ul> <pre><code>import alphalens.tears as alt\n\n# ... (\u4e0a\u8ff0\u56e0\u5b50\u6578\u64da\u6e96\u5099\u7684\u7a0b\u5f0f\u78bc)\n\nalt.create_full_tear_sheet(factor_data)\n</code></pre> <p>\u57f7\u884c\u5f8c\uff0cAlphalens \u6703\u751f\u6210\u4e00\u7cfb\u5217\u7684\u5716\u8868\u548c\u8868\u683c\uff0c\u6db5\u84cb\u4e86\u56e0\u5b50\u7684\u5404\u500b\u65b9\u9762\uff0c\u5305\u62ec\uff1a *   \u6536\u76ca\u5206\u6790: \u56e0\u5b50\u5206\u4f4d\u6578\u6536\u76ca\u3001\u56e0\u5b50\u8ff4\u6b78\u5206\u6790\u3002 *   \u4fe1\u606f\u4fc2\u6578 (Information Coefficient, IC) \u5206\u6790: \u6bcf\u65e5\u3001\u6708\u5ea6\u3001\u5e74\u5ea6 IC\u3002 *   \u9031\u8f49\u7387 (Turnover) \u5206\u6790: \u56e0\u5b50\u548c\u5206\u4f4d\u6578\u9031\u8f49\u7387\u3002 *   \u6301\u5009\u5206\u6790: \u56e0\u5b50\u66dd\u5149\u5ea6\u7b49\u3002</p>"},{"location":"how-to/factor-analysis/alphalens-tearsheet/#3","title":"3. \u5b8c\u6574\u7bc4\u4f8b","text":"<p>\u4ee5\u4e0b\u5c07\u6f14\u793a\u5982\u4f55\u7d50\u5408 Zipline <code>Pipeline</code> \u8f38\u51fa\u6578\u64da\uff0c\u900f\u904e Alphalens \u751f\u6210\u5b8c\u6574\u7684\u56e0\u5b50\u5206\u6790\u5831\u8868\u3002</p> <p>Tip</p> <p>\u5728\u57f7\u884c\u6b64\u7bc4\u4f8b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u7d93\u4f7f\u7528 <code>zipline ingest -b tquant</code> \u532f\u5165\u4e86\u50f9\u91cf\u8cc7\u6599\uff0c\u4e26\u4e14\u8cc7\u6599\u7bc4\u570d\u6db5\u84cb\u4e86\u56de\u6e2c\u671f\u9593\u3002</p> <pre><code>import pandas as pd\nimport numpy as np\nfrom zipline import run_algorithm\nfrom zipline.api import attach_pipeline, pipeline_output, symbol, set_benchmark\nfrom zipline.pipeline import Pipeline\nfrom zipline.pipeline.factors import SimpleMovingAverage\nfrom zipline.pipeline.data import EquityPricing\nimport alphalens.utils as alu\nimport alphalens.tears as alt\nimport matplotlib.pyplot as plt\n\n# 1. \u5b9a\u7fa9\u4e00\u500b\u7c21\u55ae\u7684 Pipeline \u4f86\u8a08\u7b97\u56e0\u5b50 (\u4f8b\u5982\uff1a\u77ed\u671f\u5747\u7dda\u8207\u9577\u671f\u5747\u7dda\u4e4b\u5dee)\ndef make_simple_pipeline():\n    short_sma = SimpleMovingAverage(inputs=[EquityPricing.close], window_length=10)\n    long_sma = SimpleMovingAverage(inputs=[EquityPricing.close], window_length=30)\n\n    # \u56e0\u5b50\u5b9a\u7fa9\uff1a\u77ed\u671f\u5747\u7dda\u6e1b\u53bb\u9577\u671f\u5747\u7dda\n    my_factor = short_sma - long_sma\n\n    # \u9019\u88e1\u6211\u5011\u9084\u9700\u8981\u50f9\u683c\u6578\u64da\u4f86\u8a08\u7b97\u9060\u671f\u5831\u916c\uff0c\u6240\u4ee5\u4e5f\u4e00\u4f75\u7372\u53d6\n    return Pipeline(columns={\n        'my_factor': my_factor,\n        'close_price': EquityPricing.close.latest\n    })\n\n# 2. Zipline \u56de\u6e2c\u8a2d\u7f6e\ndef initialize(context):\n    context.assets = [symbol('2330'), symbol('2454'), symbol('IR0001')] # \u5305\u542bBenchmark\n    attach_pipeline(make_simple_pipeline(), 'my_pipeline')\n    set_benchmark(symbol('IR0001')) # \u8a2d\u5b9aBenchmark\n\ndef handle_data(context, data):\n    pass # \u9019\u88e1\u53ea\u6536\u96c6\u6578\u64da\uff0c\u4e0d\u57f7\u884c\u4ea4\u6613\n\ndef analyze(context, results):\n    pass # Alphalens \u5c07\u8655\u7406\u5206\u6790\u548c\u8996\u89ba\u5316\n\n# 3. \u57f7\u884c Zipline \u56de\u6e2c\nresults = run_algorithm(\n    start=pd.Timestamp('2020-01-01', tz='UTC'),\n    end=pd.Timestamp('2022-01-01', tz='UTC'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    capital_base=1_000_000,\n    bundle='tquant'\n)\n\n# 4. \u5f9e\u56de\u6e2c\u7d50\u679c\u4e2d\u63d0\u53d6\u56e0\u5b50\u548c\u50f9\u683c\u6578\u64da\n# Pipeline \u7684\u8f38\u51fa\u6703\u5728 results DataFrame \u4e2d\uff0c\u901a\u5e38\u4ee5 MultiIndex \u5f62\u5f0f\u51fa\u73fe\n# \u9019\u88e1\u9700\u8981\u6839\u64da\u5be6\u969b results \u7d50\u69cb\u8abf\u6574\u63d0\u53d6\u65b9\u5f0f\n# \u5047\u8a2d my_factor \u5728 results.xs('my_pipeline', level=1, axis=1)['my_factor']\n# \u5047\u8a2d close_price \u5728 results['close_price']\n# \u6ce8\u610f\uff1a\u9019\u88e1\u9700\u8981\u8655\u7406 results DataFrame \u7684\u5be6\u969b\u7d50\u69cb\u4f86\u7cbe\u78ba\u63d0\u53d6\n# \u56e0\u70ba run_algorithm \u6703\u5c07\u6574\u500b pipeline_output \u653e\u5728 results \u7684 'pipeline_output' \u6b04\u4f4d\u4e0b\n# \u4f8b\u5982\uff1a\nfactor_values = results.xs('my_pipeline', level=1, axis=1)['my_factor'].dropna() # \u63d0\u53d6\u56e0\u5b50\u503c\n# \u9700\u8981\u4e00\u500b\u55ae\u4e00\u7684\u50f9\u683c\u5e8f\u5217 (\u901a\u5e38\u662f close_price)\n# \u7531\u65bc Zipline results \u7684\u7d50\u69cb\u53ef\u80fd\u8f03\u70ba\u8907\u96dc\uff0c\u9019\u88e1\u5047\u8a2d\u4e00\u500b\u7c21\u5316\u7684\u63d0\u53d6\u65b9\u5f0f\n# \u5be6\u969b\u4f7f\u7528\u6642\uff0c\u61c9\u6839\u64da results DataFrame \u7684\u7d50\u69cb\u7cbe\u78ba\u63d0\u53d6\u5404\u8cc7\u7522\u7684\u6536\u76e4\u50f9\nall_prices = results['close_price'] # \u6216\u8005\u5f9e pipeline output \u4e2d\u63d0\u53d6\n# \u78ba\u4fdd factor_values \u548c all_prices \u7684\u7d22\u5f15\u5c0d\u9f4a\n# Alphalens\u8981\u6c42 prices \u7684\u7d22\u5f15\u70ba\u65e5\u671f\uff0ccolumns\u70ba\u8cc7\u7522\npricing_data = all_prices.unstack().reindex(index=factor_values.index.get_level_values('date').unique(),\n                                              columns=factor_values.index.get_level_values('asset').unique())\npricing_data = pricing_data.stack().reindex(factor_values.index).unstack() # \u78ba\u4fdd\u8207factor\u7684\u7d22\u5f15\u5c0d\u9f4a\n\n# 5. \u6e05\u6d17\u56e0\u5b50\u6578\u64da\u4e26\u8a08\u7b97\u9060\u671f\u5831\u916c\nfactor_data = alu.get_clean_factor_and_forward_returns(\n    factor=factor_values,\n    prices=pricing_data,\n    periods=[1, 5, 10] # \u8a08\u7b97 1, 5, 10 \u65e5\u7684\u9060\u671f\u5831\u916c\n)\n\n# 6. \u751f\u6210\u5b8c\u6574\u7684 Alphalens \u7e3e\u6548\u5831\u8868\nalt.create_full_tear_sheet(factor_data)\n\n# \u78ba\u4fdd\u7e6a\u5716\u74b0\u5883\u986f\u793a\nplt.show()\n</code></pre>"},{"location":"how-to/visualization/pyfolio-tearsheet/","title":"\u5982\u4f55\u7522\u751f Pyfolio \u7e3e\u6548\u5831\u8868","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b\u5982\u4f55\u5f9e Zipline \u56de\u6e2c\u7d50\u679c\u751f\u6210 Pyfolio \u7e3e\u6548\u5831\u8868\u7684\u8a73\u7d30\u6307\u5357\uff0c\u5305\u62ec\u6578\u64da\u6e96\u5099\u3001\u6642\u5340\u6a19\u6e96\u5316\u548c <code>create_full_tear_sheet()</code> \u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p> <p>Pyfolio \u662f\u4e00\u500b\u5f37\u5927\u7684 Python \u5eab\uff0c\u5c08\u70ba\u91cf\u5316\u6295\u8cc7\u7b56\u7565\u7684\u7e3e\u6548\u8207\u98a8\u96aa\u5206\u6790\u800c\u8a2d\u8a08\u3002\u5b83\u8207 Zipline \u56de\u6e2c\u5eab\u5b8c\u7f8e\u517c\u5bb9\uff0c\u80fd\u5920\u5c07 Zipline <code>run_algorithm()</code> \u7522\u751f\u7684\u8907\u96dc\u56de\u6e2c\u7d50\u679c\uff0c\u8f49\u63db\u70ba\u4e00\u5957\u6a19\u6e96\u5316\u4e14\u8996\u89ba\u5316\u7684\u7e3e\u6548\u5831\u544a (\u7a31\u70ba \"tearsheet\")\uff0c\u8b93\u60a8\u53ef\u4ee5\u5168\u9762\u8a55\u4f30\u7b56\u7565\u7684\u512a\u52a3\u3002</p> <p>\u672c\u6307\u5357\u5c07\u8aaa\u660e\u5982\u4f55\u5c07 Zipline \u7684\u56de\u6e2c\u7d50\u679c\u5c0e\u5165 Pyfolio \u4e26\u751f\u6210\u5b8c\u6574\u7684\u7e3e\u6548\u5831\u8868\u3002</p>"},{"location":"how-to/visualization/pyfolio-tearsheet/#1","title":"1. \u6e96\u5099\u56de\u6e2c\u6578\u64da","text":"<p>\u9996\u5148\uff0c\u60a8\u9700\u8981\u5f9e Zipline <code>run_algorithm()</code> \u51fd\u6578\u8fd4\u56de\u7684 <code>results</code> DataFrame \u4e2d\uff0c\u63d0\u53d6 Pyfolio \u6240\u9700\u7684\u6838\u5fc3\u6578\u64da\u683c\u5f0f\u3002<code>pyfolio.utils.extract_rets_pos_txn_from_zipline()</code> \u51fd\u6578\u80fd\u6709\u6548\u5730\u5b8c\u6210\u9019\u9805\u4efb\u52d9\u3002</p>"},{"location":"how-to/visualization/pyfolio-tearsheet/#_1","title":"\u6838\u5fc3\u6578\u64da\u985e\u578b\uff1a","text":"<ul> <li><code>returns</code> (\u7b56\u7565\u5831\u916c\u7387): <code>pd.Series</code>\uff0c\u5305\u542b\u6bcf\u500b\u4ea4\u6613\u65e5\u7684\u7b56\u7565\u5831\u916c\u7387\u3002</li> <li><code>positions</code> (\u6301\u6709\u90e8\u4f4d): <code>pd.DataFrame</code>\uff0c\u5305\u542b\u6bcf\u500b\u4ea4\u6613\u65e5\u5404\u8b49\u5238\u8207\u73fe\u91d1\u7684\u6301\u6709\u90e8\u4f4d\u3002</li> <li><code>transactions</code> (\u4ea4\u6613\u7d00\u9304): <code>pd.DataFrame</code>\uff0c\u5305\u542b\u6240\u6709\u4ea4\u6613\u7684\u8a73\u7d30\u8cc7\u8a0a\u3002</li> <li><code>benchmark_rets</code> (\u57fa\u6e96\u5831\u916c\u7387): <code>pd.Series</code>\uff0c\u5305\u542b\u6bcf\u500b\u4ea4\u6613\u65e5\u7684 Benchmark \u5831\u916c\u7387\u3002\u9019\u53ef\u4ee5\u5f9e <code>results.benchmark_return</code> \u76f4\u63a5\u53d6\u5f97\u3002</li> </ul>"},{"location":"how-to/visualization/pyfolio-tearsheet/#_2","title":"\u6578\u64da\u63d0\u53d6\u8207\u6642\u5340\u6a19\u6e96\u5316","text":"<p>Pyfolio \u8981\u6c42\u8f38\u5165\u7684\u6578\u64da\u7d22\u5f15\u5fc5\u9808\u662f UTC \u6642\u5340\u3002\u56e0\u6b64\uff0c\u5728\u63d0\u53d6\u6578\u64da\u5f8c\uff0c\u901a\u5e38\u9700\u8981\u9032\u884c\u6642\u5340\u6a19\u6e96\u5316\u3002</p> <pre><code>import pandas as pd\nimport pyfolio\nfrom pyfolio.utils import extract_rets_pos_txn_from_zipline\n\n# \u5047\u8a2d results \u662f zipline.run_algorithm() \u57f7\u884c\u5f8c\u7684\u7d50\u679c DataFrame\n# results = run_algorithm(...)\n\n# \u63d0\u53d6\u7b56\u7565\u6578\u64da\nreturns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\n\n# \u63d0\u53d6 Benchmark \u5831\u916c\u7387\nbenchmark_rets = results.benchmark_return\n\n# \u6642\u5340\u6a19\u6e96\u5316 (\u78ba\u4fdd Pyfolio \u517c\u5bb9\u6027)\nreturns.index = returns.index.tz_localize(None).tz_localize('UTC')\npositions.index = positions.index.tz_localize(None).tz_localize('UTC')\ntransactions.index = transactions.index.tz_localize(None).tz_localize('UTC')\nbenchmark_rets.index = benchmark_rets.index.tz_localize(None).tz_localize('UTC')\n</code></pre>"},{"location":"how-to/visualization/pyfolio-tearsheet/#2-create_full_tear_sheet","title":"2. \u751f\u6210\u5b8c\u6574\u7e3e\u6548\u5831\u8868 (create_full_tear_sheet())","text":"<p>\u7576\u60a8\u6e96\u5099\u597d\u4e0a\u8ff0\u6578\u64da\u5f8c\uff0c\u5c31\u53ef\u4ee5\u547c\u53eb <code>pyfolio.tears.create_full_tear_sheet()</code> \u51fd\u6578\u4f86\u751f\u6210\u5305\u542b\u5404\u9805\u5716\u8868\u548c\u7d71\u8a08\u6578\u64da\u7684\u5b8c\u6574\u7e3e\u6548\u5831\u8868\u3002</p>"},{"location":"how-to/visualization/pyfolio-tearsheet/#_3","title":"\u4e3b\u8981\u53c3\u6578\uff1a","text":"<ul> <li><code>returns</code>: (\u5fc5\u8981) \u7b56\u7565\u7684\u6bcf\u65e5\u5831\u916c\u7387 (<code>pd.Series</code>)\u3002</li> <li><code>positions</code>: (\u53ef\u9078) \u7b56\u7565\u7684\u6bcf\u65e5\u6301\u6709\u90e8\u4f4d (<code>pd.DataFrame</code>)\u3002</li> <li><code>transactions</code>: (\u53ef\u9078) \u7b56\u7565\u7684\u4ea4\u6613\u7d00\u9304 (<code>pd.DataFrame</code>)\u3002</li> <li><code>benchmark_rets</code>: (\u53ef\u9078) Benchmark \u7684\u6bcf\u65e5\u5831\u916c\u7387 (<code>pd.Series</code>)\u3002\u82e5\u4e0d\u50b3\u5165\uff0c\u5247\u67d0\u4e9b\u8207 Benchmark \u6bd4\u8f03\u7684\u5716\u8868\u5c07\u4e0d\u6703\u751f\u6210\u3002</li> </ul> <pre><code>import pyfolio\n\n# ... (\u4e0a\u8ff0\u6578\u64da\u63d0\u53d6\u8207\u6642\u5340\u6a19\u6e96\u5316\u7684\u7a0b\u5f0f\u78bc)\n\npyfolio.tears.create_full_tear_sheet(\n    returns=returns,\n    positions=positions,\n    transactions=transactions,\n    benchmark_rets=benchmark_rets # \u50b3\u5165 Benchmark \u5831\u916c\u7387\u4ee5\u4f9b\u6bd4\u8f03\n)\n</code></pre> <p>\u57f7\u884c\u5f8c\uff0c\u60a8\u6703\u770b\u5230\u4e00\u7cfb\u5217\u7684\u7e3e\u6548\u5716\u8868\u548c\u7d71\u8a08\u6578\u64da\uff0c\u5305\u62ec\u5831\u916c\u66f2\u7dda\u3001\u56de\u64a4\u3001\u98a8\u96aa\u6307\u6a19\u3001\u5404\u8cc7\u7522\u7684\u6301\u6709\u6bd4\u91cd\u5206\u6790\u3001\u4ea4\u6613\u5206\u6790\u7b49\u3002</p>"},{"location":"how-to/visualization/pyfolio-tearsheet/#3","title":"3. \u5b8c\u6574\u7bc4\u4f8b","text":"<p>\u4ee5\u4e0b\u5c07\u7d50\u5408\u4e00\u500b\u7c21\u55ae\u7684\u300c\u8cb7\u5165\u4e26\u6301\u6709\u53f0\u7a4d\u96fb\u300d\u7b56\u7565\u7684\u56de\u6e2c\u7d50\u679c\uff0c\u6f14\u793a\u5982\u4f55\u751f\u6210 Pyfolio \u7e3e\u6548\u5831\u8868\u3002</p> <p>Tip</p> <p>\u5728\u57f7\u884c\u6b64\u7bc4\u4f8b\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u7d93\u4f7f\u7528 <code>zipline ingest -b tquant</code> \u532f\u5165\u4e86\u50f9\u91cf\u8cc7\u6599\uff0c\u4e26\u4e14\u8cc7\u6599\u7bc4\u570d\u6db5\u84cb\u4e86\u56de\u6e2c\u671f\u9593\u3002\u8a73\u898b\uff1a\u532f\u5165\u50f9\u91cf\u8cc7\u6599\u6307\u5357</p> <pre><code>import pandas as pd\nfrom zipline import run_algorithm\nfrom zipline.api import (\n    set_benchmark,\n    symbol,\n    order_target_percent,\n    record\n)\nimport pyfolio\nfrom pyfolio.utils import extract_rets_pos_txn_from_zipline\nimport matplotlib.pyplot as plt\n\n\n# --- Zipline \u56de\u6e2c\u90e8\u5206 ---\ndef initialize(context):\n    context.asset = symbol('2330')\n    set_benchmark(symbol('IR0001'))\n    context.has_ordered = False\n\ndef handle_data(context, data):\n    if not context.has_ordered:\n        order_target_percent(context.asset, 1.0)\n        context.has_ordered = True\n    record(price=data.current(context.asset, 'price'))\n\ndef analyze(context, results):\n    pass # Pyfolio \u5c07\u6703\u8655\u7406\u5206\u6790\u548c\u8996\u89ba\u5316\n\nresults = run_algorithm(\n    start=pd.Timestamp('2022-01-01', tz='UTC'),\n    end=pd.Timestamp('2023-01-01', tz='UTC'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    capital_base=1_000_000,\n    bundle='tquant'\n)\n\n# --- Pyfolio \u5206\u6790\u90e8\u5206 ---\n# 1. \u63d0\u53d6 Zipline \u56de\u6e2c\u7d50\u679c\nreturns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\nbenchmark_rets = results.benchmark_return\n\n# 2. \u6642\u5340\u6a19\u6e96\u5316\nreturns.index = returns.index.tz_localize(None).tz_localize('UTC')\npositions.index = positions.index.tz_localize(None).tz_localize('UTC')\ntransactions.index = transactions.index.tz_localize(None).tz_localize('UTC')\nbenchmark_rets.index = benchmark_rets.index.tz_localize(None).tz_localize('UTC')\n\n# 3. \u751f\u6210\u5b8c\u6574\u7684 Pyfolio \u7e3e\u6548\u5831\u8868\npyfolio.tears.create_full_tear_sheet(\n    returns=returns,\n    positions=positions,\n    transactions=transactions,\n    benchmark_rets=benchmark_rets\n)\n\n# \u7531\u65bc create_full_tear_sheet \u5167\u90e8\u6703\u8abf\u7528 plt.show()\uff0c\n# \u5982\u679c\u5728\u975e\u4e92\u52d5\u74b0\u5883\u904b\u884c\uff0c\u53ef\u80fd\u9700\u8981\u624b\u52d5\u5132\u5b58\u5716\u8868\u6216\u78ba\u4fdd\u7e6a\u5716\u74b0\u5883\u662f\u4e92\u52d5\u7684\u3002\n# plt.show() # \u5982\u679c tearsheet \u6c92\u6709\u81ea\u52d5\u986f\u793a\uff0c\u53ef\u4ee5\u5617\u8a66\u624b\u52d5\u547c\u53eb\n</code></pre>"},{"location":"reference/alphalens/api/","title":"Alphalens API \u7e3d\u89bd","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b Alphalens \u76f8\u95dc API \u7684\u8a73\u7d30\u8aaa\u660e\uff0c\u5305\u62ec\u56e0\u5b50\u5206\u6790\u3001\u8cc7\u8a0a\u4fc2\u6578 (IC) \u5206\u6790\u3001\u5468\u8f49\u7387\u5206\u6790\u53ca\u76f8\u95dc\u7e6a\u5716\u51fd\u6578\u7684\u7528\u9014\u548c\u8a08\u7b97\u65b9\u5f0f\u3002</p> <p>Alphalens \u662f\u4e00\u500b\u7528\u65bc\u56e0\u5b50\u7814\u7a76\u8207\u8a55\u4f30\u7684 Python \u5eab\uff0c\u63d0\u4f9b\u56e0\u5b50\u5206\u6790\u3001\u7e3e\u6548\u8a55\u4f30\u548c\u5468\u8f49\u7387\u5206\u6790\u7b49\u5de5\u5177\u3002</p>"},{"location":"reference/alphalens/api/#1","title":"1. \u6838\u5fc3\u6982\u5ff5","text":""},{"location":"reference/alphalens/api/#11-information-coefficient-ic","title":"1.1 \u8cc7\u8a0a\u4fc2\u6578\u5206\u6790 (Information Coefficient, IC)","text":"<p>\u8cc7\u8a0a\u4fc2\u6578\u662f\u4e00\u7a2e\u91cf\u5316\u56e0\u5b50\u9810\u6e2c\u6027\u7684\u65b9\u6cd5\uff0c\u900f\u904e\u8a08\u7b97 \u56e0\u5b50\u503c \u8207 \u6301\u6709\u671f\u5831\u916c \u7684 \u65af\u76ae\u723e\u66fc\u7b49\u7d1a\u76f8\u95dc\u4fc2\u6578 \uff08Spearman rank correlation coefficient\uff09\u800c\u5f97\u3002</p> <p>\u7c21\u800c\u8a00\u4e4b\uff0cIC \u63d0\u4f9b\u4e86\u4e00\u7a2e\u8a55\u4f30\u65b9\u5f0f\uff0c\u4f86\u78ba\u5b9a\u8f03\u9ad8\u7684\u56e0\u5b50\u503c\u662f\u5426\u610f\u5473\u8457\u66f4\u9ad8\u7684\u5831\u916c\u7387\uff0c\u5373\u662f\u5426\u5b58\u5728\u55ae\u8abf\u905e\u589e\u7684\u95dc\u4fc2\u3002\u7406\u60f3\u60c5\u6cc1\u4e0b\uff0c\u6211\u5011\u5e0c\u671b IC \u503c\u8d8a\u9ad8\u8d8a\u597d\u3002\u5728\u4e3b\u52d5\u6295\u8cc7\u7b56\u7565\u4e2d\uff0cIC \u4e5f\u5e38\u88ab\u7528\u4f86\u8a55\u4f30\u57fa\u91d1\u7d93\u7406\u4eba\u7684\u9810\u6e2c\u80fd\u529b\u3002</p> <p>\u7531\u65bc IC \u662f\u7b49\u7d1a\u76f8\u95dc\u4fc2\u6578\uff0c\u5176\u503c\u7684\u7bc4\u570d\u662f\u4ecb\u65bc +1 \u5230 -1 \u4e4b\u9593\uff1a</p> <ul> <li>IC = 1\uff1a\u8a72\u56e0\u5b50\u5b8c\u5168\u6c92\u6709\u96dc\u8a0a\uff0c\u4e26\u53ef\u4ee5\u505a\u51fa\u5b8c\u7f8e\u7684\u9810\u6e2c</li> <li>IC = 0\uff1a\u8a72\u56e0\u5b50\u7121\u9810\u6e2c\u80fd\u529b\uff0c\u5168\u70ba\u96dc\u8a0a</li> <li>IC &lt; 0\uff1a\u9810\u6e2c\u65b9\u5411\u8207\u771f\u5be6\u65b9\u5411\u5b8c\u5168\u76f8\u53cd</li> </ul> <p>\u6839\u64da Grinold and Kahn\uff082000\uff09\u7684\u7814\u7a76\uff1a</p> <ul> <li>\u826f\u597d\u7684\u56e0\u5b50\uff1aIC \u2265 0.05</li> <li>\u51fa\u8272\u7684\u56e0\u5b50\uff1aIC \u2265 0.10</li> <li>\u9802\u5c16\u7684\u56e0\u5b50\uff1aIC \u2265 0.15</li> <li>IC \u2265 0.20\uff1a\u53ef\u80fd\u4ee3\u8868\u5b58\u5728\u56de\u6e2c\u504f\u5dee\u6216\u5167\u7dda\u4ea4\u6613</li> </ul>"},{"location":"reference/alphalens/api/#12-vs","title":"1.2 \u8cc7\u8a0a\u5206\u6790 vs. \u6536\u76ca\u5206\u6790","text":"<p>\u8cc7\u8a0a\u5206\u6790 \u900f\u904e\u8a08\u7b97\u56e0\u5b50\u503c\u8207\u6301\u6709\u671f\u5831\u916c\u7387\u7684\u76f8\u95dc\u4fc2\u6578\u4f86\u8a55\u4f30\u56e0\u5b50\u7684\u6574\u9ad4\u9810\u6e2c\u80fd\u529b\u3002\u9019\u662f\u4e00\u500b\u55ae\u4e00\u7684\u5168\u5c40\u6307\u6a19\uff0c\u53cd\u6620\u56e0\u5b50\u5728\u6574\u500b\u80a1\u7968\u6c60\u4e2d\u7684\u5e73\u5747\u9810\u6e2c\u529b\u3002</p> <p>\u6536\u76ca\u5206\u6790 \u5247\u5c07\u80a1\u7968\u6309\u56e0\u5b50\u503c\u5927\u5c0f\u5206\u6210\u4e0d\u540c\u5206\u7d44\uff08\u901a\u5e38 5 \u5206\u7d44\uff09\uff0c\u7136\u5f8c\u8a08\u7b97\u6bcf\u500b\u5206\u7d44\u7684\u5e73\u5747\u5831\u916c\u7387\u3002\u9019\u7a2e\u65b9\u6cd5\u80fd\u5920\u6e05\u695a\u5c55\u793a\u56e0\u5b50\u5728\u4e0d\u540c\u80a1\u7968\u5b50\u96c6\u4e2d\u7684\u9810\u6e2c\u529b\u5206\u4f48\u3002</p> <p>\u6700\u4f73\u5be6\u8e10 \uff1a\u7d50\u5408\u4f7f\u7528\u5169\u7a2e\u5206\u6790\u5de5\u5177\u3002\u8cc7\u8a0a\u4fc2\u6578\u63d0\u4f9b\u4e86\u8f03\u70ba\u4e00\u822c\u5316\u7684\u8996\u89d2\uff0c\u800c\u5206\u7d44\u6536\u76ca\u5206\u6790\u5247\u63d0\u4f9b\u4e86\u66f4\u6df1\u5165\u7684\u89c0\u9ede\uff0c\u80fd\u5920\u660e\u78ba\u986f\u793a\u56e0\u5b50\u5728\u54ea\u4e9b\u5206\u7d44\u4e2d\u7684\u9810\u6e2c\u80fd\u529b\u6700\u5f37\u3002</p>"},{"location":"reference/alphalens/api/#2-ic","title":"2. \u8cc7\u8a0a\u4fc2\u6578 (IC) \u5206\u6790\u51fd\u6578","text":""},{"location":"reference/alphalens/api/#21-factor_information_coefficient","title":"2.1 factor_information_coefficient","text":"<p>\u5229\u7528 <code>factor_information_coefficient</code> \u51fd\u6578\u8a08\u7b97\u5404\u6301\u6709\u671f\u4e0b\u6bcf\u4e00\u65e5\u7684 IC \u503c\uff0c\u89c0\u5bdf\u56e0\u5b50\u9810\u6e2c\u529b\u96a8\u6642\u9593\u8b8a\u52d5\u7684\u60c5\u6cc1\u3002</p>"},{"location":"reference/alphalens/api/#_1","title":"\u8a08\u7b97\u65b9\u5f0f","text":"\\[IC_{t,n} = Corr(\\text{\u56e0\u5b50\u503c}_{i,t}, \\text{\u6301\u6709\u671f\u5831\u916c\u7387}_{i,t,n})\\] <p>\u5176\u4e2d\uff0c\\(i\\) \u70ba\u80a1\u7968\u4ee3\u865f\u3001\\(n\\) \u70ba\u6301\u6709\u671f\u5929\u6578\u3001\\(Corr\\) \u70ba\u65af\u76ae\u723e\u66fc\u79e9\u76f8\u95dc\u4fc2\u6578\u3002</p>"},{"location":"reference/alphalens/api/#_2","title":"\u7bc4\u4f8b","text":"<pre><code>ic = alphalens.performance.factor_information_coefficient(factor_data)\nic.head()\n</code></pre>"},{"location":"reference/alphalens/api/#22-plot_ic_ts","title":"2.2 plot_ic_ts","text":"<p>\u5229\u7528 <code>plot_ic_ts</code> \u51fd\u6578\u628a\u4e0d\u540c\u6642\u9ede\u7684 IC \u503c\u7e6a\u88fd\u6210\u6298\u7dda\u5716\uff0c\u53ef\u4ee5\u4e86\u89e3\u56e0\u5b50\u9810\u6e2c\u80fd\u529b\u96a8\u8457\u6642\u9593\u7684\u8b8a\u5316\u60c5\u6cc1\u3002</p> <p>\u901a\u5e38\u6703\u5e0c\u671b\u770b\u5230 IC \u5728\u6642\u9593\u5e8f\u5217\u4e0a\u5927\u90e8\u5206\u7684\u6642\u9593\u9ede\u7686 \u7a69\u5b9a\u70ba\u6b63 \uff08\u7406\u60f3\u60c5\u6cc1\u4e0b &gt; 0.05\uff09\uff0c\u4e14 \u64c1\u6709\u8f03\u5927\u7684 IC \u5747\u503c \u4ee5\u53ca \u8f03\u5c0f\u7684 IC \u6a19\u6e96\u5dee \u3002</p> <p>\u5716\u8868\u8aaa\u660e\uff1a</p> <ul> <li>\u85cd\u8272\u7dda\uff1a\u6bcf\u65e5\u7684 IC \u503c</li> <li>\u7da0\u8272\u7dda\uff1a\u8fd1\u4e00\u500b\u6708\uff08\u904e\u53bb 22 \u5929\uff09\u7684 IC \u5747\u503c\uff08\u6efe\u52d5\u5e73\u5747\uff09</li> <li>\u5de6\u4e0a\u89d2\u8cc7\u8a0a\uff1a\u6574\u671f\u9593\u7684 IC \u5747\u503c\u53ca IC \u6a19\u6e96\u5dee</li> </ul>"},{"location":"reference/alphalens/api/#_3","title":"\u7bc4\u4f8b","text":"<pre><code>alphalens.plotting.plot_ic_ts(ic)\n</code></pre>"},{"location":"reference/alphalens/api/#23-plot_ic_hist","title":"2.3 plot_ic_hist","text":"<p>\u5229\u7528 <code>plot_ic_hist</code> \u51fd\u6578\u5c07\u4e0d\u540c\u6301\u6709\u671f\u7684 IC \u5e8f\u5217\u8cc7\u6599\u7e6a\u88fd\u6210\u76f4\u65b9\u5716\uff0c\u89c0\u5bdf IC \u503c\u7684\u5206\u4f48\u60c5\u6cc1\u3002</p> <p>\u901a\u5e38\u6703\u5e0c\u671b\u6709 \u8f03\u9ad8\u7684 IC \u5747\u503c \u4ee5\u53ca \u8f03\u70ba\u96c6\u4e2d\u7684\u5206\u4f48 \uff08\u6a19\u6e96\u5dee\u4f4e\u3001\u5cf0\u5ea6\u9ad8\uff09\uff0c\u8868\u793a\u56e0\u5b50\u9810\u6e2c\u529b\u7a69\u5b9a\u4e00\u81f4\u3002</p>"},{"location":"reference/alphalens/api/#_4","title":"\u7bc4\u4f8b","text":"<pre><code>alphalens.plotting.plot_ic_hist(ic)\n</code></pre>"},{"location":"reference/alphalens/api/#24-plot_ic_qq","title":"2.4 plot_ic_qq","text":"<p>QQ \u5716\uff08\u4f7f\u7528 <code>plot_ic_qq</code> \u51fd\u6578\uff09\u53ef\u4ee5\u89c0\u5bdf IC \u503c\u7684\u6a5f\u7387\u5206\u914d\u662f\u5426\u8fd1\u4f3c\u65bc\u5e38\u614b\u5206\u914d\u3002\u82e5\u85cd\u8272\u9ede\u7684\u5206\u4f48\u5927\u81f4\u8cbc\u5408\u7d05\u8272\u7dda\uff08y=x\uff09\uff0c\u4ee3\u8868 IC \u7684\u5206\u4f48\u63a5\u8fd1\u5e38\u614b\u5206\u914d\u3002</p> <p>\u82e5 IC \u5206\u5e03\u504f\u96e2\u5e38\u614b\uff0c\u53ef\u80fd\u4ee3\u8868\u56e0\u5b50\u5b58\u5728\u6975\u7aef\u4e8b\u4ef6\u6216\u5176\u4ed6\u975e\u7dda\u6027\u7279\u5fb5\u3002</p>"},{"location":"reference/alphalens/api/#_5","title":"\u7bc4\u4f8b","text":"<pre><code>alphalens.plotting.plot_ic_qq(ic)\n</code></pre>"},{"location":"reference/alphalens/api/#25-plot_monthly_ic_heatmap","title":"2.5 plot_monthly_ic_heatmap","text":"<p>\u5c07 IC \u503c\u6309\u6708\u4efd\u53d6\u5e73\u5747\uff0c\u4e26\u5229\u7528\u71b1\u5340\u5716\u89c0\u5bdf\u56e0\u5b50\u662f\u5426\u5b58\u5728\u6708\u4efd\u6548\u61c9\uff08\u5373\u9810\u6e2c\u529b\u5728\u67d0\u4e9b\u6708\u4efd\u7279\u5225\u5f37\u6216\u7279\u5225\u5f31\uff09\u3002</p>"},{"location":"reference/alphalens/api/#_6","title":"\u7bc4\u4f8b","text":"<pre><code>mean_monthly_ic = alphalens.performance.mean_information_coefficient(\n    factor_data, \n    by_time='M'\n)\nalphalens.plotting.plot_monthly_ic_heatmap(mean_monthly_ic)\n</code></pre>"},{"location":"reference/alphalens/api/#26-plot_information_table","title":"2.6 plot_information_table","text":"<p>\u986f\u793a IC \u76f8\u95dc\u7684\u7d71\u8a08\u6307\u6a19\u8868\uff0c\u5305\u62ec\u4ee5\u4e0b\u5404\u9805\uff1a</p> <ul> <li>IC Mean\uff08IC \u5747\u503c\uff09\uff1a\u5404\u6301\u6709\u671f\u4e0b\u7684 IC \u503c\u53d6\u5e73\u5747</li> <li>IC Std.Div\uff08IC \u6a19\u6e96\u5dee\uff09\uff1aIC \u503c\u7684\u6a23\u672c\u6a19\u6e96\u5dee</li> <li>Risk-Adjusted IC\uff1aIC Mean / IC Std.Div\uff0c\u517c\u9867\u56e0\u5b50\u9078\u80a1\u80fd\u529b\u8207\u7a69\u5b9a\u6027</li> <li>IC Skew\uff1aIC \u503c\u7684\u504f\u614b\u4fc2\u6578\uff08\u8861\u91cf\u5206\u5e03\u7684\u975e\u5c0d\u7a31\u6027\uff09</li> <li>IC Kurtosis\uff1aIC \u503c\u7684\u5cf0\u614b\u4fc2\u6578\uff08\u8861\u91cf\u5206\u5e03\u7684\u539a\u5c3e\u7a0b\u5ea6\uff09</li> <li>t-stat(IC) &amp; p-value(IC)\uff1aT \u6aa2\u5b9a\u7d71\u8a08\u91cf\u53ca p \u503c\uff0c\u7528\u65bc\u6aa2\u9a57 IC \u662f\u5426\u986f\u8457\u7570\u65bc 0</li> </ul>"},{"location":"reference/alphalens/api/#_7","title":"\u7bc4\u4f8b","text":"<pre><code>alphalens.plotting.plot_information_table(ic)\n</code></pre>"},{"location":"reference/alphalens/api/#27-create_information_tear_sheet","title":"2.7 create_information_tear_sheet","text":"<p>\u751f\u6210\u5305\u542b\u6240\u6709 IC \u5206\u6790\u5716\u8868\u7684\u5b8c\u6574\u5831\u544a\u3002\u6b64\u51fd\u6578\u6703\u81ea\u52d5\u751f\u6210\u6642\u9593\u5e8f\u5217\u5716\u3001\u76f4\u65b9\u5716\u3001QQ \u5716\u3001\u6708\u5ea6\u71b1\u529b\u5716\u53ca\u7d71\u8a08\u8868\uff0c\u63d0\u4f9b\u56e0\u5b50\u9810\u6e2c\u529b\u7684\u5168\u9762\u8a55\u4f30\u3002</p>"},{"location":"reference/alphalens/api/#_8","title":"\u7bc4\u4f8b","text":"<pre><code>alphalens.tears.create_information_tear_sheet(factor_data)\n</code></pre>"},{"location":"reference/alphalens/api/#3","title":"3. \u5468\u8f49\u7387\u5206\u6790","text":""},{"location":"reference/alphalens/api/#31","title":"3.1 \u5468\u8f49\u7387\u6982\u5ff5","text":"<p>\u56e0\u5b50\u5468\u8f49\u7387\u9593\u63a5\u8861\u91cf \u56e0\u5b50\u7684\u7a69\u5b9a\u6027 \u53ca \u6f5b\u5728\u7684\u4ea4\u6613\u6210\u672c \u3002\u5468\u8f49\u7387\u4f4e\u7684\u56e0\u5b50\u80fd\u4f7f\u6295\u8cc7\u7d44\u5408\u7121\u9700\u983b\u7e41\u8abf\u6574\u6301\u80a1\uff0c\u4e5f\u9593\u63a5\u4ee3\u8868\u56e0\u5b50\u6709\u66f4\u597d\u7684\u6301\u7e8c\u6027\u4e14\u4eab\u6709\u8f03\u4f4e\u7684\u4ea4\u6613\u6210\u672c\u3002</p> <p>Carhart\uff081997\uff09\u548c Champagne, Karoui and Patel\uff082018\uff09\u90fd\u767c\u73fe\uff0c\u5468\u8f49\u7387\u8d8a\u9ad8\u7684\u5171\u540c\u57fa\u91d1\u7e3e\u6548\u5c31\u8d8a\u5dee\u3002</p> <p>\u5468\u8f49\u7387\u4e5f\u6703\u96a8 \u56e0\u5b50\u7684\u8cc7\u8a0a\u6642\u57df \u4e0d\u540c\u800c\u6709\u6240\u5dee\u7570\uff1a</p> <ul> <li>\u77ed\u8cc7\u8a0a\u6642\u57df \uff08\u5982\u77ed\u671f\u53cd\u8f49\u56e0\u5b50\uff09\uff1a\u8a0a\u865f\u8fc5\u901f\u6d88\u5931\uff0c\u5c0e\u81f4\u8f03\u9ad8\u5468\u8f49\u7387</li> <li>\u9577\u8cc7\u8a0a\u6642\u57df \uff08\u5982\u57fa\u672c\u9762\u56e0\u5b50\uff09\uff1a\u8a0a\u865f\u8870\u6e1b\u901f\u5ea6\u8f03\u6162\uff0c\u5468\u8f49\u7387\u76f8\u5c0d\u8f03\u4f4e</li> </ul>"},{"location":"reference/alphalens/api/#32-quantile_turnover","title":"3.2 quantile_turnover","text":"<p>\u7b2c N \u5206\u7d44\uff08quantile\uff09\u5728\u6642\u9ede t \u7684\u5468\u8f49\u7387\u5b9a\u7fa9\u70ba\uff1a</p> \\[\\text{\u5468\u8f49\u7387}_{N,t} = \\frac{\\text{\u672c\u671f\u5728\u7b2c N \u7d44\u4f46\u524d P \u671f\u4e0d\u5728\u6b64\u7d44\u7684\u80a1\u7968\u6578}}{\\text{\u672c\u671f\u5728\u7b2c N \u7d44\u7684\u80a1\u7968\u7e3d\u6578}}\\] <p>\u6b64\u6307\u6a19\u8861\u91cf\u56e0\u5b50\u6392\u5e8f\u8b8a\u5316\u7684\u5e45\u5ea6\uff0c\u503c\u8d8a\u9ad8\u8868\u793a\u56e0\u5b50\u6392\u5e8f\u8b8a\u5316\u8d8a\u5927\uff0c\u4ea4\u6613\u6210\u672c\u53ef\u80fd\u8d8a\u9ad8\u3002</p>"},{"location":"reference/alphalens/api/#_9","title":"\u7bc4\u4f8b","text":"<pre><code>quantile_turnover = {}\nfor holding_period in (1, 5, 10):\n    quantile_turnover[holding_period] = pd.concat([\n        alphalens.performance.quantile_turnover(\n            factor_data['factor_quantile'],\n            quantile=q,\n            period=holding_period\n        ) \n        for q in factor_data.factor_quantile.sort_values().unique().tolist()\n    ], axis=1)\n</code></pre>"},{"location":"reference/alphalens/api/#33-plot_top_bottom_quantile_turnover","title":"3.3 plot_top_bottom_quantile_turnover","text":"<p>\u7e6a\u88fd top quantile\uff08\u6700\u9ad8\u5206\u7d44\uff09\u8207 bottom quantile\uff08\u6700\u4f4e\u5206\u7d44\uff09\u7684\u5468\u8f49\u7387\u6298\u7dda\u5716\u3002\u9019\u5169\u500b\u5206\u7d44\u5728\u56e0\u5b50\u6295\u8cc7\u4e2d\u5c24\u70ba\u91cd\u8981\uff0c\u56e0\u70ba\u591a\u56e0\u5b50\u7b56\u7565\u901a\u5e38\u6703\u505a\u591a top quantile \u4e26\u540c\u6642\u653e\u7a7a bottom quantile \u4f86\u5efa\u69cb\u591a\u7a7a\u5c0d\u6c96\u6295\u7d44\u3002</p>"},{"location":"reference/alphalens/api/#_10","title":"\u7bc4\u4f8b","text":"<pre><code>for holding_period in (1, 5, 10):\n    alphalens.plotting.plot_top_bottom_quantile_turnover(\n        quantile_turnover[holding_period],\n        period=holding_period\n    )\n</code></pre>"},{"location":"reference/alphalens/api/#34-factor_rank_autocorrelation","title":"3.4 factor_rank_autocorrelation","text":"<p>\u56e0\u5b50\u79e9\u81ea\u76f8\u95dc\u4fc2\u6578\u8861\u91cf \u7576\u671f\u56e0\u5b50\u503c\u6392\u5e8f \u8207 \u524d\u4e00\u671f\u56e0\u5b50\u503c\u6392\u5e8f \u7684\u76f8\u95dc\u7a0b\u5ea6\u3002</p> \\[\\text{\u81ea\u76f8\u95dc\u4fc2\u6578}_t = Corr(\\text{\u56e0\u5b50\u503c\u79e9}_{i,t}, \\text{\u56e0\u5b50\u503c\u79e9}_{i,t-p})\\] <p>\u5468\u8f49\u7387\u8207\u81ea\u76f8\u95dc\u4fc2\u6578\u5448\u73fe\u8ca0\u76f8\u95dc \u3002\u56e0\u6b64\uff0c\u56e0\u5b50\u79e9\u81ea\u76f8\u95dc\u4fc2\u6578\u63d0\u4f9b\u4e86\u53e6\u4e00\u7a2e\u8861\u91cf\u56e0\u5b50\u5468\u8f49\u7387\uff08\u5373\u7a69\u5b9a\u6027\uff09\u7684\u65b9\u5f0f\u3002\u81ea\u76f8\u95dc\u4fc2\u6578\u9ad8\u5247\u4ee3\u8868\u56e0\u5b50\u5728\u4e0d\u540c\u6642\u671f\u4e4b\u9593\u5b58\u5728\u8f03\u5927\u7684\u76f8\u95dc\u6027\u548c\u7a69\u5b9a\u6027\uff0c\u540c\u6642\u610f\u5473\u8457\u5468\u8f49\u7387\u8f03\u4f4e\u3002</p>"},{"location":"reference/alphalens/api/#_11","title":"\u7bc4\u4f8b","text":"<pre><code>factor_rank_autocorr = pd.DataFrame()\nfor holding_period in (1, 5, 10):\n    factor_rank_autocorr = pd.concat([\n        factor_rank_autocorr,\n        alphalens.performance.factor_rank_autocorrelation(\n            factor_data,\n            period=holding_period\n        )\n    ], axis=1)\n</code></pre>"},{"location":"reference/alphalens/api/#35-plot_factor_rank_auto_correlation","title":"3.5 plot_factor_rank_auto_correlation","text":"<p>\u5c07\u4e0d\u540c\u6301\u6709\u671f\u7684\u56e0\u5b50\u79e9\u81ea\u76f8\u95dc\u4fc2\u6578\u7e6a\u88fd\u6210\u6298\u7dda\u5716\uff0c\u89c0\u5bdf\u56e0\u5b50\u7a69\u5b9a\u6027\u5728\u6642\u9593\u5e8f\u5217\u4e0a\u7684\u8b8a\u5316\u3002</p>"},{"location":"reference/alphalens/api/#_12","title":"\u7bc4\u4f8b","text":"<pre><code>for holding_period in (1, 5, 10):\n    alphalens.plotting.plot_factor_rank_auto_correlation(\n        factor_rank_autocorr[holding_period],\n        period=holding_period\n    )\n</code></pre>"},{"location":"reference/alphalens/api/#36-plot_turnover_table","title":"3.6 plot_turnover_table","text":"<p>\u7e6a\u88fd\u5468\u8f49\u7387\u8207\u79e9\u81ea\u76f8\u95dc\u4fc2\u6578\u7684\u7d71\u8a08\u8868\u683c\uff0c\u63d0\u4f9b\u56e0\u5b50\u7a69\u5b9a\u6027\u7684\u5168\u9762\u8a55\u4f30\u3002</p>"},{"location":"reference/alphalens/api/#_13","title":"\u7bc4\u4f8b","text":"<pre><code>alphalens.plotting.plot_turnover_table(\n    factor_rank_autocorr,\n    quantile_turnover\n)\n</code></pre>"},{"location":"reference/alphalens/api/#37-create_turnover_tear_sheet","title":"3.7 create_turnover_tear_sheet","text":"<p>\u751f\u6210\u5305\u542b\u6240\u6709\u5468\u8f49\u7387\u5206\u6790\u5716\u8868\u7684\u5b8c\u6574\u5831\u544a\u3002\u6b64\u51fd\u6578\u6574\u5408\u5468\u8f49\u7387\u5206\u6790\u7684\u5404\u500b\u65b9\u9762\uff0c\u63d0\u4f9b\u56e0\u5b50\u7a69\u5b9a\u6027\u7684\u5b8c\u6574\u8a55\u4f30\u3002</p>"},{"location":"reference/alphalens/api/#_14","title":"\u7bc4\u4f8b","text":"<pre><code>alphalens.tears.create_turnover_tear_sheet(factor_data)\n</code></pre>"},{"location":"reference/alphalens/api/#4","title":"4. \u6536\u76ca\u5206\u6790\u51fd\u6578","text":""},{"location":"reference/alphalens/api/#41-mean_return_by_quantile","title":"4.1 mean_return_by_quantile","text":"<p>\u8a08\u7b97\u4e0d\u540c\u56e0\u5b50\u5206\u7d44\u5728\u4e0d\u540c\u6642\u9593\u9ede\u7684\u5e73\u5747\u5831\u916c\u7387\uff0c\u7528\u65bc\u8a55\u4f30\u56e0\u5b50\u7684\u9810\u6e2c\u529b\u5206\u4f48\u3002\u6b64\u51fd\u6578\u5c0d\u61c9\u65bc\u300c\u6536\u76ca\u5206\u6790\u300d\uff0c\u80fd\u6e05\u695a\u5c55\u793a\u4e0d\u540c\u5206\u7d44\u7684\u7e3e\u6548\u5dee\u7570\u3002</p>"},{"location":"reference/alphalens/api/#_15","title":"\u7bc4\u4f8b","text":"<pre><code>mean_return_by_q, std_err_by_q = alphalens.performance.mean_return_by_quantile(\n    factor_data, \n    by_date=True\n)\n</code></pre>"},{"location":"reference/alphalens/api/#5","title":"5. \u5b8c\u6574\u5de5\u4f5c\u6d41\u7a0b\u7bc4\u4f8b","text":"<pre><code>import alphalens\nimport pandas as pd\n\n# 1. \u6e96\u5099\u56e0\u5b50\u8cc7\u6599\u8207\u50f9\u683c\u8cc7\u6599\nfactor_data = alphalens.utils.get_clean_factor_and_forward_returns(\n    factor,\n    prices,\n    quantiles=5,\n    periods=(1, 5, 10),\n    groupby=sector_map\n)\n\n# 2. IC \u8cc7\u8a0a\u4fc2\u6578\u5206\u6790\nic = alphalens.performance.factor_information_coefficient(factor_data)\nalphalens.plotting.plot_ic_ts(ic)\nalphalens.tears.create_information_tear_sheet(factor_data)\n\n# 3. \u5468\u8f49\u7387\u8207\u7a69\u5b9a\u6027\u5206\u6790\nalphalens.tears.create_turnover_tear_sheet(factor_data)\n\n# 4. \u5b8c\u6574\u7e3e\u6548\u5831\u544a\nalphalens.tears.create_full_tear_sheet(factor_data)\n</code></pre>"},{"location":"reference/pipeline/built-ins/","title":"\u5167\u5efa\u56e0\u5b50/\u6ffe\u7db2/\u5206\u985e\u5668","text":"<p>Info</p> <p>\u672c\u9801\u8a73\u7d30\u5217\u51fa TQuant Lab Pipeline \u4e2d\u6240\u6709\u5167\u5efa\u7684\u56e0\u5b50 (Factors)\u3001\u6ffe\u7db2 (Filters) \u548c\u5206\u985e\u5668 (Classifiers)\uff0c\u4e26\u63d0\u4f9b\u5176\u7528\u9014\u3001\u53c3\u6578\u8aaa\u660e\u53ca\u4f7f\u7528\u7bc4\u4f8b\uff0c\u5e6b\u52a9\u4f7f\u7528\u8005\u5feb\u901f\u7406\u89e3\u548c\u61c9\u7528\u9019\u4e9b\u6838\u5fc3\u7d44\u4ef6\u3002</p> <p>Zipline Pipeline \u63d0\u4f9b\u4e86\u8c50\u5bcc\u7684\u5167\u5efa\u7d44\u4ef6\uff0c\u8b93\u60a8\u53ef\u4ee5\u7121\u9700\u5f9e\u982d\u958b\u59cb\u7de8\u5beb\u8907\u96dc\u7684\u8a08\u7b97\u908f\u8f2f\u3002\u9019\u4e9b\u7d44\u4ef6\u7d93\u904e\u512a\u5316\uff0c\u80fd\u5920\u9ad8\u6548\u5730\u8655\u7406\u5927\u91cf\u7684\u6b77\u53f2\u6578\u64da\uff0c\u751f\u6210\u5404\u7a2e\u4ea4\u6613\u8a0a\u865f\u3002</p>"},{"location":"reference/pipeline/built-ins/#1-factors","title":"1. Factors (\u56e0\u5b50)","text":"<p>Factors \u7528\u65bc\u8a08\u7b97\u6bcf\u500b\u8cc7\u7522\u5728\u6bcf\u500b\u6642\u9593\u9ede\u7684\u6578\u503c\u3002\u5b83\u5011\u901a\u5e38\u57fa\u65bc\u6b77\u53f2\u50f9\u683c\u3001\u6210\u4ea4\u91cf\u6216\u5176\u4ed6\u6578\u64da\u4f86\u751f\u6210\u6280\u8853\u6307\u6a19\u6216\u57fa\u672c\u9762\u6307\u6a19\u3002</p>"},{"location":"reference/pipeline/built-ins/#11-simplemovingaverageinputs-window_length","title":"1.1 SimpleMovingAverage(inputs, window_length)","text":"<ul> <li>\u7528\u9014\uff1a\u8a08\u7b97\u6307\u5b9a\u8f38\u5165\u6578\u64da\u7684\u7c21\u55ae\u79fb\u52d5\u5e73\u5747\u3002</li> <li>\u53c3\u6578\uff1a<ul> <li><code>inputs</code> (list of <code>BoundColumn</code>)\uff1a\u8981\u8a08\u7b97\u79fb\u52d5\u5e73\u5747\u7684\u6578\u64da\u4f86\u6e90\uff0c\u4f8b\u5982 <code>[TWEquityPricing.close]</code>\u3002</li> <li><code>window_length</code> (int)\uff1a\u79fb\u52d5\u5e73\u5747\u7684\u8a08\u7b97\u7a97\u53e3\u9577\u5ea6\u3002</li> </ul> </li> <li> <p>\u7bc4\u4f8b\uff1a\u8a08\u7b97 20 \u65e5\u6536\u76e4\u50f9\u79fb\u52d5\u5e73\u5747\u3002</p> <pre><code>from zipline.pipeline.factors import SimpleMovingAverage\nfrom zipline.pipeline.data import TWEquityPricing\n\nmean_close_20 = SimpleMovingAverage(inputs=[TWEquityPricing.close], window_length=20)\n</code></pre> </li> </ul>"},{"location":"reference/pipeline/built-ins/#12-exponentialweightedmovingaverageinputs-window_length-decay_rate","title":"1.2 ExponentialWeightedMovingAverage(inputs, window_length, decay_rate)","text":"<ul> <li>\u7528\u9014\uff1a\u8a08\u7b97\u6307\u5b9a\u8f38\u5165\u6578\u64da\u7684\u6307\u6578\u52a0\u6b0a\u79fb\u52d5\u5e73\u5747\uff0c\u5c0d\u8fd1\u671f\u6578\u64da\u8ce6\u4e88\u66f4\u9ad8\u7684\u6b0a\u91cd\u3002</li> <li>\u53c3\u6578\uff1a<ul> <li><code>inputs</code> (list of <code>BoundColumn</code>)\uff1a\u8981\u8a08\u7b97\u6307\u6578\u52a0\u6b0a\u79fb\u52d5\u5e73\u5747\u7684\u6578\u64da\u4f86\u6e90\u3002</li> <li><code>window_length</code> (int)\uff1a\u6307\u6578\u52a0\u6b0a\u79fb\u52d5\u5e73\u5747\u7684\u8a08\u7b97\u7a97\u53e3\u9577\u5ea6\u3002</li> <li><code>decay_rate</code> (float, optional)\uff1a\u8870\u6e1b\u7387\uff0c\u7528\u65bc\u63a7\u5236\u6b0a\u91cd\u4e0b\u964d\u7684\u901f\u5ea6\u3002\u5982\u679c\u672a\u6307\u5b9a\uff0c\u5247\u6839\u64da <code>window_length</code> \u8a08\u7b97\u3002</li> </ul> </li> <li> <p>\u7bc4\u4f8b\uff1a\u8a08\u7b97 20 \u65e5\u6536\u76e4\u50f9\u6307\u6578\u52a0\u6b0a\u79fb\u52d5\u5e73\u5747\u3002</p> <pre><code>from zipline.pipeline.factors import ExponentialWeightedMovingAverage\nfrom zipline.pipeline.data import TWEquityPricing\n\newma_close_20 = ExponentialWeightedMovingAverage(inputs=[TWEquityPricing.close], window_length=20)\n</code></pre> </li> </ul>"},{"location":"reference/pipeline/built-ins/#13-momentuminputs-window_length","title":"1.3 Momentum(inputs, window_length)","text":"<ul> <li>\u7528\u9014\uff1a\u8a08\u7b97\u6307\u5b9a\u8f38\u5165\u6578\u64da\u7684\u52d5\u91cf\uff0c\u8861\u91cf\u50f9\u683c\u8b8a\u5316\u7684\u901f\u5ea6\u548c\u5e45\u5ea6\u3002</li> <li>\u53c3\u6578\uff1a<ul> <li><code>inputs</code> (list of <code>BoundColumn</code>)\uff1a\u8981\u8a08\u7b97\u52d5\u91cf\u7684\u6578\u64da\u4f86\u6e90\uff0c\u901a\u5e38\u662f\u6536\u76e4\u50f9\u3002</li> <li><code>window_length</code> (int)\uff1a\u52d5\u91cf\u8a08\u7b97\u7684\u7a97\u53e3\u9577\u5ea6\u3002</li> </ul> </li> <li> <p>\u7bc4\u4f8b\uff1a\u8a08\u7b97 10 \u65e5\u6536\u76e4\u50f9\u52d5\u91cf\u3002</p> <pre><code>from zipline.pipeline.factors import Momentum\nfrom zipline.pipeline.data import TWEquityPricing\n\nmomentum_10 = Momentum(inputs=[TWEquityPricing.close], window_length=10)\n</code></pre> </li> </ul>"},{"location":"reference/pipeline/built-ins/#14-faststochasticoscillatorinputs-window_length","title":"1.4 FastStochasticOscillator(inputs, window_length)","text":"<ul> <li>\u7528\u9014\uff1a\u8a08\u7b97\u5feb\u901f\u96a8\u6a5f\u6307\u6a19 (Fast Stochastic Oscillator)\uff0c\u5373 K \u503c\uff0c\u7528\u65bc\u5224\u65b7\u8d85\u8cb7\u8d85\u8ce3\u3002</li> <li>\u53c3\u6578\uff1a<ul> <li><code>inputs</code> (list of <code>BoundColumn</code>)\uff1a\u901a\u5e38\u70ba <code>[TWEquityPricing.close, TWEquityPricing.low, TWEquityPricing.high]</code>\u3002</li> <li><code>window_length</code> (int)\uff1a\u8a08\u7b97 K \u503c\u6240\u9700\u7684\u8996\u7a97\u9577\u5ea6\u3002</li> </ul> </li> <li> <p>\u7bc4\u4f8b\uff1a\u8a08\u7b97 10 \u65e5 K \u503c\u3002</p> <pre><code>from zipline.pipeline.factors import FastStochasticOscillator\nfrom zipline.pipeline.data import TWEquityPricing\n\nfast_k = FastStochasticOscillator(\n    inputs=[TWEquityPricing.close, TWEquityPricing.low, TWEquityPricing.high],\n    window_length=10\n)\n</code></pre> </li> </ul>"},{"location":"reference/pipeline/built-ins/#15-marketcapinputs-window_length","title":"1.5 MarketCap(inputs, window_length)","text":"<ul> <li>\u7528\u9014\uff1a\u8a08\u7b97\u5e02\u503c\u3002\u901a\u5e38\u4e0d\u9700\u8981 <code>inputs</code> \u548c <code>window_length</code>\uff0c\u56e0\u70ba\u5e02\u503c\u662f\u6bcf\u65e5\u66f4\u65b0\u7684\u3002</li> <li>\u53c3\u6578\uff1a\u7121\u7279\u5b9a\u53c3\u6578\uff0c\u4f46\u53ef\u4ee5\u93c8\u63a5 <code>.top()</code> \u6216 <code>.bottom()</code> \u65b9\u6cd5\u9032\u884c\u7be9\u9078\u3002</li> <li> <p>\u7bc4\u4f8b\uff1a\u7372\u53d6\u5e02\u503c\u3002</p> <pre><code>from zipline.pipeline.factors import MarketCap\n\nmarket_cap = MarketCap()\n</code></pre> </li> </ul>"},{"location":"reference/pipeline/built-ins/#2-filters","title":"2. Filters (\u6ffe\u7db2)","text":"<p>Filters \u7528\u65bc\u7be9\u9078\u51fa\u4e00\u7d44\u7b26\u5408\u7279\u5b9a\u689d\u4ef6\u7684\u8cc7\u7522\u3002\u5b83\u5011\u7684\u8f38\u51fa\u662f\u5e03\u6797\u503c (True/False)\u3002</p>"},{"location":"reference/pipeline/built-ins/#21-staticassetsassets","title":"2.1 StaticAssets(assets)","text":"<ul> <li>\u7528\u9014\uff1a\u7be9\u9078\u51fa\u4e00\u500b\u975c\u614b\u7684\u8cc7\u7522\u5217\u8868\u3002\u9019\u4e9b\u8cc7\u7522\u5728\u6574\u500b\u56de\u6e2c\u671f\u9593\u4fdd\u6301\u4e0d\u8b8a\u3002</li> <li>\u53c3\u6578\uff1a<ul> <li><code>assets</code> (list of <code>Asset</code>)\uff1a\u8981\u5305\u542b\u5728\u7be9\u9078\u7d50\u679c\u4e2d\u7684\u8cc7\u7522\u5217\u8868\u3002</li> </ul> </li> <li> <p>\u7bc4\u4f8b\uff1a\u7be9\u9078\u51fa\u53f0\u7a4d\u96fb\u548c\u806f\u767c\u79d1\u3002</p> <pre><code>from zipline.api import symbol\nfrom zipline.pipeline.filters import StaticAssets\n\nmy_assets = StaticAssets([symbol('2330'), symbol('2454')])\n</code></pre> </li> </ul>"},{"location":"reference/pipeline/built-ins/#22-topnfactor-n-bottomnfactor-n","title":"2.2 TopN(factor, N) / BottomN(factor, N)","text":"<ul> <li>\u7528\u9014\uff1a\u6839\u64da\u6307\u5b9a\u56e0\u5b50\u7684\u503c\uff0c\u7be9\u9078\u51fa\u6392\u540d\u524d N \u6216\u5f8c N \u7684\u8cc7\u7522\u3002</li> <li>\u53c3\u6578\uff1a<ul> <li><code>factor</code> (Factor)\uff1a\u7528\u65bc\u6392\u5e8f\u7684\u56e0\u5b50\u3002</li> <li><code>N</code> (int)\uff1a\u8981\u7be9\u9078\u7684\u8cc7\u7522\u6578\u91cf\u3002</li> </ul> </li> <li> <p>\u7bc4\u4f8b\uff1a\u7be9\u9078\u51fa\u5e02\u503c\u6392\u540d\u524d 100 \u7684\u80a1\u7968\u3002</p> <pre><code>from zipline.pipeline.factors import MarketCap\n\ntop_100_by_market_cap = MarketCap().top(100)\n</code></pre> </li> </ul>"},{"location":"reference/pipeline/built-ins/#23-logical-operators","title":"2.3 \u908f\u8f2f\u904b\u7b97\u7b26 (Logical Operators)","text":"<p>Filters \u53ef\u4ee5\u900f\u904e\u908f\u8f2f\u904b\u7b97\u7b26 (<code>&amp;</code> (AND), <code>|</code> (OR), <code>~</code> (NOT)) \u9032\u884c\u7d44\u5408\uff0c\u4ee5\u69cb\u5efa\u66f4\u8907\u96dc\u7684\u7be9\u9078\u689d\u4ef6\u3002</p> <ul> <li> <p>\u7bc4\u4f8b\uff1a\u7be9\u9078\u51fa\u5e02\u503c\u6392\u540d\u524d 100 \u4e14 20 \u65e5\u5747\u7dda\u5927\u65bc 100 \u7684\u80a1\u7968\u3002</p> <pre><code>from zipline.pipeline.factors import MarketCap, SimpleMovingAverage\nfrom zipline.pipeline.data import TWEquityPricing\n\ntop_100 = MarketCap().top(100)\nmean_close_20_gt_100 = SimpleMovingAverage(inputs=[TWEquityPricing.close], window_length=20) &gt; 100\n\ncombined_filter = top_100 &amp; mean_close_20_gt_100\n</code></pre> </li> </ul>"},{"location":"reference/pipeline/built-ins/#3-classifiers","title":"3. Classifiers (\u5206\u985e\u5668)","text":"<p>Classifiers \u7528\u65bc\u70ba\u8cc7\u7522\u9032\u884c\u5206\u985e\uff0c\u5176\u8f38\u51fa\u901a\u5e38\u662f\u5b57\u4e32\u6216\u6574\u6578\uff0c\u4ee3\u8868\u8cc7\u7522\u6240\u5c6c\u7684\u985e\u5225\u3002</p>"},{"location":"reference/pipeline/built-ins/#31-sector","title":"3.1 Sector()","text":"<ul> <li>\u7528\u9014\uff1a\u8fd4\u56de\u6bcf\u500b\u8cc7\u7522\u6240\u5c6c\u7684\u7522\u696d\u985e\u5225\u3002</li> <li>\u53c3\u6578\uff1a\u7121\u3002</li> <li> <p>\u7bc4\u4f8b\uff1a\u7372\u53d6\u80a1\u7968\u7684\u7522\u696d\u985e\u5225\u3002</p> <pre><code>from zipline.pipeline.classifiers import Sector\n\nsector_classifier = Sector()\n</code></pre> </li> </ul>"},{"location":"reference/pipeline/built-ins/#32-quantilesfactor-n","title":"3.2 Quantiles(factor, N)","text":"<ul> <li>\u7528\u9014\uff1a\u5c07\u4e00\u500b\u56e0\u5b50\u7684\u8f38\u51fa\u503c\u6309\u5206\u4f4d\u6578\u9032\u884c\u5206\u7d44\u3002\u4f8b\u5982\uff0c\u5c07\u6240\u6709\u80a1\u7968\u6309\u5e02\u503c\u5206\u70ba 5 \u500b\u5206\u4f4d\u6578\u7d44\u3002</li> <li>\u53c3\u6578\uff1a<ul> <li><code>factor</code> (Factor)\uff1a\u8981\u9032\u884c\u5206\u4f4d\u6578\u5206\u7d44\u7684\u56e0\u5b50\u3002</li> <li><code>N</code> (int)\uff1a\u8981\u5206\u7d44\u7684\u6578\u91cf\u3002</li> </ul> </li> <li> <p>\u7bc4\u4f8b\uff1a\u5c07\u5e02\u503c\u5206\u70ba 5 \u500b\u5206\u4f4d\u6578\u7d44\u3002</p> <pre><code>from zipline.pipeline.factors import MarketCap\nfrom zipline.pipeline.classifiers import Quantiles\n\nmarket_cap_quantiles = Quantiles(inputs=[MarketCap()], N=5)\n</code></pre> </li> </ul>"},{"location":"reference/pipeline/built-ins/#4","title":"4. \u7e3d\u7d50","text":"<p>TQuant Lab Pipeline \u7684\u5167\u5efa\u7d44\u4ef6\u63d0\u4f9b\u4e86\u5f37\u5927\u7684\u57fa\u790e\uff0c\u8b93\u60a8\u53ef\u4ee5\u5feb\u901f\u69cb\u5efa\u548c\u6e2c\u8a66\u5404\u7a2e\u91cf\u5316\u7b56\u7565\u3002\u900f\u904e\u9748\u6d3b\u7d44\u5408 Factors\u3001Filters \u548c Classifiers\uff0c\u60a8\u53ef\u4ee5\u5f9e\u539f\u59cb\u6578\u64da\u4e2d\u63d0\u53d6\u6709\u50f9\u503c\u7684\u6295\u8cc7\u8a0a\u865f\uff0c\u4e26\u6709\u6548\u5730\u7ba1\u7406\u60a8\u7684\u80a1\u7968\u6c60\u3002</p>"},{"location":"reference/pipeline/custom-factor/","title":"Zipline CustomFactor\uff1a\u5275\u5efa\u81ea\u5b9a\u7fa9\u56e0\u5b50","text":"<p>Info</p> <p>\u672c\u9801\u6df1\u5165\u4ecb\u7d39 Zipline Pipeline \u4e2d\u7684 <code>CustomFactor</code>\uff0c\u8aaa\u660e\u5982\u4f55\u900f\u904e\u7e7c\u627f\u6b64\u985e\u5225\u4f86\u5275\u5efa\u81ea\u8a02\u7684\u56e0\u5b50\uff0c\u4ee5\u6eff\u8db3\u7279\u5b9a\u7684\u91cf\u5316\u7b56\u7565\u9700\u6c42\u3002\u5167\u5bb9\u6db5\u84cb <code>CustomFactor</code> \u7684\u6838\u5fc3\u6982\u5ff5\u3001\u53c3\u6578\u3001<code>compute</code> \u65b9\u6cd5\u7684\u5be6\u73fe\u7d30\u7bc0\uff0c\u4e26\u63d0\u4f9b\u5be6\u7528\u7684\u7a0b\u5f0f\u78bc\u7bc4\u4f8b\u3002</p> <p>\u5728 Zipline \u7684 Pipeline API \u4e2d\uff0c<code>Factor</code> \u5141\u8a31\u60a8\u5c0d\u6578\u64da\u9032\u884c\u6578\u503c\u8a08\u7b97\u3002\u96d6\u7136 Zipline \u63d0\u4f9b\u4e86\u8a31\u591a\u5167\u5efa\u56e0\u5b50\uff0c\u4f46\u5be6\u52d9\u4e0a\u60a8\u5e38\u5e38\u9700\u8981\u6839\u64da\u81ea\u5df1\u7684\u7b56\u7565\u9700\u6c42\u5275\u5efa\u7368\u7279\u7684\u5206\u6790\u6307\u6a19\u3002<code>CustomFactor</code> \u5c31\u662f\u70ba\u6b64\u800c\u751f\uff0c\u5b83\u8b93\u60a8\u80fd\u5920\u5b8c\u5168\u81ea\u5b9a\u7fa9\u56e0\u5b50\u7684\u8a08\u7b97\u908f\u8f2f\u3002</p> <p><code>CustomFactor</code> \u985e\u5225\u7e7c\u627f\u81ea <code>Factor</code>\uff0c\u9019\u8868\u793a\u5b83\u64c1\u6709 <code>Factor</code> \u7684\u6240\u6709\u57fa\u672c\u7279\u6027\uff0c\u4e26\u5728\u6b64\u57fa\u790e\u4e0a\u63d0\u4f9b\u4e86\u4e00\u500b <code>compute</code> \u65b9\u6cd5\u4f9b\u60a8\u8986\u5beb\uff0c\u4ee5\u5be6\u73fe\u60a8\u7684\u81ea\u5b9a\u7fa9\u908f\u8f2f\u3002</p>"},{"location":"reference/pipeline/custom-factor/#1-customfactor","title":"1. CustomFactor \u7c21\u4ecb","text":"<ul> <li>\u7528\u9014: \u5141\u8a31\u958b\u767c\u8005\u5b9a\u7fa9\u4efb\u4f55\u57fa\u65bc\u6b77\u53f2\u6578\u64da\u7684\u6a6b\u622a\u9762\u56e0\u5b50\u8a08\u7b97\u908f\u8f2f\u3002</li> <li>\u7e7c\u627f: \u5fc5\u9808\u7e7c\u627f\u81ea <code>zipline.pipeline.CustomFactor</code>\u3002</li> <li>\u6838\u5fc3: \u900f\u904e\u5be6\u4f5c <code>compute()</code> \u65b9\u6cd5\u4f86\u5b9a\u7fa9\u56e0\u5b50\u7684\u8a08\u7b97\u65b9\u5f0f\u3002</li> </ul>"},{"location":"reference/pipeline/custom-factor/#2-customfactor","title":"2. CustomFactor \u7684\u6838\u5fc3\u5c6c\u6027\u8207\u65b9\u6cd5","text":"<p>\u5728\u5b9a\u7fa9 <code>CustomFactor</code> \u6642\uff0c\u60a8\u9700\u8981\u8a2d\u5b9a\u4ee5\u4e0b\u6838\u5fc3\u5c6c\u6027\uff0c\u4e26\u5be6\u4f5c <code>compute()</code> \u65b9\u6cd5\uff1a</p> <ul> <li><code>inputs</code>:<ul> <li>(\u985e\u5225\u5c6c\u6027) \u4e00\u500b\u5217\u8868\uff0c\u5305\u542b <code>BoundColumn</code> \u7269\u4ef6\uff08\u4f8b\u5982 <code>EquityPricing.close</code>\uff09\uff0c\u9019\u4e9b\u662f\u56e0\u5b50\u8a08\u7b97\u6240\u9700\u7684\u6b77\u53f2\u6578\u64da\u8f38\u5165\u3002</li> <li>\u7bc4\u4f8b\uff1a<code>inputs = [EquityPricing.close, EquityPricing.volume]</code></li> </ul> </li> <li><code>window_length</code>:<ul> <li>(\u985e\u5225\u5c6c\u6027) \u4e00\u500b\u6574\u6578\uff0c\u5b9a\u7fa9\u56e0\u5b50\u8a08\u7b97\u6240\u9700\u7684\u6b77\u53f2\u6578\u64da\u7a97\u53e3\u9577\u5ea6\u3002\u4f8b\u5982\uff0c<code>window_length = 20</code> \u8868\u793a\u56e0\u5b50\u6703\u4f7f\u7528\u904e\u53bb 20 \u5929\u7684\u6578\u64da\u9032\u884c\u8a08\u7b97\u3002</li> </ul> </li> <li><code>compute(self, today, assets, out, *arrays)</code>:<ul> <li>(\u65b9\u6cd5) \u9019\u662f\u60a8\u5fc5\u9808\u8986\u5beb\u7684\u6838\u5fc3\u65b9\u6cd5\uff0c\u7528\u65bc\u5be6\u73fe\u81ea\u5b9a\u7fa9\u56e0\u5b50\u7684\u8a08\u7b97\u908f\u8f2f\u3002\u5b83\u5728\u6bcf\u500b\u4ea4\u6613\u65e5\u90fd\u6703\u88ab\u547c\u53eb\u3002</li> <li><code>self</code>: <code>CustomFactor</code> \u5be6\u4f8b\u672c\u8eab\u3002</li> <li><code>today</code>: (<code>pd.Timestamp</code>) \u7576\u524d\u6b63\u5728\u8a08\u7b97\u56e0\u5b50\u7684\u65e5\u671f\u3002</li> <li><code>assets</code>: (<code>np.array</code>) \u4e00\u7dad NumPy \u6578\u7d44\uff0c\u5305\u542b\u7576\u524d Pipeline Universe \u4e2d\u7684\u8cc7\u7522 SID\u3002</li> <li><code>out</code>: (<code>np.array</code>) \u4e00\u7dad NumPy \u6578\u7d44\uff0c\u60a8\u5fc5\u9808\u5c07\u8a08\u7b97\u51fa\u7684\u56e0\u5b50\u503c\u5beb\u5165\u6b64\u6578\u7d44\u4e2d\u3002\u5b83\u7684\u9577\u5ea6\u8207 <code>assets</code> \u76f8\u540c\u3002</li> <li><code>*arrays</code>: \u8b8a\u9577\u53c3\u6578\uff0c\u6bcf\u500b\u53c3\u6578\u5c0d\u61c9\u65bc <code>inputs</code> \u5217\u8868\u4e2d\u7684\u4e00\u500b\u6b77\u53f2\u6578\u64da\u8f38\u5165\u3002\u6bcf\u500b <code>array</code> \u90fd\u662f\u4e00\u500b 2D NumPy \u6578\u7d44\uff0c\u5f62\u72c0\u70ba <code>(window_length, len(assets))</code>\uff0c\u5305\u542b\u904e\u53bb <code>window_length</code> \u5929\u7684\u6578\u64da\u3002</li> </ul> </li> <li><code>dtype</code>:<ul> <li>(\u985e\u5225\u5c6c\u6027) \u5b9a\u7fa9\u56e0\u5b50\u7684\u8f38\u51fa\u6578\u64da\u985e\u578b\uff0c\u4f8b\u5982 <code>np.float64</code>\u3002</li> </ul> </li> <li><code>missing_value</code>:<ul> <li>(\u985e\u5225\u5c6c\u6027) \u7576\u6578\u64da\u7f3a\u5931\u6642\u7528\u65bc\u586b\u5145\u7684\u9810\u8a2d\u503c\u3002</li> </ul> </li> </ul>"},{"location":"reference/pipeline/custom-factor/#3-customfactor","title":"3. \u5982\u4f55\u5275\u5efa CustomFactor","text":"<p>\u4ee5\u4e0b\u5c07\u4ee5\u4e00\u500b\u7c21\u55ae\u7684 <code>StdDev</code> (\u6a19\u6e96\u5dee) \u56e0\u5b50\u70ba\u4f8b\uff0c\u6f14\u793a\u5982\u4f55\u7e7c\u627f <code>CustomFactor</code> \u4e26\u5be6\u4f5c <code>compute</code> \u65b9\u6cd5\u4f86\u8a08\u7b97\u904e\u53bb <code>N</code> \u5929\u6536\u76e4\u50f9\u7684\u6efe\u52d5\u6a19\u6e96\u5dee\u3002</p> <pre><code>import numpy as np\nfrom zipline.pipeline import CustomFactor\nfrom zipline.pipeline.data import EquityPricing\n\nclass StdDev(CustomFactor):\n    \"\"\"\n    \u8a08\u7b97\u904e\u53bb N \u5929\u6536\u76e4\u50f9\u7684\u6efe\u52d5\u6a19\u6e96\u5dee\u3002\n    \"\"\"\n    # \u56e0\u5b50\u8a08\u7b97\u6240\u9700\u7684\u8f38\u5165\u6578\u64da (\u9019\u88e1\u53ea\u9700\u8981\u6536\u76e4\u50f9)\n    inputs = [EquityPricing.close]\n\n    # \u56e0\u5b50\u8a08\u7b97\u6240\u9700\u7684\u6b77\u53f2\u6578\u64da\u7a97\u53e3\u9577\u5ea6 (\u5c07\u5728\u521d\u59cb\u5316\u6642\u50b3\u5165)\n    window_length = 0 # \u9019\u88e1\u8a2d\u70ba0\uff0c\u56e0\u70ba\u5be6\u969b\u6703\u5728\u5be6\u4f8b\u5316\u6642\u8a2d\u5b9a\n\n    # \u56e0\u5b50\u8f38\u51fa\u7684\u6578\u64da\u985e\u578b\n    dtype = np.float64\n\n    # \u7576\u6578\u64da\u7f3a\u5931\u6642\u7684\u586b\u5145\u503c\n    missing_value = 0.0\n\n    def compute(self, today, assets, out, close_prices):\n        \"\"\"\n        \u6838\u5fc3\u7684\u56e0\u5b50\u8a08\u7b97\u908f\u8f2f\u3002\n        \"\"\"\n        # close_prices \u662f\u4e00\u500b (window_length, len(assets)) \u7684 NumPy \u6578\u7d44\n        # \u8a08\u7b97\u6bcf\u500b\u8cc7\u7522\u5728\u6307\u5b9a\u7a97\u53e3\u9577\u5ea6\u5167\u7684\u6a19\u6e96\u5dee\n        out[:] = np.nanstd(close_prices, axis=0) # axis=0 \u5c0d\u6642\u9593\u7dad\u5ea6\u6c42\u6a19\u6e96\u5dee\n</code></pre>"},{"location":"reference/pipeline/custom-factor/#4-pipeline-customfactor","title":"4. \u5728 Pipeline \u4e2d\u4f7f\u7528 CustomFactor","text":"<p>\u5275\u5efa <code>CustomFactor</code> \u5f8c\uff0c\u60a8\u5c31\u53ef\u4ee5\u50cf\u4f7f\u7528\u4efb\u4f55\u5167\u5efa\u56e0\u5b50\u4e00\u6a23\uff0c\u5c07\u5176\u61c9\u7528\u5230\u60a8\u7684 Pipeline \u4e2d\u3002</p>"},{"location":"reference/pipeline/custom-factor/#_1","title":"\u7bc4\u4f8b","text":"<pre><code>from zipline.pipeline import Pipeline\n# from zipline.pipeline.factors import SimpleMovingAverage # \u4e5f\u53ef\u4ee5\u540c\u6642\u4f7f\u7528\u5167\u5efa\u56e0\u5b50\n\ndef make_my_pipeline():\n    # \u5be6\u4f8b\u5316 CustomFactor\uff0c\u4e26\u8a2d\u5b9a\u5176 window_length\n    my_std_dev = StdDev(window_length=20) # \u8a08\u7b97 20 \u65e5\u6efe\u52d5\u6a19\u6e96\u5dee\n\n    return Pipeline(\n        columns={\n            'StdDev_20D': my_std_dev,\n            'Close_Price': EquityPricing.close.latest # \u4e5f\u53ef\u4ee5\u7372\u53d6\u6700\u65b0\u6536\u76e4\u50f9\n        }\n    )\n</code></pre>"},{"location":"reference/pipeline/custom-factor/#5","title":"5. \u5b8c\u6574\u7bc4\u4f8b","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u500b\u5b8c\u6574\u7684\u7bc4\u4f8b\uff0c\u6f14\u793a\u5982\u4f55\u5b9a\u7fa9\u4e00\u500b <code>CustomFactor</code> \u4e26\u5728 Zipline \u56de\u6e2c\u4e2d\u4f7f\u7528\u5b83\u3002</p> <pre><code>import pandas as pd\nimport numpy as np\nfrom zipline import run_algorithm\nfrom zipline.api import (\n    attach_pipeline,\n    pipeline_output,\n    set_benchmark,\n    symbol,\n    order_target_percent\n)\nfrom zipline.pipeline import Pipeline, CustomFactor\nfrom zipline.pipeline.data import EquityPricing\nfrom zipline.pipeline.filters import AverageDollarVolume\n\n# 1. \u5b9a\u7fa9 CustomFactor: \u8a08\u7b97 N \u65e5\u6efe\u52d5\u6a19\u6e96\u5dee\nclass CustomStdDev(CustomFactor):\n    inputs = [EquityPricing.close]\n    window_length = 0 # \u5c07\u5728\u5be6\u4f8b\u5316\u6642\u8986\u84cb\n    dtype = np.float64\n    missing_value = 0.0\n\n    def compute(self, today, assets, out, close_prices):\n        out[:] = np.nanstd(close_prices, axis=0)\n\n# 2. \u5b9a\u7fa9 Pipeline\ndef make_my_pipeline():\n    # \u5be6\u4f8b\u5316\u81ea\u5b9a\u7fa9\u56e0\u5b50\uff0c\u8a08\u7b97 20 \u65e5\u6efe\u52d5\u6a19\u6e96\u5dee\n    my_std_dev_20d = CustomStdDev(window_length=20)\n\n    # \u7be9\u9078\u5668\uff1a\u904e\u53bb 10 \u5929\u5e73\u5747\u65e5\u6210\u4ea4\u91d1\u984d\u524d 20 \u6a94\u80a1\u7968\n    high_volume_filter = AverageDollarVolume(window_length=10).top(20)\n\n    return Pipeline(\n        columns={\n            'Custom_StdDev_20D': my_std_dev_20d,\n            'Close_Price': EquityPricing.close.latest\n        },\n        screen=high_volume_filter # \u900f\u904e screen \u7be9\u9078 Universe\n    )\n\n# 3. Zipline \u56de\u6e2c\u8a2d\u7f6e\ndef initialize(context):\n    set_benchmark(symbol('IR0001'))\n    attach_pipeline(make_my_pipeline(), 'my_strategy_pipeline') \n\ndef before_trading_start(context, data):\n    pipeline_results = pipeline_output('my_strategy_pipeline')\n    context.my_universe = pipeline_results.index.get_level_values(1).tolist()\n    context.pipeline_data = pipeline_results\n\ndef handle_data(context, data):\n    if not context.my_universe:\n        return\n\n    for asset in context.my_universe:\n        if data.can_trade(asset) and asset in context.pipeline_data.index.get_level_values(1):\n            std_dev_value = context.pipeline_data.loc[(data.current_dt.date(), asset), 'Custom_StdDev_20D']\n            current_price = data.current(asset, 'price')\n\n            # \u7c21\u55ae\u7b56\u7565\uff1a\u5982\u679c\u80a1\u50f9\u6ce2\u52d5\u8f03\u5927\uff08\u4f8b\u5982\uff0c\u9ad8\u65bc\u5176 20 \u65e5\u6a19\u6e96\u5dee\u7684 X \u500d\uff09\uff0c\u5247\u9032\u884c\u64cd\u4f5c\n            # \u9019\u88e1\u50c5\u4f5c\u793a\u4f8b\uff0c\u5be6\u969b\u7b56\u7565\u6703\u66f4\u8907\u96dc\n            if current_price &gt; 100 and std_dev_value &gt; 5: # \u5047\u8a2d\u80a1\u50f9\u5927\u65bc100\u4e14\u6ce2\u52d5\u5927\u65bc5\n                if asset not in context.portfolio.positions:\n                    order_target_percent(asset, 1.0 / len(context.my_universe))\n            elif current_price &lt; 90 and asset in context.portfolio.positions:\n                order_target_percent(asset, 0.0)\n\ndef analyze(context, results):\n    print(\"\u56de\u6e2c\u5206\u6790\u5b8c\u6210\u3002\")\n\n# \u57f7\u884c\u56de\u6e2c\nresults = run_algorithm(\n    start=pd.Timestamp('2020-01-01', tz='UTC'),\n    end=pd.Timestamp('2021-01-01', tz='UTC'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    capital_base=1_000_000,\n    bundle='tquant',\n    before_trading_start=before_trading_start\n)\n</code></pre>"},{"location":"reference/pipeline/overview/","title":"Zipline Pipeline API \u6982\u89bd","text":"<p>Info</p> <p>\u672c\u9801\u6df1\u5165\u89e3\u91cb Zipline Pipeline \u7684\u904b\u4f5c\u539f\u7406\uff0c\u5305\u62ec\u5176\u6838\u5fc3\u7d44\u4ef6\uff08Factors, Filters, Classifiers\uff09\u3001\u8cc7\u6599\u96c6 (DataSets) \u7684\u6982\u5ff5\u3001\u4ee5\u53ca\u5982\u4f55\u900f\u904e Pipeline \u9ad8\u6548\u5730\u751f\u6210\u4ea4\u6613\u8a0a\u865f\uff0c\u70ba\u4f7f\u7528\u8005\u5efa\u7acb\u5c0d Pipeline \u7684\u5168\u9762\u7406\u89e3\u3002</p> <p>Zipline \u7684 Pipeline API \u662f\u4e00\u500b\u5f37\u5927\u4e14\u9ad8\u6548\u7684\u5de5\u5177\uff0c\u5c08\u70ba\u5728\u9f90\u5927\u7684\u8cc7\u7522\u6c60\u4e2d\u9032\u884c\u56e0\u5b50\u8a08\u7b97\u548c\u52d5\u614b\u8cc7\u7522\u7be9\u9078\u800c\u8a2d\u8a08\u3002\u5b83\u5141\u8a31\u7b56\u7565\u958b\u767c\u8005\u4ee5\u8072\u660e\u5f0f\u7684\u65b9\u5f0f\u5b9a\u7fa9\u8907\u96dc\u7684\u6578\u64da\u8655\u7406\u6d41\u7a0b\uff0c\u5f9e\u800c\u907f\u514d\u4e86\u50b3\u7d71\u65b9\u6cd5\u4e2d\u5e38\u898b\u7684\u300c\u524d\u8996\u6027\u504f\u5dee (Look-Ahead Bias)\u300d\u548c\u6578\u64da\u8655\u7406\u6548\u7387\u4f4e\u4e0b\u7b49\u554f\u984c\u3002</p>"},{"location":"reference/pipeline/overview/#1-pipeline","title":"1. Pipeline \u7c21\u4ecb","text":"<p>Pipeline \u7684\u6838\u5fc3\u601d\u60f3\u662f\u5c07\u6578\u64da\u63d0\u53d6\u3001\u56e0\u5b50\u8a08\u7b97\u548c\u8cc7\u7522\u7be9\u9078\u7684\u908f\u8f2f\uff0c\u5f9e\u4e3b\u56de\u6e2c\u5faa\u74b0 (<code>handle_data()</code>) \u4e2d\u5206\u96e2\u51fa\u4f86\uff0c\u4e26\u5728 \u6bcf\u500b\u4ea4\u6613\u65e5\u958b\u59cb\u524d \u9032\u884c**\u4e00\u6b21\u6027** \u8a08\u7b97\u3002</p>"},{"location":"reference/pipeline/overview/#_1","title":"\u4e3b\u8981\u512a\u52e2\uff1a","text":"<ul> <li>\u907f\u514d\u524d\u8996\u6027\u504f\u5dee : \u78ba\u4fdd\u6240\u6709\u6578\u64da\u64cd\u4f5c\u90fd\u53ea\u4f7f\u7528\u5230\u56de\u6e2c\u7576\u5929\u4e4b\u524d\u53ef\u7528\u7684\u8cc7\u8a0a\u3002</li> <li>\u9ad8\u6548\u6027 : \u900f\u904e Zipline \u512a\u5316\u7684\u6578\u64da\u5f15\u64ce\u548c\u5411\u91cf\u5316\u64cd\u4f5c\uff0c\u80fd\u5920\u5728\u5927\u578b\u6578\u64da\u96c6\u4e0a\u9ad8\u6548\u57f7\u884c\u8907\u96dc\u7684\u8a08\u7b97\u3002</li> <li>\u53ef\u8b80\u6027\u8207\u6a21\u7d44\u5316 : \u7b56\u7565\u908f\u8f2f\u8207\u6578\u64da\u8655\u7406\u908f\u8f2f\u5206\u96e2\uff0c\u63d0\u9ad8\u4ee3\u78bc\u7684\u53ef\u8b80\u6027\u548c\u53ef\u7dad\u8b77\u6027\u3002</li> </ul>"},{"location":"reference/pipeline/overview/#2","title":"2. \u6838\u5fc3\u6982\u5ff5","text":"<p>\u5728\u4f7f\u7528 Pipeline \u6642\uff0c\u60a8\u6703\u63a5\u89f8\u5230\u4ee5\u4e0b\u5e7e\u500b\u6838\u5fc3\u6982\u5ff5\uff1a</p> <ul> <li><code>Pipeline</code> \u7269\u4ef6:<ul> <li>\u9019\u662f Pipeline API \u7684\u6838\u5fc3\uff0c\u4f5c\u70ba\u4e00\u500b\u5bb9\u5668\uff0c\u7528\u65bc\u5b9a\u7fa9\u8981\u8a08\u7b97\u54ea\u4e9b Factor\u3001\u7be9\u9078\u54ea\u4e9b\u8cc7\u7522\uff0c\u4ee5\u53ca\u8f38\u51fa\u54ea\u4e9b\u6578\u64da\u3002</li> <li>\u60a8\u53ef\u4ee5\u5728 <code>Pipeline</code> \u7269\u4ef6\u4e2d\u6307\u5b9a <code>columns</code> \u4f86\u5b9a\u7fa9\u8f38\u51fa\u6578\u64da\uff0c\u4ee5\u53ca <code>screen</code> \u4f86\u5b9a\u7fa9\u8cc7\u7522\u7be9\u9078\u689d\u4ef6\u3002</li> </ul> </li> <li><code>Factor</code> (\u56e0\u5b50):<ul> <li>\u7528\u65bc\u8a08\u7b97\u6a6b\u622a\u9762\u6578\u64da\uff08\u5373\u5c0d\u6240\u6709\u8cc7\u7522\u5728\u67d0\u500b\u6642\u9593\u9ede\u9032\u884c\u8a08\u7b97\uff09\u7684\u51fd\u6578\u3002\u5b83\u5011\u901a\u5e38\u6703\u8fd4\u56de\u6bcf\u500b\u8cc7\u7522\u5728\u6bcf\u500b\u6642\u9593\u9ede\u7684\u6578\u503c\u3002</li> <li>\u7bc4\u4f8b\uff1a<code>SimpleMovingAverage</code> (\u7c21\u55ae\u79fb\u52d5\u5e73\u5747), <code>AverageDollarVolume</code> (\u5e73\u5747\u6210\u4ea4\u91d1\u984d)\u3002</li> </ul> </li> <li><code>Filter</code> (\u904e\u6ffe\u5668):<ul> <li>\u7528\u65bc\u7be9\u9078\u8cc7\u7522\u7684\u5e03\u6797\u51fd\u6578\u3002\u5b83\u5011\u901a\u5e38\u6703\u8fd4\u56de\u6bcf\u500b\u8cc7\u7522\u5728\u6bcf\u500b\u6642\u9593\u9ede\u7684 <code>True</code> \u6216 <code>False</code>\uff0c\u8868\u793a\u8a72\u8cc7\u7522\u662f\u5426\u7b26\u5408\u689d\u4ef6\u3002</li> <li>\u7bc4\u4f8b\uff1a<code>top(N)</code> (\u5e02\u503c\u524dN\u5927), <code>StaticAssets</code> (\u975c\u614b\u8cc7\u7522\u5217\u8868)\u3002</li> </ul> </li> <li><code>Classifier</code> (\u5206\u985e\u5668):<ul> <li>\u7528\u65bc\u5c07\u8cc7\u7522\u5206\u7d44\u7684\u51fd\u6578\u3002\u5b83\u5011\u901a\u5e38\u8fd4\u56de\u6bcf\u500b\u8cc7\u7522\u5728\u6bcf\u500b\u6642\u9593\u9ede\u7684\u4e00\u500b\u985e\u5225\u6a19\u7c64\uff08\u4f8b\u5982\u884c\u696d\u4ee3\u78bc\uff09\u3002</li> </ul> </li> <li><code>DataSet</code> (\u6578\u64da\u96c6):<ul> <li>Pipeline \u6578\u64da\u7684\u4f86\u6e90\uff0c\u4f8b\u5982 <code>EquityPricing</code> (\u80a1\u7968\u50f9\u683c\u6578\u64da), <code>TQDataSet</code> (TEJ \u81ea\u5b9a\u7fa9\u6578\u64da\u96c6)\u3002</li> </ul> </li> </ul>"},{"location":"reference/pipeline/overview/#3-pipeline","title":"3. Pipeline \u5de5\u4f5c\u6d41\u7a0b","text":"<p>Pipeline \u7684\u4f7f\u7528\u901a\u5e38\u9075\u5faa\u4ee5\u4e0b\u4e09\u500b\u6b65\u9a5f\uff1a</p>"},{"location":"reference/pipeline/overview/#31-pipeline-make_pipeline","title":"3.1. \u5b9a\u7fa9 Pipeline (make_pipeline() \u51fd\u6578)","text":"<p>\u60a8\u6703\u5275\u5efa\u4e00\u500b\u51fd\u6578 (\u901a\u5e38\u547d\u540d\u70ba <code>make_pipeline()</code>)\uff0c\u7528\u65bc\u69cb\u5efa\u548c\u8fd4\u56de\u4e00\u500b <code>Pipeline</code> \u7269\u4ef6\u3002\u5728\u9019\u500b\u51fd\u6578\u5167\u90e8\uff0c\u60a8\u5b9a\u7fa9\u4e86 Pipeline \u7684\u6240\u6709\u8a08\u7b97\u908f\u8f2f\u3002</p> <pre><code>from zipline.pipeline import Pipeline\nfrom zipline.pipeline.factors import SimpleMovingAverage\nfrom zipline.pipeline.filters import AverageDollarVolume\nfrom zipline.pipeline.data import EquityPricing\n\ndef make_my_pipeline():\n    # \u5b9a\u7fa9\u4e00\u500b\u56e0\u5b50\uff1a20 \u65e5\u7c21\u55ae\u79fb\u52d5\u5e73\u5747\u7dda\n    sma_20 = SimpleMovingAverage(inputs=[EquityPricing.close], window_length=20)\n\n    # \u5b9a\u7fa9\u4e00\u500b\u7be9\u9078\u5668\uff1a\u7be9\u9078\u51fa\u904e\u53bb 20 \u5929\u5e73\u5747\u65e5\u6210\u4ea4\u91d1\u984d\u524d 50% \u7684\u80a1\u7968\n    high_dollar_volume = AverageDollarVolume(window_length=20).percentile_between(50, 100)\n\n    return Pipeline(\n        columns={\n            'SMA_20': sma_20,\n            'Close_Price': EquityPricing.close.latest # \u4e5f\u53ef\u4ee5\u7372\u53d6\u6700\u65b0\u6536\u76e4\u50f9\n        },\n        screen=high_dollar_volume # \u5c07\u7be9\u9078\u5668\u61c9\u7528\u65bc Pipeline\uff0c\u6c7a\u5b9a\u6bcf\u5929\u7684 Universe\n    )\n</code></pre>"},{"location":"reference/pipeline/overview/#32-pipeline-attach_pipeline","title":"3.2. \u9644\u639b Pipeline (attach_pipeline() \u51fd\u6578)","text":"<p>\u5728\u56de\u6e2c\u7684 <code>initialize()</code> \u51fd\u6578\u4e2d\uff0c\u60a8\u9700\u8981\u4f7f\u7528 <code>zipline.api.attach_pipeline()</code> \u5c07\u5b9a\u7fa9\u597d\u7684 Pipeline \u9644\u639b\u5230\u56de\u6e2c\u5f15\u64ce\u3002\u9019\u6a23\uff0cZipline \u5c31\u6703\u77e5\u9053\u5728\u6bcf\u500b\u4ea4\u6613\u65e5\u904b\u884c\u8a72 Pipeline\u3002</p> <pre><code>from zipline.api import attach_pipeline, set_benchmark, symbol\n\ndef initialize(context):\n    set_benchmark(symbol('IR0001')) # \u8a2d\u5b9a Benchmark\n    attach_pipeline(make_my_pipeline(), 'my_pipeline_name') # \u9644\u639b Pipeline \u4e26\u547d\u540d\n</code></pre>"},{"location":"reference/pipeline/overview/#33-pipeline-pipeline_output","title":"3.3. \u7372\u53d6 Pipeline \u8f38\u51fa (pipeline_output() \u51fd\u6578)","text":"<p>\u5728\u6bcf\u500b\u4ea4\u6613\u65e5\u9700\u8981 Pipeline \u8f38\u51fa\u7d50\u679c\u6642\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>zipline.api.pipeline_output()</code> \u51fd\u6578\uff0c\u50b3\u5165\u60a8\u5728 <code>attach_pipeline()</code> \u4e2d\u6307\u5b9a\u7684\u540d\u7a31\uff0c\u4f86\u7372\u53d6\u7576\u65e5 Pipeline \u7684\u8a08\u7b97\u7d50\u679c\u3002</p> <p>\u9019\u901a\u5e38\u5728 <code>before_trading_start()</code> \u51fd\u6578\u4e2d\u57f7\u884c\uff0c\u56e0\u70ba Pipeline \u7684\u8a08\u7b97\u6703\u5728\u5e02\u5834\u958b\u76e4\u524d\u5b8c\u6210\uff0c\u60a8\u53ef\u4ee5\u5229\u7528\u5176\u7d50\u679c\u4f86\u6c7a\u5b9a\u7576\u5929\u7684\u4ea4\u6613\u7b56\u7565\u3002</p> <pre><code>from zipline.api import pipeline_output\n\ndef before_trading_start(context, data):\n    # \u7372\u53d6\u540d\u70ba 'my_pipeline_name' \u7684 Pipeline \u5728\u524d\u4e00\u4ea4\u6613\u65e5\u8a08\u7b97\u7684\u7d50\u679c\n    context.pipeline_results = pipeline_output('my_pipeline_name')\n\n    # \u5f9e Pipeline \u8f38\u51fa\u4e2d\u7372\u53d6\u7576\u5929\u7684 Universe (\u7b26\u5408 screen \u689d\u4ef6\u7684\u80a1\u7968)\n    context.my_universe = context.pipeline_results.index.get_level_values(1).tolist()\n\n    # \u7bc4\u4f8b\uff1a\u5f9e\u7d50\u679c\u4e2d\u7372\u53d6 SMA_20 \u503c\n    # if not context.pipeline_results.empty:\n    #     for asset in context.my_universe:\n    #         sma_value = context.pipeline_results.loc[(data.current_dt.date(), asset), 'SMA_20']\n    #         print(f\"{asset.symbol} \u7684 SMA_20: {sma_value}\")\n</code></pre>"},{"location":"reference/pipeline/overview/#4","title":"4. \u5b8c\u6574\u7bc4\u4f8b","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u500b\u5b8c\u6574\u7684\u7bc4\u4f8b\uff0c\u6f14\u793a\u5982\u4f55\u5b9a\u7fa9\u3001\u9644\u639b Pipeline \u4e26\u7372\u53d6\u5176\u8f38\u51fa\u4ee5\u7be9\u9078\u8cc7\u7522\u3002</p> <pre><code>import pandas as pd\nfrom zipline import run_algorithm\nfrom zipline.api import (\n    attach_pipeline,\n    pipeline_output,\n    set_benchmark,\n    symbol,\n    order_target_percent\n)\nfrom zipline.pipeline import Pipeline\nfrom zipline.pipeline.factors import SimpleMovingAverage, AverageDollarVolume\nfrom zipline.pipeline.data import EquityPricing\nfrom zipline.pipeline.filters import StaticAssets\n\n# 1. \u5b9a\u7fa9 Pipeline\ndef make_my_pipeline():\n    # \u8a08\u7b97 20 \u65e5\u7c21\u55ae\u79fb\u52d5\u5e73\u5747\u7dda\u56e0\u5b50\n    sma_20 = SimpleMovingAverage(inputs=[EquityPricing.close], window_length=20)\n\n    # \u7be9\u9078\u51fa\u904e\u53bb 10 \u5929\u5e73\u5747\u65e5\u6210\u4ea4\u91d1\u984d\u524d 20 \u6a94\u80a1\u7968\u4f5c\u70ba Universe\n    high_volume_filter = AverageDollarVolume(window_length=10).top(20)\n\n    return Pipeline(\n        columns={\n            'SMA_20': sma_20,\n            'Close_Price': EquityPricing.close.latest # \u540c\u6642\u7372\u53d6\u6700\u65b0\u6536\u76e4\u50f9\n        },\n        screen=high_volume_filter # \u5c07\u7be9\u9078\u5668\u61c9\u7528\u65bc Pipeline\uff0c\u5b9a\u7fa9 Universe\n    )\n\n# 2. Zipline \u56de\u6e2c\u8a2d\u7f6e\ndef initialize(context):\n    set_benchmark(symbol('IR0001')) # \u8a2d\u5b9a Benchmark\n    attach_pipeline(make_my_pipeline(), 'my_strategy_pipeline') # \u9644\u639b Pipeline\n\ndef before_trading_start(context, data):\n    # \u7372\u53d6 Pipeline \u7684\u8f38\u51fa\n    pipeline_results = pipeline_output('my_strategy_pipeline')\n\n    # \u5f9e Pipeline \u8f38\u51fa\u4e2d\u7372\u53d6\u7576\u5929\u7684 Universe (\u7b26\u5408 screen \u689d\u4ef6\u7684\u80a1\u7968)\n    context.my_universe = pipeline_results.index.get_level_values(1).tolist()\n\n    # \u5c07 Pipeline \u7d50\u679c\u5132\u5b58\u5230 context\uff0c\u4f9b handle_data \u4f7f\u7528\n    context.pipeline_data = pipeline_results\n\ndef handle_data(context, data):\n    # \u5982\u679c\u4eca\u5929\u6c92\u6709\u7be9\u9078\u51fa\u7684\u80a1\u7968\uff0c\u5247\u4e0d\u505a\u4efb\u4f55\u64cd\u4f5c\n    if not context.my_universe:\n        return\n\n    # \u904d\u6b77\u7be9\u9078\u51fa\u7684\u80a1\u7968\n    for asset in context.my_universe:\n        # \u78ba\u4fdd\u80a1\u7968\u6578\u64da\u53ef\u7528\uff0c\u4e26\u4e14\u6709 SMA_20 \u6578\u64da\n        if data.can_trade(asset) and asset in context.pipeline_data.index.get_level_values(1):\n            sma_value = context.pipeline_data.loc[(data.current_dt.date(), asset), 'SMA_20']\n            current_price = data.current(asset, 'price')\n\n            # \u7c21\u55ae\u7b56\u7565\uff1a\u5982\u679c\u80a1\u50f9\u7a81\u7834 20 \u65e5\u5747\u7dda\uff0c\u5247\u8cb7\u5165\n            if current_price &gt; sma_value:\n                # \u8cb7\u5165\u7b49\u6b0a\u91cd\n                order_target_percent(asset, 1.0 / len(context.my_universe))\n            # \u5982\u679c\u80a1\u50f9\u8dcc\u7834 20 \u65e5\u5747\u7dda\uff0c\u4e14\u6301\u6709\u8a72\u80a1\u7968\uff0c\u5247\u6e05\u5009\n            elif current_price &lt; sma_value and asset in context.portfolio.positions:\n                order_target_percent(asset, 0.0)\n\ndef analyze(context, results):\n    print(\"\u56de\u6e2c\u5206\u6790\u5b8c\u6210\u3002\")\n\n# \u57f7\u884c\u56de\u6e2c\nresults = run_algorithm(\n    start=pd.Timestamp('2020-01-01', tz='UTC'),\n    end=pd.Timestamp('2021-01-01', tz='UTC'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    capital_base=1_000_000,\n    bundle='tquant',\n    before_trading_start=before_trading_start # \u78ba\u4fdd before_trading_start \u88ab\u547c\u53eb\n)\n</code></pre>"},{"location":"reference/pipeline/terms/","title":"Pipeline \u6838\u5fc3\u69cb\u5efa\u6a21\u584a\uff1aFactor, Filter, Classifier","text":"<p>Info</p> <p>\u672c\u9801\u8a73\u7d30\u4ecb\u7d39 Zipline Pipeline \u4e2d\u7684 <code>Factor</code>\u3001<code>Filter</code> \u548c <code>Classifier</code> \u4e09\u7a2e\u6838\u5fc3\u69cb\u5efa\u6a21\u584a\uff0c\u5305\u62ec\u5176\u5b9a\u7fa9\u3001\u7528\u9014\u3001\u8f38\u51fa\u53ca\u4f7f\u7528\u7bc4\u4f8b\uff0c\u5e6b\u52a9\u4f7f\u7528\u8005\u5efa\u7acb\u81ea\u52d5\u5316\u9078\u80a1\u908f\u8f2f\u3002</p> <p>Zipline \u7684 Pipeline API \u900f\u904e <code>Factor</code>\u3001<code>Filter</code> \u548c <code>Classifier</code> \u4e09\u7a2e\u6838\u5fc3\u69cb\u5efa\u6a21\u584a\uff0c\u5be6\u73fe\u4e86\u9748\u6d3b\u9ad8\u6548\u7684\u6578\u64da\u8655\u7406\u548c\u8cc7\u7522\u7be9\u9078\u3002\u7406\u89e3\u9019\u4e9b\u69cb\u5efa\u6a21\u584a\u7684\u7528\u9014\u548c\u76f8\u4e92\u95dc\u4fc2\uff0c\u662f\u69cb\u5efa\u5f37\u5927 Pipeline \u7684\u57fa\u790e\u3002</p>"},{"location":"reference/pipeline/terms/#1","title":"1. \u6982\u5ff5\u7c21\u4ecb","text":"<ul> <li><code>Factor</code> (\u56e0\u5b50):<ul> <li>\u7528\u9014: \u8a08\u7b97\u6a6b\u622a\u9762\uff08cross-sectional\uff09\u6578\u64da\uff0c\u901a\u5e38\u662f\u6578\u503c\u578b\u8f38\u51fa\u3002\u5b83\u5c0d\u6bcf\u500b\u8cc7\u7522\u5728\u6bcf\u500b\u6642\u9593\u9ede\u751f\u6210\u4e00\u500b\u6578\u503c\uff0c\u4f8b\u5982\u79fb\u52d5\u5e73\u5747\u3001\u76f8\u5c0d\u5f37\u5f31\u6307\u6578\u3001\u5e02\u503c\u7b49\u3002</li> <li>\u8f38\u51fa: <code>pd.DataFrame</code>\uff0c\u7d22\u5f15\u70ba <code>(\u65e5\u671f, \u8cc7\u7522)</code> \u7684 MultiIndex\uff0c\u503c\u70ba\u8a08\u7b97\u51fa\u7684\u6578\u503c\u3002</li> </ul> </li> <li><code>Filter</code> (\u904e\u6ffe\u5668):<ul> <li>\u7528\u9014: \u6839\u64da\u5e03\u6797\u689d\u4ef6\u7be9\u9078\u8cc7\u7522\u3002\u5b83\u5c0d\u6bcf\u500b\u8cc7\u7522\u5728\u6bcf\u500b\u6642\u9593\u9ede\u751f\u6210\u4e00\u500b\u5e03\u6797\u503c (<code>True</code>/<code>False</code>)\uff0c\u7528\u65bc\u6c7a\u5b9a\u8a72\u8cc7\u7522\u662f\u5426\u61c9\u5305\u542b\u5728\u56de\u6e2c\u7684 Universe \u6216 Pipeline \u7684\u8f38\u51fa\u4e2d\u3002</li> <li>\u8f38\u51fa: <code>pd.DataFrame</code>\uff0c\u7d22\u5f15\u70ba <code>(\u65e5\u671f, \u8cc7\u7522)</code> \u7684 MultiIndex\uff0c\u503c\u70ba\u5e03\u6797\u503c\u3002</li> </ul> </li> <li><code>Classifier</code> (\u5206\u985e\u5668):<ul> <li>\u7528\u9014: \u5c07\u8cc7\u7522\u5206\u7d44\u3002\u5b83\u5c0d\u6bcf\u500b\u8cc7\u7522\u5728\u6bcf\u500b\u6642\u9593\u9ede\u751f\u6210\u4e00\u500b\u96e2\u6563\u7684\u985e\u5225\u6a19\u7c64\uff0c\u4f8b\u5982\u884c\u696d\u4ee3\u78bc\u3001\u5e02\u503c\u5206\u4f4d\u6578\u7b49\u3002</li> <li>\u8f38\u51fa: <code>pd.DataFrame</code>\uff0c\u7d22\u5f15\u70ba <code>(\u65e5\u671f, \u8cc7\u7522)</code> \u7684 MultiIndex\uff0c\u503c\u70ba\u985e\u5225\u6a19\u7c64\u3002</li> </ul> </li> </ul>"},{"location":"reference/pipeline/terms/#2-factor","title":"2. Factor (\u56e0\u5b50)","text":"<p><code>Factor</code> \u662f Pipeline \u4e2d\u6700\u57fa\u790e\u7684\u6578\u503c\u8a08\u7b97\u55ae\u5143\u3002\u5b83\u901a\u5e38\u63a5\u53d7\u4e00\u500b\u6216\u591a\u500b <code>DataSet</code> \u4e2d\u7684\u6b04\u4f4d\u4f5c\u70ba\u8f38\u5165\uff0c\u4e26\u5728\u6307\u5b9a\u7684 <code>window_length</code> \u4e0a\u57f7\u884c\u8a08\u7b97\u3002</p> <ul> <li>\u7528\u9014: \u5f9e\u539f\u59cb\u6578\u64da\u4e2d\u63d0\u53d6\u6709\u610f\u7fa9\u7684\u6578\u503c\u8cc7\u8a0a\u3002</li> <li>\u5e38\u898b\u53c3\u6578:<ul> <li><code>inputs</code>: (list of <code>BoundColumn</code>) \u56e0\u5b50\u8a08\u7b97\u6240\u9700\u7684\u8f38\u5165\u6578\u64da\u6b04\u4f4d\uff0c\u4f8b\u5982 <code>[EquityPricing.close]</code>\u3002</li> <li><code>window_length</code>: (int) \u56e0\u5b50\u8a08\u7b97\u6240\u4f7f\u7528\u7684\u6b77\u53f2\u6578\u64da\u7a97\u53e3\u9577\u5ea6\uff08\u4f8b\u5982\uff0c20 \u65e5\u79fb\u52d5\u5e73\u5747\uff09\u3002</li> </ul> </li> </ul>"},{"location":"reference/pipeline/terms/#simplemovingaverage","title":"\u7bc4\u4f8b\uff1aSimpleMovingAverage (\u7c21\u55ae\u79fb\u52d5\u5e73\u5747)","text":"<pre><code>from zipline.pipeline.factors import SimpleMovingAverage\nfrom zipline.pipeline.data import EquityPricing\n\n# \u8a08\u7b97 20 \u65e5\u6536\u76e4\u50f9\u7684\u7c21\u55ae\u79fb\u52d5\u5e73\u5747\nsma_20 = SimpleMovingAverage(inputs=[EquityPricing.close], window_length=20)\n\n# \u8a08\u7b97 10 \u65e5\u6210\u4ea4\u91d1\u984d\u7684\u7c21\u55ae\u79fb\u52d5\u5e73\u5747\n# from zipline.pipeline.factors import AverageDollarVolume\n# sma_dollar_volume_10 = SimpleMovingAverage(inputs=[AverageDollarVolume(window_length=1)], window_length=10)\n</code></pre>"},{"location":"reference/pipeline/terms/#3-filter","title":"3. Filter (\u904e\u6ffe\u5668)","text":"<p><code>Filter</code> \u7528\u65bc\u6839\u64da\u689d\u4ef6\u9078\u64c7\u8cc7\u7522\u3002\u5b83\u5011\u901a\u5e38\u662f <code>Factor</code> \u7269\u4ef6\u900f\u904e\u6bd4\u8f03\u904b\u7b97 (\u4f8b\u5982 <code>factor &gt; value</code>) \u6216\u7279\u5b9a\u65b9\u6cd5 (\u4f8b\u5982 <code>top(N)</code>) \u8f49\u63db\u800c\u4f86\u3002</p> <ul> <li>\u7528\u9014: \u5b9a\u7fa9\u6bcf\u65e5\u56de\u6e2c\u6216 Pipeline \u8f38\u51fa\u7684\u8cc7\u7522 Universe\u3002</li> <li>\u5e38\u898b\u7528\u6cd5:<ul> <li>\u57fa\u65bc\u56e0\u5b50\u7684\u6392\u540d\u7be9\u9078: <code>Factor.top(N)</code> (\u524d N \u540d), <code>Factor.bottom(N)</code> (\u5f8c N \u540d)\u3002</li> <li>\u57fa\u65bc\u56e0\u5b50\u5206\u4f4d\u6578\u7be9\u9078: <code>Factor.percentile_between(min_percentile, max_percentile)</code> (\u6307\u5b9a\u5206\u4f4d\u6578\u5340\u9593)\u3002</li> <li>\u5e03\u6797\u904b\u7b97: <code>factor &gt; value</code>, <code>factor == value</code>\u3002</li> <li>\u7d44\u5408\u904e\u6ffe\u5668: \u4f7f\u7528 <code>&amp;</code> (AND), <code>|</code> (OR), <code>~</code> (NOT) \u904b\u7b97\u7b26\u7d44\u5408\u591a\u500b <code>Filter</code>\u3002</li> </ul> </li> </ul>"},{"location":"reference/pipeline/terms/#50","title":"\u7bc4\u4f8b\uff1a\u7be9\u9078\u65e5\u6210\u4ea4\u91d1\u984d\u524d 50 \u6a94\u80a1\u7968","text":"<pre><code>from zipline.pipeline.factors import AverageDollarVolume\n\n# \u8a08\u7b97 20 \u65e5\u5e73\u5747\u65e5\u6210\u4ea4\u91d1\u984d\u56e0\u5b50\ndollar_volume = AverageDollarVolume(window_length=20)\n\n# \u5275\u5efa\u4e00\u500b Filter\uff1a\u7be9\u9078\u51fa\u5e73\u5747\u65e5\u6210\u4ea4\u91d1\u984d\u524d 50 \u540d\u7684\u80a1\u7968\ntop_50_dollar_volume = dollar_volume.top(50)\n\n# \u5275\u5efa\u4e00\u500b Filter\uff1a\u7be9\u9078\u51fa\u5e73\u5747\u65e5\u6210\u4ea4\u91d1\u984d\u5728 50% \u5230 80% \u5206\u4f4d\u6578\u4e4b\u9593\u7684\u80a1\u7968\nmid_range_dollar_volume = dollar_volume.percentile_between(50, 80)\n</code></pre>"},{"location":"reference/pipeline/terms/#4-classifier","title":"4. Classifier (\u5206\u985e\u5668)","text":"<p><code>Classifier</code> \u7528\u65bc\u5c07\u8cc7\u7522\u6b78\u985e\u5230\u4e0d\u540c\u7684\u7d44\u5225\u4e2d\uff0c\u4f8b\u5982\u884c\u696d\u3001\u5e02\u5834\u985e\u578b\u6216\u81ea\u5b9a\u7fa9\u7684\u7d44\u5225\u3002\u9019\u5c0d\u65bc\u9032\u884c\u884c\u696d\u8f2a\u52d5\u3001\u5206\u7d44\u5c0d\u6c96\u6216\u5206\u5c64\u56de\u6e2c\u7b49\u7b56\u7565\u975e\u5e38\u6709\u7528\u3002</p> <ul> <li>\u7528\u9014: \u5c0d\u8cc7\u7522\u9032\u884c\u5206\u7d44\u6216\u6a19\u7c64\u5316\u3002</li> <li>\u5e38\u898b\u7528\u6cd5: \u7372\u53d6\u8cc7\u7522\u7684\u884c\u696d\u6216\u677f\u584a\u4fe1\u606f\u3002</li> </ul>"},{"location":"reference/pipeline/terms/#_1","title":"\u7bc4\u4f8b\uff1a\u7372\u53d6\u8cc7\u7522\u7684\u4e3b\u7522\u696d\u5225","text":"<pre><code>from zipline.pipeline.data import tejquant # \u5047\u8a2d tejquant \u6578\u64da\u96c6\u5df2\u5c0e\u5165\nfrom zipline.pipeline.classifiers import Industry\n\n# \u7372\u53d6\u8cc7\u7522\u7684\u4e3b\u7522\u696d\u5225 (\u4e2d\u6587)\nmain_industry = tejquant.TQDataSet.Industry.latest\n# \u6216\u8005\n# main_industry = Industry() # Zipline \u5167\u5efa\u7684 Industry Classifier\n</code></pre>"},{"location":"reference/pipeline/terms/#5","title":"5. \u5b8c\u6574\u7bc4\u4f8b","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u500b\u5b8c\u6574\u7684 Pipeline \u7bc4\u4f8b\uff0c\u6f14\u793a\u5982\u4f55\u5728\u4e00\u500b Pipeline \u4e2d\u540c\u6642\u4f7f\u7528 <code>Factor</code>\u3001<code>Filter</code> \u548c <code>Classifier</code>\uff0c\u4e26\u5728\u56de\u6e2c\u4e2d\u7372\u53d6\u5176\u8f38\u51fa\u3002</p> <pre><code>import pandas as pd\nfrom zipline import run_algorithm\nfrom zipline.api import (\n    attach_pipeline,\n    pipeline_output,\n    set_benchmark,\n    symbol,\n    order_target_percent\n)\nfrom zipline.pipeline import Pipeline\nfrom zipline.pipeline.factors import SimpleMovingAverage, AverageDollarVolume\nfrom zipline.pipeline.data import EquityPricing, tejquant # \u5c0e\u5165 tejquant\nfrom zipline.pipeline.filters import StaticAssets # \u5c0e\u5165 StaticAssets\nfrom zipline.pipeline.classifiers import Industry # \u5c0e\u5165 Industry Classifier\n\n# 1. \u5b9a\u7fa9 Pipeline\ndef make_my_pipeline():\n    # Factor: \u8a08\u7b97 20 \u65e5\u7c21\u55ae\u79fb\u52d5\u5e73\u5747\u7dda\n    sma_20 = SimpleMovingAverage(inputs=[EquityPricing.close], window_length=20)\n\n    # Factor: \u8a08\u7b97 10 \u65e5\u5e73\u5747\u6210\u4ea4\u91d1\u984d\n    dollar_volume = AverageDollarVolume(window_length=10)\n\n    # Filter: \u7be9\u9078\u51fa\u5e73\u5747\u6210\u4ea4\u91d1\u984d\u524d 50 \u6a94\u80a1\u7968\n    high_volume_filter = dollar_volume.top(50)\n\n    # Classifier: \u7372\u53d6\u4e3b\u7522\u696d\u5225\n    # Zipline \u5167\u5efa Industry \u6216 tejquant.TQDataSet.Industry\n    sector_classifier = tejquant.TQDataSet.Industry.latest\n\n    return Pipeline(\n        columns={\n            'SMA_20': sma_20,\n            'Dollar_Volume': dollar_volume,\n            'Sector': sector_classifier # \u5c07 Classifier \u52a0\u5165\u8f38\u51fa\n        },\n        screen=high_volume_filter # \u5c07 Filter \u61c9\u7528\u65bc Pipeline\uff0c\u5b9a\u7fa9 Universe\n    )\n\n# 2. Zipline \u56de\u6e2c\u8a2d\u7f6e\ndef initialize(context):\n    set_benchmark(symbol('IR0001')) # \u8a2d\u5b9a Benchmark\n    attach_pipeline(make_my_pipeline(), 'my_strategy_pipeline') # \u9644\u639b Pipeline\n\ndef before_trading_start(context, data):\n    pipeline_results = pipeline_output('my_strategy_pipeline')\n    context.my_universe = pipeline_results.index.get_level_values(1).tolist()\n    context.pipeline_data = pipeline_results\n\ndef handle_data(context, data):\n    if not context.my_universe:\n        return\n\n    for asset in context.my_universe:\n        if data.can_trade(asset) and asset in context.pipeline_data.index.get_level_values(1):\n            sma_value = context.pipeline_data.loc[(data.current_dt.date(), asset), 'SMA_20']\n            current_price = data.current(asset, 'price')\n            sector = context.pipeline_data.loc[(data.current_dt.date(), asset), 'Sector'] # \u7372\u53d6\u7522\u696d\u5225\n\n            # \u7c21\u55ae\u7b56\u7565\uff1a\u5982\u679c\u80a1\u50f9\u7a81\u7834 20 \u65e5\u5747\u7dda\uff0c\u4e14\u5c6c\u65bc\u7279\u5b9a\u7522\u696d\uff0c\u5247\u8cb7\u5165\n            if current_price &gt; sma_value and sector == '\u534a\u5c0e\u9ad4\u696d': # \u5047\u8a2d\u534a\u5c0e\u9ad4\u696d\u70ba\u7bc4\u4f8b\n                order_target_percent(asset, 1.0 / len(context.my_universe))\n            elif current_price &lt; sma_value and asset in context.portfolio.positions:\n                order_target_percent(asset, 0.0)\n\ndef analyze(context, results):\n    print(\"\u56de\u6e2c\u5206\u6790\u5b8c\u6210\u3002\")\n\n# \u57f7\u884c\u56de\u6e2c\nresults = run_algorithm(\n    start=pd.Timestamp('2020-01-01', tz='UTC'),\n    end=pd.Timestamp('2021-01-01', tz='UTC'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    capital_base=1_000_000,\n    bundle='tquant',\n    before_trading_start=before_trading_start # \u78ba\u4fdd before_trading_start \u88ab\u547c\u53eb\n)\n</code></pre>"},{"location":"reference/pipeline/datasets/built-in/","title":"\u5167\u5efa\u8cc7\u6599\u96c6 (Built-in DataSets)","text":"<p>Info</p> <p>\u672c\u9801\u6574\u7406 TQuant Lab \u4e2d Pipeline \u6700\u5e38\u7528\u7684\u5167\u5efa\u8cc7\u6599\u96c6\u8207\u64cd\u4f5c\u8a9e\u6cd5\u3002</p> <p>\u5728 Pipeline \u4e2d\uff0c\u6211\u5011\u900f\u904e \u8cc7\u6599\u96c6 (DataSet) \u8b80\u53d6\u6b77\u53f2\u6578\u64da\u3002\u6240\u6709\u7684\u8cc7\u6599\u6b04\u4f4d\u90fd\u652f\u63f4\u4ee5\u4e0b\u5169\u7a2e\u53d6\u503c\u65b9\u5f0f\uff1a</p> <ul> <li><code>.latest</code>\uff1a\u53d6\u5f97\u6700\u65b0\u4e00\u7b46\u6578\u64da\uff08\u6578\u503c\uff09\u3002</li> <li><code>.slice(n)</code>\uff1a\u53d6\u5f97\u904e\u53bb <code>n</code> \u5929\u7684\u6578\u64da\uff08\u9663\u5217\uff09\u3002</li> </ul>"},{"location":"reference/pipeline/datasets/built-in/#1-twequitypricing","title":"1. \u53f0\u7063\u80a1\u50f9\u50f9\u91cf\u8cc7\u6599 (TWEquityPricing)","text":"<p>\u9019\u662f\u6700\u57fa\u790e\u7684\u50f9\u91cf\u8cc7\u6599\u96c6\u3002</p> <pre><code>from zipline.pipeline.data import TWEquityPricing\n</code></pre> \u6b04\u4f4d\u5c6c\u6027 \u8aaa\u660e <code>TWEquityPricing.open</code> \u958b\u76e4\u50f9 <code>TWEquityPricing.high</code> \u6700\u9ad8\u50f9 <code>TWEquityPricing.low</code> \u6700\u4f4e\u50f9 <code>TWEquityPricing.close</code> \u6536\u76e4\u50f9 <code>TWEquityPricing.volume</code> \u6210\u4ea4\u91cf <p>\u4f7f\u7528\u7bc4\u4f8b\uff1a</p> <pre><code># \u53d6\u5f97\u6700\u65b0\u6536\u76e4\u50f9\nclose_price = TWEquityPricing.close.latest\n</code></pre>"},{"location":"reference/pipeline/datasets/built-in/#2-tej-tqfundamentals","title":"2. TEJ \u57fa\u672c\u9762\u8cc7\u6599 (TQFundamentals)","text":"<p>\u6574\u5408 TEJ \u8cc7\u6599\u5eab\u7684\u8ca1\u52d9\u8207\u975e\u8ca1\u52d9\u6578\u64da\u3002\u8cc7\u6599\u96c6\u5206\u70ba\u4ee5\u4e0b\u5169\u985e\uff1a</p> <pre><code>from zipline.pipeline.data.TQFundamentals import TQDataSet, TQAltDataSet\n</code></pre>"},{"location":"reference/pipeline/datasets/built-in/#21-tqdataset","title":"2.1 \u8ca1\u52d9\u6578\u64da (TQDataSet)","text":"<p>\u5305\u542b\u71df\u6536\u3001\u76c8\u9918\u7b49\u8ca1\u52d9\u6307\u6a19\u3002</p> <ul> <li>\u67e5\u8a62\u6b04\u4f4d\uff1a\u53ef\u4f7f\u7528 <code>TQDataSet._column_names</code> \u67e5\u770b\u6240\u6709\u53ef\u7528\u6b04\u4f4d\u3002</li> <li>\u5e38\u7528\u6b04\u4f4d\uff1a\u5982 <code>Gross_Margin_Growth_Rate_A</code> (\u6bdb\u5229\u7387\u6210\u9577\u7387), <code>Return_On_Equity_A</code> (ROE) \u7b49\u3002</li> </ul>"},{"location":"reference/pipeline/datasets/built-in/#22-tqaltdataset","title":"2.2 \u975e\u8ca1\u52d9\u6578\u64da (TQAltDataSet)","text":"<p>\u5305\u542b\u7522\u696d\u5206\u985e\u3001\u5e02\u503c\u7b49\u8cc7\u8a0a\u3002</p> <ul> <li>\u67e5\u8a62\u6b04\u4f4d\uff1a\u53ef\u4f7f\u7528 <code>TQAltDataSet._column_names</code> \u67e5\u770b\u6240\u6709\u53ef\u7528\u6b04\u4f4d\u3002</li> <li>\u5e38\u7528\u6b04\u4f4d\uff1a<ul> <li><code>TQAltDataSet.Industry</code>\uff1a\u7522\u696d\u5225</li> <li><code>TQAltDataSet.Sub_Industry</code>\uff1a\u5b50\u7522\u696d\u5225</li> </ul> </li> </ul> <p>\u4f7f\u7528\u7bc4\u4f8b\uff1a</p> <pre><code># \u53d6\u5f97\u6700\u65b0\u7522\u696d\u5225\nindustry = TQAltDataSet.Industry.latest\n</code></pre>"},{"location":"reference/pipeline/datasets/custom-dataset/","title":"\u81ea\u8a02\u8cc7\u6599\u96c6 (Custom DataSets)","text":"<p>Info</p> <p>\u672c\u9801\u4ecb\u7d39\u5982\u4f55\u5728 TQuant Lab Pipeline \u4e2d\u5275\u5efa\u548c\u4f7f\u7528\u81ea\u8a02\u8cc7\u6599\u96c6 (Custom DataSets)\u3002\u9019\u662f\u4e00\u500b\u9032\u968e\u529f\u80fd\uff0c\u5141\u8a31\u60a8\u5c07\u5916\u90e8\u6578\u64da\u6e90\uff08\u4f8b\u5982\u60a8\u81ea\u5df1\u7684 CSV \u6a94\u6848\u3001\u8cc7\u6599\u5eab\u67e5\u8a62\u7d50\u679c\u7b49\uff09\u6574\u5408\u5230 Pipeline \u4e2d\uff0c\u6975\u5927\u5730\u64f4\u5c55\u4e86 Pipeline \u7684\u6578\u64da\u4f86\u6e90\u548c\u61c9\u7528\u7bc4\u570d\u3002</p> <p>\u96d6\u7136 TQuant Lab \u63d0\u4f9b\u4e86 <code>TWEquityPricing</code> \u548c <code>TQDataSet</code> \u7b49\u5f37\u5927\u7684\u5167\u5efa\u8cc7\u6599\u96c6\uff0c\u4f46\u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u81ea\u5df1\u7368\u6709\u7684\u6578\u64da\u4f86\u9032\u884c\u7b56\u7565\u7814\u7a76\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u60a8\u900f\u904e\u722c\u87f2\u7372\u53d6\u7684\u7db2\u8def\u8f3f\u60c5\u6578\u64da\u3002</li> <li>\u60a8\u8cfc\u8cb7\u7684\u7b2c\u4e09\u65b9\u53e6\u985e\u6578\u64da\u3002</li> <li>\u60a8\u81ea\u5df1\u8a08\u7b97\u7684\u5c08\u6709\u56e0\u5b50\u6578\u64da\u3002</li> </ul> <p><code>Custom DataSets</code> \u529f\u80fd\u5141\u8a31\u60a8\u5c07\u9019\u4e9b\u5916\u90e8\u6578\u64da\u6253\u5305\u6210 Pipeline \u53ef\u8b58\u5225\u7684\u683c\u5f0f\uff0c\u4e26\u50cf\u4f7f\u7528\u5167\u5efa\u8cc7\u6599\u96c6\u4e00\u6a23\u5728 Pipeline \u4e2d\u7121\u7e2b\u4f7f\u7528\u3002</p>"},{"location":"reference/pipeline/datasets/custom-dataset/#1-custom-datasets","title":"1. Custom DataSets \u6838\u5fc3\u6982\u5ff5","text":"<p>\u5275\u5efa\u4e00\u500b\u81ea\u8a02\u8cc7\u6599\u96c6\u7684\u904e\u7a0b\uff0c\u672c\u8cea\u4e0a\u662f\u5c07\u60a8\u7684\u5916\u90e8\u6578\u64da\u8f49\u63db\u70ba Zipline \u7684 <code>bcolz</code> \u683c\u5f0f\uff0c\u4e26\u63d0\u4f9b\u4e00\u500b\u63cf\u8ff0\u6587\u4ef6 (<code>extension.py</code>) \u8b93 Zipline \u80fd\u5920\u8b58\u5225\u548c\u8f09\u5165\u5b83\u3002</p> <p>\u4e3b\u8981\u6b65\u9a5f\uff1a</p> <ol> <li>\u6e96\u5099\u6578\u64da\uff1a\u5c07\u60a8\u7684\u6578\u64da\u6574\u7406\u6210\u7279\u5b9a\u683c\u5f0f\u7684 CSV \u6a94\u6848\u3002</li> <li>\u7de8\u5beb <code>extension.py</code>\uff1a\u5275\u5efa\u4e00\u500b Python \u8173\u672c\uff0c\u5b9a\u7fa9\u60a8\u7684 <code>Custom DataSet</code> \u985e\u5225\u3001\u6b04\u4f4d\uff0c\u4ee5\u53ca\u6578\u64da\u7684\u8f09\u5165\u908f\u8f2f\u3002</li> <li>\u57f7\u884c <code>zipline ingest</code>\uff1a\u4f7f\u7528 <code>zipline ingest</code> \u6307\u4ee4\uff0cZipline \u6703\u57f7\u884c\u60a8\u7684 <code>extension.py</code>\uff0c\u8b80\u53d6 CSV \u6a94\u6848\uff0c\u4e26\u5c07\u5176\u8f49\u63db\u70ba <code>bcolz</code> \u683c\u5f0f\u5132\u5b58\u3002</li> </ol>"},{"location":"reference/pipeline/datasets/custom-dataset/#2","title":"2. \u5be6\u4f5c\u6b65\u9a5f","text":"<p>\u4ee5\u4e0b\u6211\u5011\u5c07\u900f\u904e\u4e00\u500b\u5b8c\u6574\u7684\u7bc4\u4f8b\uff0c\u5c55\u793a\u5982\u4f55\u5c07\u4e00\u500b\u5305\u542b\u300c\u6bcf\u65e5\u5916\u8cc7\u6301\u80a1\u6bd4\u4f8b\u300d\u7684 CSV \u6a94\u6848\uff0c\u8f49\u63db\u70ba\u4e00\u500b\u53ef\u4ee5\u5728 Pipeline \u4e2d\u4f7f\u7528\u7684\u81ea\u8a02\u8cc7\u6599\u96c6\u3002</p>"},{"location":"reference/pipeline/datasets/custom-dataset/#1-csv","title":"\u6b65\u9a5f 1\uff1a\u6e96\u5099\u6578\u64da (CSV \u6a94\u6848)","text":"<p>\u9996\u5148\uff0c\u60a8\u9700\u8981\u5c07\u60a8\u7684\u6578\u64da\u6574\u7406\u6210\u4e00\u500b\u6216\u591a\u500b CSV \u6a94\u6848\u3002\u6bcf\u500b\u6a94\u6848\u61c9\u5305\u542b\u4ee5\u4e0b\u6b04\u4f4d\uff1a</p> <ul> <li><code>date</code>\uff1a\u65e5\u671f\uff0c\u683c\u5f0f\u70ba <code>YYYY-MM-DD</code>\u3002</li> <li><code>sid</code>\uff1a\u80a1\u7968\u4ee3\u78bc (Zipline \u5167\u90e8 ID)\u3002</li> <li>\u60a8\u7684\u81ea\u8a02\u6578\u64da\u6b04\u4f4d (\u4f8b\u5982 <code>foreign_ownership_ratio</code>)\u3002</li> </ul> <p>\u7bc4\u4f8b <code>my_custom_data.csv</code>\uff1a</p> <pre><code>date,sid,foreign_ownership_ratio\n2022-01-03,0,45.6\n2022-01-03,1,23.4\n2022-01-04,0,45.7\n2022-01-04,1,23.5\n...\n</code></pre> <p>Note</p> <p><code>sid</code> \u662f Zipline \u5167\u90e8\u7684\u6574\u6578 ID\uff0c\u800c\u4e0d\u662f\u80a1\u7968\u4ee3\u78bc\u5b57\u4e32 (\u5982 '2330')\u3002\u60a8\u9700\u8981\u81ea\u884c\u5c07\u80a1\u7968\u4ee3\u78bc\u6620\u5c04\u5230 <code>sid</code>\u3002</p>"},{"location":"reference/pipeline/datasets/custom-dataset/#2-extensionpy","title":"\u6b65\u9a5f 2\uff1a\u7de8\u5beb extension.py","text":"<p>\u63a5\u4e0b\u4f86\uff0c\u5728\u60a8\u7684 Zipline \u8a2d\u5b9a\u76ee\u9304\u4e0b (\u901a\u5e38\u662f <code>~/.zipline/</code>) \u5275\u5efa\u4e00\u500b\u540d\u70ba <code>extension.py</code> \u7684\u6a94\u6848\u3002\u9019\u500b\u6a94\u6848\u662f Zipline \u7528\u65bc\u767c\u73fe\u548c\u8f09\u5165\u81ea\u8a02\u8cc7\u6599\u7684\u5165\u53e3\u3002</p> <p>\u7bc4\u4f8b <code>~/.zipline/extension.py</code>\uff1a</p> <pre><code>from zipline.pipeline.data import DataSet\nfrom zipline.pipeline.loaders import CSVLoader\nfrom zipline.pipeline.loaders.frame import DataFrameLoader\nfrom zipline.pipeline.domain import US_EQUITIES # \u6216\u5176\u4ed6\u9069\u7528\u7684 Domain\nimport pandas as pd\n\n# 1. \u5b9a\u7fa9 Custom DataSet \u985e\u5225\nclass MyCustomDataSet(DataSet):\n    # \u5b9a\u7fa9\u60a8\u7684\u6578\u64da\u6b04\u4f4d\uff0c\u4e26\u6307\u5b9a\u5176\u6578\u64da\u985e\u578b\n    foreign_ownership_ratio = Column(dtype=float)\n\n    # \u6307\u5b9a\u6b64 DataSet \u9069\u7528\u7684 Domain\n    domain = US_EQUITIES # \u6839\u64da\u60a8\u7684\u9700\u6c42\u9078\u64c7\n\n# 2. \u5275\u5efa CSVLoader \u5be6\u4f8b\nmy_csv_loader = CSVLoader(\n    # \u6307\u5b9a CSV \u6a94\u6848\u7684\u8def\u5f91\n    csvdir='/path/to/your/csv/files',\n    # \u5c07 CSV \u6a94\u6848\u8207\u60a8\u7684 DataSet \u985e\u5225\u548c\u6b04\u4f4d\u9032\u884c\u6620\u5c04\n    data_query_path={\n        MyCustomDataSet.foreign_ownership_ratio: 'my_custom_data.csv'\n    }\n)\n\n# 3. \u5275\u5efa DataFrameLoader\nMyCustomDataSetLoader = DataFrameLoader(\n    column=MyCustomDataSet.foreign_ownership_ratio,\n    # \u9019\u88e1\u7684 'my_custom_data.csv' \u61c9\u8207 my_csv_loader \u4e2d\u7684\u9375\u4e00\u81f4\n    baseline=my_csv_loader.load_adjusted_array(['my_custom_data.csv'])\n)\n\n# 4. \u8a3b\u518a\u60a8\u7684 DataSet \u548c Loader\nregister_dataset(MyCustomDataSet, MyCustomDataSetLoader)\n</code></pre> <p>\u7a0b\u5f0f\u78bc\u89e3\u91cb\uff1a</p> <ol> <li><code>MyCustomDataSet(DataSet)</code>\uff1a\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u540d\u70ba <code>MyCustomDataSet</code> \u7684\u985e\u5225\uff0c\u4e26\u7e7c\u627f\u81ea <code>DataSet</code>\u3002\u5728\u5176\u4e2d\uff0c\u6211\u5011\u5b9a\u7fa9\u4e86\u4e00\u500b\u540d\u70ba <code>foreign_ownership_ratio</code> \u7684 <code>Column</code>\uff0c\u4e26\u6307\u5b9a\u5176\u6578\u64da\u985e\u578b\u70ba <code>float</code>\u3002</li> <li><code>CSVLoader</code>\uff1a\u9019\u662f\u4e00\u500b\u8f14\u52a9\u985e\u5225\uff0c\u7528\u65bc\u5f9e CSV \u6a94\u6848\u4e2d\u8b80\u53d6\u6578\u64da\u3002\u60a8\u9700\u8981\u63d0\u4f9b CSV \u6a94\u6848\u6240\u5728\u7684\u76ee\u9304 (<code>csvdir</code>)\uff0c\u4e26\u5efa\u7acb\u4e00\u500b\u5b57\u5178\uff0c\u5c07\u60a8\u7684 <code>DataSet</code> \u6b04\u4f4d\u6620\u5c04\u5230\u5c0d\u61c9\u7684 CSV \u6a94\u6848\u3002</li> <li><code>DataFrameLoader</code>\uff1a\u9019\u662f\u5be6\u969b\u7684\u6578\u64da\u8f09\u5165\u5668\u3002\u5b83\u6703\u4f7f\u7528 <code>CSVLoader</code> \u8f09\u5165\u7684\u6578\u64da\uff0c\u4e26\u5c07\u5176\u8207\u60a8\u7684 <code>DataSet</code> \u6b04\u4f4d\u9032\u884c\u7d81\u5b9a\u3002</li> <li><code>register_dataset</code>\uff1a\u6700\u5f8c\uff0c\u60a8\u9700\u8981\u8abf\u7528 <code>register_dataset</code> \u51fd\u6578\uff0c\u5c07\u60a8\u7684 <code>DataSet</code> \u985e\u5225\u548c <code>DataFrameLoader</code> \u5be6\u4f8b\u8a3b\u518a\u5230 Zipline \u4e2d\u3002</li> </ol>"},{"location":"reference/pipeline/datasets/custom-dataset/#3-zipline-ingest","title":"\u6b65\u9a5f 3\uff1a\u57f7\u884c zipline ingest","text":"<p>\u5b8c\u6210 <code>extension.py</code> \u7684\u7de8\u5beb\u5f8c\uff0c\u6253\u958b\u7d42\u7aef\u6a5f\uff0c\u57f7\u884c <code>zipline ingest</code> \u6307\u4ee4\uff1a</p> <pre><code>zipline ingest -b your_bundle_name\n</code></pre> <p>Zipline \u5728\u57f7\u884c <code>ingest</code> \u6642\uff0c\u6703\u81ea\u52d5\u67e5\u627e\u4e26\u57f7\u884c <code>~/.zipline/extension.py</code> \u8173\u672c\u3002\u5982\u679c\u4e00\u5207\u9806\u5229\uff0c\u5b83\u6703\u8b80\u53d6\u60a8\u7684 CSV \u6a94\u6848\uff0c\u5c07\u5176\u8f49\u63db\u70ba <code>bcolz</code> \u683c\u5f0f\uff0c\u4e26\u5132\u5b58\u5728\u60a8\u7684 bundle \u76ee\u9304\u4e2d\u3002</p>"},{"location":"reference/pipeline/datasets/custom-dataset/#3-pipeline","title":"3. \u5728 Pipeline \u4e2d\u4f7f\u7528\u81ea\u8a02\u8cc7\u6599\u96c6","text":"<p>\u4e00\u65e6\u60a8\u7684\u81ea\u8a02\u8cc7\u6599\u96c6\u6210\u529f <code>ingest</code>\uff0c\u60a8\u5c31\u53ef\u4ee5\u50cf\u4f7f\u7528\u5167\u5efa\u8cc7\u6599\u96c6\u4e00\u6a23\uff0c\u5728 Pipeline \u4e2d\u5c0e\u5165\u548c\u4f7f\u7528\u5b83\u3002</p> <pre><code>from zipline.pipeline import Pipeline\n# \u5f9e extension.py \u4e2d\u5c0e\u5165\u60a8\u7684 Custom DataSet\nfrom .extension import MyCustomDataSet \n\ndef make_my_pipeline():\n    # \u7372\u53d6\u6700\u65b0\u7684\u5916\u8cc7\u6301\u80a1\u6bd4\u4f8b\n    latest_foreign_ownership = MyCustomDataSet.foreign_ownership_ratio.latest\n\n    return Pipeline(\n        columns={\n            'foreign_ownership': latest_foreign_ownership\n        },\n        # \u60a8\u751a\u81f3\u53ef\u4ee5\u57fa\u65bc\u81ea\u8a02\u6578\u64da\u9032\u884c\u7be9\u9078\n        screen=(latest_foreign_ownership &gt; 30.0)\n    )\n</code></pre>"},{"location":"reference/pipeline/datasets/custom-dataset/#_1","title":"\u7e3d\u7d50","text":"<p>\u81ea\u8a02\u8cc7\u6599\u96c6\u662f Zipline Pipeline \u7684\u4e00\u500b\u5f37\u5927\u64f4\u5c55\u529f\u80fd\uff0c\u5b83\u6253\u7834\u4e86\u5167\u5efa\u6578\u64da\u6e90\u7684\u9650\u5236\uff0c\u8b93\u60a8\u53ef\u4ee5\u5c07\u4efb\u4f55\u5916\u90e8\u6578\u64da\u7121\u7e2b\u6574\u5408\u5230\u60a8\u7684\u91cf\u5316\u7814\u7a76\u6d41\u7a0b\u4e2d\u3002\u96d6\u7136\u5275\u5efa\u81ea\u8a02\u8cc7\u6599\u96c6\u7684\u904e\u7a0b\u6bd4\u76f4\u63a5\u4f7f\u7528\u5167\u5efa\u8cc7\u6599\u96c6\u8981\u8907\u96dc\u4e00\u4e9b\uff0c\u4f46\u5b83\u6240\u5e36\u4f86\u7684\u9748\u6d3b\u6027\u548c\u64f4\u5c55\u6027\uff0c\u5c0d\u65bc\u9032\u884c\u6df1\u5165\u3001\u7368\u7279\u7684\u91cf- \u5316\u7b56\u7565\u7814\u7a76\u4f86\u8aaa\uff0c\u662f\u7121\u50f9\u7684\u3002</p>"},{"location":"reference/pyfolio/api/","title":"Pyfolio \u51fd\u6578\u7e3d\u89bd","text":"<p>Info</p> <p>Pyfolio \u662f\u4e00\u500b\u7528\u65bc\u91d1\u878d\u6295\u8cc7\u7d44\u5408\u7e3e\u6548\u8207\u98a8\u96aa\u5206\u6790\u7684 Python \u5eab\uff0c\u4e3b\u8981\u4ee5\u5716\u8868\u65b9\u5f0f\u986f\u793a\u6295\u8cc7\u7b56\u7565\u7684\u512a\u52a3\u3002\u5b83\u8207 Zipline \u958b\u6e90\u56de\u6e2c\u5eab\u5b8c\u7f8e\u517c\u5bb9\uff0c\u80fd\u5c07\u56de\u6e2c\u7d50\u679c\u8f49\u5316\u70ba\u5c08\u696d\u7684\u8996\u89ba\u5316\u5831\u8868\u3002</p> <p>\u672c\u9801\u9762\u6574\u7406\u4e86 Pyfolio \u4e2d\u6700\u5e38\u7528\u7684\u6838\u5fc3\u51fd\u6578\u3002</p>"},{"location":"reference/pyfolio/api/#1-data-extraction","title":"1. \u8cc7\u6599\u63d0\u53d6 (Data Extraction)","text":"<p>\u5728\u9032\u884c\u5206\u6790\u524d\uff0c\u5fc5\u9808\u5148\u5f9e Zipline \u7684\u56de\u6e2c\u7d50\u679c (<code>results</code>) \u4e2d\u63d0\u53d6\u51fa Pyfolio \u6240\u9700\u7684\u683c\u5f0f\u3002</p>"},{"location":"reference/pyfolio/api/#extract_rets_pos_txn_from_zipline","title":"<code>extract_rets_pos_txn_from_zipline</code>","text":"<p>\u5f9e <code>zipline.run_algorithm()</code> \u8f38\u51fa\u7684\u7d50\u679c\u4e2d\uff0c\u63d0\u53d6\u6bcf\u65e5\u5831\u916c\u3001\u6301\u6709\u90e8\u4f4d\u8207\u4ea4\u6613\u7d00\u9304\u3002</p> <pre><code>from pyfolio.utils import extract_rets_pos_txn_from_zipline\n\nreturns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\n</code></pre> <p>\u53c3\u6578 (Parameters):</p> <ul> <li><code>backtest</code> (pd.DataFrame): Zipline \u56de\u6e2c\u7d50\u679c (\u5373 <code>run_algorithm</code> \u7684\u56de\u50b3\u503c)\u3002</li> </ul> <p>\u56de\u50b3\u503c (Returns):</p> <ul> <li><code>returns</code> (pd.Series): \u4ea4\u6613\u7b56\u7565\u7684\u6bcf\u65e5\u5831\u916c\u7387\u3002</li> <li><code>positions</code> (pd.DataFrame): \u6bcf\u65e5\u6301\u6709\u90e8\u4f4d\uff08\u5305\u542b\u73fe\u91d1\u8207\u5404\u8cc7\u7522\u50f9\u503c\uff09\u3002</li> <li><code>transactions</code> (pd.DataFrame): \u8a73\u7d30\u4ea4\u6613\u7d00\u9304\u3002</li> </ul>"},{"location":"reference/pyfolio/api/#2-tear-sheets","title":"2. \u6838\u5fc3\u5206\u6790\u5831\u8868 (Tear Sheets)","text":"<p>Pyfolio \u6700\u5f37\u5927\u7684\u529f\u80fd\u662f \"Tear Sheet\"\uff08\u6495\u9801\u5831\u8868\uff09\uff0c\u80fd\u4e00\u9375\u751f\u6210\u5305\u542b\u591a\u7a2e\u5716\u8868\u8207\u6307\u6a19\u7684\u5b8c\u6574\u5206\u6790\u5831\u544a\u3002</p>"},{"location":"reference/pyfolio/api/#create_full_tear_sheet","title":"<code>create_full_tear_sheet</code>","text":"<p>\u751f\u6210\u5305\u542b\u5831\u916c\u5206\u6790\u3001\u98a8\u96aa\u6307\u6a19\u3001\u6efe\u52d5 Beta\u3001\u56de\u64a4 (Drawdown) \u5206\u6790\u7b49\u5168\u65b9\u4f4d\u7684\u7e3e\u6548\u5831\u544a\u3002</p> <pre><code>from pyfolio.tears import create_full_tear_sheet\n\ncreate_full_tear_sheet(\n    returns=returns,\n    positions=positions,\n    transactions=transactions,\n    benchmark_rets=benchmark_rets\n)\n</code></pre> <p>\u4e3b\u8981\u53c3\u6578 (Parameters):</p> <ul> <li><code>returns</code> (pd.Series): \u7b56\u7565\u65e5\u5831\u916c\u7387\u3002</li> <li><code>positions</code> (pd.DataFrame, optional): \u6301\u6709\u90e8\u4f4d\u8cc7\u8a0a\u3002</li> <li><code>transactions</code> (pd.DataFrame, optional): \u4ea4\u6613\u7d00\u9304\u3002</li> <li><code>benchmark_rets</code> (pd.Series, optional): \u57fa\u6e96 (Benchmark) \u7684\u65e5\u5831\u916c\u7387\uff0c\u7528\u65bc\u8a08\u7b97 Alpha\u3001Beta \u7b49\u76f8\u5c0d\u7e3e\u6548\u3002</li> <li><code>live_start_date</code> (datetime, optional): \u8a2d\u5b9a \"Live\" \u4ea4\u6613\u7684\u958b\u59cb\u65e5\u671f\uff0c\u7528\u65bc\u5340\u5206\u6a23\u672c\u5167 (In-sample) \u8207\u6a23\u672c\u5916 (Out-of-sample) \u5340\u9593\u3002</li> </ul>"},{"location":"reference/pyfolio/api/#3","title":"3. \u5176\u4ed6\u5e38\u7528\u7e6a\u5716\u8207\u7d71\u8a08\u51fd\u6578","text":"<p>\u9664\u4e86\u7522\u751f\u5b8c\u6574\u5831\u8868\uff0c\u60a8\u4e5f\u53ef\u4ee5\u55ae\u7368\u547c\u53eb\u7279\u5b9a\u51fd\u6578\u4f86\u5206\u6790\u3002</p>"},{"location":"reference/pyfolio/api/#show_perf_stats","title":"<code>show_perf_stats</code>","text":"<p>\u986f\u793a\u7b56\u7565\u7684\u95dc\u9375\u7e3e\u6548\u6307\u6a19\u8868\u683c\uff0c\u5982\u5e74\u5316\u5831\u916c\u7387\u3001\u590f\u666e\u6bd4\u7387 (Sharpe Ratio)\u3001\u6700\u5927\u56de\u64a4 (Max Drawdown) \u7b49\u3002</p> <pre><code>from pyfolio.plotting import show_perf_stats\n\nshow_perf_stats(returns, benchmark_rets)\n</code></pre>"},{"location":"reference/pyfolio/api/#show_worst_drawdown_periods","title":"<code>show_worst_drawdown_periods</code>","text":"<p>\u5217\u51fa\u7b56\u7565\u6b77\u53f2\u4e0a\u8868\u73fe\u6700\u5dee\u7684\u524d\u5e7e\u540d\u56de\u64a4\u671f\u9593 (Drawdown Periods)\u3002</p> <pre><code>from pyfolio.plotting import show_worst_drawdown_periods\n\nshow_worst_drawdown_periods(returns, top=5)\n</code></pre>"},{"location":"reference/pyfolio/api/#plot_rolling_returns","title":"<code>plot_rolling_returns</code>","text":"<p>\u7e6a\u88fd\u6efe\u52d5\u5831\u916c\u7387\u5716\u8868\uff0c\u4e26\u8207 Benchmark \u9032\u884c\u6bd4\u8f03\u3002</p> <pre><code>from pyfolio.plotting import plot_rolling_returns\n\nplot_rolling_returns(returns, factor_returns=benchmark_rets)\n</code></pre>"},{"location":"reference/pyfolio/api/#4","title":"4. \u5b8c\u6574\u4f7f\u7528\u7bc4\u4f8b","text":"<p>\u4ee5\u4e0b\u7bc4\u4f8b\u5c55\u793a\u5982\u4f55\u5c07 Zipline \u56de\u6e2c\u7d50\u679c\u5c0e\u5165 Pyfolio \u9032\u884c\u5206\u6790\u3002</p> <pre><code>import pyfolio\nfrom pyfolio.utils import extract_rets_pos_txn_from_zipline\n\n# 1. \u57f7\u884c Zipline \u56de\u6e2c (\u5047\u8a2d results \u70ba\u56de\u6e2c\u7d50\u679c DataFrame)\n# results = run_algorithm(...)\n\n# 2. \u63d0\u53d6 Pyfolio \u6240\u9700\u8cc7\u6599\nreturns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\n\n# 3. \u63d0\u53d6 Benchmark \u5831\u916c\u7387 (\u5047\u8a2d results \u4e2d\u6709\u7d00\u9304)\nbenchmark_rets = results.benchmark_return\n\n# 4. \u6642\u5340\u6a19\u6e96\u5316 (Pyfolio \u8981\u6c42 UTC \u6642\u5340)\nreturns.index = returns.index.tz_localize(None).tz_localize('UTC')\npositions.index = positions.index.tz_localize(None).tz_localize('UTC')\ntransactions.index = transactions.index.tz_localize(None).tz_localize('UTC')\nbenchmark_rets.index = benchmark_rets.index.tz_localize(None).tz_localize('UTC')\n\n# 5. \u7522\u751f\u5b8c\u6574\u5206\u6790\u5831\u8868\npyfolio.tears.create_full_tear_sheet(\n    returns=returns,\n    positions=positions,\n    transactions=transactions,\n    benchmark_rets=benchmark_rets\n)\n</code></pre>"},{"location":"reference/tejtoolapi/api-overview/","title":"TEJ API \u6982\u8ff0","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b TEJ API \u7684\u6574\u9ad4\u6982\u8ff0\uff0c\u5305\u62ec API \u8a8d\u8b49\u65b9\u5f0f\u3001\u8cc7\u6599\u5eab\u985e\u578b\uff0c\u4ee5\u53ca\u5404\u7a2e\u7a0b\u5f0f\u8a9e\u8a00\u7684 API \u6587\u4ef6\u9023\u7d50\u3002</p>"},{"location":"reference/tejtoolapi/api-overview/#1-api","title":"1. API \u8a8d\u8b49","text":""},{"location":"reference/tejtoolapi/api-overview/#11-api-key","title":"1.1 \u53d6\u5f97 API Key","text":"<p>\u60a8\u9700\u8981\u5148\u5411 TEJ \u516c\u53f8\u8a3b\u518a\u5e33\u865f\uff0c\u7136\u5f8c\u7533\u8acb\u53d6\u7528\u8cc7\u6599\u6240\u9700\u7684 API Key\u3002</p> <pre><code>api_key=a8sb1jska2lz03hc2\n</code></pre>"},{"location":"reference/tejtoolapi/api-overview/#12-api-key","title":"1.2 \u8a2d\u5b9a API Key","text":"<p>\u6bcf\u6b21\u5b58\u53d6\u8cc7\u6599\u6642\uff0c\u90fd\u9700\u8981\u63d0\u4f9b\u60a8\u7684 API Key\u3002</p> \u74b0\u5883\u8b8a\u6578 (\u63a8\u85a6)Python tejapiREST API <pre><code>import os\nos.environ['TEJAPI_KEY'] = \"YOUR_API_KEY\"\nos.environ['TEJAPI_BASE'] = \"https://api.tej.com.tw\"\n</code></pre> <pre><code>import tejapi\ntejapi.ApiConfig.api_key = \"YOUR_API_KEY\"\n</code></pre> <pre><code>GET https://api.tej.com.tw/api/datatables/TWN/APRCD.json?api_key=YOUR_API_KEY\n</code></pre>"},{"location":"reference/tejtoolapi/api-overview/#2","title":"2. \u8cc7\u6599\u5eab\u985e\u578b","text":"<p>TEJ \u63d0\u4f9b\u514d\u8cbb\u8a66\u7528\u53ca\u4ed8\u8cbb\u8cc7\u6599\u5eab\uff1a</p> \u9805\u76ee \u8a66\u7528\u8cc7\u6599\u5eab \u4ed8\u8cbb\u8cc7\u6599\u5eab \u53ef\u7528\u8cc7\u6599\u8868 \u50c5\u8a66\u7528\u8cc7\u6599\u5eab\u5167\u7684\u8868\u683c \u5b8c\u6574\u8cc7\u6599\u5eab \u6bcf\u65e5\u547c\u53eb\u6b21\u6578 \u6700\u591a 500 \u6b21 \u6700\u591a 2,000 \u6b21 \u6bcf\u6b21\u547c\u53eb\u7b46\u6578 \u6700\u591a 10,000 \u7b46 \u6700\u591a 10,000 \u7b46 \u5206\u9801\u7e3d\u7b46\u6578\u4e0a\u9650 50,000 \u7b46 1,000,000 \u7b46 \u6bcf\u65e5\u8cc7\u6599\u4e0a\u9650 50,000 \u7b46 3,000,000 \u7b46"},{"location":"reference/tejtoolapi/api-overview/#3-api","title":"3. API \u6587\u4ef6","text":"<ul> <li> <p> TejToolAPI (Python)</p> <p>\u4f7f\u7528 <code>get_history_data</code> \u51fd\u6578\u6574\u4f75\u80a1\u50f9\u8207\u8ca1\u52d9\u8cc7\u6599</p> <p> \u67e5\u770b\u6587\u4ef6</p> </li> </ul>"},{"location":"reference/tejtoolapi/api-overview/#4","title":"4. \u5916\u90e8\u8cc7\u6e90","text":"<ul> <li>TEJ \u8cc7\u6599\u96c6\u7e3d\u89bd</li> <li>TEJ API \u5b98\u65b9\u6587\u4ef6</li> <li>REST API Swagger \u6587\u4ef6</li> <li>PyPI - TejToolAPI</li> </ul>"},{"location":"reference/tejtoolapi/get-history-data/","title":"\u5982\u4f55\u53d6\u5f97\u6b77\u53f2\u8cc7\u6599 (TejToolAPI)","text":"<p>Info</p> <p>\u672c\u9801\u8a73\u7d30\u8aaa\u660e\u5982\u4f55\u4f7f\u7528 TEJ Tool API \u7684 <code>get_history_data</code> \u51fd\u6578\u4f86\u7372\u53d6\u6b77\u53f2\u8cc7\u6599\uff0c\u4e26\u6574\u4f75\u80a1\u50f9\u8207\u4e0d\u540c\u5c6c\u6027\u7684\u8cc7\u6599\u8868\uff0c\u5305\u62ec\u53c3\u6578\u8aaa\u660e\u548c\u4f7f\u7528\u7bc4\u4f8b\u3002</p>"},{"location":"reference/tejtoolapi/get-history-data/#1","title":"1. \u6982\u8ff0","text":"<p>TEJTOOLAPI \u4e3b\u8981\u6574\u4f75\u80a1\u50f9\u8207\u4e0d\u540c\u5c6c\u6027\u7684\u8cc7\u6599\u5eab\uff0c\u900f\u904e\u8f38\u5165\u80a1\u7968\u4ee3\u78bc (TICKERS) \u548c\u6b04\u4f4d (FIELD) \u5f8c\uff0c\u53ef\u5c07\u6b32\u6293\u53d6\u7684\u8cc7\u6599\u6574\u4f75\u70ba\u65e5\u983b\u7387\u7684 DataFrame\u3002</p> <p>\u4e3b\u8981\u6574\u4f75\u65b9\u6cd5\u662f\u4ee5\u4ea4\u6613\u65e5\u671f\u8868\u70ba\u7d22\u5f15\u6574\u4f75\u80a1\u50f9\u8207\u4e0d\u540c\u5c6c\u6027\u7684\u8cc7\u6599\u3002\u8ca1\u52d9\u6578\u64da\u662f\u6839\u64da\u767c\u5e03\u65e5\uff08announcement date\uff09\u4f86 mapping\uff0c\u975e\u767c\u5e03\u65e5\u7684\u8ca1\u52d9\u6578\u64da\u6703\u4f7f\u7528\u7576\u4e0b\u53ef\u7372\u5f97\u6700\u65b0\u7684\u8cc7\u6599\u70ba\u6e96\u9032\u884c\u586b\u503c\u3002</p> <p>\u4f8b\u5982\uff1a2330 \u5728 2010-02-01 \u6642\u6240\u80fd\u7372\u5f97\u6700\u65b0\u7684\u8ca1\u52d9\u8cc7\u6599\u70ba 2009Q3 \u7684\u8ca1\u52d9\u8cc7\u6599\uff0c\u5247 2010-01-01 \u6703\u4ee5 2009Q3 \u7684\u8cc7\u6599\u9032\u884c\u586b\u88dc\u3002\u60df\u516c\u53f8 2009Q4 \u81ea\u7d50\u8ca1\u5831\u65e9\u65bc 2010-02-01 \u767c\u5e03\u6642\uff0c\u4e14 <code>include_self_acc = 'Y'</code>\uff0c\u9019\u6642 2010-02-01 \u7684\u8ca1\u52d9\u6578\u64da\u4f7f\u7528\u81ea\u7d50\u8ca1\u52d9\u6578\u64da\u3002</p> <p>\u53ef\u6293\u53d6\u7684\u8cc7\u6599\u6b04\u4f4d\u53ef\u53c3\u8003\uff1aTEJ \u8cc7\u6599\u96c6</p>"},{"location":"reference/tejtoolapi/get-history-data/#2","title":"2. \u51fd\u6578\u7c3d\u540d","text":"<pre><code>TejToolAPI.get_history_data(ticker, columns, transfer_to_chinese=False, start=None, end=None, fin_type=None, include_self_acc=None)\n</code></pre>"},{"location":"reference/tejtoolapi/get-history-data/#3","title":"3. \u53c3\u6578\u8aaa\u660e","text":"\u53c3\u6578 \u985e\u578b \u8aaa\u660e <code>ticker</code> iterable[str] \u6b32\u67e5\u8a62\u7684\u8cc7\u6599\u7684\u8b49\u5238\u4ee3\u78bc <code>columns</code> iterable[str] \u6b32\u67e5\u8a62\u8cc7\u6599\u7684\u6b04\u4f4d\u540d\u7a31\uff0c\u8a73\u898b API \u6587\u4ef6 <code>transfer_to_chinese</code> boolean \u662f\u5426\u5c07\u6b04\u4f4d\u540d\u7a31\u8f49\u63db\u70ba\u4e2d\u6587\uff0c\u9810\u8a2d\u70ba False <code>start</code> pd.Timestamp or str \u8cc7\u6599\u8d77\u59cb\u6642\u9593 (\u9078\u7528) <code>end</code> pd.Timestamp or str \u8cc7\u6599\u7d50\u675f\u6642\u9593 (\u9078\u7528) <code>fin_type</code> iterable[str] \u6c7a\u5b9a\u8ca1\u52d9\u8cc7\u6599\u578b\u614b\uff1aA (\u7d2f\u7a4d)\u3001F (\u55ae\u5b63)\u3001TTM (\u79fb\u52d5\u56db\u5b63) <code>include_self_acc</code> str Y: \u6295\u8cc7\u7528\u8ca1\u52d9\u5305\u542b\u81ea\u7d50\u548c\u8463\u4e8b\u6703\u6c7a\u8b70\u6578\uff1bN: \u50c5\u6295\u8cc7\u7528\u8ca1\u52d9"},{"location":"reference/tejtoolapi/get-history-data/#4","title":"4. \u56de\u50b3\u503c","text":"<ul> <li>\u985e\u578b\uff1a<code>pd.DataFrame</code></li> <li>\u8aaa\u660e\uff1a\u4ee5\u4ea4\u6613\u65e5\u671f\u70ba\u7d22\u5f15\uff0c\u5305\u542b\u6240\u6709\u8acb\u6c42\u6b04\u4f4d\u7684 DataFrame</li> </ul>"},{"location":"reference/tejtoolapi/get-history-data/#5","title":"5. \u4f7f\u7528\u7bc4\u4f8b","text":""},{"location":"reference/tejtoolapi/get-history-data/#51","title":"5.1 \u74b0\u5883\u8a2d\u5b9a","text":"<pre><code>import os\nos.environ['TEJAPI_KEY'] = \"your key\" \nos.environ['TEJAPI_BASE'] = \"https://api.tej.com.tw\"\n\nimport TejToolAPI \nfrom zipline.data import bundles\n</code></pre>"},{"location":"reference/tejtoolapi/get-history-data/#52-tickers","title":"5.2 \u53d6\u5f97 Tickers","text":"<p>\u65b9\u6cd5\u4e00\uff1a\u5f9e bundle \u53d6\u5f97</p> <pre><code>bundle_data = bundles.load('tquant')\nuniverse = bundle_data.asset_finder.retrieve_all(bundle_data.asset_finder.equities_sids)\ntickers = [col.symbol for col in universe]\n</code></pre> <p>\u65b9\u6cd5\u4e8c\uff1a\u81ea\u884c\u6307\u5b9a</p> <pre><code>tickers = ['2330', '2454', '2317', '2882', '2881']\n</code></pre>"},{"location":"reference/tejtoolapi/get-history-data/#53","title":"5.3 \u7bc4\u4f8b\u4e00\uff1a\u53d6\u5f97\u6708\u71df\u6536\u8cc7\u6599","text":"<pre><code>ticker = tickers\ncolumns = ['Sales_Accu_LastYear', 'Sales_Accu_3M',\n           'Sales_Per_Share_Accu_12M', 'YoY_Accu_Sales', 'YoY_Monthly_Sales',\n           'Sales_Per_Share_Accu_3M', 'Sales_Accu_3M_LastYear', 'Sales_Monthly',\n           'YoY_AccuSales_12M', 'YoY_Accu_Sales_3M', 'MoM_Monthly_Sales',\n           'Sales_Accumulated', 'QoQ_Accu_Sales_3M', 'MoM_Accu_Sales_3M',\n           'Sales_Monthly_LastYear', 'Outstanding_Shares_1000_Shares']\n\ndata = TejToolAPI.get_history_data(ticker=ticker, \n                                   columns=columns,\n                                   transfer_to_chinese=False)\nprint(data)\n</code></pre>"},{"location":"reference/tejtoolapi/get-history-data/#54","title":"5.4 \u7bc4\u4f8b\u4e8c\uff1a\u53d6\u5f97\u96c6\u4fdd\u5eab\u5b58\u8cc7\u6599","text":"<pre><code>ticker = tickers\ncolumns = ['Total_Custodied_Shares_1000_Lots',\n           'Custodied_Under_400_Lots_Total_Lots',\n           'Custodied_Lots_Between_800_1000_Total_Lots',\n           'Custodied_Larger_Than_400_Lots_Pct',\n           'Custodied_Lots_Between_400_600_Total_Lots',\n           'Custodied_Lots_Between_600_800_Pct', \n           'Pledged_Stock_Shares_1000_Lots',\n           'Custodied_Under_400_Lots_Pct',\n           'Custodied_Lots_Between_400_600_Total_Holders',\n           'Custodied_Lots_Between_800_1000_Total_Holders',\n           'Custodied_Under_400_Lots_Total_Holders',\n           'Custodied_Lots_Between_400_600_Pct',\n           'Custodied_Lots_Between_800_1000_Pct',\n           'Custodied_Greater_Than_1000_Lots_Pct']\n\ndata1 = TejToolAPI.get_history_data(ticker=ticker, \n                                    columns=columns,\n                                    transfer_to_chinese=False)\nprint(data1)\n</code></pre>"},{"location":"reference/tejtoolapi/get-history-data/#55","title":"5.5 \u7bc4\u4f8b\u4e09\uff1a\u6293\u53d6\u8ca1\u52d9\u8cc7\u6599","text":""},{"location":"reference/tejtoolapi/get-history-data/#_1","title":"\u53c3\u6578\u8a2d\u5b9a\u8aaa\u660e","text":"<p>ticker - \u55ae\u4e00\u80a1\u7968\uff1a<code>['2330']</code> - \u591a\u80a1\u7968\uff1a<code>['2330', '2317']</code></p> <p>columns - \u6b04\u4f4d\u7bc4\u4f8b\uff1a<code>columns=['r408', 'r409', 'r410', 'r502']</code></p> <p>transfer_to_chinese - \u9810\u8a2d\uff1a<code>False</code> - \u82e5\u8981\u8f49\u63db\u70ba\u4e2d\u6587\u6b04\u4f4d\u540d\u7a31\uff1a<code>True</code></p> <p>fin_type - <code>A</code>\uff1a\u8868\u793a\u7d2f\u7a4d - <code>Q</code>\uff1a\u8868\u793a\u55ae\u5b63 - <code>TTM</code>\uff1a\u8868\u793a\u79fb\u52d5 4 \u5b63</p> <p>include_self_acc - <code>'Y'</code>\uff1a\u6295\u8cc7\u7528\u8ca1\u52d9\u5305\u542b\u81ea\u7d50\u548c\u8463\u4e8b\u6703\u6c7a\u8b70\u6578 - <code>'N'</code>\uff1a\u50c5\u6295\u8cc7\u7528\u8ca1\u52d9</p>"},{"location":"reference/tejtoolapi/get-history-data/#_2","title":"\u5b8c\u6574\u7bc4\u4f8b","text":"<pre><code># \u8f38\u5165\u6b04\u4f4d\nicolumns = ['Open', 'Close', 'Qfii_Diff_Vol', 'Total_Diff_Vol', \n            'Custodied_Lots_Between_800_1000_Total_Lots', \n            'Custodied_Lots_Between_800_1000_Pct',\n            'Attention_Stock_Fg', 'Disposition_Stock_Fg', 'Matching_Period', \n            'Suspended_Trading_Stock_Fg', 'Component_Stock_of_TWN50_Fg', \n            'Gross_Margin_Growth_Rate', 'Net_Income_Rate_percent', \n            'Operating_Income_Growth_Rate']\n\n# \u4f7f\u7528 TEJTOOLAPI \u6574\u4f75\ndata = TejToolAPI.get_history_data(ticker=tickers[:5], \n                                   columns=icolumns,\n                                   transfer_to_chinese=True, \n                                   fin_type=['Q'],\n                                   start='2015-01-01', \n                                   end='2022-12-31')\nprint(data)\n</code></pre>"},{"location":"reference/tejtoolapi/get-history-data/#6","title":"6. \u5e38\u898b\u554f\u984c","text":"<p>Q\uff1a\u5982\u4f55\u77e5\u9053\u6709\u54ea\u4e9b\u6b04\u4f4d\u53ef\u4ee5\u4f7f\u7528\uff1f</p> <p>A\uff1a\u8acb\u53c3\u8003 TEJ \u8cc7\u6599\u96c6\u6587\u4ef6 \u6216 API \u6587\u4ef6</p> <p>Q\uff1a\u6642\u9593\u7be9\u9078\u7684\u683c\u5f0f\u662f\u4ec0\u9ebc\uff1f</p> <p>A\uff1a\u652f\u63f4 <code>pd.Timestamp</code> \u6216\u5b57\u7b26\u4e32\u683c\u5f0f\uff0c\u4f8b\u5982 <code>'2020-01-01'</code> \u6216 <code>'20200101'</code></p> <p>Q\uff1a\u5982\u4f55\u7372\u53d6\u6240\u6709\u53ef\u7528\u7684 tickers\uff1f</p> <p>A\uff1a\u53ef\u4ee5\u900f\u904e <code>bundles.load('tquant')</code> \u5f9e tquant bundle \u4e2d\u53d6\u5f97</p>"},{"location":"reference/zipline/assets/","title":"Zipline API \u53c3\u8003\uff1aAsset \u7269\u4ef6","text":"<p>Info</p> <p>\u672c\u9801\u8aaa\u660e Zipline \u4e2d Asset\uff08\u8cc7\u7522\uff09\u7269\u4ef6\u7684\u6838\u5fc3\u6982\u5ff5\uff0c\u5305\u542b\u80a1\u7968 (Equity) \u8207\u671f\u8ca8 (Future) \u5169\u7a2e\u985e\u578b\u7684\u5c6c\u6027\u8207\u4f7f\u7528\u65b9\u5f0f\u3002</p>"},{"location":"reference/zipline/assets/#1","title":"1. \u6838\u5fc3\u6982\u5ff5","text":"<p>\u5728 Zipline \u4e2d\uff0cAsset\uff08\u8cc7\u7522\uff09 \u7269\u4ef6\u662f\u4efb\u4f55\u53ef\u4ea4\u6613\u91d1\u878d\u5de5\u5177\uff08\u5982\u80a1\u7968\u3001\u671f\u8ca8\uff09\u7684\u552f\u4e00\u6a19\u8b58\u3002\u6bcf\u500b Asset \u7269\u4ef6\u90fd\u5305\u542b\u8a72\u91d1\u878d\u5de5\u5177\u7684\u5143\u6578\u64da\uff0c\u4f8b\u5982\u4ee3\u78bc\u3001\u4ea4\u6613\u6240\u3001\u5230\u671f\u65e5\u7b49\u3002</p> <p>\u5728 TQuant Lab \u7684\u74b0\u5883\u4e2d\uff0c\u60a8\u6700\u5e38\u63a5\u89f8\u5230\u7684 Asset \u4e3b\u8981\u6709\u5169\u7a2e\u985e\u578b\uff1a</p> <ol> <li><code>Equity</code>\uff1a\u4ee3\u8868\u80a1\u7968\u3002</li> <li><code>Future</code>\uff1a\u4ee3\u8868\u671f\u8ca8\u5408\u7d04\u3002</li> </ol>"},{"location":"reference/zipline/assets/#2-equity","title":"2. \u80a1\u7968 (Equity)","text":"<p><code>Equity</code> \u7269\u4ef6\u4ee3\u8868\u55ae\u4e00\u4e00\u652f\u80a1\u7968\uff0c\u4f8b\u5982\u53f0\u7a4d\u96fb (2330)\u3002</p>"},{"location":"reference/zipline/assets/#21-equity","title":"2.1 \u5982\u4f55\u53d6\u5f97 <code>Equity</code> \u7269\u4ef6","text":"<p>\u5728 Zipline API \u4e2d\uff0c\u6700\u5e38\u7528 <code>symbol()</code> \u51fd\u6578\u4f86\u900f\u904e\u80a1\u7968\u4ee3\u78bc\u53d6\u5f97 <code>Equity</code> \u7269\u4ef6\u3002</p> <pre><code>from zipline.api import symbol\n\n# \u53d6\u5f97\u53f0\u7a4d\u96fb (2330) \u7684 Asset \u7269\u4ef6\nasset_tsmc = symbol('2330')\n\n# \u53d6\u5f97\u5927\u76e4\u6307\u6578 (\u7528\u65bc benchmark)\nasset_benchmark = symbol('IR0001')\n</code></pre>"},{"location":"reference/zipline/assets/#22","title":"2.2 \u5e38\u7528\u5c6c\u6027","text":"\u5c6c\u6027 (<code>attribute</code>) \u63cf\u8ff0 \u7bc4\u4f8b <code>sid</code> \u7cfb\u7d71\u5167\u90e8\u552f\u4e00\u7684\u8b49\u5238 ID (Security ID) <code>2317</code> <code>symbol</code> \u80a1\u7968\u4ee3\u78bc <code>'2330'</code> <code>asset_name</code> \u80a1\u7968\u540d\u7a31 <code>'TAIWAN SEMICONDUCTOR MANUFACTURING'</code> <code>exchange</code> \u4ea4\u6613\u6240\u540d\u7a31 <code>'XTAI'</code> (\u53f0\u7063\u8b49\u5238\u4ea4\u6613\u6240)"},{"location":"reference/zipline/assets/#3-future","title":"3. \u671f\u8ca8 (Future)","text":"<p>\u671f\u8ca8\u8cc7\u7522\u5728 Zipline \u4e2d\u6709\u5169\u7a2e\u4e3b\u8981\u5f62\u5f0f\uff1a\u4ee3\u8868\u7279\u5b9a\u6708\u4efd\u7684 <code>Future</code> \u7269\u4ef6\uff0c\u4ee5\u53ca\u7528\u65bc\u5206\u6790\u548c\u4ea4\u6613\u7684 <code>ContinuousFuture</code> \u7269\u4ef6\u3002</p>"},{"location":"reference/zipline/assets/#31-the-future-object","title":"3.1 \u5177\u9ad4\u5408\u7d04 (The <code>Future</code> Object)","text":"<p><code>Future</code> \u7269\u4ef6\u4ee3\u8868\u4e00\u500b \u5177\u9ad4\u7684\u3001\u6709\u5230\u671f\u65e5 \u7684\u671f\u8ca8\u5408\u7d04\uff0c\u4f8b\u5982\u300c2024\u5e7410\u6708\u4efd\u7684\u53f0\u6307\u671f\u8ca8\u5408\u7d04\u300d\u3002\u5728\u4e0b\u55ae\u6216\u67e5\u8a62\u7279\u5b9a\u5408\u7d04\u7684\u6301\u5009\u6642\uff0c\u60a8\u64cd\u4f5c\u7684\u5c0d\u8c61\u5c31\u662f\u9019\u500b\u7269\u4ef6\u3002</p>"},{"location":"reference/zipline/assets/#311","title":"3.1.1 \u5982\u4f55\u53d6\u5f97","text":"<p>\u60a8\u901a\u5e38**\u4e0d\u6703**\u76f4\u63a5\u5efa\u7acb <code>Future</code> \u7269\u4ef6\uff0c\u800c\u662f\u900f\u904e <code>ContinuousFuture</code> \u7269\u4ef6\u5728\u7279\u5b9a\u7684\u4ea4\u6613\u65e5\u67e5\u8a62\u7576\u4e0b\u61c9\u8a72\u4ea4\u6613\u7684\u5408\u7d04\u3002</p> <pre><code># \u5047\u8a2d context.future \u662f\u4e00\u500b\u9023\u7e8c\u5408\u7d04\u7269\u4ef6\n# \u53d6\u5f97\u4eca\u5929\u7684\u5177\u9ad4\u5408\u7d04\ncurrent_contract = data.current(context.future, 'contract')\n</code></pre>"},{"location":"reference/zipline/assets/#312","title":"3.1.2 \u5e38\u7528\u5c6c\u6027","text":"\u5c6c\u6027 (<code>attribute</code>) \u63cf\u8ff0 \u7bc4\u4f8b <code>sid</code> \u7cfb\u7d71\u5167\u90e8\u552f\u4e00\u7684\u5408\u7d04 ID <code>12345</code> <code>symbol</code> \u5408\u7d04\u7684\u4ee3\u78bc <code>'TXF2410'</code> <code>root_symbol</code> \u8a72\u5408\u7d04\u7684\u6839\u4ee3\u78bc\uff0c\u4ee3\u8868\u5176\u6a19\u7684\u5546\u54c1 <code>'TX'</code> <code>start_date</code> \u8a72\u5408\u7d04\u7684\u8d77\u59cb\u4ea4\u6613\u65e5 <code>pd.Timestamp(...)</code> <code>auto_close_date</code> (\u975e\u5e38\u91cd\u8981) \u8a72\u5408\u7d04\u7684\u6700\u5f8c\u4ea4\u6613\u65e5/\u5230\u671f\u7d50\u7b97\u65e5 <code>pd.Timestamp(...)</code> <code>exchange</code> \u4ea4\u6613\u6240\u540d\u7a31 <code>'XTFX'</code> (\u53f0\u7063\u671f\u8ca8\u4ea4\u6613\u6240)"},{"location":"reference/zipline/assets/#32-the-continuousfuture-object","title":"3.2 \u9023\u7e8c\u5408\u7d04 (The ContinuousFuture Object)","text":"<p><code>ContinuousFuture</code> \u662f\u4e00\u500b \u8f14\u52a9\u6027 \u7684\u7269\u4ef6\uff0c\u5b83\u672c\u8eab\u4e0d\u80fd\u88ab\u76f4\u63a5\u4ea4\u6613\u3002\u5b83\u7684\u4f5c\u7528\u662f\u5c07\u4e00\u7cfb\u5217\u6709\u5230\u671f\u65e5\u7684\u7368\u7acb\u671f\u8ca8\u5408\u7d04\uff08\u5982\u53f0\u630709\u3001\u53f0\u630710\u3001\u53f0\u630711...\uff09\u4e32\u63a5\u6210\u4e00\u500b\u6c92\u6709\u5230\u671f\u65e5\u7684\u300c\u9023\u7e8c\u5408\u7d04\u300d\u3002</p> <p>\u9019\u8b93\u60a8\u53ef\u4ee5\u5c0d\u4e00\u500b\u9023\u7e8c\u7684\u50f9\u683c\u5e8f\u5217\u9032\u884c\u6280\u8853\u5206\u6790\uff0c\u800c Zipline \u6703\u5728\u80cc\u666f\u81ea\u52d5\u8655\u7406\u63db\u6708\uff0c\u60a8\u7121\u9700\u624b\u52d5\u7ba1\u7406\u3002</p>"},{"location":"reference/zipline/assets/#321","title":"3.2.1 \u5982\u4f55\u53d6\u5f97","text":"<p>\u4f7f\u7528 <code>continuous_future()</code> \u51fd\u6578\u4f86\u5efa\u7acb\u3002</p> <pre><code>from zipline.api import continuous_future\n\n# \u5efa\u7acb\u4e00\u500b\u4ee3\u8868\u53f0\u6307\u671f\u8fd1\u6708\u5408\u7d04\u7684\u9023\u7e8c\u5408\u7d04\u7269\u4ef6\nfuture_tx = continuous_future(\n    root_symbol='TX',      # \u6839\u4ee3\u78bc\n    offset=0,              # 0 \u4ee3\u8868\u8fd1\u6708\u5408\u7d04\n    roll='calendar',       # \u4f9d\u65e5\u66c6\u63db\u6708\n    adjustment='add'       # \u50f9\u683c\u8abf\u6574\u65b9\u5f0f\n)\n</code></pre>"},{"location":"reference/zipline/assets/#4","title":"4. \u5728\u7b56\u7565\u4e2d\u61c9\u7528","text":"<p>\u5728\u5be6\u969b\u7b56\u7565\u4e2d\uff0c\u60a8\u6703\u900f\u904e <code>context.portfolio.positions</code> \u4f86\u5b58\u53d6\u60a8\u6301\u6709\u7684\u6240\u6709 Asset \u7269\u4ef6\u3002\u60a8\u53ef\u4ee5\u900f\u904e\u6aa2\u67e5\u7269\u4ef6\u7684\u985e\u578b\u4f86\u5224\u65b7\u5b83\u662f\u80a1\u7968\u9084\u662f\u671f\u8ca8\uff0c\u4e26\u57f7\u884c\u76f8\u61c9\u7684\u64cd\u4f5c\u3002</p> <pre><code>from zipline.assets import Equity, Future\n\ndef daily_trade(context, data):\n\n    # \u904d\u6b77\u60a8\u6295\u8cc7\u7d44\u5408\u4e2d\u7684\u6bcf\u4e00\u500b\u90e8\u4f4d\n    for asset, position in context.portfolio.positions.items():\n\n        # \u6aa2\u67e5\u8cc7\u7522\u985e\u578b\n        if isinstance(asset, Equity):\n            # --- \u9019\u662f\u80a1\u7968 --- \n            print(f\"\u6301\u6709\u7684\u80a1\u7968: {asset.symbol}, \u80a1\u6578: {position.amount}\")\n\n        elif isinstance(asset, Future):\n            # --- \u9019\u662f\u671f\u8ca8 --- \n            print(f\"\u6301\u6709\u7684\u671f\u8ca8\u5408\u7d04: {asset.symbol}\")\n            print(f\"  - \u6839\u4ee3\u78bc: {asset.root_symbol}\")\n            print(f\"  - \u5230\u671f\u65e5: {asset.auto_close_date.date()}\")\n            print(f\"  - \u6301\u6709\u53e3\u6578: {position.amount}\")\n</code></pre>"},{"location":"reference/zipline/context/","title":"Zipline \u56de\u6e2c\u4e2d\u7684 context \u7269\u4ef6","text":"<p>Info</p> <p>\u672c\u9801\u6df1\u5165\u4ecb\u7d39 Zipline \u56de\u6e2c\u4e2d\u7684 <code>context</code> \u7269\u4ef6\uff0c\u5305\u62ec\u5176\u6838\u5fc3\u4f5c\u7528\u3001\u4e3b\u8981\u5167\u5efa\u5c6c\u6027\u3001\u81ea\u5b9a\u7fa9\u5c6c\u6027\u4ee5\u53ca\u5b8c\u6574\u7bc4\u4f8b\uff0c\u5e6b\u52a9\u4f7f\u7528\u8005\u7406\u89e3\u5982\u4f55\u5132\u5b58\u548c\u50b3\u905e\u7b56\u7565\u72c0\u614b\u8cc7\u8a0a\u3002</p> <p>\u5728 Zipline \u7684\u4e8b\u4ef6\u9a45\u52d5\u56de\u6e2c\u6846\u67b6\u4e2d\uff0c<code>context</code> \u7269\u4ef6\u662f\u7b56\u7565\u7684\u6838\u5fc3\u3002\u5b83\u5728\u6574\u500b\u56de\u6e2c\u904e\u7a0b\u4e2d\u6301\u7e8c\u5b58\u5728\uff0c\u4e26\u5728 <code>initialize()</code>\u3001<code>before_trading_start()</code>\u3001<code>handle_data()</code> \u548c <code>analyze()</code> \u7b49\u751f\u547d\u9031\u671f\u51fd\u6578\u4e4b\u9593\u50b3\u905e\u7b56\u7565\u7684\u72c0\u614b\u8cc7\u8a0a\u3002\u900f\u904e <code>context</code>\uff0c\u60a8\u53ef\u4ee5\u5b58\u53d6\u6295\u8cc7\u7d44\u5408\u7684\u7576\u524d\u72c0\u614b\u3001\u8a18\u9304\u4ea4\u6613\u8cc7\u8a0a\uff0c\u4ee5\u53ca\u5132\u5b58\u4efb\u4f55\u81ea\u5b9a\u7fa9\u7684\u7b56\u7565\u8b8a\u6578\u3002</p>"},{"location":"reference/zipline/context/#1-context","title":"1. context \u7c21\u4ecb","text":"<p><code>context</code> \u5c31\u50cf\u4e00\u500b\u5c08\u5c6c\u65bc\u60a8\u7b56\u7565\u7684\u5132\u7269\u6ac3\uff0c\u5b83\uff1a *   \u6301\u4e45\u6027: \u4e00\u65e6\u5728 <code>initialize()</code> \u4e2d\u8a2d\u5b9a\uff0c<code>context</code> \u7684\u5167\u5bb9\u5c31\u6703\u5728\u6574\u500b\u56de\u6e2c\u671f\u9593\u4fdd\u6301\u4e0d\u8b8a\uff0c\u9664\u975e\u60a8\u660e\u78ba\u4fee\u6539\u5b83\u3002 *   \u53ef\u8b8a\u6027: \u60a8\u53ef\u4ee5\u5728\u56de\u6e2c\u7684\u4efb\u4f55\u968e\u6bb5\u8b80\u53d6\u6216\u4fee\u6539 <code>context</code> \u7684\u5c6c\u6027\u3002 *   \u5168\u5c40\u6027: \u5b83\u662f\u7b56\u7565\u4e2d\u6240\u6709\u751f\u547d\u9031\u671f\u51fd\u6578\u5171\u4eab\u7684\u552f\u4e00\u72c0\u614b\u5bb9\u5668\u3002</p>"},{"location":"reference/zipline/context/#2-context","title":"2. context \u7684\u4e3b\u8981\u5167\u5efa\u5c6c\u6027","text":"<p><code>context</code> \u7269\u4ef6\u5167\u7f6e\u4e86\u5e7e\u500b\u91cd\u8981\u7684\u5c6c\u6027\uff0c\u63d0\u4f9b\u4e86\u95dc\u65bc\u6295\u8cc7\u7d44\u5408\u548c\u56de\u6e2c\u74b0\u5883\u7684\u5be6\u6642\u8cc7\u8a0a\u3002</p>"},{"location":"reference/zipline/context/#21-contextportfolio","title":"2.1. context.portfolio\uff1a\u6295\u8cc7\u7d44\u5408\u72c0\u614b","text":"<p><code>context.portfolio</code> \u662f\u4e00\u500b\u975e\u5e38\u91cd\u8981\u7684\u5c6c\u6027\uff0c\u5b83\u63d0\u4f9b\u4e86\u7576\u524d\u6295\u8cc7\u7d44\u5408\u7684\u8a73\u7d30\u60c5\u6cc1\u3002</p> <ul> <li><code>context.portfolio.cash</code>: \u7576\u524d\u53ef\u7528\u7684\u73fe\u91d1\u9918\u984d\u3002</li> <li><code>context.portfolio.positions</code>: \u4e00\u500b\u5b57\u5178\u578b\u7269\u4ef6\uff0c\u9375\u70ba\u8cc7\u7522\u7269\u4ef6\uff0c\u503c\u70ba <code>Position</code> \u7269\u4ef6\uff0c\u5305\u542b\u4e86\u60a8\u76ee\u524d\u6301\u6709\u7684\u6240\u6709\u8cc7\u7522\u53ca\u5176\u8a73\u7d30\u8cc7\u8a0a\uff08\u4f8b\u5982\u6301\u80a1\u6578\u91cf <code>amount</code>\uff09\u3002<ul> <li><code>context.portfolio.positions[asset].amount</code>: \u7372\u53d6\u7279\u5b9a\u8cc7\u7522\u7684\u6301\u80a1\u6578\u91cf\u3002</li> <li><code>context.portfolio.positions.keys()</code>: \u7372\u53d6\u4e00\u500b\u5217\u8868\uff0c\u5305\u542b\u6240\u6709\u76ee\u524d\u6301\u6709\u7684\u8cc7\u7522\u7269\u4ef6\u3002</li> </ul> </li> <li><code>context.portfolio.portfolio_value</code>: \u6295\u8cc7\u7d44\u5408\u7684\u7576\u524d\u7e3d\u5e02\u503c\uff08\u73fe\u91d1 + \u6301\u80a1\u50f9\u503c\uff09\u3002</li> <li><code>context.portfolio.positions_value</code>: \u6240\u6709\u6301\u80a1\u7684\u7576\u524d\u7e3d\u5e02\u503c\u3002</li> </ul>"},{"location":"reference/zipline/context/#_1","title":"\u7bc4\u4f8b","text":"<pre><code>def handle_data(context, data):\n    # \u6aa2\u67e5\u662f\u5426\u6709\u8db3\u5920\u7684\u73fe\u91d1\u4f86\u4e0b\u55ae\n    if context.portfolio.cash &gt; 10000:\n        # ... \u57f7\u884c\u8cb7\u5165\u64cd\u4f5c ...\n        pass\n\n    # \u904d\u6b77\u6240\u6709\u6301\u6709\u7684\u90e8\u4f4d\n    for asset, position in context.portfolio.positions.items():\n        print(f\"\u6301\u6709 {asset.symbol} \u80a1\u6578: {position.amount}, \u7576\u524d\u5e02\u503c: {position.last_sale_price * position.amount}\")\n\n    # \u6253\u5370\u6295\u8cc7\u7d44\u5408\u7e3d\u50f9\u503c\n    print(f\"\u6295\u8cc7\u7d44\u5408\u7e3d\u50f9\u503c: {context.portfolio.portfolio_value}\")\n</code></pre>"},{"location":"reference/zipline/context/#22-contextblotter","title":"2.2. context.blotter\uff1a\u4ea4\u6613\u8a18\u9304\u5668","text":"<p><code>context.blotter</code> \u7269\u4ef6\u63d0\u4f9b\u4e86\u5c0d\u4ea4\u6613\u6b77\u53f2\u548c\u672a\u5b8c\u6210\u8a02\u55ae\u7684\u8a2a\u554f\u4ecb\u9762\u3002\u5118\u7ba1\u5728\u4e00\u822c\u7684\u7b56\u7565\u7bc4\u4f8b\u4e2d\u4e0d\u5e38\u7528\uff0c\u4f46\u5c0d\u65bc\u9700\u8981\u7cbe\u7d30\u63a7\u5236\u8a02\u55ae\u72c0\u614b\u6216\u5206\u6790\u6b77\u53f2\u4ea4\u6613\u7684\u9032\u968e\u7b56\u7565\u975e\u5e38\u6709\u7528\u3002</p> <ul> <li><code>context.blotter.open_orders</code>: \u7372\u53d6\u4e00\u500b\u5b57\u5178\uff0c\u5305\u542b\u6240\u6709\u5c1a\u672a\u5b8c\u5168\u6210\u4ea4\u7684\u8a02\u55ae\u3002</li> </ul>"},{"location":"reference/zipline/context/#23-contextasset_finder","title":"2.3. context.asset_finder\uff1a\u8cc7\u7522\u67e5\u627e\u5668","text":"<p><code>context.asset_finder</code> \u662f\u4e00\u500b\u7528\u65bc\u6839\u64da\u7b26\u865f (symbol)\u3001SID (Zipline ID) \u6216\u5176\u4ed6\u5c6c\u6027\u67e5\u627e\u8cc7\u7522\u7269\u4ef6\u7684\u5de5\u5177\u3002\u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>zipline.api.symbol()</code> \u6216 <code>asset_finder.lookup_symbol()</code> \u4f86\u7372\u53d6\u8cc7\u7522\u7269\u4ef6\u3002</p>"},{"location":"reference/zipline/context/#3-custom-attributes","title":"3. \u81ea\u5b9a\u7fa9\u5c6c\u6027 (Custom Attributes)","text":"<p>\u60a8\u53ef\u4ee5\u5728 <code>initialize()</code> \u51fd\u6578\u4e2d\u70ba <code>context</code> \u7269\u4ef6\u6dfb\u52a0\u4efb\u610f\u81ea\u5b9a\u7fa9\u5c6c\u6027\uff0c\u4ee5\u4fbf\u5728\u56de\u6e2c\u7684\u5f8c\u7e8c\u968e\u6bb5\uff08\u5982 <code>handle_data()</code>\uff09\u4e2d\u5b58\u5132\u548c\u6aa2\u7d22\u7b56\u7565\u7684\u5167\u90e8\u72c0\u614b\u6216\u984d\u5916\u6578\u64da\u3002</p>"},{"location":"reference/zipline/context/#_2","title":"\u7bc4\u4f8b","text":"<pre><code>def initialize(context):\n    context.my_flag = False          # \u5132\u5b58\u5e03\u6797\u503c\n    context.counter = 0              # \u5132\u5b58\u6574\u6578\u8a08\u6578\u5668\n    context.stock_list = []          # \u5132\u5b58\u80a1\u7968\u5217\u8868\n    context.my_data_dict = {}        # \u5132\u5b58\u5b57\u5178\n\ndef handle_data(context, data):\n    if not context.my_flag:\n        print(\"\u9019\u662f\u7b2c\u4e00\u6b21\u9032\u5165 handle_data\uff01\")\n        context.my_flag = True # \u4fee\u6539\u81ea\u5b9a\u7fa9\u5c6c\u6027\n\n    context.counter += 1\n    if context.counter % 10 == 0:\n        print(f\"\u5df2\u904b\u884c {context.counter} \u6b21 handle_data\u3002\")\n</code></pre>"},{"location":"reference/zipline/context/#4","title":"4. \u5b8c\u6574\u7bc4\u4f8b","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u500b\u5b8c\u6574\u7684\u7bc4\u4f8b\uff0c\u6f14\u793a\u5982\u4f55\u5728 <code>initialize()</code> \u4e2d\u8a2d\u5b9a <code>context</code>\uff0c\u4e26\u5728 <code>handle_data()</code> \u4e2d\u4f7f\u7528\u5176\u5167\u5efa\u548c\u81ea\u5b9a\u7fa9\u5c6c\u6027\u3002</p> <pre><code>import pandas as pd\nfrom zipline import run_algorithm\nfrom zipline.api import symbol, order_target_percent, record, set_benchmark\n\ndef initialize(context):\n    context.my_asset = symbol('2330') # \u8a2d\u5b9a\u4e00\u500b\u8981\u4ea4\u6613\u7684\u8cc7\u7522\n    context.has_ordered = False       # \u81ea\u5b9a\u7fa9\u65d7\u6a19\uff0c\u8ffd\u8e64\u662f\u5426\u5df2\u4e0b\u55ae\n    context.trade_count = 0           # \u81ea\u5b9a\u7fa9\u8a08\u6578\u5668\n    set_benchmark(symbol('IR0001'))   # \u8a2d\u5b9a Benchmark\n\ndef handle_data(context, data):\n    # \u6aa2\u67e5\u662f\u5426\u5df2\u4e0b\u55ae\n    if not context.has_ordered:\n        # \u4f7f\u7528 context.portfolio.cash \u6aa2\u67e5\u662f\u5426\u6709\u8db3\u5920\u73fe\u91d1\n        if context.portfolio.cash &gt; data.current(context.my_asset, 'price') * 100: # \u5047\u8a2d\u8cb7100\u80a1\n            order_target_percent(context.my_asset, 1.0) # \u5168\u5009\u8cb7\u5165\n            context.has_ordered = True\n            context.trade_count += 1\n            print(f\"\u8cb7\u5165 {context.my_asset.symbol}\uff0c\u73fe\u91d1\u9918\u984d: {context.portfolio.cash}\")\n\n    # \u5728\u6bcf\u9694\u4e00\u6bb5\u6642\u9593\u5f8c\u6253\u5370\u6301\u5009\u4fe1\u606f\n    context.trade_count += 1\n    if context.trade_count % 50 == 0:\n        if context.my_asset in context.portfolio.positions:\n            pos = context.portfolio.positions[context.my_asset]\n            print(f\"\u65e5\u671f: {data.current_dt.date()} \u6301\u6709 {pos.asset.symbol} \u80a1\u6578: {pos.amount}\")\n        print(f\"\u6295\u8cc7\u7d44\u5408\u7e3d\u50f9\u503c: {context.portfolio.portfolio_value}\")\n\ndef analyze(context, results):\n    # \u6b64\u8655\u53ef\u4ee5\u5229\u7528 context \u9032\u884c\u5206\u6790\uff0c\u4f8b\u5982\u6253\u5370\u6700\u7d42\u7684 trade_count\n    print(f\"\u7e3d\u4ea4\u6613\u6b21\u6578: {context.trade_count}\")\n    print(f\"\u6700\u7d42\u6295\u8cc7\u7d44\u5408\u50f9\u503c: {results.iloc[-1]['portfolio_value']}\")\n\n# \u57f7\u884c\u56de\u6e2c\nresults = run_algorithm(\n    start=pd.Timestamp('2022-01-01', tz='UTC'),\n    end=pd.Timestamp('2023-01-01', tz='UTC'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    capital_base=1_000_000,\n    bundle='tquant'\n)\n</code></pre>"},{"location":"reference/zipline/data-object/","title":"Zipline \u8cc7\u6599\u7269\u4ef6\u4ecb\u7d39","text":"<p>Info</p> <p>\u672c\u9801\u4ecb\u7d39 Zipline \u4e2d\u5e38\u898b\u7684\u5167\u5efa\u8cc7\u6599\u7269\u4ef6\uff0c\u5305\u62ec <code>context</code>\u3001<code>data</code>\u3001<code>pipeline_output()</code>\u3001<code>record()</code> \u7b49\uff0c\u4e26\u8aaa\u660e\u5176\u7528\u9014\u548c\u4f7f\u7528\u65b9\u5f0f\uff0c\u5e6b\u52a9\u4f7f\u7528\u8005\u7406\u89e3\u5982\u4f55\u5b58\u53d6\u548c\u7ba1\u7406\u56de\u6e2c\u4e2d\u7684\u6578\u64da\u3002</p> <p>\u5728 Zipline \u4e2d\uff0c\u6709\u591a\u7a2e\u5167\u5efa\u8cc7\u6599\u7269\u4ef6\u53ef\u4f9b\u6f14\u7b97\u6cd5\u5b58\u53d6\u8cc7\u6599\u8207\u8ffd\u8e64\u8b8a\u6578\u3002\u5e38\u898b\u7684\u8cc7\u6599\u7269\u4ef6\u5305\u62ec <code>context</code>\u3001<code>data</code>\u3001<code>pipeline_output()</code>\u3001<code>record()</code>\u3001<code>get_bundle_price()</code>\u3001<code>portfolio</code>\u3001<code>account</code> \u53ca <code>get_open_orders()</code> \u7b49\uff0c\u4ee5\u4e0b\u5c07\u9010\u4e00\u4ecb\u7d39\u5176\u7528\u9014\u8207\u4f7f\u7528\u65b9\u5f0f\u3002</p>"},{"location":"reference/zipline/data-object/#1-context","title":"1. context \u7269\u4ef6","text":"<p><code>context</code> \u662f Zipline \u7b56\u7565\u7684\u6838\u5fc3\uff0c\u7528\u4f86\u5132\u5b58\u7b56\u7565\u57f7\u884c\u904e\u7a0b\u4e2d\u7684\u72c0\u614b\u8207\u8b8a\u6578\uff0c\u8b93\u4f60\u5728\u4e0d\u540c\u7684\u51fd\u6578\uff08\u5982 <code>initialize</code>\u3001<code>before_trading_start</code>\u3001<code>handle_data</code>\uff09\u4e2d\u90fd\u80fd\u5b58\u53d6\u8207\u5171\u4eab\u8cc7\u6599\u3002\u4f8b\u5982\u4f60\u53ef\u4ee5\u5728 <code>initialize()</code> \u4e2d\u5b9a\u7fa9\u6295\u8cc7\u6a19\u7684\u6e05\u55ae\u8207\u53c3\u6578\uff0c\u4e26\u65bc\u5f8c\u7e8c\u7b56\u7565\u57f7\u884c\u4e2d\u6301\u7e8c\u4f7f\u7528\uff1a</p> <pre><code>def initialize(context):\n    context.stocklist = ['2330', '2317']\n    context.max_leverage = 1.0\n</code></pre>"},{"location":"reference/zipline/data-object/#2-data","title":"2. data \u7269\u4ef6","text":"<p><code>data</code> \u63d0\u4f9b\u6bcf\u65e5\u5e02\u5834\u8cc7\u6599\uff0c\u5305\u542b\u5831\u50f9\uff08<code>price</code>\uff09\u3001\u6210\u4ea4\u91cf\uff08<code>volume</code>\uff09\u3001\u662f\u5426\u53ef\u4ea4\u6613\uff08<code>can_trade</code>\uff09\u7b49\u8cc7\u8a0a\u3002\u5e38\u898b\u7528\u6cd5\u5982\u4e0b\uff1a</p> <pre><code>def handle_data(context, data):\n    price = data.current(symbol(\"2330\"), 'price')\n    volume = data.current(symbol(\"2330\"), 'volume')\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u900f\u904e\uff1a</p> <pre><code>data.can_trade(symbol(\"2330\"))\n</code></pre> <p>\u4f86\u78ba\u8a8d\u67d0\u80a1\u7968\u7576\u65e5\u662f\u5426\u53ef\u4ee5\u9032\u884c\u4ea4\u6613\uff08\u5982\u672a\u505c\u724c\u3001\u6d41\u52d5\u6027\u8db3\u5920\u7b49\uff09\u3002</p>"},{"location":"reference/zipline/data-object/#3-pipeline_output","title":"3. pipeline_output()","text":"<p>\u82e5\u4f60\u6709\u5efa\u7acb Pipeline \u7528\u4f86\u9032\u884c\u689d\u4ef6\u7be9\u9078\u6216\u56e0\u5b50\u8a08\u7b97\uff0c\u53ef\u4ee5\u900f\u904e <code>pipeline_output()</code> \u4f86\u53d6\u5f97\u7d50\u679c\u3002\u5b83\u6703\u56de\u50b3\u4e00\u500b DataFrame\uff0c\u5305\u542b\u901a\u904e\u689d\u4ef6\u7684\u6a19\u7684\u8207\u5c0d\u61c9\u7684\u6b04\u4f4d\u6578\u503c\u3002</p> <pre><code>def before_trading_start(context, data):\n    context.output = pipeline_output('my_pipeline')\n</code></pre> <p>\u9019\u4e9b\u7d50\u679c\u53ef\u7528\u4f86\u8a2d\u5b9a\u6bcf\u65e5\u7684\u6295\u8cc7\u6e05\u55ae\uff0c\u642d\u914d\u76ee\u6a19\u6b0a\u91cd\u9032\u884c\u518d\u5e73\u8861\u3002</p>"},{"location":"reference/zipline/data-object/#4-record","title":"4. record()","text":"<p><code>record()</code> \u53ef\u7528\u4f86\u5728\u56de\u6e2c\u904e\u7a0b\u4e2d\u8a18\u9304\u91cd\u8981\u8b8a\u6578\uff0c\u4f8b\u5982\u69d3\u687f\u6bd4\u7387\u3001\u73fe\u91d1\u6c34\u4f4d\u3001\u6295\u8cc7\u5831\u916c\u7b49\uff0c\u4e4b\u5f8c\u53ef\u7522\u88fd\u5716\u8868\u9032\u884c\u8996\u89ba\u5316\u5206\u6790\u3002</p> <pre><code>def handle_data(context, data):\n    record(leverage=context.account.leverage, cash=context.portfolio.cash)\n</code></pre> <p>\u8a18\u9304\u7684\u8b8a\u6578\u6703\u5728\u56de\u6e2c\u5b8c\u6210\u5f8c\uff0c\u81ea\u52d5\u986f\u793a\u65bc\u5716\u8868\u4e2d\u3002</p>"},{"location":"reference/zipline/data-object/#5-get_bundle_price","title":"5. get_bundle_price()","text":"<p><code>get_bundle_price()</code> \u662f TEJ \u5c08\u5c6c\u7684 Zipline \u64f4\u5145\u51fd\u6578\uff0c\u7528\u4f86\u8b80\u53d6\u67d0\u6bb5\u671f\u9593\u5167\u7684\u80a1\u7968\u6b77\u53f2\u8cc7\u6599\uff0c\u4e26\u4ee5 DataFrame \u7684\u5f62\u5f0f\u8f38\u51fa\uff0c\u9069\u5408\u7528\u65bc\u5206\u6790\u6216\u4f5c\u70ba\u5916\u90e8\u8f38\u5165\u8cc7\u6599\u3002</p> <pre><code>from zipline.data.data_portal import get_bundle_price\n\ndf = get_bundle_price(\n    bundle_name='tej_bundle',\n    calendar_name='XTAI',\n    start_dt='2020-01-01',\n    end_dt='2020-12-31'\n)\n</code></pre> <p>\u4f60\u53ef\u4ee5\u4f7f\u7528\u9019\u4efd\u8cc7\u6599\u505a\u70ba\u56de\u6e2c\u57fa\u790e\uff0c\u4e5f\u53ef\u4ee5\u642d\u914d TA-Lib \u6216\u81ea\u88fd\u56e0\u5b50\u9032\u884c\u8a08\u7b97\u3002</p>"},{"location":"reference/zipline/data-object/#6-portfolio","title":"6. portfolio \u7269\u4ef6","text":"<p><code>context.portfolio</code> \u63d0\u4f9b\u7576\u524d\u6295\u8cc7\u7d44\u5408\u7684\u7e3d\u89bd\u8cc7\u8a0a\uff0c\u5305\u542b\u7e3d\u8cc7\u7522\u3001\u73fe\u91d1\u9918\u984d\u3001\u6bcf\u6a94\u80a1\u7968\u7684\u6301\u80a1\u72c0\u6cc1\u7b49\uff0c\u662f\u76e3\u63a7\u90e8\u4f4d\u8207\u4e0b\u55ae\u908f\u8f2f\u7684\u91cd\u8981\u4f9d\u64da\u3002</p> <p>\u5e38\u898b\u5c6c\u6027\u5305\u62ec\uff1a</p> <ul> <li><code>portfolio.cash</code>\uff1a\u76ee\u524d\u6301\u6709\u7684\u73fe\u91d1</li> <li><code>portfolio.positions</code>\uff1a\u6bcf\u6a94\u6301\u80a1\u8cc7\u8a0a\uff08\u5305\u542b\u80a1\u6578\u3001\u6210\u672c\u3001\u6700\u65b0\u5e02\u503c\uff09</li> <li><code>portfolio.positions[symbol(\"2330\")].amount</code>\uff1a\u67d0\u6a94\u80a1\u7968\u7684\u6301\u80a1\u6578\u91cf</li> <li><code>portfolio.positions[symbol(\"2330\")].cost_basis</code>\uff1a\u8a72\u6a94\u80a1\u7968\u7684\u5e73\u5747\u6210\u672c</li> </ul> <pre><code>def handle_data(context, data):\n    cash = context.portfolio.cash\n    amount = context.portfolio.positions[symbol(\"2330\")].amount\n</code></pre>"},{"location":"reference/zipline/data-object/#7-account","title":"7. account \u7269\u4ef6","text":"<p><code>context.account</code> \u662f Zipline \u63d0\u4f9b\u7684\u5e33\u6236\u5c64\u7d1a\u8cc7\u8a0a\uff0c\u4e3b\u8981\u7528\u4f86\u8ffd\u8e64\u69d3\u687f\u4f7f\u7528\u3001\u6de8\u503c\u7b49\u7b56\u7565\u7e3d\u9ad4\u8ca1\u52d9\u72c0\u6cc1\u3002</p> <p>\u5e38\u898b\u5c6c\u6027\u5305\u62ec\uff1a</p> <ul> <li><code>account.leverage</code>\uff1a\u7576\u524d\u69d3\u687f\u6bd4\u7387</li> <li><code>account.net_leverage</code>\uff1a\u8003\u616e\u7a7a\u982d\u5f8c\u7684\u6de8\u69d3\u687f</li> <li><code>account.portfolio_value</code>\uff1a\u6574\u9ad4\u6295\u8cc7\u7d44\u5408\u50f9\u503c\uff08\u542b\u80a1\u7968\u8207\u73fe\u91d1\uff09</li> </ul> <pre><code>def handle_data(context, data):\n    record(leverage=context.account.leverage)\n</code></pre>"},{"location":"reference/zipline/data-object/#8-get_open_orders","title":"8. get_open_orders()","text":"<p><code>get_open_orders()</code> \u662f Zipline \u63d0\u4f9b\u7684\u67e5\u8a62\u51fd\u6578\uff0c\u53ef\u7528\u4f86\u6aa2\u8996\u76ee\u524d\u6709\u54ea\u4e9b\u639b\u55ae\u5c1a\u672a\u6210\u4ea4\uff08\u5982\u9650\u50f9\u55ae\u3001\u505c\u640d\u55ae\u7b49\uff09\u3002</p> <pre><code>open_orders = get_open_orders()\n</code></pre> <p>\u4f60\u4e5f\u53ef\u4ee5\u6307\u5b9a\u67d0\u4e00\u6a94\u80a1\u7968\u9032\u884c\u67e5\u8a62\uff1a</p> <pre><code>open_orders_tsmc = get_open_orders(symbol(\"2330\"))\n</code></pre> <p>\u56de\u50b3\u5167\u5bb9\u70ba dictionary \u683c\u5f0f\uff1a</p> <ul> <li>key \u70ba\u8cc7\u7522\uff08\u5982 <code>symbol(\"2330\")</code>\uff09</li> <li>value \u70ba\u8a72\u8cc7\u7522\u7684\u639b\u55ae\u5217\u8868</li> </ul> <p>\u901a\u5e38\u642d\u914d <code>cancel_order()</code> \u4f7f\u7528\uff0c\u53ef\u5728\u7279\u5b9a\u908f\u8f2f\u689d\u4ef6\u4e0b\u81ea\u52d5\u53d6\u6d88\u672a\u6210\u4ea4\u639b\u55ae\u3002</p>"},{"location":"reference/zipline/lifecycle-functions/","title":"Zipline \u56de\u6e2c\u751f\u547d\u9031\u671f\u51fd\u6578\u53c3\u8003","text":"<p>Info</p> <p>\u672c\u9801\u8a73\u7d30\u8aaa\u660e Zipline \u56de\u6e2c\u7684\u751f\u547d\u9031\u671f\u51fd\u6578\uff0c\u5305\u62ec <code>initialize()</code>\u3001<code>before_trading_start()</code>\u3001<code>handle_data()</code> \u548c <code>analyze()</code> \u7684\u7528\u9014\u3001\u57f7\u884c\u6642\u6a5f\u548c\u5e38\u898b\u64cd\u4f5c\uff0c\u5e6b\u52a9\u4f7f\u7528\u8005\u7de8\u5beb\u6709\u6548\u7684 Zipline \u7b56\u7565\u3002</p> <p>Zipline \u662f\u4e00\u500b\u4e8b\u4ef6\u9a45\u52d5\u7684\u56de\u6e2c\u6846\u67b6\uff0c\u5b83\u900f\u904e\u4e00\u7cfb\u5217\u5b9a\u7fa9\u597d\u7684\u751f\u547d\u9031\u671f\u51fd\u6578\u4f86\u57f7\u884c\u4ea4\u6613\u7b56\u7565\u3002\u7406\u89e3\u9019\u4e9b\u51fd\u6578\u7684\u7528\u9014\u548c\u57f7\u884c\u6642\u6a5f\uff0c\u5c0d\u65bc\u7de8\u5beb\u6709\u6548\u7684 Zipline \u7b56\u7565\u81f3\u95dc\u91cd\u8981\u3002</p> <p>\u672c\u6587\u4ef6\u5c07\u8a73\u7d30\u8aaa\u660e <code>initialize()</code>\u3001<code>before_trading_start()</code>\u3001<code>handle_data()</code> \u548c <code>analyze()</code> \u9019\u56db\u500b\u6838\u5fc3\u51fd\u6578\u3002</p>"},{"location":"reference/zipline/lifecycle-functions/#1-initializecontext","title":"1. initialize(context)","text":"<ul> <li>\u7528\u9014: \u7b56\u7565\u57f7\u884c\u524d\u7684\u521d\u59cb\u5316\u8a2d\u5b9a\u3002</li> <li>\u57f7\u884c\u6642\u6a5f: \u5728\u56de\u6e2c\u958b\u59cb\u6642\u50c5\u57f7\u884c \u4e00\u6b21\u3002</li> <li>\u53c3\u6578:<ul> <li><code>context</code>: \u4e00\u500b <code>dict</code> \u822c\u7684\u7269\u4ef6\uff0c\u7528\u65bc\u5728\u56de\u6e2c\u671f\u9593\u5132\u5b58\u548c\u50b3\u905e\u7b56\u7565\u7684\u72c0\u614b\u8cc7\u8a0a\u3002\u60a8\u53ef\u4ee5\u5728 <code>context</code> \u4e2d\u5b9a\u7fa9\u4efb\u4f55\u81ea\u5b9a\u7fa9\u8b8a\u6578\u3002</li> </ul> </li> </ul>"},{"location":"reference/zipline/lifecycle-functions/#11","title":"1.1\u5e38\u898b\u64cd\u4f5c","text":"<ul> <li>\u8a2d\u5b9a Benchmark: \u4f7f\u7528 <code>set_benchmark()</code>\u3002</li> <li>\u8a2d\u5b9a\u4ea4\u6613\u6210\u672c: \u4f7f\u7528 <code>set_commission()</code> \u548c <code>set_slippage()</code>\u3002</li> <li>\u8a2d\u5b9a\u4ea4\u6613\u63a7\u5236: \u4f7f\u7528 <code>set_max_leverage()</code> \u7b49\u3002</li> <li>\u9644\u639b Pipeline: \u4f7f\u7528 <code>attach_pipeline()</code>\u3002</li> <li>\u521d\u59cb\u5316\u81ea\u5b9a\u7fa9\u8b8a\u6578: \u4f8b\u5982 <code>context.has_ordered = False</code>\u3002</li> <li>\u8a2d\u5b9a\u6392\u7a0b\u51fd\u6578: \u4f7f\u7528 <code>schedule_function()</code>\u3002</li> </ul>"},{"location":"reference/zipline/lifecycle-functions/#12","title":"1.2\u7bc4\u4f8b","text":"<pre><code>from zipline.api import set_benchmark, symbol, set_commission, set_slippage, attach_pipeline\nfrom zipline.finance import commission, slippage\nfrom zipline.pipeline import Pipeline\nfrom zipline.pipeline.factors import SimpleMovingAverage\nfrom zipline.pipeline.data import EquityPricing\n\ndef make_my_pipeline():\n    # \u9019\u88e1\u5b9a\u7fa9\u4e00\u500b\u7c21\u55ae\u7684 Pipeline\n    return Pipeline(columns={'SMA': SimpleMovingAverage(inputs=[EquityPricing.close], window_length=20)})\n\ndef initialize(context):\n    context.my_stock = symbol('2330')\n    set_benchmark(symbol('IR0001')) # \u8a2d\u5b9aBenchmark\n    set_commission(equities=commission.PerDollar(cost=0.001)) # \u8a2d\u5b9a\u624b\u7e8c\u8cbb\n    set_slippage(equities=slippage.VolumeShareSlippage(volume_limit=0.025, price_impact=0.1)) # \u8a2d\u5b9a\u6ed1\u50f9\n    attach_pipeline(make_my_pipeline(), 'my_strategy_pipeline') # \u9644\u639b Pipeline\n    context.trading_signal_triggered = False # \u521d\u59cb\u5316\u81ea\u5b9a\u7fa9\u8b8a\u6578\n</code></pre>"},{"location":"reference/zipline/lifecycle-functions/#2-before_trading_startcontext-data","title":"2. before_trading_start(context, data)","text":"<ul> <li>\u7528\u9014: \u6bcf\u65e5\u76e4\u524d\u6578\u64da\u6e96\u5099\u548c\u6c7a\u7b56\u3002</li> <li>\u57f7\u884c\u6642\u6a5f: \u6bcf\u500b\u4ea4\u6613\u65e5 \u958b\u76e4\u524d \u57f7\u884c\u4e00\u6b21\uff0c\u5728 <code>handle_data()</code> \u4e4b\u524d\u3002</li> <li>\u53c3\u6578:<ul> <li><code>context</code>: \u7b56\u7565\u72c0\u614b\u7269\u4ef6\u3002</li> <li><code>data</code>: \u6578\u64da\u7269\u4ef6\uff0c\u63d0\u4f9b\u7576\u524d\u65e5\u671f\u4e4b\u524d\u6240\u6709\u53ef\u7528\u7684\u6b77\u53f2\u6578\u64da\u3002</li> </ul> </li> </ul>"},{"location":"reference/zipline/lifecycle-functions/#21","title":"2.1\u5e38\u898b\u64cd\u4f5c","text":"<ul> <li>\u6578\u64da\u9810\u8655\u7406: \u7372\u53d6\u6700\u65b0\u7684\u6b77\u53f2\u6578\u64da\u6216\u8a08\u7b97\u76e4\u524d\u6307\u6a19\u3002</li> <li>\u66f4\u65b0\u8cc7\u7522\u6c60 (Universe): \u57fa\u65bc\u76e4\u524d\u4fe1\u606f\u7be9\u9078\u51fa\u7576\u65e5\u8981\u95dc\u6ce8\u7684\u80a1\u7968\u3002</li> <li>\u6aa2\u7d22 Pipeline \u8f38\u51fa: \u7372\u53d6 Pipeline \u5728\u524d\u4e00\u4ea4\u6613\u65e5\u8a08\u7b97\u51fa\u7684\u56e0\u5b50\u503c\u6216\u4fe1\u865f\uff0c\u4e26\u5132\u5b58\u5230 <code>context</code> \u4e2d\uff0c\u4f9b <code>handle_data()</code> \u4f7f\u7528\u3002</li> </ul> <p>Important</p> <p><code>before_trading_start()</code> \u51fd\u6578 \u4e0d\u80fd \u7528\u65bc\u4e0b\u9054\u4ea4\u6613\u8a02\u55ae\u3002\u8a02\u55ae\u5fc5\u9808\u5728\u5e02\u5834\u958b\u653e\u6642\u9593\u5167\uff0c\u901a\u5e38\u5728 <code>handle_data()</code> \u4e2d\u57f7\u884c\u3002</p>"},{"location":"reference/zipline/lifecycle-functions/#22","title":"2.2\u7bc4\u4f8b","text":"<pre><code>from zipline.api import pipeline_output\n\ndef before_trading_start(context, data):\n    # \u7372\u53d6 Pipeline \u5728\u524d\u4e00\u4ea4\u6613\u65e5\u8a08\u7b97\u7684\u7d50\u679c\uff0c\u4e26\u5b58\u5132\u5230 context \u4e2d\n    context.pipeline_data = pipeline_output('my_strategy_pipeline')\n    # \u53ef\u4ee5\u9032\u884c\u4e00\u4e9b\u76e4\u524d\u6578\u64da\u7684\u7be9\u9078\u6216\u8655\u7406\n    if not context.pipeline_data.empty:\n        context.today_factors = context.pipeline_data['SMA']\n    else:\n        context.today_factors = None\n</code></pre>"},{"location":"reference/zipline/lifecycle-functions/#3-handle_datacontext-data","title":"3. handle_data(context, data)","text":"<ul> <li>\u7528\u9014: \u57f7\u884c\u6838\u5fc3\u4ea4\u6613\u908f\u8f2f\u3002</li> <li>\u57f7\u884c\u6642\u6a5f: \u5728\u56de\u6e2c\u7684\u6bcf\u500b\u6642\u9593\u55ae\u4f4d\uff08\u4f8b\u5982\uff0c\u6bcf\u65e5\u6216\u6bcf\u5206\u9418\uff09\u90fd\u6703\u88ab\u547c\u53eb\u3002</li> <li>\u53c3\u6578:<ul> <li><code>context</code>: \u7b56\u7565\u72c0\u614b\u7269\u4ef6\u3002</li> <li><code>data</code>: \u6578\u64da\u7269\u4ef6\uff0c\u63d0\u4f9b\u7576\u524d\u6642\u9593\u9ede\u53ef\u7528\u7684\u5e02\u5834\u6578\u64da\uff08\u4f8b\u5982\uff0c\u6700\u65b0\u50f9\u683c\u3001\u6210\u4ea4\u91cf\uff09\u3002</li> </ul> </li> </ul>"},{"location":"reference/zipline/lifecycle-functions/#31","title":"3.1\u5e38\u898b\u64cd\u4f5c","text":"<ul> <li>\u7372\u53d6\u5e02\u5834\u6578\u64da: \u4f7f\u7528 <code>data.current()</code> \u6216 <code>data.history()</code> \u7372\u53d6\u7576\u524d\u6216\u6b77\u53f2\u7684\u50f9\u683c\u3001\u6210\u4ea4\u91cf\u7b49\u4fe1\u606f\u3002</li> <li>\u8a08\u7b97\u4ea4\u6613\u4fe1\u865f: \u6839\u64da\u6280\u8853\u6307\u6a19\u3001\u56e0\u5b50\u503c\u6216\u5176\u4ed6\u908f\u8f2f\u5224\u65b7\u8cb7\u8ce3\u6642\u6a5f\u3002</li> <li>\u4e0b\u9054\u8a02\u55ae: \u4f7f\u7528 <code>order()</code>, <code>order_target()</code>, <code>order_percent()</code>, <code>order_target_percent()</code> \u7b49\u51fd\u6578\u57f7\u884c\u4ea4\u6613\u3002</li> <li>\u8a18\u9304\u6578\u64da: \u4f7f\u7528 <code>record()</code> \u51fd\u6578\u8a18\u9304\u60a8\u60f3\u8981\u5728\u56de\u6e2c\u7d50\u679c\u4e2d\u8ffd\u8e64\u7684\u6578\u64da\u3002</li> </ul>"},{"location":"reference/zipline/lifecycle-functions/#32","title":"3.2\u7bc4\u4f8b","text":"<pre><code>from zipline.api import order_target_percent\n\ndef handle_data(context, data):\n    # \u6aa2\u67e5\u662f\u5426\u6709 Pipeline \u6578\u64da\u53ef\u7528\n    if context.today_factors is None or context.my_stock not in context.today_factors.index:\n        return\n\n    current_sma = context.today_factors.loc[context.my_stock]\n    current_price = data.current(context.my_stock, 'price')\n\n    # \u7c21\u55ae\u7684\u5747\u7dda\u7a81\u7834\u7b56\u7565\uff1a\u5982\u679c\u80a1\u50f9\u9ad8\u65bc\u5747\u7dda\uff0c\u5247\u5168\u5009\u8cb7\u5165\n    if current_price &gt; current_sma and not context.trading_signal_triggered:\n        order_target_percent(context.my_stock, 1.0) # \u5168\u5009\u8cb7\u5165\n        context.trading_signal_triggered = True\n    # \u5982\u679c\u80a1\u50f9\u4f4e\u65bc\u5747\u7dda\uff0c\u4e14\u5df2\u6301\u6709\uff0c\u5247\u6e05\u5009\n    elif current_price &lt; current_sma and context.my_stock in context.portfolio.positions:\n        order_target_percent(context.my_stock, 0.0) # \u6e05\u5009\n        context.trading_signal_triggered = False\n\n    # \u8a18\u9304\u6578\u64da (\u4f8b\u5982\u80a1\u50f9\u548c\u5747\u7dda\uff0c\u65b9\u4fbf\u5206\u6790)\n    record(price=current_price, sma=current_sma)\n</code></pre>"},{"location":"reference/zipline/lifecycle-functions/#4-analyzecontext-results","title":"4. analyze(context, results)","text":"<ul> <li>\u7528\u9014: \u56de\u6e2c\u7d50\u675f\u5f8c\u7684\u7e3e\u6548\u5206\u6790\u548c\u8996\u89ba\u5316\u3002</li> <li>\u57f7\u884c\u6642\u6a5f: \u5728\u6574\u500b\u56de\u6e2c\u6d41\u7a0b\u5b8c\u6210\u5f8c\u50c5\u57f7\u884c \u4e00\u6b21\u3002</li> <li>\u53c3\u6578:<ul> <li><code>context</code>: \u7b56\u7565\u72c0\u614b\u7269\u4ef6 (\u8207 <code>initialize</code> \u548c <code>handle_data</code> \u4e2d\u7684 <code>context</code> \u76f8\u540c)\u3002</li> <li><code>results</code>: \u4e00\u500b <code>pandas.DataFrame</code>\uff0c\u5305\u542b\u4e86\u56de\u6e2c\u671f\u9593\u6bcf\u65e5\u7684\u7e3e\u6548\u6578\u64da (\u4f8b\u5982\uff0c\u5831\u916c\u7387\u3001\u8cc7\u91d1\u66f2\u7dda\u3001\u6700\u5927\u56de\u64a4\u7b49)\u3002</li> </ul> </li> </ul>"},{"location":"reference/zipline/lifecycle-functions/#41","title":"4.1\u5e38\u898b\u64cd\u4f5c","text":"<ul> <li>\u4f7f\u7528 Pyfolio \u7522\u751f Tearsheet: \u5c07 <code>results</code> \u6578\u64da\u50b3\u905e\u7d66 Pyfolio\uff0c\u751f\u6210\u6a19\u6e96\u7684\u7e3e\u6548\u5206\u6790\u5831\u8868\u3002</li> <li>\u81ea\u5b9a\u7fa9\u5716\u8868\u7e6a\u88fd: \u4f7f\u7528 Matplotlib \u6216 Seaborn \u7b49\u5eab\u7e6a\u88fd\u81ea\u5b9a\u7fa9\u7684\u7e3e\u6548\u5716\u8868\u3002</li> <li>\u8a08\u7b97\u81ea\u5b9a\u7fa9\u6307\u6a19: \u5f9e <code>results</code> \u4e2d\u63d0\u53d6\u6578\u64da\uff0c\u8a08\u7b97\u7b56\u7565\u7279\u6709\u7684\u6307\u6a19\u3002</li> </ul>"},{"location":"reference/zipline/lifecycle-functions/#42","title":"4.2\u7bc4\u4f8b","text":"<pre><code>import matplotlib.pyplot as plt\nimport pyfolio\nfrom pyfolio.utils import extract_rets_pos_txn_from_zipline\n\ndef analyze(context, results):\n    # \u7e6a\u88fd\u6295\u8cc7\u7d44\u5408\u50f9\u503c\u66f2\u7dda\n    results['portfolio_value'].plot(figsize=(10, 6))\n    plt.title('Portfolio Value Over Time')\n    plt.xlabel('Date')\n    plt.ylabel('Portfolio Value')\n    plt.grid(True)\n    plt.show()\n\n    # \u4f7f\u7528 Pyfolio \u751f\u6210\u7e3e\u6548\u5831\u8868\n    returns, positions, transactions = extract_rets_pos_txn_from_zipline(results)\n    benchmark_rets = results.benchmark_return # \u5047\u8a2d benchmark_return \u5b58\u5728\u65bc results \u4e2d\n\n    # \u6642\u5340\u6a19\u6e96\u5316 (\u70ba Pyfolio \u6e96\u5099)\n    returns.index = returns.index.tz_localize(None).tz_localize('UTC')\n    positions.index = positions.index.tz_localize(None).tz_localize('UTC')\n    transactions.index = transactions.index.tz_localize(None).tz_localize('UTC')\n    benchmark_rets.index = benchmark_rets.index.tz_localize(None).tz_localize('UTC')\n\n    pyfolio.tears.create_full_tear_sheet(\n        returns=returns,\n        positions=positions,\n        transactions=transactions,\n        benchmark_rets=benchmark_rets\n    )\n    plt.show() # \u78ba\u4fdd Pyfolio \u7684\u5716\u8868\u986f\u793a\n</code></pre>"},{"location":"reference/zipline/orders/","title":"Zipline \u4e0b\u55ae\u51fd\u6578\u53c3\u8003","text":"<p>Info</p> <p>\u672c\u9801\u8a73\u7d30\u8aaa\u660e Zipline \u4e2d\u7684\u4e0b\u55ae\u51fd\u6578\uff0c\u5305\u62ec <code>order()</code>\u3001<code>order_target()</code>\u3001<code>order_percent()</code> \u7b49\u7684\u7528\u9014\u3001\u53c3\u6578\u548c\u4f7f\u7528\u7bc4\u4f8b\uff0c\u5e6b\u52a9\u4f7f\u7528\u8005\u5c07\u7b56\u7565\u4fe1\u865f\u8f49\u5316\u70ba\u5be6\u969b\u4ea4\u6613\u884c\u70ba\u3002</p> <p>\u5728 Zipline \u56de\u6e2c\u4e2d\uff0c\u4e0b\u55ae\u662f\u5c07\u7b56\u7565\u4fe1\u865f\u8f49\u5316\u70ba\u5be6\u969b\u4ea4\u6613\u884c\u70ba\u7684\u95dc\u9375\u74b0\u7bc0\u3002Zipline \u63d0\u4f9b\u4e86\u591a\u7a2e\u4e0b\u55ae\u51fd\u6578\uff0c\u4ee5\u61c9\u5c0d\u4e0d\u540c\u7b56\u7565\u908f\u8f2f\u548c\u98a8\u96aa\u7ba1\u7406\u9700\u6c42\u3002\u9019\u4e9b\u51fd\u6578\u4e3b\u8981\u7522\u751f \u5e02\u50f9\u55ae\uff0c\u4e26\u5728\u6bcf\u500b <code>handle_data()</code> \u547c\u53eb\u7684\u672b\u5c3e\u9032\u884c\u64ae\u5408\u3002</p> <p>\u7406\u89e3\u4e0d\u540c\u4e0b\u55ae\u51fd\u6578\u7684\u7279\u6027\uff0c\u5c0d\u65bc\u7cbe\u78ba\u6a21\u64ec\u7b56\u7565\u884c\u70ba\u548c\u907f\u514d\u610f\u5916\u7684\u4ea4\u6613\u7d50\u679c\u81f3\u95dc\u91cd\u8981\u3002</p>"},{"location":"reference/zipline/orders/#1","title":"1. \u4e0b\u55ae\u51fd\u6578\u7c21\u4ecb","text":"<p>Zipline \u7684\u4e0b\u55ae\u51fd\u6578\u901a\u5e38\u5728 <code>handle_data()</code> \u4e2d\u88ab\u547c\u53eb\uff0c\u5b83\u5011\u6703\u5411\u56de\u6e2c\u5f15\u64ce\u767c\u9001\u4ea4\u6613\u6307\u4ee4\u3002Zipline \u7684\u6838\u5fc3\u8a2d\u8a08\u662f\u8655\u7406 \u5e02\u50f9\u55ae\uff0c\u5373\u5047\u8a2d\u8a02\u55ae\u6703\u4ee5\u7576\u524d\u5e02\u5834\u50f9\u683c\u6210\u4ea4\u3002</p> <p>Zipline \u7684\u4e0b\u55ae\u51fd\u6578\u53ef\u4ee5\u5206\u70ba\u5169\u5927\u985e\uff1a *   \u76f4\u63a5\u4e0b\u55ae: \u6839\u64da\u6307\u5b9a\u7684\u80a1\u6578\u3001\u767e\u5206\u6bd4\u6216\u91d1\u984d\u76f4\u63a5\u767c\u51fa\u8cb7\u5165\u6216\u8ce3\u51fa\u8a02\u55ae\u3002 *   \u76ee\u6a19\u4e0b\u55ae: \u6839\u64da\u6307\u5b9a\u7684\u76ee\u6a19\u80a1\u6578\u3001\u76ee\u6a19\u767e\u5206\u6bd4\u6216\u76ee\u6a19\u91d1\u984d\uff0c\u7531 Zipline \u81ea\u52d5\u8a08\u7b97\u6240\u9700\u8cb7\u8ce3\u7684\u6578\u91cf\u4ee5\u9054\u5230\u76ee\u6a19\u3002\u9019\u7a2e\u65b9\u5f0f\u5728\u7b56\u7565\u9700\u8981\u518d\u5e73\u8861\u6216\u8abf\u6574\u6301\u5009\u6642\u7279\u5225\u6709\u7528\u3002</p> <p>Note</p> <p>\u6839\u64da Zipline \u7248\u672c 2.1.0 \u7684\u66f4\u65b0\uff0c<code>order_value()</code>\u3001<code>order_target_value()</code>\u3001<code>order_percent()</code> \u548c <code>order_target_percent()</code> \u51fd\u6578\u5728\u8a08\u7b97\u6578\u91cf\u548c\u76ee\u6a19\u91d1\u984d\u6642\uff0c\u6703\u57fa\u65bc \u7576\u524d\u4ea4\u6613\u50f9\u683c\uff08\u800c\u975e\u524d\u4e00\u65e5\u7684\u6536\u76e4\u50f9\uff09\uff0c\u9019\u6709\u52a9\u65bc\u66f4\u7cbe\u78ba\u5730\u6a21\u64ec\u5728\u591a\u8b8a\u5e02\u5834\u689d\u4ef6\u4e0b\u7684\u4ea4\u6613\u3002</p>"},{"location":"reference/zipline/orders/#2-ziplineapiorder","title":"2. zipline.api.order()\uff1a\u76f4\u63a5\u4e0b\u55ae\u6307\u5b9a\u80a1\u6578","text":"<p><code>zipline.api.order()</code> \u51fd\u6578\u7528\u65bc\u76f4\u63a5\u8cb7\u5165\u6216\u8ce3\u51fa\u6307\u5b9a\u6578\u91cf\u7684\u80a1\u7968\u3002</p> <ul> <li>\u7528\u9014: \u76f4\u63a5\u4e0b\u9054\u8cb7\u5165 (<code>amount &gt; 0</code>) \u6216\u8ce3\u51fa (<code>amount &lt; 0</code>) \u6307\u5b9a\u80a1\u6578\u7684\u5e02\u50f9\u55ae\u3002</li> <li>\u53c3\u6578:<ul> <li><code>asset</code>: (Asset) \u6b32\u4ea4\u6613\u7684\u8cc7\u7522\u7269\u4ef6\u3002</li> <li><code>amount</code>: (int) \u6b32\u4ea4\u6613\u7684\u80a1\u6578\u3002\u6b63\u6578\u8868\u793a\u8cb7\u5165\uff0c\u8ca0\u6578\u8868\u793a\u8ce3\u51fa\u3002</li> </ul> </li> </ul>"},{"location":"reference/zipline/orders/#_1","title":"\u7bc4\u4f8b","text":"<pre><code>from zipline.api import order, symbol\n\ndef handle_data(context, data):\n    my_stock = symbol('2330')\n\n    # \u8cb7\u5165 1000 \u80a1\u53f0\u7a4d\u96fb\n    order(my_stock, 1000) \n\n    # \u8ce3\u51fa 500 \u80a1\u53f0\u7a4d\u96fb\n    order(my_stock, -500)\n</code></pre>"},{"location":"reference/zipline/orders/#3-ziplineapiorder_target","title":"3. zipline.api.order_target()\uff1a\u4ea4\u6613\u5230\u76ee\u6a19\u80a1\u6578","text":"<p><code>zipline.api.order_target()</code> \u51fd\u6578\u6703\u8a08\u7b97\u7576\u524d\u6301\u80a1\u8207\u76ee\u6a19\u80a1\u6578\u4e4b\u9593\u7684\u5dee\u984d\uff0c\u7136\u5f8c\u4e0b\u9054\u76f8\u61c9\u7684\u8cb7\u8ce3\u8a02\u55ae\uff0c\u4f7f\u8a72\u8cc7\u7522\u7684\u7e3d\u6301\u80a1\u6578\u91cf\u9054\u5230\u6307\u5b9a\u7684\u76ee\u6a19\u3002</p> <ul> <li>\u7528\u9014: \u8abf\u6574\u8cc7\u7522\u7684\u6301\u80a1\u6578\u91cf\u5230\u6307\u5b9a\u76ee\u6a19\u3002</li> <li>\u53c3\u6578:<ul> <li><code>asset</code>: (Asset) \u6b32\u4ea4\u6613\u7684\u8cc7\u7522\u7269\u4ef6\u3002</li> <li><code>target_amount</code>: (int) \u8a72\u8cc7\u7522\u7684\u76ee\u6a19\u7e3d\u6301\u80a1\u6578\u91cf\u3002</li> </ul> </li> </ul>"},{"location":"reference/zipline/orders/#_2","title":"\u7bc4\u4f8b","text":"<pre><code>from zipline.api import order_target, symbol\n\ndef handle_data(context, data):\n    my_stock = symbol('2330')\n\n    # \u5c07\u53f0\u7a4d\u96fb\u7684\u6301\u80a1\u6578\u91cf\u8abf\u6574\u5230 2000 \u80a1\n    order_target(my_stock, 2000)\n\n    # \u6e05\u7a7a\u53f0\u7a4d\u96fb\u7684\u6301\u80a1\uff08\u5c07\u6301\u80a1\u6578\u91cf\u8abf\u6574\u5230 0\uff09\n    order_target(my_stock, 0)\n</code></pre>"},{"location":"reference/zipline/orders/#4-ziplineapiorder_percent","title":"4. zipline.api.order_percent()\uff1a\u6309\u6295\u8cc7\u7d44\u5408\u767e\u5206\u6bd4\u4e0b\u55ae","text":"<p><code>zipline.api.order_percent()</code> \u51fd\u6578\u6703\u8a08\u7b97\u7576\u524d\u6295\u8cc7\u7d44\u5408\u7e3d\u50f9\u503c\u7684\u4e00\u500b\u767e\u5206\u6bd4\uff0c\u7136\u5f8c\u5c07\u9019\u500b\u91d1\u984d\u8f49\u63db\u70ba\u80a1\u6578\uff0c\u4e26\u4e0b\u9054\u8cb7\u8ce3\u8a02\u55ae\u3002</p> <ul> <li>\u7528\u9014: \u6309\u6295\u8cc7\u7d44\u5408\u7e3d\u50f9\u503c\u7684\u4e00\u500b\u767e\u5206\u6bd4 (<code>percent</code>) \u4e0b\u55ae\u3002</li> <li>\u53c3\u6578:<ul> <li><code>asset</code>: (Asset) \u6b32\u4ea4\u6613\u7684\u8cc7\u7522\u7269\u4ef6\u3002</li> <li><code>percent</code>: (float) \u4f54\u6295\u8cc7\u7d44\u5408\u7e3d\u50f9\u503c\u7684\u767e\u5206\u6bd4\uff08\u4ee5\u5c0f\u6578\u8868\u793a\uff0c\u4f8b\u5982 <code>0.1</code> \u4ee3\u8868 10%\uff09\u3002\u6b63\u6578\u70ba\u8cb7\u5165\uff0c\u8ca0\u6578\u70ba\u8ce3\u51fa\u3002</li> </ul> </li> </ul>"},{"location":"reference/zipline/orders/#_3","title":"\u7bc4\u4f8b","text":"<pre><code>from zipline.api import order_percent, symbol\n\ndef handle_data(context, data):\n    my_stock = symbol('2330')\n\n    # \u5c07\u6295\u8cc7\u7d44\u5408\u7e3d\u50f9\u503c\u7684 10% \u7528\u65bc\u8cb7\u5165\u53f0\u7a4d\u96fb\n    order_percent(my_stock, 0.1)\n\n    # \u8ce3\u51fa\u6295\u8cc7\u7d44\u5408\u7e3d\u50f9\u503c\u7684 5% \u7684\u53f0\u7a4d\u96fb\n    order_percent(my_stock, -0.05)\n</code></pre>"},{"location":"reference/zipline/orders/#5-ziplineapiorder_target_percent","title":"5. zipline.api.order_target_percent()\uff1a\u4ea4\u6613\u5230\u76ee\u6a19\u6295\u8cc7\u7d44\u5408\u767e\u5206\u6bd4","text":"<p><code>zipline.api.order_target_percent()</code> \u51fd\u6578\u6703\u8a08\u7b97\u6240\u9700\u7684\u4ea4\u6613\u91cf\uff0c\u4f7f\u8a72\u8cc7\u7522\u5728\u6295\u8cc7\u7d44\u5408\u4e2d\u7684\u6b0a\u91cd\u9054\u5230\u6307\u5b9a\u7684\u76ee\u6a19\u767e\u5206\u6bd4\u3002\u9019\u662f\u6700\u5e38\u7528\u65bc\u518d\u5e73\u8861\u7b56\u7565\u7684\u51fd\u6578\u4e4b\u4e00\u3002</p> <ul> <li>\u7528\u9014: \u8abf\u6574\u8cc7\u7522\u5728\u6295\u8cc7\u7d44\u5408\u4e2d\u7684\u6b0a\u91cd\u5230\u6307\u5b9a\u76ee\u6a19\u767e\u5206\u6bd4\u3002</li> <li>\u53c3\u6578:<ul> <li><code>asset</code>: (Asset) \u6b32\u4ea4\u6613\u7684\u8cc7\u7522\u7269\u4ef6\u3002</li> <li><code>target_percent</code>: (float) \u8a72\u8cc7\u7522\u5728\u6295\u8cc7\u7d44\u5408\u4e2d\u7684\u76ee\u6a19\u6b0a\u91cd\u767e\u5206\u6bd4\u3002</li> </ul> </li> </ul>"},{"location":"reference/zipline/orders/#_4","title":"\u7bc4\u4f8b","text":"<pre><code>from zipline.api import order_target_percent, symbol\n\ndef handle_data(context, data):\n    my_stock = symbol('2330')\n\n    # \u5c07\u53f0\u7a4d\u96fb\u5728\u6295\u8cc7\u7d44\u5408\u4e2d\u7684\u6b0a\u91cd\u8abf\u6574\u5230 50%\n    order_target_percent(my_stock, 0.5)\n\n    # \u6e05\u7a7a\u53f0\u7a4d\u96fb\u7684\u6301\u80a1\uff08\u5c07\u6b0a\u91cd\u8abf\u6574\u5230 0%\uff09\n    order_target_percent(my_stock, 0.0)\n</code></pre>"},{"location":"reference/zipline/orders/#6-ziplineapiorder_value","title":"6. zipline.api.order_value()\uff1a\u76f4\u63a5\u4e0b\u55ae\u6307\u5b9a\u91d1\u984d","text":"<p><code>zipline.api.order_value()</code> \u51fd\u6578\u6703\u8a08\u7b97\u8cfc\u8cb7\u6216\u51fa\u552e\u6307\u5b9a\u91d1\u984d\u8cc7\u7522\u6240\u9700\u7684\u80a1\u6578\uff0c\u7136\u5f8c\u4e0b\u9054\u5e02\u50f9\u55ae\u3002</p> <ul> <li>\u7528\u9014: \u76f4\u63a5\u4e0b\u9054\u8cb7\u5165 (<code>value &gt; 0</code>) \u6216\u8ce3\u51fa (<code>value &lt; 0</code>) \u6307\u5b9a\u91d1\u984d\u7684\u5e02\u50f9\u55ae\u3002</li> <li>\u53c3\u6578:<ul> <li><code>asset</code>: (Asset) \u6b32\u4ea4\u6613\u7684\u8cc7\u7522\u7269\u4ef6\u3002</li> <li><code>value</code>: (float) \u6b32\u4ea4\u6613\u7684\u91d1\u984d\u3002\u6b63\u6578\u8868\u793a\u8cb7\u5165\uff0c\u8ca0\u6578\u8868\u793a\u8ce3\u51fa\u3002</li> </ul> </li> </ul>"},{"location":"reference/zipline/orders/#_5","title":"\u7bc4\u4f8b","text":"<pre><code>from zipline.api import order_value, symbol\n\ndef handle_data(context, data):\n    my_stock = symbol('2330')\n\n    # \u8cb7\u5165\u50f9\u503c 10,000 \u5143\u7684\u53f0\u7a4d\u96fb\n    order_value(my_stock, 10000)\n\n    # \u8ce3\u51fa\u50f9\u503c 5,000 \u5143\u7684\u53f0\u7a4d\u96fb\n    order_value(my_stock, -5000)\n</code></pre>"},{"location":"reference/zipline/orders/#7-ziplineapiorder_target_value","title":"7. zipline.api.order_target_value()\uff1a\u4ea4\u6613\u5230\u76ee\u6a19\u91d1\u984d","text":"<p><code>zipline.api.order_target_value()</code> \u51fd\u6578\u6703\u8a08\u7b97\u6240\u9700\u7684\u4ea4\u6613\u91cf\uff0c\u4f7f\u8a72\u8cc7\u7522\u7684\u7e3d\u5e02\u503c\u9054\u5230\u6307\u5b9a\u7684\u76ee\u6a19\u91d1\u984d\u3002</p> <ul> <li>\u7528\u9014: \u8abf\u6574\u8cc7\u7522\u7684\u7e3d\u5e02\u503c\u5230\u6307\u5b9a\u76ee\u6a19\u3002</li> <li>\u53c3\u6578:<ul> <li><code>asset</code>: (Asset) \u6b32\u4ea4\u6613\u7684\u8cc7\u7522\u7269\u4ef6\u3002</li> <li><code>target_value</code>: (float) \u8a72\u8cc7\u7522\u7684\u76ee\u6a19\u7e3d\u5e02\u503c\u3002</li> </ul> </li> </ul>"},{"location":"reference/zipline/orders/#_6","title":"\u7bc4\u4f8b","text":"<pre><code>from zipline.api import order_target_value, symbol\n\ndef handle_data(context, data):\n    my_stock = symbol('2330')\n\n    # \u5c07\u53f0\u7a4d\u96fb\u7684\u6301\u80a1\u5e02\u503c\u8abf\u6574\u5230 50,000 \u5143\n    order_target_value(my_stock, 50000)\n\n    # \u6e05\u7a7a\u53f0\u7a4d\u96fb\u7684\u6301\u80a1\uff08\u5c07\u5e02\u503c\u8abf\u6574\u5230 0 \u5143\uff09\n    order_target_value(my_stock, 0)\n</code></pre>"},{"location":"reference/zipline/scheduling-functions/","title":"Zipline \u6392\u7a0b\u51fd\u6578\u53c3\u8003","text":"<p>Info</p> <p>\u672c\u9801\u8a73\u7d30\u8aaa\u660e Zipline \u6392\u7a0b\u51fd\u6578\uff0c\u5305\u62ec <code>schedule_function()</code> \u7684\u7528\u6cd5\u3001\u65e5\u671f\u898f\u5247 (<code>date_rules</code>) \u548c\u6642\u9593\u898f\u5247 (<code>time_rules</code>) \u7684\u8a2d\u5b9a\uff0c\u5e6b\u52a9\u4f7f\u7528\u8005\u7cbe\u78ba\u63a7\u5236\u56de\u6e2c\u4efb\u52d9\u7684\u57f7\u884c\u6642\u6a5f\u3002</p> <p>\u5728 Zipline \u56de\u6e2c\u4e2d\uff0c\u7b56\u7565\u901a\u5e38\u9700\u8981\u5b9a\u671f\u57f7\u884c\u67d0\u4e9b\u4efb\u52d9\uff0c\u4f8b\u5982 \u6bcf\u65e5\u7684\u518d\u5e73\u8861 \u3001 \u6bcf\u6708\u521d\u7684\u8cc7\u7522\u7be9\u9078 \uff0c\u6216\u8005\u5728\u7279\u5b9a\u7684\u6642\u9593\u9ede\u57f7\u884c\u67d0\u4e9b\u5206\u6790\u3002Zipline \u63d0\u4f9b\u4e86\u5f37\u5927\u7684\u6392\u7a0b\u51fd\u6578\u529f\u80fd\uff0c\u8b93\u60a8\u53ef\u4ee5\u7cbe\u78ba\u5730\u63a7\u5236\u9019\u4e9b\u4efb\u52d9\u7684\u57f7\u884c\u6642\u6a5f\u3002</p> <p>\u6838\u5fc3\u7684\u6392\u7a0b\u51fd\u6578\u662f <code>schedule_function()</code>\uff0c\u5b83\u7d50\u5408\u4e86\u65e5\u671f\u898f\u5247 (<code>date_rules</code>) \u548c\u6642\u9593\u898f\u5247 (<code>time_rules</code>) \u4f86\u5b9a\u7fa9\u4efb\u52d9\u7684\u57f7\u884c\u983b\u7387\u3002</p>"},{"location":"reference/zipline/scheduling-functions/#1-schedule_function","title":"1. schedule_function() \u51fd\u6578","text":"<p><code>zipline.api.schedule_function()</code> \u7528\u65bc\u5c07\u4e00\u500b\u81ea\u5b9a\u7fa9\u51fd\u6578\u6392\u7a0b\u5230\u672a\u4f86\u7684\u7279\u5b9a\u6642\u9593\u9ede\u57f7\u884c\u3002\u5b83\u901a\u5e38\u5728 <code>initialize()</code> \u51fd\u6578\u4e2d\u547c\u53eb\u3002</p> <pre><code>from zipline.api import schedule_function\n# \u4ea6\u9700\u5c0e\u5165 date_rules \u548c time_rules\nfrom zipline.api import date_rules, time_rules\nimport datetime\n</code></pre>"},{"location":"reference/zipline/scheduling-functions/#_1","title":"\u4e3b\u8981\u53c3\u6578\uff1a","text":"<ul> <li><code>func</code>: (callable) \u6b32\u6392\u7a0b\u57f7\u884c\u7684\u51fd\u6578\u3002\u6b64\u51fd\u6578\u5fc5\u9808\u63a5\u53d7 <code>context</code> \u548c <code>data</code> \u4f5c\u70ba\u53c3\u6578\u3002</li> <li><code>date_rule</code>: (zipline.api.date_rules \u7269\u4ef6) \u5b9a\u7fa9\u51fd\u6578\u57f7\u884c\u7684\u65e5\u671f\u983b\u7387\u3002</li> <li><code>time_rule</code>: (zipline.api.time_rules \u7269\u4ef6, \u53ef\u9078) \u5b9a\u7fa9\u51fd\u6578\u5728\u4ea4\u6613\u65e5\u4e2d\u57f7\u884c\u7684\u5177\u9ad4\u6642\u9593\u9ede\u3002\u9810\u8a2d\u70ba <code>time_rules.market_open()</code>\u3002</li> <li><code>half_days</code>: (bool, \u53ef\u9078) \u82e5\u70ba <code>True</code>\uff0c\u5247\u51fd\u6578\u4e5f\u6703\u5728\u534a\u5929\u4ea4\u6613\u65e5\u57f7\u884c\u3002\u9810\u8a2d\u70ba <code>False</code>\u3002</li> <li><code>calendar_days</code>: (bool, \u53ef\u9078) \u82e5\u70ba <code>True</code>\uff0c\u5247\u51fd\u6578\u6703\u5728\u65e5\u66c6\u65e5\u57f7\u884c\uff0c\u800c\u4e0d\u50c5\u9650\u65bc\u4ea4\u6613\u65e5\u3002\u9810\u8a2d\u70ba <code>False</code>\u3002</li> <li><code>exception_rules</code>: (zipline.api.date_rules \u7269\u4ef6, \u53ef\u9078) \u6307\u5b9a\u4e0d\u57f7\u884c\u51fd\u6578\u7684\u65e5\u671f\u898f\u5247\u3002</li> </ul>"},{"location":"reference/zipline/scheduling-functions/#2-date_rules","title":"2. \u65e5\u671f\u898f\u5247 (date_rules)","text":"<p><code>date_rules</code> \u7528\u65bc\u5b9a\u7fa9 <code>schedule_function()</code> \u7684\u65e5\u671f\u89f8\u767c\u689d\u4ef6\u3002</p> <ul> <li>\u5c0e\u5165: <code>from zipline.api import date_rules</code></li> </ul>"},{"location":"reference/zipline/scheduling-functions/#_2","title":"\u5e38\u898b\u65e5\u671f\u898f\u5247\uff1a","text":"<ul> <li> <p><code>date_rules.every_day()</code>: \u6bcf\u500b\u4ea4\u6613\u65e5\u57f7\u884c\u3002     <pre><code>schedule_function(my_daily_task, date_rules.every_day())\n</code></pre></p> </li> <li> <p><code>date_rules.week_start(days_offset=0)</code>: \u6bcf\u9031\u7684\u7b2c\u4e00\u500b\u4ea4\u6613\u65e5\u57f7\u884c\u3002<code>days_offset</code> \u53ef\u7528\u65bc\u5f9e\u7b2c\u4e00\u500b\u4ea4\u6613\u65e5\u504f\u79fb\uff0c\u4f8b\u5982 <code>days_offset=1</code> \u8868\u793a\u6bcf\u9031\u7b2c\u4e8c\u500b\u4ea4\u6613\u65e5\u3002     <pre><code>schedule_function(my_weekly_task, date_rules.week_start()) # \u6bcf\u9031\u4e00\u57f7\u884c\nschedule_function(my_weekly_task_offset, date_rules.week_start(days_offset=2)) # \u6bcf\u9031\u4e09\u57f7\u884c (\u9031\u4e00+2\u5929)\n</code></pre></p> </li> <li> <p><code>date_rules.month_start(days_offset=0)</code>: \u6bcf\u6708\u7684\u7b2c\u4e00\u500b\u4ea4\u6613\u65e5\u57f7\u884c\u3002     <pre><code>schedule_function(my_monthly_task, date_rules.month_start()) # \u6bcf\u6708\u7b2c\u4e00\u500b\u4ea4\u6613\u65e5\u57f7\u884c\n</code></pre></p> </li> <li> <p><code>date_rules.month_end(days_offset=0)</code>: \u6bcf\u6708\u7684\u6700\u5f8c\u4e00\u500b\u4ea4\u6613\u65e5\u57f7\u884c\u3002     <pre><code>schedule_function(my_monthly_end_task, date_rules.month_end()) # \u6bcf\u6708\u6700\u5f8c\u4e00\u500b\u4ea4\u6613\u65e5\u57f7\u884c\n</code></pre></p> </li> </ul>"},{"location":"reference/zipline/scheduling-functions/#3-time_rules","title":"3. \u6642\u9593\u898f\u5247 (time_rules)","text":"<p><code>time_rules</code> \u7528\u65bc\u5b9a\u7fa9 <code>schedule_function()</code> \u5728\u7b26\u5408 <code>date_rules</code> \u7684\u4ea4\u6613\u65e5\u4e2d\uff0c\u5177\u9ad4\u5728\u4ec0\u9ebc\u6642\u9593\u9ede\u57f7\u884c\u3002</p> <ul> <li>\u5c0e\u5165: <code>from zipline.api import time_rules</code></li> </ul>"},{"location":"reference/zipline/scheduling-functions/#_3","title":"\u5e38\u898b\u6642\u9593\u898f\u5247\uff1a","text":"<ul> <li> <p><code>time_rules.market_open(minutes=0)</code>: \u5728\u5e02\u5834\u958b\u76e4\u6642\u57f7\u884c\u3002<code>minutes</code> \u53c3\u6578\u53ef\u4ee5\u6307\u5b9a\u5728\u958b\u76e4\u5f8c\u504f\u79fb\u7684\u5206\u9418\u6578\u3002     <pre><code>schedule_function(my_open_task, date_rules.every_day(), time_rules.market_open()) # \u6bcf\u5929\u958b\u76e4\u57f7\u884c\nschedule_function(my_open_delay_task, date_rules.every_day(), time_rules.market_open(minutes=30)) # \u6bcf\u5929\u958b\u76e4\u5f8c30\u5206\u9418\u57f7\u884c\n</code></pre></p> </li> <li> <p><code>time_rules.market_close(minutes=0)</code>: \u5728\u5e02\u5834\u6536\u76e4\u6642\u57f7\u884c\u3002<code>minutes</code> \u53c3\u6578\u53ef\u4ee5\u6307\u5b9a\u5728\u6536\u76e4\u524d\u504f\u79fb\u7684\u5206\u9418\u6578\uff08\u8ca0\u503c\uff09\u6216\u6536\u76e4\u5f8c\u504f\u79fb\u7684\u5206\u9418\u6578\uff08\u6b63\u503c\uff09\u3002     <pre><code>schedule_function(my_close_task, date_rules.every_day(), time_rules.market_close()) # \u6bcf\u5929\u6536\u76e4\u57f7\u884c\nschedule_function(my_close_before_task, date_rules.every_day(), time_rules.market_close(minutes=-10)) # \u6bcf\u5929\u6536\u76e4\u524d10\u5206\u9418\u57f7\u884c\n</code></pre></p> </li> <li> <p><code>time_rules.before_market_open(minutes=0)</code>: \u5728\u5e02\u5834\u958b\u76e4\u524d\u57f7\u884c\u3002<code>minutes</code> \u53c3\u6578\u6307\u5b9a\u958b\u76e4\u524d\u591a\u5c11\u5206\u9418\u3002     <pre><code>schedule_function(my_pre_open_task, date_rules.every_day(), time_rules.before_market_open(minutes=10)) # \u6bcf\u5929\u958b\u76e4\u524d10\u5206\u9418\u57f7\u884c\n</code></pre></p> </li> <li> <p><code>time_rules.after_market_close(minutes=0)</code>: \u5728\u5e02\u5834\u6536\u76e4\u5f8c\u57f7\u884c\u3002<code>minutes</code> \u53c3\u6578\u6307\u5b9a\u6536\u76e4\u5f8c\u591a\u5c11\u5206\u9418\u3002     <pre><code>schedule_function(my_post_close_task, date_rules.every_day(), time_rules.after_market_close(minutes=10)) # \u6bcf\u5929\u6536\u76e4\u5f8c10\u5206\u9418\u57f7\u884c\n</code></pre></p> </li> <li> <p><code>time_rules.at_time(dt_time)</code>: \u5728\u4ea4\u6613\u65e5\u4e2d\u7684\u7279\u5b9a\u6642\u9593\u57f7\u884c\u3002<code>dt_time</code> \u61c9\u70ba <code>datetime.time</code> \u7269\u4ef6\u3002     <pre><code>schedule_function(my_fixed_time_task, date_rules.every_day(), time_rules.at_time(datetime.time(10, 0))) # \u6bcf\u5929\u65e9\u4e0a10\u9ede\u57f7\u884c\n</code></pre></p> </li> </ul>"},{"location":"reference/zipline/scheduling-functions/#4","title":"4. \u5b8c\u6574\u7bc4\u4f8b","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u500b\u5b8c\u6574\u7684\u7a0b\u5f0f\u78bc\u7bc4\u4f8b\uff0c\u6f14\u793a\u5982\u4f55\u5728 <code>initialize()</code> \u51fd\u6578\u4e2d\u8a2d\u5b9a\u591a\u500b\u6392\u7a0b\u4efb\u52d9\u3002</p> <pre><code>import pandas as pd\nfrom zipline import run_algorithm\nfrom zipline.api import (\n    symbol,\n    order_target_percent,\n    record,\n    set_benchmark,\n    schedule_function,\n    date_rules,\n    time_rules\n)\nimport datetime\n\n# --- \u81ea\u5b9a\u7fa9\u4efb\u52d9\u51fd\u6578 ---\ndef rebalance_monthly(context, data):\n    # \u6bcf\u6708\u57f7\u884c\u7684\u518d\u5e73\u8861\u908f\u8f2f\n    current_price = data.current(context.my_asset, 'price')\n    if current_price is not None and not pd.isnull(current_price):\n        order_target_percent(context.my_asset, 0.5) # \u5c07\u4e00\u534a\u8cc7\u91d1\u6295\u5165\n        print(f\"[{data.current_dt.date()}] \u6bcf\u6708\u518d\u5e73\u8861: \u8cb7\u5165 {context.my_asset.symbol}\")\n\ndef log_daily_data(context, data):\n    # \u6bcf\u65e5\u57f7\u884c\u7684\u6578\u64da\u8a18\u9304\u908f\u8f2f\n    current_price = data.current(context.my_asset, 'price')\n    if current_price is not None and not pd.isnull(current_price):\n        record(price=current_price)\n        print(f\"[{data.current_dt.date()}] \u6bcf\u65e5\u8a18\u9304: {context.my_asset.symbol} \u50f9\u683c {current_price}\")\n\ndef pre_market_check(context, data):\n    # \u76e4\u524d\u57f7\u884c\u7684\u6aa2\u67e5\u908f\u8f2f\n    print(f\"[{data.current_dt.date()}] \u76e4\u524d\u6aa2\u67e5: \u5e02\u5834\u5373\u5c07\u958b\u76e4...\")\n\n\n# --- Zipline \u56de\u6e2c\u90e8\u5206 ---\ndef initialize(context):\n    context.my_asset = symbol('2330')\n    set_benchmark(symbol('IR0001'))\n\n    # 1. \u8a2d\u5b9a\u6bcf\u65e5\u6536\u76e4\u524d 10 \u5206\u9418\u8a18\u9304\u6578\u64da\n    schedule_function(\n        log_daily_data,\n        date_rules.every_day(),\n        time_rules.market_close(minutes=-10)\n    )\n\n    # 2. \u8a2d\u5b9a\u6bcf\u6708\u7b2c\u4e00\u500b\u4ea4\u6613\u65e5\u958b\u76e4\u6642\u9032\u884c\u518d\u5e73\u8861\n    schedule_function(\n        rebalance_monthly,\n        date_rules.month_start(),\n        time_rules.market_open()\n    )\n\n    # 3. \u8a2d\u5b9a\u6bcf\u5929\u958b\u76e4\u524d 5 \u5206\u9418\u9032\u884c\u76e4\u524d\u6aa2\u67e5\n    schedule_function(\n        pre_market_check,\n        date_rules.every_day(),\n        time_rules.before_market_open(minutes=5)\n    )\n\ndef handle_data(context, data):\n    pass # \u6838\u5fc3\u4ea4\u6613\u908f\u8f2f\u53ef\u4ee5\u653e\u5728\u9019\u88e1\uff0c\u4e5f\u53ef\u4ee5\u6392\u7a0b\u57f7\u884c\n\ndef analyze(context, results):\n    # \u5206\u6790\u7d50\u679c\n    final_portfolio_value = results.iloc[-1]['portfolio_value']\n    print(f\"\u6700\u7d42\u6295\u8cc7\u7d44\u5408\u50f9\u503c: {final_portfolio_value}\")\n\n# \u57f7\u884c\u56de\u6e2c\nresults = run_algorithm(\n    start=pd.Timestamp('2022-01-01', tz='UTC'),\n    end=pd.Timestamp('2023-01-01', tz='UTC'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    capital_base=1_000_000,\n    bundle='tquant'\n)\n</code></pre>"},{"location":"reference/zipline/slippage/","title":"\u6ed1\u50f9\u6a21\u578b\u4ecb\u7d39","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b Zipline \u4e2d\u6ed1\u50f9\u6a21\u578b\u7684\u8a73\u7d30\u4ecb\u7d39\uff0c\u5305\u62ec\u6ed1\u50f9\u7684\u6982\u5ff5\u3001\u5167\u5efa\u6ed1\u50f9\u6a21\u578b\u985e\u578b\u53ca\u5176\u7528\u9014\uff0c\u5e6b\u52a9\u4f7f\u7528\u8005\u7406\u89e3\u5982\u4f55\u6a21\u64ec\u4ea4\u6613\u6210\u672c\u3002</p> <ul> <li> <p>\u4ea4\u6613\u6210\u672c\uff08transaction costs\uff09\u88ab\u5ee3\u6cdb\u8a8d\u70ba\u662f\u5f71\u97ff\u6295\u8cc7\u7e3e\u6548\u7684\u91cd\u8981\u56e0\u7d20\u3002\u5b83\u5011\u4e0d\u50c5\u5f71\u97ff\u6295\u8cc7\u7e3e\u6548\uff0c\u9084\u5f71\u97ff\u4e86\u5c07\u8cc7\u7522\u8f49\u63db\u6210\u73fe\u91d1\u7684\u96e3\u6613\u5ea6\u3002</p> </li> <li> <p>\u5728\u771f\u5be6\u4e16\u754c\u7684\u4ea4\u6613\u4e2d\u5b58\u5728\u8a31\u591a\u7a2e\u985e\u7684\u4ea4\u6613\u6210\u672c\uff0c\u5176\u4e2d\u4e00\u7a2e\u662f\u9593\u63a5\u6210\u672c\uff08indirect cost\uff09\uff0c\u9593\u63a5\u6210\u672c\u5305\u542b\u4e86\u6ed1\u50f9\uff08slippage\uff09\u3001\u6d41\u52d5\u6027\uff08liquidity\uff09\u7b49\u3002\u56e0\u70ba\u80a1\u50f9\u96a8\u6642\u90fd\u5728\u8b8a\u52d5\uff0c\u4e0b\u55ae\u6642\u7684\u4e9b\u5fae\u6642\u9593\u5dee\u4e5f\u53ef\u80fd\u9020\u6210\u9810\u671f\u7684\u50f9\u683c\u8207\u6210\u4ea4\u50f9\u6709\u843d\u5dee\uff0c\u800c\u9019\u500b\u50f9\u5dee\u5c31\u662f\u6ed1\u50f9\u3002\u6d41\u52d5\u6027\u5247\u6703\u5f71\u97ff\u4ea4\u6613\u7684\u96e3\u6613\u5ea6\uff0c\u6211\u5011\u901a\u5e38\u53ef\u4ee5\u7528\u4ea4\u6613\u91cf\u4f86\u9593\u63a5\u8a55\u4f30\u6d41\u52d5\u6027\u3002\u82e5\u80a1\u7968\u5e73\u5747\u4f86\u8aaa\u4ea4\u6613\u91cf\u9ad8\uff0c\u5247\u901a\u5e38\u4ee3\u8868\u8a72\u80a1\u7968\u6d41\u52d5\u6027\u9ad8\u3001\u53ef\u4ee5\u8fc5\u901f\u9032\u884c\u4ea4\u6613\uff0c\u540c\u6642\u6ed1\u50f9\u7684\u5f71\u97ff\u4e5f\u6703\u964d\u4f4e\u3002</p> </li> <li> <p>\u82e5\u6c92\u6709\u8003\u616e\u6ed1\u50f9\u53ca\u6d41\u52d5\u6027\u53ef\u80fd\u6703\u9ad8\u4f30\u6295\u8cc7\u7b56\u7565\u7684\u7372\u5229\uff0c\u7279\u5225\u662f\u5728\u6295\u8cc7\u7d44\u5408\u4e2d\u6709\u6210\u4ea4\u91cf\u8f03\u4f4e\uff08\u6d41\u52d5\u6027\u5dee\uff09\u7684\u80a1\u7968\u3001\u8cc7\u91d1\u91cf\uff08capital base\uff09\u5927\u6216\u904e\u5ea6\u96c6\u4e2d\u4ea4\u6613\u55ae\u4e00\u500b\u80a1\u6642\uff0c\u5f71\u97ff\u6703\u66f4\u70ba\u660e\u986f\u3002\u9019\u4e5f\u662f\u56de\u6e2c\uff08backtesting\uff09\u7684\u4e00\u5927\u76ee\u7684\uff0c\u8003\u91cf\u6295\u8cc7\u7b56\u7565\u5728\u771f\u5be6\u4e16\u754c\u904b\u884c\u7684\u53ef\u80fd\u6027\u3002</p> </li> </ul>"},{"location":"reference/zipline/slippage/#1-set_slippage","title":"1. set_slippage() \u51fd\u6578","text":"<p><code>zipline.api.set_slippage()</code> \u7528\u65bc\u8a2d\u5b9a\u56de\u6e2c\u6642\u6240\u4f7f\u7528\u7684\u6ed1\u50f9\u6a21\u578b\u3002</p>"},{"location":"reference/zipline/slippage/#_2","title":"\u53c3\u6578","text":"<ul> <li> <p><code>equities</code> (<code>EquitySlippageModel</code>, optional)</p> <ul> <li>\u7528\u65bc\u4ea4\u6613\u80a1\u7968\u7684\u6ed1\u50f9\u6a21\u578b\u3002</li> <li><code>EquitySlippageModel</code>: <code>zipline.finance.slippage</code></li> </ul> </li> <li> <p><code>futures</code> (<code>FutureSlippageModel</code>, optional)</p> <ul> <li>\u7528\u65bc\u4ea4\u6613\u671f\u8ca8\u7684\u6ed1\u50f9\u6a21\u578b\u3002\uff08\u76ee\u524d\u4e0d\u652f\u63f4\uff09</li> <li><code>FutureSlippageModel</code>: <code>zipline.finance.slippage</code></li> </ul> </li> </ul>"},{"location":"reference/zipline/slippage/#raises","title":"\u932f\u8aa4 (Raises)","text":"<ul> <li><code>SetSlippagePostInit</code><ul> <li><code>slippage</code> \u53ea\u80fd\u5728 <code>initialize</code> \u968e\u6bb5\u4f7f\u7528\u3002</li> </ul> </li> </ul>"},{"location":"reference/zipline/slippage/#notes","title":"\u6ce8\u610f\u4e8b\u9805 (Notes)","text":"<ul> <li><code>set_slippage</code> \u53ea\u80fd\u4e00\u6b21\u7528\u4e00\u7a2e\u65b9\u6cd5\u3002</li> </ul>"},{"location":"reference/zipline/slippage/#_3","title":"\u5167\u5efa\u6ed1\u50f9\u6a21\u578b","text":"<ul> <li><code>zipline.finance.slippage.FixedSlippage</code></li> <li><code>zipline.finance.slippage.VolumeShareSlippage</code></li> <li><code>zipline.finance.slippage.FixedBasisPointsSlippage</code></li> </ul>"},{"location":"reference/zipline/slippage/#_4","title":"\u7bc4\u4f8b","text":"<pre><code>from zipline.api import set_slippage\nfrom zipline.finance import slippage\n\ndef initialize(context):\n    set_slippage(slippage.&lt;\u5176\u4e2d\u4e00\u7a2e slippage models&gt;)\n</code></pre>"},{"location":"reference/zipline/universe/","title":"Zipline \u80a1\u7968\u6c60 (Universe) \u5b9a\u7fa9\u8207\u7ba1\u7406","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b Zipline \u4e2d\u80a1\u7968\u6c60 (Universe) \u5b9a\u7fa9\u8207\u7ba1\u7406\u7684\u8a73\u7d30\u6307\u5357\uff0c\u5305\u62ec <code>get_universe()</code> \u51fd\u6578\u7684\u4f7f\u7528\u3001\u900f\u904e Pipeline \u7684 <code>screen</code> \u53c3\u6578\u9032\u884c\u52d5\u614b\u7be9\u9078\uff0c\u5e6b\u52a9\u4f7f\u7528\u8005\u63d0\u5347\u56de\u6e2c\u6548\u7387\u3002</p> <p>\u5728 Zipline \u56de\u6e2c\u4e2d\uff0c\u300c\u80a1\u7968\u6c60 (Universe)\u300d\u662f\u6307\u60a8\u7684\u4ea4\u6613\u7b56\u7565\u5728\u6bcf\u500b\u6642\u9593\u9ede\u4e0a\u6240\u80fd\u8003\u616e\u6216\u5be6\u969b\u4ea4\u6613\u7684\u8cc7\u7522\u96c6\u5408\u3002\u6709\u6548\u5730\u5b9a\u7fa9\u548c\u7ba1\u7406\u80a1\u7968\u6c60\uff0c\u80fd\u5920\u5927\u5e45\u63d0\u5347\u56de\u6e2c\u6548\u7387\uff0c\u4e26\u78ba\u4fdd\u7b56\u7565\u53ea\u95dc\u6ce8\u76f8\u95dc\u6216\u7b26\u5408\u7279\u5b9a\u689d\u4ef6\u7684\u8cc7\u7522\u3002</p> <p>\u672c\u6587\u4ef6\u5c07\u8aaa\u660e\u5982\u4f55\u5229\u7528 <code>get_universe()</code> \u51fd\u6578\u4f86\u5b9a\u7fa9\u975c\u614b\u80a1\u7968\u6c60\uff0c\u4ee5\u53ca\u5982\u4f55\u900f\u904e <code>Pipeline</code> \u7684 <code>screen</code> \u53c3\u6578\u4f86\u5be6\u73fe\u52d5\u614b\u7be9\u9078\u3002</p>"},{"location":"reference/zipline/universe/#1-ziplinesourcestej_api_dataget_universe","title":"1. zipline.sources.TEJ_Api_Data.get_universe() \u51fd\u6578\uff1a\u5b9a\u7fa9\u975c\u614b\u80a1\u7968\u6c60","text":"<p><code>zipline.sources.TEJ_Api_Data.get_universe()</code> \u51fd\u6578\u662f TQuant Lab \u63d0\u4f9b\u7684\u4e00\u500b\u5f37\u5927\u5de5\u5177\uff0c\u7528\u65bc\u5f9e TEJ \u8cc7\u6599\u5eab\u4e2d\u7372\u53d6\u7b26\u5408\u7279\u5b9a\u7be9\u9078\u689d\u4ef6\u7684\u8cc7\u7522\u5217\u8868\u3002</p> <p>\u5c0e\u5165: <code>from zipline.sources.TEJ_Api_Data import get_universe</code> \u7528\u9014: \u6839\u64da\u65e5\u671f\u548c\u591a\u7a2e\u7be9\u9078\u689d\u4ef6\uff0c\u7372\u53d6\u4e00\u7d44 Zipline \u8cc7\u7522\u7269\u4ef6 (SID) \u5217\u8868\u3002</p> <p>\u53c3\u6578:</p> <ul> <li><code>start</code>: (<code>datetime</code> \u6216 <code>str</code>) \u8d77\u59cb\u65e5\u671f\u3002</li> <li><code>end</code>: (<code>datetime</code> \u6216 <code>str</code>, \u53ef\u9078) \u7d50\u675f\u65e5\u671f\uff0c\u9810\u8a2d\u70ba\u57f7\u884c\u7576\u5929\u3002</li> <li><code>idx_id</code>: (<code>str</code> \u6216 <code>list</code>, \u53ef\u9078) \u6307\u6578\u4ee3\u78bc\uff0c\u4f8b\u5982 <code>'IX0002'</code> (\u53f0\u7063\u4e94\u5341\u6307\u6578)\u3002</li> <li><code>mkt</code>: (<code>str</code> \u6216 <code>list</code>, \u53ef\u9078) \u5e02\u5834\u985e\u578b\uff0c\u4f8b\u5982 <code>'TWSE'</code> (\u53f0\u7063\u8b49\u5238\u4ea4\u6613\u6240)\u3001<code>'OTC'</code> (\u6ac3\u6aaf\u8cb7\u8ce3\u4e2d\u5fc3)\u3002</li> <li><code>stktp_c</code> / <code>stktp_e</code>: (<code>str</code> \u6216 <code>list</code>, \u53ef\u9078) \u80a1\u7968\u985e\u578b\uff0c\u53ef\u4f7f\u7528\u4e2d\u6587\u6216\u82f1\u6587\uff0c\u4f8b\u5982 <code>'\u666e\u901a\u80a1'</code>, <code>'Common Stock'</code>\u3002</li> <li><code>sub_ind_c</code> / <code>sub_ind_e</code>: (<code>str</code> \u6216 <code>list</code>, \u53ef\u9078) \u6b21\u7522\u696d\u5225\u3002</li> <li><code>main_ind_c</code>: (<code>str</code> \u6216 <code>list</code>, \u53ef\u9078) \u4e3b\u8981\u7522\u696d\u5225\u3002</li> <li>\u66f4\u591a\u7be9\u9078\u53c3\u6578\u8acb\u53c3\u8003 <code>get_universe</code> \u7684\u6e90\u78bc\u6216\u76f8\u95dc\u8aaa\u660e\u3002</li> </ul> <p>\u8fd4\u56de\u503c: <code>pd.Series</code> \u6216 <code>list</code>\uff0c\u5305\u542b\u7b26\u5408\u689d\u4ef6\u7684\u8cc7\u7522\u7269\u4ef6 (Zipline <code>Asset</code> \u7269\u4ef6)\u3002</p> <p>Note</p> <p><code>get_universe()</code> \u51fd\u6578\u4f9d\u8cf4\u65bc TEJ API\u3002\u56e0\u6b64\uff0c<code>TEJAPI_KEY</code> \u548c <code>TEJAPI_BASE</code> \u74b0\u5883\u8b8a\u6578\u5fc5\u9808\u9810\u5148\u8a2d\u5b9a\u3002</p>"},{"location":"reference/zipline/universe/#50","title":"\u7bc4\u4f8b\uff1a\u7372\u53d6\u53f0\u706350\u6307\u6578\u6210\u5206\u80a1","text":"<pre><code>import pandas as pd\nfrom zipline.sources.TEJ_Api_Data import get_universe\nimport os\n\n# \u5047\u8a2d\u5df2\u8a2d\u5b9a TEJAPI_KEY \u548c TEJAPI_BASE \u74b0\u5883\u8b8a\u6578\n# os.environ['TEJAPI_KEY'] = 'YOUR_API_KEY'\n# os.environ['TEJAPI_BASE'] = 'https://api.tej.com.tw'\n\nstart_date = pd.Timestamp('2020-01-01', tz='UTC')\nend_date = pd.Timestamp('2023-01-01', tz='UTC')\n\n# \u7372\u53d6\u53f0\u706350\u6307\u6578 (IX0002) \u7684\u6210\u5206\u80a1\ntw50_assets = get_universe(start=start_date, end=end_date, idx_id='IX0002')\n\nprint(f\"\u53f0\u706350\u6307\u6578\u6210\u5206\u80a1\u6578\u91cf: {len(tw50_assets)}\")\nprint(tw50_assets.head())\n</code></pre>"},{"location":"reference/zipline/universe/#2-pipeline-screen","title":"2. \u900f\u904e Pipeline \u7684 screen \u53c3\u6578\u52d5\u614b\u7be9\u9078","text":"<p>\u5728 Zipline \u4e2d\uff0c<code>Pipeline</code> \u63d0\u4f9b\u4e86\u4e00\u7a2e\u66f4\u70ba\u5f37\u5927\u548c\u52d5\u614b\u7684\u65b9\u5f0f\u4f86\u5b9a\u7fa9\u6bcf\u65e5\u7684\u80a1\u7968\u6c60\u3002\u60a8\u53ef\u4ee5\u5229\u7528\u5404\u7a2e\u56e0\u5b50\uff08Factor\uff09\u548c\u904e\u6ffe\u5668\uff08Filter\uff09\u4f86\u69cb\u5efa\u8907\u96dc\u7684\u7be9\u9078\u908f\u8f2f\uff0c\u4e26\u900f\u904e <code>attach_pipeline()</code> \u7684 <code>screen</code> \u53c3\u6578\u5c07\u7be9\u9078\u7d50\u679c\u61c9\u7528\u65bc\u56de\u6e2c\u3002</p> <p><code>screen</code> \u53c3\u6578\u61c9\u63a5\u6536\u4e00\u500b\u5e03\u6797 Series (Boolean Series)\uff0c\u5176\u4e2d <code>True</code> \u8868\u793a\u8a72\u8cc7\u7522\u5305\u542b\u5728 Universe \u4e2d\u3002</p>"},{"location":"reference/zipline/universe/#_1","title":"\u7bc4\u4f8b\uff1a\u7be9\u9078\u5e02\u503c\u6700\u5927\u7684\u80a1\u7968","text":"<pre><code>from zipline.api import attach_pipeline, pipeline_output, set_benchmark, symbol\nfrom zipline.pipeline import Pipeline\nfrom zipline.pipeline.factors import AverageDollarVolume\nfrom zipline.pipeline.filters import StaticAssets\nfrom zipline.pipeline.data import EquityPricing\n\n# 1. \u5b9a\u7fa9 Pipeline\ndef make_my_pipeline():\n    # \u8a08\u7b97\u5e73\u5747\u6bcf\u65e5\u6210\u4ea4\u91d1\u984d\n    dollar_volume = AverageDollarVolume(window_length=20)\n\n    # \u7be9\u9078\u689d\u4ef6\uff1a\u5e02\u503c\u524d 100 \u5927\u7684\u80a1\u7968\n    # \u9019\u88e1\u53ea\u662f\u4e00\u500b\u793a\u610f\uff0c\u5be6\u969b\u7684\u5e02\u503c\u7be9\u9078\u53ef\u80fd\u9700\u8981\u66f4\u8907\u96dc\u7684\u56e0\u5b50\n    top_100_by_volume = dollar_volume.top(100) # \u5047\u8a2d\u6210\u4ea4\u91cf\u8207\u5e02\u503c\u6b63\u76f8\u95dc\n\n    return Pipeline(\n        columns={\n            'dollar_volume': dollar_volume\n        },\n        screen=top_100_by_volume # &lt;--- \u900f\u904e screen \u53c3\u6578\u9032\u884c\u52d5\u614b\u7be9\u9078\n    )\n\n# 2. \u56de\u6e2c\u7684 initialize \u51fd\u6578\ndef initialize(context):\n    set_benchmark(symbol('IR0001'))\n    # \u9644\u639b Pipeline\uff0c\u4e26\u8b93\u5176 screen \u53c3\u6578\u5b9a\u7fa9\u7576\u65e5 Universe\n    attach_pipeline(make_my_pipeline(), 'my_dynamic_universe') \n    context.my_universe = None\n\n# 3. \u56de\u6e2c\u7684 before_trading_start \u51fd\u6578 (\u7372\u53d6 Pipeline \u7be9\u9078\u7d50\u679c)\ndef before_trading_start(context, data):\n    # \u7372\u53d6 Pipeline \u7684\u8f38\u51fa\uff0c\u5176\u7d22\u5f15\u5373\u70ba\u7576\u65e5\u7be9\u9078\u51fa\u7684 Universe\n    context.my_universe = pipeline_output('my_dynamic_universe').index.get_level_values(1).tolist()\n\n# 4. \u56de\u6e2c\u7684 handle_data \u51fd\u6578 (\u5728\u7be9\u9078\u5f8c\u7684 Universe \u4e2d\u64cd\u4f5c)\ndef handle_data(context, data):\n    # \u7b56\u7565\u908f\u8f2f\u53ea\u5c0d context.my_universe \u4e2d\u7684\u80a1\u7968\u57f7\u884c\n    for asset in context.my_universe:\n        if data.can_trade(asset):\n            # ... \u57f7\u884c\u4ea4\u6613\u908f\u8f2f ...\n            pass\n</code></pre>"},{"location":"tutorials/first-spot-strategy/","title":"\u4f60\u7684\u7b2c\u4e00\u500b\u73fe\u8ca8\u7b56\u7565\uff1aKD \u6307\u6a19\u56de\u6e2c\u5be6\u6230","text":"<p>Info</p> <p>\u5728 TQuant Lab \u4ee5 KD \u6307\u6a19\u5b8c\u6210\u5f9e\u8cc7\u6599\u3001\u56de\u6e2c\u5230\u7e3e\u6548\u7684\u6700\u5c0f\u53ef\u884c\u7b56\u7565\uff08MVP\uff09\u3002</p> <p>\ud83d\ude80 \u9ede\u6b64\u524d\u5f80 GitHub \u4e0b\u8f09\u672c\u7bc4\u4f8b Jupyter Notebook\uff0c \u8ddf\u8457\u6559\u5b78\u4e00\u8d77\u64cd\u4f5c\u5427!</p>"},{"location":"tutorials/first-spot-strategy/#1-kd","title":"1. \u7c21\u4ecb\uff1aKD \u6307\u6a19\u8207\u4ea4\u6613\u7b56\u7565","text":"<p>KD \u6307\u6a19 (\u96a8\u6a5f\u6307\u6a19) \u662f\u6280\u8853\u5206\u6790\u4e2d\u5e38\u7528\u7684\u52d5\u91cf\u6307\u6a19\uff0c\u7528\u65bc\u5224\u65b7\u80a1\u50f9\u7684\u8d85\u8cb7\u8d85\u8ce3\u72c0\u614b\u53ca\u53ef\u80fd\u7684\u53cd\u8f49\u6642\u6a5f\u3002</p>"},{"location":"tutorials/first-spot-strategy/#2","title":"2. \u74b0\u5883\u8a2d\u5b9a\u8207\u8cc7\u6599\u6e96\u5099","text":"<p>\u5728\u958b\u59cb\u7b56\u7565\u56de\u6e2c\u524d\uff0c\u8acb\u78ba\u4fdd\u60a8\u5df2\u5b8c\u6210 TQuant Lab \u7684\u74b0\u5883\u5efa\u7f6e\uff0c\u4e26\u8a2d\u5b9a\u597d TEJ API Key\u3002</p>"},{"location":"tutorials/first-spot-strategy/#3","title":"3. \u5efa\u69cb\u4ea4\u6613\u7b56\u7565","text":"<p>\u4f7f\u7528 TQuant Lab \u7684 Pipeline \u5efa\u7acb KD \u6307\u6a19\uff0c\u4e26\u900f\u904e <code>initialize</code> \u548c <code>handle_data</code> \u51fd\u5f0f\u5be6\u4f5c\u4ea4\u6613\u908f\u8f2f\u3002</p>"},{"location":"tutorials/first-spot-strategy/#4","title":"4. \u57f7\u884c\u56de\u6e2c\u8207\u5206\u6790","text":"<p>\u4f7f\u7528 <code>run_algorithm</code> \u57f7\u884c\u7b56\u7565\uff0c\u4e26\u900f\u904e <code>pyfolio</code> \u5957\u4ef6\u5206\u6790\u7b56\u7565\u7684\u7e3e\u6548\u8207\u98a8\u96aa\u8868\u73fe\u3002</p>"},{"location":"tutorials/first-spot-strategy/#1-kd_1","title":"1. \u7c21\u4ecb\uff1aKD \u6307\u6a19\u8207\u4ea4\u6613\u7b56\u7565","text":"<ul> <li> <p>KD \u6307\u6a19\u8a08\u7b97 \uff1a</p> <ul> <li><code>RSV = ((\u7576\u65e5\u6536\u76e4\u50f9 - \u8fd1 N \u65e5\u7684\u6700\u4f4e\u50f9) / (\u8fd1 N \u65e5\u7684\u6700\u9ad8\u50f9 - \u8fd1 N \u65e5\u7684\u6700\u4f4e\u50f9)) * 100</code></li> <li><code>K \u503c = \u6628\u65e5 K \u503c \u00d7 (2/3) + \u7576\u65e5 RSV \u00d7 (1/3)</code></li> <li><code>D \u503c = \u6628\u65e5 D \u503c \u00d7 (2/3) + \u7576\u65e5 K \u503c \u00d7 (1/3)</code></li> </ul> <p>Note</p> <p>\u672c\u7b56\u7565\u4e2d N = 10</p> </li> <li> <p>\u4ea4\u6613\u7b56\u7565\u9032\u51fa\u5834\u898f\u5247 \uff1a</p> <ul> <li>\u8cb7\u5165\u8a0a\u865f (Long Entry)\uff1a\u7576 K \u503c \u2264 20 \u6642\uff0c\u8996\u70ba\u8d85\u8ce3\uff0c\u8cb7\u5165\u80a1\u7968\u6c60\u4e2d\u7b26\u5408\u689d\u4ef6\u7684\u80a1\u7968\uff0c\u914d\u7f6e\u5e33\u6236\u8cc7\u91d1\u7684 1%\u3002</li> <li>\u8ce3\u51fa/\u51fa\u5834\u8a0a\u865f\uff1a\u7576 K \u503c \u2265 80 \u6642\uff0c\u8996\u70ba\u8d85\u8cb7\uff0c\u8ce3\u51fa\u6301\u80a1\u4ee5\u5be6\u73fe\u7372\u5229 (\u672c\u7b56\u7565\u50c5\u6e05\u5009\uff0c\u975e\u653e\u7a7a)\u3002</li> </ul> </li> </ul>"},{"location":"tutorials/first-spot-strategy/#2_1","title":"2. \u74b0\u5883\u8a2d\u5b9a\u8207\u8cc7\u6599\u6e96\u5099","text":"<ol> <li> <p>\u8a2d\u5b9a TEJ API Key \uff1a     \u5c07 <code>YOUR_API_KEY</code> \u66ff\u63db\u70ba\u60a8\u7684 TEJ API Key\u3002</p> <pre><code>import os\ntej_key = 'YOUR_API_KEY' # \u8acb\u66ff\u63db\u70ba\u60a8\u7684 API Key\napi_base = 'https://api.tej.com.tw'\nos.environ['TEJAPI_KEY'] = tej_key\nos.environ['TEJAPI_BASE'] = api_base\n</code></pre> </li> <li> <p>\u8f09\u5165\u6240\u9700\u5957\u4ef6 \uff1a</p> <pre><code>import pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\n\nfrom zipline.data import bundles\nfrom zipline.sources.TEJ_Api_Data import get_universe\nfrom zipline.pipeline import Pipeline\nfrom zipline.pipeline.data import TWEquityPricing\nfrom zipline.TQresearch.tej_pipeline import run_pipeline\nfrom zipline.api import *\nfrom zipline.finance.commission import PerDollar\nfrom zipline.finance.slippage import VolumeShareSlippage\nfrom zipline.sources.TEJ_Api_Data import (get_Treasury_Return, get_Benchmark_Return)\nimport pyfolio as pf\n\nplt.rcParams['axes.unicode_minus'] = False # \u89e3\u6c7a Matplotlib \u8ca0\u865f\u986f\u793a\u554f\u984c\n</code></pre> </li> <li> <p>\u8a2d\u5b9a\u56de\u6e2c\u671f\u9593\u8207\u80a1\u7968\u6c60 \uff1a     \u672c\u7bc4\u4f8b\u5c07\u56de\u6e2c 2012 \u5e74\u81f3 2022 \u5e74\u7684\u53f0\u7063 50 \u6307\u6578\u6210\u5206\u80a1\u3002</p> <pre><code># \u8a2d\u5b9a\u56de\u6e2c\u671f\u9593\nstart = '2012-01-01'\nend = '2022-12-30'\n\n# \u6293\u53d6\u53f0\u706350\u6307\u6578\u7684\u80a1\u7968 (IX0002) \u8207\u52a0\u6b0a\u80a1\u50f9\u5831\u916c\u6307\u6578 (IR0001)\nStockList = get_universe(start, end, idx_id='IX0002')\nStockList.append('IR0001')\n\nos.environ['ticker'] = ' '.join(StockList)\nos.environ['mdate'] = start + ' ' + end\n\n# \u8a2d\u5b9a Zipline \u8cc7\u6599 bundle \u540d\u7a31\nbundle_name = 'tquant'\n</code></pre> </li> <li> <p>\u8f09\u5165\u8cc7\u6599 \uff1a     \u5728\u7d42\u7aef\u6a5f\u4e2d\u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4\uff0c\u5c07\u8cc7\u6599\u8f09\u5165 Zipline\u3002</p> <pre><code>zipline ingest -b tquant\n</code></pre> </li> </ol>"},{"location":"tutorials/first-spot-strategy/#3_1","title":"3. \u5efa\u69cb\u4ea4\u6613\u7b56\u7565","text":"<p>\u7b56\u7565\u53c3\u6578\u8a2d\u5b9a </p> <pre><code>starting_portfolio = 1e6 # \u521d\u59cb\u8cc7\u91d1 1,000,000 \u5143\ncommission_pct = 0.0029 # \u4f63\u91d1\u8cbb\u7387 0.29%\nslippage_volume_limit = 1.0 # \u6ed1\u50f9\u4ea4\u6613\u91cf\u9650\u5236\nslippage_impact = 0 # \u6ed1\u50f9\u5f71\u97ff\n</code></pre> <p>\u5efa\u7acb Pipeline \u51fd\u5f0f\uff1a\u8a08\u7b97 KD \u6307\u6a19 </p> <pre><code>from zipline.pipeline.factors import FastStochasticOscillator\n\ndef make_pipeline():\n    return Pipeline(\n        columns = {\n            \"FastStochasticOscillator\": FastStochasticOscillator(\n                inputs = [TWEquityPricing.close, TWEquityPricing.low, TWEquityPricing.high],\n                window_length = 10 # \u8a08\u7b97 K \u503c\u6240\u9700\u7684\u8996\u7a97\u9577\u5ea6\uff0c\u8207\u4e0a\u65b9 N=10 \u4e00\u81f4\n            )\n        }\n    )\n</code></pre> <p><code>initialize</code> \u51fd\u5f0f\uff1a\u8a2d\u5b9a\u56de\u6e2c\u74b0\u5883 </p> <pre><code>bundle = bundles.load('tquant')\n\ndef initialize(context):\n    set_commission(PerDollar(cost=commission_pct)) # \u8a2d\u5b9a\u4f63\u91d1\n    set_slippage(VolumeShareSlippage(volume_limit=slippage_volume_limit, price_impact=slippage_impact)) # \u8a2d\u5b9a\u6ed1\u50f9\n    set_benchmark(symbol('IR0001')) # \u8a2d\u5b9a\u57fa\u6e96\u6307\u6578\u70ba\u52a0\u6b0a\u80a1\u50f9\u5831\u916c\u6307\u6578\n    attach_pipeline(make_pipeline(), 'mystrategy') # \u5c0e\u5165 Pipeline\n</code></pre> <p><code>handle_data</code> \u51fd\u5f0f\uff1a\u5be6\u4f5c\u4ea4\u6613\u908f\u8f2f </p> <pre><code>def handle_data(context, data):\n    # \u53d6\u5f97\u6bcf\u5929 Pipeline \u8a08\u7b97\u51fa\u7684 K \u503c\n    out_dir = pipeline_output('mystrategy')\n\n    for asset in out_dir.index:\n        k_value = out_dir.loc[asset, 'FastStochasticOscillator']\n        position = context.portfolio.positions[asset].amount\n\n        # \u8cb7\u5165\u8a0a\u865f\uff1aK \u503c &lt;= 20 \u4e14\u76ee\u524d\u672a\u6301\u6709\u8a72\u80a1\u7968\n        if position == 0 and k_value &lt;= 20:\n            order_target_percent(asset, 0.01) # \u914d\u7f6e 1% \u8cc7\u91d1\u8cb7\u5165\n\n        # \u8ce3\u51fa\u8a0a\u865f\uff1aK \u503c &gt;= 80 \u4e14\u76ee\u524d\u6301\u6709\u8a72\u80a1\u7968\n        elif position &gt; 0 and k_value &gt;= 80:\n            order_target_percent(asset, 0.0) # \u6e05\u5009\u8ce3\u51fa\n</code></pre>"},{"location":"tutorials/first-spot-strategy/#4_1","title":"4. \u57f7\u884c\u56de\u6e2c","text":"<p>\u57f7\u884c\u56de\u6e2c </p> <pre><code>from zipline import run_algorithm\nfrom zipline.utils.calendar_utils import get_calendar #\u65e5\u66c6\u6293\u53d6\u5de5\u5177\n\nstart_date = pd.Timestamp(start, tz='utc')\nend_date = pd.Timestamp(end, tz='utc')\n\nresults = run_algorithm(\n    start=start_date,\n    end=end_date,\n    initialize=initialize,\n    capital_base=starting_portfolio,\n    handle_data=handle_data,\n    data_frequency='daily',\n    bundle='tquant',\n    trading_calendar=get_calendar('TEJ') #\u6307\u5b9a\u53f0\u7063\u65e5\u6b77\n)\n</code></pre>"},{"location":"tutorials/first-spot-strategy/#5","title":"5. \u7b56\u7565\u7e3e\u6548\u5206\u6790","text":"<p>\u7b56\u7565\u7e3e\u6548\u5206\u6790 </p> <pre><code># \u5f9e Zipline \u7d50\u679c\u4e2d\u63d0\u53d6\u5831\u916c\u3001\u90e8\u4f4d\u548c\u4ea4\u6613\u8cc7\u8a0a\nbt_returns, bt_positions, bt_transactions = pf.utils.extract_rets_pos_txn_from_zipline(results)\n\n# \u53d6\u5f97\u57fa\u6e96\u6307\u6578\u5831\u916c\nbenchmark_rets = results.benchmark_return\n\n# \u7522\u751f\u5b8c\u6574\u7684\u7e3e\u6548\u5206\u6790\u5831\u544a\npf.create_full_tear_sheet(\n    bt_returns,\n    positions=bt_positions,\n    transactions=bt_transactions,\n    benchmark_rets=benchmark_rets,\n    round_trips=False\n)\n</code></pre>"},{"location":"tutorials/first-spot-strategy/#6","title":"6. \u4e0b\u4e00\u6b65","text":"<p>\u606d\u559c\u60a8\u5b8c\u6210\u4e86\u7b2c\u4e00\u500b\u73fe\u8ca8\u7b56\u7565\uff01 \u60a8\u53ef\u4ee5\u7e7c\u7e8c\u63a2\u7d22\uff1a</p> <ul> <li>\u74b0\u5883\u5efa\u7f6e\uff1a\u6df1\u5165\u4e86\u89e3 TQuant Lab \u7684\u5b89\u88dd\u8207\u8a2d\u5b9a\u3002</li> <li>10 \u5206\u9418\u9ad4\u9a57\uff1a\u5feb\u901f\u56de\u9867 Zipline \u7684\u6838\u5fc3\u529f\u80fd\u3002</li> </ul>"},{"location":"tutorials/getting-started/","title":"\u65b0\u624b\u5fc5\u8b80\uff1a\u5feb\u901f\u4e86\u89e3 TQuant Lab","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b TQuant Lab \u65b0\u624b\u5165\u9580\u6307\u5357\uff0c\u5feb\u901f\u4e86\u89e3\u5e73\u53f0\u7684\u6838\u5fc3\u50f9\u503c\u3001\u4e3b\u8981\u529f\u80fd\u6a21\u7d44\uff0c\u4e26\u6307\u5f15\u60a8\u958b\u59cb\u4f7f\u7528\u91cf\u5316\u7814\u7a76\u5e73\u53f0\u3002</p> <p>\u6b61\u8fce\u4f86\u5230 TQuant Lab\uff01\u672c\u6307\u5357\u5c07\u5e36\u60a8\u5feb\u901f\u8a8d\u8b58 TQuant Lab \u7684\u6838\u5fc3\u50f9\u503c\u3001\u4e3b\u8981\u529f\u80fd\u6a21\u7d44\uff0c\u4e26\u6307\u5f15\u60a8\u958b\u59cb\u4f7f\u7528\u9019\u500b\u5b8c\u6574\u7684\u91cf\u5316\u7814\u7a76\u5e73\u53f0\u3002</p>"},{"location":"tutorials/getting-started/#tquant-lab_1","title":"\u4ec0\u9ebc\u662f TQuant Lab\uff1f","text":"<p>TQuant Lab \u662f\u4e00\u500b\u4e00\u7ad9\u5f0f\u7684\u91cf\u5316\u7814\u7a76\u5e73\u53f0\uff0c\u65e8\u5728\u63d0\u4f9b\u6700\u5b8c\u5584\u7684\u8cc7\u6599\u54c1\u8cea\u8207\u5167\u5bb9\uff0c\u4e26\u642d\u914d\u5f37\u5927\u7684\u4e8b\u4ef6\u9a45\u52d5\u578b\u56de\u6e2c\u7cfb\u7d71\u3002\u5b83\u6574\u5408\u4e86\uff1a</p> <ul> <li>PIT (Point In Time) \u91cf\u5316\u8cc7\u6599\u5eab\u8207\u8cc7\u6599\u6b78\u7d0d\u5de5\u5177\uff08TejToolAPI\uff09\u3002</li> <li>\u5c08\u696d\u7684\u56e0\u5b50\u5206\u6790\u5de5\u5177\u3002</li> <li>\u5168\u65b9\u4f4d\u7684\u7b56\u7565\u56de\u6e2c\u5f15\u64ce\u3002</li> <li>\u8a73\u7d30\u7684\u53ef\u8996\u5316\u5831\u8868\u5448\u73fe\u3002</li> </ul> <p>Note</p> <p>PIT (Point In Time) \u8cc7\u6599\u662f\u6307\u5728\u6b77\u53f2\u4e0a\u7279\u5b9a\u6642\u9593\u9ede\u6240\u80fd\u53d6\u5f97\u7684\u6700\u65b0\u8cc7\u6599\u3002\u4f7f\u7528 PIT \u8cc7\u6599\u80fd\u6709\u6548\u907f\u514d\u300c\u524d\u8996\u504f\u8aa4 (Look-ahead Bias)\u300d\uff0c\u78ba\u4fdd\u56de\u6e2c\u7d50\u679c\u7684\u771f\u5be6\u6027\u8207\u53ef\u9760\u6027\u3002</p>"},{"location":"tutorials/getting-started/#_1","title":"\u6838\u5fc3\u512a\u52e2","text":"<ul> <li> <p>\u6a21\u7d44\u5316\u7b56\u7565\u5efa\u69cb</p> <p>\u63d0\u4f9b\u9ad8\u5ea6\u81ea\u7531\u5316\u7684\u6a21\u7d44\u5316\u67b6\u69cb\uff0c\u8b93\u60a8\u53ef\u4ee5\u5c07\u8907\u96dc\u7684\u7b56\u7565\u6b65\u9a5f\u5316\u8655\u7406\u3002\u652f\u63f4\u540c\u6642\u8655\u7406\u591a\u91cd\u6a19\u7684\u8cb7\u8ce3\uff0c\u4e26\u5b8c\u6574\u5448\u73fe\u7b56\u7565\u7e3e\u6548\u8207\u98a8\u96aa\u6307\u6a19\u3002</p> </li> <li> <p>\u5b8c\u6574\u4e14\u7dad\u8b77\u826f\u597d\u7684\u8cc7\u6599\u5eab</p> <p>\u6574\u5408\u5b8c\u6574\u4e14\u7dad\u8b77\u826f\u597d\u7684\u8cc7\u6599\u5eab\u7cfb\u7d71\uff0c\u6240\u6709\u8cc7\u6599\u7686\u7d93\u904e\u56b4\u683c\u628a\u95dc\u8207\u7dad\u8b77\uff0c\u78ba\u4fdd\u56de\u6e2c\u7e3e\u6548\u7684\u6e96\u78ba\u6027\u3002</p> </li> <li> <p>\u5f37\u5927\u4e14\u56b4\u8b39\u7684\u56de\u6e2c\u5206\u6790\u5957\u4ef6</p> <p>\u5167\u5efa\u591a\u7a2e Python \u5206\u6790\u5de5\u5177\uff0c\u4e26\u63d0\u4f9b\u8c50\u5bcc\u7684\u53c3\u6578\u8abf\u6574\u9078\u9805\u3002\u5168\u65b9\u4f4d\u6a21\u64ec\u5e02\u5834\u4ea4\u6613\u74b0\u5883\uff0c\u5927\u5e45\u63d0\u5347\u5206\u6790\u7d50\u679c\u7684\u53ef\u4fe1\u5ea6\u3002</p> </li> </ul>"},{"location":"tutorials/getting-started/#_2","title":"\u4e3b\u8981\u529f\u80fd\u6a21\u7d44","text":"<p>TQuant Lab \u6574\u5408\u4e86\u591a\u500b\u696d\u754c\u9818\u5148\u7684\u958b\u6e90\u91cf\u5316\u5206\u6790\u5de5\u5177\uff0c\u4e26\u9032\u884c\u4e86\u512a\u5316\u8207\u6574\u5408\uff1a</p> <ul> <li> <p>Zipline</p> <p>\u4e8b\u4ef6\u9a45\u52d5\u578b\u56de\u6e2c\u5f15\u64ce\uff0c\u7528\u65bc\u6a21\u64ec\u4ea4\u6613\u7b56\u7565\u7684\u57f7\u884c\u3002</p> </li> <li> <p>Pipeline</p> <p>\u5f37\u5927\u7684\u8cc7\u6599\u8655\u7406\u8207\u56e0\u5b50\u751f\u6210\u6846\u67b6\uff0c\u5354\u52a9\u60a8\u69cb\u5efa\u8907\u96dc\u7684\u6295\u8cc7\u8a0a\u865f\u3002</p> </li> <li> <p>Pyfolio</p> <p>\u5c08\u696d\u7684\u7e3e\u6548\u5206\u6790\u5de5\u5177\uff0c\u63d0\u4f9b\u591a\u6a23\u5316\u7684\u5831\u8868\u8207\u8996\u89ba\u5316\u5448\u73fe\u3002</p> </li> <li> <p>Alphalens</p> <p>\u56e0\u5b50\u5206\u6790\u5de5\u5177\uff0c\u7528\u65bc\u8a55\u4f30\u6295\u8cc7\u56e0\u5b50\u7684\u6709\u6548\u6027\u3002</p> </li> <li> <p>TejToolAPI</p> <p>TEJ \u53f0\u7063\u7d93\u6fdf\u65b0\u5831\u63d0\u4f9b\u7684\u8cc7\u6599\u4ecb\u9762\uff0c\u65b9\u4fbf\u60a8\u53d6\u5f97\u9ad8\u54c1\u8cea\u7684\u8ca1\u52d9\u8207\u5e02\u5834\u8cc7\u6599\u3002</p> </li> </ul>"},{"location":"tutorials/getting-started/#_3","title":"\u5feb\u901f\u958b\u59cb","text":"<p>\u6e96\u5099\u597d\u958b\u59cb\u60a8\u7684\u91cf\u5316\u6295\u8cc7\u4e4b\u65c5\u4e86\u55ce\uff1f</p> <ol> <li>\u74b0\u5883\u5efa\u7f6e: \u4f9d\u7167 TQuant Lab \u5b89\u88dd \u6307\u5357\uff0c\u8a2d\u5b9a\u60a8\u7684\u958b\u767c\u74b0\u5883\u3002</li> <li>\u60a8\u7684\u7b2c\u4e00\u500b\u7b56\u7565: \u900f\u904e \u4f60\u7684\u7b2c\u4e00\u500b\u73fe\u8ca8\u7b56\u7565 \u6216 \u4f60\u7684\u7b2c\u4e00\u500b\u671f\u8ca8\u7b56\u7565 \u7bc4\u4f8b\uff0c\u5feb\u901f\u9ad4\u9a57 TQuant Lab \u7684\u56de\u6e2c\u529f\u80fd\u3002</li> </ol>"},{"location":"tutorials/quick-demo/","title":"10 \u5206\u9418\u9ad4\u9a57\uff1a\u60a8\u7684\u7b2c\u4e00\u500b Zipline \u56de\u6e2c\u7b56\u7565","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b Zipline \u56de\u6e2c\u7b56\u7565\u7684 10 \u5206\u9418\u5feb\u901f\u9ad4\u9a57\u6307\u5357\uff0c\u5305\u62ec\u74b0\u5883\u8a2d\u5b9a\u3001\u8cc7\u6599\u8f09\u5165\u3001\u7b56\u7565\u51fd\u5f0f\u8aaa\u660e\u3001\u57f7\u884c\u56de\u6e2c\u8207\u5206\u6790\u7d50\u679c\uff0c\u5e6b\u52a9\u60a8\u5feb\u901f\u4e0a\u624b TQuant Lab\u3002</p> <p>\ud83d\ude80 \u9ede\u6b64\u524d\u5f80 GitHub \u4e0b\u8f09\u672c\u7bc4\u4f8b Jupyter Notebook\uff0c \u8ddf\u8457\u6559\u5b78\u4e00\u8d77\u64cd\u4f5c\u5427!</p> <p>\u672c\u6307\u5357\u5c07\u5e36\u60a8\u900f\u904e\u4e00\u500b\u7c21\u55ae\u7684\u300c\u8cb7\u9032\u6301\u6709\u300d\u7b56\u7565\uff0c\u5feb\u901f\u9ad4\u9a57 TQuant Lab \u7684\u6838\u5fc3\u56de\u6e2c\u529f\u80fd\u3002\u60a8\u5c07\u4e86\u89e3\u5982\u4f55\u8a2d\u5b9a\u74b0\u5883\u3001\u8f09\u5165\u8cc7\u6599\u3001\u5b9a\u7fa9\u4ea4\u6613\u7b56\u7565\uff0c\u4e26\u57f7\u884c\u56de\u6e2c\u8207\u5206\u6790\u7d50\u679c\u3002</p>"},{"location":"tutorials/quick-demo/#1","title":"1. \u74b0\u5883\u8a2d\u5b9a\u8207\u8cc7\u6599\u8f09\u5165","text":"<p>\u5728\u4f7f\u7528 Zipline \u9032\u884c\u56de\u6e2c\u524d\uff0c\u9700\u8981\u8a2d\u5b9a TEJ API \u76f8\u95dc\u74b0\u5883\u8b8a\u6578\uff0c\u4e26\u8f09\u5165\u80a1\u50f9\u8cc7\u6599\u3002</p> <ol> <li> <p>\u8a2d\u5b9a\u74b0\u5883\u8b8a\u6578 \uff1a     \u5728 Jupyter Notebook \u4e2d\u57f7\u884c\u4ee5\u4e0b\u7a0b\u5f0f\u78bc\uff0c\u5c07 <code>YOUR_API_KEY</code> \u66ff\u63db\u70ba\u60a8\u7684 TEJ API Key\u3002<code>mdate</code> \u8a2d\u5b9a\u8cc7\u6599\u5340\u9593\uff0c<code>ticker</code> \u8a2d\u5b9a\u80a1\u7968\u4ee3\u78bc\u3002</p> <pre><code>import os\nos.environ['TEJAPI_BASE'] = \"https://api.tej.com.tw\"\nos.environ['TEJAPI_KEY'] = \"YOUR_API_KEY\" # \u8acb\u66ff\u63db\u70ba\u60a8\u7684 API Key\nos.environ['mdate'] = \"20170601 20230702\" # \u8cc7\u6599\u8d77\u59cb\u65e5\u8207\u7d50\u675f\u65e5\nos.environ['ticker'] = '2330 IR0001' # \u80a1\u7968\u4ee3\u78bc (2330 \u70ba\u53f0\u7a4d\u96fb)\n</code></pre> </li> <li> <p>\u8f09\u5165\u80a1\u50f9\u8cc7\u6599 \uff1a     \u4f7f\u7528 <code>!zipline ingest</code> \u6307\u4ee4\u5c07\u8a2d\u5b9a\u597d\u7684\u8cc7\u6599\u8f09\u5165\u5230 Zipline \u7684 bundle \u4e2d\u3002</p> <pre><code>!zipline ingest -b tquant\n</code></pre> <p>\u5c0f\u77e5\u8b58\uff1a\u70ba\u4ec0\u9ebc\u6307\u4ee4\u524d\u9762\u6709\u500b\u9a5a\u5606\u865f (!)</p> <p>\u5728 Jupyter Notebook \u4e2d\uff0c\u958b\u982d\u7684 <code>!</code> (Bang) \u4ee3\u8868\u9019\u662f\u4e00\u884c \u7cfb\u7d71\u6307\u4ee4 (Shell Command)\uff0c\u800c\u4e0d\u662f Python \u7a0b\u5f0f\u78bc\u3002</p> <p>\u56e0\u70ba <code>zipline ingest</code> \u672c\u8cea\u4e0a\u662f\u4e00\u500b\u5b89\u88dd\u5728\u96fb\u8166\u88e1\u7684\u57f7\u884c\u6a94 (CLI \u5de5\u5177)\uff0c\u52a0\u4e0a <code>!</code> \u8b93\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5728 Notebook \u5132\u5b58\u683c\u88e1\u547c\u53eb\u5b83\uff0c\u7701\u53bb\u5207\u63db\u5230\u9ed1\u5e95\u767d\u5b57\u7d42\u7aef\u6a5f\u7684\u9ebb\u7169\u3002</p> </li> </ol>"},{"location":"tutorials/quick-demo/#2-zipline","title":"2. \u7b56\u7565\u6838\u5fc3\uff1aZipline \u56de\u6e2c\u51fd\u6578","text":"<p>Zipline \u7b56\u7565\u4e3b\u8981\u7531\u56db\u500b\u6838\u5fc3\u51fd\u5f0f\u69cb\u6210\uff1a<code>initialize</code>\u3001<code>handle_data</code>\u3001<code>analyze</code> \u548c <code>run_algorithm</code>\u3002</p>"},{"location":"tutorials/quick-demo/#21-initializecontext","title":"2.1. initialize(context)","text":"<ul> <li>\u529f\u80fd \uff1a\u5728\u56de\u6e2c\u958b\u59cb\u524d\u57f7\u884c\u4e00\u6b21\uff0c\u7528\u65bc\u8a2d\u5b9a\u521d\u59cb\u74b0\u5883\uff0c\u4f8b\u5982\u8a2d\u5b9a\u6ed1\u50f9\u3001\u624b\u7e8c\u8cbb\uff0c\u6216\u521d\u59cb\u5316\u7b56\u7565\u6240\u9700\u7684\u8b8a\u6578\u3002</li> <li> <p>\u7bc4\u4f8b \uff1a\u8a2d\u5b9a\u6ed1\u50f9\u3001\u624b\u7e8c\u8cbb\uff0c\u4e26\u521d\u59cb\u5316 <code>context.day</code> \u548c <code>context.has_ordered</code> \u8b8a\u6578\u3002</p> <pre><code>from zipline.api import set_slippage, set_commission\nfrom zipline.finance import slippage, commission\n\ndef initialize(context):\n    context.day = 0\n    context.has_ordered = False # \u8ffd\u8e64\u662f\u5426\u5df2\u4e0b\u55ae\n    set_slippage(slippage.FixedSlippage()) # \u8a2d\u5b9a\u56fa\u5b9a\u6ed1\u50f9\n    set_commission(commission.PerShare(cost=0.00285)) # \u8a2d\u5b9a\u6bcf\u80a1\u624b\u7e8c\u8cbb\n</code></pre> </li> </ul>"},{"location":"tutorials/quick-demo/#22-handle_datacontext-data","title":"2.2. handle_data(context, data)","text":"<ul> <li>\u529f\u80fd \uff1a\u5728\u6bcf\u500b\u4ea4\u6613\u65e5\u7d50\u675f\u6642\u57f7\u884c\u4e00\u6b21\uff0c\u7528\u65bc\u5b9a\u7fa9\u4ea4\u6613\u908f\u8f2f\u3001\u4e0b\u55ae\u64cd\u4f5c\u53ca\u8a18\u9304\u4ea4\u6613\u8cc7\u8a0a\u3002</li> <li>\u53c3\u6578 \uff1a<ul> <li><code>context</code>: \u5305\u542b\u7b56\u7565\u72c0\u614b\u7684\u7269\u4ef6\uff0c\u53ef\u5728\u4e0d\u540c\u51fd\u5f0f\u9593\u5171\u4eab\u8cc7\u8a0a\u3002</li> <li><code>data</code>: \u5305\u542b\u7576\u524d\u4ea4\u6613\u65e5\u6240\u6709\u8cc7\u7522\u7684\u6b77\u53f2\u8207\u7576\u524d\u5e02\u5834\u8cc7\u6599\u3002</li> </ul> </li> <li> <p>\u7bc4\u4f8b \uff1a\u5728\u7b2c\u4e00\u500b\u4ea4\u6613\u65e5\u8cb7\u5165\u53f0\u7a4d\u96fb (2330) \u80a1\u7968\uff0c\u4e26\u8a18\u9304\u76f8\u95dc\u8cc7\u8a0a\u3002</p> <pre><code>from zipline.api import order, record, symbol\n\ndef handle_data(context, data):\n    context.day += 1 #\u8a18\u9304\u9019\u662f\u56de\u6e2c\u7b2c\u5e7e\u5929\n    if not context.has_ordered: #\u78ba\u4fdd\u4e0d\u6703\u91cd\u8907\u4e0b\u55ae\n        order(symbol(\"2330\"), 1000) #\u8cb7\u51651000\u80a1\u53f0\u7a4d\u96fb\n        context.has_ordered = True #\u6307\u793a\u7cfb\u7d71\u5df2\u7d93\u4e0b\u55ae\n\n    # \u7d00\u9304\u4ea4\u6613\u65e5\u3001\u662f\u5426\u5df2\u7d93\u4e0b\u55ae\u4ee5\u53ca\u53f0\u7a4d\u96fb\u6536\u76e4\u50f9\n    record(\n        trade_days = context.day,\n        has_ordered = context.has_ordered,\n        TSMC = data.current(symbol(\"2330\"), \"close\")\n    )\n</code></pre> </li> </ul>"},{"location":"tutorials/quick-demo/#23-analyzecontext-perf","title":"2.3. analyze(context, perf)","text":"<ul> <li>\u529f\u80fd \uff1a\u5728\u56de\u6e2c\u7d50\u675f\u5f8c\u57f7\u884c\u4e00\u6b21\uff0c\u7528\u65bc\u5206\u6790\u7b56\u7565\u7e3e\u6548\u4e26\u9032\u884c\u8996\u89ba\u5316\u3002</li> <li>\u53c3\u6578 \uff1a<ul> <li><code>context</code>: \u540c <code>initialize</code> \u548c <code>handle_data</code> \u4e2d\u7684 <code>context</code>\u3002</li> <li><code>perf</code>: \u5305\u542b\u56de\u6e2c\u7d50\u679c\u7684 DataFrame\uff0c\u53ef\u63d0\u53d6\u7e3e\u6548\u6307\u6a19\u3002</li> </ul> </li> <li> <p>\u7bc4\u4f8b \uff1a\u7e6a\u88fd\u6295\u8cc7\u7d44\u5408\u50f9\u503c\u8207\u53f0\u7a4d\u96fb\u80a1\u50f9\u8d70\u52e2\u5716\u3002</p> <pre><code>import matplotlib.pyplot as plt\n\ndef analyze(context, perf):\n    fig, (ax1, ax2) = plt.subplots(2, 1, sharex=True, figsize=(18, 8))\n    perf.portfolio_value.plot(ax=ax1, title='\u6295\u8cc7\u7d44\u5408\u50f9\u503c')\n    perf['TSMC'].plot(ax=ax2, title='\u53f0\u7a4d\u96fb\u6536\u76e4\u50f9')\n    plt.tight_layout()\n    plt.show()\n</code></pre> </li> </ul>"},{"location":"tutorials/quick-demo/#24-run_algorithm","title":"2.4. run_algorithm","text":"<ul> <li>\u529f\u80fd \uff1a \u555f\u52d5 Zipline \u56de\u6e2c\u5f15\u64ce\uff0c\u6574\u5408\u4e0a\u8ff0\u51fd\u5f0f\u4e26\u57f7\u884c\u7b56\u7565\u3002</li> <li>\u53c3\u6578 \uff1a<ul> <li><code>start</code>, <code>end</code>: \u56de\u6e2c\u7684\u8d77\u59cb\u8207\u7d50\u675f\u65e5\u671f\u3002</li> <li><code>initialize</code>, <code>handle_data</code>, <code>analyze</code>: \u50b3\u5165\u4e0a\u8ff0\u5b9a\u7fa9\u7684\u51fd\u5f0f\u3002</li> <li><code>capital_base</code>: \u521d\u59cb\u6295\u8cc7\u91d1\u984d\u3002</li> <li><code>bundle</code>: \u4f7f\u7528\u7684\u8cc7\u6599 bundle \u540d\u7a31\u3002</li> <li><code>trading_calendar</code>: (\u91cd\u8981) \u6307\u5b9a\u4ea4\u6613\u884c\u4e8b\u66c6\uff0c\u53f0\u80a1\u56de\u6e2c\u8acb\u52d9\u5fc5\u4f7f\u7528 <code>get_calendar('TEJ')</code>\u3002</li> </ul> </li> <li> <p>\u7bc4\u4f8b \uff1a\u57f7\u884c\u5f9e 2020 \u5e74\u4e2d\u5230 2025 \u5e74\u5e95\u7684\u56de\u6e2c\u3002</p> <pre><code>from zipline.utils.calendar_utils import get_calendar # \u5f15\u5165\u884c\u4e8b\u66c6\u5de5\u5177\nfrom zipline import run_algorithm\nimport pandas as pd\n\nstart_date = pd.Timestamp('2020-06-30', tz='utc')\nend_date = pd.Timestamp('2025-12-31', tz='utc')\n\nresults = run_algorithm(\n    start=start_date,\n    end=end_date,\n    initialize=initialize,\n    capital_base=1e6, # \u521d\u59cb\u8cc7\u91d1 1,000,000\n    handle_data=handle_data,\n    analyze=analyze,\n    data_frequency='daily',\n    bundle='tquant',\n    trading_calendar=get_calendar('TEJ') # \u6307\u5b9a\u4f7f\u7528 TEJ \u53f0\u80a1\u884c\u4e8b\u66c6\n)\n</code></pre> </li> </ul>"},{"location":"tutorials/quick-demo/#3","title":"3. \u57f7\u884c\u56de\u6e2c\u8207\u7d50\u679c\u5206\u6790","text":"<p>\u5c07\u4e0a\u8ff0\u6240\u6709\u7a0b\u5f0f\u78bc\u7247\u6bb5\u4f9d\u5e8f\u5728 Jupyter Notebook \u4e2d\u57f7\u884c\uff0c<code>run_algorithm</code> \u51fd\u5f0f\u5c07\u6703\u555f\u52d5\u56de\u6e2c\uff0c\u4e26\u5728\u7d50\u675f\u5f8c\u81ea\u52d5\u547c\u53eb <code>analyze</code> \u51fd\u5f0f\u986f\u793a\u7e3e\u6548\u5716\u8868\u3002</p> <ol> <li> <p><code>results</code> \u8b8a\u6578\u6703\u5132\u5b58\u56de\u6e2c\u671f\u9593\u7684\u8a73\u7d30\u7e3e\u6548\u6578\u64da\uff0c\u60a8\u53ef\u4ee5\u9032\u4e00\u6b65\u6aa2\u8996\uff1a</p> <pre><code>results.head()\n</code></pre> </li> <li> <p>\u900f\u904e\u9019\u500b\u7c21\u55ae\u7684\u7bc4\u4f8b\uff0c\u60a8\u5df2\u6210\u529f\u57f7\u884c\u4e86\u7b2c\u4e00\u500b TQuant Lab Zipline \u56de\u6e2c\u7b56\u7565\uff01\u60a8\u53ef\u4ee5\u5617\u8a66\u4fee\u6539 <code>handle_data</code> \u4e2d\u7684\u908f\u8f2f\uff0c\u63a2\u7d22\u66f4\u591a\u5143\u7684\u4ea4\u6613\u7b56\u7565\u3002</p> </li> </ol>"},{"location":"tutorials/quick-reference/","title":"\u5e38\u7528\u529f\u80fd\u901f\u67e5\u8868","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b TQuant Lab \u5e38\u7528\u529f\u80fd\u7684\u5feb\u901f\u67e5\u8a62\u6307\u5357\uff0c\u5e6b\u52a9\u60a8\u8fc5\u901f\u627e\u5230\u95dc\u9375\u51fd\u6578\u8207\u64cd\u4f5c\u65b9\u5f0f\u3002</p> <p>\u5feb\u901f\u67e5\u8a62\u5e38\u898b\u4efb\u52d9\u7684\u89e3\u6c7a\u65b9\u6848\u3002\u6bcf\u500b\u90e8\u5206\u90fd\u5305\u542b\u4ee3\u78bc\u793a\u4f8b\u548c\u6307\u5411\u8a73\u7d30\u6587\u6a94\u7684\u9023\u7d50\u3002</p>"},{"location":"tutorials/quick-reference/#_2","title":"\u5feb\u901f\u8df3\u8f49","text":"<p>\u5728\u4e0b\u65b9\u5feb\u901f\u5b9a\u4f4d\u4f60\u9700\u8981\u7684\u5167\u5bb9\uff1a</p> <ul> <li>\u8cc7\u6599\u7ba1\u7406 - \u7372\u53d6\u80a1\u7968\u6578\u64da\u3001\u57fa\u672c\u9762\u8cc7\u6599\u3001\u57fa\u6e96\u6307\u6578</li> <li>\u7b56\u7565\u7de8\u5beb - \u521d\u59cb\u5316\u53c3\u6578\u3001\u7de8\u5beb\u4ea4\u6613\u908f\u8f2f\u3001\u4f7f\u7528 Pipeline</li> <li>\u4ea4\u6613\u57f7\u884c - \u4e0b\u55ae\u3001\u67e5\u8a62\u6301\u5009\u3001\u8a2d\u7f6e\u624b\u7e8c\u8cbb\u548c\u6ed1\u50f9</li> <li>\u4ea4\u6613\u9650\u5236 - \u8a2d\u7f6e\u69d3\u687f\u3001\u7981\u6b62\u4ea4\u6613\u6e05\u55ae\u3001\u4ea4\u6613\u983b\u7387\u9650\u5236</li> <li>\u7e3e\u6548\u5206\u6790 - Pyfolo \u5831\u8868\u3001\u56e0\u5b50\u5206\u6790\u3001\u81ea\u8a02\u6307\u6a19</li> <li>API \u53c3\u8003 - symbol()\u3001data.history()\u3001context.portfolio</li> <li>\u5e38\u898b\u554f\u984c - \u8abf\u8a66\u6280\u5de7\u3001\u5feb\u901f\u8a3a\u65b7</li> </ul>"},{"location":"tutorials/quick-reference/#data-management","title":"\u8cc7\u6599\u7ba1\u7406","text":""},{"location":"tutorials/quick-reference/#_3","title":"\u5982\u4f55\u53d6\u5f97\u80a1\u7968\u6b77\u53f2\u50f9\u683c\uff1f","text":"<pre><code>from zipline.api import data\nprices = data.history(symbol('2330'), 'close', 100, '1d')\n</code></pre> <p>\u8a73\u898b\uff1a\u5982\u4f55 Ingest \u80a1\u7968\u50f9\u91cf\u8cc7\u6599</p>"},{"location":"tutorials/quick-reference/#tej","title":"\u5982\u4f55\u52a0\u8f09 TEJ \u57fa\u672c\u9762\u8cc7\u6599\uff1f","text":"<pre><code>import TejToolAPI\napi = TejToolAPI.TejToolAPI()\ndf = api.get_history_data(tickers='2330', fields=['PER', 'PBR'], date='20230101')\n</code></pre> <p>\u8a73\u898b\uff1a\u5982\u4f55 Ingest TEJ \u8ca1\u52d9/\u975e\u8ca1\u52d9\u8cc7\u6599</p>"},{"location":"tutorials/quick-reference/#_4","title":"\u5982\u4f55\u53d6\u5f97\u57fa\u6e96\u6307\u6578\u5831\u916c\uff1f","text":"<p>\u5728 <code>run_algorithm()</code> \u4e2d\u6307\u5b9a\uff1a</p> <pre><code>run_algorithm(\n    benchmark_symbol='0050',  # \u53f0\u7063 50 \u6307\u6578\n)\n</code></pre> <p>\u8a73\u898b\uff1a\u5982\u4f55\u53d6\u5f97 Benchmark \u5831\u916c\u7387</p>"},{"location":"tutorials/quick-reference/#strategy-writing","title":"\u7b56\u7565\u7de8\u5beb","text":""},{"location":"tutorials/quick-reference/#_5","title":"\u5982\u4f55\u521d\u59cb\u5316\u7b56\u7565\u53c3\u6578\uff1f","text":"<pre><code>def initialize(context):\n    context.max_leverage = 1.0\n    context.stocks = [symbol('2330'), symbol('2454')]\n    context.long_window = 50\n    context.short_window = 20\n</code></pre> <p>\u8a73\u898b\uff1aZipline \u751f\u547d\u9031\u671f\u51fd\u6578</p>"},{"location":"tutorials/quick-reference/#_6","title":"\u5982\u4f55\u5728\u6bcf\u500b\u4ea4\u6613\u65e5\u57f7\u884c\u64cd\u4f5c\uff1f","text":"<pre><code>def handle_data(context, data):\n    # \u9019\u500b\u51fd\u6578\u6bcf\u5929\u57f7\u884c\u4e00\u6b21\n    prices = data.history(symbol('2330'), 'close', 20, '1d')\n    avg = prices.mean()\n\n    if avg &gt; some_threshold:\n        order(symbol('2330'), 100)\n</code></pre> <p>\u8a73\u898b\uff1aZipline \u751f\u547d\u9031\u671f\u51fd\u6578</p>"},{"location":"tutorials/quick-reference/#_7","title":"\u5982\u4f55\u8a08\u7b97\u56e0\u5b50\u4e26\u904e\u6ffe\u80a1\u7968\uff1f","text":"<pre><code>from zipline.pipeline import Pipeline, screen\nfrom zipline.pipeline.factors import CustomFactor\n\npipeline = Pipeline(\n    columns={\n        'momentum': CustomFactor(...),\n    },\n    screen=Q(pe_ratio &lt; 20),\n)\n</code></pre> <p>\u8a73\u898b\uff1aPipeline \u81ea\u8a02\u56e0\u5b50</p>"},{"location":"tutorials/quick-reference/#trade-execution","title":"\u4ea4\u6613\u57f7\u884c","text":""},{"location":"tutorials/quick-reference/#_8","title":"\u5982\u4f55\u4e0b\u8cb7\u55ae\uff1f","text":"<pre><code>order(symbol('2330'), 100)  # \u8cb7 100 \u80a1\n</code></pre>"},{"location":"tutorials/quick-reference/#_9","title":"\u5982\u4f55\u4e0b\u8ce3\u55ae\uff1f","text":"<pre><code>order(symbol('2330'), -100)  # \u8ce3 100 \u80a1\n</code></pre>"},{"location":"tutorials/quick-reference/#_10","title":"\u5982\u4f55\u4e00\u6b21\u8cb7\u5165\u6240\u6709\u8cc7\u91d1\u53ef\u8cfc\u8cb7\u7684\u80a1\u7968\uff1f","text":"<pre><code>price = data.current(symbol('2330'), 'price')\ncash = context.portfolio.cash\nshares = int(cash / price)\norder(symbol('2330'), shares)\n</code></pre>"},{"location":"tutorials/quick-reference/#_11","title":"\u5982\u4f55\u8abf\u6574\u81f3\u76ee\u6a19\u6b0a\u91cd\uff1f (\u63a8\u85a6)","text":"<p>\u81ea\u52d5\u8a08\u7b97\u9700\u8981\u8cb7\u8ce3\u7684\u80a1\u6578\uff0c\u5c07\u8a72\u80a1\u7968\u8abf\u6574\u81f3\u7e3d\u8cc7\u7522\u7684 10%\u3002</p> <pre><code>order_target_percent(symbol('2330'), 0.10)\n</code></pre> <p>\u8a73\u898b\uff1a\u4e0b\u55ae\u51fd\u6578</p>"},{"location":"tutorials/quick-reference/#_12","title":"\u5982\u4f55\u67e5\u8a62\u7576\u524d\u6301\u5009\uff1f","text":"<pre><code>positions = context.portfolio.positions\nfor asset, position in positions.items():\n    print(f\"\u80a1\u7968: {asset}, \u6578\u91cf: {position.amount}, \u6210\u672c: {position.cost_basis}\")\n</code></pre> <p>\u8a73\u898b\uff1acontext \u8b8a\u6578</p>"},{"location":"tutorials/quick-reference/#_13","title":"\u5982\u4f55\u8a2d\u5b9a\u624b\u7e8c\u8cbb\uff1f","text":"<pre><code>from zipline.finance import commission\n\nset_commission(commission.PerShare(cost=0.001))  # \u6bcf\u80a1 0.001 \u5143\n</code></pre> <p>\u8a73\u898b\uff1a\u5982\u4f55\u8a2d\u5b9a\u624b\u7e8c\u8cbb\u6a21\u578b</p>"},{"location":"tutorials/quick-reference/#_14","title":"\u5982\u4f55\u8a2d\u5b9a\u6ed1\u50f9\uff1f","text":"<pre><code>from zipline.finance import slippage\n\nset_slippage(slippage.FixedSlippage(0.001))  # \u56fa\u5b9a 0.1%\n</code></pre> <p>\u8a73\u898b\uff1a\u5982\u4f55\u8a2d\u5b9a\u6ed1\u50f9\u6a21\u578b</p>"},{"location":"tutorials/quick-reference/#trading-controls","title":"\u4ea4\u6613\u9650\u5236","text":""},{"location":"tutorials/quick-reference/#_15","title":"\u5982\u4f55\u9650\u5236\u6700\u5927\u69d3\u687f\uff1f","text":"<pre><code>set_max_leverage(2.0)  # \u6700\u591a\u501f 2 \u500d\u8cc7\u91d1\n</code></pre>"},{"location":"tutorials/quick-reference/#_16","title":"\u5982\u4f55\u8a2d\u5b9a\u7981\u6b62\u4ea4\u6613\u6e05\u55ae\uff1f","text":"<pre><code>set_do_not_order_list([symbol('2881'), symbol('2882')])\n</code></pre>"},{"location":"tutorials/quick-reference/#_17","title":"\u5982\u4f55\u8a2d\u5b9a\u55ae\u65e5\u6700\u5927\u4ea4\u6613\u7b46\u6578\uff1f","text":"<pre><code>set_max_order_count(10)  # \u6700\u591a\u4e0b 10 \u55ae\n</code></pre> <p>\u8a73\u898b\uff1a\u5982\u4f55\u8a2d\u5b9a\u4ea4\u6613\u9650\u5236</p>"},{"location":"tutorials/quick-reference/#performance-analysis","title":"\u7e3e\u6548\u5206\u6790","text":""},{"location":"tutorials/quick-reference/#pyfolo","title":"\u5982\u4f55\u751f\u6210 Pyfolo \u5831\u8868\uff1f","text":"<pre><code>import pyfolio as pf\npf.create_tear_sheet(returns, positions, transactions)\n</code></pre> <p>\u8a73\u898b\uff1a\u5982\u4f55\u7522\u751f Pyfolo \u7e3e\u6548\u5831\u8868</p>"},{"location":"tutorials/quick-reference/#_18","title":"\u5982\u4f55\u9032\u884c\u56e0\u5b50\u5206\u6790\uff1f","text":"<pre><code>import alphalens as al\nal.tears.create_factor_tear_sheet(factor, prices)\n</code></pre> <p>\u8a73\u898b\uff1a\u5982\u4f55\u57f7\u884c Alphalens \u56e0\u5b50\u5206\u6790</p>"},{"location":"tutorials/quick-reference/#_19","title":"\u5982\u4f55\u8a18\u9304\u81ea\u8a02\u6307\u6a19\uff1f","text":"<pre><code>def handle_data(context, data):\n    # ... \u4ea4\u6613\u908f\u8f2f ...\n\n    record(\n        portfolio_value=context.portfolio.portfolio_value,\n        leverage=context.account.leverage,\n        custom_signal=some_value\n    )\n</code></pre> <p>\u8a73\u898b\uff1acontext \u8b8a\u6578</p>"},{"location":"tutorials/quick-reference/#api-reference","title":"\u5e38\u7528 API \u53c3\u8003","text":""},{"location":"tutorials/quick-reference/#symbol-","title":"symbol() - \u7372\u53d6\u80a1\u7968\u5c0d\u8c61","text":"<pre><code>from zipline.api import symbol\n\ntsmc = symbol('2330')  # TSMC\n</code></pre>"},{"location":"tutorials/quick-reference/#datahistory-","title":"data.history() - \u7372\u53d6\u6b77\u53f2\u6578\u64da","text":"<pre><code>prices = data.history(stock, 'close', 50, '1d')  # \u904e\u53bb 50 \u65e5\u6536\u76e4\u50f9\nvolumes = data.history(stock, 'volume', 20, '1d')  # \u904e\u53bb 20 \u65e5\u6210\u4ea4\u91cf\n</code></pre>"},{"location":"tutorials/quick-reference/#datacurrent-","title":"data.current() - \u7372\u53d6\u7576\u524d\u50f9\u683c","text":"<pre><code>current_price = data.current(stock, 'price')\ncurrent_volume = data.current(stock, 'volume')\n</code></pre>"},{"location":"tutorials/quick-reference/#contextportfolio-","title":"context.portfolio - \u6295\u8cc7\u7d44\u5408\u4fe1\u606f","text":"<pre><code>context.portfolio.portfolio_value  # \u7e3d\u8cc7\u7522\ncontext.portfolio.cash             # \u73fe\u91d1\ncontext.portfolio.positions        # \u6301\u5009\u5b57\u5178\n</code></pre> <p>\u8a73\u898b\uff1acontext \u8b8a\u6578\u5b8c\u6574\u53c3\u8003</p>"},{"location":"tutorials/quick-reference/#_20","title":"\u5b8c\u6574\u7b56\u7565\u7bc4\u672c","text":"<p>\u4e00\u500b\u6700\u5c0f\u5316\u4f46\u5b8c\u6574\u7684\u7b56\u7565\u6846\u67b6\uff1a</p> <pre><code>from zipline import run_algorithm\nfrom zipline.api import order, symbol, record\nfrom datetime import datetime\n\ndef initialize(context):\n    context.stock = symbol('2330')\n\ndef handle_data(context, data):\n    price = data.current(context.stock, 'price')\n    order(context.stock, 10)\n    record(price=price)\n\ndef analyze(context, perf):\n    print(f\"Return: {perf['algorithm_period_return'][-1]:.2%}\")\n\nrun_algorithm(\n    start=pd.Timestamp('2022-01-01', tz='utc'),\n    end=pd.Timestamp('2023-01-01', tz='utc'),\n    initialize=initialize,\n    handle_data=handle_data,\n    analyze=analyze,\n    capital_base=100000,\n    bundle='tquant',\n)\n</code></pre>"},{"location":"tutorials/quick-reference/#troubleshooting","title":"\u5feb\u901f\u8a3a\u65b7","text":""},{"location":"tutorials/quick-reference/#_21","title":"\u70ba\u4ec0\u9ebc\u6211\u7684\u7b56\u7565\u6c92\u6709\u4e0b\u55ae\uff1f","text":"\u539f\u56e0 \u6aa2\u67e5\u65b9\u6cd5 \u8cc7\u91d1\u4e0d\u8db3 \u6aa2\u67e5 <code>context.portfolio.cash</code> \u80a1\u7968\u4ee3\u78bc\u932f\u8aa4 \u78ba\u4fdd symbol() \u4f7f\u7528\u6b63\u78ba\u7684\u4ee3\u78bc \u6578\u64da\u4e0d\u53ef\u7528 \u6aa2\u67e5\u56de\u6e2c\u671f\u9593\u662f\u5426\u6709\u8a72\u80a1\u7968\u7684\u6578\u64da \u908f\u8f2f\u932f\u8aa4 \u5728 <code>handle_data()</code> \u4e2d\u6dfb\u52a0 <code>print()</code> \u8abf\u8a66"},{"location":"tutorials/quick-reference/#_22","title":"\u5982\u4f55\u8abf\u8a66\u7b56\u7565\uff1f","text":"<pre><code>def handle_data(context, data):\n    # \u6dfb\u52a0 print \u8a9e\u53e5\n    print(f\"Date: {data.current_dt}\")\n    print(f\"Cash: {context.portfolio.cash}\")\n    print(f\"Portfolio value: {context.portfolio.portfolio_value}\")\n\n    # ... \u5176\u4ed6\u908f\u8f2f ...\n</code></pre>"},{"location":"tutorials/quick-reference/#_23","title":"\u9032\u968e\u4e3b\u984c","text":"<ul> <li>Pipeline \u5167\u5efa\u56e0\u5b50</li> <li>\u81ea\u8a02 Pipeline \u56e0\u5b50</li> <li>\u4ea4\u6613\u65e5\u66c6\u8a2d\u5b9a</li> <li>Zipline \u8cc7\u6599\u7269\u4ef6</li> </ul>"},{"location":"tutorials/quick-reference/#_24","title":"\u7121\u6cd5\u627e\u5230\u7b54\u6848\uff1f","text":"<ul> <li>\u67e5\u770b \u65b0\u624b\u5fc5\u8b80</li> <li>\u95b1\u8b80 \u6838\u5fc3\u6982\u5ff5</li> <li>\u67e5\u8a62 \u5b8c\u6574 API \u53c3\u8003</li> <li>\u67e5\u95b1 10 \u5206\u9418\u5feb\u901f\u9ad4\u9a57</li> </ul>"},{"location":"tutorials/setup/","title":"\u74b0\u5883\u5efa\u7f6e\uff1a\u5b89\u88dd\u8207\u8a2d\u5b9a TQuant Lab","text":"<p>Info</p> <p>\u672c\u6587\u4ef6\u63d0\u4f9b TQuant Lab \u7684\u8a73\u7d30\u5b89\u88dd\u8207\u74b0\u5883\u8a2d\u5b9a\u6307\u5357\uff0c\u78ba\u4fdd\u60a8\u80fd\u9806\u5229\u555f\u52d5\u4e26\u958b\u59cb\u4f7f\u7528\u5e73\u53f0\u3002</p>"},{"location":"tutorials/setup/#_1","title":"\u7cfb\u7d71\u8981\u6c42\u8207\u652f\u63f4\u74b0\u5883","text":"<p>\u5728\u5b89\u88dd TQuant Lab \u4e4b\u524d\uff0c\u8acb\u78ba\u8a8d\u60a8\u7684\u7cfb\u7d71\u7b26\u5408\u4ee5\u4e0b\u8981\u6c42\uff1a</p> <ul> <li>\u4e3b\u8981\u5957\u4ef6\uff1aZipline (Zipline-tej)</li> <li>\u652f\u63f4 Python \u7248\u672c\uff1aPython 3.8 ~ 3.11 ( \u5efa\u8b70\u4f7f\u7528 Python 3.11 )</li> <li>\u652f\u63f4\u4f5c\u696d\u7cfb\u7d71\uff1aMicrosoft Windows OS, macOS \u6216 Linux (Linux \u4f7f\u7528\u8005\u8acb\u512a\u5148\u63a1\u7528\u300cA. \u900f\u904e Docker \u5b89\u88dd\u300d\u6d41\u7a0b)</li> <li>Pandas \u7248\u672c\uff1a\u5efa\u8b70 1.5.3 \u6216 2.0.0\uff1b\u9ad8\u65bc 2.0.0 \u53ef\u80fd\u4e0d\u76f8\u5bb9\u3002</li> <li>NumPy \u7248\u672c\uff1a\u5efa\u8b70 1.23.5\uff1b\u9ad8\u65bc 1.23.5 \u53ef\u80fd\u4e0d\u76f8\u5bb9\u3002</li> </ul>"},{"location":"tutorials/setup/#_2","title":"\u5b89\u88dd\u65b9\u5f0f","text":"<p>\u4ee5\u4e0b\u63d0\u4f9b\u4e09\u7a2e\u5b89\u88dd <code>zipline-tej</code> (TQuant Lab \u7684\u6838\u5fc3\u5957\u4ef6) \u7684\u65b9\u5f0f\uff0c \u5efa\u8b70\u512a\u5148\u63a1\u7528 1 \u6216 2 \u65b9\u5f0f \u3002</p>"},{"location":"tutorials/setup/#1-docker-zipline-tej","title":"1. \u900f\u904e Docker \u5b89\u88dd zipline-tej ( \u63a8\u85a6 )","text":"<p>\u4f7f\u7528 Docker \u5b89\u88dd\u662f\u6700\u63a8\u85a6\u7684\u65b9\u5f0f\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u500b\u9694\u96e2\u4e14\u4e00\u81f4\u7684\u904b\u884c\u74b0\u5883\uff0c\u80fd\u6709\u6548\u907f\u514d\u5957\u4ef6\u76f8\u4f9d\u6027\u554f\u984c\u3002</p>"},{"location":"tutorials/setup/#11","title":"1.1 \u5148\u6c7a\u689d\u4ef6","text":"<p>\u8acb\u78ba\u4fdd\u60a8\u7684\u7cfb\u7d71\u5df2\u5b89\u88dd Docker Desktop\uff1a</p> <ul> <li>Mac \u4f7f\u7528\u8005\u8acb\u9ede\u6b64</li> <li>Windows \u4f7f\u7528\u8005\u8acb\u9ede\u6b64</li> <li>Linux \u4f7f\u7528\u8005\u8acb\u9ede\u6b64</li> </ul> <p>\u91cd\u65b0\u555f\u52d5\u60a8\u7684\u96fb\u8166</p> <p>\u5982\u679c\u60a8\u525b\u5728 Windows \u7cfb\u7d71\u4e0a\u5b89\u88dd\u4e86 Docker\uff0c\u8acb\u8a18\u5f97\u91cd\u65b0\u555f\u52d5\u96fb\u8166\uff0c\u5426\u5247\u53ef\u80fd\u6703\u9047\u5230\u5bb9\u5668\u7db2\u8def\u9023\u7dda\u65b9\u9762\u7684\u7570\u5e38\u554f\u984c\u3002</p>"},{"location":"tutorials/setup/#12","title":"1.2 \u5b89\u88dd\u6b65\u9a5f","text":"<ol> <li> <p>\u5f9e Docker Hub \u4e0b\u8f09\u6620\u50cf\u6a94 \uff1a     \u5728\u7d42\u7aef\u6a5f\u4e2d\u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4\uff0c\u4e0b\u8f09\u5b98\u65b9 <code>tquant</code> Docker \u6620\u50cf\u6a94\uff1a</p> <pre><code>docker pull tej87681088/tquant:latest\n</code></pre> </li> <li> <p>\u5efa\u7acb\u8cc7\u6599\u5132\u5b58\u7a7a\u9593 (Volume) \uff1a     \u5efa\u7acb\u4e00\u500b Docker Volume \u4f86\u6301\u4e45\u5316\u60a8\u7684\u8cc7\u6599\uff0c\u907f\u514d\u5bb9\u5668\u522a\u9664\u5f8c\u8cc7\u6599\u907a\u5931\uff1a</p> <pre><code>docker volume create data\n</code></pre> </li> <li> <p>\u555f\u52d5 <code>tquant</code> \u5bb9\u5668 \uff1a     \u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4\u555f\u52d5\u5bb9\u5668\u3002\u6b64\u547d\u4ee4\u6703\u5c07 <code>data</code> volume \u639b\u8f09\u5230\u5bb9\u5668\u5167\u90e8\u7684 <code>/app</code> \u76ee\u9304\uff0c\u4e26\u5c07\u60a8\u7684\u672c\u6a5f 8888 \u57e0\u6620\u5c04\u5230\u5bb9\u5668\u5167\u7684 8888 \u57e0\u3002</p> <pre><code>docker run -v data:/app -p 8888:8888 --name tquant tej87681088/tquant\n</code></pre> <p>\u88dc\u5145\u8aaa\u660e</p> <ul> <li><code>volume</code> \u5728 Windows 10 WSL \u74b0\u5883\u4e2d\u7684\u4f4d\u7f6e\u901a\u5e38\u70ba\uff1a<code>\\wsl$\\docker-desktop-data\\data\\docker\\volumes\\data\\_data</code></li> <li>\u82e5\u60a8\u5e0c\u671b\u5bb9\u5668\u5728\u505c\u6b62\u6642\u81ea\u52d5\u79fb\u9664\uff0c\u53ef\u4ee5\u5728 <code>docker run</code> \u547d\u4ee4\u4e2d\u52a0\u5165 <code>--rm</code> \u53c3\u6578\u3002</li> </ul> </li> </ol>"},{"location":"tutorials/setup/#13-jupyter-notebook","title":"1.3 \u4f7f\u7528 Jupyter Notebook","text":"<p>\u5bb9\u5668\u555f\u52d5\u5f8c\uff0c\u60a8\u6703\u5728\u7d42\u7aef\u6a5f\u4e2d\u770b\u5230\u985e\u4f3c\u4ee5\u4e0b\u7684\u7db2\u5740\u3002\u8907\u88fd\u8a72\u7db2\u5740\u4e26\u8cbc\u81f3\u700f\u89bd\u5668\u5373\u53ef\u958b\u59cb\u4f7f\u7528 Jupyter Notebook\u3002</p> <pre><code>http://127.0.0.1:8888/tree?token=XXXXXXXXXXXXXXXX\n</code></pre>"},{"location":"tutorials/setup/#131-vs-code","title":"1.3.1 \u9032\u968e\uff1a\u4f7f\u7528 VS Code \u9023\u7dda\u958b\u767c (\u63a8\u85a6)","text":"<p>\u96d6\u7136 Jupyter Notebook \u5f88\u65b9\u4fbf\uff0c\u4f46\u4f7f\u7528 VS Code \u53ef\u4ee5\u7372\u5f97\u66f4\u5f37\u5927\u7684\u7a0b\u5f0f\u78bc\u88dc\u5168\u8207\u9664\u932f\u529f\u80fd\u3002\u900f\u904e Dev Containers \u64f4\u5145\u5957\u4ef6\uff0c\u60a8\u53ef\u4ee5\u76f4\u63a5\u9023\u7dda\u5230 Docker \u5bb9\u5668\u5167\u90e8\u9032\u884c\u958b\u767c\u3002</p> <p>\u6b65\u9a5f\u8aaa\u660e\uff1a</p> <ol> <li> <p>\u5b89\u88dd\u64f4\u5145\u5957\u4ef6\uff1a     \u6253\u958b VS Code\uff0c\u5b89\u88dd\u5fae\u8edf\u5b98\u65b9\u7684 Dev Containers \u64f4\u5145\u5957\u4ef6\u3002</p> </li> <li> <p>\u555f\u52d5\u5bb9\u5668\uff1a     \u78ba\u4fdd\u60a8\u7684 <code>tquant</code> \u5bb9\u5668\u5df2\u7d93\u8655\u65bc\u57f7\u884c\u72c0\u614b (Running)\u3002</p> </li> <li> <p>\u9023\u7dda\u81f3\u5bb9\u5668\uff1a</p> <ul> <li>\u9ede\u64ca VS Code \u5de6\u4e0b\u89d2\u7684\u7da0\u8272\u6309\u9215 (\u6216\u662f\u6309 <code>F1</code> \u958b\u555f\u547d\u4ee4\u5217)\u3002</li> <li>\u8f38\u5165\u4e26\u9078\u64c7 <code>Dev Containers: Attach to Running Container...</code>\u3002</li> <li>\u9078\u64c7 <code>/tquant</code> \u5bb9\u5668\u3002</li> </ul> </li> <li> <p>\u958b\u555f\u5de5\u4f5c\u76ee\u9304\uff1a     \u9023\u7dda\u6210\u529f\u5f8c\uff0cVS Code \u6703\u958b\u4e00\u500b\u65b0\u8996\u7a97\u3002\u9ede\u64ca Open Folder\uff0c\u8f38\u5165 <code>/app</code> \u4e26\u6309\u4e0b\u78ba\u5b9a\u3002\u73fe\u5728\uff0c\u60a8\u5c31\u50cf\u662f\u5728\u672c\u6a5f\u4e00\u6a23\u7de8\u8f2f\u5bb9\u5668\u5167\u7684\u6a94\u6848\u4e86\uff01</p> </li> </ol> <p>\u6548\u7387\u63d0\u5347</p> <p>\u5728 VS Code \u5bb9\u5668\u74b0\u5883\u4e2d\uff0c\u60a8\u4f9d\u7136\u53ef\u4ee5\u5b89\u88dd\u81ea\u5df1\u7fd2\u6163\u7684 Python \u64f4\u5145\u5957\u4ef6 (\u5982 Pylance)\uff0c\u9019\u5c07\u5927\u5e45\u63d0\u5347\u64b0\u5beb\u7b56\u7565\u7684\u6d41\u66a2\u5ea6\u3002</p>"},{"location":"tutorials/setup/#14-container","title":"1.4 \u64cd\u4f5c\u5df2\u95dc\u9589\u7684\u5bb9\u5668 (Container)","text":"<p>\u82e5\u60a8\u9700\u8981\u64cd\u4f5c\u4e4b\u524d\u5275\u5efa\u4f46\u5df2\u95dc\u9589\u7684\u5bb9\u5668\uff0c\u8acb\u4f9d\u7167\u4ee5\u4e0b\u6b65\u9a5f\uff1a</p> <ol> <li> <p>\u5217\u51fa\u6240\u6709\u5bb9\u5668 (\u5305\u62ec\u5df2\u505c\u6b62\u7684)\uff1a</p> <pre><code>docker ps -a\n</code></pre> </li> <li> <p>\u555f\u52d5\u6307\u5b9a\u5bb9\u5668 \uff1a     \u5c07 <code>&lt;CONTAINER_ID&gt;</code> \u66ff\u63db\u70ba <code>docker ps -a</code> \u67e5\u8a62\u5230\u7684\u5be6\u969b\u5bb9\u5668 ID\u3002</p> <pre><code>docker start &lt;CONTAINER_ID&gt;\n</code></pre> </li> <li> <p>\u67e5\u770b\u5bb9\u5668\u65e5\u8a8c \uff1a     \u986f\u793a\u6307\u5b9a\u5bb9\u5668\u7684\u6700\u8fd1\u65e5\u8a8c (\u4f8b\u5982\u6700\u5f8c 50 \u884c)\uff1a</p> <pre><code>docker logs --tail 50 &lt;CONTAINER_ID&gt;\n</code></pre> </li> </ol>"},{"location":"tutorials/setup/#15-tquant-docker","title":"1.5 \u66f4\u65b0 TQuant Docker \u5bb9\u5668","text":"<p>\u70ba\u78ba\u4fdd\u60a8\u4f7f\u7528\u7684 <code>tquant</code> \u74b0\u5883\u662f\u6700\u65b0\u7248\u672c\uff0c\u8acb\u5b9a\u671f\u66f4\u65b0\u60a8\u7684 Docker \u5bb9\u5668\u3002\u9019\u4e9b\u6b65\u9a5f\u6703\u505c\u6b62\u4e26\u522a\u9664\u73fe\u6709\u5bb9\u5668\uff0c\u4f46\u7531\u65bc\u8cc7\u6599\u5132\u5b58\u5728 <code>volume</code> \u4e2d\uff0c\u60a8\u7684\u8cc7\u6599\u5c07\u4e0d\u6703\u907a\u5931\u3002</p> <ol> <li> <p>\u505c\u6b62\u4e26\u522a\u9664\u73fe\u6709 <code>tquant</code> \u5bb9\u5668 \uff1a</p> <pre><code>docker stop tquant\ndocker rm tquant\n</code></pre> </li> <li> <p>\u4e0b\u8f09\u6700\u65b0 <code>tquant</code> \u6620\u50cf\u6a94 \uff1a</p> <pre><code>docker pull tej87681088/tquant:latest\n</code></pre> </li> <li> <p>\u91cd\u65b0\u555f\u52d5\u5bb9\u5668 \uff1a     \u4f7f\u7528\u5efa\u7acb <code>volume</code> \u7684\u65b9\u5f0f\u91cd\u65b0\u555f\u52d5\u5bb9\u5668\u3002</p> <pre><code>docker run -v data:/app -p 8888:8888 --name tquant tej87681088/tquant\n</code></pre> </li> </ol>"},{"location":"tutorials/setup/#16-docker-troubleshooting","title":"1.6 Docker \u5e38\u898b\u554f\u984c\u6392\u9664 (Troubleshooting)","text":"<p>\u5982\u679c\u60a8\u5728\u555f\u52d5\u6216\u4f7f\u7528\u5bb9\u5668\u6642\u9047\u5230\u554f\u984c\uff0c\u8acb\u53c3\u8003\u4ee5\u4e0b\u89e3\u6c7a\u65b9\u6848\uff1a</p> \u554f\u984c 1\uff1aError response from daemon: driver failed programming external connectivity... <p>\u539f\u56e0\uff1a\u9019\u901a\u5e38\u8868\u793a\u60a8\u8a2d\u5b9a\u7684 Port (8888) \u5df2\u7d93\u88ab\u5176\u4ed6\u61c9\u7528\u7a0b\u5f0f\u4f54\u7528\u4e86\u3002</p> <p>\u89e3\u6c7a\u65b9\u6cd5\uff1a \u8acb\u4fee\u6539\u555f\u52d5\u6307\u4ee4\u4e2d\u7684 Port \u6620\u5c04\uff0c\u5c07\u5192\u865f\u524d\u7684\u6578\u5b57\u6539\u70ba\u5176\u4ed6\u672a\u88ab\u4f7f\u7528\u7684 Port (\u4f8b\u5982 8889)\uff1a <pre><code>docker run -v data:/app -p 8889:8888 --name tquant tej87681088/tquant\n</code></pre> \u555f\u52d5\u5f8c\uff0c\u60a8\u7684 Jupyter Notebook \u7db2\u5740\u5c07\u8b8a\u70ba <code>http://127.0.0.1:8889/...</code>\u3002</p> \u554f\u984c 2\uff1a\u56de\u6e2c\u57f7\u884c\u5230\u4e00\u534a\uff0c\u6838\u5fc3 (Kernel) \u81ea\u52d5\u91cd\u555f\u6216\u5d29\u6f70 <p>\u539f\u56e0\uff1aZipline \u9032\u884c\u56de\u6e2c\u6642\u9700\u8981\u8f03\u5927\u7684\u8a18\u61b6\u9ad4\uff0c\u82e5 Docker \u5206\u914d\u7684\u8a18\u61b6\u9ad4\u4e0d\u8db3 (\u9810\u8a2d\u901a\u5e38\u70ba 2GB)\uff0c\u5c31\u6703\u5c0e\u81f4\u5d29\u6f70\u3002</p> <p>\u89e3\u6c7a\u65b9\u6cd5 (\u91dd\u5c0d Windows/Mac Docker Desktop)\uff1a 1. \u958b\u555f Docker Desktop \u7684 Settings (\u9f52\u8f2a\u5716\u793a)\u3002 2. \u524d\u5f80 Resources &gt; Advanced (\u6216 Memory)\u3002 3. \u5c07 Memory limit \u62c9\u9ad8\u81f3 4GB \u6216 8GB \u4ee5\u4e0a\u3002 4. \u9ede\u64ca Apply &amp; Restart\u3002</p> \u554f\u984c 3\uff1aWindows \u7528\u6236\u7121\u6cd5\u639b\u8f09 Volume \u6216\u6b0a\u9650\u932f\u8aa4 <p>\u539f\u56e0\uff1aWindows \u6a94\u6848\u7cfb\u7d71\u6b0a\u9650\u6709\u6642\u6703\u963b\u6b62\u5bb9\u5668\u5beb\u5165\u8cc7\u6599\u3002</p> <p>\u89e3\u6c7a\u65b9\u6cd5\uff1a \u5efa\u8b70\u5728 Powershell \u4e2d\u57f7\u884c\u6307\u4ee4\uff0c\u4e26\u78ba\u4fdd\u60a8\u6709\u7ba1\u7406\u54e1\u6b0a\u9650\u3002\u82e5\u554f\u984c\u6301\u7e8c\uff0c\u8acb\u5617\u8a66\u91cd\u65b0\u5b89\u88dd Docker Desktop \u4e26\u78ba\u4fdd\u52fe\u9078 \"Use WSL 2 based engine\"\u3002</p>"},{"location":"tutorials/setup/#2-anaconda-prompt-zipline-tej","title":"2. \u900f\u904e Anaconda Prompt \u4e00\u9375\u5b89\u88dd zipline-tej ( \u63a8\u85a6 )","text":"<p>\u6b64\u65b9\u5f0f\u9069\u7528\u65bc\u5df2\u5b89\u88dd Anaconda \u7684\u4f7f\u7528\u8005\uff0c\u53ef\u900f\u904e\u9810\u8a2d\u7684\u74b0\u5883\u914d\u7f6e\u6587\u4ef6\u5feb\u901f\u8a2d\u5b9a\u597d\u904b\u884c\u74b0\u5883\u3002</p> <ol> <li> <p>\u4e0b\u8f09\u74b0\u5883\u914d\u7f6e\u6587\u4ef6 \uff1a     \u6839\u64da\u60a8\u7684\u4f5c\u696d\u7cfb\u7d71\u4e0b\u8f09\u5c0d\u61c9\u7684 <code>yml</code> \u6a94\u6848\uff1a</p> <ul> <li>Windows (zipline-tej.yml) (Raw \u9023\u7d50)</li> <li>Mac (zipline-tej_mac.yml) (Raw \u9023\u7d50)</li> </ul> </li> <li> <p>\u5efa\u7acb\u4e26\u555f\u52d5\u865b\u64ec\u74b0\u5883 \uff1a     \u958b\u555f Anaconda Prompt \uff0c\u5c07\u4e0b\u8f09\u597d\u7684 <code>yml</code> \u6a94\u6848\u653e\u7f6e\u65bc\u4efb\u4e00\u76ee\u9304\u5f8c\uff0c\u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4\uff1a</p> <pre><code># Windows \u4f7f\u7528\u8005\n# \u5c07 zipline-tej.yml \u6a94\u6848\u6240\u5728\u7684\u76ee\u9304\u66ff\u63db\u5230 &lt;C:\\Users\\username\\Downloads&gt;\ncd &lt;C:\\Users\\username\\Downloads&gt;\n\n# \u900f\u904e yml \u6a94\u5b89\u88dd\u6240\u9700\u5957\u4ef6\u4e26\u5275\u5efa\u865b\u64ec\u74b0\u5883\nconda env create -f zipline-tej.yml\n\n# \u555f\u52d5\u865b\u64ec\u74b0\u5883\nconda activate zipline-tej\n</code></pre> <pre><code># Mac \u4f7f\u7528\u8005\n# \u5c07 zipline-tej_mac.yml \u6a94\u6848\u6240\u5728\u7684\u76ee\u9304\u66ff\u63db\u5230 /Users/username/Downloads\ncd /Users/username/Downloads\n\n# \u900f\u904e yml \u6a94\u5b89\u88dd\u6240\u9700\u5957\u4ef6\u4e26\u5275\u5efa\u865b\u64ec\u74b0\u5883\nconda env create -f zipline-tej_mac.yml\n\n# \u555f\u52d5\u865b\u64ec\u74b0\u5883\nconda activate zipline-tej\n</code></pre> <p>\u70ba\u4ec0\u9ebc\u5efa\u8b70\u4f7f\u7528\u865b\u64ec\u74b0\u5883\uff1f</p> <p>\u4f7f\u7528\u865b\u64ec\u74b0\u5883\u53ef\u4ee5\u70ba\u4e0d\u540c\u7684\u5c08\u6848\u5efa\u7acb\u7368\u7acb\u7684 Python \u904b\u884c\u74b0\u5883\uff0c\u6709\u6548\u907f\u514d\u4e0d\u540c\u5c08\u6848\u9593\u7684\u5957\u4ef6\u885d\u7a81\u554f\u984c\u3002</p> </li> </ol>"},{"location":"tutorials/setup/#3-pip-install-zipline-tej","title":"3. \u76f4\u63a5\u900f\u904e pip install \u5b89\u88dd zipline-tej (\u53ef\u80fd\u6703\u6709\u672a\u9810\u671f\u7684\u932f\u8aa4)","text":"<p>\u6b64\u65b9\u6cd5\u8f03\u4e0d\u63a8\u85a6\uff0c\u56e0\u70ba\u53ef\u80fd\u6703\u6709\u672a\u9810\u671f\u7684\u5957\u4ef6\u76f8\u4f9d\u6027\u554f\u984c\uff0c\u9700\u81ea\u884c\u9664\u932f\u3002</p>"},{"location":"tutorials/setup/#31-zipline-tej","title":"3.1 \u65bc\u672c\u6a5f\u7aef\u5b89\u88dd zipline-tej","text":"<p>\u5efa\u8b70\u5728\u7368\u7acb\u7684\u865b\u64ec\u74b0\u5883\u4e2d\u9032\u884c\u5b89\u88dd\uff1a</p> <ol> <li> <p>\u5efa\u7acb\u8207\u555f\u52d5\u865b\u64ec\u74b0\u5883 \uff1a\u900f\u904e Anaconda \u6216 Python \u539f\u751f <code>venv</code> \u5efa\u7acb\u3002</p> <ul> <li> <p>\u65b9\u6cd5\u4e00\uff1aAnaconda \u6307\u4ee4     \u958b\u555f Anaconda Prompt\uff1a</p> <pre><code># \u5275\u5efa\u865b\u64ec\u74b0\u5883\nconda create -n &lt;env_name&gt; python=3.11\n\n# \u555f\u52d5\u865b\u64ec\u74b0\u5883\nconda activate &lt;env_name&gt;\n</code></pre> </li> <li> <p>\u65b9\u6cd5\u4e8c\uff1aPython \u539f\u751f\u6307\u4ee4     \u958b\u555f\u7d42\u7aef\u6a5f (CMD)\uff1a</p> <p><pre><code># \u5275\u5efa\u865b\u64ec\u74b0\u5883\npython -m venv venv\n\n# \u555f\u52d5\u865b\u64ec\u74b0\u5883 (Windows)\nvenv\\Scripts\\activate.bat\n</code></pre> <pre><code># \u6216 (macOS/Linux)\nsource venv/bin/activate\n</code></pre></p> </li> </ul> </li> <li> <p>\u5b89\u88dd\u5957\u4ef6 \uff1a</p> </li> </ol>"},{"location":"tutorials/setup/#311-pip","title":"3.1.1 \u4f7f\u7528 pip \u5b89\u88dd","text":"<pre><code>pip install zipline-tej notebook\n</code></pre>"},{"location":"tutorials/setup/#312-conda-jupyter","title":"3.1.2 \u4f7f\u7528 conda \u5b89\u88dd (\u91dd\u5c0d Jupyter \u6838\u5fc3)","text":"<pre><code>conda install -c conda-forge nb_conda_kernels\n</code></pre>"},{"location":"tutorials/setup/#32-google-colab-zipline-tej","title":"3.2 \u65bc Google Colab \u4f7f\u7528 zipline-tej","text":"<p>\u82e5\u5728 Google Colab \u74b0\u5883\u4e0b\u4f7f\u7528\uff0c\u53ef\u76f4\u63a5\u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4\u5b89\u88dd\uff1a</p> <pre><code>!pip install zipline-tej\n</code></pre> <ul> <li> <p>\u9078\u7528\uff1aColab \u5b57\u9ad4\u8a2d\u5b9a (\u91dd\u5c0d Pyfolio \u63d0\u9192) \uff1a     \u82e5\u60a8\u5728 Colab \u4e2d\u4f7f\u7528 Pyfolio \u9032\u884c\u8996\u89ba\u5316\u5206\u6790\uff0c\u53ef\u80fd\u6703\u9047\u5230\u5b57\u9ad4\u986f\u793a\u554f\u984c\u3002\u53ef\u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4\u5b89\u88dd\u4e2d\u6587\u5b57\u9ad4\u4ee5\u907f\u514d\u8b66\u544a\u6216\u4e82\u78bc\u3002</p> <p>\u5b57\u9ad4\u4f86\u6e90\u8207\u6388\u6b0a\u63d0\u9192</p> <p>\u4ee5\u4e0b\u6307\u4ee4\u6703\u5f9e\u5916\u90e8\u9023\u7d50\u4e0b\u8f09\u5b57\u9ad4\u6a94\u6848\u3002\u8acb\u6ce8\u610f\u5b57\u9ad4\u6a94\u6848\u7684\u6388\u6b0a\u689d\u6b3e\uff0c\u4e26\u81ea\u884c\u8a55\u4f30\u4f7f\u7528\u98a8\u96aa\u3002\u82e5\u6709\u7591\u616e\uff0c\u5efa\u8b70\u4f7f\u7528\u60a8\u672c\u5730\u5df2\u6709\u7684\u5b57\u9ad4\u6216\u516c\u53f8\u5167\u90e8\u63d0\u4f9b\u7684\u5b57\u9ad4\u8cc7\u6e90\u3002</p> <pre><code>import matplotlib\nimport matplotlib.font_manager as fm\n!wget -O MicrosoftJhengHei.ttf https://github.com/a7532ariel/ms-web/raw/master/Microsoft-JhengHei.ttf\n!wget -O ArialUnicodeMS.ttf https://github.com/texttechnologylab/DHd2019BoA/raw/master/fonts/Arial%20Unicode%20MS.TTF\n\nfm.fontManager.addfont('MicrosoftJhengHei.ttf')\nmatplotlib.rc('font', family='Microsoft Jheng Hei')\n\nmatplotlib.font_manager.fontManager.addfont('ArialUnicodeMS.ttf')\nmatplotlib.rc('font', family='Arial Unicode MS')\n</code></pre> </li> </ul>"},{"location":"tutorials/setup/#4-tquant-lab","title":"4. \u6aa2\u67e5\u8207\u66f4\u65b0 TQuant Lab","text":""},{"location":"tutorials/setup/#41","title":"4.1 \u6aa2\u67e5\u7248\u672c","text":"<p>\u5b89\u88dd\u5b8c\u6210\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u6307\u4ee4\u6aa2\u67e5 <code>zipline-tej</code> \u7684\u7576\u524d\u7248\u672c\uff1a</p> <pre><code>!pip show zipline-tej\n</code></pre>"},{"location":"tutorials/setup/#42","title":"4.2 \u66f4\u65b0\u81f3\u6700\u65b0\u7248\u672c","text":"<p>\u70ba\u78ba\u4fdd\u60a8\u4f7f\u7528\u7684\u662f\u6700\u65b0\u529f\u80fd\u8207\u4fee\u5fa9\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4\u66f4\u65b0 <code>zipline-tej</code>\uff1a</p> <pre><code>!pip install --upgrade zipline-tej\n</code></pre> <ul> <li>\u5b98\u65b9\u7248\u672c\u8cc7\u8a0a \uff1a\u60a8\u53ef\u4ee5\u5728 PyPI - zipline-tej \u9801\u9762\u67e5\u770b\u6700\u65b0\u7684\u7248\u672c\u8cc7\u8a0a\u3002</li> </ul>"},{"location":"tutorials/stocks_cheat_sheet/","title":"Zipline \u80a1\u7968\u7b56\u7565\u5099\u5fd8\u9304 (API Cheat Sheet)","text":"<p>Info</p> <p>\u672c\u9801\u63d0\u4f9b TQuant Lab \u80a1\u7968\u7b56\u7565\u958b\u767c\u7684 API \u5feb\u901f\u53c3\u8003\uff0c\u5305\u542b\u521d\u59cb\u5316\u3001\u6578\u64da\u7372\u53d6\u3001\u4ea4\u6613\u4e0b\u55ae\u3001\u90e8\u4f4d\u7ba1\u7406\u53ca\u56de\u6e2c\u57f7\u884c\u7b49\u5e38\u7528\u51fd\u6578\u3002</p> <p>\u9019\u662f\u4e00\u4efd\u5c08\u70ba TQuant Lab \u4e2d\u9032\u884c\u80a1\u7968\u7b56\u7565\u56de\u6e2c\u8a2d\u8a08\u7684 API \u5feb\u901f\u53c3\u8003\u5099\u5fd8\u9304\u3002</p>"},{"location":"tutorials/stocks_cheat_sheet/#1-initialize","title":"1. \u521d\u59cb\u5316 (<code>initialize</code>)","text":"API \u51fd\u6578/\u5c6c\u6027 \u8aaa\u660e \u7bc4\u4f8b <code>symbol(ticker_str)</code> \u6839\u64da\u80a1\u7968\u4ee3\u78bc\u53d6\u5f97 <code>Equity</code> \u8cc7\u7522\u7269\u4ef6\u3002 <code>context.asset = symbol('2330')</code> <code>set_benchmark(asset)</code> \u8a2d\u5b9a\u56de\u6e2c\u7684\u7e3e\u6548\u6bd4\u8f03\u57fa\u6e96\u3002 <code>set_benchmark(symbol('IR0001'))</code> <code>set_commission(...)</code> \u8a2d\u5b9a\u4ea4\u6613\u624b\u7e8c\u8cbb\u6a21\u578b\u3002 <code>set_commission(equities=commission.PerDollar(cost=0.001425))</code> <code>set_slippage(...)</code> \u8a2d\u5b9a\u6ed1\u50f9\u6a21\u578b\u3002 <code>set_slippage(equities=slippage.VolumeShareSlippage())</code> <code>schedule_function(...)</code> \u8a3b\u518a\u4e00\u500b\u6392\u7a0b\u51fd\u6578\uff0c\u5728\u7279\u5b9a\u6642\u9593\u9031\u671f\u6027\u57f7\u884c\u3002 <code>schedule_function(my_func, date_rules.every_day())</code> <code>date_rules.every_day()</code> \u65e5\u671f\u898f\u5247\uff1a\u6bcf\u500b\u4ea4\u6613\u65e5\u3002 <code>schedule_function(my_func, date_rules.every_day())</code> <code>date_rules.week_start()</code> \u65e5\u671f\u898f\u5247\uff1a\u6bcf\u9031\u7684\u7b2c\u4e00\u500b\u4ea4\u6613\u65e5\u3002 <code>schedule_function(my_func, date_rules.week_start())</code> <code>date_rules.month_start()</code> \u65e5\u671f\u898f\u5247\uff1a\u6bcf\u500b\u6708\u7684\u7b2c\u4e00\u500b\u4ea4\u6613\u65e5\u3002 <code>schedule_function(my_func, date_rules.month_start())</code> <code>time_rules.market_open()</code> \u6642\u9593\u898f\u5247\uff1a\u6bcf\u65e5\u958b\u76e4\u6642\u3002\u53ef\u52a0 <code>minutes</code> \u6216 <code>hours</code> \u53c3\u6578\u505a\u504f\u79fb\u3002 <code>time_rules.market_open(minutes=30)</code> <code>time_rules.market_close()</code> \u6642\u9593\u898f\u5247\uff1a\u6bcf\u65e5\u6536\u76e4\u6642\u3002\u53ef\u52a0 <code>minutes</code> \u6216 <code>hours</code> \u53c3\u6578\u505a\u504f\u79fb\u3002 <code>time_rules.market_close(minutes=15)</code>"},{"location":"tutorials/stocks_cheat_sheet/#2-data-access","title":"2. \u6578\u64da\u7372\u53d6 (Data Access)","text":"API \u51fd\u6578/\u5c6c\u6027 \u8aaa\u660e \u7bc4\u4f8b <code>data.history(...)</code> \u7372\u53d6\u6b77\u53f2\u6578\u64da\uff0c\u56de\u50b3\u4e00\u500b <code>pandas.DataFrame</code>\u3002 <code>hist = data.history(asset, 'price', 50, '1d')</code> <code>data.current(...)</code> \u7372\u53d6\u6307\u5b9a\u8cc7\u7522\u7684\u7576\u524d\u6578\u64da\uff08\u50f9\u683c\u3001\u6210\u4ea4\u91cf\u7b49\uff09\u3002 <code>price = data.current(asset, 'price')</code> <code>data.can_trade(asset)</code> \u6aa2\u67e5\u6307\u5b9a\u8cc7\u7522\u5728\u7576\u524d\u6642\u9593\u9ede\u662f\u5426\u53ef\u4ea4\u6613\u3002 <code>if data.can_trade(my_asset): ...</code> <code>get_datetime()</code> \u53d6\u5f97\u76ee\u524d\u56de\u6e2c\u7684\u6642\u9593\u9ede (UTC)\u3002 <code>current_time = get_datetime()</code>"},{"location":"tutorials/stocks_cheat_sheet/#3-trading-orders","title":"3. \u4ea4\u6613\u8207\u8a02\u55ae (Trading &amp; Orders)","text":"API \u51fd\u6578/\u5c6c\u6027 \u8aaa\u660e \u7bc4\u4f8b <code>order(asset, amount)</code> \u4e0b\u4e00\u5f35\u5e02\u50f9\u55ae\uff0c\u8cb7\u5165/\u8ce3\u51fa\u6307\u5b9a <code>amount</code> \u7684\u80a1\u6578\u3002\u6b63\u6578\u70ba\u8cb7\uff0c\u8ca0\u6578\u70ba\u8ce3\u3002 <code>order(symbol('2330'), 1000)</code> <code>order_target(asset, amount)</code> \u4e0b\u55ae\u5c07\u8cc7\u7522\u90e8\u4f4d\u8abf\u6574\u81f3\u76ee\u6a19 <code>amount</code> \u80a1\u6578\u3002 <code>order_target(symbol('2330'), 5000)</code> <code>order_target_percent(asset, pct)</code> \u4e0b\u55ae\u5c07\u8cc7\u7522\u90e8\u4f4d\u8abf\u6574\u81f3\u4f54\u7e3d\u6295\u8cc7\u7d44\u5408\u50f9\u503c\u7684 <code>pct</code> \u6bd4\u4f8b\u3002 <code>order_target_percent(symbol('2330'), 0.1)</code> <code>order_value(asset, value)</code> \u4e0b\u55ae\u8cb7\u5165/\u8ce3\u51fa\u50f9\u503c <code>value</code> \u7684\u80a1\u7968\u3002 <code>order_value(symbol('2330'), 500000)</code> <code>order_target_value(asset, value)</code> \u4e0b\u55ae\u5c07\u8cc7\u7522\u90e8\u4f4d\u8abf\u6574\u81f3\u76ee\u6a19\u50f9\u503c <code>value</code>\u3002 <code>order_target_value(symbol('2330'), 200000)</code> <code>LimitOrder(price)</code> \u9650\u50f9\u55ae\u6a23\u5f0f\uff0c\u9700\u8207 <code>order()</code> \u51fd\u6578\u914d\u5408\u4f7f\u7528\u3002 <code>order(asset, 1000, style=LimitOrder(599.0))</code> <code>StopOrder(price)</code> \u505c\u640d\u55ae\u6a23\u5f0f\uff08\u5e02\u50f9\uff09\u3002 <code>order(asset, -1000, style=StopOrder(550.0))</code> <code>StopLimitOrder(limit, stop)</code> \u505c\u640d\u9650\u50f9\u55ae\u6a23\u5f0f\u3002 <code>order(asset, -1000, style=StopLimitOrder(550, 551))</code> <code>get_order(order_id)</code> \u900f\u904e\u8a02\u55ae ID \u67e5\u8a62\u8a02\u55ae\u7269\u4ef6\u3002<code>order()</code> \u51fd\u6578\u6703\u56de\u50b3 ID\u3002 <code>my_order = get_order(order_id)</code> <code>get_open_orders()</code> \u53d6\u5f97\u6240\u6709\u672a\u6210\u4ea4\u7684\u639b\u55ae\u3002 <code>open_orders = get_open_orders()</code> <code>cancel_order(order_id)</code> \u6839\u64da\u8a02\u55ae ID \u53d6\u6d88\u4e00\u7b46\u672a\u6210\u4ea4\u7684\u639b\u55ae\u3002 <code>cancel_order(my_order_id)</code>"},{"location":"tutorials/stocks_cheat_sheet/#4-portfolio-positions","title":"4. \u6295\u8cc7\u7d44\u5408\u8207\u90e8\u4f4d (Portfolio &amp; Positions)","text":"API \u51fd\u6578/\u5c6c\u6027 \u8aaa\u660e \u7bc4\u4f8b <code>context.portfolio.portfolio_value</code> (\u5c6c\u6027) \u6574\u500b\u6295\u8cc7\u7d44\u5408\u7684\u7e3d\u6de8\u503c\u3002 <code>net_worth = context.portfolio.portfolio_value</code> <code>context.portfolio.cash</code> (\u5c6c\u6027) \u5e33\u6236\u4e2d\u7684\u73fe\u91d1\u9918\u984d\u3002 <code>cash_balance = context.portfolio.cash</code> <code>context.portfolio.positions</code> (\u5c6c\u6027) \u4e00\u500b\u5b57\u5178\uff0c\u5305\u542b\u6240\u6709\u7576\u524d\u6301\u6709\u7684\u90e8\u4f4d\u3002 <code>for asset, pos in context.portfolio.positions.items(): ...</code> <code>context.portfolio.positions_value</code> (\u5c6c\u6027) \u6240\u6709\u6301\u5009\u7684\u7e3d\u5e02\u503c\u3002 <code>total_pos_value = context.portfolio.positions_value</code> <code>position.amount</code> (\u5c6c\u6027) \u6301\u6709\u7684\u80a1\u6578\u3002 <code>shares = position.amount</code> <code>position.cost_basis</code> (\u5c6c\u6027) \u5e73\u5747\u6301\u6709\u6210\u672c\u3002 <code>avg_cost = position.cost_basis</code> <code>position.last_sale_price</code> (\u5c6c\u6027) \u6700\u65b0\u6210\u4ea4\u50f9\u683c\u3002 <code>current_price = position.last_sale_price</code>"},{"location":"tutorials/stocks_cheat_sheet/#5-execution-analysis","title":"5. \u57f7\u884c\u8207\u5206\u6790 (Execution &amp; Analysis)","text":"API \u51fd\u6578/\u5c6c\u6027 \u8aaa\u660e \u7bc4\u4f8b <code>run_algorithm(...)</code> \u6838\u5fc3\u57f7\u884c\u51fd\u6578\uff0c\u555f\u52d5\u6574\u500b\u56de\u6e2c\u3002 <code>results = run_algorithm(...)</code> <code>record(**kwargs)</code> \u5728\u6bcf\u500b\u6642\u9593\u9ede\u8a18\u9304\u4e00\u500b\u6216\u591a\u500b\u8b8a\u6578\uff0c\u4ee5\u4fbf\u5f8c\u7e8c\u5206\u6790\u3002 <code>record(my_ma=ma_value, price=current_price)</code> <code>get_calendar(name)</code> \u53d6\u5f97\u4e00\u500b\u4ea4\u6613\u65e5\u66c6\u7269\u4ef6\u3002 <code>trading_calendar=get_calendar('TEJ')</code>"}]}